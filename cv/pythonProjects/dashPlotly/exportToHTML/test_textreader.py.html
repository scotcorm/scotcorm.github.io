<html>
<head>
<title>test_textreader.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_textreader.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Tests the TextReader class in parsers.pyx, which 
is integral to the C engine in parsers.py 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">BytesIO</span><span class="s2">,</span>
    <span class="s1">StringIO</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">import </span><span class="s1">os</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">pandas._libs.parsers </span><span class="s2">as </span><span class="s1">parser</span>
<span class="s2">from </span><span class="s1">pandas._libs.parsers </span><span class="s2">import </span><span class="s1">TextReader</span>

<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">DataFrame</span>
<span class="s2">import </span><span class="s1">pandas._testing </span><span class="s2">as </span><span class="s1">tm</span>

<span class="s2">from </span><span class="s1">pandas.io.parsers </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">TextFileReader</span><span class="s2">,</span>
    <span class="s1">read_csv</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">pandas.io.parsers.c_parser_wrapper </span><span class="s2">import </span><span class="s1">ensure_dtype_objs</span>


<span class="s2">class </span><span class="s1">TestTextReader:</span>
    <span class="s1">@pytest.fixture(autouse=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">setup_method(self</span><span class="s2">, </span><span class="s1">datapath):</span>
        <span class="s1">self.dirpath = datapath(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s1">)</span>
        <span class="s1">csv1_dirpath = datapath(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;csv&quot;</span><span class="s1">)</span>
        <span class="s1">self.csv1 = os.path.join(csv1_dirpath</span><span class="s2">, </span><span class="s3">&quot;test1.csv&quot;</span><span class="s1">)</span>
        <span class="s1">self.csv2 = os.path.join(self.dirpath</span><span class="s2">, </span><span class="s3">&quot;test2.csv&quot;</span><span class="s1">)</span>
        <span class="s1">self.xls1 = os.path.join(self.dirpath</span><span class="s2">, </span><span class="s3">&quot;test.xls&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_file_handle(self):</span>
        <span class="s2">with </span><span class="s1">open(self.csv1</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">reader = TextReader(f)</span>
            <span class="s1">reader.read()</span>

    <span class="s2">def </span><span class="s1">test_file_handle_mmap(self):</span>
        <span class="s4"># this was never using memory_map=True</span>
        <span class="s2">with </span><span class="s1">open(self.csv1</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">reader = TextReader(f</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
            <span class="s1">reader.read()</span>

    <span class="s2">def </span><span class="s1">test_StringIO(self):</span>
        <span class="s2">with </span><span class="s1">open(self.csv1</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">text = f.read()</span>
        <span class="s1">src = BytesIO(text)</span>
        <span class="s1">reader = TextReader(src</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">reader.read()</span>

    <span class="s2">def </span><span class="s1">test_string_factorize(self):</span>
        <span class="s4"># should this be optional?</span>
        <span class="s1">data = </span><span class="s3">&quot;a</span><span class="s2">\n</span><span class="s3">b</span><span class="s2">\n</span><span class="s3">a</span><span class="s2">\n</span><span class="s3">b</span><span class="s2">\n</span><span class="s3">a&quot;</span>
        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>
        <span class="s2">assert </span><span class="s1">len(set(map(id</span><span class="s2">, </span><span class="s1">result[</span><span class="s5">0</span><span class="s1">]))) == </span><span class="s5">2</span>

    <span class="s2">def </span><span class="s1">test_skipinitialspace(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;a,   b</span><span class="s2">\n</span><span class="s3">a,   b</span><span class="s2">\n</span><span class="s3">a,   b</span><span class="s2">\n</span><span class="s3">a,   b&quot;</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">skipinitialspace=</span><span class="s2">True, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s1">tm.assert_numpy_array_equal(</span>
            <span class="s1">result[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.object_)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_numpy_array_equal(</span>
            <span class="s1">result[</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.object_)</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_parse_booleans(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;True</span><span class="s2">\n</span><span class="s3">False</span><span class="s2">\n</span><span class="s3">True</span><span class="s2">\n</span><span class="s3">True&quot;</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">0</span><span class="s1">].dtype == np.bool_</span>

    <span class="s2">def </span><span class="s1">test_delimit_whitespace(self):</span>
        <span class="s1">data = </span><span class="s3">'a  b</span><span class="s2">\n</span><span class="s3">a</span><span class="s2">\t\t </span><span class="s3">&quot;b&quot;</span><span class="s2">\n</span><span class="s3">&quot;a&quot;</span><span class="s2">\t \t </span><span class="s3">b'</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delim_whitespace=</span><span class="s2">True, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s1">tm.assert_numpy_array_equal(</span>
            <span class="s1">result[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.object_)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_numpy_array_equal(</span>
            <span class="s1">result[</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.object_)</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_embedded_newline(self):</span>
        <span class="s1">data = </span><span class="s3">'a</span><span class="s2">\n</span><span class="s3">&quot;hello</span><span class="s2">\n</span><span class="s3">there&quot;</span><span class="s2">\n</span><span class="s3">this'</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s1">expected = np.array([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;hello</span><span class="s2">\n</span><span class="s3">there&quot;</span><span class="s2">, </span><span class="s3">&quot;this&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.object_)</span>
        <span class="s1">tm.assert_numpy_array_equal(result[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_euro_decimal(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;12345,67</span><span class="s2">\n</span><span class="s3">345,678&quot;</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s1">decimal=</span><span class="s3">&quot;,&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s1">expected = np.array([</span><span class="s5">12345.67</span><span class="s2">, </span><span class="s5">345.678</span><span class="s1">])</span>
        <span class="s1">tm.assert_almost_equal(result[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_integer_thousands(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;123,456</span><span class="s2">\n</span><span class="s3">12,500&quot;</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s1">thousands=</span><span class="s3">&quot;,&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s1">expected = np.array([</span><span class="s5">123456</span><span class="s2">, </span><span class="s5">12500</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s1">tm.assert_almost_equal(result[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_integer_thousands_alt(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;123.456</span><span class="s2">\n</span><span class="s3">12.500&quot;</span>

        <span class="s1">reader = TextFileReader(</span>
            <span class="s1">StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s1">thousands=</span><span class="s3">&quot;.&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span>
        <span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s1">expected = DataFrame([</span><span class="s5">123456</span><span class="s2">, </span><span class="s5">12500</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_skip_bad_lines(self</span><span class="s2">, </span><span class="s1">capsys):</span>
        <span class="s4"># too many lines, see #2430 for why</span>
        <span class="s1">data = </span><span class="s3">&quot;a:b:c</span><span class="s2">\n</span><span class="s3">d:e:f</span><span class="s2">\n</span><span class="s3">g:h:i</span><span class="s2">\n</span><span class="s3">j:k:l:m</span><span class="s2">\n</span><span class="s3">l:m:n</span><span class="s2">\n</span><span class="s3">o:p:q:r&quot;</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None</span><span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">r&quot;Error tokenizing data\. C error: Expected 3 fields in line 4, saw 4&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(parser.ParserError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">reader.read()</span>

        <span class="s1">reader = TextReader(</span>
            <span class="s1">StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None, </span><span class="s1">on_bad_lines=</span><span class="s5">2  </span><span class="s4"># Skip</span>
        <span class="s1">)</span>
        <span class="s1">result = reader.read()</span>
        <span class="s1">expected = {</span>
            <span class="s5">0</span><span class="s1">: np.array([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;g&quot;</span><span class="s2">, </span><span class="s3">&quot;l&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=object)</span><span class="s2">,</span>
            <span class="s5">1</span><span class="s1">: np.array([</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">, </span><span class="s3">&quot;h&quot;</span><span class="s2">, </span><span class="s3">&quot;m&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=object)</span><span class="s2">,</span>
            <span class="s5">2</span><span class="s1">: np.array([</span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;f&quot;</span><span class="s2">, </span><span class="s3">&quot;i&quot;</span><span class="s2">, </span><span class="s3">&quot;n&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=object)</span><span class="s2">,</span>
        <span class="s1">}</span>
        <span class="s1">assert_array_dicts_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">reader = TextReader(</span>
            <span class="s1">StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None, </span><span class="s1">on_bad_lines=</span><span class="s5">1  </span><span class="s4"># Warn</span>
        <span class="s1">)</span>
        <span class="s1">reader.read()</span>
        <span class="s1">captured = capsys.readouterr()</span>

        <span class="s2">assert </span><span class="s3">&quot;Skipping line 4&quot; </span><span class="s2">in </span><span class="s1">captured.err</span>
        <span class="s2">assert </span><span class="s3">&quot;Skipping line 6&quot; </span><span class="s2">in </span><span class="s1">captured.err</span>

    <span class="s2">def </span><span class="s1">test_header_not_enough_lines(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;skip this</span><span class="s2">\n</span><span class="s3">skip this</span><span class="s2">\n</span><span class="s3">a,b,c</span><span class="s2">\n</span><span class="s3">1,2,3</span><span class="s2">\n</span><span class="s3">4,5,6&quot;</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">header = reader.header</span>
        <span class="s1">expected = [[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]]</span>
        <span class="s2">assert </span><span class="s1">header == expected</span>

        <span class="s1">recs = reader.read()</span>
        <span class="s1">expected = {</span>
            <span class="s5">0</span><span class="s1">: np.array([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.int64)</span><span class="s2">,</span>
            <span class="s5">1</span><span class="s1">: np.array([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.int64)</span><span class="s2">,</span>
            <span class="s5">2</span><span class="s1">: np.array([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.int64)</span><span class="s2">,</span>
        <span class="s1">}</span>
        <span class="s1">assert_array_dicts_equal(recs</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_escapechar(self):</span>
        <span class="s1">data = </span><span class="s3">'</span><span class="s2">\\</span><span class="s3">&quot;hello world&quot;</span><span class="s2">\n\\</span><span class="s3">&quot;hello world&quot;</span><span class="s2">\n\\</span><span class="s3">&quot;hello world&quot;'</span>

        <span class="s1">reader = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None, </span><span class="s1">escapechar=</span><span class="s3">&quot;</span><span class="s2">\\</span><span class="s3">&quot;</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>
        <span class="s1">expected = {</span><span class="s5">0</span><span class="s1">: np.array([</span><span class="s3">'&quot;hello world&quot;'</span><span class="s1">] * </span><span class="s5">3</span><span class="s2">, </span><span class="s1">dtype=object)}</span>
        <span class="s1">assert_array_dicts_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_eof_has_eol(self):</span>
        <span class="s4"># handling of new line at EOF</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_na_substitution(self):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_numpy_string_dtype(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;&quot;&quot;</span><span class="s2">\ 
</span><span class="s3">a,1 
aa,2 
aaa,3 
aaaa,4 
aaaaa,5&quot;&quot;&quot;</span>

        <span class="s2">def </span><span class="s1">_make_reader(**kwds):</span>
            <span class="s2">if </span><span class="s3">&quot;dtype&quot; </span><span class="s2">in </span><span class="s1">kwds:</span>
                <span class="s1">kwds[</span><span class="s3">&quot;dtype&quot;</span><span class="s1">] = ensure_dtype_objs(kwds[</span><span class="s3">&quot;dtype&quot;</span><span class="s1">])</span>
            <span class="s2">return </span><span class="s1">TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None, </span><span class="s1">**kwds)</span>

        <span class="s1">reader = _make_reader(dtype=</span><span class="s3">&quot;S5,i4&quot;</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>

        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">0</span><span class="s1">].dtype == </span><span class="s3">&quot;S5&quot;</span>

        <span class="s1">ex_values = np.array([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;aa&quot;</span><span class="s2">, </span><span class="s3">&quot;aaa&quot;</span><span class="s2">, </span><span class="s3">&quot;aaaa&quot;</span><span class="s2">, </span><span class="s3">&quot;aaaaa&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s3">&quot;S5&quot;</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">(result[</span><span class="s5">0</span><span class="s1">] == ex_values).all()</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">1</span><span class="s1">].dtype == </span><span class="s3">&quot;i4&quot;</span>

        <span class="s1">reader = _make_reader(dtype=</span><span class="s3">&quot;S4&quot;</span><span class="s1">)</span>
        <span class="s1">result = reader.read()</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">0</span><span class="s1">].dtype == </span><span class="s3">&quot;S4&quot;</span>
        <span class="s1">ex_values = np.array([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;aa&quot;</span><span class="s2">, </span><span class="s3">&quot;aaa&quot;</span><span class="s2">, </span><span class="s3">&quot;aaaa&quot;</span><span class="s2">, </span><span class="s3">&quot;aaaa&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s3">&quot;S4&quot;</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">(result[</span><span class="s5">0</span><span class="s1">] == ex_values).all()</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">1</span><span class="s1">].dtype == </span><span class="s3">&quot;S4&quot;</span>

    <span class="s2">def </span><span class="s1">test_pass_dtype(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;&quot;&quot;</span><span class="s2">\ 
</span><span class="s3">one,two 
1,a 
2,b 
3,c 
4,d&quot;&quot;&quot;</span>

        <span class="s2">def </span><span class="s1">_make_reader(**kwds):</span>
            <span class="s2">if </span><span class="s3">&quot;dtype&quot; </span><span class="s2">in </span><span class="s1">kwds:</span>
                <span class="s1">kwds[</span><span class="s3">&quot;dtype&quot;</span><span class="s1">] = ensure_dtype_objs(kwds[</span><span class="s3">&quot;dtype&quot;</span><span class="s1">])</span>
            <span class="s2">return </span><span class="s1">TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s2">, </span><span class="s1">**kwds)</span>

        <span class="s1">reader = _make_reader(dtype={</span><span class="s3">&quot;one&quot;</span><span class="s1">: </span><span class="s3">&quot;u1&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s1">: </span><span class="s3">&quot;S1&quot;</span><span class="s1">})</span>
        <span class="s1">result = reader.read()</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">0</span><span class="s1">].dtype == </span><span class="s3">&quot;u1&quot;</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">1</span><span class="s1">].dtype == </span><span class="s3">&quot;S1&quot;</span>

        <span class="s1">reader = _make_reader(dtype={</span><span class="s3">&quot;one&quot;</span><span class="s1">: np.uint8</span><span class="s2">, </span><span class="s5">1</span><span class="s1">: object})</span>
        <span class="s1">result = reader.read()</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">0</span><span class="s1">].dtype == </span><span class="s3">&quot;u1&quot;</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">1</span><span class="s1">].dtype == </span><span class="s3">&quot;O&quot;</span>

        <span class="s1">reader = _make_reader(dtype={</span><span class="s3">&quot;one&quot;</span><span class="s1">: np.dtype(</span><span class="s3">&quot;u1&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">1</span><span class="s1">: np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)})</span>
        <span class="s1">result = reader.read()</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">0</span><span class="s1">].dtype == </span><span class="s3">&quot;u1&quot;</span>
        <span class="s2">assert </span><span class="s1">result[</span><span class="s5">1</span><span class="s1">].dtype == </span><span class="s3">&quot;O&quot;</span>

    <span class="s2">def </span><span class="s1">test_usecols(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;&quot;&quot;</span><span class="s2">\ 
</span><span class="s3">a,b,c 
1,2,3 
4,5,6 
7,8,9 
10,11,12&quot;&quot;&quot;</span>

        <span class="s2">def </span><span class="s1">_make_reader(**kwds):</span>
            <span class="s2">return </span><span class="s1">TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s2">, </span><span class="s1">**kwds)</span>

        <span class="s1">reader = _make_reader(usecols=(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">result = reader.read()</span>

        <span class="s1">exp = _make_reader().read()</span>
        <span class="s2">assert </span><span class="s1">len(result) == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">(result[</span><span class="s5">1</span><span class="s1">] == exp[</span><span class="s5">1</span><span class="s1">]).all()</span>
        <span class="s2">assert </span><span class="s1">(result[</span><span class="s5">2</span><span class="s1">] == exp[</span><span class="s5">2</span><span class="s1">]).all()</span>

    <span class="s2">def </span><span class="s1">test_cr_delimited(self):</span>
        <span class="s2">def </span><span class="s1">_test(text</span><span class="s2">, </span><span class="s1">**kwargs):</span>
            <span class="s1">nice_text = text.replace(</span><span class="s3">&quot;</span><span class="s2">\r</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s2">\r\n</span><span class="s3">&quot;</span><span class="s1">)</span>
            <span class="s1">result = TextReader(StringIO(text)</span><span class="s2">, </span><span class="s1">**kwargs).read()</span>
            <span class="s1">expected = TextReader(StringIO(nice_text)</span><span class="s2">, </span><span class="s1">**kwargs).read()</span>
            <span class="s1">assert_array_dicts_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">data = </span><span class="s3">&quot;a,b,c</span><span class="s2">\r</span><span class="s3">1,2,3</span><span class="s2">\r</span><span class="s3">4,5,6</span><span class="s2">\r</span><span class="s3">7,8,9</span><span class="s2">\r</span><span class="s3">10,11,12&quot;</span>
        <span class="s1">_test(data</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s1">)</span>

        <span class="s1">data = </span><span class="s3">&quot;a  b  c</span><span class="s2">\r</span><span class="s3">1  2  3</span><span class="s2">\r</span><span class="s3">4  5  6</span><span class="s2">\r</span><span class="s3">7  8  9</span><span class="s2">\r</span><span class="s3">10  11  12&quot;</span>
        <span class="s1">_test(data</span><span class="s2">, </span><span class="s1">delim_whitespace=</span><span class="s2">True</span><span class="s1">)</span>

        <span class="s1">data = </span><span class="s3">&quot;a,b,c</span><span class="s2">\r</span><span class="s3">1,2,3</span><span class="s2">\r</span><span class="s3">4,5,6</span><span class="s2">\r</span><span class="s3">,88,9</span><span class="s2">\r</span><span class="s3">10,11,12&quot;</span>
        <span class="s1">_test(data</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s1">)</span>

        <span class="s1">sample = (</span>
            <span class="s3">&quot;A,B,C,D,E,F,G,H,I,J,K,L,M,N,O</span><span class="s2">\r</span><span class="s3">&quot;</span>
            <span class="s3">&quot;AAAAA,BBBBB,0,0,0,0,0,0,0,0,0,0,0,0,0</span><span class="s2">\r</span><span class="s3">&quot;</span>
            <span class="s3">&quot;,BBBBB,0,0,0,0,0,0,0,0,0,0,0,0,0&quot;</span>
        <span class="s1">)</span>
        <span class="s1">_test(sample</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s1">)</span>

        <span class="s1">data = </span><span class="s3">&quot;A  B  C</span><span class="s2">\r  </span><span class="s3">2  3</span><span class="s2">\r</span><span class="s3">4  5  6&quot;</span>
        <span class="s1">_test(data</span><span class="s2">, </span><span class="s1">delim_whitespace=</span><span class="s2">True</span><span class="s1">)</span>

        <span class="s1">data = </span><span class="s3">&quot;A B C</span><span class="s2">\r</span><span class="s3">2 3</span><span class="s2">\r</span><span class="s3">4 5 6&quot;</span>
        <span class="s1">_test(data</span><span class="s2">, </span><span class="s1">delim_whitespace=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_empty_field_eof(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;a,b,c</span><span class="s2">\n</span><span class="s3">1,2,3</span><span class="s2">\n</span><span class="s3">4,,&quot;</span>

        <span class="s1">result = TextReader(StringIO(data)</span><span class="s2">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s1">).read()</span>

        <span class="s1">expected = {</span>
            <span class="s5">0</span><span class="s1">: np.array([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.int64)</span><span class="s2">,</span>
            <span class="s5">1</span><span class="s1">: np.array([</span><span class="s3">&quot;2&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=object)</span><span class="s2">,</span>
            <span class="s5">2</span><span class="s1">: np.array([</span><span class="s3">&quot;3&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=object)</span><span class="s2">,</span>
        <span class="s1">}</span>
        <span class="s1">assert_array_dicts_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s4"># GH5664</span>
        <span class="s1">a = DataFrame([[</span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[np.nan]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">b = DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s3">&quot;abcd&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">c = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s1">[</span><span class="s5">6</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s1">np.nan]</span><span class="s2">,</span>
                <span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s1">[</span><span class="s5">13</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s1">np.nan]</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s1">columns=list(</span><span class="s3">&quot;abcd&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">index=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">12</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">100</span><span class="s1">):</span>
            <span class="s1">df = read_csv(StringIO(</span><span class="s3">&quot;a,b</span><span class="s2">\n</span><span class="s3">c</span><span class="s2">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">skiprows=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">names=[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">engine=</span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">a)</span>

            <span class="s1">df = read_csv(</span>
                <span class="s1">StringIO(</span><span class="s3">&quot;1,1,1,1,0</span><span class="s2">\n</span><span class="s3">&quot; </span><span class="s1">* </span><span class="s5">2 </span><span class="s1">+ </span><span class="s3">&quot;</span><span class="s2">\n</span><span class="s3">&quot; </span><span class="s1">* </span><span class="s5">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">names=list(</span><span class="s3">&quot;abcd&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">engine=</span><span class="s3">&quot;c&quot;</span>
            <span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">b)</span>

            <span class="s1">df = read_csv(</span>
                <span class="s1">StringIO(</span><span class="s3">&quot;0,1,2,3,4</span><span class="s2">\n</span><span class="s3">5,6</span><span class="s2">\n</span><span class="s3">7,8,9,10,11</span><span class="s2">\n</span><span class="s3">12,13,14&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">names=list(</span><span class="s3">&quot;abcd&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">engine=</span><span class="s3">&quot;c&quot;</span><span class="s2">,</span>
            <span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">c)</span>

    <span class="s2">def </span><span class="s1">test_empty_csv_input(self):</span>
        <span class="s4"># GH14867</span>
        <span class="s2">with </span><span class="s1">read_csv(</span>
            <span class="s1">StringIO()</span><span class="s2">, </span><span class="s1">chunksize=</span><span class="s5">20</span><span class="s2">, </span><span class="s1">header=</span><span class="s2">None, </span><span class="s1">names=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">) </span><span class="s2">as </span><span class="s1">df:</span>
            <span class="s2">assert </span><span class="s1">isinstance(df</span><span class="s2">, </span><span class="s1">TextFileReader)</span>


<span class="s2">def </span><span class="s1">assert_array_dicts_equal(left</span><span class="s2">, </span><span class="s1">right):</span>
    <span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">left.items():</span>
        <span class="s1">tm.assert_numpy_array_equal(np.asarray(v)</span><span class="s2">, </span><span class="s1">np.asarray(right[k]))</span>
</pre>
</body>
</html>