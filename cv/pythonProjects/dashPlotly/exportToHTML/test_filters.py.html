<html>
<head>
<title>test_filters.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_filters.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>


<span class="s0">def </span><span class="s1">test_filter_series():</span>
    <span class="s1">s = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">22</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">7</span><span class="s1">])</span>
    <span class="s1">expected_odd = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
    <span class="s1">expected_even = Series([</span><span class="s2">20</span><span class="s0">, </span><span class="s2">22</span><span class="s0">, </span><span class="s2">24</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>
    <span class="s1">grouper = s.apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = s.groupby(grouper)</span>
    <span class="s1">tm.assert_series_equal(grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &lt; </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected_odd)</span>
    <span class="s1">tm.assert_series_equal(grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected_even)</span>
    <span class="s3"># Test dropna=False.</span>
    <span class="s1">tm.assert_series_equal(</span>
        <span class="s1">grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &lt; </span><span class="s2">10</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">expected_odd.reindex(s.index)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(</span>
        <span class="s1">grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">10</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">expected_even.reindex(s.index)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_filter_single_column_df():</span>
    <span class="s1">df = DataFrame([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">22</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">7</span><span class="s1">])</span>
    <span class="s1">expected_odd = DataFrame([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
    <span class="s1">expected_even = DataFrame([</span><span class="s2">20</span><span class="s0">, </span><span class="s2">22</span><span class="s0">, </span><span class="s2">24</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>
    <span class="s1">grouper = df[</span><span class="s2">0</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = df.groupby(grouper)</span>
    <span class="s1">tm.assert_frame_equal(grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &lt; </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected_odd)</span>
    <span class="s1">tm.assert_frame_equal(grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected_even)</span>
    <span class="s3"># Test dropna=False.</span>
    <span class="s1">tm.assert_frame_equal(</span>
        <span class="s1">grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &lt; </span><span class="s2">10</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">expected_odd.reindex(df.index)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(</span>
        <span class="s1">grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">10</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">expected_even.reindex(df.index)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_filter_multi_column_df():</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]})</span>
    <span class="s1">grouper = df[</span><span class="s4">&quot;A&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = df.groupby(grouper)</span>
    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(</span>
        <span class="s1">grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;A&quot;</span><span class="s1">].sum() - x[</span><span class="s4">&quot;B&quot;</span><span class="s1">].sum() &gt; </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_filter_mixed_df():</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: </span><span class="s4">&quot;a b c d&quot;</span><span class="s1">.split()})</span>
    <span class="s1">grouper = df[</span><span class="s4">&quot;A&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = df.groupby(grouper)</span>
    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;A&quot;</span><span class="s1">].sum() &gt; </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_out_all_groups():</span>
    <span class="s1">s = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">22</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">7</span><span class="s1">])</span>
    <span class="s1">grouper = s.apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = s.groupby(grouper)</span>
    <span class="s1">tm.assert_series_equal(grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">s[[]])</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: </span><span class="s4">&quot;a b c d&quot;</span><span class="s1">.split()})</span>
    <span class="s1">grouper = df[</span><span class="s4">&quot;A&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = df.groupby(grouper)</span>
    <span class="s1">tm.assert_frame_equal(grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;A&quot;</span><span class="s1">].sum() &gt; </span><span class="s2">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.loc[[]])</span>


<span class="s0">def </span><span class="s1">test_filter_out_no_groups():</span>
    <span class="s1">s = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">22</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">7</span><span class="s1">])</span>
    <span class="s1">grouper = s.apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = s.groupby(grouper)</span>
    <span class="s1">filtered = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(filtered</span><span class="s0">, </span><span class="s1">s)</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: </span><span class="s4">&quot;a b c d&quot;</span><span class="s1">.split()})</span>
    <span class="s1">grouper = df[</span><span class="s4">&quot;A&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = df.groupby(grouper)</span>
    <span class="s1">filtered = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;A&quot;</span><span class="s1">].mean() &gt; </span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(filtered</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_filter_out_all_groups_in_df():</span>
    <span class="s3"># GH12768</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]})</span>
    <span class="s1">res = df.groupby(</span><span class="s4">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">res = res.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;b&quot;</span><span class="s1">].sum() &gt; </span><span class="s2">5</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: [np.nan] * </span><span class="s2">3</span><span class="s1">})</span>
    <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">res)</span>

    <span class="s1">df = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]})</span>
    <span class="s1">res = df.groupby(</span><span class="s4">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">res = res.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;b&quot;</span><span class="s1">].sum() &gt; </span><span class="s2">5</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: []}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s4">&quot;int64&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">res)</span>


<span class="s0">def </span><span class="s1">test_filter_condition_raises():</span>
    <span class="s0">def </span><span class="s1">raise_if_sum_is_zero(x):</span>
        <span class="s0">if </span><span class="s1">x.sum() == </span><span class="s2">0</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s1">x.sum() &gt; </span><span class="s2">0</span>

    <span class="s1">s = Series([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">grouper = s.apply(</span><span class="s0">lambda </span><span class="s1">x: x % </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">grouped = s.groupby(grouper)</span>
    <span class="s1">msg = </span><span class="s4">&quot;the filter must return a boolean result&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">grouped.filter(raise_if_sum_is_zero)</span>


<span class="s0">def </span><span class="s1">test_filter_with_axis_in_groupby():</span>
    <span class="s3"># issue 11041</span>
    <span class="s1">index = pd.MultiIndex.from_product([range(</span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]])</span>
    <span class="s1">data = DataFrame(np.arange(</span><span class="s2">100</span><span class="s1">).reshape(-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=index</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s4">&quot;int64&quot;</span><span class="s1">)</span>
    <span class="s1">result = data.groupby(level=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">).filter(</span><span class="s0">lambda </span><span class="s1">x: x.iloc[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] &gt; </span><span class="s2">10</span><span class="s1">)</span>
    <span class="s1">expected = data.iloc[:</span><span class="s0">, </span><span class="s2">12</span><span class="s1">:</span><span class="s2">20</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_bad_shapes():</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: list(</span><span class="s4">&quot;aabbbbcc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)})</span>
    <span class="s1">s = df[</span><span class="s4">&quot;B&quot;</span><span class="s1">]</span>
    <span class="s1">g_df = df.groupby(</span><span class="s4">&quot;B&quot;</span><span class="s1">)</span>
    <span class="s1">g_s = s.groupby(s)</span>

    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">x: x</span>
    <span class="s1">msg = </span><span class="s4">&quot;filter function returned a DataFrame, but expected a scalar bool&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">g_df.filter(f)</span>
    <span class="s1">msg = </span><span class="s4">&quot;the filter must return a boolean result&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">g_s.filter(f)</span>

    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">x: x == </span><span class="s2">1</span>
    <span class="s1">msg = </span><span class="s4">&quot;filter function returned a DataFrame, but expected a scalar bool&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">g_df.filter(f)</span>
    <span class="s1">msg = </span><span class="s4">&quot;the filter must return a boolean result&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">g_s.filter(f)</span>

    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">x: np.outer(x</span><span class="s0">, </span><span class="s1">x)</span>
    <span class="s1">msg = </span><span class="s4">&quot;can't multiply sequence by non-int of type 'str'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">g_df.filter(f)</span>
    <span class="s1">msg = </span><span class="s4">&quot;the filter must return a boolean result&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">g_s.filter(f)</span>


<span class="s0">def </span><span class="s1">test_filter_nan_is_false():</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: list(</span><span class="s4">&quot;aabbbbcc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)})</span>
    <span class="s1">s = df[</span><span class="s4">&quot;B&quot;</span><span class="s1">]</span>
    <span class="s1">g_df = df.groupby(df[</span><span class="s4">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">g_s = s.groupby(s)</span>

    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">x: np.nan</span>
    <span class="s1">tm.assert_frame_equal(g_df.filter(f)</span><span class="s0">, </span><span class="s1">df.loc[[]])</span>
    <span class="s1">tm.assert_series_equal(g_s.filter(f)</span><span class="s0">, </span><span class="s1">s[[]])</span>


<span class="s0">def </span><span class="s1">test_filter_against_workaround():</span>
    <span class="s1">np.random.seed(</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s3"># Series of ints</span>
    <span class="s1">s = Series(np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">1000</span><span class="s1">))</span>
    <span class="s1">grouper = s.apply(</span><span class="s0">lambda </span><span class="s1">x: np.round(x</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">))</span>
    <span class="s1">grouped = s.groupby(grouper)</span>
    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">10</span>

    <span class="s1">old_way = s[grouped.transform(f).astype(</span><span class="s4">&quot;bool&quot;</span><span class="s1">)]</span>
    <span class="s1">new_way = grouped.filter(f)</span>
    <span class="s1">tm.assert_series_equal(new_way.sort_values()</span><span class="s0">, </span><span class="s1">old_way.sort_values())</span>

    <span class="s3"># Series of floats</span>
    <span class="s1">s = </span><span class="s2">100 </span><span class="s1">* Series(np.random.random(</span><span class="s2">1000</span><span class="s1">))</span>
    <span class="s1">grouper = s.apply(</span><span class="s0">lambda </span><span class="s1">x: np.round(x</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">))</span>
    <span class="s1">grouped = s.groupby(grouper)</span>
    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">10</span>
    <span class="s1">old_way = s[grouped.transform(f).astype(</span><span class="s4">&quot;bool&quot;</span><span class="s1">)]</span>
    <span class="s1">new_way = grouped.filter(f)</span>
    <span class="s1">tm.assert_series_equal(new_way.sort_values()</span><span class="s0">, </span><span class="s1">old_way.sort_values())</span>

    <span class="s3"># Set up DataFrame of ints, floats, strings.</span>
    <span class="s0">from </span><span class="s1">string </span><span class="s0">import </span><span class="s1">ascii_lowercase</span>

    <span class="s1">letters = np.array(list(ascii_lowercase))</span>
    <span class="s1">N = </span><span class="s2">1000</span>
    <span class="s1">random_letters = letters.take(np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">26</span><span class="s0">, </span><span class="s1">N))</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;ints&quot;</span><span class="s1">: Series(np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s1">N))</span><span class="s0">,</span>
            <span class="s4">&quot;floats&quot;</span><span class="s1">: N / </span><span class="s2">10 </span><span class="s1">* Series(np.random.random(N))</span><span class="s0">,</span>
            <span class="s4">&quot;letters&quot;</span><span class="s1">: Series(random_letters)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s3"># Group by ints; filter on floats.</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;ints&quot;</span><span class="s1">)</span>
    <span class="s1">old_way = df[grouped.floats.transform(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; N / </span><span class="s2">20</span><span class="s1">).astype(</span><span class="s4">&quot;bool&quot;</span><span class="s1">)]</span>
    <span class="s1">new_way = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;floats&quot;</span><span class="s1">].mean() &gt; N / </span><span class="s2">20</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(new_way</span><span class="s0">, </span><span class="s1">old_way)</span>

    <span class="s3"># Group by floats (rounded); filter on strings.</span>
    <span class="s1">grouper = df.floats.apply(</span><span class="s0">lambda </span><span class="s1">x: np.round(x</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">))</span>
    <span class="s1">grouped = df.groupby(grouper)</span>
    <span class="s1">old_way = df[grouped.letters.transform(</span><span class="s0">lambda </span><span class="s1">x: len(x) &lt; N / </span><span class="s2">10</span><span class="s1">).astype(</span><span class="s4">&quot;bool&quot;</span><span class="s1">)]</span>
    <span class="s1">new_way = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x.letters) &lt; N / </span><span class="s2">10</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(new_way</span><span class="s0">, </span><span class="s1">old_way)</span>

    <span class="s3"># Group by strings; filter on ints.</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;letters&quot;</span><span class="s1">)</span>
    <span class="s1">old_way = df[grouped.ints.transform(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; N / </span><span class="s2">20</span><span class="s1">).astype(</span><span class="s4">&quot;bool&quot;</span><span class="s1">)]</span>
    <span class="s1">new_way = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;ints&quot;</span><span class="s1">].mean() &gt; N / </span><span class="s2">20</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(new_way</span><span class="s0">, </span><span class="s1">old_way)</span>


<span class="s0">def </span><span class="s1">test_filter_using_len():</span>
    <span class="s3"># BUG GH4447</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: list(</span><span class="s4">&quot;aabbbbcc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)})</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;B&quot;</span><span class="s1">)</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;A&quot;</span><span class="s1">: np.arange(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">6</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: list(</span><span class="s4">&quot;bbbb&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: np.arange(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">6</span><span class="s1">)}</span><span class="s0">,</span>
        <span class="s1">index=np.arange(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">6</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">4</span><span class="s1">)</span>
    <span class="s1">expected = df.loc[[]]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Series have always worked properly, but we'll test anyway.</span>
    <span class="s1">s = df[</span><span class="s4">&quot;B&quot;</span><span class="s1">]</span>
    <span class="s1">grouped = s.groupby(s)</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">expected = Series(</span><span class="s2">4 </span><span class="s1">* [</span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=np.arange(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;B&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">4</span><span class="s1">)</span>
    <span class="s1">expected = s[[]]</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_maintains_ordering():</span>
    <span class="s3"># Simple case: index is sequential. #4621</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;pid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;tag&quot;</span><span class="s1">: [</span><span class="s2">23</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">62</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">34</span><span class="s0">, </span><span class="s2">25</span><span class="s0">, </span><span class="s2">62</span><span class="s1">]}</span>
    <span class="s1">)</span>
    <span class="s1">s = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">grouped = s.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = s.iloc[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]]</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Now index is sequentially decreasing.</span>
    <span class="s1">df.index = np.arange(len(df) - </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">s = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">grouped = s.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = s.iloc[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]]</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Index is shuffled.</span>
    <span class="s1">SHUFFLED = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span>
    <span class="s1">df.index = df.index[SHUFFLED]</span>
    <span class="s1">s = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">grouped = s.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">actual = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = s.iloc[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]]</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_multiple_timestamp():</span>
    <span class="s3"># GH 10114</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;A&quot;</span><span class="s1">: np.arange(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s4">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">&quot;foo&quot;</span><span class="s0">, </span><span class="s4">&quot;bar&quot;</span><span class="s0">, </span><span class="s4">&quot;foo&quot;</span><span class="s0">, </span><span class="s4">&quot;bar&quot;</span><span class="s0">, </span><span class="s4">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s4">&quot;C&quot;</span><span class="s1">: Timestamp(</span><span class="s4">&quot;20130101&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">grouped = df.groupby([</span><span class="s4">&quot;B&quot;</span><span class="s0">, </span><span class="s4">&quot;C&quot;</span><span class="s1">])</span>

    <span class="s1">result = grouped[</span><span class="s4">&quot;A&quot;</span><span class="s1">].filter(</span><span class="s0">lambda </span><span class="s1">x: </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(df[</span><span class="s4">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">result = grouped[</span><span class="s4">&quot;A&quot;</span><span class="s1">].transform(len)</span>
    <span class="s1">expected = Series([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = grouped.filter(</span><span class="s0">lambda </span><span class="s1">x: </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">result = grouped.transform(</span><span class="s4">&quot;sum&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = grouped.transform(len)</span>
    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_and_transform_with_non_unique_int_index():</span>
    <span class="s3"># GH4620</span>
    <span class="s1">index = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;pid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;tag&quot;</span><span class="s1">: [</span><span class="s2">23</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">62</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">34</span><span class="s0">, </span><span class="s2">25</span><span class="s0">, </span><span class="s2">62</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">grouped_df = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">ser = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped_ser = ser.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">expected_indexes = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span>

    <span class="s3"># Filter DataFrame</span>
    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[expected_indexes]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected.iloc[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]] = np.nan</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Filter Series</span>
    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = ser.take(expected_indexes)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">NA = np.nan</span>
    <span class="s1">expected = Series([NA</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s3"># ^ made manually because this can get confusing!</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform Series</span>
    <span class="s1">actual = grouped_ser.transform(len)</span>
    <span class="s1">expected = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform (a column from) DataFrameGroupBy</span>
    <span class="s1">actual = grouped_df.pid.transform(len)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_and_transform_with_multiple_non_unique_int_index():</span>
    <span class="s3"># GH4620</span>
    <span class="s1">index = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;pid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;tag&quot;</span><span class="s1">: [</span><span class="s2">23</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">62</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">34</span><span class="s0">, </span><span class="s2">25</span><span class="s0">, </span><span class="s2">62</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">grouped_df = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">ser = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped_ser = ser.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">expected_indexes = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span>

    <span class="s3"># Filter DataFrame</span>
    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[expected_indexes]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected.iloc[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]] = np.nan</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Filter Series</span>
    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = ser.take(expected_indexes)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">NA = np.nan</span>
    <span class="s1">expected = Series([NA</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s3"># ^ made manually because this can get confusing!</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform Series</span>
    <span class="s1">actual = grouped_ser.transform(len)</span>
    <span class="s1">expected = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform (a column from) DataFrameGroupBy</span>
    <span class="s1">actual = grouped_df.pid.transform(len)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_and_transform_with_non_unique_float_index():</span>
    <span class="s3"># GH4620</span>
    <span class="s1">index = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;pid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;tag&quot;</span><span class="s1">: [</span><span class="s2">23</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">62</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">34</span><span class="s0">, </span><span class="s2">25</span><span class="s0">, </span><span class="s2">62</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">grouped_df = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">ser = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped_ser = ser.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">expected_indexes = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span>

    <span class="s3"># Filter DataFrame</span>
    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[expected_indexes]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected.iloc[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]] = np.nan</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Filter Series</span>
    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = ser.take(expected_indexes)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">NA = np.nan</span>
    <span class="s1">expected = Series([NA</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s3"># ^ made manually because this can get confusing!</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform Series</span>
    <span class="s1">actual = grouped_ser.transform(len)</span>
    <span class="s1">expected = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform (a column from) DataFrameGroupBy</span>
    <span class="s1">actual = grouped_df.pid.transform(len)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_and_transform_with_non_unique_timestamp_index():</span>
    <span class="s3"># GH4620</span>
    <span class="s1">t0 = Timestamp(</span><span class="s4">&quot;2013-09-30 00:05:00&quot;</span><span class="s1">)</span>
    <span class="s1">t1 = Timestamp(</span><span class="s4">&quot;2013-10-30 00:05:00&quot;</span><span class="s1">)</span>
    <span class="s1">t2 = Timestamp(</span><span class="s4">&quot;2013-11-30 00:05:00&quot;</span><span class="s1">)</span>
    <span class="s1">index = [t1</span><span class="s0">, </span><span class="s1">t1</span><span class="s0">, </span><span class="s1">t1</span><span class="s0">, </span><span class="s1">t2</span><span class="s0">, </span><span class="s1">t1</span><span class="s0">, </span><span class="s1">t1</span><span class="s0">, </span><span class="s1">t0</span><span class="s0">, </span><span class="s1">t1]</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;pid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;tag&quot;</span><span class="s1">: [</span><span class="s2">23</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">62</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">34</span><span class="s0">, </span><span class="s2">25</span><span class="s0">, </span><span class="s2">62</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">grouped_df = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">ser = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped_ser = ser.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">expected_indexes = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span>

    <span class="s3"># Filter DataFrame</span>
    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[expected_indexes]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected.iloc[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]] = np.nan</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Filter Series</span>
    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = ser.take(expected_indexes)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">NA = np.nan</span>
    <span class="s1">expected = Series([NA</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s3"># ^ made manually because this can get confusing!</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform Series</span>
    <span class="s1">actual = grouped_ser.transform(len)</span>
    <span class="s1">expected = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform (a column from) DataFrameGroupBy</span>
    <span class="s1">actual = grouped_df.pid.transform(len)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_and_transform_with_non_unique_string_index():</span>
    <span class="s3"># GH4620</span>
    <span class="s1">index = list(</span><span class="s4">&quot;bbbcbbab&quot;</span><span class="s1">)</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;pid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">&quot;tag&quot;</span><span class="s1">: [</span><span class="s2">23</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">62</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">45</span><span class="s0">, </span><span class="s2">34</span><span class="s0">, </span><span class="s2">25</span><span class="s0">, </span><span class="s2">62</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">grouped_df = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span>
    <span class="s1">ser = df[</span><span class="s4">&quot;pid&quot;</span><span class="s1">]</span>
    <span class="s1">grouped_ser = ser.groupby(df[</span><span class="s4">&quot;tag&quot;</span><span class="s1">])</span>
    <span class="s1">expected_indexes = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span>

    <span class="s3"># Filter DataFrame</span>
    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[expected_indexes]</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_df.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected.iloc[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]] = np.nan</span>
    <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Filter Series</span>
    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">expected = ser.take(expected_indexes)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = grouped_ser.filter(</span><span class="s0">lambda </span><span class="s1">x: len(x) &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">NA = np.nan</span>
    <span class="s1">expected = Series([NA</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s1">NA</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s3"># ^ made manually because this can get confusing!</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform Series</span>
    <span class="s1">actual = grouped_ser.transform(len)</span>
    <span class="s1">expected = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">&quot;pid&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Transform (a column from) DataFrameGroupBy</span>
    <span class="s1">actual = grouped_df.pid.transform(len)</span>
    <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_filter_has_access_to_grouped_cols():</span>
    <span class="s1">df = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s4">&quot;A&quot;</span><span class="s0">, </span><span class="s4">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">g = df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s3"># previously didn't have access to col A #????</span>
    <span class="s1">filt = g.filter(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">&quot;A&quot;</span><span class="s1">].sum() == </span><span class="s2">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(filt</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_filter_enforces_scalarness():</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;worst&quot;</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s4">&quot;y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;c&quot;</span><span class="s0">, </span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s4">&quot;y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;worst&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s4">&quot;y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;worst&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s4">&quot;y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s4">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s4">&quot;filter function returned a.*&quot;</span><span class="s1">):</span>
        <span class="s1">df.groupby(</span><span class="s4">&quot;c&quot;</span><span class="s1">).filter(</span><span class="s0">lambda </span><span class="s1">g: g[</span><span class="s4">&quot;a&quot;</span><span class="s1">] == </span><span class="s4">&quot;best&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_filter_non_bool_raises():</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;worst&quot;</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;c&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;worst&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;worst&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">&quot;best&quot;</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s4">&quot;filter function returned a.*&quot;</span><span class="s1">):</span>
        <span class="s1">df.groupby(</span><span class="s4">&quot;a&quot;</span><span class="s1">).filter(</span><span class="s0">lambda </span><span class="s1">g: g.c.mean())</span>


<span class="s0">def </span><span class="s1">test_filter_dropna_with_empty_groups():</span>
    <span class="s3"># GH 10780</span>
    <span class="s1">data = Series(np.random.rand(</span><span class="s2">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=np.repeat([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">3</span><span class="s1">))</span>
    <span class="s1">groupped = data.groupby(level=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">result_false = groupped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">expected_false = Series([np.nan] * </span><span class="s2">9</span><span class="s0">, </span><span class="s1">index=np.repeat([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">3</span><span class="s1">))</span>
    <span class="s1">tm.assert_series_equal(result_false</span><span class="s0">, </span><span class="s1">expected_false)</span>

    <span class="s1">result_true = groupped.filter(</span><span class="s0">lambda </span><span class="s1">x: x.mean() &gt; </span><span class="s2">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected_true = Series(index=pd.Index([]</span><span class="s0">, </span><span class="s1">dtype=int)</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">tm.assert_series_equal(result_true</span><span class="s0">, </span><span class="s1">expected_true)</span>


<span class="s0">def </span><span class="s1">test_filter_consistent_result_before_after_agg_func():</span>
    <span class="s3"># GH 17091</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;data&quot;</span><span class="s1">: range(</span><span class="s2">6</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;key&quot;</span><span class="s1">: list(</span><span class="s4">&quot;ABCABC&quot;</span><span class="s1">)})</span>
    <span class="s1">grouper = df.groupby(</span><span class="s4">&quot;key&quot;</span><span class="s1">)</span>
    <span class="s1">result = grouper.filter(</span><span class="s0">lambda </span><span class="s1">x: </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;data&quot;</span><span class="s1">: range(</span><span class="s2">6</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;key&quot;</span><span class="s1">: list(</span><span class="s4">&quot;ABCABC&quot;</span><span class="s1">)})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">grouper.sum()</span>
    <span class="s1">result = grouper.filter(</span><span class="s0">lambda </span><span class="s1">x: </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>