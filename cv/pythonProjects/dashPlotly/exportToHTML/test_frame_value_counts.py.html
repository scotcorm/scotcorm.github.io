<html>
<head>
<title>test_frame_value_counts.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_frame_value_counts.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">CategoricalIndex</span><span class="s0">,</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">education_df():</span>
    <span class="s0">return </span><span class="s1">DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;gender&quot;</span><span class="s1">: [</span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;education&quot;</span><span class="s1">: [</span><span class="s2">&quot;low&quot;</span><span class="s0">, </span><span class="s2">&quot;medium&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;country&quot;</span><span class="s1">: [</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;FR&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_axis(education_df):</span>
    <span class="s1">gp = education_df.groupby(</span><span class="s2">&quot;country&quot;</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;axis&quot;</span><span class="s1">):</span>
        <span class="s1">gp.value_counts()</span>


<span class="s0">def </span><span class="s1">test_bad_subset(education_df):</span>
    <span class="s1">gp = education_df.groupby(</span><span class="s2">&quot;country&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;subset&quot;</span><span class="s1">):</span>
        <span class="s1">gp.value_counts(subset=[</span><span class="s2">&quot;country&quot;</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_basic(education_df):</span>
    <span class="s4"># gh43564</span>
    <span class="s1">result = education_df.groupby(</span><span class="s2">&quot;country&quot;</span><span class="s1">)[[</span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s2">&quot;education&quot;</span><span class="s1">]].value_counts(</span>
        <span class="s1">normalize=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">data=[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;medium&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;country&quot;</span><span class="s0">, </span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s2">&quot;education&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">_frame_value_counts(df</span><span class="s0">, </span><span class="s1">keys</span><span class="s0">, </span><span class="s1">normalize</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">ascending):</span>
    <span class="s0">return </span><span class="s1">df[keys].value_counts(normalize=normalize</span><span class="s0">, </span><span class="s1">sort=sort</span><span class="s0">, </span><span class="s1">ascending=ascending)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;groupby&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;column&quot;</span><span class="s0">, </span><span class="s2">&quot;array&quot;</span><span class="s0">, </span><span class="s2">&quot;function&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;normalize&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;sort, ascending&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">False, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, False</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;as_index&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;frame&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_against_frame_and_seriesgroupby(</span>
    <span class="s1">education_df</span><span class="s0">, </span><span class="s1">groupby</span><span class="s0">, </span><span class="s1">normalize</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">ascending</span><span class="s0">, </span><span class="s1">as_index</span><span class="s0">, </span><span class="s1">frame</span>
<span class="s1">):</span>
    <span class="s4"># test all parameters:</span>
    <span class="s4"># - Use column, array or function as by= parameter</span>
    <span class="s4"># - Whether or not to normalize</span>
    <span class="s4"># - Whether or not to sort and how</span>
    <span class="s4"># - Whether or not to use the groupby as an index</span>
    <span class="s4"># - 3-way compare against:</span>
    <span class="s4">#   - apply with :meth:`~DataFrame.value_counts`</span>
    <span class="s4">#   - `~SeriesGroupBy.value_counts`</span>
    <span class="s1">by = {</span>
        <span class="s2">&quot;column&quot;</span><span class="s1">: </span><span class="s2">&quot;country&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;array&quot;</span><span class="s1">: education_df[</span><span class="s2">&quot;country&quot;</span><span class="s1">].values</span><span class="s0">,</span>
        <span class="s2">&quot;function&quot;</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">x: education_df[</span><span class="s2">&quot;country&quot;</span><span class="s1">][x] == </span><span class="s2">&quot;US&quot;</span><span class="s0">,</span>
    <span class="s1">}[groupby]</span>

    <span class="s1">gp = education_df.groupby(by=by</span><span class="s0">, </span><span class="s1">as_index=as_index)</span>
    <span class="s1">result = gp[[</span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s2">&quot;education&quot;</span><span class="s1">]].value_counts(</span>
        <span class="s1">normalize=normalize</span><span class="s0">, </span><span class="s1">sort=sort</span><span class="s0">, </span><span class="s1">ascending=ascending</span>
    <span class="s1">)</span>
    <span class="s0">if </span><span class="s1">frame:</span>
        <span class="s4"># compare against apply with DataFrame value_counts</span>
        <span class="s1">expected = gp.apply(</span>
            <span class="s1">_frame_value_counts</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s2">&quot;education&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">normalize</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">ascending</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">as_index:</span>
            <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">name = </span><span class="s2">&quot;proportion&quot; </span><span class="s0">if </span><span class="s1">normalize </span><span class="s0">else </span><span class="s2">&quot;count&quot;</span>
            <span class="s1">expected = expected.reset_index().rename({</span><span class="s3">0</span><span class="s1">: name}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">groupby == </span><span class="s2">&quot;column&quot;</span><span class="s1">:</span>
                <span class="s1">expected = expected.rename({</span><span class="s2">&quot;level_0&quot;</span><span class="s1">: </span><span class="s2">&quot;country&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
                <span class="s1">expected[</span><span class="s2">&quot;country&quot;</span><span class="s1">] = np.where(expected[</span><span class="s2">&quot;country&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;FR&quot;</span><span class="s1">)</span>
            <span class="s0">elif </span><span class="s1">groupby == </span><span class="s2">&quot;function&quot;</span><span class="s1">:</span>
                <span class="s1">expected[</span><span class="s2">&quot;level_0&quot;</span><span class="s1">] = expected[</span><span class="s2">&quot;level_0&quot;</span><span class="s1">] == </span><span class="s3">1</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">expected[</span><span class="s2">&quot;level_0&quot;</span><span class="s1">] = np.where(expected[</span><span class="s2">&quot;level_0&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;FR&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># compare against SeriesGroupBy value_counts</span>
        <span class="s1">education_df[</span><span class="s2">&quot;both&quot;</span><span class="s1">] = education_df[</span><span class="s2">&quot;gender&quot;</span><span class="s1">] + </span><span class="s2">&quot;-&quot; </span><span class="s1">+ education_df[</span><span class="s2">&quot;education&quot;</span><span class="s1">]</span>
        <span class="s1">expected = gp[</span><span class="s2">&quot;both&quot;</span><span class="s1">].value_counts(</span>
            <span class="s1">normalize=normalize</span><span class="s0">, </span><span class="s1">sort=sort</span><span class="s0">, </span><span class="s1">ascending=ascending</span>
        <span class="s1">)</span>
        <span class="s1">expected.name = </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">as_index:</span>
            <span class="s1">index_frame = expected.index.to_frame(index=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">index_frame[</span><span class="s2">&quot;gender&quot;</span><span class="s1">] = index_frame[</span><span class="s2">&quot;both&quot;</span><span class="s1">].str.split(</span><span class="s2">&quot;-&quot;</span><span class="s1">).str.get(</span><span class="s3">0</span><span class="s1">)</span>
            <span class="s1">index_frame[</span><span class="s2">&quot;education&quot;</span><span class="s1">] = index_frame[</span><span class="s2">&quot;both&quot;</span><span class="s1">].str.split(</span><span class="s2">&quot;-&quot;</span><span class="s1">).str.get(</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s0">del </span><span class="s1">index_frame[</span><span class="s2">&quot;both&quot;</span><span class="s1">]</span>
            <span class="s1">index_frame = index_frame.rename({</span><span class="s3">0</span><span class="s1">: </span><span class="s0">None</span><span class="s1">}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s1">expected.index = MultiIndex.from_frame(index_frame)</span>
            <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">expected.insert(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s1">expected[</span><span class="s2">&quot;both&quot;</span><span class="s1">].str.split(</span><span class="s2">&quot;-&quot;</span><span class="s1">).str.get(</span><span class="s3">0</span><span class="s1">))</span>
            <span class="s1">expected.insert(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;education&quot;</span><span class="s0">, </span><span class="s1">expected[</span><span class="s2">&quot;both&quot;</span><span class="s1">].str.split(</span><span class="s2">&quot;-&quot;</span><span class="s1">).str.get(</span><span class="s3">1</span><span class="s1">))</span>
            <span class="s0">del </span><span class="s1">expected[</span><span class="s2">&quot;both&quot;</span><span class="s1">]</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;normalize&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;sort, ascending, expected_rows, expected_count, expected_group_size&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">False, None, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, False, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, True, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_compound(</span>
    <span class="s1">education_df</span><span class="s0">,</span>
    <span class="s1">normalize</span><span class="s0">,</span>
    <span class="s1">sort</span><span class="s0">,</span>
    <span class="s1">ascending</span><span class="s0">,</span>
    <span class="s1">expected_rows</span><span class="s0">,</span>
    <span class="s1">expected_count</span><span class="s0">,</span>
    <span class="s1">expected_group_size</span><span class="s0">,</span>
<span class="s1">):</span>
    <span class="s4"># Multiple groupby keys and as_index=False</span>
    <span class="s1">gp = education_df.groupby([</span><span class="s2">&quot;country&quot;</span><span class="s0">, </span><span class="s2">&quot;gender&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">result = gp[</span><span class="s2">&quot;education&quot;</span><span class="s1">].value_counts(</span>
        <span class="s1">normalize=normalize</span><span class="s0">, </span><span class="s1">sort=sort</span><span class="s0">, </span><span class="s1">ascending=ascending</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame()</span>
    <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;country&quot;</span><span class="s0">, </span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s2">&quot;education&quot;</span><span class="s1">]:</span>
        <span class="s1">expected[column] = [education_df[column][row] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">expected_rows]</span>
    <span class="s0">if </span><span class="s1">normalize:</span>
        <span class="s1">expected[</span><span class="s2">&quot;proportion&quot;</span><span class="s1">] = expected_count</span>
        <span class="s1">expected[</span><span class="s2">&quot;proportion&quot;</span><span class="s1">] /= expected_group_size</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected[</span><span class="s2">&quot;count&quot;</span><span class="s1">] = expected_count</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">animals_df():</span>
    <span class="s0">return </span><span class="s1">DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;num_legs&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;num_wings&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s2">&quot;falcon&quot;</span><span class="s0">, </span><span class="s2">&quot;dog&quot;</span><span class="s0">, </span><span class="s2">&quot;cat&quot;</span><span class="s0">, </span><span class="s2">&quot;ant&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;sort, ascending, normalize, expected_data, expected_index&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">False, None, False, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, True, False, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, False, False, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, False, True, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_data_frame_value_counts(</span>
    <span class="s1">animals_df</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">ascending</span><span class="s0">, </span><span class="s1">normalize</span><span class="s0">, </span><span class="s1">expected_data</span><span class="s0">, </span><span class="s1">expected_index</span>
<span class="s1">):</span>
    <span class="s4"># 3-way compare with :meth:`~DataFrame.value_counts`</span>
    <span class="s4"># Tests from frame/methods/test_value_counts.py</span>
    <span class="s1">result_frame = animals_df.value_counts(</span>
        <span class="s1">sort=sort</span><span class="s0">, </span><span class="s1">ascending=ascending</span><span class="s0">, </span><span class="s1">normalize=normalize</span>
    <span class="s1">)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">data=expected_data</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_arrays(</span>
            <span class="s1">expected_index</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;num_legs&quot;</span><span class="s0">, </span><span class="s2">&quot;num_wings&quot;</span><span class="s1">]</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result_frame</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result_frame_groupby = animals_df.groupby(</span><span class="s2">&quot;key&quot;</span><span class="s1">).value_counts(</span>
        <span class="s1">sort=sort</span><span class="s0">, </span><span class="s1">ascending=ascending</span><span class="s0">, </span><span class="s1">normalize=normalize</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_series_equal(result_frame_groupby</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">nulls_df():</span>
    <span class="s1">n = np.nan</span>
    <span class="s0">return </span><span class="s1">DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">n]</span><span class="s0">,</span>
            <span class="s2">&quot;D&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">n]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;group_dropna, count_dropna, expected_rows, expected_values&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s0">False,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">False, True, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, False, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, True, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_dropna_combinations(</span>
    <span class="s1">nulls_df</span><span class="s0">, </span><span class="s1">group_dropna</span><span class="s0">, </span><span class="s1">count_dropna</span><span class="s0">, </span><span class="s1">expected_rows</span><span class="s0">, </span><span class="s1">expected_values</span>
<span class="s1">):</span>
    <span class="s1">gp = nulls_df.groupby([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=group_dropna)</span>
    <span class="s1">result = gp.value_counts(normalize=</span><span class="s0">True, </span><span class="s1">sort=</span><span class="s0">True, </span><span class="s1">dropna=count_dropna)</span>
    <span class="s1">columns = DataFrame()</span>
    <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">nulls_df.columns:</span>
        <span class="s1">columns[column] = [nulls_df[column][row] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">expected_rows]</span>
    <span class="s1">index = MultiIndex.from_frame(columns)</span>
    <span class="s1">expected = Series(data=expected_values</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">names_with_nulls_df(nulls_fixture):</span>
    <span class="s0">return </span><span class="s1">DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;first_name&quot;</span><span class="s1">: [</span><span class="s2">&quot;John&quot;</span><span class="s0">, </span><span class="s2">&quot;Anne&quot;</span><span class="s0">, </span><span class="s2">&quot;John&quot;</span><span class="s0">, </span><span class="s2">&quot;Beth&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;middle_name&quot;</span><span class="s1">: [</span><span class="s2">&quot;Smith&quot;</span><span class="s0">, </span><span class="s1">nulls_fixture</span><span class="s0">, </span><span class="s1">nulls_fixture</span><span class="s0">, </span><span class="s2">&quot;Louise&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, expected_data, expected_index&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">MultiIndex.from_arrays(</span>
                <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;Beth&quot;</span><span class="s0">, </span><span class="s2">&quot;John&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;Louise&quot;</span><span class="s0">, </span><span class="s2">&quot;Smith&quot;</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;first_name&quot;</span><span class="s0">, </span><span class="s2">&quot;middle_name&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">MultiIndex(</span>
                <span class="s1">levels=[</span>
                    <span class="s1">Index([</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                    <span class="s1">Index([</span><span class="s2">&quot;Anne&quot;</span><span class="s0">, </span><span class="s2">&quot;Beth&quot;</span><span class="s0">, </span><span class="s2">&quot;John&quot;</span><span class="s1">])</span><span class="s0">,</span>
                    <span class="s1">Index([</span><span class="s2">&quot;Louise&quot;</span><span class="s0">, </span><span class="s2">&quot;Smith&quot;</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;first_name&quot;</span><span class="s0">, </span><span class="s2">&quot;middle_name&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;normalize&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_data_frame_value_counts_dropna(</span>
    <span class="s1">names_with_nulls_df</span><span class="s0">, </span><span class="s1">dropna</span><span class="s0">, </span><span class="s1">normalize</span><span class="s0">, </span><span class="s1">expected_data</span><span class="s0">, </span><span class="s1">expected_index</span>
<span class="s1">):</span>
    <span class="s4"># GH 41334</span>
    <span class="s4"># 3-way compare with :meth:`~DataFrame.value_counts`</span>
    <span class="s4"># Tests with nulls from frame/methods/test_value_counts.py</span>
    <span class="s1">result_frame = names_with_nulls_df.value_counts(dropna=dropna</span><span class="s0">, </span><span class="s1">normalize=normalize)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">data=expected_data</span><span class="s0">,</span>
        <span class="s1">index=expected_index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">if </span><span class="s1">normalize:</span>
        <span class="s1">expected /= float(len(expected_data))</span>

    <span class="s1">tm.assert_series_equal(result_frame</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result_frame_groupby = names_with_nulls_df.groupby(</span><span class="s2">&quot;key&quot;</span><span class="s1">).value_counts(</span>
        <span class="s1">dropna=dropna</span><span class="s0">, </span><span class="s1">normalize=normalize</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_series_equal(result_frame_groupby</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;as_index&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;observed, expected_index&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;medium&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;medium&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;medium&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;medium&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;FR&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;medium&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;high&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;US&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, </span><span class="s2">&quot;low&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;normalize, expected_data&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">False, </span><span class="s1">np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">np.array([</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_categorical(</span>
    <span class="s1">education_df</span><span class="s0">, </span><span class="s1">as_index</span><span class="s0">, </span><span class="s1">observed</span><span class="s0">, </span><span class="s1">expected_index</span><span class="s0">, </span><span class="s1">normalize</span><span class="s0">, </span><span class="s1">expected_data</span>
<span class="s1">):</span>
    <span class="s4"># Test categorical data whether or not observed</span>
    <span class="s1">gp = education_df.astype(</span><span class="s2">&quot;category&quot;</span><span class="s1">).groupby(</span>
        <span class="s2">&quot;country&quot;</span><span class="s0">, </span><span class="s1">as_index=as_index</span><span class="s0">, </span><span class="s1">observed=observed</span>
    <span class="s1">)</span>
    <span class="s1">result = gp.value_counts(normalize=normalize)</span>

    <span class="s1">expected_series = Series(</span>
        <span class="s1">data=expected_data[expected_data &gt; </span><span class="s3">0.0</span><span class="s1">] </span><span class="s0">if </span><span class="s1">observed </span><span class="s0">else </span><span class="s1">expected_data</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples(</span>
            <span class="s1">expected_index</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;country&quot;</span><span class="s0">, </span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s2">&quot;education&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
        <span class="s1">expected_series.index = expected_series.index.set_levels(</span>
            <span class="s1">CategoricalIndex(expected_series.index.levels[i])</span><span class="s0">, </span><span class="s1">level=i</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">as_index:</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected_series)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = expected_series.reset_index(</span>
            <span class="s1">name=</span><span class="s2">&quot;proportion&quot; </span><span class="s0">if </span><span class="s1">normalize </span><span class="s0">else </span><span class="s2">&quot;count&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;normalize, expected_label, expected_values&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">False, </span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, </span><span class="s2">&quot;proportion&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_mixed_groupings(normalize</span><span class="s0">, </span><span class="s1">expected_label</span><span class="s0">, </span><span class="s1">expected_values):</span>
    <span class="s4"># Test multiple groupings</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">gp = df.groupby([[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, lambda </span><span class="s1">i: </span><span class="s3">7 </span><span class="s0">if </span><span class="s1">i == </span><span class="s3">1 </span><span class="s0">else </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">result = gp.value_counts(sort=</span><span class="s0">True, </span><span class="s1">normalize=normalize)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;level_0&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;level_2&quot;</span><span class="s1">: [</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">expected_label: expected_values</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;test, expected_names&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;repeat&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, None, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;level&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, None, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;level_1&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;as_index&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_column_name_clashes(test</span><span class="s0">, </span><span class="s1">expected_names</span><span class="s0">, </span><span class="s1">as_index):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]})</span>
    <span class="s0">if </span><span class="s1">test == </span><span class="s2">&quot;repeat&quot;</span><span class="s1">:</span>
        <span class="s1">df.columns = list(</span><span class="s2">&quot;abbde&quot;</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">df.columns = list(</span><span class="s2">&quot;abcd&quot;</span><span class="s1">) + [</span><span class="s2">&quot;level_1&quot;</span><span class="s1">]</span>

    <span class="s0">if </span><span class="s1">as_index:</span>
        <span class="s1">result = df.groupby([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">as_index=as_index).value_counts()</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">data=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">names=expected_names</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;cannot insert&quot;</span><span class="s1">):</span>
            <span class="s1">df.groupby([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">as_index=as_index).value_counts()</span>


<span class="s0">def </span><span class="s1">test_ambiguous_grouping():</span>
    <span class="s4"># Test that groupby is not confused by groupings length equal to row count</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]})</span>
    <span class="s1">gb = df.groupby([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">result = gb.value_counts()</span>
    <span class="s1">expected = Series([</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_tuples([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;a&quot;</span><span class="s1">]))</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>