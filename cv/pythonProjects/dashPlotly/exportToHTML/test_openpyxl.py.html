<html>
<head>
<title>test_openpyxl.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_openpyxl.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">re</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">DataFrame</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>

<span class="s0">from </span><span class="s1">pandas.io.excel </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">ExcelWriter</span><span class="s0">,</span>
    <span class="s1">_OpenpyxlWriter</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s1">openpyxl = pytest.importorskip(</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>

<span class="s1">pytestmark = pytest.mark.parametrize(</span><span class="s2">&quot;ext&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;.xlsx&quot;</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_to_excel_styleconverter(ext):</span>
    <span class="s0">from </span><span class="s1">openpyxl </span><span class="s0">import </span><span class="s1">styles</span>

    <span class="s1">hstyle = {</span>
        <span class="s2">&quot;font&quot;</span><span class="s1">: {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;00FF0000&quot;</span><span class="s0">, </span><span class="s2">&quot;bold&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;borders&quot;</span><span class="s1">: {</span><span class="s2">&quot;top&quot;</span><span class="s1">: </span><span class="s2">&quot;thin&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s1">: </span><span class="s2">&quot;thin&quot;</span><span class="s0">, </span><span class="s2">&quot;bottom&quot;</span><span class="s1">: </span><span class="s2">&quot;thin&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s1">: </span><span class="s2">&quot;thin&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;alignment&quot;</span><span class="s1">: {</span><span class="s2">&quot;horizontal&quot;</span><span class="s1">: </span><span class="s2">&quot;center&quot;</span><span class="s0">, </span><span class="s2">&quot;vertical&quot;</span><span class="s1">: </span><span class="s2">&quot;top&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;fill&quot;</span><span class="s1">: {</span><span class="s2">&quot;patternType&quot;</span><span class="s1">: </span><span class="s2">&quot;solid&quot;</span><span class="s0">, </span><span class="s2">&quot;fgColor&quot;</span><span class="s1">: {</span><span class="s2">&quot;rgb&quot;</span><span class="s1">: </span><span class="s2">&quot;006666FF&quot;</span><span class="s0">, </span><span class="s2">&quot;tint&quot;</span><span class="s1">: </span><span class="s3">0.3</span><span class="s1">}}</span><span class="s0">,</span>
        <span class="s2">&quot;number_format&quot;</span><span class="s1">: {</span><span class="s2">&quot;format_code&quot;</span><span class="s1">: </span><span class="s2">&quot;0.00&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;protection&quot;</span><span class="s1">: {</span><span class="s2">&quot;locked&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s2">&quot;hidden&quot;</span><span class="s1">: </span><span class="s0">False</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">font_color = styles.Color(</span><span class="s2">&quot;00FF0000&quot;</span><span class="s1">)</span>
    <span class="s1">font = styles.Font(bold=</span><span class="s0">True, </span><span class="s1">color=font_color)</span>
    <span class="s1">side = styles.Side(style=styles.borders.BORDER_THIN)</span>
    <span class="s1">border = styles.Border(top=side</span><span class="s0">, </span><span class="s1">right=side</span><span class="s0">, </span><span class="s1">bottom=side</span><span class="s0">, </span><span class="s1">left=side)</span>
    <span class="s1">alignment = styles.Alignment(horizontal=</span><span class="s2">&quot;center&quot;</span><span class="s0">, </span><span class="s1">vertical=</span><span class="s2">&quot;top&quot;</span><span class="s1">)</span>
    <span class="s1">fill_color = styles.Color(rgb=</span><span class="s2">&quot;006666FF&quot;</span><span class="s0">, </span><span class="s1">tint=</span><span class="s3">0.3</span><span class="s1">)</span>
    <span class="s1">fill = styles.PatternFill(patternType=</span><span class="s2">&quot;solid&quot;</span><span class="s0">, </span><span class="s1">fgColor=fill_color)</span>

    <span class="s1">number_format = </span><span class="s2">&quot;0.00&quot;</span>

    <span class="s1">protection = styles.Protection(locked=</span><span class="s0">True, </span><span class="s1">hidden=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">kw = _OpenpyxlWriter._convert_to_style_kwargs(hstyle)</span>
    <span class="s0">assert </span><span class="s1">kw[</span><span class="s2">&quot;font&quot;</span><span class="s1">] == font</span>
    <span class="s0">assert </span><span class="s1">kw[</span><span class="s2">&quot;border&quot;</span><span class="s1">] == border</span>
    <span class="s0">assert </span><span class="s1">kw[</span><span class="s2">&quot;alignment&quot;</span><span class="s1">] == alignment</span>
    <span class="s0">assert </span><span class="s1">kw[</span><span class="s2">&quot;fill&quot;</span><span class="s1">] == fill</span>
    <span class="s0">assert </span><span class="s1">kw[</span><span class="s2">&quot;number_format&quot;</span><span class="s1">] == number_format</span>
    <span class="s0">assert </span><span class="s1">kw[</span><span class="s2">&quot;protection&quot;</span><span class="s1">] == protection</span>


<span class="s0">def </span><span class="s1">test_write_cells_merge_styled(ext):</span>
    <span class="s0">from </span><span class="s1">pandas.io.formats.excel </span><span class="s0">import </span><span class="s1">ExcelCell</span>

    <span class="s1">sheet_name = </span><span class="s2">&quot;merge_styled&quot;</span>

    <span class="s1">sty_b1 = {</span><span class="s2">&quot;font&quot;</span><span class="s1">: {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;00FF0000&quot;</span><span class="s1">}}</span>
    <span class="s1">sty_a2 = {</span><span class="s2">&quot;font&quot;</span><span class="s1">: {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;0000FF00&quot;</span><span class="s1">}}</span>

    <span class="s1">initial_cells = [</span>
        <span class="s1">ExcelCell(col=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">row=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">val=</span><span class="s3">42</span><span class="s0">, </span><span class="s1">style=sty_b1)</span><span class="s0">,</span>
        <span class="s1">ExcelCell(col=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">row=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">val=</span><span class="s3">99</span><span class="s0">, </span><span class="s1">style=sty_a2)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s1">sty_merged = {</span><span class="s2">&quot;font&quot;</span><span class="s1">: {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;000000FF&quot;</span><span class="s0">, </span><span class="s2">&quot;bold&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}}</span>
    <span class="s1">sty_kwargs = _OpenpyxlWriter._convert_to_style_kwargs(sty_merged)</span>
    <span class="s1">openpyxl_sty_merged = sty_kwargs[</span><span class="s2">&quot;font&quot;</span><span class="s1">]</span>
    <span class="s1">merge_cells = [</span>
        <span class="s1">ExcelCell(</span>
            <span class="s1">col=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">row=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">val=</span><span class="s2">&quot;pandas&quot;</span><span class="s0">, </span><span class="s1">mergestart=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">mergeend=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">style=sty_merged</span>
        <span class="s1">)</span>
    <span class="s1">]</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s0">with </span><span class="s1">_OpenpyxlWriter(path) </span><span class="s0">as </span><span class="s1">writer:</span>
            <span class="s1">writer.write_cells(initial_cells</span><span class="s0">, </span><span class="s1">sheet_name=sheet_name)</span>
            <span class="s1">writer.write_cells(merge_cells</span><span class="s0">, </span><span class="s1">sheet_name=sheet_name)</span>

            <span class="s1">wks = writer.sheets[sheet_name]</span>
        <span class="s1">xcell_b1 = wks[</span><span class="s2">&quot;B1&quot;</span><span class="s1">]</span>
        <span class="s1">xcell_a2 = wks[</span><span class="s2">&quot;A2&quot;</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">xcell_b1.font == openpyxl_sty_merged</span>
        <span class="s0">assert </span><span class="s1">xcell_a2.font == openpyxl_sty_merged</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;iso_dates&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_kwargs(ext</span><span class="s0">, </span><span class="s1">iso_dates):</span>
    <span class="s4"># GH 42286 GH 43445</span>
    <span class="s1">kwargs = {</span><span class="s2">&quot;iso_dates&quot;</span><span class="s1">: iso_dates}</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">msg = re.escape(</span><span class="s2">&quot;Use of **kwargs is deprecated&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s0">with </span><span class="s1">ExcelWriter(f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">**kwargs) </span><span class="s0">as </span><span class="s1">writer:</span>
                <span class="s0">assert </span><span class="s1">writer.book.iso_dates == iso_dates</span>
                <span class="s4"># ExcelWriter won't allow us to close without writing something</span>
                <span class="s1">DataFrame().to_excel(writer)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;iso_dates&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_engine_kwargs_write(ext</span><span class="s0">, </span><span class="s1">iso_dates):</span>
    <span class="s4"># GH 42286 GH 43445</span>
    <span class="s1">engine_kwargs = {</span><span class="s2">&quot;iso_dates&quot;</span><span class="s1">: iso_dates}</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">with </span><span class="s1">ExcelWriter(f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">engine_kwargs=engine_kwargs) </span><span class="s0">as </span><span class="s1">writer:</span>
            <span class="s0">assert </span><span class="s1">writer.book.iso_dates == iso_dates</span>
            <span class="s4"># ExcelWriter won't allow us to close without writing something</span>
            <span class="s1">DataFrame().to_excel(writer)</span>


<span class="s0">def </span><span class="s1">test_engine_kwargs_append_invalid(ext):</span>
    <span class="s4"># GH 43445</span>
    <span class="s4"># test whether an invalid engine kwargs actually raises</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">DataFrame([</span><span class="s2">&quot;hello&quot;</span><span class="s0">, </span><span class="s2">&quot;world&quot;</span><span class="s1">]).to_excel(f)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">TypeError</span><span class="s0">,</span>
            <span class="s1">match=re.escape(</span>
                <span class="s2">&quot;load_workbook() got an unexpected keyword argument 'apple_banana'&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">):</span>
            <span class="s0">with </span><span class="s1">ExcelWriter(</span>
                <span class="s1">f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">engine_kwargs={</span><span class="s2">&quot;apple_banana&quot;</span><span class="s1">: </span><span class="s2">&quot;fruit&quot;</span><span class="s1">}</span>
            <span class="s1">) </span><span class="s0">as </span><span class="s1">writer:</span>
                <span class="s4"># ExcelWriter needs us to write something to close properly</span>
                <span class="s1">DataFrame([</span><span class="s2">&quot;good&quot;</span><span class="s1">]).to_excel(writer</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;Sheet2&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;data_only, expected&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">True, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, </span><span class="s2">&quot;=1+1&quot;</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_engine_kwargs_append_data_only(ext</span><span class="s0">, </span><span class="s1">data_only</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s4"># GH 43445</span>
    <span class="s4"># tests whether the data_only engine_kwarg actually works well for</span>
    <span class="s4"># openpyxl's load_workbook</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">DataFrame([</span><span class="s2">&quot;=1+1&quot;</span><span class="s1">]).to_excel(f)</span>
        <span class="s0">with </span><span class="s1">ExcelWriter(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">engine_kwargs={</span><span class="s2">&quot;data_only&quot;</span><span class="s1">: data_only}</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">writer:</span>
            <span class="s0">assert </span><span class="s1">writer.sheets[</span><span class="s2">&quot;Sheet1&quot;</span><span class="s1">][</span><span class="s2">&quot;B2&quot;</span><span class="s1">].value == expected</span>
            <span class="s4"># ExcelWriter needs us to writer something to close properly?</span>
            <span class="s1">DataFrame().to_excel(writer</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;Sheet2&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;mode,expected&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;baz&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">&quot;baz&quot;</span><span class="s1">])]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_write_append_mode(ext</span><span class="s0">, </span><span class="s1">mode</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">df = DataFrame([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;baz&quot;</span><span class="s1">])</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">wb = openpyxl.Workbook()</span>
        <span class="s1">wb.worksheets[</span><span class="s3">0</span><span class="s1">].title = </span><span class="s2">&quot;foo&quot;</span>
        <span class="s1">wb.worksheets[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;A1&quot;</span><span class="s1">].value = </span><span class="s2">&quot;foo&quot;</span>
        <span class="s1">wb.create_sheet(</span><span class="s2">&quot;bar&quot;</span><span class="s1">)</span>
        <span class="s1">wb.worksheets[</span><span class="s3">1</span><span class="s1">][</span><span class="s2">&quot;A1&quot;</span><span class="s1">].value = </span><span class="s2">&quot;bar&quot;</span>
        <span class="s1">wb.save(f)</span>

        <span class="s0">with </span><span class="s1">ExcelWriter(f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">mode=mode) </span><span class="s0">as </span><span class="s1">writer:</span>
            <span class="s1">df.to_excel(writer</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;baz&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">wb2 = openpyxl.load_workbook(f)</span>
        <span class="s1">result = [sheet.title </span><span class="s0">for </span><span class="s1">sheet </span><span class="s0">in </span><span class="s1">wb2.worksheets]</span>
        <span class="s0">assert </span><span class="s1">result == expected</span>

        <span class="s0">for </span><span class="s1">index</span><span class="s0">, </span><span class="s1">cell_value </span><span class="s0">in </span><span class="s1">enumerate(expected):</span>
            <span class="s0">assert </span><span class="s1">wb2.worksheets[index][</span><span class="s2">&quot;A1&quot;</span><span class="s1">].value == cell_value</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;if_sheet_exists,num_sheets,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;new&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;apple&quot;</span><span class="s0">, </span><span class="s2">&quot;banana&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;replace&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;pear&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;overlay&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;pear&quot;</span><span class="s0">, </span><span class="s2">&quot;banana&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_if_sheet_exists_append_modes(ext</span><span class="s0">, </span><span class="s1">if_sheet_exists</span><span class="s0">, </span><span class="s1">num_sheets</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s4"># GH 40230</span>
    <span class="s1">df1 = DataFrame({</span><span class="s2">&quot;fruit&quot;</span><span class="s1">: [</span><span class="s2">&quot;apple&quot;</span><span class="s0">, </span><span class="s2">&quot;banana&quot;</span><span class="s1">]})</span>
    <span class="s1">df2 = DataFrame({</span><span class="s2">&quot;fruit&quot;</span><span class="s1">: [</span><span class="s2">&quot;pear&quot;</span><span class="s1">]})</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">df1.to_excel(f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">ExcelWriter(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">if_sheet_exists=if_sheet_exists</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">writer:</span>
            <span class="s1">df2.to_excel(writer</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">wb = openpyxl.load_workbook(f)</span>
        <span class="s0">assert </span><span class="s1">len(wb.sheetnames) == num_sheets</span>
        <span class="s0">assert </span><span class="s1">wb.sheetnames[</span><span class="s3">0</span><span class="s1">] == </span><span class="s2">&quot;foo&quot;</span>
        <span class="s1">result = pd.read_excel(wb</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">list(result[</span><span class="s2">&quot;fruit&quot;</span><span class="s1">]) == expected</span>
        <span class="s0">if </span><span class="s1">len(wb.sheetnames) == </span><span class="s3">2</span><span class="s1">:</span>
            <span class="s1">result = pd.read_excel(wb</span><span class="s0">, </span><span class="s1">wb.sheetnames[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df2)</span>
        <span class="s1">wb.close()</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;startrow, startcol, greeting, goodbye&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;poop&quot;</span><span class="s0">, </span><span class="s2">&quot;world&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;goodbye&quot;</span><span class="s0">, </span><span class="s2">&quot;people&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;hello&quot;</span><span class="s0">, </span><span class="s2">&quot;world&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;poop&quot;</span><span class="s0">, </span><span class="s2">&quot;people&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;hello&quot;</span><span class="s0">, </span><span class="s2">&quot;poop&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;goodbye&quot;</span><span class="s0">, </span><span class="s2">&quot;people&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;hello&quot;</span><span class="s0">, </span><span class="s2">&quot;world&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;goodbye&quot;</span><span class="s0">, </span><span class="s2">&quot;poop&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_append_overlay_startrow_startcol(ext</span><span class="s0">, </span><span class="s1">startrow</span><span class="s0">, </span><span class="s1">startcol</span><span class="s0">, </span><span class="s1">greeting</span><span class="s0">, </span><span class="s1">goodbye):</span>
    <span class="s1">df1 = DataFrame({</span><span class="s2">&quot;greeting&quot;</span><span class="s1">: [</span><span class="s2">&quot;hello&quot;</span><span class="s0">, </span><span class="s2">&quot;world&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;goodbye&quot;</span><span class="s1">: [</span><span class="s2">&quot;goodbye&quot;</span><span class="s0">, </span><span class="s2">&quot;people&quot;</span><span class="s1">]})</span>
    <span class="s1">df2 = DataFrame([</span><span class="s2">&quot;poop&quot;</span><span class="s1">])</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">df1.to_excel(f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;poo&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">ExcelWriter(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">if_sheet_exists=</span><span class="s2">&quot;overlay&quot;</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">writer:</span>
            <span class="s4"># use startrow+1 because we don't have a header</span>
            <span class="s1">df2.to_excel(</span>
                <span class="s1">writer</span><span class="s0">,</span>
                <span class="s1">index=</span><span class="s0">False,</span>
                <span class="s1">header=</span><span class="s0">False,</span>
                <span class="s1">startrow=startrow + </span><span class="s3">1</span><span class="s0">,</span>
                <span class="s1">startcol=startcol</span><span class="s0">,</span>
                <span class="s1">sheet_name=</span><span class="s2">&quot;poo&quot;</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s1">result = pd.read_excel(f</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;poo&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;greeting&quot;</span><span class="s1">: greeting</span><span class="s0">, </span><span class="s2">&quot;goodbye&quot;</span><span class="s1">: goodbye})</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;if_sheet_exists,msg&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s2">&quot;invalid&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;'invalid' is not valid for if_sheet_exists. Valid options &quot;</span>
            <span class="s2">&quot;are 'error', 'new', 'replace' and 'overlay'.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;error&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Sheet 'foo' already exists and if_sheet_exists is set to 'error'.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">None,</span>
            <span class="s2">&quot;Sheet 'foo' already exists and if_sheet_exists is set to 'error'.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_if_sheet_exists_raises(ext</span><span class="s0">, </span><span class="s1">if_sheet_exists</span><span class="s0">, </span><span class="s1">msg):</span>
    <span class="s4"># GH 40230</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;fruit&quot;</span><span class="s1">: [</span><span class="s2">&quot;pear&quot;</span><span class="s1">]})</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=re.escape(msg)):</span>
            <span class="s1">df.to_excel(f</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">ExcelWriter(</span>
                <span class="s1">f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">if_sheet_exists=if_sheet_exists</span>
            <span class="s1">) </span><span class="s0">as </span><span class="s1">writer:</span>
                <span class="s1">df.to_excel(writer</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_excel_with_openpyxl_engine(ext):</span>
    <span class="s4"># GH 29854</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">filename:</span>

        <span class="s1">df1 = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: np.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s2">&quot;B&quot;</span><span class="s1">: np.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)})</span>
        <span class="s1">df = pd.concat([df1</span><span class="s0">, </span><span class="s1">df2]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">styled = df.style.applymap(</span>
            <span class="s0">lambda </span><span class="s1">val: </span><span class="s2">&quot;color: %s&quot; </span><span class="s1">% (</span><span class="s2">&quot;red&quot; </span><span class="s0">if </span><span class="s1">val &lt; </span><span class="s3">0 </span><span class="s0">else </span><span class="s2">&quot;black&quot;</span><span class="s1">)</span>
        <span class="s1">).highlight_max()</span>

        <span class="s1">styled.to_excel(filename</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;read_only&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_read_workbook(datapath</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">read_only):</span>
    <span class="s4"># GH 39528</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;excel&quot;</span><span class="s0">, </span><span class="s2">&quot;test1&quot; </span><span class="s1">+ ext)</span>
    <span class="s1">wb = openpyxl.load_workbook(filename</span><span class="s0">, </span><span class="s1">read_only=read_only)</span>
    <span class="s1">result = pd.read_excel(wb</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>
    <span class="s1">wb.close()</span>
    <span class="s1">expected = pd.read_excel(filename)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;header, expected_data&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s2">&quot;Title&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;Unnamed: 1&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;Unnamed: 2&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;filename&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;dimension_missing&quot;</span><span class="s0">, </span><span class="s2">&quot;dimension_small&quot;</span><span class="s0">, </span><span class="s2">&quot;dimension_large&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s4"># When read_only is None, use read_excel instead of a workbook</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;read_only&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False, None</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_read_with_bad_dimension(</span>
    <span class="s1">datapath</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">expected_data</span><span class="s0">, </span><span class="s1">filename</span><span class="s0">, </span><span class="s1">read_only</span><span class="s0">, </span><span class="s1">request</span>
<span class="s1">):</span>
    <span class="s4"># GH 38956, 39001 - no/incorrect dimension information</span>
    <span class="s1">path = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;excel&quot;</span><span class="s0">, </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">filename</span><span class="s0">}{</span><span class="s1">ext</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">read_only </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">result = pd.read_excel(path</span><span class="s0">, </span><span class="s1">header=header)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">wb = openpyxl.load_workbook(path</span><span class="s0">, </span><span class="s1">read_only=read_only)</span>
        <span class="s1">result = pd.read_excel(wb</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">header=header)</span>
        <span class="s1">wb.close()</span>
    <span class="s1">expected = DataFrame(expected_data)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_append_mode_file(ext):</span>
    <span class="s4"># GH 39576</span>
    <span class="s1">df = DataFrame()</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(ext) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">df.to_excel(f</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">ExcelWriter(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s0">, </span><span class="s1">if_sheet_exists=</span><span class="s2">&quot;new&quot;</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">writer:</span>
            <span class="s1">df.to_excel(writer)</span>

        <span class="s4"># make sure that zip files are not concatenated by making sure that</span>
        <span class="s4"># &quot;docProps/app.xml&quot; only occurs twice in the file</span>
        <span class="s1">data = Path(f).read_bytes()</span>
        <span class="s1">first = data.find(</span><span class="s5">b&quot;docProps/app.xml&quot;</span><span class="s1">)</span>
        <span class="s1">second = data.find(</span><span class="s5">b&quot;docProps/app.xml&quot;</span><span class="s0">, </span><span class="s1">first + </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">third = data.find(</span><span class="s5">b&quot;docProps/app.xml&quot;</span><span class="s0">, </span><span class="s1">second + </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">second != -</span><span class="s3">1 </span><span class="s0">and </span><span class="s1">third == -</span><span class="s3">1</span>


<span class="s4"># When read_only is None, use read_excel instead of a workbook</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;read_only&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False, None</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_read_with_empty_trailing_rows(datapath</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">read_only</span><span class="s0">, </span><span class="s1">request):</span>
    <span class="s4"># GH 39181</span>
    <span class="s1">path = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;excel&quot;</span><span class="s0">, </span><span class="s2">f&quot;empty_trailing_rows</span><span class="s0">{</span><span class="s1">ext</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">read_only </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">result = pd.read_excel(path)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">wb = openpyxl.load_workbook(path</span><span class="s0">, </span><span class="s1">read_only=read_only)</span>
        <span class="s1">result = pd.read_excel(wb</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>
        <span class="s1">wb.close()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;Title&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;Unnamed: 1&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;Unnamed: 2&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s4"># When read_only is None, use read_excel instead of a workbook</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;read_only&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False, None</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_read_empty_with_blank_row(datapath</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">read_only):</span>
    <span class="s4"># GH 39547 - empty excel file with a row that has no data</span>
    <span class="s1">path = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;excel&quot;</span><span class="s0">, </span><span class="s2">f&quot;empty_with_blank_row</span><span class="s0">{</span><span class="s1">ext</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">read_only </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">result = pd.read_excel(path)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">wb = openpyxl.load_workbook(path</span><span class="s0">, </span><span class="s1">read_only=read_only)</span>
        <span class="s1">result = pd.read_excel(wb</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;openpyxl&quot;</span><span class="s1">)</span>
        <span class="s1">wb.close()</span>
    <span class="s1">expected = DataFrame()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>