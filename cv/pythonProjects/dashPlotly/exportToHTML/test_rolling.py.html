<html>
<head>
<title>test_rolling.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_rolling.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">datetime</span><span class="s0">,</span>
    <span class="s1">timedelta</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.compat </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">is_platform_arm</span><span class="s0">,</span>
    <span class="s1">is_platform_mac</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">pandas.errors </span><span class="s0">import </span><span class="s1">UnsupportedFunctionCall</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">DatetimeIndex</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timedelta</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
    <span class="s1">period_range</span><span class="s0">,</span>
    <span class="s1">to_datetime</span><span class="s0">,</span>
    <span class="s1">to_timedelta</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.api.indexers </span><span class="s0">import </span><span class="s1">BaseIndexer</span>
<span class="s0">from </span><span class="s1">pandas.core.window </span><span class="s0">import </span><span class="s1">Rolling</span>


<span class="s0">def </span><span class="s1">test_doc_string():</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]})</span>
    <span class="s1">df</span>
    <span class="s1">df.rolling(</span><span class="s3">2</span><span class="s1">).sum()</span>
    <span class="s1">df.rolling(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).sum()</span>


<span class="s0">def </span><span class="s1">test_constructor(frame_or_series):</span>
    <span class="s4"># GH 12669</span>

    <span class="s1">c = frame_or_series(range(</span><span class="s3">5</span><span class="s1">)).rolling</span>

    <span class="s4"># valid</span>
    <span class="s1">c(</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">c(window=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">c(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">c(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">c(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s4"># GH 13383</span>

    <span class="s1">msg = </span><span class="s2">&quot;window must be an integer 0 or greater&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">c(-</span><span class="s3">1</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">2</span><span class="s1">])])</span>
<span class="s0">def </span><span class="s1">test_invalid_constructor(frame_or_series</span><span class="s0">, </span><span class="s1">w):</span>
    <span class="s4"># not valid</span>

    <span class="s1">c = frame_or_series(range(</span><span class="s3">5</span><span class="s1">)).rolling</span>

    <span class="s1">msg = </span><span class="s2">&quot;|&quot;</span><span class="s1">.join(</span>
        <span class="s1">[</span>
            <span class="s2">&quot;window must be an integer&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;passed window foo is not compatible with a datetimelike index&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">c(window=w)</span>

    <span class="s1">msg = </span><span class="s2">&quot;min_periods must be an integer&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">c(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=w)</span>

    <span class="s1">msg = </span><span class="s2">&quot;center must be a boolean&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">c(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=w)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;window&quot;</span><span class="s0">, </span><span class="s1">[timedelta(days=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timedelta(days=</span><span class="s3">3</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_constructor_with_timedelta_window(window):</span>
    <span class="s4"># GH 15440</span>
    <span class="s1">n = </span><span class="s3">10</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;value&quot;</span><span class="s1">: np.arange(n)}</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2015-12-24&quot;</span><span class="s0">, </span><span class="s1">periods=n</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected_data = np.append([</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">27.0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">result = df.rolling(window=window).sum()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;value&quot;</span><span class="s1">: expected_data}</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2015-12-24&quot;</span><span class="s0">, </span><span class="s1">periods=n</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">expected = df.rolling(</span><span class="s2">&quot;3D&quot;</span><span class="s1">).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;window&quot;</span><span class="s0">, </span><span class="s1">[timedelta(days=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timedelta(days=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;3D&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_constructor_timedelta_window_and_minperiods(window</span><span class="s0">, </span><span class="s1">raw):</span>
    <span class="s4"># GH 15305</span>
    <span class="s1">n = </span><span class="s3">10</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;value&quot;</span><span class="s1">: np.arange(n)}</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2017-08-08&quot;</span><span class="s0">, </span><span class="s1">periods=n</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;value&quot;</span><span class="s1">: np.append([np.NaN</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">27.0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))}</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2017-08-08&quot;</span><span class="s0">, </span><span class="s1">periods=n</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result_roll_sum = df.rolling(window=window</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">2</span><span class="s1">).sum()</span>
    <span class="s1">result_roll_generic = df.rolling(window=window</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">2</span><span class="s1">).apply(sum</span><span class="s0">, </span><span class="s1">raw=raw)</span>
    <span class="s1">tm.assert_frame_equal(result_roll_sum</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result_roll_generic</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;std&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;var&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_numpy_compat(method):</span>
    <span class="s4"># see gh-12811</span>
    <span class="s1">r = Rolling(Series([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span><span class="s0">, </span><span class="s1">window=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">msg = </span><span class="s2">&quot;numpy operations are not valid with window objects&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(UnsupportedFunctionCall</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">getattr(r</span><span class="s0">, </span><span class="s1">method)(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(UnsupportedFunctionCall</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">getattr(r</span><span class="s0">, </span><span class="s1">method)(dtype=np.float64)</span>


<span class="s0">def </span><span class="s1">test_closed_fixed(closed</span><span class="s0">, </span><span class="s1">arithmetic_win_operators):</span>
    <span class="s4"># GH 34315</span>
    <span class="s1">func_name = arithmetic_win_operators</span>
    <span class="s1">df_fixed = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]})</span>
    <span class="s1">df_time = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s2">&quot;2020&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">result = getattr(</span>
        <span class="s1">df_fixed.rolling(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">closed=closed</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">func_name</span><span class="s0">,</span>
    <span class="s1">)()</span>
    <span class="s1">expected = getattr(</span>
        <span class="s1">df_time.rolling(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s1">closed=closed</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">func_name</span><span class="s0">,</span>
    <span class="s1">)().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;closed, window_selections&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s2">&quot;both&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s0">True, True, False, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">True, True, True, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, True, True, True, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, True, True, True</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, False, True, True</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;left&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s0">True, False, False, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">True, True, False, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, True, True, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, True, True, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, False, True, True</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;right&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s0">True, True, False, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, True, True, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, True, True, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, False, True, True</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, False, False, True</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;neither&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s0">True, False, False, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, True, False, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, True, False, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, False, True, False</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">False, False, False, False, True</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_datetimelike_centered_selections(</span>
    <span class="s1">closed</span><span class="s0">, </span><span class="s1">window_selections</span><span class="s0">, </span><span class="s1">arithmetic_win_operators</span>
<span class="s1">):</span>
    <span class="s4"># GH 34315</span>
    <span class="s1">func_name = arithmetic_win_operators</span>
    <span class="s1">df_time = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s2">&quot;2020&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [getattr(df_time[</span><span class="s2">&quot;A&quot;</span><span class="s1">].iloc[s]</span><span class="s0">, </span><span class="s1">func_name)() </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">window_selections]}</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2020&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">func_name == </span><span class="s2">&quot;sem&quot;</span><span class="s1">:</span>
        <span class="s1">kwargs = {</span><span class="s2">&quot;ddof&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">kwargs = {}</span>

    <span class="s1">result = getattr(</span>
        <span class="s1">df_time.rolling(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s1">closed=closed</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">func_name</span><span class="s0">,</span>
    <span class="s1">)(**kwargs)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;window,closed,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_datetimelike_centered_offset_covers_all(</span>
    <span class="s1">window</span><span class="s0">, </span><span class="s1">closed</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">frame_or_series</span>
<span class="s1">):</span>
    <span class="s4"># GH 42753</span>

    <span class="s1">index = [</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;20130101 09:00:01&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;20130101 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;20130101 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">df = frame_or_series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index)</span>

    <span class="s1">result = df.rolling(window</span><span class="s0">, </span><span class="s1">closed=closed</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">).sum()</span>
    <span class="s1">expected = frame_or_series(expected</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;window,closed,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_datetimelike_nonunique_index_centering(</span>
    <span class="s1">window</span><span class="s0">, </span><span class="s1">closed</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">frame_or_series</span>
<span class="s1">):</span>
    <span class="s1">index = DatetimeIndex(</span>
        <span class="s1">[</span>
            <span class="s2">&quot;2020-01-01&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;2020-01-01&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;2020-01-02&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;2020-01-02&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;2020-01-03&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;2020-01-03&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;2020-01-04&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;2020-01-04&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">df = frame_or_series([</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">8</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">expected = frame_or_series(expected</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">dtype=float)</span>

    <span class="s1">result = df.rolling(window</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True, </span><span class="s1">closed=closed).sum()</span>

    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_even_number_window_alignment():</span>
    <span class="s4"># see discussion in GH 38780</span>
    <span class="s1">s = Series(range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=date_range(start=</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">))</span>

    <span class="s4"># behavior of index- and datetime-based windows differs here!</span>
    <span class="s4"># s.rolling(window=2, min_periods=1, center=True).mean()</span>

    <span class="s1">result = s.rolling(window=</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">).mean()</span>

    <span class="s1">expected = Series([</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=s.index)</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_closed_fixed_binary_col(center):</span>
    <span class="s4"># GH 34315</span>
    <span class="s1">data = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;binary_col&quot;</span><span class="s1">: data}</span><span class="s0">,</span>
        <span class="s1">index=date_range(start=</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s1">periods=len(data))</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">center:</span>
        <span class="s1">expected_data = [</span><span class="s3">2 </span><span class="s1">/ </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.4</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.428571</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.571429</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected_data = [np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">/ </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.4</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.428571</span><span class="s1">]</span>

    <span class="s1">expected = DataFrame(</span>
        <span class="s1">expected_data</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;binary_col&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=date_range(start=</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s1">periods=len(expected_data))</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">rolling = df.rolling(window=len(df)</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=center)</span>
    <span class="s1">result = rolling.mean()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;closed&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_closed_empty(closed</span><span class="s0">, </span><span class="s1">arithmetic_win_operators):</span>
    <span class="s4"># GH 26005</span>
    <span class="s1">func_name = arithmetic_win_operators</span>
    <span class="s1">ser = Series(data=np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;2D&quot;</span><span class="s1">))</span>
    <span class="s1">roll = ser.rolling(</span><span class="s2">&quot;1D&quot;</span><span class="s0">, </span><span class="s1">closed=closed)</span>

    <span class="s1">result = getattr(roll</span><span class="s0">, </span><span class="s1">func_name)()</span>
    <span class="s1">expected = Series([np.nan] * </span><span class="s3">5</span><span class="s0">, </span><span class="s1">index=ser.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_closed_one_entry(func):</span>
    <span class="s4"># GH24718</span>
    <span class="s1">ser = Series(data=[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">result = getattr(ser.rolling(</span><span class="s2">&quot;10D&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">Series([np.nan]</span><span class="s0">, </span><span class="s1">index=ser.index))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_closed_one_entry_groupby(func):</span>
    <span class="s4"># GH24718</span>
    <span class="s1">ser = DataFrame(</span>
        <span class="s1">data={</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = getattr(</span>
        <span class="s1">ser.groupby(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">)[</span><span class="s2">&quot;B&quot;</span><span class="s1">].rolling(</span><span class="s2">&quot;10D&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func</span>
    <span class="s1">)()</span>
    <span class="s1">exp_idx = MultiIndex.from_arrays(arrays=[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ser.index]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s2">&quot;A&quot;</span><span class="s0">, None</span><span class="s1">))</span>
    <span class="s1">expected = Series(data=[np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">index=exp_idx</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;input_dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int&quot;</span><span class="s0">, </span><span class="s2">&quot;float&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func,closed,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_closed_min_max_datetime(input_dtype</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">closed</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s4"># see gh-21704</span>
    <span class="s1">ser = Series(</span>
        <span class="s1">data=np.arange(</span><span class="s3">10</span><span class="s1">).astype(input_dtype)</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">result = getattr(ser.rolling(</span><span class="s2">&quot;3D&quot;</span><span class="s0">, </span><span class="s1">closed=closed)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">expected = Series(expected</span><span class="s0">, </span><span class="s1">index=ser.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_closed_uneven():</span>
    <span class="s4"># see gh-21704</span>
    <span class="s1">ser = Series(data=np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s4"># uneven</span>
    <span class="s1">ser = ser.drop(index=ser.index[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]])</span>
    <span class="s1">result = ser.rolling(</span><span class="s2">&quot;3D&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s1">).min()</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=ser.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func,closed,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_closed_min_max_minp(func</span><span class="s0">, </span><span class="s1">closed</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s4"># see gh-21704</span>
    <span class="s1">ser = Series(data=np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">ser[ser.index[-</span><span class="s3">3</span><span class="s1">:]] = np.nan</span>
    <span class="s1">result = getattr(ser.rolling(</span><span class="s2">&quot;3D&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">closed=closed)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">expected = Series(expected</span><span class="s0">, </span><span class="s1">index=ser.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;closed,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2.5</span><span class="s0">, </span><span class="s3">3.5</span><span class="s0">, </span><span class="s3">4.5</span><span class="s0">, </span><span class="s3">5.5</span><span class="s0">, </span><span class="s3">6.5</span><span class="s0">, </span><span class="s3">7.5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2.5</span><span class="s0">, </span><span class="s3">3.5</span><span class="s0">, </span><span class="s3">4.5</span><span class="s0">, </span><span class="s3">5.5</span><span class="s0">, </span><span class="s3">6.5</span><span class="s0">, </span><span class="s3">7.5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_closed_median_quantile(closed</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s4"># GH 26005</span>
    <span class="s1">ser = Series(data=np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">roll = ser.rolling(</span><span class="s2">&quot;3D&quot;</span><span class="s0">, </span><span class="s1">closed=closed)</span>
    <span class="s1">expected = Series(expected</span><span class="s0">, </span><span class="s1">index=ser.index)</span>

    <span class="s1">result = roll.median()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = roll.quantile(</span><span class="s3">0.5</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;roller&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;1s&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">tests_empty_df_rolling(roller):</span>
    <span class="s4"># GH 15819 Verifies that datetime and integer rolling windows can be</span>
    <span class="s4"># applied to empty DataFrames</span>
    <span class="s1">expected = DataFrame()</span>
    <span class="s1">result = DataFrame().rolling(roller).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># Verifies that datetime and integer rolling windows can be applied to</span>
    <span class="s4"># empty DataFrames with datetime index</span>
    <span class="s1">expected = DataFrame(index=DatetimeIndex([]))</span>
    <span class="s1">result = DataFrame(index=DatetimeIndex([])).rolling(roller).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_empty_window_median_quantile():</span>
    <span class="s4"># GH 26005</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span>
    <span class="s1">roll = Series(np.arange(</span><span class="s3">3</span><span class="s1">)).rolling(</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s1">result = roll.median()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = roll.quantile(</span><span class="s3">0.1</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_missing_minp_zero():</span>
    <span class="s4"># https://github.com/pandas-dev/pandas/pull/18921</span>
    <span class="s4"># minp=0</span>
    <span class="s1">x = Series([np.nan])</span>
    <span class="s1">result = x.rolling(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">0</span><span class="s1">).sum()</span>
    <span class="s1">expected = Series([</span><span class="s3">0.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># minp=1</span>
    <span class="s1">result = x.rolling(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).sum()</span>
    <span class="s1">expected = Series([np.nan])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_missing_minp_zero_variable():</span>
    <span class="s4"># https://github.com/pandas-dev/pandas/pull/18921</span>
    <span class="s1">x = Series(</span>
        <span class="s1">[np.nan] * </span><span class="s3">4</span><span class="s0">,</span>
        <span class="s1">index=DatetimeIndex([</span><span class="s2">&quot;2017-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2017-01-04&quot;</span><span class="s0">, </span><span class="s2">&quot;2017-01-06&quot;</span><span class="s0">, </span><span class="s2">&quot;2017-01-07&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = x.rolling(Timedelta(</span><span class="s2">&quot;2d&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">0</span><span class="s1">).sum()</span>
    <span class="s1">expected = Series(</span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">index=x.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_multi_index_names():</span>

    <span class="s4"># GH 16789, 16825</span>
    <span class="s1">cols = MultiIndex.from_product([[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;E&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;1&quot;</span><span class="s0">, </span><span class="s2">&quot;2&quot;</span><span class="s1">])</span>
    <span class="s1">df = DataFrame(np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span><span class="s0">, </span><span class="s1">columns=cols)</span>
    <span class="s1">result = df.rolling(</span><span class="s3">3</span><span class="s1">).cov()</span>

    <span class="s1">tm.assert_index_equal(result.columns</span><span class="s0">, </span><span class="s1">df.columns)</span>
    <span class="s0">assert </span><span class="s1">result.index.names == [</span><span class="s0">None, </span><span class="s2">&quot;1&quot;</span><span class="s0">, </span><span class="s2">&quot;2&quot;</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_rolling_axis_sum(axis_frame):</span>
    <span class="s4"># see gh-23372.</span>
    <span class="s1">df = DataFrame(np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)))</span>
    <span class="s1">axis = df._get_axis_number(axis_frame)</span>

    <span class="s0">if </span><span class="s1">axis == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s1">expected = DataFrame({i: [np.nan] * </span><span class="s3">2 </span><span class="s1">+ [</span><span class="s3">3.0</span><span class="s1">] * </span><span class="s3">8 </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">20</span><span class="s1">)})</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># axis == 1</span>
        <span class="s1">expected = DataFrame([[np.nan] * </span><span class="s3">2 </span><span class="s1">+ [</span><span class="s3">3.0</span><span class="s1">] * </span><span class="s3">18</span><span class="s1">] * </span><span class="s3">10</span><span class="s1">)</span>

    <span class="s1">result = df.rolling(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis=axis_frame).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_axis_count(axis_frame):</span>
    <span class="s4"># see gh-26055</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: range(</span><span class="s3">3</span><span class="s1">)})</span>

    <span class="s1">axis = df._get_axis_number(axis_frame)</span>

    <span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">]:</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">]})</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">]})</span>

    <span class="s1">result = df.rolling(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis=axis_frame</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">0</span><span class="s1">).count()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_readonly_array():</span>
    <span class="s4"># GH-27766</span>
    <span class="s1">arr = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">arr.setflags(write=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">result = Series(arr).rolling(</span><span class="s3">2</span><span class="s1">).mean()</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_datetime(axis_frame</span><span class="s0">, </span><span class="s1">tz_naive_fixture):</span>
    <span class="s4"># GH-28192</span>
    <span class="s1">tz = tz_naive_fixture</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{i: [</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">date_range(</span><span class="s2">&quot;2019-8-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2019-08-03&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">tz=tz)}</span>
    <span class="s1">)</span>
    <span class="s0">if </span><span class="s1">axis_frame </span><span class="s0">in </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">]:</span>
        <span class="s1">result = df.T.rolling(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s1">axis=axis_frame).sum().T</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">result = df.rolling(</span><span class="s2">&quot;2D&quot;</span><span class="s0">, </span><span class="s1">axis=axis_frame).sum()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s1">**{</span>
                <span class="s1">i: [</span><span class="s3">1.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">date_range(</span><span class="s2">&quot;2019-8-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">tz=tz)</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">**{</span>
                <span class="s1">i: [</span><span class="s3">2.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">date_range(</span><span class="s2">&quot;2019-8-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2019-8-03&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">tz=tz)</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;center, expected_data&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">(</span>
                <span class="s1">[</span><span class="s3">88.0</span><span class="s1">] * </span><span class="s3">7</span>
                <span class="s1">+ [</span><span class="s3">97.0</span><span class="s1">] * </span><span class="s3">9</span>
                <span class="s1">+ [</span><span class="s3">98.0</span><span class="s1">]</span>
                <span class="s1">+ [</span><span class="s3">99.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">16</span>
                <span class="s1">+ [</span><span class="s3">93.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">89.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">96.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">94.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">90.0</span><span class="s1">] * </span><span class="s3">13</span>
                <span class="s1">+ [</span><span class="s3">88.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">90.0</span><span class="s1">] * </span><span class="s3">9</span>
                <span class="s1">+ [</span><span class="s3">96.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">6</span>
                <span class="s1">+ [</span><span class="s3">91.0</span><span class="s1">]</span>
                <span class="s1">+ [</span><span class="s3">87.0</span><span class="s1">] * </span><span class="s3">6</span>
                <span class="s1">+ [</span><span class="s3">92.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">83.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">86.0</span><span class="s1">] * </span><span class="s3">10</span>
                <span class="s1">+ [</span><span class="s3">87.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">98.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">97.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">93.0</span><span class="s1">] * </span><span class="s3">7</span>
                <span class="s1">+ [</span><span class="s3">87.0</span><span class="s1">] * </span><span class="s3">4</span>
                <span class="s1">+ [</span><span class="s3">86.0</span><span class="s1">] * </span><span class="s3">4</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">85.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">83.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">76.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">81.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">98.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">91.0</span><span class="s1">] * </span><span class="s3">7</span>
                <span class="s1">+ [</span><span class="s3">86.0</span><span class="s1">]</span>
                <span class="s1">+ [</span><span class="s3">93.0</span><span class="s1">] * </span><span class="s3">3</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">29</span>
                <span class="s1">+ [</span><span class="s3">77.0</span><span class="s1">] * </span><span class="s3">2</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">(</span>
                <span class="s1">[np.nan] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">88.0</span><span class="s1">] * </span><span class="s3">16</span>
                <span class="s1">+ [</span><span class="s3">97.0</span><span class="s1">] * </span><span class="s3">9</span>
                <span class="s1">+ [</span><span class="s3">98.0</span><span class="s1">]</span>
                <span class="s1">+ [</span><span class="s3">99.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">16</span>
                <span class="s1">+ [</span><span class="s3">93.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">89.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">96.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">94.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">90.0</span><span class="s1">] * </span><span class="s3">13</span>
                <span class="s1">+ [</span><span class="s3">88.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">90.0</span><span class="s1">] * </span><span class="s3">9</span>
                <span class="s1">+ [</span><span class="s3">96.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">6</span>
                <span class="s1">+ [</span><span class="s3">91.0</span><span class="s1">]</span>
                <span class="s1">+ [</span><span class="s3">87.0</span><span class="s1">] * </span><span class="s3">6</span>
                <span class="s1">+ [</span><span class="s3">92.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">83.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">86.0</span><span class="s1">] * </span><span class="s3">10</span>
                <span class="s1">+ [</span><span class="s3">87.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">98.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">97.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">93.0</span><span class="s1">] * </span><span class="s3">7</span>
                <span class="s1">+ [</span><span class="s3">87.0</span><span class="s1">] * </span><span class="s3">4</span>
                <span class="s1">+ [</span><span class="s3">86.0</span><span class="s1">] * </span><span class="s3">4</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">85.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">83.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">76.0</span><span class="s1">] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s3">81.0</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s3">98.0</span><span class="s1">] * </span><span class="s3">21</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">14</span>
                <span class="s1">+ [</span><span class="s3">91.0</span><span class="s1">] * </span><span class="s3">7</span>
                <span class="s1">+ [</span><span class="s3">86.0</span><span class="s1">]</span>
                <span class="s1">+ [</span><span class="s3">93.0</span><span class="s1">] * </span><span class="s3">3</span>
                <span class="s1">+ [</span><span class="s3">95.0</span><span class="s1">] * </span><span class="s3">20</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_window_as_string(center</span><span class="s0">, </span><span class="s1">expected_data):</span>
    <span class="s4"># see gh-22590</span>
    <span class="s1">date_today = datetime.now()</span>
    <span class="s1">days = date_range(date_today</span><span class="s0">, </span><span class="s1">date_today + timedelta(</span><span class="s3">365</span><span class="s1">)</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span>

    <span class="s1">npr = np.random.RandomState(seed=</span><span class="s3">421</span><span class="s1">)</span>

    <span class="s1">data = npr.randint(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">high=</span><span class="s3">100</span><span class="s0">, </span><span class="s1">size=len(days))</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;DateCol&quot;</span><span class="s1">: days</span><span class="s0">, </span><span class="s2">&quot;metric&quot;</span><span class="s1">: data})</span>

    <span class="s1">df.set_index(</span><span class="s2">&quot;DateCol&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">result = df.rolling(window=</span><span class="s2">&quot;21D&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">center=center)[</span>
        <span class="s2">&quot;metric&quot;</span>
    <span class="s1">].agg(</span><span class="s2">&quot;max&quot;</span><span class="s1">)</span>

    <span class="s1">index = days.rename(</span><span class="s2">&quot;DateCol&quot;</span><span class="s1">)</span>
    <span class="s1">index = index._with_freq(</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s1">expected = Series(expected_data</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;metric&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_min_periods1():</span>
    <span class="s4"># GH#6795</span>
    <span class="s1">df = DataFrame([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">result = df[</span><span class="s2">&quot;a&quot;</span><span class="s1">].rolling(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).max()</span>
    <span class="s1">expected = Series([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_count_with_min_periods(frame_or_series):</span>
    <span class="s4"># GH 26996</span>
    <span class="s1">result = frame_or_series(range(</span><span class="s3">5</span><span class="s1">)).rolling(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">3</span><span class="s1">).count()</span>
    <span class="s1">expected = frame_or_series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_count_default_min_periods_with_null_values(frame_or_series):</span>
    <span class="s4"># GH 26996</span>
    <span class="s1">values = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span>
    <span class="s1">expected_counts = [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span>

    <span class="s4"># GH 31302</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
        <span class="s1">result = frame_or_series(values).rolling(</span><span class="s3">3</span><span class="s1">).count()</span>
    <span class="s1">expected = frame_or_series(expected_counts)</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;df,expected,window,min_periods&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s0">,</span>
            <span class="s0">None,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]})</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]})</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(DataFrame()</span><span class="s0">, </span><span class="s1">[({}</span><span class="s0">, </span><span class="s1">[])]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_rolling_dataframe(df</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">window</span><span class="s0">, </span><span class="s1">min_periods):</span>
    <span class="s4"># GH 11704</span>
    <span class="s1">expected = [DataFrame(values</span><span class="s0">, </span><span class="s1">index=index) </span><span class="s0">for </span><span class="s1">(values</span><span class="s0">, </span><span class="s1">index) </span><span class="s0">in </span><span class="s1">expected]</span>

    <span class="s0">for </span><span class="s1">(expected</span><span class="s0">, </span><span class="s1">actual) </span><span class="s0">in </span><span class="s1">zip(</span>
        <span class="s1">expected</span><span class="s0">, </span><span class="s1">df.rolling(window</span><span class="s0">, </span><span class="s1">min_periods=min_periods)</span>
    <span class="s1">):</span>
        <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;expected,window&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;2D&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;3D&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;1D&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_rolling_on_dataframe(expected</span><span class="s0">, </span><span class="s1">window):</span>
    <span class="s4"># GH 11704, 40373</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;C&quot;</span><span class="s1">: date_range(start=</span><span class="s2">&quot;2016-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">expected = [</span>
        <span class="s1">DataFrame(values</span><span class="s0">, </span><span class="s1">index=df.loc[index</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]) </span><span class="s0">for </span><span class="s1">(values</span><span class="s0">, </span><span class="s1">index) </span><span class="s0">in </span><span class="s1">expected</span>
    <span class="s1">]</span>
    <span class="s0">for </span><span class="s1">(expected</span><span class="s0">, </span><span class="s1">actual) </span><span class="s0">in </span><span class="s1">zip(expected</span><span class="s0">, </span><span class="s1">df.rolling(window</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;C&quot;</span><span class="s1">)):</span>
        <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_iter_rolling_on_dataframe_unordered():</span>
    <span class="s4"># GH 43386</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})</span>
    <span class="s1">results = list(df.groupby(</span><span class="s2">&quot;a&quot;</span><span class="s1">).rolling(</span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">expecteds = [df.iloc[idx</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]] </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]]]</span>
    <span class="s0">for </span><span class="s1">result</span><span class="s0">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">zip(results</span><span class="s0">, </span><span class="s1">expecteds):</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;ser,expected,window, min_periods&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])]</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s0">,</span>
            <span class="s0">None,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])]</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_rolling_series(ser</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">window</span><span class="s0">, </span><span class="s1">min_periods):</span>
    <span class="s4"># GH 11704</span>
    <span class="s1">expected = [Series(values</span><span class="s0">, </span><span class="s1">index=index) </span><span class="s0">for </span><span class="s1">(values</span><span class="s0">, </span><span class="s1">index) </span><span class="s0">in </span><span class="s1">expected]</span>

    <span class="s0">for </span><span class="s1">(expected</span><span class="s0">, </span><span class="s1">actual) </span><span class="s0">in </span><span class="s1">zip(</span>
        <span class="s1">expected</span><span class="s0">, </span><span class="s1">ser.rolling(window</span><span class="s0">, </span><span class="s1">min_periods=min_periods)</span>
    <span class="s1">):</span>
        <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;expected,expected_index,window&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-02&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-03&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-04&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-05&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;1D&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-02&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-03&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-04&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;2D&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-02&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">date_range(</span><span class="s2">&quot;2020-01-03&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;3D&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_rolling_datetime(expected</span><span class="s0">, </span><span class="s1">expected_index</span><span class="s0">, </span><span class="s1">window):</span>
    <span class="s4"># GH 11704</span>
    <span class="s1">ser = Series(range(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=date_range(start=</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">))</span>

    <span class="s1">expected = [</span>
        <span class="s1">Series(values</span><span class="s0">, </span><span class="s1">index=idx) </span><span class="s0">for </span><span class="s1">(values</span><span class="s0">, </span><span class="s1">idx) </span><span class="s0">in </span><span class="s1">zip(expected</span><span class="s0">, </span><span class="s1">expected_index)</span>
    <span class="s1">]</span>

    <span class="s0">for </span><span class="s1">(expected</span><span class="s0">, </span><span class="s1">actual) </span><span class="s0">in </span><span class="s1">zip(expected</span><span class="s0">, </span><span class="s1">ser.rolling(window)):</span>
        <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;grouping,_index&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s2">&quot;level&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, None</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s2">&quot;by&quot;</span><span class="s1">: </span><span class="s2">&quot;X&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;X&quot;</span><span class="s0">, None</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_positional_argument(grouping</span><span class="s0">, </span><span class="s1">_index</span><span class="s0">, </span><span class="s1">raw):</span>
    <span class="s4"># GH 34605</span>

    <span class="s0">def </span><span class="s1">scaled_sum(*args):</span>
        <span class="s0">if </span><span class="s1">len(args) &lt; </span><span class="s3">2</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">&quot;The function needs two arguments&quot;</span><span class="s1">)</span>
        <span class="s1">array</span><span class="s0">, </span><span class="s1">scale = args</span>
        <span class="s0">return </span><span class="s1">array.sum() / scale</span>

    <span class="s1">df = DataFrame(data={</span><span class="s2">&quot;X&quot;</span><span class="s1">: range(</span><span class="s3">5</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">expected = DataFrame(data={</span><span class="s2">&quot;X&quot;</span><span class="s1">: [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=_index)</span>
    <span class="s4"># GH 40341</span>
    <span class="s0">if </span><span class="s2">&quot;by&quot; </span><span class="s0">in </span><span class="s1">grouping:</span>
        <span class="s1">expected = expected.drop(columns=</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s1">errors=</span><span class="s2">&quot;ignore&quot;</span><span class="s1">)</span>
    <span class="s1">result = df.groupby(**grouping).rolling(</span><span class="s3">1</span><span class="s1">).apply(scaled_sum</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">args=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;add&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rolling_numerical_accuracy_kahan_mean(add):</span>
    <span class="s4"># GH: 36031 implementing kahan summation</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">3002399751580331.0 </span><span class="s1">+ add</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;19700101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;19700101 09:00:03&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;19700101 09:00:06&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = (</span>
        <span class="s1">df.resample(</span><span class="s2">&quot;1s&quot;</span><span class="s1">).ffill().rolling(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">3</span><span class="s1">).mean()</span>
    <span class="s1">)</span>
    <span class="s1">dates = date_range(</span><span class="s2">&quot;19700101 09:00:00&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">7</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;S&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s3">3002399751580330.5</span><span class="s0">,</span>
                <span class="s3">2001599834386887.25</span><span class="s0">,</span>
                <span class="s3">1000799917193443.625</span><span class="s0">,</span>
                <span class="s3">0.0</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=dates</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_numerical_accuracy_kahan_sum():</span>
    <span class="s4"># GH: 13254</span>
    <span class="s1">df = DataFrame([</span><span class="s3">2.186</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.647</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;x&quot;</span><span class="s1">])</span>
    <span class="s1">result = df[</span><span class="s2">&quot;x&quot;</span><span class="s1">].rolling(</span><span class="s3">3</span><span class="s1">).sum()</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">0.539</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.647</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;x&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_numerical_accuracy_jump():</span>
    <span class="s4"># GH: 32761</span>
    <span class="s1">index = date_range(start=</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;2020-01-02&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;60s&quot;</span><span class="s1">).append(</span>
        <span class="s1">DatetimeIndex([</span><span class="s2">&quot;2020-01-03&quot;</span><span class="s1">])</span>
    <span class="s1">)</span>
    <span class="s1">data = np.random.rand(len(index))</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;data&quot;</span><span class="s1">: data}</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">result = df.rolling(</span><span class="s2">&quot;60s&quot;</span><span class="s1">).mean()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df[[</span><span class="s2">&quot;data&quot;</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_rolling_numerical_accuracy_small_values():</span>
    <span class="s4"># GH: 10319</span>
    <span class="s1">s = Series(</span>
        <span class="s1">data=[</span><span class="s3">0.00012456</span><span class="s0">, </span><span class="s3">0.0003</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;1999-02-03&quot;</span><span class="s0">, </span><span class="s2">&quot;1999-02-06&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = s.rolling(</span><span class="s3">1</span><span class="s1">).mean()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">s)</span>


<span class="s0">def </span><span class="s1">test_rolling_numerical_too_large_numbers():</span>
    <span class="s4"># GH: 11645</span>
    <span class="s1">dates = date_range(</span><span class="s2">&quot;2015-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span>
    <span class="s1">ds = Series(data=range(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=dates</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">ds[</span><span class="s3">2</span><span class="s1">] = -</span><span class="s3">9e33</span>
    <span class="s1">result = ds.rolling(</span><span class="s3">5</span><span class="s1">).mean()</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">[</span>
            <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">1.8e33</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">1.8e33</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">1.8e33</span><span class="s0">,</span>
            <span class="s3">5.0</span><span class="s0">,</span>
            <span class="s3">6.0</span><span class="s0">,</span>
            <span class="s3">7.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=dates</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;median&quot;</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_mixed_dtypes_axis_1(func</span><span class="s0">, </span><span class="s1">value):</span>
    <span class="s4"># GH: 20649</span>
    <span class="s1">df = DataFrame(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">df[</span><span class="s2">&quot;c&quot;</span><span class="s1">] = </span><span class="s3">1.0</span>
    <span class="s1">result = getattr(df.rolling(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [value</span><span class="s0">, </span><span class="s1">value]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [value</span><span class="s0">, </span><span class="s1">value]}</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_axis_one_with_nan():</span>
    <span class="s4"># GH: 35596</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result = df.rolling(window=</span><span class="s3">7</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">&quot;columns&quot;</span><span class="s1">).sum()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;value&quot;</span><span class="s0">,</span>
    <span class="s1">[</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s1">to_datetime(</span><span class="s2">&quot;2019-12-31&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">to_timedelta(</span><span class="s2">&quot;1 days 06:05:01.00003&quot;</span><span class="s1">)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_axis_1_non_numeric_dtypes(value):</span>
    <span class="s4"># GH: 20649</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})</span>
    <span class="s1">df[</span><span class="s2">&quot;b&quot;</span><span class="s1">] = value</span>
    <span class="s1">result = df.rolling(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">).sum()</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_on_df_transposed():</span>
    <span class="s4"># GH: 32724</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]})</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">11.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s1">]})</span>
    <span class="s1">result = df.rolling(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.T.rolling(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">window=</span><span class="s3">2</span><span class="s1">).sum().T</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s2">&quot;window&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">period_range(start=</span><span class="s2">&quot;2020-01-01 08:00&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;2020-01-01 08:08&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;T&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;2T&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">period_range(start=</span><span class="s2">&quot;2020-01-01 08:00&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;2020-01-01 12:00&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;30T&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;1h&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">13</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_period_index(index</span><span class="s0">, </span><span class="s1">window</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">values):</span>
    <span class="s4"># GH: 34225</span>
    <span class="s1">ds = Series([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">result = getattr(ds.rolling(window</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">expected = Series(values</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_sem(frame_or_series):</span>
    <span class="s4"># GH: 26476</span>
    <span class="s1">obj = frame_or_series([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">result = obj.rolling(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).sem()</span>
    <span class="s0">if </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">DataFrame):</span>
        <span class="s1">result = Series(result[</span><span class="s3">0</span><span class="s1">].values)</span>
    <span class="s1">expected = Series([np.nan] + [</span><span class="s3">0.7071067811865476</span><span class="s1">] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.xfail(is_platform_arm() </span><span class="s0">and not </span><span class="s1">is_platform_mac()</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;GH 38921&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s2">&quot;third_value&quot;</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;var&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5e33</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;std&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7.071068e16</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.7071068</span><span class="s0">, </span><span class="s3">0.7071068</span><span class="s0">, </span><span class="s3">1.414214</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;var&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5e33</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;std&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7.071068e16</span><span class="s0">, </span><span class="s3">0.7071068</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.7071068</span><span class="s0">, </span><span class="s3">1.414214</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_var_numerical_issues(func</span><span class="s0">, </span><span class="s1">third_value</span><span class="s0">, </span><span class="s1">values):</span>
    <span class="s4"># GH: 37051</span>
    <span class="s1">ds = Series([</span><span class="s3">99999999999999999</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">third_value</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">result = getattr(ds.rolling(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">expected = Series([np.nan] + values)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_timeoffset_as_window_parameter_for_corr():</span>
    <span class="s4"># GH: 28266</span>
    <span class="s1">exp = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s3">0.9999999999999998</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.3273268353539892</span><span class="s0">,</span>
                <span class="s3">0.9999999999999998</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">0.9999999999999998</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0000000000000002</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.3273268353539892</span><span class="s0">,</span>
                <span class="s3">0.9999999999999966</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0000000000000002</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0000000000000002</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples(</span>
            <span class="s1">[</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130102 09:00:02&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130102 09:00:02&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130103 09:00:03&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130103 09:00:03&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130105 09:00:05&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130105 09:00:05&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130106 09:00:06&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(Timestamp(</span><span class="s2">&quot;20130106 09:00:06&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;20130101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;20130102 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;20130103 09:00:03&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;20130105 09:00:05&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s2">&quot;20130106 09:00:06&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">res = df.rolling(window=</span><span class="s2">&quot;3d&quot;</span><span class="s1">).corr()</span>

    <span class="s1">tm.assert_frame_equal(exp</span><span class="s0">, </span><span class="s1">res)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;var&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;skew&quot;</span><span class="s0">, </span><span class="s2">&quot;kurt&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rolling_decreasing_indices(method):</span>
    <span class="s5">&quot;&quot;&quot; 
    Make sure that decreasing indices give the same results as increasing indices. 
 
    GH 36933 
    &quot;&quot;&quot;</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: np.arange(-</span><span class="s3">15</span><span class="s0">, </span><span class="s3">10</span><span class="s1">) ** </span><span class="s3">2</span><span class="s1">})</span>
    <span class="s1">df_reverse = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: df[</span><span class="s2">&quot;values&quot;</span><span class="s1">][::-</span><span class="s3">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=df.index[::-</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">increasing = getattr(df.rolling(window=</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">decreasing = getattr(df_reverse.rolling(window=</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>

    <span class="s0">assert </span><span class="s1">np.abs(decreasing.values[::-</span><span class="s3">1</span><span class="s1">][:-</span><span class="s3">4</span><span class="s1">] - increasing.values[</span><span class="s3">4</span><span class="s1">:]).max() &lt; </span><span class="s3">1e-12</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;window,closed,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;2s&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;both&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3s&quot;</span><span class="s0">, </span><span class="s2">&quot;neither&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_decreasing_indices_centered(window</span><span class="s0">, </span><span class="s1">closed</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">frame_or_series):</span>
    <span class="s5">&quot;&quot;&quot; 
    Ensure that a symmetrical inverted index return same result as non-inverted. 
    &quot;&quot;&quot;</span>
    <span class="s4">#  GH 43927</span>

    <span class="s1">index = date_range(</span><span class="s2">&quot;2020&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1s&quot;</span><span class="s1">)</span>
    <span class="s1">df_inc = frame_or_series(range(</span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">df_dec = frame_or_series(range(</span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index[::-</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">expected_inc = frame_or_series(expected</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">expected_dec = frame_or_series(expected</span><span class="s0">, </span><span class="s1">index=index[::-</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">result_inc = df_inc.rolling(window</span><span class="s0">, </span><span class="s1">closed=closed</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">).sum()</span>
    <span class="s1">result_dec = df_dec.rolling(window</span><span class="s0">, </span><span class="s1">closed=closed</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">).sum()</span>

    <span class="s1">tm.assert_equal(result_inc</span><span class="s0">, </span><span class="s1">expected_inc)</span>
    <span class="s1">tm.assert_equal(result_dec</span><span class="s0">, </span><span class="s1">expected_dec)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;window,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;1ns&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;3ns&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_center_nanosecond_resolution(</span>
    <span class="s1">window</span><span class="s0">, </span><span class="s1">closed</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">frame_or_series</span>
<span class="s1">):</span>
    <span class="s1">index = date_range(</span><span class="s2">&quot;2020&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1ns&quot;</span><span class="s1">)</span>
    <span class="s1">df = frame_or_series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">expected = frame_or_series(expected</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">result = df.rolling(window</span><span class="s0">, </span><span class="s1">closed=closed</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">).sum()</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;method,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s2">&quot;var&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">43.0</span><span class="s0">,</span>
                <span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">136.333333</span><span class="s0">,</span>
                <span class="s3">43.5</span><span class="s0">,</span>
                <span class="s3">94.966667</span><span class="s0">,</span>
                <span class="s3">182.0</span><span class="s0">,</span>
                <span class="s3">318.0</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;mean&quot;</span><span class="s0">,</span>
            <span class="s1">[float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">7.5</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">21.5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">9.166667</span><span class="s0">, </span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">17.5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;sum&quot;</span><span class="s0">,</span>
            <span class="s1">[float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">30.0</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">86.0</span><span class="s0">, </span><span class="s3">30.0</span><span class="s0">, </span><span class="s3">55.0</span><span class="s0">, </span><span class="s3">91.0</span><span class="s0">, </span><span class="s3">140.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;skew&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">0.709296</span><span class="s0">,</span>
                <span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">0.407073</span><span class="s0">,</span>
                <span class="s3">0.984656</span><span class="s0">,</span>
                <span class="s3">0.919184</span><span class="s0">,</span>
                <span class="s3">0.874674</span><span class="s0">,</span>
                <span class="s3">0.842418</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;kurt&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.5916711736073559</span><span class="s0">,</span>
                <span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">1.0028993131317954</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.06103844629409494</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.254143227116194</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.37362637362637585</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.45439658241367054</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_non_monotonic(method</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s5">&quot;&quot;&quot; 
    Make sure the (rare) branch of non-monotonic indices is covered by a test. 
 
    output from 1.1.3 is assumed to be the expected output. Output of sum/mean has 
    manually been verified. 
 
    GH 36933. 
    &quot;&quot;&quot;</span>
    <span class="s4"># Based on an example found in computation.rst</span>
    <span class="s1">use_expanding = [</span><span class="s0">True, False, True, False, True, True, True, True</span><span class="s1">]</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: np.arange(len(use_expanding)) ** </span><span class="s3">2</span><span class="s1">})</span>

    <span class="s0">class </span><span class="s1">CustomIndexer(BaseIndexer):</span>
        <span class="s0">def </span><span class="s1">get_window_bounds(self</span><span class="s0">, </span><span class="s1">num_values</span><span class="s0">, </span><span class="s1">min_periods</span><span class="s0">, </span><span class="s1">center</span><span class="s0">, </span><span class="s1">closed):</span>
            <span class="s1">start = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s1">end = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(num_values):</span>
                <span class="s0">if </span><span class="s1">self.use_expanding[i]:</span>
                    <span class="s1">start[i] = </span><span class="s3">0</span>
                    <span class="s1">end[i] = i + </span><span class="s3">1</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">start[i] = i</span>
                    <span class="s1">end[i] = i + self.window_size</span>
            <span class="s0">return </span><span class="s1">start</span><span class="s0">, </span><span class="s1">end</span>

    <span class="s1">indexer = CustomIndexer(window_size=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">use_expanding=use_expanding)</span>

    <span class="s1">result = getattr(df.rolling(indexer)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: expected})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s2">&quot;window&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(date_range(</span><span class="s2">&quot;2001-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;2D&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_corr_timedelta_index(index</span><span class="s0">, </span><span class="s1">window):</span>
    <span class="s4"># GH: 31286</span>
    <span class="s1">x = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">y = x.copy()</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] = </span><span class="s3">0.0</span>
    <span class="s1">result = x.rolling(window).corr(y)</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">tm.assert_almost_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_groupby_rolling_nan_included():</span>
    <span class="s4"># GH 35542</span>
    <span class="s1">data = {</span><span class="s2">&quot;group&quot;</span><span class="s1">: [</span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s2">&quot;g2&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]}</span>
    <span class="s1">df = DataFrame(data)</span>
    <span class="s1">result = df.groupby(</span><span class="s2">&quot;group&quot;</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">).rolling(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).mean()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s4"># GH-38057 from_tuples puts the NaNs in the codes, result expects them</span>
        <span class="s4"># to be in the levels, at the moment</span>
        <span class="s4"># index=MultiIndex.from_tuples(</span>
        <span class="s4">#     [(&quot;g1&quot;, 0), (&quot;g1&quot;, 2), (&quot;g2&quot;, 3), (np.nan, 1), (np.nan, 4)],</span>
        <span class="s4">#     names=[&quot;group&quot;, None],</span>
        <span class="s4"># ),</span>
        <span class="s1">index=MultiIndex(</span>
            <span class="s1">[[</span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s2">&quot;g2&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;group&quot;</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_groupby_rolling_non_monotonic():</span>
    <span class="s4"># GH 43909</span>

    <span class="s1">shuffled = [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">sec = </span><span class="s3">1_000</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[{</span><span class="s2">&quot;t&quot;</span><span class="s1">: Timestamp(</span><span class="s3">2 </span><span class="s1">* x * sec)</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">: x + </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">42</span><span class="s1">} </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">shuffled]</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">r&quot;.* must be monotonic&quot;</span><span class="s1">):</span>
        <span class="s1">df.groupby(</span><span class="s2">&quot;c&quot;</span><span class="s1">).rolling(on=</span><span class="s2">&quot;t&quot;</span><span class="s0">, </span><span class="s1">window=</span><span class="s2">&quot;3s&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;skew&quot;</span><span class="s0">, </span><span class="s2">&quot;kurt&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rolling_skew_kurt_numerical_stability(method):</span>
    <span class="s4"># GH#6929</span>
    <span class="s1">ser = Series(np.random.rand(</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">ser_copy = ser.copy()</span>
    <span class="s1">expected = getattr(ser.rolling(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_copy)</span>
    <span class="s1">ser = ser + </span><span class="s3">50000</span>
    <span class="s1">result = getattr(ser.rolling(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;skew&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">0.854563</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.999984</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;kurt&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.289256</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.2</span><span class="s0">, </span><span class="s3">3.999946</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_skew_kurt_large_value_range(method</span><span class="s0">, </span><span class="s1">values):</span>
    <span class="s4"># GH: 37557</span>
    <span class="s1">s = Series([</span><span class="s3">3000000</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">999</span><span class="s1">])</span>
    <span class="s1">result = getattr(s.rolling(</span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">expected = Series([np.nan] * </span><span class="s3">3 </span><span class="s1">+ values)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_invalid_method():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;method must be 'table' or 'single&quot;</span><span class="s1">):</span>
        <span class="s1">Series(range(</span><span class="s3">1</span><span class="s1">)).rolling(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">method=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;window&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;1d&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rolling_descending_date_order_with_offset(window</span><span class="s0">, </span><span class="s1">frame_or_series):</span>
    <span class="s4"># GH#40002</span>
    <span class="s1">idx = date_range(start=</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;2020-01-03&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1d&quot;</span><span class="s1">)</span>
    <span class="s1">obj = frame_or_series(range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=idx)</span>
    <span class="s1">result = obj.rolling(</span><span class="s2">&quot;1d&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s1">).sum()</span>
    <span class="s1">expected = frame_or_series([np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=idx)</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = obj.iloc[::-</span><span class="s3">1</span><span class="s1">].rolling(</span><span class="s2">&quot;1d&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;left&quot;</span><span class="s1">).sum()</span>
    <span class="s1">idx = date_range(start=</span><span class="s2">&quot;2020-01-03&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;-1d&quot;</span><span class="s1">)</span>
    <span class="s1">expected = frame_or_series([np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=idx)</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_var_floating_artifact_precision():</span>
    <span class="s4"># GH 37051</span>
    <span class="s1">s = Series([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">result = s.rolling(</span><span class="s3">3</span><span class="s1">).var()</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4 </span><span class="s1">/ </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1.0e-15</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1.0e-15</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_rolling_std_small_values():</span>
    <span class="s4"># GH 37051</span>
    <span class="s1">s = Series(</span>
        <span class="s1">[</span>
            <span class="s3">0.00000054</span><span class="s0">,</span>
            <span class="s3">0.00000053</span><span class="s0">,</span>
            <span class="s3">0.00000054</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result = s.rolling(</span><span class="s3">2</span><span class="s1">).std()</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s3">7.071068e-9</span><span class="s0">, </span><span class="s3">7.071068e-9</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1.0e-15</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1.0e-15</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;start, exp_values&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.03</span><span class="s0">, </span><span class="s3">0.0155</span><span class="s0">, </span><span class="s3">0.0155</span><span class="s0">, </span><span class="s3">0.011</span><span class="s0">, </span><span class="s3">0.01025</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.001</span><span class="s0">, </span><span class="s3">0.001</span><span class="s0">, </span><span class="s3">0.0015</span><span class="s0">, </span><span class="s3">0.00366666</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_mean_all_nan_window_floating_artifacts(start</span><span class="s0">, </span><span class="s1">exp_values):</span>
    <span class="s4"># GH#41053</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s3">0.03</span><span class="s0">,</span>
            <span class="s3">0.03</span><span class="s0">,</span>
            <span class="s3">0.001</span><span class="s0">,</span>
            <span class="s1">np.NaN</span><span class="s0">,</span>
            <span class="s3">0.002</span><span class="s0">,</span>
            <span class="s3">0.008</span><span class="s0">,</span>
            <span class="s1">np.NaN</span><span class="s0">,</span>
            <span class="s1">np.NaN</span><span class="s0">,</span>
            <span class="s1">np.NaN</span><span class="s0">,</span>
            <span class="s1">np.NaN</span><span class="s0">,</span>
            <span class="s1">np.NaN</span><span class="s0">,</span>
            <span class="s1">np.NaN</span><span class="s0">,</span>
            <span class="s3">0.005</span><span class="s0">,</span>
            <span class="s3">0.2</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">values = exp_values + [</span>
        <span class="s3">0.00366666</span><span class="s0">,</span>
        <span class="s3">0.005</span><span class="s0">,</span>
        <span class="s3">0.005</span><span class="s0">,</span>
        <span class="s3">0.008</span><span class="s0">,</span>
        <span class="s1">np.NaN</span><span class="s0">,</span>
        <span class="s1">np.NaN</span><span class="s0">,</span>
        <span class="s3">0.005</span><span class="s0">,</span>
        <span class="s3">0.102500</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">values</span><span class="s0">,</span>
        <span class="s1">index=list(range(start</span><span class="s0">, </span><span class="s1">len(values) + start))</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.iloc[start:].rolling(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">0</span><span class="s1">).mean()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_sum_all_nan_window_floating_artifacts():</span>
    <span class="s4"># GH#41053</span>
    <span class="s1">df = DataFrame([</span><span class="s3">0.002</span><span class="s0">, </span><span class="s3">0.008</span><span class="s0">, </span><span class="s3">0.005</span><span class="s0">, </span><span class="s1">np.NaN</span><span class="s0">, </span><span class="s1">np.NaN</span><span class="s0">, </span><span class="s1">np.NaN])</span>
    <span class="s1">result = df.rolling(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">0</span><span class="s1">).sum()</span>
    <span class="s1">expected = DataFrame([</span><span class="s3">0.002</span><span class="s0">, </span><span class="s3">0.010</span><span class="s0">, </span><span class="s3">0.015</span><span class="s0">, </span><span class="s3">0.013</span><span class="s0">, </span><span class="s3">0.005</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_zero_window():</span>
    <span class="s4"># GH 22719</span>
    <span class="s1">s = Series(range(</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">result = s.rolling(</span><span class="s3">0</span><span class="s1">).min()</span>
    <span class="s1">expected = Series([np.nan])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_float_dtype(float_numpy_dtype):</span>
    <span class="s4"># GH#42452</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: range(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: range(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">dtype=float_numpy_dtype)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [np.nan] * </span><span class="s3">5</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: range(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}</span><span class="s0">,</span>
        <span class="s1">dtype=float_numpy_dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.rolling(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_rolling_numeric_dtypes():</span>
    <span class="s4"># GH#41779</span>
    <span class="s1">df = DataFrame(np.arange(</span><span class="s3">40</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="s1">)).astype(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s2">&quot;float16&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;float32&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s2">&quot;float64&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;d&quot;</span><span class="s1">: </span><span class="s2">&quot;int8&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;e&quot;</span><span class="s1">: </span><span class="s2">&quot;int16&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;f&quot;</span><span class="s1">: </span><span class="s2">&quot;int32&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;g&quot;</span><span class="s1">: </span><span class="s2">&quot;uint8&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;h&quot;</span><span class="s1">: </span><span class="s2">&quot;uint16&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;i&quot;</span><span class="s1">: </span><span class="s2">&quot;uint32&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;j&quot;</span><span class="s1">: </span><span class="s2">&quot;uint64&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">result = df.rolling(window=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">).min()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: range(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: range(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;d&quot;</span><span class="s1">: range(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;e&quot;</span><span class="s1">: range(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;f&quot;</span><span class="s1">: range(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;g&quot;</span><span class="s1">: range(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;h&quot;</span><span class="s1">: range(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;i&quot;</span><span class="s1">: range(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;j&quot;</span><span class="s1">: range(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;window&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;average&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;pct&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;ascending&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;test_data&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;default&quot;</span><span class="s0">, </span><span class="s2">&quot;duplicates&quot;</span><span class="s0">, </span><span class="s2">&quot;nans&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rank(window</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">pct</span><span class="s0">, </span><span class="s1">ascending</span><span class="s0">, </span><span class="s1">test_data):</span>
    <span class="s1">length = </span><span class="s3">20</span>
    <span class="s0">if </span><span class="s1">test_data == </span><span class="s2">&quot;default&quot;</span><span class="s1">:</span>
        <span class="s1">ser = Series(data=np.random.rand(length))</span>
    <span class="s0">elif </span><span class="s1">test_data == </span><span class="s2">&quot;duplicates&quot;</span><span class="s1">:</span>
        <span class="s1">ser = Series(data=np.random.choice(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">length))</span>
    <span class="s0">elif </span><span class="s1">test_data == </span><span class="s2">&quot;nans&quot;</span><span class="s1">:</span>
        <span class="s1">ser = Series(</span>
            <span class="s1">data=np.random.choice([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.75</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">)</span>

    <span class="s1">expected = ser.rolling(window).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.rank(method=method</span><span class="s0">, </span><span class="s1">pct=pct</span><span class="s0">, </span><span class="s1">ascending=ascending).iloc[-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result = ser.rolling(window).rank(method=method</span><span class="s0">, </span><span class="s1">pct=pct</span><span class="s0">, </span><span class="s1">ascending=ascending)</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rolling_quantile_np_percentile():</span>
    <span class="s4"># #9413: Tests that rolling window's quantile default behavior</span>
    <span class="s4"># is analogous to Numpy's percentile</span>
    <span class="s1">row = </span><span class="s3">10</span>
    <span class="s1">col = </span><span class="s3">5</span>
    <span class="s1">idx = date_range(</span><span class="s2">&quot;20100101&quot;</span><span class="s0">, </span><span class="s1">periods=row</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
    <span class="s1">df = DataFrame(np.random.rand(row * col).reshape((row</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">index=idx)</span>

    <span class="s1">df_quantile = df.quantile([</span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">np_percentile = np.percentile(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">25</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s1">tm.assert_almost_equal(df_quantile.values</span><span class="s0">, </span><span class="s1">np.array(np_percentile))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;quantile&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.45</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;interpolation&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;linear&quot;</span><span class="s0">, </span><span class="s2">&quot;lower&quot;</span><span class="s0">, </span><span class="s2">&quot;higher&quot;</span><span class="s0">, </span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s2">&quot;midpoint&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;data&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">8.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">0.4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
        <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">0.3</span><span class="s0">, </span><span class="s3">0.4</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">0.5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s3">0.6</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_quantile_interpolation_options(quantile</span><span class="s0">, </span><span class="s1">interpolation</span><span class="s0">, </span><span class="s1">data):</span>
    <span class="s4"># Tests that rolling window's quantile behavior is analogous to</span>
    <span class="s4"># Series' quantile for each interpolation option</span>
    <span class="s1">s = Series(data)</span>

    <span class="s1">q1 = s.quantile(quantile</span><span class="s0">, </span><span class="s1">interpolation)</span>
    <span class="s1">q2 = s.expanding(min_periods=</span><span class="s3">1</span><span class="s1">).quantile(quantile</span><span class="s0">, </span><span class="s1">interpolation).iloc[-</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s0">if </span><span class="s1">np.isnan(q1):</span>
        <span class="s0">assert </span><span class="s1">np.isnan(q2)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">q1 == q2</span>


<span class="s0">def </span><span class="s1">test_invalid_quantile_value():</span>
    <span class="s1">data = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">s = Series(data)</span>

    <span class="s1">msg = </span><span class="s2">&quot;Interpolation 'invalid' is not supported&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">s.rolling(len(data)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).quantile(</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">&quot;invalid&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_rolling_quantile_param():</span>
    <span class="s1">ser = Series([</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.9</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>
    <span class="s1">msg = </span><span class="s2">&quot;quantile value -0.1 not in </span><span class="s0">\\</span><span class="s2">[0, 1</span><span class="s0">\\</span><span class="s2">]&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">ser.rolling(</span><span class="s3">3</span><span class="s1">).quantile(-</span><span class="s3">0.1</span><span class="s1">)</span>

    <span class="s1">msg = </span><span class="s2">&quot;quantile value 10.0 not in </span><span class="s0">\\</span><span class="s2">[0, 1</span><span class="s0">\\</span><span class="s2">]&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">ser.rolling(</span><span class="s3">3</span><span class="s1">).quantile(</span><span class="s3">10.0</span><span class="s1">)</span>

    <span class="s1">msg = </span><span class="s2">&quot;must be real number, not str&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">ser.rolling(</span><span class="s3">3</span><span class="s1">).quantile(</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_rolling_std_1obs():</span>
    <span class="s1">vals = Series([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span>

    <span class="s1">result = vals.rolling(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).std()</span>
    <span class="s1">expected = Series([np.nan] * </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = vals.rolling(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).std(ddof=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s3">0.0</span><span class="s1">] * </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = Series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]).rolling(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">2</span><span class="s1">).std()</span>
    <span class="s0">assert </span><span class="s1">np.isnan(result[</span><span class="s3">2</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_rolling_std_neg_sqrt():</span>
    <span class="s4"># unit test from Bottleneck</span>

    <span class="s4"># Test move_nanstd for neg sqrt.</span>

    <span class="s1">a = Series(</span>
        <span class="s1">[</span>
            <span class="s3">0.0011448196318903589</span><span class="s0">,</span>
            <span class="s3">0.00028718669878572767</span><span class="s0">,</span>
            <span class="s3">0.00028718669878572767</span><span class="s0">,</span>
            <span class="s3">0.00028718669878572767</span><span class="s0">,</span>
            <span class="s3">0.00028718669878572767</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">b = a.rolling(window=</span><span class="s3">3</span><span class="s1">).std()</span>
    <span class="s0">assert </span><span class="s1">np.isfinite(b[</span><span class="s3">2</span><span class="s1">:]).all()</span>

    <span class="s1">b = a.ewm(span=</span><span class="s3">3</span><span class="s1">).std()</span>
    <span class="s0">assert </span><span class="s1">np.isfinite(b[</span><span class="s3">2</span><span class="s1">:]).all()</span>
</pre>
</body>
</html>