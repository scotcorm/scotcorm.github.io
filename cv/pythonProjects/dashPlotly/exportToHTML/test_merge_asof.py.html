<html>
<head>
<title>test_merge_asof.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_merge_asof.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">pytz</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">Timedelta</span><span class="s0">,</span>
    <span class="s1">merge_asof</span><span class="s0">,</span>
    <span class="s1">read_csv</span><span class="s0">,</span>
    <span class="s1">to_datetime</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.reshape.merge </span><span class="s0">import </span><span class="s1">MergeError</span>


<span class="s0">class </span><span class="s1">TestAsOfMerge:</span>
    <span class="s0">def </span><span class="s1">read_data(self</span><span class="s0">, </span><span class="s1">datapath</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">dedupe=</span><span class="s0">False</span><span class="s1">):</span>
        <span class="s1">path = datapath(</span><span class="s2">&quot;reshape&quot;</span><span class="s0">, </span><span class="s2">&quot;merge&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s1">name)</span>
        <span class="s1">x = read_csv(path)</span>
        <span class="s0">if </span><span class="s1">dedupe:</span>
            <span class="s1">x = x.drop_duplicates([</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">keep=</span><span class="s2">&quot;last&quot;</span><span class="s1">).reset_index(</span>
                <span class="s1">drop=</span><span class="s0">True</span>
            <span class="s1">)</span>
        <span class="s1">x.time = to_datetime(x.time)</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s1">@pytest.fixture(autouse=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">datapath):</span>

        <span class="s1">self.trades = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;trades.csv&quot;</span><span class="s1">)</span>
        <span class="s1">self.quotes = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;quotes.csv&quot;</span><span class="s0">, </span><span class="s1">dedupe=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">self.asof = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;asof.csv&quot;</span><span class="s1">)</span>
        <span class="s1">self.tolerance = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;tolerance.csv&quot;</span><span class="s1">)</span>
        <span class="s1">self.allow_exact_matches = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;allow_exact_matches.csv&quot;</span><span class="s1">)</span>
        <span class="s1">self.allow_exact_matches_and_tolerance = self.read_data(</span>
            <span class="s1">datapath</span><span class="s0">, </span><span class="s2">&quot;allow_exact_matches_and_tolerance.csv&quot;</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_examples1(self):</span>
        <span class="s3">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_examples2(self):</span>
        <span class="s3">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s1">trades = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.038&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;AAPL&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.77</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">98.00</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;quantity&quot;</span><span class="s1">: [</span><span class="s4">75</span><span class="s0">, </span><span class="s4">155</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;quantity&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">quotes = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.030&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.041&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.049&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.072&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.075&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span>
                    <span class="s2">&quot;GOOG&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;MSFT&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;MSFT&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;MSFT&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;GOOG&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;AAPL&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;GOOG&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;MSFT&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;bid&quot;</span><span class="s1">: [</span><span class="s4">720.50</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.97</span><span class="s0">, </span><span class="s4">51.99</span><span class="s0">, </span><span class="s4">720.50</span><span class="s0">, </span><span class="s4">97.99</span><span class="s0">, </span><span class="s4">720.50</span><span class="s0">, </span><span class="s4">52.01</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;ask&quot;</span><span class="s1">: [</span><span class="s4">720.93</span><span class="s0">, </span><span class="s4">51.96</span><span class="s0">, </span><span class="s4">51.98</span><span class="s0">, </span><span class="s4">52.00</span><span class="s0">, </span><span class="s4">720.93</span><span class="s0">, </span><span class="s4">98.01</span><span class="s0">, </span><span class="s4">720.88</span><span class="s0">, </span><span class="s4">52.03</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>

        <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;2ms&quot;</span><span class="s1">))</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.038&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;AAPL&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.77</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">98.00</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;quantity&quot;</span><span class="s1">: [</span><span class="s4">75</span><span class="s0">, </span><span class="s4">155</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;bid&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">51.97</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s2">&quot;ask&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">51.98</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;quantity&quot;</span><span class="s0">, </span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">trades</span><span class="s0">,</span>
            <span class="s1">quotes</span><span class="s0">,</span>
            <span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">,</span>
            <span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">,</span>
            <span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;10ms&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_examples3(self):</span>
        <span class="s3">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s1">np.nan]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;forward&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_examples4(self):</span>
        <span class="s3">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic(self):</span>

        <span class="s1">expected = self.asof</span>
        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic_categorical(self):</span>

        <span class="s1">expected = self.asof</span>
        <span class="s1">trades = self.trades.copy()</span>
        <span class="s1">trades.ticker = trades.ticker.astype(</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes.copy()</span>
        <span class="s1">quotes.ticker = quotes.ticker.astype(</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">expected.ticker = expected.ticker.astype(</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic_left_index(self):</span>

        <span class="s5"># GH14253</span>
        <span class="s1">expected = self.asof</span>
        <span class="s1">trades = self.trades.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span>
        <span class="s1">)</span>
        <span class="s5"># left-only index uses right&quot;s index, oddly</span>
        <span class="s1">expected.index = result.index</span>
        <span class="s5"># time column appears after left&quot;s columns</span>
        <span class="s1">expected = expected[result.columns]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic_right_index(self):</span>

        <span class="s1">expected = self.asof</span>
        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic_left_index_right_index(self):</span>

        <span class="s1">expected = self.asof.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">trades = self.trades.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_multi_index(self):</span>

        <span class="s5"># MultiIndex is prohibited</span>
        <span class="s1">trades = self.trades.set_index([</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s1">])</span>
        <span class="s1">quotes = self.quotes.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;left can only have one index&quot;</span><span class="s1">):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">trades = self.trades.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes.set_index([</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;bid&quot;</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;right can only have one index&quot;</span><span class="s1">):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_on_and_index(self):</span>

        <span class="s5"># &quot;on&quot; parameter and index together is prohibited</span>
        <span class="s1">trades = self.trades.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">msg = </span><span class="s2">'Can only pass argument &quot;left_on&quot; OR &quot;left_index&quot; not both.'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(</span>
                <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span>
            <span class="s1">)</span>

        <span class="s1">trades = self.trades.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">msg = </span><span class="s2">'Can only pass argument &quot;right_on&quot; OR &quot;right_index&quot; not both.'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(</span>
                <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_basic_left_by_right_by(self):</span>

        <span class="s5"># GH14253</span>
        <span class="s1">expected = self.asof</span>
        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">left_by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">right_by=</span><span class="s2">&quot;ticker&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_missing_right_by(self):</span>

        <span class="s1">expected = self.asof</span>
        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s1">q = quotes[quotes.ticker != </span><span class="s2">&quot;MSFT&quot;</span><span class="s1">]</span>
        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">q</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>
        <span class="s1">expected.loc[expected.ticker == </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s1">]] = np.nan</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_multiby(self):</span>
        <span class="s5"># GH13936</span>
        <span class="s1">trades = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.046&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.050&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;AAPL&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;BATS&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.77</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">98.00</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;quantity&quot;</span><span class="s1">: [</span><span class="s4">75</span><span class="s0">, </span><span class="s4">155</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;quantity&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">quotes = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.030&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.041&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.045&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.049&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;AAPL&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s2">&quot;BATS&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;ARCA&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;bid&quot;</span><span class="s1">: [</span><span class="s4">720.51</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.97</span><span class="s0">, </span><span class="s4">51.99</span><span class="s0">, </span><span class="s4">720.50</span><span class="s0">, </span><span class="s4">97.99</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;ask&quot;</span><span class="s1">: [</span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">51.96</span><span class="s0">, </span><span class="s4">51.98</span><span class="s0">, </span><span class="s4">52.00</span><span class="s0">, </span><span class="s4">720.93</span><span class="s0">, </span><span class="s4">98.01</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.046&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.050&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;MSFT&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;GOOG&quot;</span><span class="s0">, </span><span class="s2">&quot;AAPL&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;BATS&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.77</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">98.00</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;quantity&quot;</span><span class="s1">: [</span><span class="s4">75</span><span class="s0">, </span><span class="s4">155</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;bid&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.50</span><span class="s0">, </span><span class="s4">720.51</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s2">&quot;ask&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">51.96</span><span class="s0">, </span><span class="s4">720.93</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;quantity&quot;</span><span class="s0">, </span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=[</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_multiby_heterogeneous_types(self):</span>
        <span class="s5"># GH13936</span>
        <span class="s1">trades = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.046&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.050&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;BATS&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.77</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">98.00</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;quantity&quot;</span><span class="s1">: [</span><span class="s4">75</span><span class="s0">, </span><span class="s4">155</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;quantity&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">quotes = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.030&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.041&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.045&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.049&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s2">&quot;BATS&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;ARCA&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;bid&quot;</span><span class="s1">: [</span><span class="s4">720.51</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.97</span><span class="s0">, </span><span class="s4">51.99</span><span class="s0">, </span><span class="s4">720.50</span><span class="s0">, </span><span class="s4">97.99</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;ask&quot;</span><span class="s1">: [</span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">51.96</span><span class="s0">, </span><span class="s4">51.98</span><span class="s0">, </span><span class="s4">52.00</span><span class="s0">, </span><span class="s4">720.93</span><span class="s0">, </span><span class="s4">98.01</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.023&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.046&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.048&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.050&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;ticker&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s2">&quot;ARCA&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s0">, </span><span class="s2">&quot;BATS&quot;</span><span class="s0">, </span><span class="s2">&quot;NSDQ&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.77</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s4">98.00</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;quantity&quot;</span><span class="s1">: [</span><span class="s4">75</span><span class="s0">, </span><span class="s4">155</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;bid&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">51.95</span><span class="s0">, </span><span class="s4">720.50</span><span class="s0">, </span><span class="s4">720.51</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s2">&quot;ask&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">51.96</span><span class="s0">, </span><span class="s4">720.93</span><span class="s0">, </span><span class="s4">720.92</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;quantity&quot;</span><span class="s0">, </span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=[</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_multiby_indexed(self):</span>
        <span class="s5"># GH15676</span>
        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160602&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160602&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160603&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160603&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;k1&quot;</span><span class="s0">, </span><span class="s2">&quot;k2&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">).set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>

        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160502&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160502&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s4">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160503&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160503&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;k1&quot;</span><span class="s0">, </span><span class="s2">&quot;k2&quot;</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">).set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160602&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160602&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s4">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160603&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[to_datetime(</span><span class="s2">&quot;20160603&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;k1&quot;</span><span class="s0">, </span><span class="s2">&quot;k2&quot;</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">).set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">by=[</span><span class="s2">&quot;k1&quot;</span><span class="s0">, </span><span class="s2">&quot;k2&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">MergeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;left_by and right_by must be same length&quot;</span>
        <span class="s1">):</span>
            <span class="s1">merge_asof(</span>
                <span class="s1">left</span><span class="s0">,</span>
                <span class="s1">right</span><span class="s0">,</span>
                <span class="s1">left_index=</span><span class="s0">True,</span>
                <span class="s1">right_index=</span><span class="s0">True,</span>
                <span class="s1">left_by=[</span><span class="s2">&quot;k1&quot;</span><span class="s0">, </span><span class="s2">&quot;k2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">right_by=[</span><span class="s2">&quot;k1&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_basic2(self</span><span class="s0">, </span><span class="s1">datapath):</span>

        <span class="s1">expected = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;asof2.csv&quot;</span><span class="s1">)</span>
        <span class="s1">trades = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;trades2.csv&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;quotes2.csv&quot;</span><span class="s0">, </span><span class="s1">dedupe=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic_no_by(self):</span>
        <span class="s1">f = (</span>
            <span class="s0">lambda </span><span class="s1">x: x[x.ticker == </span><span class="s2">&quot;MSFT&quot;</span><span class="s1">]</span>
            <span class="s1">.drop(</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">.reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s5"># just use a single ticker</span>
        <span class="s1">expected = f(self.asof)</span>
        <span class="s1">trades = f(self.trades)</span>
        <span class="s1">quotes = f(self.quotes)</span>

        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_valid_join_keys(self):</span>

        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s1">msg = </span><span class="s2">r&quot;incompatible merge keys \[1\] .* must be the same type&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;can only asof on a key for left&quot;</span><span class="s1">):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;can only asof on a key for left&quot;</span><span class="s1">):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_with_duplicates(self</span><span class="s0">, </span><span class="s1">datapath):</span>

        <span class="s1">q = (</span>
            <span class="s1">pd.concat([self.quotes</span><span class="s0">, </span><span class="s1">self.quotes])</span>
            <span class="s1">.sort_values([</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;ticker&quot;</span><span class="s1">])</span>
            <span class="s1">.reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">result = merge_asof(self.trades</span><span class="s0">, </span><span class="s1">q</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>
        <span class="s1">expected = self.read_data(datapath</span><span class="s0">, </span><span class="s2">&quot;asof.csv&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_with_duplicates_no_on(self):</span>

        <span class="s1">df1 = pd.DataFrame({</span><span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
        <span class="s1">df2 = pd.DataFrame({</span><span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_valid_allow_exact_matches(self):</span>

        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s1">msg = </span><span class="s2">&quot;allow_exact_matches must be boolean, passed foo&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(</span>
                <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">allow_exact_matches=</span><span class="s2">&quot;foo&quot;</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_valid_tolerance(self):</span>

        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s5"># dti</span>
        <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;1s&quot;</span><span class="s1">))</span>

        <span class="s5"># integer</span>
        <span class="s1">merge_asof(</span>
            <span class="s1">trades.reset_index()</span><span class="s0">,</span>
            <span class="s1">quotes.reset_index()</span><span class="s0">,</span>
            <span class="s1">on=</span><span class="s2">&quot;index&quot;</span><span class="s0">,</span>
            <span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">,</span>
            <span class="s1">tolerance=</span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">msg = </span><span class="s2">r&quot;incompatible tolerance .*, must be compat with type .*&quot;</span>

        <span class="s5"># incompat</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">tolerance=</span><span class="s4">1</span><span class="s1">)</span>

        <span class="s5"># invalid</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(</span>
                <span class="s1">trades.reset_index()</span><span class="s0">,</span>
                <span class="s1">quotes.reset_index()</span><span class="s0">,</span>
                <span class="s1">on=</span><span class="s2">&quot;index&quot;</span><span class="s0">,</span>
                <span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">,</span>
                <span class="s1">tolerance=</span><span class="s4">1.0</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s1">msg = </span><span class="s2">&quot;tolerance must be positive&quot;</span>

        <span class="s5"># invalid negative</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(</span>
                <span class="s1">trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">tolerance=-Timedelta(</span><span class="s2">&quot;1s&quot;</span><span class="s1">)</span>
            <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(</span>
                <span class="s1">trades.reset_index()</span><span class="s0">,</span>
                <span class="s1">quotes.reset_index()</span><span class="s0">,</span>
                <span class="s1">on=</span><span class="s2">&quot;index&quot;</span><span class="s0">,</span>
                <span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">,</span>
                <span class="s1">tolerance=-</span><span class="s4">1</span><span class="s0">,</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_non_sorted(self):</span>

        <span class="s1">trades = self.trades.sort_values(</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">ascending=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes.sort_values(</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">ascending=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s5"># we require that we are already sorted on time &amp; quotes</span>
        <span class="s0">assert not </span><span class="s1">trades.time.is_monotonic</span>
        <span class="s0">assert not </span><span class="s1">quotes.time.is_monotonic</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;left keys must be sorted&quot;</span><span class="s1">):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>

        <span class="s1">trades = self.trades.sort_values(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">trades.time.is_monotonic</span>
        <span class="s0">assert not </span><span class="s1">quotes.time.is_monotonic</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;right keys must be sorted&quot;</span><span class="s1">):</span>
            <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>

        <span class="s1">quotes = self.quotes.sort_values(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">trades.time.is_monotonic</span>
        <span class="s0">assert </span><span class="s1">quotes.time.is_monotonic</span>

        <span class="s5"># ok, though has dupes</span>
        <span class="s1">merge_asof(trades</span><span class="s0">, </span><span class="s1">self.quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;tolerance&quot;</span><span class="s0">,</span>
        <span class="s1">[Timedelta(</span><span class="s2">&quot;1day&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime.timedelta(days=</span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">ids=[</span><span class="s2">&quot;Timedelta&quot;</span><span class="s0">, </span><span class="s2">&quot;datetime.timedelta&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_tolerance(self</span><span class="s0">, </span><span class="s1">tolerance):</span>

        <span class="s1">trades = self.trades</span>
        <span class="s1">quotes = self.quotes</span>

        <span class="s1">result = merge_asof(trades</span><span class="s0">, </span><span class="s1">quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">tolerance=tolerance)</span>
        <span class="s1">expected = self.tolerance</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_forward(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;forward&quot;</span><span class="s0">, </span><span class="s1">tolerance=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_nearest(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s1">tolerance=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_tz(self):</span>
        <span class="s5"># GH 14844</span>
        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;date&quot;</span><span class="s1">: pd.date_range(</span>
                    <span class="s1">start=to_datetime(</span><span class="s2">&quot;2016-01-02&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">,</span>
                    <span class="s1">periods=</span><span class="s4">5</span><span class="s0">,</span>
                    <span class="s1">tz=pytz.timezone(</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;value1&quot;</span><span class="s1">: np.arange(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;date&quot;</span><span class="s1">: pd.date_range(</span>
                    <span class="s1">start=to_datetime(</span><span class="s2">&quot;2016-01-01&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">,</span>
                    <span class="s1">periods=</span><span class="s4">5</span><span class="s0">,</span>
                    <span class="s1">tz=pytz.timezone(</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;value2&quot;</span><span class="s1">: list(</span><span class="s2">&quot;ABCDE&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;date&quot;</span><span class="s0">, </span><span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;1 day&quot;</span><span class="s1">))</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;date&quot;</span><span class="s1">: pd.date_range(</span>
                    <span class="s1">start=to_datetime(</span><span class="s2">&quot;2016-01-02&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">,</span>
                    <span class="s1">periods=</span><span class="s4">5</span><span class="s0">,</span>
                    <span class="s1">tz=pytz.timezone(</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;value1&quot;</span><span class="s1">: np.arange(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;value2&quot;</span><span class="s1">: list(</span><span class="s2">&quot;BCDEE&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_float(self):</span>
        <span class="s5"># GH22981</span>
        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1.1</span><span class="s0">, </span><span class="s4">3.5</span><span class="s0">, </span><span class="s4">10.9</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">3.3</span><span class="s0">, </span><span class="s4">7.5</span><span class="s0">, </span><span class="s4">11.5</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">3.3</span><span class="s0">, </span><span class="s4">7.5</span><span class="s0">, </span><span class="s4">11.5</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1.1</span><span class="s0">, </span><span class="s4">3.5</span><span class="s0">, </span><span class="s4">10.9</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3.3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s1">tolerance=</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_index_tolerance(self):</span>
        <span class="s5"># GH 15135</span>
        <span class="s1">expected = self.tolerance.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">trades = self.trades.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">quotes = self.quotes.set_index(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">trades</span><span class="s0">,</span>
            <span class="s1">quotes</span><span class="s0">,</span>
            <span class="s1">left_index=</span><span class="s0">True,</span>
            <span class="s1">right_index=</span><span class="s0">True,</span>
            <span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">,</span>
            <span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;1day&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches(self):</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">self.trades</span><span class="s0">, </span><span class="s1">self.quotes</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">, </span><span class="s1">allow_exact_matches=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">expected = self.allow_exact_matches</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_forward(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;forward&quot;</span><span class="s0">, </span><span class="s1">allow_exact_matches=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_nearest(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s1">allow_exact_matches=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance(self):</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">self.trades</span><span class="s0">,</span>
            <span class="s1">self.quotes</span><span class="s0">,</span>
            <span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">,</span>
            <span class="s1">by=</span><span class="s2">&quot;ticker&quot;</span><span class="s0">,</span>
            <span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;100ms&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
        <span class="s1">)</span>
        <span class="s1">expected = self.allow_exact_matches_and_tolerance</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance2(self):</span>
        <span class="s5"># GH 13695</span>
        <span class="s1">df1 = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime([</span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s2">&quot;username&quot;</span><span class="s1">: [</span><span class="s2">&quot;bob&quot;</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">df2 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span><span class="s2">&quot;2016-07-15 13:30:00.000&quot;</span><span class="s0">, </span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;version&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime([</span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s2">&quot;username&quot;</span><span class="s1">: [</span><span class="s2">&quot;bob&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;version&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">allow_exact_matches=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime([</span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s2">&quot;username&quot;</span><span class="s1">: [</span><span class="s2">&quot;bob&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;version&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">df1</span><span class="s0">,</span>
            <span class="s1">df2</span><span class="s0">,</span>
            <span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">,</span>
            <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
            <span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;10ms&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime([</span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s2">&quot;username&quot;</span><span class="s1">: [</span><span class="s2">&quot;bob&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;version&quot;</span><span class="s1">: [np.nan]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance3(self):</span>
        <span class="s5"># GH 13709</span>
        <span class="s1">df1 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s0">, </span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;username&quot;</span><span class="s1">: [</span><span class="s2">&quot;bob&quot;</span><span class="s0">, </span><span class="s2">&quot;charlie&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df2 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span><span class="s2">&quot;2016-07-15 13:30:00.000&quot;</span><span class="s0">, </span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;version&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">df1</span><span class="s0">,</span>
            <span class="s1">df2</span><span class="s0">,</span>
            <span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">,</span>
            <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
            <span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;10ms&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s0">, </span><span class="s2">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;username&quot;</span><span class="s1">: [</span><span class="s2">&quot;bob&quot;</span><span class="s0">, </span><span class="s2">&quot;charlie&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;version&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance_forward(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">left</span><span class="s0">,</span>
            <span class="s1">right</span><span class="s0">,</span>
            <span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">,</span>
            <span class="s1">direction=</span><span class="s2">&quot;forward&quot;</span><span class="s0">,</span>
            <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
            <span class="s1">tolerance=</span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance_nearest(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]})</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">left</span><span class="s0">,</span>
            <span class="s1">right</span><span class="s0">,</span>
            <span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">,</span>
            <span class="s1">direction=</span><span class="s2">&quot;nearest&quot;</span><span class="s0">,</span>
            <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
            <span class="s1">tolerance=</span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_forward_by(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;forward&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_nearest_by(self):</span>
        <span class="s5"># GH14887</span>

        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_by_int(self):</span>
        <span class="s5"># we specialize by type, so test that this is correct</span>
        <span class="s1">df1 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.020&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.030&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.040&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.050&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.060&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;value1&quot;</span><span class="s1">: [</span><span class="s4">1.1</span><span class="s0">, </span><span class="s4">1.2</span><span class="s0">, </span><span class="s4">1.3</span><span class="s0">, </span><span class="s4">1.4</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;value1&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df2 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.015&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.020&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.025&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.035&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.040&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.055&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.060&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.065&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;value2&quot;</span><span class="s1">: [</span><span class="s4">2.1</span><span class="s0">, </span><span class="s4">2.2</span><span class="s0">, </span><span class="s4">2.3</span><span class="s0">, </span><span class="s4">2.4</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.6</span><span class="s0">, </span><span class="s4">2.7</span><span class="s0">, </span><span class="s4">2.8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;value2&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;key&quot;</span><span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;time&quot;</span><span class="s1">: to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s2">&quot;20160525 13:30:00.020&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.030&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.040&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.050&quot;</span><span class="s0">,</span>
                        <span class="s2">&quot;20160525 13:30:00.060&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;value1&quot;</span><span class="s1">: [</span><span class="s4">1.1</span><span class="s0">, </span><span class="s4">1.2</span><span class="s0">, </span><span class="s4">1.3</span><span class="s0">, </span><span class="s4">1.4</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;value2&quot;</span><span class="s1">: [</span><span class="s4">2.2</span><span class="s0">, </span><span class="s4">2.1</span><span class="s0">, </span><span class="s4">2.3</span><span class="s0">, </span><span class="s4">2.4</span><span class="s0">, </span><span class="s4">2.7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;value1&quot;</span><span class="s0">, </span><span class="s2">&quot;value2&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_on_float(self):</span>
        <span class="s5"># mimics how to determine the minimum-price variation</span>
        <span class="s1">df1 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">5.01</span><span class="s0">, </span><span class="s4">0.0023</span><span class="s0">, </span><span class="s4">25.13</span><span class="s0">, </span><span class="s4">340.05</span><span class="s0">, </span><span class="s4">30.78</span><span class="s0">, </span><span class="s4">1040.90</span><span class="s0">, </span><span class="s4">0.0078</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;ABCDEFG&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df2 = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">100.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;mpv&quot;</span><span class="s1">: [</span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.05</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;mpv&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df1 = df1.sort_values(</span><span class="s2">&quot;price&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;price&quot;</span><span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;BGACEDF&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">0.0023</span><span class="s0">, </span><span class="s4">0.0078</span><span class="s0">, </span><span class="s4">5.01</span><span class="s0">, </span><span class="s4">25.13</span><span class="s0">, </span><span class="s4">30.78</span><span class="s0">, </span><span class="s4">340.05</span><span class="s0">, </span><span class="s4">1040.90</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;mpv&quot;</span><span class="s1">: [</span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.05</span><span class="s0">, </span><span class="s4">0.05</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;mpv&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_on_specialized_type(self</span><span class="s0">, </span><span class="s1">any_real_numpy_dtype):</span>
        <span class="s5"># see gh-13936</span>
        <span class="s1">dtype = np.dtype(any_real_numpy_dtype).type</span>

        <span class="s1">df1 = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">78</span><span class="s0">, </span><span class="s4">120</span><span class="s0">, </span><span class="s4">79</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;ABCDEFG&quot;</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df1.value = dtype(df1.value)</span>

        <span class="s1">df2 = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">80</span><span class="s0">, </span><span class="s4">120</span><span class="s0">, </span><span class="s4">125</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;result&quot;</span><span class="s1">: list(</span><span class="s2">&quot;xyzw&quot;</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;value&quot;</span><span class="s0">, </span><span class="s2">&quot;result&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df2.value = dtype(df2.value)</span>

        <span class="s1">df1 = df1.sort_values(</span><span class="s2">&quot;value&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;value&quot;</span><span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;BACEGDF&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">78</span><span class="s0">, </span><span class="s4">79</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">120</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;result&quot;</span><span class="s1">: list(</span><span class="s2">&quot;xxxxxyz&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s0">, </span><span class="s2">&quot;result&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.value = dtype(expected.value)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_on_specialized_type_by_int(self</span><span class="s0">, </span><span class="s1">any_real_numpy_dtype):</span>
        <span class="s5"># see gh-13936</span>
        <span class="s1">dtype = np.dtype(any_real_numpy_dtype).type</span>

        <span class="s1">df1 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">78</span><span class="s0">, </span><span class="s4">120</span><span class="s0">, </span><span class="s4">79</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;ABCDEFG&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df1.value = dtype(df1.value)</span>

        <span class="s1">df2 = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">80</span><span class="s0">, </span><span class="s4">120</span><span class="s0">, </span><span class="s4">125</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;result&quot;</span><span class="s1">: list(</span><span class="s2">&quot;xyzw&quot;</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;value&quot;</span><span class="s0">, </span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;result&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df2.value = dtype(df2.value)</span>

        <span class="s1">df1 = df1.sort_values(</span><span class="s2">&quot;value&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;value&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;key&quot;</span><span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;BACEGDF&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;key&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">78</span><span class="s0">, </span><span class="s4">79</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">120</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;result&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s0">, </span><span class="s2">&quot;result&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.value = dtype(expected.value)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_on_float_by_int(self):</span>
        <span class="s5"># type specialize both &quot;by&quot; and &quot;on&quot; parameters</span>
        <span class="s1">df1 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;AAABBBCCC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span>
                    <span class="s4">3.26</span><span class="s0">,</span>
                    <span class="s4">3.2599</span><span class="s0">,</span>
                    <span class="s4">3.2598</span><span class="s0">,</span>
                    <span class="s4">12.58</span><span class="s0">,</span>
                    <span class="s4">12.59</span><span class="s0">,</span>
                    <span class="s4">12.5</span><span class="s0">,</span>
                    <span class="s4">378.15</span><span class="s0">,</span>
                    <span class="s4">378.2</span><span class="s0">,</span>
                    <span class="s4">378.25</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df2 = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">100.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">100.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">1000.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;mpv&quot;</span><span class="s1">: [</span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.05</span><span class="s0">, </span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;mpv&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df1 = df1.sort_values(</span><span class="s2">&quot;price&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">df2 = df2.sort_values(</span><span class="s2">&quot;price&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;exch&quot;</span><span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="s1">: list(</span><span class="s2">&quot;AAABBBCCC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;exch&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;price&quot;</span><span class="s1">: [</span>
                    <span class="s4">3.2598</span><span class="s0">,</span>
                    <span class="s4">3.2599</span><span class="s0">,</span>
                    <span class="s4">3.26</span><span class="s0">,</span>
                    <span class="s4">12.5</span><span class="s0">,</span>
                    <span class="s4">12.58</span><span class="s0">,</span>
                    <span class="s4">12.59</span><span class="s0">,</span>
                    <span class="s4">378.15</span><span class="s0">,</span>
                    <span class="s4">378.2</span><span class="s0">,</span>
                    <span class="s4">378.25</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;mpv&quot;</span><span class="s1">: [</span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.0001</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.01</span><span class="s0">, </span><span class="s4">0.05</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;symbol&quot;</span><span class="s0">, </span><span class="s2">&quot;exch&quot;</span><span class="s0">, </span><span class="s2">&quot;price&quot;</span><span class="s0">, </span><span class="s2">&quot;mpv&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_datatype_error_raises(self):</span>
        <span class="s1">msg = </span><span class="s2">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]})</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_merge_datatype_categorical_error_raises(self):</span>
        <span class="s1">msg = (</span>
            <span class="s2">r&quot;incompatible merge keys \[0\] .* both sides category, &quot;</span>
            <span class="s2">&quot;but not equal ones&quot;</span>
        <span class="s1">)</span>

        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">: pd.Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])}</span>
        <span class="s1">)</span>
        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: pd.Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_merge_groupby_multiple_column_with_categorical_column(self):</span>
        <span class="s5"># GH 16454</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">: pd.Categorical([</span><span class="s4">0</span><span class="s1">])})</span>
        <span class="s1">result = merge_asof(df</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">by=[</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">])</span>
        <span class="s1">expected = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">: pd.Categorical([</span><span class="s4">0</span><span class="s1">])})</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, lambda </span><span class="s1">x: to_datetime(x)]</span><span class="s0">, </span><span class="s1">ids=[</span><span class="s2">&quot;numeric&quot;</span><span class="s0">, </span><span class="s2">&quot;datetime&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;side&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_merge_on_nans(self</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">side):</span>
        <span class="s5"># GH 23189</span>
        <span class="s1">msg = </span><span class="s2">f&quot;Merge keys contain null values on </span><span class="s0">{</span><span class="s1">side</span><span class="s0">} </span><span class="s2">side&quot;</span>
        <span class="s1">nulls = func([</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">5.0</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s1">non_nulls = func([</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">10.0</span><span class="s1">])</span>
        <span class="s1">df_null = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: nulls</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: non_nulls</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]})</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s0">if </span><span class="s1">side == </span><span class="s2">&quot;left&quot;</span><span class="s1">:</span>
                <span class="s1">merge_asof(df_null</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">merge_asof(df</span><span class="s0">, </span><span class="s1">df_null</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_merge_by_col_tz_aware(self):</span>
        <span class="s5"># GH 21184</span>
        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;by_col&quot;</span><span class="s1">: pd.DatetimeIndex([</span><span class="s2">&quot;2018-01-01&quot;</span><span class="s1">]).tz_localize(</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;on_col&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;by_col&quot;</span><span class="s1">: pd.DatetimeIndex([</span><span class="s2">&quot;2018-01-01&quot;</span><span class="s1">]).tz_localize(</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;on_col&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">by=</span><span class="s2">&quot;by_col&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;on_col&quot;</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">[[pd.Timestamp(</span><span class="s2">&quot;2018-01-01&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;by_col&quot;</span><span class="s0">, </span><span class="s2">&quot;on_col&quot;</span><span class="s0">, </span><span class="s2">&quot;values_x&quot;</span><span class="s0">, </span><span class="s2">&quot;values_y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_by_mixed_tz_aware(self):</span>
        <span class="s5"># GH 26649</span>
        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;by_col1&quot;</span><span class="s1">: pd.DatetimeIndex([</span><span class="s2">&quot;2018-01-01&quot;</span><span class="s1">]).tz_localize(</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;by_col2&quot;</span><span class="s1">: [</span><span class="s2">&quot;HELLO&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;on_col&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;by_col1&quot;</span><span class="s1">: pd.DatetimeIndex([</span><span class="s2">&quot;2018-01-01&quot;</span><span class="s1">]).tz_localize(</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;by_col2&quot;</span><span class="s1">: [</span><span class="s2">&quot;WORLD&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;on_col&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">by=[</span><span class="s2">&quot;by_col1&quot;</span><span class="s0">, </span><span class="s2">&quot;by_col2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;on_col&quot;</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">[[pd.Timestamp(</span><span class="s2">&quot;2018-01-01&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;HELLO&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;by_col1&quot;</span><span class="s0">, </span><span class="s2">&quot;by_col2&quot;</span><span class="s0">, </span><span class="s2">&quot;on_col&quot;</span><span class="s0">, </span><span class="s2">&quot;value_x&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected[</span><span class="s2">&quot;value_y&quot;</span><span class="s1">] = np.array([np.nan]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_timedelta_tolerance_nearest(self):</span>
        <span class="s5"># GH 27642</span>

        <span class="s1">left = pd.DataFrame(</span>
            <span class="s1">list(zip([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">25</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">left[</span><span class="s2">&quot;time&quot;</span><span class="s1">] = pd.to_timedelta(left[</span><span class="s2">&quot;time&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;ms&quot;</span><span class="s1">)</span>

        <span class="s1">right = pd.DataFrame(</span>
            <span class="s1">list(zip([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">18</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">right[</span><span class="s2">&quot;time&quot;</span><span class="s1">] = pd.to_timedelta(right[</span><span class="s2">&quot;time&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;ms&quot;</span><span class="s1">)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">list(</span>
                <span class="s1">zip(</span>
                    <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">25</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected[</span><span class="s2">&quot;time&quot;</span><span class="s1">] = pd.to_timedelta(expected[</span><span class="s2">&quot;time&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;ms&quot;</span><span class="s1">)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">tolerance=Timedelta(</span><span class="s2">&quot;1ms&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">direction=</span><span class="s2">&quot;nearest&quot;</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_int_type_tolerance(self</span><span class="s0">, </span><span class="s1">any_int_numpy_dtype):</span>
        <span class="s5"># GH #28870</span>

        <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">25</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
        <span class="s1">left[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = left[</span><span class="s2">&quot;a&quot;</span><span class="s1">].astype(any_int_numpy_dtype)</span>
        <span class="s1">right[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = right[</span><span class="s2">&quot;a&quot;</span><span class="s1">].astype(any_int_numpy_dtype)</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right_val&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">expected[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = expected[</span><span class="s2">&quot;a&quot;</span><span class="s1">].astype(any_int_numpy_dtype)</span>

        <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">tolerance=</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_index_column_tz(self):</span>
        <span class="s5"># GH 29864</span>
        <span class="s1">index = pd.date_range(</span><span class="s2">&quot;2019-10-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;30min&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span>
        <span class="s1">left = pd.DataFrame([</span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;xyz&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index[</span><span class="s4">1</span><span class="s1">:])</span>
        <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;from_date&quot;</span><span class="s1">: index</span><span class="s0">, </span><span class="s2">&quot;abc&quot;</span><span class="s1">: [</span><span class="s4">2.46</span><span class="s1">] * </span><span class="s4">4 </span><span class="s1">+ [</span><span class="s4">2.19</span><span class="s1">]})</span>
        <span class="s1">result = merge_asof(</span>
            <span class="s1">left=left</span><span class="s0">, </span><span class="s1">right=right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_on=[</span><span class="s2">&quot;from_date&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;xyz&quot;</span><span class="s1">: [</span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;from_date&quot;</span><span class="s1">: index[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">,</span>
                <span class="s2">&quot;abc&quot;</span><span class="s1">: [</span><span class="s4">2.46</span><span class="s1">] * </span><span class="s4">3 </span><span class="s1">+ [</span><span class="s4">2.19</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=pd.date_range(</span>
                <span class="s2">&quot;2019-10-01 00:30:00&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;30min&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">4</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = merge_asof(</span>
            <span class="s1">left=right</span><span class="s0">, </span><span class="s1">right=left</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">left_on=[</span><span class="s2">&quot;from_date&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;from_date&quot;</span><span class="s1">: index</span><span class="s0">,</span>
                <span class="s2">&quot;abc&quot;</span><span class="s1">: [</span><span class="s4">2.46</span><span class="s1">] * </span><span class="s4">4 </span><span class="s1">+ [</span><span class="s4">2.19</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;xyz&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_left_index_right_index_tolerance(self):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/35558</span>
        <span class="s1">dr1 = pd.date_range(start=</span><span class="s2">&quot;1/1/2020&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;1/20/2020&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;2D&quot;</span><span class="s1">) + Timedelta(</span>
            <span class="s1">seconds=</span><span class="s4">0.4</span>
        <span class="s1">)</span>
        <span class="s1">dr2 = pd.date_range(start=</span><span class="s2">&quot;1/1/2020&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;2/1/2020&quot;</span><span class="s1">)</span>

        <span class="s1">df1 = pd.DataFrame({</span><span class="s2">&quot;val1&quot;</span><span class="s1">: </span><span class="s2">&quot;foo&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=pd.DatetimeIndex(dr1))</span>
        <span class="s1">df2 = pd.DataFrame({</span><span class="s2">&quot;val2&quot;</span><span class="s1">: </span><span class="s2">&quot;bar&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=pd.DatetimeIndex(dr2))</span>

        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;val1&quot;</span><span class="s1">: </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;val2&quot;</span><span class="s1">: </span><span class="s2">&quot;bar&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=pd.DatetimeIndex(dr1)</span>
        <span class="s1">)</span>
        <span class="s1">result = merge_asof(</span>
            <span class="s1">df1</span><span class="s0">,</span>
            <span class="s1">df2</span><span class="s0">,</span>
            <span class="s1">left_index=</span><span class="s0">True,</span>
            <span class="s1">right_index=</span><span class="s0">True,</span>
            <span class="s1">tolerance=Timedelta(seconds=</span><span class="s4">0.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;kwargs&quot;</span><span class="s0">, </span><span class="s1">[{</span><span class="s2">&quot;on&quot;</span><span class="s1">: </span><span class="s2">&quot;x&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s2">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;data&quot;</span><span class="s0">,</span>
    <span class="s1">[[</span><span class="s2">&quot;2019-06-01 00:09:12&quot;</span><span class="s0">, </span><span class="s2">&quot;2019-06-01 00:10:29&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s2">&quot;2019-06-01 00:10:29&quot;</span><span class="s1">]]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_asof_non_numerical_dtype(kwargs</span><span class="s0">, </span><span class="s1">data):</span>
    <span class="s5"># GH#29130</span>
    <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: data}</span><span class="s0">, </span><span class="s1">index=data)</span>
    <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: data}</span><span class="s0">, </span><span class="s1">index=data)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">MergeError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_non_numerical_dtype_object():</span>
    <span class="s5"># GH#29130</span>
    <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;12&quot;</span><span class="s0">, </span><span class="s2">&quot;13&quot;</span><span class="s0">, </span><span class="s2">&quot;15&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val1&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
    <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_val&quot;</span><span class="s1">: [</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;f&quot;</span><span class="s1">]})</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">MergeError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">merge_asof(</span>
            <span class="s1">left</span><span class="s0">,</span>
            <span class="s1">right</span><span class="s0">,</span>
            <span class="s1">left_on=</span><span class="s2">&quot;left_val1&quot;</span><span class="s0">,</span>
            <span class="s1">right_on=</span><span class="s2">&quot;a&quot;</span><span class="s0">,</span>
            <span class="s1">left_by=</span><span class="s2">&quot;a&quot;</span><span class="s0">,</span>
            <span class="s1">right_by=</span><span class="s2">&quot;left_val&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">{</span><span class="s2">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s2">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;left_on&quot;</span><span class="s1">: </span><span class="s2">&quot;left_time&quot;</span><span class="s0">, </span><span class="s2">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s2">&quot;right_on&quot;</span><span class="s1">: </span><span class="s2">&quot;right&quot;</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_asof_index_behavior(kwargs):</span>
    <span class="s5"># GH 33463</span>
    <span class="s1">index = Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;left&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_time&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;right&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">])</span>
    <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s1">expected = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;left&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;left_time&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_numeri_column_in_index():</span>
    <span class="s5"># GH#34488</span>
    <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">20</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">22</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">20</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">22</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_numeri_column_in_multiindex():</span>
    <span class="s5"># GH#34488</span>
    <span class="s1">left = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=pd.MultiIndex.from_arrays([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">right = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">20</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">22</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=pd.MultiIndex.from_arrays([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">result = merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">20</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">22</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_numeri_column_in_index_object_dtype():</span>
    <span class="s5"># GH#34488</span>
    <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s2">&quot;1&quot;</span><span class="s0">, </span><span class="s2">&quot;2&quot;</span><span class="s0">, </span><span class="s2">&quot;3&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">right = pd.DataFrame({</span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">20</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">22</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s2">&quot;m&quot;</span><span class="s0">, </span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s2">&quot;o&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">MergeError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s1">left = left.reset_index().set_index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">right = right.reset_index().set_index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">MergeError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">merge_asof(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_array_as_on():</span>
    <span class="s5"># GH#42844</span>
    <span class="s1">right = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;ts&quot;</span><span class="s1">: [pd.Timestamp(</span><span class="s2">&quot;2021/01/01 00:37&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Timestamp(</span><span class="s2">&quot;2021/01/01 01:40&quot;</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">ts_merge = pd.date_range(</span>
        <span class="s1">start=pd.Timestamp(</span><span class="s2">&quot;2021/01/01 00:00&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1h&quot;</span>
    <span class="s1">)</span>
    <span class="s1">left = pd.DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]})</span>
    <span class="s1">result = merge_asof(</span>
        <span class="s1">left</span><span class="s0">,</span>
        <span class="s1">right</span><span class="s0">,</span>
        <span class="s1">left_on=ts_merge</span><span class="s0">,</span>
        <span class="s1">right_on=</span><span class="s2">&quot;ts&quot;</span><span class="s0">,</span>
        <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
        <span class="s1">direction=</span><span class="s2">&quot;backward&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = pd.DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;ts&quot;</span><span class="s1">: ts_merge})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = merge_asof(</span>
        <span class="s1">right</span><span class="s0">,</span>
        <span class="s1">left</span><span class="s0">,</span>
        <span class="s1">left_on=</span><span class="s2">&quot;ts&quot;</span><span class="s0">,</span>
        <span class="s1">right_on=ts_merge</span><span class="s0">,</span>
        <span class="s1">allow_exact_matches=</span><span class="s0">False,</span>
        <span class="s1">direction=</span><span class="s2">&quot;backward&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;ts&quot;</span><span class="s1">: [pd.Timestamp(</span><span class="s2">&quot;2021/01/01 00:37&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Timestamp(</span><span class="s2">&quot;2021/01/01 01:40&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>