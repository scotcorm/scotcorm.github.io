<html>
<head>
<title>test_join.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_join.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Categorical</span><span class="s0">,</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
    <span class="s1">concat</span><span class="s0">,</span>
    <span class="s1">merge</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.tests.reshape.merge.test_merge </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">NGROUPS</span><span class="s0">,</span>
    <span class="s1">N</span><span class="s0">,</span>
    <span class="s1">get_test_data</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s1">a_ = np.array</span>


<span class="s0">class </span><span class="s1">TestJoin:</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s2"># aggregate multiple columns</span>
        <span class="s1">self.df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key1&quot;</span><span class="s1">: get_test_data()</span><span class="s0">,</span>
                <span class="s3">&quot;key2&quot;</span><span class="s1">: get_test_data()</span><span class="s0">,</span>
                <span class="s3">&quot;data1&quot;</span><span class="s1">: np.random.randn(N)</span><span class="s0">,</span>
                <span class="s3">&quot;data2&quot;</span><span class="s1">: np.random.randn(N)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s2"># exclude a couple keys for fun</span>
        <span class="s1">self.df = self.df[self.df[</span><span class="s3">&quot;key2&quot;</span><span class="s1">] &gt; </span><span class="s4">1</span><span class="s1">]</span>

        <span class="s1">self.df2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key1&quot;</span><span class="s1">: get_test_data(n=N // </span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;key2&quot;</span><span class="s1">: get_test_data(ngroups=NGROUPS // </span><span class="s4">2</span><span class="s0">, </span><span class="s1">n=N // </span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: np.random.randn(N // </span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">index</span><span class="s0">, </span><span class="s1">data = tm.getMixedTypeDict()</span>
        <span class="s1">self.target = DataFrame(data</span><span class="s0">, </span><span class="s1">index=index)</span>

        <span class="s2"># Join on string value</span>
        <span class="s1">self.source = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;MergedA&quot;</span><span class="s1">: data[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;MergedD&quot;</span><span class="s1">: data[</span><span class="s3">&quot;D&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=data[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_left_outer_join(self):</span>
        <span class="s1">joined_key2 = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key2&quot;</span><span class="s1">)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_key2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s1">)</span>

        <span class="s1">joined_both = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_both</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_right_outer_join(self):</span>
        <span class="s1">joined_key2 = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key2&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_key2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>

        <span class="s1">joined_both = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_both</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_full_outer_join(self):</span>
        <span class="s1">joined_key2 = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key2&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_key2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>

        <span class="s1">joined_both = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_both</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_inner_join(self):</span>
        <span class="s1">joined_key2 = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key2&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_key2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>

        <span class="s1">joined_both = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">_check_join(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">joined_both</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_handle_overlap(self):</span>
        <span class="s1">joined = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key2&quot;</span><span class="s0">, </span><span class="s1">suffixes=(</span><span class="s3">&quot;.foo&quot;</span><span class="s0">, </span><span class="s3">&quot;.bar&quot;</span><span class="s1">))</span>

        <span class="s0">assert </span><span class="s3">&quot;key1.foo&quot; </span><span class="s0">in </span><span class="s1">joined</span>
        <span class="s0">assert </span><span class="s3">&quot;key1.bar&quot; </span><span class="s0">in </span><span class="s1">joined</span>

    <span class="s0">def </span><span class="s1">test_handle_overlap_arbitrary_key(self):</span>
        <span class="s1">joined = merge(</span>
            <span class="s1">self.df</span><span class="s0">,</span>
            <span class="s1">self.df2</span><span class="s0">,</span>
            <span class="s1">left_on=</span><span class="s3">&quot;key2&quot;</span><span class="s0">,</span>
            <span class="s1">right_on=</span><span class="s3">&quot;key1&quot;</span><span class="s0">,</span>
            <span class="s1">suffixes=(</span><span class="s3">&quot;.foo&quot;</span><span class="s0">, </span><span class="s3">&quot;.bar&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s3">&quot;key1.foo&quot; </span><span class="s0">in </span><span class="s1">joined</span>
        <span class="s0">assert </span><span class="s3">&quot;key2.bar&quot; </span><span class="s0">in </span><span class="s1">joined</span>

    <span class="s0">def </span><span class="s1">test_join_on(self):</span>
        <span class="s1">target = self.target</span>
        <span class="s1">source = self.source</span>

        <span class="s1">merged = target.join(source</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;MergedA&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">target[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;MergedD&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">target[</span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s2"># join with duplicates (fix regression from DataFrame/Matrix merge)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">joined = df.join(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s2"># Test when some are missing</span>
        <span class="s1">df_a = DataFrame([[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;one&quot;</span><span class="s1">])</span>
        <span class="s1">df_b = DataFrame([[</span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;bar&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;two&quot;</span><span class="s1">])</span>
        <span class="s1">df_c = DataFrame([[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;three&quot;</span><span class="s1">])</span>
        <span class="s1">joined = df_a.join(df_b</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;one&quot;</span><span class="s1">)</span>
        <span class="s1">joined = joined.join(df_c</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;one&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.isnan(joined[</span><span class="s3">&quot;two&quot;</span><span class="s1">][</span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">np.isnan(joined[</span><span class="s3">&quot;three&quot;</span><span class="s1">][</span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>

        <span class="s2"># merge column not p resent</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;^'E'$&quot;</span><span class="s1">):</span>
            <span class="s1">target.join(source</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;E&quot;</span><span class="s1">)</span>

        <span class="s2"># overlap</span>
        <span class="s1">source_copy = source.copy()</span>
        <span class="s1">source_copy[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = </span><span class="s4">0</span>
        <span class="s1">msg = (</span>
            <span class="s3">&quot;You are trying to merge on float64 and object columns. If &quot;</span>
            <span class="s3">&quot;you wish to proceed you should use pd.concat&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">target.join(source_copy</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_on_fails_with_different_right_index(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.random.choice([</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">3</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.random.choice([</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">10</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">index=tm.makeCustomIndex(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">r'len\(left_on\) must equal the number of levels in the index of &quot;right&quot;'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_on_fails_with_different_left_index(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.random.choice([</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">3</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">index=tm.makeCustomIndex(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.random.choice([</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">10</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">r'len\(right_on\) must equal the number of levels in the index of &quot;left&quot;'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_on_fails_with_different_column_counts(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.random.choice([</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">3</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.random.choice([</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">10</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">index=tm.makeCustomIndex(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">r&quot;len\(right_on\) must equal len\(left_on\)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">left_on=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;wrong_type&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;str&quot;</span><span class="s0">, None, </span><span class="s1">np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])])</span>
    <span class="s0">def </span><span class="s1">test_join_on_fails_with_wrong_object_type(self</span><span class="s0">, </span><span class="s1">wrong_type):</span>
        <span class="s2"># GH12081 - original issue</span>

        <span class="s2"># GH21220 - merging of Series and DataFrame is now allowed</span>
        <span class="s2"># Edited test to remove the Series object from test parameters</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]})</span>
        <span class="s1">msg = (</span>
            <span class="s3">&quot;Can only merge Series or DataFrame objects, &quot;</span>
            <span class="s3">f&quot;a </span><span class="s0">{</span><span class="s1">type(wrong_type)</span><span class="s0">} </span><span class="s3">was passed&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(wrong_type</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df</span><span class="s0">, </span><span class="s1">wrong_type</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_on_pass_vector(self):</span>
        <span class="s1">expected = self.target.join(self.source</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s0">del </span><span class="s1">expected[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span>

        <span class="s1">join_col = self.target.pop(</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s1">result = self.target.join(self.source</span><span class="s0">, </span><span class="s1">on=join_col)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_with_len0(self):</span>
        <span class="s2"># nothing to merge</span>
        <span class="s1">merged = self.target.join(self.source.reindex([])</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">self.source:</span>
            <span class="s0">assert </span><span class="s1">col </span><span class="s0">in </span><span class="s1">merged</span>
            <span class="s0">assert </span><span class="s1">merged[col].isna().all()</span>

        <span class="s1">merged2 = self.target.join(self.source.reindex([])</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_index_equal(merged2.columns</span><span class="s0">, </span><span class="s1">merged.columns)</span>
        <span class="s0">assert </span><span class="s1">len(merged2) == </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">test_join_on_inner(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>

        <span class="s1">joined = df.join(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>

        <span class="s1">expected = df.join(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">expected = expected[expected[</span><span class="s3">&quot;value&quot;</span><span class="s1">].notna()]</span>
        <span class="s1">tm.assert_series_equal(joined[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(joined[</span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected[</span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">tm.assert_index_equal(joined.index</span><span class="s0">, </span><span class="s1">expected.index)</span>

    <span class="s0">def </span><span class="s1">test_join_on_singlekey_list(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>

        <span class="s2"># corner cases</span>
        <span class="s1">joined = df.join(df2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">expected = df.join(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_on_series(self):</span>
        <span class="s1">result = self.target.join(self.source[</span><span class="s3">&quot;MergedA&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s1">expected = self.target.join(self.source[[</span><span class="s3">&quot;MergedA&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_on_series_buglet(self):</span>
        <span class="s2"># GH #638</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]})</span>
        <span class="s1">ds = Series([</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;b&quot;</span><span class="s1">)</span>
        <span class="s1">result = df.join(ds</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=df.index)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_index_mixed(self</span><span class="s0">, </span><span class="s1">join_type):</span>
        <span class="s2"># no overlapping blocks</span>
        <span class="s1">df1 = DataFrame(index=np.arange(</span><span class="s4">10</span><span class="s1">))</span>
        <span class="s1">df1[</span><span class="s3">&quot;bool&quot;</span><span class="s1">] = </span><span class="s0">True</span>
        <span class="s1">df1[</span><span class="s3">&quot;string&quot;</span><span class="s1">] = </span><span class="s3">&quot;foo&quot;</span>

        <span class="s1">df2 = DataFrame(index=np.arange(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">15</span><span class="s1">))</span>
        <span class="s1">df2[</span><span class="s3">&quot;int&quot;</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">df2[</span><span class="s3">&quot;float&quot;</span><span class="s1">] = </span><span class="s4">1.0</span>

        <span class="s1">joined = df1.join(df2</span><span class="s0">, </span><span class="s1">how=join_type)</span>
        <span class="s1">expected = _join_by_hand(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=join_type)</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">joined = df2.join(df1</span><span class="s0">, </span><span class="s1">how=join_type)</span>
        <span class="s1">expected = _join_by_hand(df2</span><span class="s0">, </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">how=join_type)</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_index_mixed_overlap(self):</span>
        <span class="s1">df1 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: </span><span class="s4">1.0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=np.arange(</span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df1[</span><span class="s3">&quot;B&quot;</span><span class="s1">].dtype == np.int64</span>
        <span class="s0">assert </span><span class="s1">df1[</span><span class="s3">&quot;D&quot;</span><span class="s1">].dtype == np.bool_</span>

        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: </span><span class="s4">1.0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=np.arange(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s2"># overlap</span>
        <span class="s1">joined = df1.join(df2</span><span class="s0">, </span><span class="s1">lsuffix=</span><span class="s3">&quot;_one&quot;</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_two&quot;</span><span class="s1">)</span>
        <span class="s1">expected_columns = [</span>
            <span class="s3">&quot;A_one&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;B_one&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;C_one&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;D_one&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;A_two&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;B_two&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;C_two&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;D_two&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">df1.columns = expected_columns[:</span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">df2.columns = expected_columns[</span><span class="s4">4</span><span class="s1">:]</span>
        <span class="s1">expected = _join_by_hand(df1</span><span class="s0">, </span><span class="s1">df2)</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_empty_bug(self):</span>
        <span class="s2"># generated an exception in 0.4.3</span>
        <span class="s1">x = DataFrame()</span>
        <span class="s1">x.join(DataFrame([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_unconsolidated(self):</span>
        <span class="s2"># GH #331</span>
        <span class="s1">a = DataFrame(np.random.randn(</span><span class="s4">30</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">c = Series(np.random.randn(</span><span class="s4">30</span><span class="s1">))</span>
        <span class="s1">a[</span><span class="s3">&quot;c&quot;</span><span class="s1">] = c</span>
        <span class="s1">d = DataFrame(np.random.randn(</span><span class="s4">30</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;q&quot;</span><span class="s1">])</span>

        <span class="s2"># it works!</span>
        <span class="s1">a.join(d)</span>
        <span class="s1">d.join(a)</span>

    <span class="s0">def </span><span class="s1">test_join_multiindex(self):</span>
        <span class="s1">index1 = MultiIndex.from_arrays(</span>
            <span class="s1">[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">index2 = MultiIndex.from_arrays(</span>
            <span class="s1">[[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df1 = DataFrame(data=np.random.randn(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index1</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;var X&quot;</span><span class="s1">])</span>
        <span class="s1">df2 = DataFrame(data=np.random.randn(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index2</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;var Y&quot;</span><span class="s1">])</span>

        <span class="s1">df1 = df1.sort_index(level=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">df2 = df2.sort_index(level=</span><span class="s4">0</span><span class="s1">)</span>

        <span class="s1">joined = df1.join(df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">ex_index = Index(index1.values).union(Index(index2.values))</span>
        <span class="s1">expected = df1.reindex(ex_index).join(df2.reindex(ex_index))</span>
        <span class="s1">expected.index.names = index1.names</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">joined.index.names == index1.names</span>

        <span class="s1">df1 = df1.sort_index(level=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">df2 = df2.sort_index(level=</span><span class="s4">1</span><span class="s1">)</span>

        <span class="s1">joined = df1.join(df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">).sort_index(level=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">ex_index = Index(index1.values).union(Index(index2.values))</span>
        <span class="s1">expected = df1.reindex(ex_index).join(df2.reindex(ex_index))</span>
        <span class="s1">expected.index.names = index1.names</span>

        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">joined.index.names == index1.names</span>

    <span class="s0">def </span><span class="s1">test_join_inner_multiindex(self</span><span class="s0">, </span><span class="s1">lexsorted_two_level_string_multiindex):</span>
        <span class="s1">key1 = [</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;qux&quot;</span><span class="s0">, </span><span class="s3">&quot;qux&quot;</span><span class="s0">, </span><span class="s3">&quot;snap&quot;</span><span class="s1">]</span>
        <span class="s1">key2 = [</span>
            <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;three&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;three&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>

        <span class="s1">data = np.random.randn(len(key1))</span>
        <span class="s1">data = DataFrame({</span><span class="s3">&quot;key1&quot;</span><span class="s1">: key1</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">: key2</span><span class="s0">, </span><span class="s3">&quot;data&quot;</span><span class="s1">: data})</span>

        <span class="s1">index = lexsorted_two_level_string_multiindex</span>
        <span class="s1">to_join = DataFrame(</span>
            <span class="s1">np.random.randn(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;j_one&quot;</span><span class="s0">, </span><span class="s3">&quot;j_two&quot;</span><span class="s0">, </span><span class="s3">&quot;j_three&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s1">joined = data.join(to_join</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">expected = merge(</span>
            <span class="s1">data</span><span class="s0">,</span>
            <span class="s1">to_join.reset_index()</span><span class="s0">,</span>
            <span class="s1">left_on=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">right_on=[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">,</span>
            <span class="s1">sort=</span><span class="s0">False,</span>
        <span class="s1">)</span>

        <span class="s1">expected2 = merge(</span>
            <span class="s1">to_join</span><span class="s0">,</span>
            <span class="s1">data</span><span class="s0">,</span>
            <span class="s1">right_on=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">left_index=</span><span class="s0">True,</span>
            <span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">,</span>
            <span class="s1">sort=</span><span class="s0">False,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected2.reindex_like(joined))</span>

        <span class="s1">expected2 = merge(</span>
            <span class="s1">to_join</span><span class="s0">,</span>
            <span class="s1">data</span><span class="s0">,</span>
            <span class="s1">right_on=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">left_index=</span><span class="s0">True,</span>
            <span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">,</span>
            <span class="s1">sort=</span><span class="s0">False,</span>
        <span class="s1">)</span>

        <span class="s1">expected = expected.drop([</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected.index = joined.index</span>

        <span class="s0">assert </span><span class="s1">joined.index.is_monotonic</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s2"># _assert_same_contents(expected, expected2.loc[:, expected.columns])</span>

    <span class="s0">def </span><span class="s1">test_join_hierarchical_mixed(self):</span>
        <span class="s2"># GH 2024</span>
        <span class="s1">df = DataFrame([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">new_df = df.groupby([</span><span class="s3">&quot;a&quot;</span><span class="s1">]).agg({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [np.mean</span><span class="s0">, </span><span class="s1">np.sum]})</span>
        <span class="s1">other_df = DataFrame([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">7</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">])</span>
        <span class="s1">other_df.set_index(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s2"># GH 9455, 12219</span>
        <span class="s1">msg = </span><span class="s3">&quot;merging between different levels is deprecated&quot;</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">result = merge(new_df</span><span class="s0">, </span><span class="s1">other_df</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">) </span><span class="s0">in </span><span class="s1">result</span>
        <span class="s0">assert </span><span class="s3">&quot;b&quot; </span><span class="s0">in </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">test_join_float64_float32(self):</span>

        <span class="s1">a = DataFrame(np.random.randn(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">b = DataFrame(np.random.randn(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
        <span class="s1">joined = a.join(b)</span>
        <span class="s0">assert </span><span class="s1">joined.dtypes[</span><span class="s3">&quot;a&quot;</span><span class="s1">] == </span><span class="s3">&quot;float64&quot;</span>
        <span class="s0">assert </span><span class="s1">joined.dtypes[</span><span class="s3">&quot;b&quot;</span><span class="s1">] == </span><span class="s3">&quot;float64&quot;</span>
        <span class="s0">assert </span><span class="s1">joined.dtypes[</span><span class="s3">&quot;c&quot;</span><span class="s1">] == </span><span class="s3">&quot;float32&quot;</span>

        <span class="s1">a = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">100</span><span class="s1">).astype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">b = np.random.random(</span><span class="s4">100</span><span class="s1">).astype(</span><span class="s3">&quot;float64&quot;</span><span class="s1">)</span>
        <span class="s1">c = np.random.random(</span><span class="s4">100</span><span class="s1">).astype(</span><span class="s3">&quot;float32&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: a</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: b</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: c})</span>
        <span class="s1">xpdf = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: a</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: b</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: c})</span>
        <span class="s1">s = DataFrame(np.random.random(</span><span class="s4">5</span><span class="s1">).astype(</span><span class="s3">&quot;float32&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;md&quot;</span><span class="s1">])</span>
        <span class="s1">rs = df.merge(s</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">rs.dtypes[</span><span class="s3">&quot;a&quot;</span><span class="s1">] == </span><span class="s3">&quot;int64&quot;</span>
        <span class="s0">assert </span><span class="s1">rs.dtypes[</span><span class="s3">&quot;b&quot;</span><span class="s1">] == </span><span class="s3">&quot;float64&quot;</span>
        <span class="s0">assert </span><span class="s1">rs.dtypes[</span><span class="s3">&quot;c&quot;</span><span class="s1">] == </span><span class="s3">&quot;float32&quot;</span>
        <span class="s0">assert </span><span class="s1">rs.dtypes[</span><span class="s3">&quot;md&quot;</span><span class="s1">] == </span><span class="s3">&quot;float32&quot;</span>

        <span class="s1">xp = xpdf.merge(s</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(rs</span><span class="s0">, </span><span class="s1">xp)</span>

    <span class="s0">def </span><span class="s1">test_join_many_non_unique_index(self):</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s4">100</span><span class="s0">, </span><span class="s4">200</span><span class="s1">]})</span>
        <span class="s1">df3 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">: [</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">2000</span><span class="s1">]})</span>
        <span class="s1">idf1 = df1.set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">idf2 = df2.set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">idf3 = df3.set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>

        <span class="s1">result = idf1.join([idf2</span><span class="s0">, </span><span class="s1">idf3]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>

        <span class="s1">df_partially_merged = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">expected = merge(df_partially_merged</span><span class="s0">, </span><span class="s1">df3</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>

        <span class="s1">result = result.reset_index()</span>
        <span class="s1">expected = expected[result.columns]</span>
        <span class="s1">expected[</span><span class="s3">&quot;a&quot;</span><span class="s1">] = expected.a.astype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">expected[</span><span class="s3">&quot;b&quot;</span><span class="s1">] = expected.b.astype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">30</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s4">100</span><span class="s0">, </span><span class="s4">200</span><span class="s0">, </span><span class="s4">300</span><span class="s1">]})</span>
        <span class="s1">df3 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">: [</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">2000</span><span class="s0">, </span><span class="s4">3000</span><span class="s1">]})</span>
        <span class="s1">idf1 = df1.set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">idf2 = df2.set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">idf3 = df3.set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">result = idf1.join([idf2</span><span class="s0">, </span><span class="s1">idf3]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>

        <span class="s1">df_partially_merged = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">expected = merge(df_partially_merged</span><span class="s0">, </span><span class="s1">df3</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>

        <span class="s1">result = result.reset_index()</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.loc[:</span><span class="s0">, </span><span class="s1">result.columns])</span>

        <span class="s2"># GH 11519</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;three&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;three&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;D&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">s = Series(</span>
            <span class="s1">np.repeat(np.arange(</span><span class="s4">8</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=np.repeat(np.arange(</span><span class="s4">8</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;TEST&quot;</span>
        <span class="s1">)</span>
        <span class="s1">inner = df.join(s</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">outer = df.join(s</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">left = df.join(s</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">right = df.join(s</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(inner</span><span class="s0">, </span><span class="s1">outer)</span>
        <span class="s1">tm.assert_frame_equal(inner</span><span class="s0">, </span><span class="s1">left)</span>
        <span class="s1">tm.assert_frame_equal(inner</span><span class="s0">, </span><span class="s1">right)</span>

    <span class="s0">def </span><span class="s1">test_join_sort(self):</span>
        <span class="s1">left = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;value2&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span>

        <span class="s1">joined = left.join(right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;value2&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s2"># smoke test</span>
        <span class="s1">joined = left.join(right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">tm.assert_index_equal(joined.index</span><span class="s0">, </span><span class="s1">Index(range(</span><span class="s4">4</span><span class="s1">))</span><span class="s0">, </span><span class="s1">exact=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_mixed_non_unique_index(self):</span>
        <span class="s2"># GH 12814, unorderable types in py3 with a non-unique index</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span>
        <span class="s1">result = df1.join(df2)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s1">np.nan]}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df3 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">df4 = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span>
        <span class="s1">result = df3.join(df4)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s1">np.nan]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_non_unique_period_index(self):</span>
        <span class="s2"># GH #16871</span>
        <span class="s1">index = pd.period_range(</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">16</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(list(range(len(index)))</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;pnum&quot;</span><span class="s1">])</span>
        <span class="s1">df2 = concat([df</span><span class="s0">, </span><span class="s1">df])</span>
        <span class="s1">result = df.join(df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_df2&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.tile(np.arange(</span><span class="s4">16</span><span class="s0">, </span><span class="s1">dtype=np.int64).repeat(</span><span class="s4">2</span><span class="s1">).reshape(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;pnum&quot;</span><span class="s0">, </span><span class="s3">&quot;pnum_df2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=df2.sort_index().index</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_mixed_type_join_with_suffix(self):</span>
        <span class="s2"># GH #916</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">20</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">])</span>
        <span class="s1">df.insert(</span><span class="s4">0</span><span class="s0">, </span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">df.insert(</span><span class="s4">5</span><span class="s0">, </span><span class="s3">&quot;dt&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

        <span class="s1">grouped = df.groupby(</span><span class="s3">&quot;id&quot;</span><span class="s1">)</span>
        <span class="s1">mn = grouped.mean()</span>
        <span class="s1">cn = grouped.count()</span>

        <span class="s2"># it works!</span>
        <span class="s1">mn.join(cn</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_right&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_many(self):</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s3">&quot;abcdef&quot;</span><span class="s1">))</span>
        <span class="s1">df_list = [df[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">df[[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">df[[</span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]]]</span>

        <span class="s1">joined = df_list[</span><span class="s4">0</span><span class="s1">].join(df_list[</span><span class="s4">1</span><span class="s1">:])</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">df_list = [df[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]][:-</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df[[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]][</span><span class="s4">2</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">df[[</span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]][</span><span class="s4">1</span><span class="s1">:</span><span class="s4">9</span><span class="s1">]]</span>

        <span class="s0">def </span><span class="s1">_check_diff_index(df_list</span><span class="s0">, </span><span class="s1">result</span><span class="s0">, </span><span class="s1">exp_index):</span>
            <span class="s1">reindexed = [x.reindex(exp_index) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">df_list]</span>
            <span class="s1">expected = reindexed[</span><span class="s4">0</span><span class="s1">].join(reindexed[</span><span class="s4">1</span><span class="s1">:])</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s2"># different join types</span>
        <span class="s1">joined = df_list[</span><span class="s4">0</span><span class="s1">].join(df_list[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">_check_diff_index(df_list</span><span class="s0">, </span><span class="s1">joined</span><span class="s0">, </span><span class="s1">df.index)</span>

        <span class="s1">joined = df_list[</span><span class="s4">0</span><span class="s1">].join(df_list[</span><span class="s4">1</span><span class="s1">:])</span>
        <span class="s1">_check_diff_index(df_list</span><span class="s0">, </span><span class="s1">joined</span><span class="s0">, </span><span class="s1">df_list[</span><span class="s4">0</span><span class="s1">].index)</span>

        <span class="s1">joined = df_list[</span><span class="s4">0</span><span class="s1">].join(df_list[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">_check_diff_index(df_list</span><span class="s0">, </span><span class="s1">joined</span><span class="s0">, </span><span class="s1">df.index[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">8</span><span class="s1">])</span>

        <span class="s1">msg = </span><span class="s3">&quot;Joining multiple DataFrames only supported for joining on index&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df_list[</span><span class="s4">0</span><span class="s1">].join(df_list[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_join_many_mixed(self):</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">8</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">])</span>
        <span class="s1">df[</span><span class="s3">&quot;key&quot;</span><span class="s1">] = [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">] * </span><span class="s4">4</span>
        <span class="s1">df1 = df.loc[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]]</span>
        <span class="s1">df2 = df.loc[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]]</span>
        <span class="s1">df3 = df.loc[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;key&quot;</span><span class="s1">]]</span>

        <span class="s1">result = df1.join([df2</span><span class="s0">, </span><span class="s1">df3])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s0">def </span><span class="s1">test_join_dups(self):</span>

        <span class="s2"># joining dups</span>
        <span class="s1">df = concat(</span>
            <span class="s1">[</span>
                <span class="s1">DataFrame(np.random.randn(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">DataFrame(</span>
                    <span class="s1">np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">20</span><span class="s1">).reshape(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">axis=</span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected = concat([df</span><span class="s0">, </span><span class="s1">df]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">result = df.join(df</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_2&quot;</span><span class="s1">)</span>
        <span class="s1">result.columns = expected.columns</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s2"># GH 4975, invalid join on dups</span>
        <span class="s1">w = DataFrame(np.random.randn(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s1">x = DataFrame(np.random.randn(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s1">y = DataFrame(np.random.randn(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s1">z = DataFrame(np.random.randn(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])</span>

        <span class="s1">dta = x.merge(y</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">).merge(</span>
            <span class="s1">z</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
            <span class="s1">dta = dta.merge(w</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = concat([x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">w]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected.columns = [</span><span class="s3">&quot;x_x&quot;</span><span class="s0">, </span><span class="s3">&quot;y_x&quot;</span><span class="s0">, </span><span class="s3">&quot;x_y&quot;</span><span class="s0">, </span><span class="s3">&quot;y_y&quot;</span><span class="s0">, </span><span class="s3">&quot;x_x&quot;</span><span class="s0">, </span><span class="s3">&quot;y_x&quot;</span><span class="s0">, </span><span class="s3">&quot;x_y&quot;</span><span class="s0">, </span><span class="s3">&quot;y_y&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(dta</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_multi_to_multi(self</span><span class="s0">, </span><span class="s1">join_type):</span>
        <span class="s2"># GH 20475</span>
        <span class="s1">leftindex = MultiIndex.from_product(</span>
            <span class="s1">[list(</span><span class="s3">&quot;abc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(</span><span class="s3">&quot;xy&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s3">&quot;xy&quot;</span><span class="s0">, </span><span class="s3">&quot;num&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">left = DataFrame({</span><span class="s3">&quot;v1&quot;</span><span class="s1">: range(</span><span class="s4">12</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">index=leftindex)</span>

        <span class="s1">rightindex = MultiIndex.from_product(</span>
            <span class="s1">[list(</span><span class="s3">&quot;abc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(</span><span class="s3">&quot;xy&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s3">&quot;xy&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;v2&quot;</span><span class="s1">: [</span><span class="s4">100 </span><span class="s1">* i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)]}</span><span class="s0">, </span><span class="s1">index=rightindex)</span>

        <span class="s1">result = left.join(right</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s3">&quot;xy&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=join_type)</span>
        <span class="s1">expected = (</span>
            <span class="s1">left.reset_index()</span>
            <span class="s1">.merge(right.reset_index()</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s3">&quot;xy&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=join_type)</span>
            <span class="s1">.set_index([</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s3">&quot;xy&quot;</span><span class="s0">, </span><span class="s3">&quot;num&quot;</span><span class="s1">])</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">msg = </span><span class="s3">r'len\(left_on\) must equal the number of levels in the index of &quot;right&quot;'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">left.join(right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;xy&quot;</span><span class="s0">, </span><span class="s1">how=join_type)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">right.join(left</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s3">&quot;xy&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=join_type)</span>

    <span class="s0">def </span><span class="s1">test_join_on_tz_aware_datetimeindex(self):</span>
        <span class="s2"># GH 23931, 26335</span>
        <span class="s1">df1 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s1">: pd.date_range(</span>
                    <span class="s1">start=</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;America/Chicago&quot;</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;vals&quot;</span><span class="s1">: list(</span><span class="s3">&quot;abcde&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s1">: pd.date_range(</span>
                    <span class="s1">start=</span><span class="s3">&quot;2018-01-03&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;America/Chicago&quot;</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;vals_2&quot;</span><span class="s1">: list(</span><span class="s3">&quot;tuvwx&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = df1.join(df2.set_index(</span><span class="s3">&quot;date&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;date&quot;</span><span class="s1">)</span>
        <span class="s1">expected = df1.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;vals_2&quot;</span><span class="s1">] = Series([np.nan] * </span><span class="s4">2 </span><span class="s1">+ list(</span><span class="s3">&quot;tuv&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_datetime_string(self):</span>
        <span class="s2"># GH 5647</span>
        <span class="s1">dfa = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s3">&quot;2012-08-02&quot;</span><span class="s0">, </span><span class="s3">&quot;L&quot;</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;2012-08-02&quot;</span><span class="s0">, </span><span class="s3">&quot;J&quot;</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;2013-04-06&quot;</span><span class="s0">, </span><span class="s3">&quot;L&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;2013-04-06&quot;</span><span class="s0">, </span><span class="s3">&quot;J&quot;</span><span class="s0">, </span><span class="s4">25</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">dfa[</span><span class="s3">&quot;x&quot;</span><span class="s1">] = pd.to_datetime(dfa[</span><span class="s3">&quot;x&quot;</span><span class="s1">])</span>
        <span class="s1">dfb = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">&quot;2012-08-02&quot;</span><span class="s0">, </span><span class="s3">&quot;J&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;2013-04-06&quot;</span><span class="s0">, </span><span class="s3">&quot;L&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">dfb[</span><span class="s3">&quot;x&quot;</span><span class="s1">] = pd.to_datetime(dfb[</span><span class="s3">&quot;x&quot;</span><span class="s1">])</span>
        <span class="s1">result = dfb.join(dfa.set_index([</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[Timestamp(</span><span class="s3">&quot;2012-08-02 00:00:00&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;J&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[Timestamp(</span><span class="s3">&quot;2013-04-06 00:00:00&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;L&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">_check_join(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">result</span><span class="s0">, </span><span class="s1">join_col</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">lsuffix=</span><span class="s3">&quot;_x&quot;</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_y&quot;</span><span class="s1">):</span>

    <span class="s2"># some smoke tests</span>
    <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">join_col:</span>
        <span class="s0">assert </span><span class="s1">result[c].notna().all()</span>

    <span class="s1">left_grouped = left.groupby(join_col)</span>
    <span class="s1">right_grouped = right.groupby(join_col)</span>

    <span class="s0">for </span><span class="s1">group_key</span><span class="s0">, </span><span class="s1">group </span><span class="s0">in </span><span class="s1">result.groupby(join_col):</span>
        <span class="s1">l_joined = _restrict_to_columns(group</span><span class="s0">, </span><span class="s1">left.columns</span><span class="s0">, </span><span class="s1">lsuffix)</span>
        <span class="s1">r_joined = _restrict_to_columns(group</span><span class="s0">, </span><span class="s1">right.columns</span><span class="s0">, </span><span class="s1">rsuffix)</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">lgroup = left_grouped.get_group(group_key)</span>
        <span class="s0">except </span><span class="s1">KeyError </span><span class="s0">as </span><span class="s1">err:</span>
            <span class="s0">if </span><span class="s1">how </span><span class="s0">in </span><span class="s1">(</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">):</span>
                <span class="s0">raise </span><span class="s1">AssertionError(</span>
                    <span class="s3">f&quot;key </span><span class="s0">{</span><span class="s1">group_key</span><span class="s0">} </span><span class="s3">should not have been in the join&quot;</span>
                <span class="s1">) </span><span class="s0">from </span><span class="s1">err</span>

            <span class="s1">_assert_all_na(l_joined</span><span class="s0">, </span><span class="s1">left.columns</span><span class="s0">, </span><span class="s1">join_col)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">_assert_same_contents(l_joined</span><span class="s0">, </span><span class="s1">lgroup)</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">rgroup = right_grouped.get_group(group_key)</span>
        <span class="s0">except </span><span class="s1">KeyError </span><span class="s0">as </span><span class="s1">err:</span>
            <span class="s0">if </span><span class="s1">how </span><span class="s0">in </span><span class="s1">(</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">):</span>
                <span class="s0">raise </span><span class="s1">AssertionError(</span>
                    <span class="s3">f&quot;key </span><span class="s0">{</span><span class="s1">group_key</span><span class="s0">} </span><span class="s3">should not have been in the join&quot;</span>
                <span class="s1">) </span><span class="s0">from </span><span class="s1">err</span>

            <span class="s1">_assert_all_na(r_joined</span><span class="s0">, </span><span class="s1">right.columns</span><span class="s0">, </span><span class="s1">join_col)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">_assert_same_contents(r_joined</span><span class="s0">, </span><span class="s1">rgroup)</span>


<span class="s0">def </span><span class="s1">_restrict_to_columns(group</span><span class="s0">, </span><span class="s1">columns</span><span class="s0">, </span><span class="s1">suffix):</span>
    <span class="s1">found = [</span>
        <span class="s1">c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">group.columns </span><span class="s0">if </span><span class="s1">c </span><span class="s0">in </span><span class="s1">columns </span><span class="s0">or </span><span class="s1">c.replace(suffix</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">) </span><span class="s0">in </span><span class="s1">columns</span>
    <span class="s1">]</span>

    <span class="s2"># filter</span>
    <span class="s1">group = group.loc[:</span><span class="s0">, </span><span class="s1">found]</span>

    <span class="s2"># get rid of suffixes, if any</span>
    <span class="s1">group = group.rename(columns=</span><span class="s0">lambda </span><span class="s1">x: x.replace(suffix</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">))</span>

    <span class="s2"># put in the right order...</span>
    <span class="s1">group = group.loc[:</span><span class="s0">, </span><span class="s1">columns]</span>

    <span class="s0">return </span><span class="s1">group</span>


<span class="s0">def </span><span class="s1">_assert_same_contents(join_chunk</span><span class="s0">, </span><span class="s1">source):</span>
    <span class="s1">NA_SENTINEL = -</span><span class="s4">1234567  </span><span class="s2"># drop_duplicates not so NA-friendly...</span>

    <span class="s1">jvalues = join_chunk.fillna(NA_SENTINEL).drop_duplicates().values</span>
    <span class="s1">svalues = source.fillna(NA_SENTINEL).drop_duplicates().values</span>

    <span class="s1">rows = {tuple(row) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">jvalues}</span>
    <span class="s0">assert </span><span class="s1">len(rows) == len(source)</span>
    <span class="s0">assert </span><span class="s1">all(tuple(row) </span><span class="s0">in </span><span class="s1">rows </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">svalues)</span>


<span class="s0">def </span><span class="s1">_assert_all_na(join_chunk</span><span class="s0">, </span><span class="s1">source_columns</span><span class="s0">, </span><span class="s1">join_col):</span>
    <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">source_columns:</span>
        <span class="s0">if </span><span class="s1">c </span><span class="s0">in </span><span class="s1">join_col:</span>
            <span class="s0">continue</span>
        <span class="s0">assert </span><span class="s1">join_chunk[c].isna().all()</span>


<span class="s0">def </span><span class="s1">_join_by_hand(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s1">):</span>
    <span class="s1">join_index = a.index.join(b.index</span><span class="s0">, </span><span class="s1">how=how)</span>

    <span class="s1">a_re = a.reindex(join_index)</span>
    <span class="s1">b_re = b.reindex(join_index)</span>

    <span class="s1">result_columns = a.columns.append(b.columns)</span>

    <span class="s0">for </span><span class="s1">col</span><span class="s0">, </span><span class="s1">s </span><span class="s0">in </span><span class="s1">b_re.items():</span>
        <span class="s1">a_re[col] = s</span>
    <span class="s0">return </span><span class="s1">a_re.reindex(columns=result_columns)</span>


<span class="s0">def </span><span class="s1">test_join_inner_multiindex_deterministic_order():</span>
    <span class="s2"># GH: 36910</span>
    <span class="s1">left = DataFrame(</span>
        <span class="s1">data={</span><span class="s3">&quot;e&quot;</span><span class="s1">: </span><span class="s4">5</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">right = DataFrame(</span>
        <span class="s1">data={</span><span class="s3">&quot;f&quot;</span><span class="s1">: </span><span class="s4">6</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_tuples([(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">)</span>
    <span class="s1">result = left.join(right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;e&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">: [</span><span class="s4">6</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples([(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s3">&quot;input_col&quot;</span><span class="s0">, </span><span class="s3">&quot;output_cols&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a_x&quot;</span><span class="s0">, </span><span class="s3">&quot;a_y&quot;</span><span class="s1">])]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_join_cross(input_col</span><span class="s0">, </span><span class="s1">output_cols):</span>
    <span class="s2"># GH#5401</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
    <span class="s1">right = DataFrame({input_col: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">result = left.join(right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;cross&quot;</span><span class="s0">, </span><span class="s1">lsuffix=</span><span class="s3">&quot;_x&quot;</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_y&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({output_cols[</span><span class="s4">0</span><span class="s1">]: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">output_cols[</span><span class="s4">1</span><span class="s1">]: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_join_multiindex_one_level(join_type):</span>
    <span class="s2"># GH#36909</span>
    <span class="s1">left = DataFrame(</span>
        <span class="s1">data={</span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_tuples([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s1">)</span>
    <span class="s1">right = DataFrame(data={</span><span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s4">4</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_tuples([(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;b&quot;</span><span class="s0">,</span><span class="s1">)))</span>
    <span class="s1">result = left.join(right</span><span class="s0">, </span><span class="s1">how=join_type)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s4">4</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples([(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;categories, values&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[Timestamp(</span><span class="s3">&quot;2020-12-31&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s3">&quot;2019-12-31&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">[Timestamp(</span><span class="s3">&quot;2020-12-31&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s3">&quot;2019-12-31&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s3">&quot;2019-12-31&quot;</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_join_multiindex_not_alphabetical_categorical(categories</span><span class="s0">, </span><span class="s1">values):</span>
    <span class="s2"># GH#38502</span>
    <span class="s1">left = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;first&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;second&quot;</span><span class="s1">: Categorical(categories</span><span class="s0">, </span><span class="s1">categories=categories)</span><span class="s0">,</span>
            <span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">).set_index([</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">])</span>
    <span class="s1">right = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;first&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;second&quot;</span><span class="s1">: Categorical(values</span><span class="s0">, </span><span class="s1">categories=categories)</span><span class="s0">,</span>
            <span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">).set_index([</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">])</span>
    <span class="s1">result = left.join(right</span><span class="s0">, </span><span class="s1">lsuffix=</span><span class="s3">&quot;_left&quot;</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_right&quot;</span><span class="s1">)</span>

    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;first&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;second&quot;</span><span class="s1">: Categorical(categories</span><span class="s0">, </span><span class="s1">categories=categories)</span><span class="s0">,</span>
            <span class="s3">&quot;value_left&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;value_right&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">).set_index([</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>