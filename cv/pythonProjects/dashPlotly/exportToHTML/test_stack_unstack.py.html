<html>
<head>
<title>test_stack_unstack.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_stack_unstack.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">StringIO</span>
<span class="s0">import </span><span class="s1">itertools</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.errors </span><span class="s0">import </span><span class="s1">PerformanceWarning</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Period</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timedelta</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.reshape </span><span class="s0">import </span><span class="s1">reshape </span><span class="s0">as </span><span class="s1">reshape_lib</span>


<span class="s0">class </span><span class="s1">TestDataFrameReshape:</span>
    <span class="s0">def </span><span class="s1">test_stack_unstack(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s1">df = float_frame.copy()</span>
        <span class="s1">df[:] = np.arange(np.prod(df.shape)).reshape(df.shape)</span>

        <span class="s1">stacked = df.stack()</span>
        <span class="s1">stacked_df = DataFrame({</span><span class="s2">&quot;foo&quot;</span><span class="s1">: stacked</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">: stacked})</span>

        <span class="s1">unstacked = stacked.unstack()</span>
        <span class="s1">unstacked_df = stacked_df.unstack()</span>

        <span class="s1">tm.assert_frame_equal(unstacked</span><span class="s0">, </span><span class="s1">df)</span>
        <span class="s1">tm.assert_frame_equal(unstacked_df[</span><span class="s2">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">unstacked_cols = stacked.unstack(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">unstacked_cols_df = stacked_df.unstack(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(unstacked_cols.T</span><span class="s0">, </span><span class="s1">df)</span>
        <span class="s1">tm.assert_frame_equal(unstacked_cols_df[</span><span class="s2">&quot;bar&quot;</span><span class="s1">].T</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s0">def </span><span class="s1">test_stack_mixed_level(self):</span>
        <span class="s4"># GH 18310</span>
        <span class="s1">levels = [range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span>

        <span class="s4"># flat columns:</span>
        <span class="s1">df = DataFrame(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">index=levels[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=levels[</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">result = df.stack()</span>
        <span class="s1">expected = Series(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_product(levels[:</span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># MultiIndex columns:</span>
        <span class="s1">df = DataFrame(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">index=levels[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=MultiIndex.from_product(levels[</span><span class="s3">1</span><span class="s1">:]))</span>
        <span class="s1">result = df.stack(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s3">1</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_product([levels[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">levels[</span><span class="s3">2</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">columns=levels[</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># as above, but used labels in level are actually of homogeneous type</span>
        <span class="s1">result = df[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]].stack(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">expected = expected[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_not_consolidated(self</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
        <span class="s4"># Gh#34708</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.NaN]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.NaN]})</span>
        <span class="s1">df2 = df[[</span><span class="s2">&quot;x&quot;</span><span class="s1">]]</span>
        <span class="s1">df2[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = df[</span><span class="s2">&quot;y&quot;</span><span class="s1">]</span>
        <span class="s0">if not </span><span class="s1">using_array_manager:</span>
            <span class="s0">assert </span><span class="s1">len(df2._mgr.blocks) == </span><span class="s3">2</span>

        <span class="s1">res = df2.unstack()</span>
        <span class="s1">expected = df.unstack()</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_fill(self):</span>

        <span class="s4"># GH #9746: fill_value keyword argument for Series</span>
        <span class="s4"># and DataFrame unstack</span>

        <span class="s4"># From a series</span>
        <span class="s1">data = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16)</span>
        <span class="s1">data.index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s1">result = data.unstack(fill_value=-</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># From a series with incorrect data type for fill_value</span>
        <span class="s1">result = data.unstack(fill_value=</span><span class="s3">0.5</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># GH #13971: fill_value when unstacking multiple levels:</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s2">&quot;k&quot;</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]}</span>
        <span class="s1">).set_index([</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">])</span>
        <span class="s1">unstacked = df.unstack([</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">key = (</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span>
        <span class="s1">expected = unstacked[key]</span>
        <span class="s1">result = Series([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=unstacked.index</span><span class="s0">, </span><span class="s1">name=key)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">stacked = unstacked.stack([</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s1">stacked.index = stacked.index.reorder_levels(df.index.names)</span>
        <span class="s4"># Workaround for GH #17886 (unnecessarily casts to float):</span>
        <span class="s1">stacked = stacked.astype(np.int64)</span>
        <span class="s1">result = stacked.loc[df.index]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s4"># From a series</span>
        <span class="s1">s = df[</span><span class="s2">&quot;w&quot;</span><span class="s1">]</span>
        <span class="s1">result = s.unstack([</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">expected = unstacked[</span><span class="s2">&quot;w&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_fill_frame(self):</span>

        <span class="s4"># From a dataframe</span>
        <span class="s1">rows = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]]</span>
        <span class="s1">df = DataFrame(rows</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;AB&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">df.index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s1">result = df.unstack(fill_value=-</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">rows = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]]</span>
        <span class="s1">expected = DataFrame(rows</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">expected.columns = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># From a mixed type dataframe</span>
        <span class="s1">df[</span><span class="s2">&quot;A&quot;</span><span class="s1">] = df[</span><span class="s2">&quot;A&quot;</span><span class="s1">].astype(np.int16)</span>
        <span class="s1">df[</span><span class="s2">&quot;B&quot;</span><span class="s1">] = df[</span><span class="s2">&quot;B&quot;</span><span class="s1">].astype(np.float64)</span>

        <span class="s1">result = df.unstack(fill_value=-</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">expected[</span><span class="s2">&quot;A&quot;</span><span class="s1">] = expected[</span><span class="s2">&quot;A&quot;</span><span class="s1">].astype(np.int16)</span>
        <span class="s1">expected[</span><span class="s2">&quot;B&quot;</span><span class="s1">] = expected[</span><span class="s2">&quot;B&quot;</span><span class="s1">].astype(np.float64)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># From a dataframe with incorrect data type for fill_value</span>
        <span class="s1">result = df.unstack(fill_value=</span><span class="s3">0.5</span><span class="s1">)</span>

        <span class="s1">rows = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">]]</span>
        <span class="s1">expected = DataFrame(rows</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=float)</span>
        <span class="s1">expected.columns = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_fill_frame_datetime(self):</span>

        <span class="s4"># Test unstacking with date times</span>
        <span class="s1">dv = date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">4</span><span class="s1">).values</span>
        <span class="s1">data = Series(dv)</span>
        <span class="s1">data.index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s1">result = data.unstack()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [dv[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">dv[</span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [dv[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dv[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">pd.NaT]}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = data.unstack(fill_value=dv[</span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [dv[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dv[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dv[</span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [dv[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dv[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dv[</span><span class="s3">0</span><span class="s1">]]}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_fill_frame_timedelta(self):</span>

        <span class="s4"># Test unstacking with time deltas</span>
        <span class="s1">td = [Timedelta(days=i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)]</span>
        <span class="s1">data = Series(td)</span>
        <span class="s1">data.index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s1">result = data.unstack()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [td[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">td[</span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [td[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">td[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">pd.NaT]}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = data.unstack(fill_value=td[</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [td[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">td[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">td[</span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [td[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">td[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">td[</span><span class="s3">1</span><span class="s1">]]}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_fill_frame_period(self):</span>

        <span class="s4"># Test unstacking with period</span>
        <span class="s1">periods = [</span>
            <span class="s1">Period(</span><span class="s2">&quot;2012-01&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Period(</span><span class="s2">&quot;2012-02&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Period(</span><span class="s2">&quot;2012-03&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Period(</span><span class="s2">&quot;2012-04&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">data = Series(periods)</span>
        <span class="s1">data.index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s1">result = data.unstack()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [periods[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, None, </span><span class="s1">periods[</span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [periods[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">periods[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = data.unstack(fill_value=periods[</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [periods[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">periods[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">periods[</span><span class="s3">3</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [periods[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">periods[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">periods[</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_fill_frame_categorical(self):</span>

        <span class="s4"># Test unstacking with categorical</span>
        <span class="s1">data = Series([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">data.index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s4"># By default missing values will be NaN</span>
        <span class="s1">result = data.unstack()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: pd.Categorical(list(</span><span class="s2">&quot;axa&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">categories=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: pd.Categorical(list(</span><span class="s2">&quot;bcx&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">categories=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># Fill with non-category results in a ValueError</span>
        <span class="s1">msg = </span><span class="s2">r&quot;Cannot setitem on a Categorical with a new category \(d\)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">data.unstack(fill_value=</span><span class="s2">&quot;d&quot;</span><span class="s1">)</span>

        <span class="s4"># Fill with category value replaces missing values as expected</span>
        <span class="s1">result = data.unstack(fill_value=</span><span class="s2">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: pd.Categorical(list(</span><span class="s2">&quot;aca&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">categories=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: pd.Categorical(list(</span><span class="s2">&quot;bcc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">categories=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_tuplename_in_multiindex(self):</span>
        <span class="s4"># GH 19966</span>
        <span class="s1">idx = MultiIndex.from_product(</span>
            <span class="s1">[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">9</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">9</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">result = df.unstack((</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[</span>
                    <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s0">None, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;unstack_idx, expected_values, expected_index, expected_columns&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">MultiIndex.from_tuples(</span>
                    <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">MultiIndex.from_tuples(</span>
                    <span class="s1">[(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">names=[</span><span class="s0">None, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">((</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">Index([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">MultiIndex.from_tuples(</span>
                    <span class="s1">[</span>
                        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">names=[</span><span class="s0">None, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_unstack_mixed_type_name_in_multiindex(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">unstack_idx</span><span class="s0">, </span><span class="s1">expected_values</span><span class="s0">, </span><span class="s1">expected_index</span><span class="s0">, </span><span class="s1">expected_columns</span>
    <span class="s1">):</span>
        <span class="s4"># GH 19966</span>
        <span class="s1">idx = MultiIndex.from_product(</span>
            <span class="s1">[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">8</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">8</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">result = df.unstack(unstack_idx)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">expected_values</span><span class="s0">, </span><span class="s1">columns=expected_columns</span><span class="s0">, </span><span class="s1">index=expected_index</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_preserve_dtypes(self):</span>
        <span class="s4"># Checks fix for #11847</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;state&quot;</span><span class="s1">: [</span><span class="s2">&quot;IL&quot;</span><span class="s0">, </span><span class="s2">&quot;MI&quot;</span><span class="s0">, </span><span class="s2">&quot;NC&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;index&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;some_categories&quot;</span><span class="s1">: Series([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]).astype(</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;A&quot;</span><span class="s1">: np.random.rand(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">,</span>
                <span class="s2">&quot;C&quot;</span><span class="s1">: </span><span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;D&quot;</span><span class="s1">: pd.Timestamp(</span><span class="s2">&quot;20010102&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;E&quot;</span><span class="s1">: Series([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">50.0</span><span class="s0">, </span><span class="s3">100.0</span><span class="s1">]).astype(</span><span class="s2">&quot;float32&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;F&quot;</span><span class="s1">: Series([</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">]).astype(</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;G&quot;</span><span class="s1">: </span><span class="s0">False,</span>
                <span class="s2">&quot;H&quot;</span><span class="s1">: Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">200</span><span class="s0">, </span><span class="s3">923442</span><span class="s1">]).astype(</span><span class="s2">&quot;int8&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s0">def </span><span class="s1">unstack_and_compare(df</span><span class="s0">, </span><span class="s1">column_name):</span>
            <span class="s1">unstacked1 = df.unstack([column_name])</span>
            <span class="s1">unstacked2 = df.unstack(column_name)</span>
            <span class="s1">tm.assert_frame_equal(unstacked1</span><span class="s0">, </span><span class="s1">unstacked2)</span>

        <span class="s1">df1 = df.set_index([</span><span class="s2">&quot;state&quot;</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">])</span>
        <span class="s1">unstack_and_compare(df1</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">)</span>

        <span class="s1">df1 = df.set_index([</span><span class="s2">&quot;state&quot;</span><span class="s0">, </span><span class="s2">&quot;some_categories&quot;</span><span class="s1">])</span>
        <span class="s1">unstack_and_compare(df1</span><span class="s0">, </span><span class="s2">&quot;some_categories&quot;</span><span class="s1">)</span>

        <span class="s1">df1 = df.set_index([</span><span class="s2">&quot;F&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">])</span>
        <span class="s1">unstack_and_compare(df1</span><span class="s0">, </span><span class="s2">&quot;F&quot;</span><span class="s1">)</span>

        <span class="s1">df1 = df.set_index([</span><span class="s2">&quot;G&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;state&quot;</span><span class="s1">])</span>
        <span class="s1">unstack_and_compare(df1</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>

        <span class="s1">df1 = df.set_index([</span><span class="s2">&quot;E&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s1">unstack_and_compare(df1</span><span class="s0">, </span><span class="s2">&quot;E&quot;</span><span class="s1">)</span>

        <span class="s1">df1 = df.set_index([</span><span class="s2">&quot;state&quot;</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">])</span>
        <span class="s1">s = df1[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">unstack_and_compare(s</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_stack_ints(self):</span>
        <span class="s1">columns = MultiIndex.from_tuples(list(itertools.product(range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">repeat=</span><span class="s3">3</span><span class="s1">)))</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">30</span><span class="s0">, </span><span class="s3">27</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=columns)</span>

        <span class="s1">tm.assert_frame_equal(df.stack(level=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.stack(level=</span><span class="s3">1</span><span class="s1">).stack(level=</span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df.stack(level=[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.stack(level=</span><span class="s3">1</span><span class="s1">).stack(level=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s1">df_named = df.copy()</span>
        <span class="s1">return_value = df_named.columns.set_names(range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>

        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df_named.stack(level=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df_named.stack(level=</span><span class="s3">1</span><span class="s1">).stack(level=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_stack_mixed_levels(self):</span>
        <span class="s1">columns = MultiIndex.from_tuples(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;cat&quot;</span><span class="s0">, </span><span class="s2">&quot;long&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;cat&quot;</span><span class="s0">, </span><span class="s2">&quot;long&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;dog&quot;</span><span class="s0">, </span><span class="s2">&quot;short&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;dog&quot;</span><span class="s0">, </span><span class="s2">&quot;short&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s2">&quot;hair_length&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=columns)</span>

        <span class="s1">animal_hair_stacked = df.stack(level=[</span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s2">&quot;hair_length&quot;</span><span class="s1">])</span>
        <span class="s1">exp_hair_stacked = df.stack(level=[</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;hair_length&quot;</span><span class="s1">])</span>

        <span class="s4"># GH #8584: Need to check that stacking works when a number</span>
        <span class="s4"># is passed that is both a level name and in the range of</span>
        <span class="s4"># the level numbers</span>
        <span class="s1">df2 = df.copy()</span>
        <span class="s1">df2.columns.names = [</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df2.stack(level=[</span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">animal_hair_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df2.stack(level=[</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp_hair_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>

        <span class="s4"># When mixed types are passed and the ints are not level</span>
        <span class="s4"># names, raise</span>
        <span class="s1">msg = (</span>
            <span class="s2">&quot;level should contain all level names or all level numbers, not &quot;</span>
            <span class="s2">&quot;a mixture of the two&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df2.stack(level=[</span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>

        <span class="s4"># GH #8584: Having 0 in the level names could raise a</span>
        <span class="s4"># strange error about lexsort depth</span>
        <span class="s1">df3 = df.copy()</span>
        <span class="s1">df3.columns.names = [</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df3.stack(level=[</span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">animal_hair_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_stack_int_level_names(self):</span>
        <span class="s1">columns = MultiIndex.from_tuples(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;cat&quot;</span><span class="s0">, </span><span class="s2">&quot;long&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;cat&quot;</span><span class="s0">, </span><span class="s2">&quot;long&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;dog&quot;</span><span class="s0">, </span><span class="s2">&quot;short&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;dog&quot;</span><span class="s0">, </span><span class="s2">&quot;short&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s2">&quot;hair_length&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=columns)</span>

        <span class="s1">exp_animal_stacked = df.stack(level=[</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;animal&quot;</span><span class="s1">])</span>
        <span class="s1">animal_hair_stacked = df.stack(level=[</span><span class="s2">&quot;animal&quot;</span><span class="s0">, </span><span class="s2">&quot;hair_length&quot;</span><span class="s1">])</span>
        <span class="s1">exp_hair_stacked = df.stack(level=[</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;hair_length&quot;</span><span class="s1">])</span>

        <span class="s1">df2 = df.copy()</span>
        <span class="s1">df2.columns.names = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df2.stack(level=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">animal_hair_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df2.stack(level=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp_animal_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df2.stack(level=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp_hair_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>

        <span class="s4"># Out-of-order int column names</span>
        <span class="s1">df3 = df.copy()</span>
        <span class="s1">df3.columns.names = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df3.stack(level=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">animal_hair_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df3.stack(level=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp_animal_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df3.stack(level=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp_hair_stacked</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unstack_bool(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[</span><span class="s0">False, False</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_arrays([[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;l&quot;</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;col&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">rs = df.unstack()</span>
        <span class="s1">xp = DataFrame(</span>
            <span class="s1">np.array([[</span><span class="s0">False, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, False</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_arrays([[</span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;l&quot;</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(rs</span><span class="s0">, </span><span class="s1">xp)</span>

    <span class="s0">def </span><span class="s1">test_unstack_level_binding(self):</span>
        <span class="s4"># GH9856</span>
        <span class="s1">mi = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;one&quot;</span><span class="s0">, </span><span class="s2">&quot;two&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;first&quot;</span><span class="s0">, </span><span class="s2">&quot;second&quot;</span><span class="s0">, </span><span class="s2">&quot;third&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">s = Series(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">index=mi)</span>
        <span class="s1">result = s.unstack([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]).stack(</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">expected_mi = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;one&quot;</span><span class="s0">, </span><span class="s2">&quot;two&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;first&quot;</span><span class="s0">, </span><span class="s2">&quot;second&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">, </span><span class="s1">dtype=np.float64</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=expected_mi</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;third&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_to_series(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s4"># check reversibility</span>
        <span class="s1">data = float_frame.unstack()</span>

        <span class="s0">assert </span><span class="s1">isinstance(data</span><span class="s0">, </span><span class="s1">Series)</span>
        <span class="s1">undo = data.unstack().T</span>
        <span class="s1">tm.assert_frame_equal(undo</span><span class="s0">, </span><span class="s1">float_frame)</span>

        <span class="s4"># check NA handling</span>
        <span class="s1">data = DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.NaN]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.NaN]})</span>
        <span class="s1">data.index = Index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">result = data.unstack()</span>

        <span class="s1">midx = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.NaN</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.NaN]</span><span class="s0">, </span><span class="s1">index=midx)</span>

        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># check composability of unstack</span>
        <span class="s1">old_data = data.copy()</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">):</span>
            <span class="s1">data = data.unstack()</span>
        <span class="s1">tm.assert_frame_equal(old_data</span><span class="s0">, </span><span class="s1">data)</span>

    <span class="s0">def </span><span class="s1">test_unstack_dtypes(self):</span>

        <span class="s4"># GH 2929</span>
        <span class="s1">rows = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span>

        <span class="s1">df = DataFrame(rows</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;ABCD&quot;</span><span class="s1">))</span>
        <span class="s1">result = df.dtypes</span>
        <span class="s1">expected = Series([np.dtype(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)] * </span><span class="s3">4</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s2">&quot;ABCD&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># single dtype</span>
        <span class="s1">df2 = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">df3 = df2.unstack(</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">result = df3.dtypes</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[np.dtype(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)] * </span><span class="s3">4</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_arrays(</span>
                <span class="s1">[[</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s0">None, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># mixed</span>
        <span class="s1">df2 = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">df2[</span><span class="s2">&quot;C&quot;</span><span class="s1">] = </span><span class="s3">3.0</span>
        <span class="s1">df3 = df2.unstack(</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">result = df3.dtypes</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[np.dtype(</span><span class="s2">&quot;float64&quot;</span><span class="s1">)] * </span><span class="s3">2 </span><span class="s1">+ [np.dtype(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)] * </span><span class="s3">2</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_arrays(</span>
                <span class="s1">[[</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s0">None, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">df2[</span><span class="s2">&quot;D&quot;</span><span class="s1">] = </span><span class="s2">&quot;foo&quot;</span>
        <span class="s1">df3 = df2.unstack(</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">result = df3.dtypes</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[np.dtype(</span><span class="s2">&quot;float64&quot;</span><span class="s1">)] * </span><span class="s3">2 </span><span class="s1">+ [np.dtype(</span><span class="s2">&quot;object&quot;</span><span class="s1">)] * </span><span class="s3">2</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_arrays(</span>
                <span class="s1">[[</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=(</span><span class="s0">None, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># GH7405</span>
        <span class="s0">for </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d </span><span class="s0">in </span><span class="s1">(</span>
            <span class="s1">(np.zeros(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.zeros(</span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(np.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">):</span>

            <span class="s1">df = DataFrame(</span>
                <span class="s1">{</span>
                    <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">,</span>
                    <span class="s2">&quot;C&quot;</span><span class="s1">: c</span><span class="s0">,</span>
                    <span class="s2">&quot;D&quot;</span><span class="s1">: d</span><span class="s0">,</span>
                    <span class="s2">&quot;B&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span>
            <span class="s1">)</span>

            <span class="s1">right = df.iloc[:</span><span class="s3">3</span><span class="s1">].copy(deep=</span><span class="s0">True</span><span class="s1">)</span>

            <span class="s1">df = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">])</span>
            <span class="s1">df[</span><span class="s2">&quot;D&quot;</span><span class="s1">] = df[</span><span class="s2">&quot;D&quot;</span><span class="s1">].astype(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span>

            <span class="s1">left = df.iloc[:</span><span class="s3">3</span><span class="s1">].unstack(</span><span class="s3">0</span><span class="s1">)</span>
            <span class="s1">right = right.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]).unstack(</span><span class="s3">0</span><span class="s1">)</span>
            <span class="s1">right[(</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)] = right[(</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)].astype(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span>

            <span class="s0">assert </span><span class="s1">left.shape == (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">right)</span>

    <span class="s0">def </span><span class="s1">test_unstack_non_unique_index_names(self):</span>
        <span class="s1">idx = MultiIndex.from_tuples([(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s2">&quot;c1&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">msg = </span><span class="s2">&quot;The name c1 occurs multiple times, use a level number&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.unstack(</span><span class="s2">&quot;c1&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.T.stack(</span><span class="s2">&quot;c1&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unstack_unused_levels(self):</span>
        <span class="s4"># GH 17845: unused codes in index make unstack() cast int to float</span>
        <span class="s1">idx = MultiIndex.from_product([[</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s1">]])[:-</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">df = DataFrame([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]] * </span><span class="s3">3</span><span class="s0">, </span><span class="s1">index=idx)</span>

        <span class="s1">result = df.unstack()</span>
        <span class="s1">exp_col = MultiIndex.from_product([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]])</span>
        <span class="s1">expected = DataFrame([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=exp_col)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">(result.columns.levels[</span><span class="s3">1</span><span class="s1">] == idx.levels[</span><span class="s3">1</span><span class="s1">]).all()</span>

        <span class="s4"># Unused items on both levels</span>
        <span class="s1">levels = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">codes = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span>
        <span class="s1">idx = MultiIndex(levels</span><span class="s0">, </span><span class="s1">codes)</span>
        <span class="s1">block = np.arange(</span><span class="s3">4</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(np.concatenate([block</span><span class="s0">, </span><span class="s1">block + </span><span class="s3">4</span><span class="s1">])</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">result = df.unstack()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.concatenate([block * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">block * </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=idx</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">(result.columns.levels[</span><span class="s3">1</span><span class="s1">] == idx.levels[</span><span class="s3">1</span><span class="s1">]).all()</span>

        <span class="s4"># With mixed dtype and NaN</span>
        <span class="s1">levels = [[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">codes = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span>
        <span class="s1">idx = MultiIndex(levels</span><span class="s0">, </span><span class="s1">codes)</span>
        <span class="s1">data = np.arange(</span><span class="s3">8</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(data.reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=idx)</span>

        <span class="s1">cases = (</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s3">13</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">16</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">level</span><span class="s0">, </span><span class="s1">idces</span><span class="s0">, </span><span class="s1">col_level</span><span class="s0">, </span><span class="s1">idx_level </span><span class="s0">in </span><span class="s1">cases:</span>
            <span class="s1">result = df.unstack(level=level)</span>
            <span class="s1">exp_data = np.zeros(</span><span class="s3">18</span><span class="s1">) * np.nan</span>
            <span class="s1">exp_data[idces] = data</span>
            <span class="s1">cols = MultiIndex.from_product([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">col_level])</span>
            <span class="s1">expected = DataFrame(exp_data.reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=idx_level</span><span class="s0">, </span><span class="s1">columns=cols)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;cols&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)])</span>
    <span class="s0">def </span><span class="s1">test_unstack_unused_level(self</span><span class="s0">, </span><span class="s1">cols):</span>
        <span class="s4"># GH 18562 : unused codes on the unstacked level</span>
        <span class="s1">df = DataFrame([[</span><span class="s3">2010</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;I&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2011</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;II&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">])</span>

        <span class="s1">ind = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">drop=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">selection = ind.loc[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;I&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">cols]</span>
        <span class="s1">result = selection.unstack()</span>

        <span class="s1">expected = ind.iloc[[</span><span class="s3">0</span><span class="s1">]][cols]</span>
        <span class="s1">expected.columns = MultiIndex.from_product(</span>
            <span class="s1">[expected.columns</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;I&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected.index = expected.index.droplevel(</span><span class="s2">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_long_index(self):</span>
        <span class="s4"># PH 32624: Error when using a lot of indices to unstack.</span>
        <span class="s4"># The error occurred only, if a lot of indices are used.</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples([[</span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;c1&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_tuples(</span>
                <span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s2">&quot;i1&quot;</span><span class="s0">, </span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s2">&quot;i3&quot;</span><span class="s0">, </span><span class="s2">&quot;i4&quot;</span><span class="s0">, </span><span class="s2">&quot;i5&quot;</span><span class="s0">, </span><span class="s2">&quot;i6&quot;</span><span class="s0">, </span><span class="s2">&quot;i7&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df.unstack([</span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s2">&quot;i3&quot;</span><span class="s0">, </span><span class="s2">&quot;i4&quot;</span><span class="s0">, </span><span class="s2">&quot;i5&quot;</span><span class="s0">, </span><span class="s2">&quot;i6&quot;</span><span class="s0">, </span><span class="s2">&quot;i7&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s2">&quot;i3&quot;</span><span class="s0">, </span><span class="s2">&quot;i4&quot;</span><span class="s0">, </span><span class="s2">&quot;i5&quot;</span><span class="s0">, </span><span class="s2">&quot;i6&quot;</span><span class="s0">, </span><span class="s2">&quot;i7&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;i1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_multi_level_cols(self):</span>
        <span class="s4"># PH 24729: Unstack a df with multi level columns</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s2">&quot;c2&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_tuples(</span>
                <span class="s1">[[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">40</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;i1&quot;</span><span class="s0">, </span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s2">&quot;i3&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.unstack([</span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s2">&quot;i1&quot;</span><span class="s1">]).columns.names[-</span><span class="s3">2</span><span class="s1">:] == [</span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s2">&quot;i1&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_unstack_multi_level_rows_and_cols(self):</span>
        <span class="s4"># PH 28306: Unstack df with multi level cols and rows</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples([[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;f&quot;</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_tuples(</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s2">&quot;m1&quot;</span><span class="s0">, </span><span class="s2">&quot;P3&quot;</span><span class="s0">, </span><span class="s3">222</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">&quot;m1&quot;</span><span class="s0">, </span><span class="s2">&quot;A5&quot;</span><span class="s0">, </span><span class="s3">111</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">&quot;m2&quot;</span><span class="s0">, </span><span class="s2">&quot;P3&quot;</span><span class="s0">, </span><span class="s3">222</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">&quot;m2&quot;</span><span class="s0">, </span><span class="s2">&quot;A5&quot;</span><span class="s0">, </span><span class="s3">111</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s2">&quot;i1&quot;</span><span class="s0">, </span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s2">&quot;i3&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df.unstack([</span><span class="s2">&quot;i3&quot;</span><span class="s0">, </span><span class="s2">&quot;i2&quot;</span><span class="s1">])</span>
        <span class="s1">expected = df.unstack([</span><span class="s2">&quot;i3&quot;</span><span class="s1">]).unstack([</span><span class="s2">&quot;i2&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;idx&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;jim&quot;</span><span class="s0">, </span><span class="s2">&quot;joe&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;joe&quot;</span><span class="s0">, </span><span class="s2">&quot;jim&quot;</span><span class="s1">)])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;lev&quot;</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s0">def </span><span class="s1">test_unstack_nan_index1(self</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">lev):</span>
        <span class="s4"># GH7466</span>
        <span class="s0">def </span><span class="s1">cast(val):</span>
            <span class="s1">val_str = </span><span class="s2">&quot;&quot; </span><span class="s0">if </span><span class="s1">val != val </span><span class="s0">else </span><span class="s1">val</span>
            <span class="s0">return </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">val_str</span><span class="s0">:</span><span class="s2">1</span><span class="s0">}</span><span class="s2">&quot;</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;jim&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;joe&quot;</span><span class="s1">: [</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;jolie&quot;</span><span class="s1">: [</span><span class="s2">&quot;a.w&quot;</span><span class="s0">, </span><span class="s2">&quot;b.x&quot;</span><span class="s0">, </span><span class="s2">&quot; .y&quot;</span><span class="s0">, </span><span class="s2">&quot;d.z&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">left = df.set_index([</span><span class="s2">&quot;jim&quot;</span><span class="s0">, </span><span class="s2">&quot;joe&quot;</span><span class="s1">]).unstack()[</span><span class="s2">&quot;jolie&quot;</span><span class="s1">]</span>
        <span class="s1">right = df.set_index([</span><span class="s2">&quot;joe&quot;</span><span class="s0">, </span><span class="s2">&quot;jim&quot;</span><span class="s1">]).unstack()[</span><span class="s2">&quot;jolie&quot;</span><span class="s1">].T</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">right)</span>

        <span class="s1">mi = df.set_index(list(idx))</span>
        <span class="s1">udf = mi.unstack(level=lev)</span>
        <span class="s0">assert </span><span class="s1">udf.notna().values.sum() == len(df)</span>
        <span class="s1">mk_list = </span><span class="s0">lambda </span><span class="s1">a: list(a) </span><span class="s0">if </span><span class="s1">isinstance(a</span><span class="s0">, </span><span class="s1">tuple) </span><span class="s0">else </span><span class="s1">[a]</span>
        <span class="s1">rows</span><span class="s0">, </span><span class="s1">cols = udf[</span><span class="s2">&quot;jolie&quot;</span><span class="s1">].notna().values.nonzero()</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">zip(rows</span><span class="s0">, </span><span class="s1">cols):</span>
            <span class="s1">left = sorted(udf[</span><span class="s2">&quot;jolie&quot;</span><span class="s1">].iloc[i</span><span class="s0">, </span><span class="s1">j].split(</span><span class="s2">&quot;.&quot;</span><span class="s1">))</span>
            <span class="s1">right = mk_list(udf[</span><span class="s2">&quot;jolie&quot;</span><span class="s1">].index[i]) + mk_list(udf[</span><span class="s2">&quot;jolie&quot;</span><span class="s1">].columns[j])</span>
            <span class="s1">right = sorted(map(cast</span><span class="s0">, </span><span class="s1">right))</span>
            <span class="s0">assert </span><span class="s1">left == right</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;idx&quot;</span><span class="s0">, </span><span class="s1">itertools.permutations([</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s0">, </span><span class="s2">&quot;3rd&quot;</span><span class="s1">]))</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;lev&quot;</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s3">3</span><span class="s1">)))</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;4th&quot;</span><span class="s0">, </span><span class="s2">&quot;5th&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_unstack_nan_index_repeats(self</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">lev</span><span class="s0">, </span><span class="s1">col):</span>
        <span class="s0">def </span><span class="s1">cast(val):</span>
            <span class="s1">val_str = </span><span class="s2">&quot;&quot; </span><span class="s0">if </span><span class="s1">val != val </span><span class="s0">else </span><span class="s1">val</span>
            <span class="s0">return </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">val_str</span><span class="s0">:</span><span class="s2">1</span><span class="s0">}</span><span class="s2">&quot;</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;1st&quot;</span><span class="s1">: [</span><span class="s2">&quot;d&quot;</span><span class="s1">] * </span><span class="s3">3</span>
                <span class="s1">+ [np.nan] * </span><span class="s3">5</span>
                <span class="s1">+ [</span><span class="s2">&quot;a&quot;</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s2">&quot;c&quot;</span><span class="s1">] * </span><span class="s3">3</span>
                <span class="s1">+ [</span><span class="s2">&quot;e&quot;</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s2">&quot;b&quot;</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">,</span>
                <span class="s2">&quot;2nd&quot;</span><span class="s1">: [</span><span class="s2">&quot;y&quot;</span><span class="s1">] * </span><span class="s3">2</span>
                <span class="s1">+ [</span><span class="s2">&quot;w&quot;</span><span class="s1">] * </span><span class="s3">3</span>
                <span class="s1">+ [np.nan] * </span><span class="s3">3</span>
                <span class="s1">+ [</span><span class="s2">&quot;z&quot;</span><span class="s1">] * </span><span class="s3">4</span>
                <span class="s1">+ [np.nan] * </span><span class="s3">3</span>
                <span class="s1">+ [</span><span class="s2">&quot;x&quot;</span><span class="s1">] * </span><span class="s3">3</span>
                <span class="s1">+ [np.nan] * </span><span class="s3">2</span><span class="s0">,</span>
                <span class="s2">&quot;3rd&quot;</span><span class="s1">: [</span>
                    <span class="s3">67</span><span class="s0">,</span>
                    <span class="s3">39</span><span class="s0">,</span>
                    <span class="s3">53</span><span class="s0">,</span>
                    <span class="s3">72</span><span class="s0">,</span>
                    <span class="s3">57</span><span class="s0">,</span>
                    <span class="s3">80</span><span class="s0">,</span>
                    <span class="s3">31</span><span class="s0">,</span>
                    <span class="s3">18</span><span class="s0">,</span>
                    <span class="s3">11</span><span class="s0">,</span>
                    <span class="s3">30</span><span class="s0">,</span>
                    <span class="s3">59</span><span class="s0">,</span>
                    <span class="s3">50</span><span class="s0">,</span>
                    <span class="s3">62</span><span class="s0">,</span>
                    <span class="s3">59</span><span class="s0">,</span>
                    <span class="s3">76</span><span class="s0">,</span>
                    <span class="s3">52</span><span class="s0">,</span>
                    <span class="s3">14</span><span class="s0">,</span>
                    <span class="s3">53</span><span class="s0">,</span>
                    <span class="s3">60</span><span class="s0">,</span>
                    <span class="s3">51</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df[</span><span class="s2">&quot;4th&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df[</span><span class="s2">&quot;5th&quot;</span><span class="s1">] = (</span>
            <span class="s1">df.apply(</span><span class="s0">lambda </span><span class="s1">r: </span><span class="s2">&quot;.&quot;</span><span class="s1">.join(map(cast</span><span class="s0">, </span><span class="s1">r))</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">df.apply(</span><span class="s0">lambda </span><span class="s1">r: </span><span class="s2">&quot;.&quot;</span><span class="s1">.join(map(cast</span><span class="s0">, </span><span class="s1">r.iloc[::-</span><span class="s3">1</span><span class="s1">]))</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">mi = df.set_index(list(idx))</span>
        <span class="s1">udf = mi.unstack(level=lev)</span>
        <span class="s0">assert </span><span class="s1">udf.notna().values.sum() == </span><span class="s3">2 </span><span class="s1">* len(df)</span>
        <span class="s1">mk_list = </span><span class="s0">lambda </span><span class="s1">a: list(a) </span><span class="s0">if </span><span class="s1">isinstance(a</span><span class="s0">, </span><span class="s1">tuple) </span><span class="s0">else </span><span class="s1">[a]</span>
        <span class="s1">rows</span><span class="s0">, </span><span class="s1">cols = udf[col].notna().values.nonzero()</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">zip(rows</span><span class="s0">, </span><span class="s1">cols):</span>
            <span class="s1">left = sorted(udf[col].iloc[i</span><span class="s0">, </span><span class="s1">j].split(</span><span class="s2">&quot;.&quot;</span><span class="s1">))</span>
            <span class="s1">right = mk_list(udf[col].index[i]) + mk_list(udf[col].columns[j])</span>
            <span class="s1">right = sorted(map(cast</span><span class="s0">, </span><span class="s1">right))</span>
            <span class="s0">assert </span><span class="s1">left == right</span>

    <span class="s0">def </span><span class="s1">test_unstack_nan_index2(self):</span>
        <span class="s4"># GH7403</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aaaabbbb&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: range(</span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: range(</span><span class="s3">8</span><span class="s1">)})</span>
        <span class="s1">df.iloc[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = np.NaN</span>
        <span class="s1">left = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]).unstack(</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">vals = [</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">vals = list(map(list</span><span class="s0">, </span><span class="s1">zip(*vals)))</span>
        <span class="s1">idx = Index([np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">cols = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s1">right = DataFrame(vals</span><span class="s0">, </span><span class="s1">columns=cols</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">right)</span>

        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aaaabbbb&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: list(range(</span><span class="s3">4</span><span class="s1">)) * </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: range(</span><span class="s3">8</span><span class="s1">)})</span>
        <span class="s1">df.iloc[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = np.NaN</span>
        <span class="s1">left = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]).unstack(</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">vals = [[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">cols = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">idx = Index([np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">right = DataFrame(vals</span><span class="s0">, </span><span class="s1">columns=cols</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">right)</span>

        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aaaabbbb&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: list(range(</span><span class="s3">4</span><span class="s1">)) * </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: range(</span><span class="s3">8</span><span class="s1">)})</span>
        <span class="s1">df.iloc[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = np.NaN</span>
        <span class="s1">left = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]).unstack(</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">vals = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">cols = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">idx = Index([np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">right = DataFrame(vals</span><span class="s0">, </span><span class="s1">columns=cols</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">right)</span>

    <span class="s0">def </span><span class="s1">test_unstack_nan_index3(self</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
        <span class="s4"># GH7401</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;A&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aaaaabbbbb&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;B&quot;</span><span class="s1">: (date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">).tolist() * </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;C&quot;</span><span class="s1">: np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df.iloc[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = np.NaN</span>
        <span class="s1">left = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]).unstack()</span>

        <span class="s1">vals = np.array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]])</span>
        <span class="s1">idx = Index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">cols = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">right = DataFrame(vals</span><span class="s0">, </span><span class="s1">columns=cols</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s0">if </span><span class="s1">using_array_manager:</span>
            <span class="s4"># INFO(ArrayManager) with ArrayManager preserve dtype where possible</span>
            <span class="s1">cols = right.columns[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span>
            <span class="s1">right[cols] = right[cols].astype(df[</span><span class="s2">&quot;C&quot;</span><span class="s1">].dtype)</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">right)</span>

    <span class="s0">def </span><span class="s1">test_unstack_nan_index4(self):</span>
        <span class="s4"># GH4862</span>
        <span class="s1">vals = [</span>
            <span class="s1">[</span><span class="s2">&quot;Hg&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">680585148</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">&quot;U&quot;</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">680585148</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">&quot;Pb&quot;</span><span class="s0">, </span><span class="s3">7.07e-06</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">680585148</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">&quot;Sn&quot;</span><span class="s0">, </span><span class="s3">2.3614e-05</span><span class="s0">, </span><span class="s3">0.0133</span><span class="s0">, </span><span class="s3">680607017</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">&quot;Ag&quot;</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0133</span><span class="s0">, </span><span class="s3">680607017</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">&quot;Hg&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00015</span><span class="s0">, </span><span class="s3">0.0133</span><span class="s0">, </span><span class="s3">680607017</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">vals</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;agent&quot;</span><span class="s0">, </span><span class="s2">&quot;change&quot;</span><span class="s0">, </span><span class="s2">&quot;dosage&quot;</span><span class="s0">, </span><span class="s2">&quot;s_id&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">17263</span><span class="s0">, </span><span class="s3">17264</span><span class="s0">, </span><span class="s3">17265</span><span class="s0">, </span><span class="s3">17266</span><span class="s0">, </span><span class="s3">17267</span><span class="s0">, </span><span class="s3">17268</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">left = df.copy().set_index([</span><span class="s2">&quot;s_id&quot;</span><span class="s0">, </span><span class="s2">&quot;dosage&quot;</span><span class="s0">, </span><span class="s2">&quot;agent&quot;</span><span class="s1">]).unstack()</span>

        <span class="s1">vals = [</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">7.07e-06</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00015</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">2.3614e-05</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
        <span class="s1">]</span>

        <span class="s1">idx = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s3">680585148</span><span class="s0">, </span><span class="s3">680607017</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0133</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;s_id&quot;</span><span class="s0">, </span><span class="s2">&quot;dosage&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">cols = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;change&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;Ag&quot;</span><span class="s0">, </span><span class="s2">&quot;Hg&quot;</span><span class="s0">, </span><span class="s2">&quot;Pb&quot;</span><span class="s0">, </span><span class="s2">&quot;Sn&quot;</span><span class="s0">, </span><span class="s2">&quot;U&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;agent&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">right = DataFrame(vals</span><span class="s0">, </span><span class="s1">columns=cols</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">right)</span>

        <span class="s1">left = df.loc[</span><span class="s3">17264</span><span class="s1">:].copy().set_index([</span><span class="s2">&quot;s_id&quot;</span><span class="s0">, </span><span class="s2">&quot;dosage&quot;</span><span class="s0">, </span><span class="s2">&quot;agent&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(left.unstack()</span><span class="s0">, </span><span class="s1">right)</span>

    <span class="s0">def </span><span class="s1">test_unstack_nan_index5(self):</span>
        <span class="s4"># GH9497 - multiple unstack with nulls</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;1st&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;2nd&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;2014-02-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">6</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;jim&quot;</span><span class="s1">: </span><span class="s3">100 </span><span class="s1">+ np.arange(</span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;joe&quot;</span><span class="s1">: (np.random.randn(</span><span class="s3">6</span><span class="s1">) * </span><span class="s3">10</span><span class="s1">).round(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df[</span><span class="s2">&quot;3rd&quot;</span><span class="s1">] = df[</span><span class="s2">&quot;2nd&quot;</span><span class="s1">] - pd.Timestamp(</span><span class="s2">&quot;2014-02-02&quot;</span><span class="s1">)</span>
        <span class="s1">df.loc[</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s1">] = df.loc[</span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s1">] = np.nan</span>
        <span class="s1">df.loc[</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;3rd&quot;</span><span class="s1">] = df.loc[</span><span class="s3">4</span><span class="s0">, </span><span class="s2">&quot;3rd&quot;</span><span class="s1">] = np.nan</span>

        <span class="s1">left = df.set_index([</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s0">, </span><span class="s2">&quot;3rd&quot;</span><span class="s1">]).unstack([</span><span class="s2">&quot;2nd&quot;</span><span class="s0">, </span><span class="s2">&quot;3rd&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">left.notna().values.sum() == </span><span class="s3">2 </span><span class="s1">* len(df)</span>

        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;jim&quot;</span><span class="s0">, </span><span class="s2">&quot;joe&quot;</span><span class="s1">]:</span>
            <span class="s0">for </span><span class="s1">_</span><span class="s0">, </span><span class="s1">r </span><span class="s0">in </span><span class="s1">df.iterrows():</span>
                <span class="s1">key = r[</span><span class="s2">&quot;1st&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(col</span><span class="s0">, </span><span class="s1">r[</span><span class="s2">&quot;2nd&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">r[</span><span class="s2">&quot;3rd&quot;</span><span class="s1">])</span>
                <span class="s0">assert </span><span class="s1">r[col] == left.loc[key]</span>

    <span class="s0">def </span><span class="s1">test_stack_datetime_column_multiIndex(self):</span>
        <span class="s4"># GH 8039</span>
        <span class="s1">t = datetime(</span><span class="s3">2014</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">df = DataFrame([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=MultiIndex.from_tuples([(t</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)]))</span>
        <span class="s1">result = df.stack()</span>

        <span class="s1">eidx = MultiIndex.from_product([(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">,</span><span class="s1">)])</span>
        <span class="s1">ecols = MultiIndex.from_tuples([(t</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)])</span>
        <span class="s1">expected = DataFrame([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=eidx</span><span class="s0">, </span><span class="s1">columns=ecols)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_partial_multiIndex(self):</span>
        <span class="s4"># GH 8844</span>
        <span class="s0">def </span><span class="s1">_test_stack_with_multiindex(multiindex):</span>
            <span class="s1">df = DataFrame(</span>
                <span class="s1">np.arange(</span><span class="s3">3 </span><span class="s1">* len(multiindex)).reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">len(multiindex))</span><span class="s0">,</span>
                <span class="s1">columns=multiindex</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s0">for </span><span class="s1">level </span><span class="s0">in </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]):</span>
                <span class="s1">result = df.stack(level=level</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>

                <span class="s0">if </span><span class="s1">isinstance(level</span><span class="s0">, </span><span class="s1">int):</span>
                    <span class="s4"># Stacking a single level should not make any all-NaN rows,</span>
                    <span class="s4"># so df.stack(level=level, dropna=False) should be the same</span>
                    <span class="s4"># as df.stack(level=level, dropna=True).</span>
                    <span class="s1">expected = df.stack(level=level</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">True</span><span class="s1">)</span>
                    <span class="s0">if </span><span class="s1">isinstance(expected</span><span class="s0">, </span><span class="s1">Series):</span>
                        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
                    <span class="s0">else</span><span class="s1">:</span>
                        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

                <span class="s1">df.columns = MultiIndex.from_tuples(</span>
                    <span class="s1">df.columns.to_numpy()</span><span class="s0">, </span><span class="s1">names=df.columns.names</span>
                <span class="s1">)</span>
                <span class="s1">expected = df.stack(level=level</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
                <span class="s0">if </span><span class="s1">isinstance(expected</span><span class="s0">, </span><span class="s1">Series):</span>
                    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">full_multiindex = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;u&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;Upper&quot;</span><span class="s0">, </span><span class="s2">&quot;Lower&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">multiindex_columns </span><span class="s0">in </span><span class="s1">(</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">):</span>
            <span class="s1">_test_stack_with_multiindex(full_multiindex[multiindex_columns])</span>
            <span class="s0">if </span><span class="s1">len(multiindex_columns) &gt; </span><span class="s3">1</span><span class="s1">:</span>
                <span class="s1">multiindex_columns.reverse()</span>
                <span class="s1">_test_stack_with_multiindex(full_multiindex[multiindex_columns])</span>

        <span class="s1">df = DataFrame(np.arange(</span><span class="s3">6</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=full_multiindex[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
        <span class="s1">result = df.stack(dropna=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex(</span>
                <span class="s1">levels=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;u&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;Lower&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;Upper&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected[</span><span class="s2">&quot;B&quot;</span><span class="s1">] = expected[</span><span class="s2">&quot;B&quot;</span><span class="s1">].astype(df.dtypes[</span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;ordered&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;labels&quot;</span><span class="s0">, </span><span class="s1">[list(</span><span class="s2">&quot;yxz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(</span><span class="s2">&quot;yxy&quot;</span><span class="s1">)])</span>
    <span class="s0">def </span><span class="s1">test_stack_preserve_categorical_dtype(self</span><span class="s0">, </span><span class="s1">ordered</span><span class="s0">, </span><span class="s1">labels):</span>
        <span class="s4"># GH13854</span>
        <span class="s1">cidx = pd.CategoricalIndex(labels</span><span class="s0">, </span><span class="s1">categories=list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ordered=ordered)</span>
        <span class="s1">df = DataFrame([[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=cidx)</span>
        <span class="s1">result = df.stack()</span>

        <span class="s4"># `MultiIndex.from_product` preserves categorical dtype -</span>
        <span class="s4"># it's tested elsewhere.</span>
        <span class="s1">midx = MultiIndex.from_product([df.index</span><span class="s0">, </span><span class="s1">cidx])</span>
        <span class="s1">expected = Series([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=midx)</span>

        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;ordered&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;labels,data&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(list(</span><span class="s2">&quot;zyx&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_stack_multi_preserve_categorical_dtype(self</span><span class="s0">, </span><span class="s1">ordered</span><span class="s0">, </span><span class="s1">labels</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s4"># GH-36991</span>
        <span class="s1">cidx = pd.CategoricalIndex(labels</span><span class="s0">, </span><span class="s1">categories=sorted(labels)</span><span class="s0">, </span><span class="s1">ordered=ordered)</span>
        <span class="s1">cidx2 = pd.CategoricalIndex([</span><span class="s2">&quot;u&quot;</span><span class="s0">, </span><span class="s2">&quot;v&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=ordered)</span>
        <span class="s1">midx = MultiIndex.from_product([cidx</span><span class="s0">, </span><span class="s1">cidx2])</span>
        <span class="s1">df = DataFrame([sorted(data)]</span><span class="s0">, </span><span class="s1">columns=midx)</span>
        <span class="s1">result = df.stack([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

        <span class="s1">s_cidx = pd.CategoricalIndex(sorted(labels)</span><span class="s0">, </span><span class="s1">ordered=ordered)</span>
        <span class="s1">expected = Series(data</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_product([[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">s_cidx</span><span class="s0">, </span><span class="s1">cidx2]))</span>

        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_preserve_categorical_dtype_values(self):</span>
        <span class="s4"># GH-23077</span>
        <span class="s1">cat = pd.Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: cat</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: cat})</span>
        <span class="s1">result = df.stack()</span>
        <span class="s1">index = MultiIndex.from_product([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]])</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">pd.Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">index=index</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;index, columns&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">MultiIndex.from_product([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]))</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">MultiIndex.from_product([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]))</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">MultiIndex.from_product([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]]))</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_stack_multi_columns_non_unique_index(self</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">columns):</span>
        <span class="s4"># GH-28301</span>
        <span class="s1">df = DataFrame(index=index</span><span class="s0">, </span><span class="s1">columns=columns).fillna(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">stacked = df.stack()</span>
        <span class="s1">new_index = MultiIndex.from_tuples(stacked.index.to_numpy())</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">stacked.to_numpy()</span><span class="s0">, </span><span class="s1">index=new_index</span><span class="s0">, </span><span class="s1">columns=stacked.columns</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(stacked</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">stacked_codes = np.asarray(stacked.index.codes)</span>
        <span class="s1">expected_codes = np.asarray(new_index.codes)</span>
        <span class="s1">tm.assert_numpy_array_equal(stacked_codes</span><span class="s0">, </span><span class="s1">expected_codes)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;level&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_unstack_mixed_extension_types(self</span><span class="s0">, </span><span class="s1">level):</span>
        <span class="s1">index = MultiIndex.from_tuples([(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;A&quot;</span><span class="s1">: pd.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;B&quot;</span><span class="s1">: pd.Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=index</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = df.unstack(level=level)</span>
        <span class="s1">expected = df.astype(object).unstack(level=level)</span>

        <span class="s1">expected_dtypes = Series(</span>
            <span class="s1">[df.A.dtype] * </span><span class="s3">2 </span><span class="s1">+ [df.B.dtype] * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">index=result.columns</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result.dtypes</span><span class="s0">, </span><span class="s1">expected_dtypes)</span>
        <span class="s1">tm.assert_frame_equal(result.astype(object)</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;level&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;baz&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_unstack_swaplevel_sortlevel(self</span><span class="s0">, </span><span class="s1">level):</span>
        <span class="s4"># GH 20994</span>
        <span class="s1">mi = MultiIndex.from_product([[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">&quot;baz&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=mi</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s1">df.columns.name = </span><span class="s2">&quot;foo&quot;</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;baz&quot;</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.index.name = </span><span class="s2">&quot;bar&quot;</span>

        <span class="s1">result = df.unstack().swaplevel(axis=</span><span class="s3">1</span><span class="s1">).sort_index(axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">level=level)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_unstack_fill_frame_object():</span>
    <span class="s4"># GH12815 Test unstacking with object.</span>
    <span class="s1">data = Series([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;object&quot;</span><span class="s1">)</span>
    <span class="s1">data.index = MultiIndex.from_tuples(</span>
        <span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)]</span>
    <span class="s1">)</span>

    <span class="s4"># By default missing values will be NaN</span>
    <span class="s1">result = data.unstack()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s1">np.nan]}</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># Fill with any value replaces missing values as expected</span>
    <span class="s1">result = data.unstack(fill_value=</span><span class="s2">&quot;d&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s2">&quot;xyz&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_unstack_timezone_aware_values():</span>
    <span class="s4"># GH 18338</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="s1">: [pd.Timestamp(</span><span class="s2">&quot;2017-08-27 01:00:00.709949+0000&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;timestamp&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.set_index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]).unstack()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[pd.Timestamp(</span><span class="s2">&quot;2017-08-27 01:00:00.709949+0000&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=Index([</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;timestamp&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;b&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_stack_timezone_aware_values():</span>
    <span class="s4"># GH 19420</span>
    <span class="s1">ts = date_range(freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">start=</span><span class="s2">&quot;20180101&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;20180103&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;America/New_York&quot;</span><span class="s1">)</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: ts}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.stack()</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">ts</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex(levels=[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dropna&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_stack_empty_frame(dropna):</span>
    <span class="s4"># GH 36113</span>
    <span class="s1">expected = Series(index=MultiIndex([[]</span><span class="s0">, </span><span class="s1">[]]</span><span class="s0">, </span><span class="s1">[[]</span><span class="s0">, </span><span class="s1">[]])</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">result = DataFrame(dtype=np.float64).stack(dropna=dropna)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dropna&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_stack_unstack_empty_frame(dropna</span><span class="s0">, </span><span class="s1">fill_value):</span>
    <span class="s4"># GH 36113</span>
    <span class="s1">result = (</span>
        <span class="s1">DataFrame(dtype=np.int64).stack(dropna=dropna).unstack(fill_value=fill_value)</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(dtype=np.int64)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_unstack_single_index_series():</span>
    <span class="s4"># GH 36113</span>
    <span class="s1">msg = </span><span class="s2">r&quot;index must be a MultiIndex to unstack.*&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">Series(dtype=np.int64).unstack()</span>


<span class="s0">def </span><span class="s1">test_unstacking_multi_index_df():</span>
    <span class="s4"># see gh-30740</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;name&quot;</span><span class="s1">: [</span><span class="s2">&quot;Alice&quot;</span><span class="s0">, </span><span class="s2">&quot;Bob&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;score&quot;</span><span class="s1">: [</span><span class="s3">9.5</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;employed&quot;</span><span class="s1">: [</span><span class="s0">False, True</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;kids&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;gender&quot;</span><span class="s1">: [</span><span class="s2">&quot;female&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">df = df.set_index([</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;employed&quot;</span><span class="s0">, </span><span class="s2">&quot;kids&quot;</span><span class="s0">, </span><span class="s2">&quot;gender&quot;</span><span class="s1">])</span>
    <span class="s1">df = df.unstack([</span><span class="s2">&quot;gender&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">expected = df.unstack(</span><span class="s2">&quot;employed&quot;</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">0</span><span class="s1">).unstack(</span><span class="s2">&quot;kids&quot;</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">result = df.unstack([</span><span class="s2">&quot;employed&quot;</span><span class="s0">, </span><span class="s2">&quot;kids&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">9.5</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">8.0</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=Index([</span><span class="s2">&quot;Alice&quot;</span><span class="s0">, </span><span class="s2">&quot;Bob&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;name&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex.from_tuples(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;score&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, False, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;score&quot;</span><span class="s0">, </span><span class="s2">&quot;female&quot;</span><span class="s0">, True, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;score&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, False, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;score&quot;</span><span class="s0">, </span><span class="s2">&quot;male&quot;</span><span class="s0">, True, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;gender&quot;</span><span class="s0">, </span><span class="s2">&quot;employed&quot;</span><span class="s0">, </span><span class="s2">&quot;kids&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_stack_positional_level_duplicate_column_names():</span>
    <span class="s4"># https://github.com/pandas-dev/pandas/issues/36353</span>
    <span class="s1">columns = MultiIndex.from_product([(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">df = DataFrame([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=columns)</span>
    <span class="s1">result = df.stack(</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s1">new_columns = Index([</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">new_index = MultiIndex.from_tuples([(</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=new_index</span><span class="s0">, </span><span class="s1">columns=new_columns)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_unstack_non_slice_like_blocks(using_array_manager):</span>
    <span class="s4"># Case where the mgr_locs of a DataFrame's underlying blocks are not slice-like</span>

    <span class="s1">mi = MultiIndex.from_product([range(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]])</span>
    <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=mi)</span>
    <span class="s1">df[</span><span class="s3">1</span><span class="s1">] = df[</span><span class="s3">1</span><span class="s1">].astype(np.int64)</span>
    <span class="s0">if not </span><span class="s1">using_array_manager:</span>
        <span class="s0">assert </span><span class="s1">any(</span><span class="s0">not </span><span class="s1">x.mgr_locs.is_slice_like </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">df._mgr.blocks)</span>

    <span class="s1">res = df.unstack()</span>

    <span class="s1">expected = pd.concat([df[n].unstack() </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">keys=range(</span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">class </span><span class="s1">TestStackUnstackMultiLevel:</span>
    <span class="s0">def </span><span class="s1">test_unstack(self</span><span class="s0">, </span><span class="s1">multiindex_year_month_day_dataframe_random_data):</span>
        <span class="s4"># just check that it works for now</span>
        <span class="s1">ymd = multiindex_year_month_day_dataframe_random_data</span>

        <span class="s1">unstacked = ymd.unstack()</span>
        <span class="s1">unstacked.unstack()</span>

        <span class="s4"># test that ints work</span>
        <span class="s1">ymd.astype(int).unstack()</span>

        <span class="s4"># test that int32 work</span>
        <span class="s1">ymd.astype(np.int32).unstack()</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;result_rows,result_columns,index_product,expected_row&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None, None, </span><span class="s3">30.0</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, None, None, </span><span class="s3">30.0</span><span class="s0">, None</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">&quot;ix1&quot;</span><span class="s0">, </span><span class="s2">&quot;ix2&quot;</span><span class="s0">, </span><span class="s2">&quot;col1&quot;</span><span class="s0">, </span><span class="s2">&quot;col2&quot;</span><span class="s0">, </span><span class="s2">&quot;col3&quot;</span><span class="s0">, </span><span class="s2">&quot;col4&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">2</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">None, None, </span><span class="s3">30.0</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None, None, </span><span class="s3">30.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, None, None, </span><span class="s3">30.0</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">&quot;ix1&quot;</span><span class="s0">, </span><span class="s2">&quot;ix2&quot;</span><span class="s0">, </span><span class="s2">&quot;col1&quot;</span><span class="s0">, </span><span class="s2">&quot;col2&quot;</span><span class="s0">, </span><span class="s2">&quot;col3&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">2</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">None, None, </span><span class="s3">30.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None, None, </span><span class="s3">30.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, None, None, None, </span><span class="s3">30.0</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">&quot;ix1&quot;</span><span class="s0">, </span><span class="s2">&quot;ix2&quot;</span><span class="s0">, </span><span class="s2">&quot;col1&quot;</span><span class="s0">, </span><span class="s2">&quot;col2&quot;</span><span class="s0">, </span><span class="s2">&quot;col3&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s0">None,</span>
                <span class="s1">[</span><span class="s0">None, None, </span><span class="s3">30.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_unstack_partial(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">result_rows</span><span class="s0">, </span><span class="s1">result_columns</span><span class="s0">, </span><span class="s1">index_product</span><span class="s0">, </span><span class="s1">expected_row</span>
    <span class="s1">):</span>
        <span class="s4"># check for regressions on this issue:</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/19351</span>
        <span class="s4"># make sure DataFrame.unstack() works when its run on a subset of the DataFrame</span>
        <span class="s4"># and the Index levels contain values that are not present in the subset</span>
        <span class="s1">result = DataFrame(result_rows</span><span class="s0">, </span><span class="s1">columns=result_columns).set_index(</span>
            <span class="s1">[</span><span class="s2">&quot;ix1&quot;</span><span class="s0">, </span><span class="s2">&quot;ix2&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">result = result.iloc[</span><span class="s3">1</span><span class="s1">:</span><span class="s3">2</span><span class="s1">].unstack(</span><span class="s2">&quot;ix2&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[expected_row]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_product(</span>
                <span class="s1">[result_columns[</span><span class="s3">2</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">[index_product]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;ix2&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;ix1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_multiple_no_empty_columns(self):</span>
        <span class="s1">index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;qux&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s1">s = Series(np.random.randn(</span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>

        <span class="s1">unstacked = s.unstack([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">expected = unstacked.dropna(axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">how=</span><span class="s2">&quot;all&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(unstacked</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack(self</span><span class="s0">, </span><span class="s1">multiindex_year_month_day_dataframe_random_data):</span>
        <span class="s1">ymd = multiindex_year_month_day_dataframe_random_data</span>

        <span class="s4"># regular roundtrip</span>
        <span class="s1">unstacked = ymd.unstack()</span>
        <span class="s1">restacked = unstacked.stack()</span>
        <span class="s1">tm.assert_frame_equal(restacked</span><span class="s0">, </span><span class="s1">ymd)</span>

        <span class="s1">unlexsorted = ymd.sort_index(level=</span><span class="s3">2</span><span class="s1">)</span>

        <span class="s1">unstacked = unlexsorted.unstack(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">restacked = unstacked.stack()</span>
        <span class="s1">tm.assert_frame_equal(restacked.sort_index(level=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ymd)</span>

        <span class="s1">unlexsorted = unlexsorted[::-</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">unstacked = unlexsorted.unstack(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">restacked = unstacked.stack().swaplevel(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(restacked.sort_index(level=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ymd)</span>

        <span class="s1">unlexsorted = unlexsorted.swaplevel(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">unstacked = unlexsorted.unstack(</span><span class="s3">0</span><span class="s1">).swaplevel(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">restacked = unstacked.stack(</span><span class="s3">0</span><span class="s1">).swaplevel(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(restacked.sort_index(level=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ymd)</span>

        <span class="s4"># columns unsorted</span>
        <span class="s1">unstacked = ymd.unstack()</span>
        <span class="s1">unstacked = unstacked.sort_index(axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">ascending=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">restacked = unstacked.stack()</span>
        <span class="s1">tm.assert_frame_equal(restacked</span><span class="s0">, </span><span class="s1">ymd)</span>

        <span class="s4"># more than 2 levels in the columns</span>
        <span class="s1">unstacked = ymd.unstack(</span><span class="s3">1</span><span class="s1">).unstack(</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">result = unstacked.stack(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">expected = ymd.unstack()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = unstacked.stack(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">expected = ymd.unstack(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = unstacked.stack(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">expected = ymd.stack().unstack(</span><span class="s3">1</span><span class="s1">).unstack(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># not all levels present in each echelon</span>
        <span class="s1">unstacked = ymd.unstack(</span><span class="s3">2</span><span class="s1">).loc[:</span><span class="s0">, </span><span class="s1">::</span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">stacked = unstacked.stack().stack()</span>
        <span class="s1">ymd_stacked = ymd.stack()</span>
        <span class="s1">tm.assert_series_equal(stacked</span><span class="s0">, </span><span class="s1">ymd_stacked.reindex(stacked.index))</span>

        <span class="s4"># stack with negative number</span>
        <span class="s1">result = ymd.unstack(</span><span class="s3">0</span><span class="s1">).stack(-</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">expected = ymd.unstack(</span><span class="s3">0</span><span class="s1">).stack(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;idx, columns, exp_idx&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">list(</span><span class="s2">&quot;abab&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s0">, </span><span class="s2">&quot;3rd&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">MultiIndex(</span>
                    <span class="s1">levels=[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s0">, </span><span class="s2">&quot;3rd&quot;</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">codes=[</span>
                        <span class="s1">np.tile(np.arange(</span><span class="s3">2</span><span class="s1">).repeat(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.tile(np.arange(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">list(</span><span class="s2">&quot;abab&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s0">, </span><span class="s2">&quot;1st&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">MultiIndex(</span>
                    <span class="s1">levels=[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">codes=[np.tile(np.arange(</span><span class="s3">2</span><span class="s1">).repeat(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.tile([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">MultiIndex.from_tuples(((</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s0">, </span><span class="s2">&quot;1st&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">MultiIndex(</span>
                    <span class="s1">levels=[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;1st&quot;</span><span class="s0">, </span><span class="s2">&quot;2nd&quot;</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">codes=[</span>
                        <span class="s1">np.tile(np.arange(</span><span class="s3">2</span><span class="s1">).repeat(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.repeat([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                        <span class="s1">np.tile([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_stack_duplicate_index(self</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">columns</span><span class="s0">, </span><span class="s1">exp_idx):</span>
        <span class="s4"># GH10417</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s3">12</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=idx</span><span class="s0">,</span>
            <span class="s1">columns=columns</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df.stack()</span>
        <span class="s1">expected = Series(np.arange(</span><span class="s3">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=exp_idx)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">result.index.is_unique </span><span class="s0">is False</span>
        <span class="s1">li</span><span class="s0">, </span><span class="s1">ri = result.index</span><span class="s0">, </span><span class="s1">expected.index</span>
        <span class="s1">tm.assert_index_equal(li</span><span class="s0">, </span><span class="s1">ri)</span>

    <span class="s0">def </span><span class="s1">test_unstack_odd_failure(self):</span>
        <span class="s1">data = </span><span class="s2">&quot;&quot;&quot;day,time,smoker,sum,len 
Fri,Dinner,No,8.25,3. 
Fri,Dinner,Yes,27.03,9 
Fri,Lunch,No,3.0,1 
Fri,Lunch,Yes,13.68,6 
Sat,Dinner,No,139.63,45 
Sat,Dinner,Yes,120.77,42 
Sun,Dinner,No,180.57,57 
Sun,Dinner,Yes,66.82,19 
Thu,Dinner,No,3.0,1 
Thu,Lunch,No,117.32,44 
Thu,Lunch,Yes,51.51,17&quot;&quot;&quot;</span>

        <span class="s1">df = pd.read_csv(StringIO(data)).set_index([</span><span class="s2">&quot;day&quot;</span><span class="s0">, </span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;smoker&quot;</span><span class="s1">])</span>

        <span class="s4"># it works, #2100</span>
        <span class="s1">result = df.unstack(</span><span class="s3">2</span><span class="s1">)</span>

        <span class="s1">recons = result.stack()</span>
        <span class="s1">tm.assert_frame_equal(recons</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s0">def </span><span class="s1">test_stack_mixed_dtype(self</span><span class="s0">, </span><span class="s1">multiindex_dataframe_random_data):</span>
        <span class="s1">frame = multiindex_dataframe_random_data</span>

        <span class="s1">df = frame.T</span>
        <span class="s1">df[</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;four&quot;</span><span class="s1">] = </span><span class="s2">&quot;foo&quot;</span>
        <span class="s1">df = df.sort_index(level=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">stacked = df.stack()</span>
        <span class="s1">result = df[</span><span class="s2">&quot;foo&quot;</span><span class="s1">].stack().sort_index()</span>
        <span class="s1">tm.assert_series_equal(stacked[</span><span class="s2">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">result</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.name </span><span class="s0">is None</span>
        <span class="s0">assert </span><span class="s1">stacked[</span><span class="s2">&quot;bar&quot;</span><span class="s1">].dtype == np.float_</span>

    <span class="s0">def </span><span class="s1">test_unstack_bug(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;state&quot;</span><span class="s1">: [</span><span class="s2">&quot;naive&quot;</span><span class="s0">, </span><span class="s2">&quot;naive&quot;</span><span class="s0">, </span><span class="s2">&quot;naive&quot;</span><span class="s0">, </span><span class="s2">&quot;active&quot;</span><span class="s0">, </span><span class="s2">&quot;active&quot;</span><span class="s0">, </span><span class="s2">&quot;active&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;exp&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;barcode&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;v&quot;</span><span class="s1">: [</span><span class="s2">&quot;hi&quot;</span><span class="s0">, </span><span class="s2">&quot;hi&quot;</span><span class="s0">, </span><span class="s2">&quot;bye&quot;</span><span class="s0">, </span><span class="s2">&quot;bye&quot;</span><span class="s0">, </span><span class="s2">&quot;bye&quot;</span><span class="s0">, </span><span class="s2">&quot;peace&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;extra&quot;</span><span class="s1">: np.arange(</span><span class="s3">6.0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = df.groupby([</span><span class="s2">&quot;state&quot;</span><span class="s0">, </span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;barcode&quot;</span><span class="s0">, </span><span class="s2">&quot;v&quot;</span><span class="s1">]).apply(len)</span>

        <span class="s1">unstacked = result.unstack()</span>
        <span class="s1">restacked = unstacked.stack()</span>
        <span class="s1">tm.assert_series_equal(restacked</span><span class="s0">, </span><span class="s1">result.reindex(restacked.index).astype(float))</span>

    <span class="s0">def </span><span class="s1">test_stack_unstack_preserve_names(self</span><span class="s0">, </span><span class="s1">multiindex_dataframe_random_data):</span>
        <span class="s1">frame = multiindex_dataframe_random_data</span>

        <span class="s1">unstacked = frame.unstack()</span>
        <span class="s0">assert </span><span class="s1">unstacked.index.name == </span><span class="s2">&quot;first&quot;</span>
        <span class="s0">assert </span><span class="s1">unstacked.columns.names == [</span><span class="s2">&quot;exp&quot;</span><span class="s0">, </span><span class="s2">&quot;second&quot;</span><span class="s1">]</span>

        <span class="s1">restacked = unstacked.stack()</span>
        <span class="s0">assert </span><span class="s1">restacked.index.names == frame.index.names</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;stack&quot;</span><span class="s0">, </span><span class="s2">&quot;unstack&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_stack_unstack_wrong_level_name(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">multiindex_dataframe_random_data</span>
    <span class="s1">):</span>
        <span class="s4"># GH 18303 - wrong level name should raise</span>
        <span class="s1">frame = multiindex_dataframe_random_data</span>

        <span class="s4"># A DataFrame with flat axes:</span>
        <span class="s1">df = frame.loc[</span><span class="s2">&quot;foo&quot;</span><span class="s1">]</span>

        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;does not match index name&quot;</span><span class="s1">):</span>
            <span class="s1">getattr(df</span><span class="s0">, </span><span class="s1">method)(</span><span class="s2">&quot;mistake&quot;</span><span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method == </span><span class="s2">&quot;unstack&quot;</span><span class="s1">:</span>
            <span class="s4"># Same on a Series:</span>
            <span class="s1">s = df.iloc[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span>
            <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;does not match index name&quot;</span><span class="s1">):</span>
                <span class="s1">getattr(s</span><span class="s0">, </span><span class="s1">method)(</span><span class="s2">&quot;mistake&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unstack_level_name(self</span><span class="s0">, </span><span class="s1">multiindex_dataframe_random_data):</span>
        <span class="s1">frame = multiindex_dataframe_random_data</span>

        <span class="s1">result = frame.unstack(</span><span class="s2">&quot;second&quot;</span><span class="s1">)</span>
        <span class="s1">expected = frame.unstack(level=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_level_name(self</span><span class="s0">, </span><span class="s1">multiindex_dataframe_random_data):</span>
        <span class="s1">frame = multiindex_dataframe_random_data</span>

        <span class="s1">unstacked = frame.unstack(</span><span class="s2">&quot;second&quot;</span><span class="s1">)</span>
        <span class="s1">result = unstacked.stack(</span><span class="s2">&quot;exp&quot;</span><span class="s1">)</span>
        <span class="s1">expected = frame.unstack().stack(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = frame.stack(</span><span class="s2">&quot;exp&quot;</span><span class="s1">)</span>
        <span class="s1">expected = frame.stack()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_unstack_multiple(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">multiindex_year_month_day_dataframe_random_data</span>
    <span class="s1">):</span>
        <span class="s1">ymd = multiindex_year_month_day_dataframe_random_data</span>

        <span class="s1">unstacked = ymd.unstack([</span><span class="s2">&quot;year&quot;</span><span class="s0">, </span><span class="s2">&quot;month&quot;</span><span class="s1">])</span>
        <span class="s1">expected = ymd.unstack(</span><span class="s2">&quot;year&quot;</span><span class="s1">).unstack(</span><span class="s2">&quot;month&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(unstacked</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">unstacked.columns.names == expected.columns.names</span>

        <span class="s4"># series</span>
        <span class="s1">s = ymd[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">s_unstacked = s.unstack([</span><span class="s2">&quot;year&quot;</span><span class="s0">, </span><span class="s2">&quot;month&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(s_unstacked</span><span class="s0">, </span><span class="s1">expected[</span><span class="s2">&quot;A&quot;</span><span class="s1">])</span>

        <span class="s1">restacked = unstacked.stack([</span><span class="s2">&quot;year&quot;</span><span class="s0">, </span><span class="s2">&quot;month&quot;</span><span class="s1">])</span>
        <span class="s1">restacked = restacked.swaplevel(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">).swaplevel(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">restacked = restacked.sort_index(level=</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(restacked</span><span class="s0">, </span><span class="s1">ymd)</span>
        <span class="s0">assert </span><span class="s1">restacked.index.names == ymd.index.names</span>

        <span class="s4"># GH #451</span>
        <span class="s1">unstacked = ymd.unstack([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">expected = ymd.unstack(</span><span class="s3">1</span><span class="s1">).unstack(</span><span class="s3">1</span><span class="s1">).dropna(axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">how=</span><span class="s2">&quot;all&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(unstacked</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">unstacked = ymd.unstack([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">expected = ymd.unstack(</span><span class="s3">2</span><span class="s1">).unstack(</span><span class="s3">1</span><span class="s1">).dropna(axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">how=</span><span class="s2">&quot;all&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(unstacked</span><span class="s0">, </span><span class="s1">expected.loc[:</span><span class="s0">, </span><span class="s1">unstacked.columns])</span>

    <span class="s0">def </span><span class="s1">test_stack_names_and_numbers(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">multiindex_year_month_day_dataframe_random_data</span>
    <span class="s1">):</span>
        <span class="s1">ymd = multiindex_year_month_day_dataframe_random_data</span>

        <span class="s1">unstacked = ymd.unstack([</span><span class="s2">&quot;year&quot;</span><span class="s0">, </span><span class="s2">&quot;month&quot;</span><span class="s1">])</span>

        <span class="s4"># Can't use mixture of names and numbers to stack</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;level should contain&quot;</span><span class="s1">):</span>
            <span class="s1">unstacked.stack([</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;month&quot;</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_stack_multiple_out_of_bounds(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">multiindex_year_month_day_dataframe_random_data</span>
    <span class="s1">):</span>
        <span class="s4"># nlevels == 3</span>
        <span class="s1">ymd = multiindex_year_month_day_dataframe_random_data</span>

        <span class="s1">unstacked = ymd.unstack([</span><span class="s2">&quot;year&quot;</span><span class="s0">, </span><span class="s2">&quot;month&quot;</span><span class="s1">])</span>

        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Too many levels&quot;</span><span class="s1">):</span>
            <span class="s1">unstacked.stack([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;not a valid level number&quot;</span><span class="s1">):</span>
            <span class="s1">unstacked.stack([-</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_unstack_period_series(self):</span>
        <span class="s4"># GH4342</span>
        <span class="s1">idx1 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-03&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-03&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;period&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">idx2 = Index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">] * </span><span class="s3">3</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;str&quot;</span><span class="s1">)</span>
        <span class="s1">value = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span>

        <span class="s1">idx = MultiIndex.from_arrays([idx1</span><span class="s0">, </span><span class="s1">idx2])</span>
        <span class="s1">s = Series(value</span><span class="s0">, </span><span class="s1">index=idx)</span>

        <span class="s1">result1 = s.unstack()</span>
        <span class="s1">result2 = s.unstack(level=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">result3 = s.unstack(level=</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">e_idx = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-03&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;period&quot;</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=e_idx</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected.columns.name = </span><span class="s2">&quot;str&quot;</span>

        <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(result3</span><span class="s0">, </span><span class="s1">expected.T)</span>

        <span class="s1">idx1 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-03&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-03&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;period1&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">idx2 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-12&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-11&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-10&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-09&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-08&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-07&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;period2&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">idx = MultiIndex.from_arrays([idx1</span><span class="s0">, </span><span class="s1">idx2])</span>
        <span class="s1">s = Series(value</span><span class="s0">, </span><span class="s1">index=idx)</span>

        <span class="s1">result1 = s.unstack()</span>
        <span class="s1">result2 = s.unstack(level=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">result3 = s.unstack(level=</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">e_idx = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-03&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;period1&quot;</span>
        <span class="s1">)</span>
        <span class="s1">e_cols = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-07&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-08&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-09&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-10&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-11&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-12&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;period2&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=e_idx</span><span class="s0">,</span>
            <span class="s1">columns=e_cols</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(result3</span><span class="s0">, </span><span class="s1">expected.T)</span>

    <span class="s0">def </span><span class="s1">test_unstack_period_frame(self):</span>
        <span class="s4"># GH4342</span>
        <span class="s1">idx1 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2014-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-01&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;period1&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">idx2 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-12&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-12&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-10&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-10&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;period2&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">value = {</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span>
        <span class="s1">idx = MultiIndex.from_arrays([idx1</span><span class="s0">, </span><span class="s1">idx2])</span>
        <span class="s1">df = DataFrame(value</span><span class="s0">, </span><span class="s1">index=idx)</span>

        <span class="s1">result1 = df.unstack()</span>
        <span class="s1">result2 = df.unstack(level=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">result3 = df.unstack(level=</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">e_1 = pd.PeriodIndex([</span><span class="s2">&quot;2014-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;period1&quot;</span><span class="s1">)</span>
        <span class="s1">e_2 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-10&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-12&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-10&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-12&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;period2&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">e_cols = MultiIndex.from_arrays([</span><span class="s2">&quot;A A A B B B&quot;</span><span class="s1">.split()</span><span class="s0">, </span><span class="s1">e_2])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=e_1</span><span class="s0">, </span><span class="s1">columns=e_cols</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">e_1 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2014-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;period1&quot;</span>
        <span class="s1">)</span>
        <span class="s1">e_2 = pd.PeriodIndex(</span>
            <span class="s1">[</span><span class="s2">&quot;2013-10&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-12&quot;</span><span class="s0">, </span><span class="s2">&quot;2014-02&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;period2&quot;</span>
        <span class="s1">)</span>
        <span class="s1">e_cols = MultiIndex.from_arrays([</span><span class="s2">&quot;A A B B&quot;</span><span class="s1">.split()</span><span class="s0">, </span><span class="s1">e_1])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=e_2</span><span class="s0">, </span><span class="s1">columns=e_cols</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result3</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_multiple_bug(self):</span>
        <span class="s4"># bug when some uniques are not present in the data GH#3170</span>
        <span class="s1">id_col = ([</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">3</span><span class="s1">) + ([</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">name = ([</span><span class="s2">&quot;a&quot;</span><span class="s1">] * </span><span class="s3">3</span><span class="s1">) + ([</span><span class="s2">&quot;b&quot;</span><span class="s1">] * </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">date = pd.to_datetime([</span><span class="s2">&quot;2013-01-03&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-01-04&quot;</span><span class="s0">, </span><span class="s2">&quot;2013-01-05&quot;</span><span class="s1">] * </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">var1 = np.random.randint(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;ID&quot;</span><span class="s1">: id_col</span><span class="s0">, </span><span class="s2">&quot;NAME&quot;</span><span class="s1">: name</span><span class="s0">, </span><span class="s2">&quot;DATE&quot;</span><span class="s1">: date</span><span class="s0">, </span><span class="s2">&quot;VAR1&quot;</span><span class="s1">: var1})</span>

        <span class="s1">multi = df.set_index([</span><span class="s2">&quot;DATE&quot;</span><span class="s0">, </span><span class="s2">&quot;ID&quot;</span><span class="s1">])</span>
        <span class="s1">multi.columns.name = </span><span class="s2">&quot;Params&quot;</span>
        <span class="s1">unst = multi.unstack(</span><span class="s2">&quot;ID&quot;</span><span class="s1">)</span>
        <span class="s1">down = unst.resample(</span><span class="s2">&quot;W-THU&quot;</span><span class="s1">).mean()</span>

        <span class="s1">rs = down.stack(</span><span class="s2">&quot;ID&quot;</span><span class="s1">)</span>
        <span class="s1">xp = unst.loc[:</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;VAR1&quot;</span><span class="s1">]].resample(</span><span class="s2">&quot;W-THU&quot;</span><span class="s1">).mean().stack(</span><span class="s2">&quot;ID&quot;</span><span class="s1">)</span>
        <span class="s1">xp.columns.name = </span><span class="s2">&quot;Params&quot;</span>
        <span class="s1">tm.assert_frame_equal(rs</span><span class="s0">, </span><span class="s1">xp)</span>

    <span class="s0">def </span><span class="s1">test_stack_dropna(self):</span>
        <span class="s4"># GH#3997</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;a1&quot;</span><span class="s0">, </span><span class="s2">&quot;a2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s2">&quot;b2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]})</span>
        <span class="s1">df = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">])</span>

        <span class="s1">stacked = df.unstack().stack(dropna=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">len(stacked) &gt; len(stacked.dropna())</span>

        <span class="s1">stacked = df.unstack().stack(dropna=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(stacked</span><span class="s0">, </span><span class="s1">stacked.dropna())</span>

    <span class="s0">def </span><span class="s1">test_unstack_multiple_hierarchical(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">index=[</span>
                <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df.index.names = [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">df.columns.names = [</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">]</span>

        <span class="s4"># it works!</span>
        <span class="s1">df.unstack([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_unstack_sparse_keyspace(self):</span>
        <span class="s4"># memory problems with naive impl GH#2278</span>
        <span class="s4"># Generate Long File &amp; Test Pivot</span>
        <span class="s1">NUM_ROWS = </span><span class="s3">1000</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;A&quot;</span><span class="s1">: np.random.randint(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">size=NUM_ROWS)</span><span class="s0">,</span>
                <span class="s2">&quot;B&quot;</span><span class="s1">: np.random.randint(</span><span class="s3">300</span><span class="s0">, </span><span class="s1">size=NUM_ROWS)</span><span class="s0">,</span>
                <span class="s2">&quot;C&quot;</span><span class="s1">: np.random.randint(-</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s1">size=NUM_ROWS)</span><span class="s0">,</span>
                <span class="s2">&quot;D&quot;</span><span class="s1">: np.random.randint(-</span><span class="s3">19</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s1">size=NUM_ROWS)</span><span class="s0">,</span>
                <span class="s2">&quot;E&quot;</span><span class="s1">: np.random.randint(</span><span class="s3">3000</span><span class="s0">, </span><span class="s1">size=NUM_ROWS)</span><span class="s0">,</span>
                <span class="s2">&quot;F&quot;</span><span class="s1">: np.random.randn(NUM_ROWS)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">idf = df.set_index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;E&quot;</span><span class="s1">])</span>

        <span class="s4"># it works! is sufficient</span>
        <span class="s1">idf.unstack(</span><span class="s2">&quot;E&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unstack_unobserved_keys(self):</span>
        <span class="s4"># related to GH#2278 refactoring</span>
        <span class="s1">levels = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">codes = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span>

        <span class="s1">index = MultiIndex(levels</span><span class="s0">, </span><span class="s1">codes)</span>

        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>

        <span class="s1">result = df.unstack()</span>
        <span class="s0">assert </span><span class="s1">len(result.columns) == </span><span class="s3">4</span>

        <span class="s1">recons = result.stack()</span>
        <span class="s1">tm.assert_frame_equal(recons</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s1">@pytest.mark.slow</span>
    <span class="s0">def </span><span class="s1">test_unstack_number_of_levels_larger_than_int32(self</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
        <span class="s4"># GH#20601</span>
        <span class="s4"># GH 26314: Change ValueError to PerformanceWarning</span>

        <span class="s0">class </span><span class="s1">MockUnstacker(reshape_lib._Unstacker):</span>
            <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
                <span class="s4"># __init__ will raise the warning</span>
                <span class="s1">super().__init__(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
                <span class="s0">raise </span><span class="s1">Exception(</span><span class="s2">&quot;Don't compute final result.&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">monkeypatch.context() </span><span class="s0">as </span><span class="s1">m:</span>
            <span class="s1">m.setattr(reshape_lib</span><span class="s0">, </span><span class="s2">&quot;_Unstacker&quot;</span><span class="s0">, </span><span class="s1">MockUnstacker)</span>
            <span class="s1">df = DataFrame(</span>
                <span class="s1">np.random.randn(</span><span class="s3">2 </span><span class="s1">** </span><span class="s3">16</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">index=[np.arange(</span><span class="s3">2 </span><span class="s1">** </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">2 </span><span class="s1">** </span><span class="s3">16</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">msg = </span><span class="s2">&quot;The following operation may generate&quot;</span>
            <span class="s0">with </span><span class="s1">tm.assert_produces_warning(PerformanceWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s0">with </span><span class="s1">pytest.raises(Exception</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Don't compute final result.&quot;</span><span class="s1">):</span>
                    <span class="s1">df.unstack()</span>

    <span class="s0">def </span><span class="s1">test_stack_order_with_unsorted_levels(self):</span>
        <span class="s4"># GH#16323</span>

        <span class="s0">def </span><span class="s1">manual_compare_stacked(df</span><span class="s0">, </span><span class="s1">df_stacked</span><span class="s0">, </span><span class="s1">lev0</span><span class="s0">, </span><span class="s1">lev1):</span>
            <span class="s0">assert </span><span class="s1">all(</span>
                <span class="s1">df.loc[row</span><span class="s0">, </span><span class="s1">col] == df_stacked.loc[(row</span><span class="s0">, </span><span class="s1">col[lev0])</span><span class="s0">, </span><span class="s1">col[lev1]]</span>
                <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">df.index</span>
                <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">df.columns</span>
            <span class="s1">)</span>

        <span class="s4"># deep check for 1-row case</span>
        <span class="s0">for </span><span class="s1">width </span><span class="s0">in </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]:</span>
            <span class="s1">levels_poss = itertools.product(</span>
                <span class="s1">itertools.permutations([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">width)</span><span class="s0">, </span><span class="s1">repeat=</span><span class="s3">2</span>
            <span class="s1">)</span>

            <span class="s0">for </span><span class="s1">levels </span><span class="s0">in </span><span class="s1">levels_poss:</span>
                <span class="s1">columns = MultiIndex(levels=levels</span><span class="s0">, </span><span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
                <span class="s1">df = DataFrame(columns=columns</span><span class="s0">, </span><span class="s1">data=[range(</span><span class="s3">4</span><span class="s1">)])</span>
                <span class="s0">for </span><span class="s1">stack_lev </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
                    <span class="s1">df_stacked = df.stack(stack_lev)</span>
                    <span class="s1">manual_compare_stacked(df</span><span class="s0">, </span><span class="s1">df_stacked</span><span class="s0">, </span><span class="s1">stack_lev</span><span class="s0">, </span><span class="s3">1 </span><span class="s1">- stack_lev)</span>

        <span class="s4"># check multi-row case</span>
        <span class="s1">mi = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[np.repeat(range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.tile(range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">columns=mi</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">data=np.arange(</span><span class="s3">5 </span><span class="s1">* len(mi)).reshape(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">manual_compare_stacked(df</span><span class="s0">, </span><span class="s1">df.stack(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_stack_unstack_unordered_multiindex(self):</span>
        <span class="s4"># GH# 18265</span>
        <span class="s1">values = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">data = np.vstack(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">f&quot;b</span><span class="s0">{</span><span class="s1">x</span><span class="s0">}</span><span class="s2">&quot; </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">values]</span><span class="s0">,  </span><span class="s4"># b0, b1, ..</span>
                <span class="s1">[</span><span class="s2">f&quot;a</span><span class="s0">{</span><span class="s1">x</span><span class="s0">}</span><span class="s2">&quot; </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">values]</span><span class="s0">,  </span><span class="s4"># a0, a1, ..</span>
            <span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(data.T</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">df.columns.name = </span><span class="s2">&quot;first&quot;</span>
        <span class="s1">second_level_dict = {</span><span class="s2">&quot;x&quot;</span><span class="s1">: df}</span>
        <span class="s1">multi_level_df = pd.concat(second_level_dict</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">multi_level_df.columns.names = [</span><span class="s2">&quot;second&quot;</span><span class="s0">, </span><span class="s2">&quot;first&quot;</span><span class="s1">]</span>
        <span class="s1">df = multi_level_df.reindex(sorted(multi_level_df.columns)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">result = df.stack([</span><span class="s2">&quot;first&quot;</span><span class="s0">, </span><span class="s2">&quot;second&quot;</span><span class="s1">]).unstack([</span><span class="s2">&quot;first&quot;</span><span class="s0">, </span><span class="s2">&quot;second&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">&quot;a0&quot;</span><span class="s0">, </span><span class="s2">&quot;b0&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a1&quot;</span><span class="s0">, </span><span class="s2">&quot;b1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a2&quot;</span><span class="s0">, </span><span class="s2">&quot;b2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a3&quot;</span><span class="s0">, </span><span class="s2">&quot;b3&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a4&quot;</span><span class="s0">, </span><span class="s2">&quot;b4&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;first&quot;</span><span class="s0">, </span><span class="s2">&quot;second&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_preserve_types(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">multiindex_year_month_day_dataframe_random_data</span>
    <span class="s1">):</span>
        <span class="s4"># GH#403</span>
        <span class="s1">ymd = multiindex_year_month_day_dataframe_random_data</span>
        <span class="s1">ymd[</span><span class="s2">&quot;E&quot;</span><span class="s1">] = </span><span class="s2">&quot;foo&quot;</span>
        <span class="s1">ymd[</span><span class="s2">&quot;F&quot;</span><span class="s1">] = </span><span class="s3">2</span>

        <span class="s1">unstacked = ymd.unstack(</span><span class="s2">&quot;month&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">unstacked[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">].dtype == np.float64</span>
        <span class="s0">assert </span><span class="s1">unstacked[</span><span class="s2">&quot;E&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">].dtype == np.object_</span>
        <span class="s0">assert </span><span class="s1">unstacked[</span><span class="s2">&quot;F&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">].dtype == np.float64</span>

    <span class="s0">def </span><span class="s1">test_unstack_group_index_overflow(self):</span>
        <span class="s1">codes = np.tile(np.arange(</span><span class="s3">500</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">level = np.arange(</span><span class="s3">500</span><span class="s1">)</span>

        <span class="s1">index = MultiIndex(</span>
            <span class="s1">levels=[level] * </span><span class="s3">8 </span><span class="s1">+ [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[codes] * </span><span class="s3">8 </span><span class="s1">+ [np.arange(</span><span class="s3">2</span><span class="s1">).repeat(</span><span class="s3">500</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">s = Series(np.arange(</span><span class="s3">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">result = s.unstack()</span>
        <span class="s0">assert </span><span class="s1">result.shape == (</span><span class="s3">500</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

        <span class="s4"># test roundtrip</span>
        <span class="s1">stacked = result.stack()</span>
        <span class="s1">tm.assert_series_equal(s</span><span class="s0">, </span><span class="s1">stacked.reindex(s.index))</span>

        <span class="s4"># put it at beginning</span>
        <span class="s1">index = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]] + [level] * </span><span class="s3">8</span><span class="s0">,</span>
            <span class="s1">codes=[np.arange(</span><span class="s3">2</span><span class="s1">).repeat(</span><span class="s3">500</span><span class="s1">)] + [codes] * </span><span class="s3">8</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">s = Series(np.arange(</span><span class="s3">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">result = s.unstack(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.shape == (</span><span class="s3">500</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

        <span class="s4"># put it in middle</span>
        <span class="s1">index = MultiIndex(</span>
            <span class="s1">levels=[level] * </span><span class="s3">4 </span><span class="s1">+ [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]] + [level] * </span><span class="s3">4</span><span class="s0">,</span>
            <span class="s1">codes=([codes] * </span><span class="s3">4 </span><span class="s1">+ [np.arange(</span><span class="s3">2</span><span class="s1">).repeat(</span><span class="s3">500</span><span class="s1">)] + [codes] * </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">s = Series(np.arange(</span><span class="s3">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">result = s.unstack(</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.shape == (</span><span class="s3">500</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unstack_with_missing_int_cast_to_float(self</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/37115</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;ca&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;v&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s1">] * </span><span class="s3">3</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">).set_index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>

        <span class="s4"># add another int column to get 2 blocks</span>
        <span class="s1">df[</span><span class="s2">&quot;is_&quot;</span><span class="s1">] = </span><span class="s3">1</span>
        <span class="s0">if not </span><span class="s1">using_array_manager:</span>
            <span class="s0">assert </span><span class="s1">len(df._mgr.blocks) == </span><span class="s3">2</span>

        <span class="s1">result = df.unstack(</span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
        <span class="s1">result[(</span><span class="s2">&quot;is_&quot;</span><span class="s0">, </span><span class="s2">&quot;ca&quot;</span><span class="s1">)] = result[(</span><span class="s2">&quot;is_&quot;</span><span class="s0">, </span><span class="s2">&quot;ca&quot;</span><span class="s1">)].fillna(</span><span class="s3">0</span><span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">10.0</span><span class="s0">, </span><span class="s3">10.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">10.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;object&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s2">&quot;v&quot;</span><span class="s0">, </span><span class="s2">&quot;ca&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;v&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;is_&quot;</span><span class="s0">, </span><span class="s2">&quot;ca&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;is_&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s0">None, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">using_array_manager:</span>
            <span class="s4"># INFO(ArrayManager) with ArrayManager preserve dtype where possible</span>
            <span class="s1">expected[(</span><span class="s2">&quot;v&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s1">)] = expected[(</span><span class="s2">&quot;v&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s1">)].astype(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span>
            <span class="s1">expected[(</span><span class="s2">&quot;is_&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s1">)] = expected[(</span><span class="s2">&quot;is_&quot;</span><span class="s0">, </span><span class="s2">&quot;cb&quot;</span><span class="s1">)].astype(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_with_level_has_nan(self):</span>
        <span class="s4"># GH 37510</span>
        <span class="s1">df1 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;L1&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;L2&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;L3&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df1 = df1.set_index([</span><span class="s2">&quot;L1&quot;</span><span class="s0">, </span><span class="s2">&quot;L2&quot;</span><span class="s0">, </span><span class="s2">&quot;L3&quot;</span><span class="s1">])</span>
        <span class="s1">new_levels = [</span><span class="s2">&quot;n1&quot;</span><span class="s0">, </span><span class="s2">&quot;n2&quot;</span><span class="s0">, </span><span class="s2">&quot;n3&quot;</span><span class="s0">, None</span><span class="s1">]</span>
        <span class="s1">df1.index = df1.index.set_levels(levels=new_levels</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">&quot;L1&quot;</span><span class="s1">)</span>
        <span class="s1">df1.index = df1.index.set_levels(levels=new_levels</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">&quot;L2&quot;</span><span class="s1">)</span>

        <span class="s1">result = df1.unstack(</span><span class="s2">&quot;L3&quot;</span><span class="s1">)[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)].sort_index().index</span>
        <span class="s1">expected = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s2">&quot;n1&quot;</span><span class="s0">, </span><span class="s2">&quot;n2&quot;</span><span class="s0">, </span><span class="s2">&quot;n3&quot;</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;n1&quot;</span><span class="s0">, </span><span class="s2">&quot;n2&quot;</span><span class="s0">, </span><span class="s2">&quot;n3&quot;</span><span class="s0">, None</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;L1&quot;</span><span class="s0">, </span><span class="s2">&quot;L2&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_index_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_nan_in_multiindex_columns(self):</span>
        <span class="s4"># GH#39481</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.zeros([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[</span>
                    <span class="s1">(</span><span class="s3">0</span><span class="s0">, None, None</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df.stack(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=Index([(</span><span class="s3">0</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">columns=Index([(</span><span class="s3">0</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_multi_level_stack_categorical(self):</span>
        <span class="s4"># GH 15239</span>
        <span class="s1">midx = MultiIndex.from_arrays(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s1">] * </span><span class="s3">2 </span><span class="s1">+ [</span><span class="s2">&quot;B&quot;</span><span class="s1">] * </span><span class="s3">2</span><span class="s0">,</span>
                <span class="s1">pd.Categorical(list(</span><span class="s2">&quot;abab&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">pd.Categorical(list(</span><span class="s2">&quot;ccdd&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(np.arange(</span><span class="s3">8</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=midx)</span>
        <span class="s1">result = df.stack([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_arrays(</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s3">0</span><span class="s1">] * </span><span class="s3">4 </span><span class="s1">+ [</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">4</span><span class="s0">,</span>
                    <span class="s1">pd.Categorical(list(</span><span class="s2">&quot;aabbaabb&quot;</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s1">pd.Categorical(list(</span><span class="s2">&quot;cdcdcdcd&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_nan_level(self):</span>
        <span class="s4"># GH 9406</span>
        <span class="s1">df_nan = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s3">4</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;Upper&quot;</span><span class="s0">, </span><span class="s2">&quot;Lower&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;Num&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">dtype=np.float64</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df_nan.stack()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;Upper&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;Num&quot;</span><span class="s0">, </span><span class="s2">&quot;Lower&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unstack_categorical_columns(self):</span>
        <span class="s4"># GH 14018</span>
        <span class="s1">idx = MultiIndex.from_product([[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;cat&quot;</span><span class="s1">: pd.Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])}</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">result = df.unstack()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">0</span><span class="s1">: pd.Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">1</span><span class="s1">: pd.Categorical([</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.columns = MultiIndex.from_tuples([(</span><span class="s2">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_unsorted(self):</span>
        <span class="s4"># GH 16925</span>
        <span class="s1">PAE = [</span><span class="s2">&quot;ITA&quot;</span><span class="s0">, </span><span class="s2">&quot;FRA&quot;</span><span class="s1">]</span>
        <span class="s1">VAR = [</span><span class="s2">&quot;A1&quot;</span><span class="s0">, </span><span class="s2">&quot;A2&quot;</span><span class="s1">]</span>
        <span class="s1">TYP = [</span><span class="s2">&quot;CRT&quot;</span><span class="s0">, </span><span class="s2">&quot;DBT&quot;</span><span class="s0">, </span><span class="s2">&quot;NET&quot;</span><span class="s1">]</span>
        <span class="s1">MI = MultiIndex.from_product([PAE</span><span class="s0">, </span><span class="s1">VAR</span><span class="s0">, </span><span class="s1">TYP]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;PAE&quot;</span><span class="s0">, </span><span class="s2">&quot;VAR&quot;</span><span class="s0">, </span><span class="s2">&quot;TYP&quot;</span><span class="s1">])</span>

        <span class="s1">V = list(range(len(MI)))</span>
        <span class="s1">DF = DataFrame(data=V</span><span class="s0">, </span><span class="s1">index=MI</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;VALUE&quot;</span><span class="s1">])</span>

        <span class="s1">DF = DF.unstack([</span><span class="s2">&quot;VAR&quot;</span><span class="s0">, </span><span class="s2">&quot;TYP&quot;</span><span class="s1">])</span>
        <span class="s1">DF.columns = DF.columns.droplevel(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">DF.loc[:</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A0&quot;</span><span class="s0">, </span><span class="s2">&quot;NET&quot;</span><span class="s1">)] = </span><span class="s3">9999</span>

        <span class="s1">result = DF.stack([</span><span class="s2">&quot;VAR&quot;</span><span class="s0">, </span><span class="s2">&quot;TYP&quot;</span><span class="s1">]).sort_index()</span>
        <span class="s1">expected = DF.sort_index(axis=</span><span class="s3">1</span><span class="s1">).stack([</span><span class="s2">&quot;VAR&quot;</span><span class="s0">, </span><span class="s2">&quot;TYP&quot;</span><span class="s1">]).sort_index()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stack_nullable_dtype(self):</span>
        <span class="s4"># GH#43561</span>
        <span class="s1">columns = MultiIndex.from_product(</span>
            <span class="s1">[[</span><span class="s2">&quot;54511&quot;</span><span class="s0">, </span><span class="s2">&quot;54515&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;r&quot;</span><span class="s0">, </span><span class="s2">&quot;t_mean&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;station&quot;</span><span class="s0">, </span><span class="s2">&quot;element&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">index = Index([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>

        <span class="s1">arr = np.array([[</span><span class="s3">50</span><span class="s0">, </span><span class="s3">226</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">215</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">215</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">220</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">305</span><span class="s0">, </span><span class="s3">232</span><span class="s0">, </span><span class="s3">111</span><span class="s0">, </span><span class="s3">220</span><span class="s1">]])</span>
        <span class="s1">df = DataFrame(arr</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">dtype=pd.Int64Dtype())</span>

        <span class="s1">result = df.stack(</span><span class="s2">&quot;station&quot;</span><span class="s1">)</span>

        <span class="s1">expected = df.astype(np.int64).stack(</span><span class="s2">&quot;station&quot;</span><span class="s1">).astype(pd.Int64Dtype())</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># non-homogeneous case</span>
        <span class="s1">df[df.columns[</span><span class="s3">0</span><span class="s1">]] = df[df.columns[</span><span class="s3">0</span><span class="s1">]].astype(pd.Float64Dtype())</span>
        <span class="s1">result = df.stack(</span><span class="s2">&quot;station&quot;</span><span class="s1">)</span>

        <span class="s4"># TODO(EA2D): we get object dtype because DataFrame.values can't</span>
        <span class="s4">#  be an EA</span>
        <span class="s1">expected = df.astype(object).stack(</span><span class="s2">&quot;station&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>