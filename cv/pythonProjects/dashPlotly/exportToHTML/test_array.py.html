<html>
<head>
<title>test_array.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_array.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas._libs.sparse </span><span class="s0">import </span><span class="s1">IntIndex</span>
<span class="s0">import </span><span class="s1">pandas.util._test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">isna</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.api </span><span class="s0">import </span><span class="s1">Int64Index</span>
<span class="s0">from </span><span class="s1">pandas.core.arrays.sparse </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">SparseArray</span><span class="s0">,</span>
    <span class="s1">SparseDtype</span><span class="s0">,</span>
<span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestSparseArray:</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s1">self.arr_data = np.array([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
        <span class="s1">self.arr = SparseArray(self.arr_data)</span>
        <span class="s1">self.zarr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_constructor_dtype(self):</span>
        <span class="s1">arr = SparseArray([np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.float64</span><span class="s0">, </span><span class="s1">np.nan)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype.subtype == np.float64</span>
        <span class="s0">assert </span><span class="s1">np.isnan(arr.fill_value)</span>

        <span class="s1">arr = SparseArray([np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.float64</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.float64</span><span class="s0">, </span><span class="s1">np.nan)</span>
        <span class="s0">assert </span><span class="s1">np.isnan(arr.fill_value)</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

    <span class="s0">def </span><span class="s1">test_constructor_dtype_str(self):</span>
        <span class="s1">result = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int&quot;</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_constructor_sparse_dtype(self):</span>
        <span class="s1">result = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(</span><span class="s3">&quot;int64&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">))</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">result.sp_values.dtype == np.dtype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_constructor_sparse_dtype_str(self):</span>
        <span class="s1">result = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Sparse[int32]&quot;</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">result.sp_values.dtype == np.dtype(</span><span class="s3">&quot;int32&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_constructor_object_dtype(self):</span>
        <span class="s4"># GH 11856</span>
        <span class="s1">arr = SparseArray([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(object)</span>
        <span class="s0">assert </span><span class="s1">np.isnan(arr.fill_value)</span>

        <span class="s1">arr = SparseArray([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(object</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s3">&quot;A&quot;</span>

        <span class="s4"># GH 17574</span>
        <span class="s1">data = [</span><span class="s0">False, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">100.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span>
        <span class="s1">arr = SparseArray(data</span><span class="s0">, </span><span class="s1">dtype=object</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(object</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value </span><span class="s0">is False</span>
        <span class="s1">arr_expected = np.array(data</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s1">it = (type(x) == type(y) </span><span class="s0">and </span><span class="s1">x == y </span><span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip(arr</span><span class="s0">, </span><span class="s1">arr_expected))</span>
        <span class="s0">assert </span><span class="s1">np.fromiter(it</span><span class="s0">, </span><span class="s1">dtype=np.bool_).all()</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[SparseDtype(int</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int])</span>
    <span class="s0">def </span><span class="s1">test_constructor_na_dtype(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;Cannot convert&quot;</span><span class="s1">):</span>
            <span class="s1">SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

    <span class="s0">def </span><span class="s1">test_constructor_warns_when_losing_timezone(self):</span>
        <span class="s4"># GH#32501 warn when losing timezone information</span>
        <span class="s1">dti = pd.date_range(</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span>

        <span class="s1">expected = SparseArray(np.asarray(dti</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s1">))</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(UserWarning):</span>
            <span class="s1">result = SparseArray(dti)</span>

        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(UserWarning):</span>
            <span class="s1">result = SparseArray(pd.Series(dti))</span>

        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_constructor_spindex_dtype(self):</span>
        <span class="s1">arr = SparseArray(data=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sparse_index=IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]))</span>
        <span class="s4"># XXX: Behavior change: specifying SparseIndex no longer changes the</span>
        <span class="s4"># fill_value</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray(</span>
            <span class="s1">data=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">sparse_index=IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">dtype=np.int64</span><span class="s0">,</span>
            <span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray(</span>
            <span class="s1">data=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sparse_index=IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.int64</span>
        <span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray(</span>
            <span class="s1">data=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">sparse_index=IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">dtype=</span><span class="s0">None,</span>
            <span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;sparse_index&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s1">IntIndex(</span><span class="s2">1</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s1">])])</span>
    <span class="s0">def </span><span class="s1">test_constructor_spindex_dtype_scalar(self</span><span class="s0">, </span><span class="s1">sparse_index):</span>
        <span class="s4"># scalar input</span>
        <span class="s1">arr = SparseArray(data=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">sparse_index=sparse_index</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

        <span class="s1">arr = SparseArray(data=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">sparse_index=IntIndex(</span><span class="s2">1</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

    <span class="s0">def </span><span class="s1">test_constructor_spindex_dtype_scalar_broadcasts(self):</span>
        <span class="s1">arr = SparseArray(</span>
            <span class="s1">data=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sparse_index=IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span>
        <span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">0</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;data, fill_value&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([pd.Timestamp(</span><span class="s3">&quot;2017-01-01&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">pd.NaT)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_constructor_inferred_fill_value(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">fill_value):</span>
        <span class="s1">result = SparseArray(data).fill_value</span>

        <span class="s0">if </span><span class="s1">isna(fill_value):</span>
            <span class="s0">assert </span><span class="s1">isna(result)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">result == fill_value</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;format&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;coo&quot;</span><span class="s0">, </span><span class="s3">&quot;csc&quot;</span><span class="s0">, </span><span class="s3">&quot;csr&quot;</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;size&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">])</span>
    <span class="s1">@td.skip_if_no_scipy</span>
    <span class="s0">def </span><span class="s1">test_from_spmatrix(self</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">format):</span>
        <span class="s0">import </span><span class="s1">scipy.sparse</span>

        <span class="s1">mat = scipy.sparse.random(size</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">format=format)</span>
        <span class="s1">result = SparseArray.from_spmatrix(mat)</span>

        <span class="s1">result = np.asarray(result)</span>
        <span class="s1">expected = mat.toarray().ravel()</span>
        <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;format&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;coo&quot;</span><span class="s0">, </span><span class="s3">&quot;csc&quot;</span><span class="s0">, </span><span class="s3">&quot;csr&quot;</span><span class="s1">])</span>
    <span class="s1">@td.skip_if_no_scipy</span>
    <span class="s0">def </span><span class="s1">test_from_spmatrix_including_explicit_zero(self</span><span class="s0">, </span><span class="s1">format):</span>
        <span class="s0">import </span><span class="s1">scipy.sparse</span>

        <span class="s1">mat = scipy.sparse.random(</span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">format=format)</span>
        <span class="s1">mat.data[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>
        <span class="s1">result = SparseArray.from_spmatrix(mat)</span>

        <span class="s1">result = np.asarray(result)</span>
        <span class="s1">expected = mat.toarray().ravel()</span>
        <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@td.skip_if_no_scipy</span>
    <span class="s0">def </span><span class="s1">test_from_spmatrix_raises(self):</span>
        <span class="s0">import </span><span class="s1">scipy.sparse</span>

        <span class="s1">mat = scipy.sparse.eye(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;csc&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;not '4'&quot;</span><span class="s1">):</span>
            <span class="s1">SparseArray.from_spmatrix(mat)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;scalar,dtype&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s0">False, </span><span class="s1">SparseDtype(bool</span><span class="s0">, False</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">SparseDtype(</span><span class="s3">&quot;float64&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s1">SparseDtype(</span><span class="s3">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s1">SparseDtype(</span><span class="s3">&quot;object&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_scalar_with_index_infer_dtype(self</span><span class="s0">, </span><span class="s1">scalar</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s4"># GH 19163</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(</span>
            <span class="s1">FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;The index argument has been deprecated&quot;</span>
        <span class="s1">):</span>
            <span class="s1">arr = SparseArray(scalar</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=scalar)</span>
        <span class="s1">exp = SparseArray([scalar</span><span class="s0">, </span><span class="s1">scalar</span><span class="s0">, </span><span class="s1">scalar]</span><span class="s0">, </span><span class="s1">fill_value=scalar)</span>

        <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s0">assert </span><span class="s1">arr.dtype == dtype</span>
        <span class="s0">assert </span><span class="s1">exp.dtype == dtype</span>

    <span class="s0">def </span><span class="s1">test_getitem_bool_sparse_array(self):</span>
        <span class="s4"># GH 23122</span>
        <span class="s1">spar_bool = SparseArray([</span><span class="s0">False, True</span><span class="s1">] * </span><span class="s2">5</span><span class="s0">, </span><span class="s1">dtype=np.bool8</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
        <span class="s1">tm.assert_sp_array_equal(self.arr[spar_bool]</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">spar_bool = ~spar_bool</span>
        <span class="s1">res = self.arr[spar_bool]</span>
        <span class="s1">exp = SparseArray([np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">spar_bool = SparseArray(</span>
            <span class="s1">[</span><span class="s0">False, True, </span><span class="s1">np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=np.bool8</span><span class="s0">, </span><span class="s1">fill_value=np.nan</span>
        <span class="s1">)</span>
        <span class="s1">res = self.arr[spar_bool]</span>
        <span class="s1">exp = SparseArray([np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_getitem_bool_sparse_array_as_comparison(self):</span>
        <span class="s4"># GH 45110</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">fill_value=np.nan)</span>
        <span class="s1">res = arr[arr &gt; </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=np.nan)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_get_item(self):</span>

        <span class="s0">assert </span><span class="s1">np.isnan(self.arr[</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">self.arr[</span><span class="s2">2</span><span class="s1">] == </span><span class="s2">1</span>
        <span class="s0">assert </span><span class="s1">self.arr[</span><span class="s2">7</span><span class="s1">] == </span><span class="s2">5</span>

        <span class="s0">assert </span><span class="s1">self.zarr[</span><span class="s2">0</span><span class="s1">] == </span><span class="s2">0</span>
        <span class="s0">assert </span><span class="s1">self.zarr[</span><span class="s2">2</span><span class="s1">] == </span><span class="s2">1</span>
        <span class="s0">assert </span><span class="s1">self.zarr[</span><span class="s2">7</span><span class="s1">] == </span><span class="s2">5</span>

        <span class="s1">errmsg = </span><span class="s3">&quot;must be an integer between -10 and 10&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=errmsg):</span>
            <span class="s1">self.arr[</span><span class="s2">11</span><span class="s1">]</span>

        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=errmsg):</span>
            <span class="s1">self.arr[-</span><span class="s2">11</span><span class="s1">]</span>

        <span class="s0">assert </span><span class="s1">self.arr[-</span><span class="s2">1</span><span class="s1">] == self.arr[len(self.arr) - </span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_take_scalar_raises(self):</span>
        <span class="s1">msg = </span><span class="s3">&quot;'indices' must be an array, not a scalar '2'.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">self.arr.take(</span><span class="s2">2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_take(self):</span>
        <span class="s1">exp = SparseArray(np.take(self.arr_data</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]))</span>
        <span class="s1">tm.assert_sp_array_equal(self.arr.take([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">exp = SparseArray(np.take(self.arr_data</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]))</span>
        <span class="s1">tm.assert_sp_array_equal(self.arr.take([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_take_all_empty(self):</span>
        <span class="s1">a = pd.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">))</span>
        <span class="s1">result = a.take([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True, </span><span class="s1">fill_value=np.nan)</span>
        <span class="s1">tm.assert_sp_array_equal(a</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s0">def </span><span class="s1">test_take_fill_value(self):</span>
        <span class="s1">data = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">sparse = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">exp = SparseArray(np.take(data</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(sparse.take([</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">exp = SparseArray(np.take(data</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(sparse.take([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_take_negative(self):</span>
        <span class="s1">exp = SparseArray(np.take(self.arr_data</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">]))</span>
        <span class="s1">tm.assert_sp_array_equal(self.arr.take([-</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">exp = SparseArray(np.take(self.arr_data</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">4</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]))</span>
        <span class="s1">tm.assert_sp_array_equal(self.arr.take([-</span><span class="s2">4</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, None, </span><span class="s1">np.nan])</span>
    <span class="s0">def </span><span class="s1">test_shift_fill_value(self</span><span class="s0">, </span><span class="s1">fill_value):</span>
        <span class="s4"># GH #24128</span>
        <span class="s1">sparse = SparseArray(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">8.0</span><span class="s1">)</span>
        <span class="s1">res = sparse.shift(</span><span class="s2">1</span><span class="s0">, </span><span class="s1">fill_value=fill_value)</span>
        <span class="s0">if </span><span class="s1">isna(fill_value):</span>
            <span class="s1">fill_value = res.dtype.na_value</span>
        <span class="s1">exp = SparseArray(np.array([fill_value</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">8.0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_bad_take(self):</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;bounds&quot;</span><span class="s1">):</span>
            <span class="s1">self.arr.take([</span><span class="s2">11</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_take_filling(self):</span>
        <span class="s4"># similar tests as GH 12631</span>
        <span class="s1">sparse = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]))</span>
        <span class="s1">expected = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># XXX: test change: fill_value=True -&gt; allow_fill=True</span>
        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># allow_fill=False</span>
        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">False, </span><span class="s1">fill_value=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">msg = </span><span class="s3">&quot;Invalid value in 'indices'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">msg = </span><span class="s3">&quot;out of bounds value in 'indices'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">6</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_take_filling_fill_value(self):</span>
        <span class="s4"># same tests as GH 12631</span>
        <span class="s1">sparse = SparseArray([np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]))</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># fill_value</span>
        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s4"># XXX: behavior change.</span>
        <span class="s4"># the old way of filling self.fill_value doesn't follow EA rules.</span>
        <span class="s4"># It's supposed to be self.dtype.na_value (nan in this case)</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># allow_fill=False</span>
        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">False, </span><span class="s1">fill_value=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">msg = </span><span class="s3">&quot;Invalid value in 'indices'.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">allow_fill=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">msg = </span><span class="s3">&quot;out of bounds value in 'indices'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">6</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;kind&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;block&quot;</span><span class="s0">, </span><span class="s3">&quot;integer&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_take_filling_all_nan(self</span><span class="s0">, </span><span class="s1">kind):</span>
        <span class="s1">sparse = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">kind=kind)</span>
        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]))</span>
        <span class="s1">expected = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">kind=kind)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">kind=kind)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">msg = </span><span class="s3">&quot;out of bounds value in 'indices'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">6</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse.take(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_set_item(self):</span>
        <span class="s0">def </span><span class="s1">setitem():</span>
            <span class="s1">self.arr[</span><span class="s2">5</span><span class="s1">] = </span><span class="s2">3</span>

        <span class="s0">def </span><span class="s1">setslice():</span>
            <span class="s1">self.arr[</span><span class="s2">1</span><span class="s1">:</span><span class="s2">5</span><span class="s1">] = </span><span class="s2">2</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;assignment via setitem&quot;</span><span class="s1">):</span>
            <span class="s1">setitem()</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;assignment via setitem&quot;</span><span class="s1">):</span>
            <span class="s1">setslice()</span>

    <span class="s0">def </span><span class="s1">test_constructor_from_too_large_array(self):</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;expected dimension &lt;= 1 data&quot;</span><span class="s1">):</span>
            <span class="s1">SparseArray(np.arange(</span><span class="s2">10</span><span class="s1">).reshape((</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">)))</span>

    <span class="s0">def </span><span class="s1">test_constructor_from_sparse(self):</span>
        <span class="s1">res = SparseArray(self.zarr)</span>
        <span class="s0">assert </span><span class="s1">res.fill_value == </span><span class="s2">0</span>
        <span class="s1">tm.assert_almost_equal(res.sp_values</span><span class="s0">, </span><span class="s1">self.zarr.sp_values)</span>

    <span class="s0">def </span><span class="s1">test_constructor_copy(self):</span>
        <span class="s1">cp = SparseArray(self.arr</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">cp.sp_values[:</span><span class="s2">3</span><span class="s1">] = </span><span class="s2">0</span>
        <span class="s0">assert not </span><span class="s1">(self.arr.sp_values[:</span><span class="s2">3</span><span class="s1">] == </span><span class="s2">0</span><span class="s1">).any()</span>

        <span class="s1">not_copy = SparseArray(self.arr)</span>
        <span class="s1">not_copy.sp_values[:</span><span class="s2">3</span><span class="s1">] = </span><span class="s2">0</span>
        <span class="s0">assert </span><span class="s1">(self.arr.sp_values[:</span><span class="s2">3</span><span class="s1">] == </span><span class="s2">0</span><span class="s1">).all()</span>

    <span class="s0">def </span><span class="s1">test_constructor_bool(self):</span>
        <span class="s4"># GH 10648</span>
        <span class="s1">data = np.array([</span><span class="s0">False, False, True, True, False, False</span><span class="s1">])</span>
        <span class="s1">arr = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">False, </span><span class="s1">dtype=bool)</span>

        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(bool)</span>
        <span class="s1">tm.assert_numpy_array_equal(arr.sp_values</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">True, True</span><span class="s1">]))</span>
        <span class="s4"># Behavior change: np.asarray densifies.</span>
        <span class="s4"># tm.assert_numpy_array_equal(arr.sp_values, np.asarray(arr))</span>
        <span class="s1">tm.assert_numpy_array_equal(arr.sp_index.indices</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.int32))</span>

        <span class="s1">dense = arr.to_dense()</span>
        <span class="s0">assert </span><span class="s1">dense.dtype == bool</span>
        <span class="s1">tm.assert_numpy_array_equal(dense</span><span class="s0">, </span><span class="s1">data)</span>

    <span class="s0">def </span><span class="s1">test_constructor_bool_fill_value(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s0">True, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.bool_)</span>
        <span class="s0">assert not </span><span class="s1">arr.fill_value</span>

        <span class="s1">arr = SparseArray([</span><span class="s0">True, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.bool_)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.bool_)</span>
        <span class="s0">assert not </span><span class="s1">arr.fill_value</span>

        <span class="s1">arr = SparseArray([</span><span class="s0">True, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.bool_</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.bool_</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value</span>

    <span class="s0">def </span><span class="s1">test_constructor_float32(self):</span>
        <span class="s4"># GH 10648</span>
        <span class="s1">data = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
        <span class="s1">arr = SparseArray(data</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>

        <span class="s0">assert </span><span class="s1">arr.dtype == SparseDtype(np.float32)</span>
        <span class="s1">tm.assert_numpy_array_equal(arr.sp_values</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>
        <span class="s4"># Behavior change: np.asarray densifies.</span>
        <span class="s4"># tm.assert_numpy_array_equal(arr.sp_values, np.asarray(arr))</span>
        <span class="s1">tm.assert_numpy_array_equal(</span>
            <span class="s1">arr.sp_index.indices</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">)</span>

        <span class="s1">dense = arr.to_dense()</span>
        <span class="s0">assert </span><span class="s1">dense.dtype == np.float32</span>
        <span class="s1">tm.assert_numpy_array_equal(dense</span><span class="s0">, </span><span class="s1">data)</span>

    <span class="s0">def </span><span class="s1">test_astype(self):</span>
        <span class="s4"># float -&gt; float</span>
        <span class="s1">arr = SparseArray([</span><span class="s0">None, None, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">result = arr.astype(</span><span class="s3">&quot;Sparse[float32]&quot;</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([</span><span class="s0">None, None, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.dtype(</span><span class="s3">&quot;float32&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">dtype = SparseDtype(</span><span class="s3">&quot;float64&quot;</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = arr.astype(dtype)</span>
        <span class="s1">expected = SparseArray._simple_new(</span>
            <span class="s1">np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype.subtype)</span><span class="s0">, </span><span class="s1">IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">dtype</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">dtype = SparseDtype(</span><span class="s3">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = arr.astype(dtype)</span>
        <span class="s1">expected = SparseArray._simple_new(</span>
            <span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span><span class="s0">, </span><span class="s1">IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">dtype</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;NA&quot;</span><span class="s1">):</span>
            <span class="s1">arr.astype(</span><span class="s3">&quot;Sparse[i8]&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_astype_bool(self):</span>
        <span class="s1">a = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(int</span><span class="s0">, </span><span class="s2">0</span><span class="s1">))</span>
        <span class="s1">result = a.astype(bool)</span>
        <span class="s1">expected = SparseArray(</span>
            <span class="s1">[</span><span class="s0">True, False, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(bool</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># update fill value</span>
        <span class="s1">result = a.astype(SparseDtype(bool</span><span class="s0">, False</span><span class="s1">))</span>
        <span class="s1">expected = SparseArray(</span>
            <span class="s1">[</span><span class="s0">True, False, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(bool</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_astype_all(self</span><span class="s0">, </span><span class="s1">any_real_numpy_dtype):</span>
        <span class="s1">vals = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>
        <span class="s1">arr = SparseArray(vals</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">typ = np.dtype(any_real_numpy_dtype)</span>
        <span class="s1">res = arr.astype(typ)</span>
        <span class="s0">assert </span><span class="s1">res.dtype == SparseDtype(typ</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">res.sp_values.dtype == typ</span>

        <span class="s1">tm.assert_numpy_array_equal(np.asarray(res.to_dense())</span><span class="s0">, </span><span class="s1">vals.astype(typ))</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;arr, dtype, expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s1">SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;float&quot;</span><span class="s0">,</span>
                <span class="s1">SparseArray([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(float</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">bool</span><span class="s0">, </span><span class="s1">SparseArray([</span><span class="s0">False, True</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">bool</span><span class="s0">,</span>
                <span class="s1">SparseArray([</span><span class="s0">False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(bool</span><span class="s0">, True</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">pytest.param(</span>
                <span class="s1">SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;datetime64[ns]&quot;</span><span class="s0">,</span>
                <span class="s1">SparseArray(</span>
                    <span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">dtype=SparseDtype(</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s0">, </span><span class="s1">pd.Timestamp(</span><span class="s3">&quot;1970&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">marks=[pytest.mark.xfail(reason=</span><span class="s3">&quot;NumPy-7619&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">10</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">str</span><span class="s0">,</span>
                <span class="s1">SparseArray([</span><span class="s3">&quot;0&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;10&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(str</span><span class="s0">, </span><span class="s3">&quot;0&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(SparseArray([</span><span class="s3">&quot;10&quot;</span><span class="s0">, </span><span class="s3">&quot;20&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">SparseArray([</span><span class="s2">10.0</span><span class="s0">, </span><span class="s2">20.0</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">object</span><span class="s0">,</span>
                <span class="s1">SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(object</span><span class="s0">, </span><span class="s2">0</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_astype_more(self</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">expected):</span>
        <span class="s1">result = arr.astype(dtype)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_astype_nan_raises(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;Cannot convert non-finite&quot;</span><span class="s1">):</span>
            <span class="s1">arr.astype(int)</span>

    <span class="s0">def </span><span class="s1">test_astype_copy_false(self):</span>
        <span class="s4"># GH#34456 bug caused by using .view instead of .astype in astype_nansafe</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

        <span class="s1">result = arr.astype(float</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0.0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_set_fill_value(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=np.nan)</span>
        <span class="s1">arr.fill_value = </span><span class="s2">2</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">2</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s1">arr.fill_value = </span><span class="s2">2</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">2</span>

        <span class="s4"># XXX: this seems fine? You can construct an integer</span>
        <span class="s4"># sparsearray with NaN fill value, why not update one?</span>
        <span class="s4"># coerces to int</span>
        <span class="s4"># msg = &quot;unable to set fill_value 3\\.1 to int64 dtype&quot;</span>
        <span class="s4"># with pytest.raises(ValueError, match=msg):</span>
        <span class="s1">arr.fill_value = </span><span class="s2">3.1</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value == </span><span class="s2">3.1</span>

        <span class="s4"># msg = &quot;unable to set fill_value nan to int64 dtype&quot;</span>
        <span class="s4"># with pytest.raises(ValueError, match=msg):</span>
        <span class="s1">arr.fill_value = np.nan</span>
        <span class="s0">assert </span><span class="s1">np.isnan(arr.fill_value)</span>

        <span class="s1">arr = SparseArray([</span><span class="s0">True, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">False, </span><span class="s1">dtype=np.bool_)</span>
        <span class="s1">arr.fill_value = </span><span class="s0">True</span>
        <span class="s0">assert </span><span class="s1">arr.fill_value</span>

        <span class="s4"># coerces to bool</span>
        <span class="s4"># XXX: we can construct an sparse array of bool</span>
        <span class="s4">#      type and use as fill_value any value</span>
        <span class="s4"># msg = &quot;fill_value must be True, False or nan&quot;</span>
        <span class="s4"># with pytest.raises(ValueError, match=msg):</span>
        <span class="s4">#    arr.fill_value = 0</span>

        <span class="s4"># msg = &quot;unable to set fill_value nan to bool dtype&quot;</span>
        <span class="s4"># with pytest.raises(ValueError, match=msg):</span>
        <span class="s1">arr.fill_value = np.nan</span>
        <span class="s0">assert </span><span class="s1">np.isnan(arr.fill_value)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)])</span>
    <span class="s0">def </span><span class="s1">test_set_fill_invalid_non_scalar(self</span><span class="s0">, </span><span class="s1">val):</span>
        <span class="s1">arr = SparseArray([</span><span class="s0">True, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">False, </span><span class="s1">dtype=np.bool_)</span>
        <span class="s1">msg = </span><span class="s3">&quot;fill_value must be a scalar&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">arr.fill_value = val</span>

    <span class="s0">def </span><span class="s1">test_copy(self):</span>
        <span class="s1">arr2 = self.arr.copy()</span>
        <span class="s0">assert </span><span class="s1">arr2.sp_values </span><span class="s0">is not </span><span class="s1">self.arr.sp_values</span>
        <span class="s0">assert </span><span class="s1">arr2.sp_index </span><span class="s0">is </span><span class="s1">self.arr.sp_index</span>

    <span class="s0">def </span><span class="s1">test_values_asarray(self):</span>
        <span class="s1">tm.assert_almost_equal(self.arr.to_dense()</span><span class="s0">, </span><span class="s1">self.arr_data)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;data,shape,dtype&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s2">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([]</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s2">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_shape(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s4"># GH 21126</span>
        <span class="s1">out = SparseArray(data</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s0">assert </span><span class="s1">out.shape == shape</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;vals&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s2">0</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_dense_repr(self</span><span class="s0">, </span><span class="s1">vals</span><span class="s0">, </span><span class="s1">fill_value):</span>
        <span class="s1">vals = np.array(vals)</span>
        <span class="s1">arr = SparseArray(vals</span><span class="s0">, </span><span class="s1">fill_value=fill_value)</span>

        <span class="s1">res = arr.to_dense()</span>
        <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">vals)</span>

        <span class="s1">res2 = arr._internal_get_values()</span>

        <span class="s1">tm.assert_numpy_array_equal(res2</span><span class="s0">, </span><span class="s1">vals)</span>

    <span class="s0">def </span><span class="s1">test_getitem(self):</span>
        <span class="s0">def </span><span class="s1">_checkit(i):</span>
            <span class="s1">tm.assert_almost_equal(self.arr[i]</span><span class="s0">, </span><span class="s1">self.arr.to_dense()[i])</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(self.arr)):</span>
            <span class="s1">_checkit(i)</span>
            <span class="s1">_checkit(-i)</span>

    <span class="s0">def </span><span class="s1">test_getitem_arraylike_mask(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">result = arr[[</span><span class="s0">True, False, True</span><span class="s1">]]</span>
        <span class="s1">expected = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;slc&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">np.s_[:]</span><span class="s0">,</span>
            <span class="s1">np.s_[</span><span class="s2">1</span><span class="s1">:</span><span class="s2">10</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[</span><span class="s2">1</span><span class="s1">:</span><span class="s2">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[</span><span class="s2">10</span><span class="s1">:</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[:-</span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[-</span><span class="s2">5</span><span class="s1">:-</span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[:-</span><span class="s2">12</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[-</span><span class="s2">12</span><span class="s1">:]</span><span class="s0">,</span>
            <span class="s1">np.s_[</span><span class="s2">2</span><span class="s1">:]</span><span class="s0">,</span>
            <span class="s1">np.s_[</span><span class="s2">2</span><span class="s1">::</span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[::</span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[::-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[::-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[</span><span class="s2">1</span><span class="s1">:</span><span class="s2">6</span><span class="s1">:</span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.s_[:-</span><span class="s2">6</span><span class="s1">:-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;as_dense&quot;</span><span class="s0">, </span><span class="s1">[[np.nan] * </span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">] * </span><span class="s2">10</span><span class="s0">, </span><span class="s1">[np.nan] * </span><span class="s2">5 </span><span class="s1">+ [</span><span class="s2">1</span><span class="s1">] * </span><span class="s2">5</span><span class="s0">, </span><span class="s1">[]]</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_getslice(self</span><span class="s0">, </span><span class="s1">slc</span><span class="s0">, </span><span class="s1">as_dense):</span>
        <span class="s1">as_dense = np.array(as_dense)</span>
        <span class="s1">arr = SparseArray(as_dense)</span>

        <span class="s1">result = arr[slc]</span>
        <span class="s1">expected = SparseArray(as_dense[slc])</span>

        <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_getslice_tuple(self):</span>
        <span class="s1">dense = np.array([np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">sparse = SparseArray(dense)</span>
        <span class="s1">res = sparse[(slice(</span><span class="s2">4</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)]</span>
        <span class="s1">exp = SparseArray(dense[</span><span class="s2">4</span><span class="s1">:])</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">sparse = SparseArray(dense</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">res = sparse[(slice(</span><span class="s2">4</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)]</span>
        <span class="s1">exp = SparseArray(dense[</span><span class="s2">4</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">msg = </span><span class="s3">&quot;too many indices for array&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">sparse[</span><span class="s2">4</span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span>

        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s4"># check numpy compat</span>
            <span class="s1">dense[</span><span class="s2">4</span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span>

    <span class="s0">def </span><span class="s1">test_boolean_slice_empty(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">res = arr[[</span><span class="s0">False, False, False</span><span class="s1">]]</span>
        <span class="s0">assert </span><span class="s1">res.dtype == arr.dtype</span>

    <span class="s0">def </span><span class="s1">test_neg_operator(self):</span>
        <span class="s1">arr = SparseArray([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=np.nan</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">res = -arr</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=np.nan</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">tm.assert_sp_array_equal(exp</span><span class="s0">, </span><span class="s1">res)</span>

        <span class="s1">arr = SparseArray([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">res = -arr</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">tm.assert_sp_array_equal(exp</span><span class="s0">, </span><span class="s1">res)</span>

    <span class="s0">def </span><span class="s1">test_abs_operator(self):</span>
        <span class="s1">arr = SparseArray([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=np.nan</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">res = abs(arr)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=np.nan</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">tm.assert_sp_array_equal(exp</span><span class="s0">, </span><span class="s1">res)</span>

        <span class="s1">arr = SparseArray([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">res = abs(arr)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">tm.assert_sp_array_equal(exp</span><span class="s0">, </span><span class="s1">res)</span>

    <span class="s0">def </span><span class="s1">test_invert_operator(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s0">False, True, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">False, </span><span class="s1">dtype=np.bool8)</span>
        <span class="s1">res = ~arr</span>
        <span class="s1">exp = SparseArray(</span>
            <span class="s1">np.invert([</span><span class="s0">False, True, False, True</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">True, </span><span class="s1">dtype=np.bool8</span>
        <span class="s1">)</span>
        <span class="s1">res = ~arr</span>
        <span class="s1">tm.assert_sp_array_equal(exp</span><span class="s0">, </span><span class="s1">res)</span>

        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">res = ~arr</span>
        <span class="s1">exp = SparseArray([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;op&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;add&quot;</span><span class="s0">, </span><span class="s3">&quot;sub&quot;</span><span class="s0">, </span><span class="s3">&quot;mul&quot;</span><span class="s0">, </span><span class="s3">&quot;truediv&quot;</span><span class="s0">, </span><span class="s3">&quot;floordiv&quot;</span><span class="s0">, </span><span class="s3">&quot;pow&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_binary_operators(self</span><span class="s0">, </span><span class="s1">op):</span>
        <span class="s1">op = getattr(operator</span><span class="s0">, </span><span class="s1">op)</span>
        <span class="s1">data1 = np.random.randn(</span><span class="s2">20</span><span class="s1">)</span>
        <span class="s1">data2 = np.random.randn(</span><span class="s2">20</span><span class="s1">)</span>

        <span class="s1">data1[::</span><span class="s2">2</span><span class="s1">] = np.nan</span>
        <span class="s1">data2[::</span><span class="s2">3</span><span class="s1">] = np.nan</span>

        <span class="s1">arr1 = SparseArray(data1)</span>
        <span class="s1">arr2 = SparseArray(data2)</span>

        <span class="s1">data1[::</span><span class="s2">2</span><span class="s1">] = </span><span class="s2">3</span>
        <span class="s1">data2[::</span><span class="s2">3</span><span class="s1">] = </span><span class="s2">3</span>
        <span class="s1">farr1 = SparseArray(data1</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">farr2 = SparseArray(data2</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">_check_op(op</span><span class="s0">, </span><span class="s1">first</span><span class="s0">, </span><span class="s1">second):</span>
            <span class="s1">res = op(first</span><span class="s0">, </span><span class="s1">second)</span>
            <span class="s1">exp = SparseArray(</span>
                <span class="s1">op(first.to_dense()</span><span class="s0">, </span><span class="s1">second.to_dense())</span><span class="s0">, </span><span class="s1">fill_value=first.fill_value</span>
            <span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">isinstance(res</span><span class="s0">, </span><span class="s1">SparseArray)</span>
            <span class="s1">tm.assert_almost_equal(res.to_dense()</span><span class="s0">, </span><span class="s1">exp.to_dense())</span>

            <span class="s1">res2 = op(first</span><span class="s0">, </span><span class="s1">second.to_dense())</span>
            <span class="s0">assert </span><span class="s1">isinstance(res2</span><span class="s0">, </span><span class="s1">SparseArray)</span>
            <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">res2)</span>

            <span class="s1">res3 = op(first.to_dense()</span><span class="s0">, </span><span class="s1">second)</span>
            <span class="s0">assert </span><span class="s1">isinstance(res3</span><span class="s0">, </span><span class="s1">SparseArray)</span>
            <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">res3)</span>

            <span class="s1">res4 = op(first</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">isinstance(res4</span><span class="s0">, </span><span class="s1">SparseArray)</span>

            <span class="s4"># Ignore this if the actual op raises (e.g. pow).</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">exp = op(first.to_dense()</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span>
                <span class="s1">exp_fv = op(first.fill_value</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span>
            <span class="s0">except </span><span class="s1">ValueError:</span>
                <span class="s0">pass</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">tm.assert_almost_equal(res4.fill_value</span><span class="s0">, </span><span class="s1">exp_fv)</span>
                <span class="s1">tm.assert_almost_equal(res4.to_dense()</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s3">&quot;ignore&quot;</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">first_arr</span><span class="s0">, </span><span class="s1">second_arr </span><span class="s0">in </span><span class="s1">[(arr1</span><span class="s0">, </span><span class="s1">arr2)</span><span class="s0">, </span><span class="s1">(farr1</span><span class="s0">, </span><span class="s1">farr2)]:</span>
                <span class="s1">_check_op(op</span><span class="s0">, </span><span class="s1">first_arr</span><span class="s0">, </span><span class="s1">second_arr)</span>

    <span class="s0">def </span><span class="s1">test_pickle(self):</span>
        <span class="s0">def </span><span class="s1">_check_roundtrip(obj):</span>
            <span class="s1">unpickled = tm.round_trip_pickle(obj)</span>
            <span class="s1">tm.assert_sp_array_equal(unpickled</span><span class="s0">, </span><span class="s1">obj)</span>

        <span class="s1">_check_roundtrip(self.arr)</span>
        <span class="s1">_check_roundtrip(self.zarr)</span>

    <span class="s0">def </span><span class="s1">test_generator_warnings(self):</span>
        <span class="s1">sp_arr = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(action=</span><span class="s3">&quot;always&quot;</span><span class="s0">, </span><span class="s1">category=DeprecationWarning)</span>
            <span class="s1">warnings.filterwarnings(action=</span><span class="s3">&quot;always&quot;</span><span class="s0">, </span><span class="s1">category=PendingDeprecationWarning)</span>
            <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">sp_arr:</span>
                <span class="s0">pass</span>
            <span class="s0">assert </span><span class="s1">len(w) == </span><span class="s2">0</span>

    <span class="s0">def </span><span class="s1">test_fillna(self):</span>
        <span class="s1">s = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">s = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">s = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">s = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">s = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">s = SparseArray([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># float dtype's fill_value is np.nan, replaced by -1</span>
        <span class="s1">s = SparseArray([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># int dtype shouldn't have missing. No changes.</span>
        <span class="s1">s = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">s.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">s.fill_value == </span><span class="s2">0</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">s)</span>

        <span class="s1">s = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">s.dtype == SparseDtype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">s.fill_value == </span><span class="s2">0</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># fill_value can be nan if there is no missing hole.</span>
        <span class="s4"># only fill_value will be changed</span>
        <span class="s1">s = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=np.nan)</span>
        <span class="s0">assert </span><span class="s1">s.dtype == SparseDtype(np.int64</span><span class="s0">, </span><span class="s1">fill_value=np.nan)</span>
        <span class="s0">assert </span><span class="s1">np.isnan(s.fill_value)</span>
        <span class="s1">res = s.fillna(-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_fillna_overlap(self):</span>
        <span class="s1">s = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan])</span>
        <span class="s4"># filling with existing value doesn't replace existing value with</span>
        <span class="s4"># fill_value, i.e. existing 3 remains in sp_values</span>
        <span class="s1">res = s.fillna(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">exp = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_numpy_array_equal(res.to_dense()</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">s = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">res = s.fillna(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">tm.assert_sp_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_nonzero(self):</span>
        <span class="s4"># Tests regression #21172.</span>
        <span class="s1">sa = SparseArray([float(</span><span class="s3">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float(</span><span class="s3">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">expected = np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">(result</span><span class="s0">,</span><span class="s1">) = sa.nonzero()</span>
        <span class="s1">tm.assert_numpy_array_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">sa = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">(result</span><span class="s0">,</span><span class="s1">) = sa.nonzero()</span>
        <span class="s1">tm.assert_numpy_array_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">class </span><span class="s1">TestSparseArrayAnalytics:</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;data,pos,neg&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s0">True, True, True</span><span class="s1">]</span><span class="s0">, True, False</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_all(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">pos</span><span class="s0">, </span><span class="s1">neg):</span>
        <span class="s4"># GH 17570</span>
        <span class="s1">out = SparseArray(data).all()</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">out = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos).all()</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">data[</span><span class="s2">1</span><span class="s1">] = neg</span>
        <span class="s1">out = SparseArray(data).all()</span>
        <span class="s0">assert not </span><span class="s1">out</span>

        <span class="s1">out = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos).all()</span>
        <span class="s0">assert not </span><span class="s1">out</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;data,pos,neg&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s0">True, True, True</span><span class="s1">]</span><span class="s0">, True, False</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_numpy_all(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">pos</span><span class="s0">, </span><span class="s1">neg):</span>
        <span class="s4"># GH 17570</span>
        <span class="s1">out = np.all(SparseArray(data))</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">out = np.all(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos))</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">data[</span><span class="s2">1</span><span class="s1">] = neg</span>
        <span class="s1">out = np.all(SparseArray(data))</span>
        <span class="s0">assert not </span><span class="s1">out</span>

        <span class="s1">out = np.all(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos))</span>
        <span class="s0">assert not </span><span class="s1">out</span>

        <span class="s4"># raises with a different message on py2.</span>
        <span class="s1">msg = </span><span class="s3">&quot;the 'out' parameter is not supported&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">np.all(SparseArray(data)</span><span class="s0">, </span><span class="s1">out=np.array([]))</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;data,pos,neg&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s0">False, True, False</span><span class="s1">]</span><span class="s0">, True, False</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_any(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">pos</span><span class="s0">, </span><span class="s1">neg):</span>
        <span class="s4"># GH 17570</span>
        <span class="s1">out = SparseArray(data).any()</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">out = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos).any()</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">data[</span><span class="s2">1</span><span class="s1">] = neg</span>
        <span class="s1">out = SparseArray(data).any()</span>
        <span class="s0">assert not </span><span class="s1">out</span>

        <span class="s1">out = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos).any()</span>
        <span class="s0">assert not </span><span class="s1">out</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;data,pos,neg&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s0">False, True, False</span><span class="s1">]</span><span class="s0">, True, False</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_numpy_any(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">pos</span><span class="s0">, </span><span class="s1">neg):</span>
        <span class="s4"># GH 17570</span>
        <span class="s1">out = np.any(SparseArray(data))</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">out = np.any(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos))</span>
        <span class="s0">assert </span><span class="s1">out</span>

        <span class="s1">data[</span><span class="s2">1</span><span class="s1">] = neg</span>
        <span class="s1">out = np.any(SparseArray(data))</span>
        <span class="s0">assert not </span><span class="s1">out</span>

        <span class="s1">out = np.any(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=pos))</span>
        <span class="s0">assert not </span><span class="s1">out</span>

        <span class="s1">msg = </span><span class="s3">&quot;the 'out' parameter is not supported&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">np.any(SparseArray(data)</span><span class="s0">, </span><span class="s1">out=out)</span>

    <span class="s0">def </span><span class="s1">test_sum(self):</span>
        <span class="s1">data = np.arange(</span><span class="s2">10</span><span class="s1">).astype(float)</span>
        <span class="s1">out = SparseArray(data).sum()</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">45.0</span>

        <span class="s1">data[</span><span class="s2">5</span><span class="s1">] = np.nan</span>
        <span class="s1">out = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">2</span><span class="s1">).sum()</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">40.0</span>

        <span class="s1">out = SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=np.nan).sum()</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">40.0</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;arr&quot;</span><span class="s0">,</span>
        <span class="s1">[np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;min_count, expected&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.nan)])</span>
    <span class="s0">def </span><span class="s1">test_sum_min_count(self</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">fill_value</span><span class="s0">, </span><span class="s1">min_count</span><span class="s0">, </span><span class="s1">expected):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/25777</span>
        <span class="s1">sparray = SparseArray(arr</span><span class="s0">, </span><span class="s1">fill_value=fill_value)</span>
        <span class="s1">result = sparray.sum(min_count=min_count)</span>
        <span class="s0">if </span><span class="s1">np.isnan(expected):</span>
            <span class="s0">assert </span><span class="s1">np.isnan(result)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s0">def </span><span class="s1">test_bool_sum_min_count(self):</span>
        <span class="s1">spar_bool = pd.arrays.SparseArray(</span>
            <span class="s1">[</span><span class="s0">False, True</span><span class="s1">] * </span><span class="s2">5</span><span class="s0">, </span><span class="s1">dtype=np.bool8</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">res = spar_bool.sum(min_count=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">res == </span><span class="s2">5</span>
        <span class="s1">res = spar_bool.sum(min_count=</span><span class="s2">11</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isna(res)</span>

    <span class="s0">def </span><span class="s1">test_numpy_sum(self):</span>
        <span class="s1">data = np.arange(</span><span class="s2">10</span><span class="s1">).astype(float)</span>
        <span class="s1">out = np.sum(SparseArray(data))</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">45.0</span>

        <span class="s1">data[</span><span class="s2">5</span><span class="s1">] = np.nan</span>
        <span class="s1">out = np.sum(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">40.0</span>

        <span class="s1">out = np.sum(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=np.nan))</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">40.0</span>

        <span class="s1">msg = </span><span class="s3">&quot;the 'dtype' parameter is not supported&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">np.sum(SparseArray(data)</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>

        <span class="s1">msg = </span><span class="s3">&quot;the 'out' parameter is not supported&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">np.sum(SparseArray(data)</span><span class="s0">, </span><span class="s1">out=out)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;data,expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span><span class="s0">,  </span><span class="s4"># non-null data</span>
                <span class="s1">SparseArray(np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s0">, </span><span class="s2">10.0</span><span class="s0">, </span><span class="s2">15.0</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span><span class="s0">,  </span><span class="s4"># null data</span>
                <span class="s1">SparseArray(np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">7.0</span><span class="s0">, </span><span class="s2">12.0</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;numpy&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_cumsum(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">numpy):</span>
        <span class="s1">cumsum = np.cumsum </span><span class="s0">if </span><span class="s1">numpy </span><span class="s0">else lambda </span><span class="s1">s: s.cumsum()</span>

        <span class="s1">out = cumsum(SparseArray(data))</span>
        <span class="s1">tm.assert_sp_array_equal(out</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">out = cumsum(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=np.nan))</span>
        <span class="s1">tm.assert_sp_array_equal(out</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">out = cumsum(SparseArray(data</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">tm.assert_sp_array_equal(out</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s0">if </span><span class="s1">numpy:  </span><span class="s4"># numpy compatibility checks.</span>
            <span class="s1">msg = </span><span class="s3">&quot;the 'dtype' parameter is not supported&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">np.cumsum(SparseArray(data)</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>

            <span class="s1">msg = </span><span class="s3">&quot;the 'out' parameter is not supported&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">np.cumsum(SparseArray(data)</span><span class="s0">, </span><span class="s1">out=out)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">axis = </span><span class="s2">1  </span><span class="s4"># SparseArray currently 1-D, so only axis = 0 is valid.</span>
            <span class="s1">msg = re.escape(</span><span class="s3">f&quot;axis(=</span><span class="s0">{</span><span class="s1">axis</span><span class="s0">}</span><span class="s3">) out of bounds&quot;</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">SparseArray(data).cumsum(axis=axis)</span>

    <span class="s0">def </span><span class="s1">test_mean(self):</span>
        <span class="s1">data = np.arange(</span><span class="s2">10</span><span class="s1">).astype(float)</span>
        <span class="s1">out = SparseArray(data).mean()</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">4.5</span>

        <span class="s1">data[</span><span class="s2">5</span><span class="s1">] = np.nan</span>
        <span class="s1">out = SparseArray(data).mean()</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">40.0 </span><span class="s1">/ </span><span class="s2">9</span>

    <span class="s0">def </span><span class="s1">test_numpy_mean(self):</span>
        <span class="s1">data = np.arange(</span><span class="s2">10</span><span class="s1">).astype(float)</span>
        <span class="s1">out = np.mean(SparseArray(data))</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">4.5</span>

        <span class="s1">data[</span><span class="s2">5</span><span class="s1">] = np.nan</span>
        <span class="s1">out = np.mean(SparseArray(data))</span>
        <span class="s0">assert </span><span class="s1">out == </span><span class="s2">40.0 </span><span class="s1">/ </span><span class="s2">9</span>

        <span class="s1">msg = </span><span class="s3">&quot;the 'dtype' parameter is not supported&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">np.mean(SparseArray(data)</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>

        <span class="s1">msg = </span><span class="s3">&quot;the 'out' parameter is not supported&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">np.mean(SparseArray(data)</span><span class="s0">, </span><span class="s1">out=out)</span>

    <span class="s0">def </span><span class="s1">test_ufunc(self):</span>
        <span class="s4"># GH 13853 make sure ufunc is applied to fill_value</span>
        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">result = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">tm.assert_sp_array_equal(abs(sparse)</span><span class="s0">, </span><span class="s1">result)</span>
        <span class="s1">tm.assert_sp_array_equal(np.abs(sparse)</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">result = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sparse_index=sparse.sp_index</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(abs(sparse)</span><span class="s0">, </span><span class="s1">result)</span>
        <span class="s1">tm.assert_sp_array_equal(np.abs(sparse)</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">exp = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(abs(sparse)</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_sp_array_equal(np.abs(sparse)</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">result = SparseArray(np.sin([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]))</span>
        <span class="s1">tm.assert_sp_array_equal(np.sin(sparse)</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">result = SparseArray(np.sin([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=np.sin(</span><span class="s2">1</span><span class="s1">))</span>
        <span class="s1">tm.assert_sp_array_equal(np.sin(sparse)</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = SparseArray(np.sin([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">fill_value=np.sin(</span><span class="s2">0</span><span class="s1">))</span>
        <span class="s1">tm.assert_sp_array_equal(np.sin(sparse)</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_args(self):</span>
        <span class="s4"># GH 13853 make sure ufunc is applied to fill_value, including its arg</span>
        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">result = SparseArray([</span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">tm.assert_sp_array_equal(np.add(sparse</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">result = SparseArray([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(np.add(sparse</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">sparse = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = SparseArray([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_sp_array_equal(np.add(sparse</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">np.nan])</span>
    <span class="s0">def </span><span class="s1">test_modf(self</span><span class="s0">, </span><span class="s1">fill_value):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/26946</span>
        <span class="s1">sparse = SparseArray([fill_value] * </span><span class="s2">10 </span><span class="s1">+ [</span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">2.2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=fill_value)</span>
        <span class="s1">r1</span><span class="s0">, </span><span class="s1">r2 = np.modf(sparse)</span>
        <span class="s1">e1</span><span class="s0">, </span><span class="s1">e2 = np.modf(np.asarray(sparse))</span>
        <span class="s1">tm.assert_sp_array_equal(r1</span><span class="s0">, </span><span class="s1">SparseArray(e1</span><span class="s0">, </span><span class="s1">fill_value=fill_value))</span>
        <span class="s1">tm.assert_sp_array_equal(r2</span><span class="s0">, </span><span class="s1">SparseArray(e2</span><span class="s0">, </span><span class="s1">fill_value=fill_value))</span>

    <span class="s0">def </span><span class="s1">test_nbytes_integer(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span><span class="s1">)</span>
        <span class="s1">result = arr.nbytes</span>
        <span class="s4"># (2 * 8) + 2 * 4</span>
        <span class="s0">assert </span><span class="s1">result == </span><span class="s2">24</span>

    <span class="s0">def </span><span class="s1">test_nbytes_block(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s1">result = arr.nbytes</span>
        <span class="s4"># (2 * 8) + 4 + 4</span>
        <span class="s4"># sp_values, blocs, blengths</span>
        <span class="s0">assert </span><span class="s1">result == </span><span class="s2">24</span>

    <span class="s0">def </span><span class="s1">test_asarray_datetime64(self):</span>
        <span class="s1">s = SparseArray(pd.to_datetime([</span><span class="s3">&quot;2012&quot;</span><span class="s0">, None, None, </span><span class="s3">&quot;2013&quot;</span><span class="s1">]))</span>
        <span class="s1">np.asarray(s)</span>

    <span class="s0">def </span><span class="s1">test_density(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">arr.density == </span><span class="s2">0.5</span>

    <span class="s0">def </span><span class="s1">test_npoints(self):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">arr.npoints == </span><span class="s2">1</span>


<span class="s0">class </span><span class="s1">TestAccessor:</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;attr&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;npoints&quot;</span><span class="s0">, </span><span class="s3">&quot;density&quot;</span><span class="s0">, </span><span class="s3">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s3">&quot;sp_values&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_get_attributes(self</span><span class="s0">, </span><span class="s1">attr):</span>
        <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">ser = pd.Series(arr)</span>

        <span class="s1">result = getattr(ser.sparse</span><span class="s0">, </span><span class="s1">attr)</span>
        <span class="s1">expected = getattr(arr</span><span class="s0">, </span><span class="s1">attr)</span>
        <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s1">@td.skip_if_no_scipy</span>
    <span class="s0">def </span><span class="s1">test_from_coo(self):</span>
        <span class="s0">import </span><span class="s1">scipy.sparse</span>

        <span class="s1">row = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">col = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">data = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span>
        <span class="s4"># TODO(scipy#13585): Remove dtype when scipy is fixed</span>
        <span class="s4"># https://github.com/scipy/scipy/issues/13585</span>
        <span class="s1">sp_array = scipy.sparse.coo_matrix((data</span><span class="s0">, </span><span class="s1">(row</span><span class="s0">, </span><span class="s1">col))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int&quot;</span><span class="s1">)</span>
        <span class="s1">result = pd.Series.sparse.from_coo(sp_array)</span>

        <span class="s1">index = pd.MultiIndex.from_arrays([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]])</span>
        <span class="s1">expected = pd.Series([</span><span class="s2">4</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Sparse[int]&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@td.skip_if_no_scipy</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;sort_labels, expected_rows, expected_cols, expected_values_pos&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s0">False,</span>
                <span class="s1">[(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">[(</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">{</span><span class="s2">1</span><span class="s1">: (</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: (</span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s0">True,</span>
                <span class="s1">[(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">[(</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">{</span><span class="s2">1</span><span class="s1">: (</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: (</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_to_coo(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">sort_labels</span><span class="s0">, </span><span class="s1">expected_rows</span><span class="s0">, </span><span class="s1">expected_cols</span><span class="s0">, </span><span class="s1">expected_values_pos</span>
    <span class="s1">):</span>
        <span class="s0">import </span><span class="s1">scipy.sparse</span>

        <span class="s1">values = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, None, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">index = pd.MultiIndex.from_tuples(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">ss = pd.Series(values</span><span class="s0">, </span><span class="s1">index=index)</span>

        <span class="s1">expected_A = np.zeros((</span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">))</span>
        <span class="s0">for </span><span class="s1">value</span><span class="s0">, </span><span class="s1">(row</span><span class="s0">, </span><span class="s1">col) </span><span class="s0">in </span><span class="s1">expected_values_pos.items():</span>
            <span class="s1">expected_A[row</span><span class="s0">, </span><span class="s1">col] = value</span>

        <span class="s1">A</span><span class="s0">, </span><span class="s1">rows</span><span class="s0">, </span><span class="s1">cols = ss.sparse.to_coo(</span>
            <span class="s1">row_levels=(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">column_levels=(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">sort_labels=sort_labels</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(A</span><span class="s0">, </span><span class="s1">scipy.sparse.coo_matrix)</span>
        <span class="s1">tm.assert_numpy_array_equal(A.toarray()</span><span class="s0">, </span><span class="s1">expected_A)</span>
        <span class="s0">assert </span><span class="s1">rows == expected_rows</span>
        <span class="s0">assert </span><span class="s1">cols == expected_cols</span>

    <span class="s0">def </span><span class="s1">test_non_sparse_raises(self):</span>
        <span class="s1">ser = pd.Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">pytest.raises(AttributeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;.sparse&quot;</span><span class="s1">):</span>
            <span class="s1">ser.sparse.density</span>


<span class="s0">def </span><span class="s1">test_setting_fill_value_fillna_still_works():</span>
    <span class="s4"># This is why letting users update fill_value / dtype is bad</span>
    <span class="s4"># astype has the same problem.</span>
    <span class="s1">arr = SparseArray([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0.0</span><span class="s1">)</span>
    <span class="s1">arr.fill_value = np.nan</span>
    <span class="s1">result = arr.isna()</span>
    <span class="s4"># Can't do direct comparison, since the sp_index will be different</span>
    <span class="s4"># So let's convert to ndarray and check there.</span>
    <span class="s1">result = np.asarray(result)</span>

    <span class="s1">expected = np.array([</span><span class="s0">False, True, False</span><span class="s1">])</span>
    <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_setting_fill_value_updates():</span>
    <span class="s1">arr = SparseArray([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">arr.fill_value = np.nan</span>
    <span class="s4"># use private constructor to get the index right</span>
    <span class="s4"># otherwise both nans would be un-stored.</span>
    <span class="s1">expected = SparseArray._simple_new(</span>
        <span class="s1">sparse_array=np.array([np.nan])</span><span class="s0">,</span>
        <span class="s1">sparse_index=IntIndex(</span><span class="s2">2</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">dtype=SparseDtype(float</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_sp_array_equal(arr</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;arr, loc&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s0">None, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s2">0</span><span class="s0">, None, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([]</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_first_fill_value_loc(arr</span><span class="s0">, </span><span class="s1">loc):</span>
    <span class="s1">result = SparseArray(arr)._first_fill_value_loc()</span>
    <span class="s0">assert </span><span class="s1">result == loc</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;arr&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_unique_na_fill(arr</span><span class="s0">, </span><span class="s1">fill_value):</span>
    <span class="s1">a = SparseArray(arr</span><span class="s0">, </span><span class="s1">fill_value=fill_value).unique()</span>
    <span class="s1">b = pd.Series(arr).unique()</span>
    <span class="s0">assert </span><span class="s1">isinstance(a</span><span class="s0">, </span><span class="s1">SparseArray)</span>
    <span class="s1">a = np.asarray(a)</span>
    <span class="s1">tm.assert_numpy_array_equal(a</span><span class="s0">, </span><span class="s1">b)</span>


<span class="s0">def </span><span class="s1">test_unique_all_sparse():</span>
    <span class="s4"># https://github.com/pandas-dev/pandas/issues/23168</span>
    <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
    <span class="s1">result = arr.unique()</span>
    <span class="s1">expected = SparseArray([</span><span class="s2">0</span><span class="s1">])</span>
    <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_map():</span>
    <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">expected = SparseArray([</span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">10</span><span class="s1">)</span>

    <span class="s4"># dict</span>
    <span class="s1">result = arr.map({</span><span class="s2">0</span><span class="s1">: </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">12</span><span class="s1">})</span>
    <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># series</span>
    <span class="s1">result = arr.map(pd.Series({</span><span class="s2">0</span><span class="s1">: </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">12</span><span class="s1">}))</span>
    <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># function</span>
    <span class="s1">result = arr.map(pd.Series({</span><span class="s2">0</span><span class="s1">: </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">12</span><span class="s1">}))</span>
    <span class="s1">expected = SparseArray([</span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">10</span><span class="s1">)</span>
    <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_map_missing():</span>
    <span class="s1">arr = SparseArray([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">expected = SparseArray([</span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">10</span><span class="s1">)</span>

    <span class="s1">result = arr.map({</span><span class="s2">0</span><span class="s1">: </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s1">})</span>
    <span class="s1">tm.assert_sp_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;fill_value&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_dropna(fill_value):</span>
    <span class="s4"># GH-28287</span>
    <span class="s1">arr = SparseArray([np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=fill_value)</span>
    <span class="s1">exp = SparseArray([</span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=fill_value)</span>
    <span class="s1">tm.assert_sp_array_equal(arr.dropna()</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: arr})</span>
    <span class="s1">expected_df = pd.DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: exp}</span><span class="s0">, </span><span class="s1">index=Int64Index([</span><span class="s2">1</span><span class="s1">]))</span>
    <span class="s1">tm.assert_equal(df.dropna()</span><span class="s0">, </span><span class="s1">expected_df)</span>


<span class="s0">def </span><span class="s1">test_drop_duplicates_fill_value():</span>
    <span class="s4"># GH 11726</span>
    <span class="s1">df = pd.DataFrame(np.zeros((</span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s1">))).apply(</span><span class="s0">lambda </span><span class="s1">x: SparseArray(x</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">))</span>
    <span class="s1">result = df.drop_duplicates()</span>
    <span class="s1">expected = pd.DataFrame({i: SparseArray([</span><span class="s2">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">5</span><span class="s1">)})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">class </span><span class="s1">TestMinMax:</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;raw_data,max_expected,min_expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(np.arange(</span><span class="s2">5.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(-np.arange(</span><span class="s2">5.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">4</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(np.array([np.nan] * </span><span class="s2">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[np.nan]</span><span class="s0">, </span><span class="s1">[np.nan])</span><span class="s0">,</span>
            <span class="s1">(np.array([])</span><span class="s0">, </span><span class="s1">[np.nan]</span><span class="s0">, </span><span class="s1">[np.nan])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_nan_fill_value(self</span><span class="s0">, </span><span class="s1">raw_data</span><span class="s0">, </span><span class="s1">max_expected</span><span class="s0">, </span><span class="s1">min_expected):</span>
        <span class="s1">arr = SparseArray(raw_data)</span>
        <span class="s1">max_result = arr.max()</span>
        <span class="s1">min_result = arr.min()</span>
        <span class="s0">assert </span><span class="s1">max_result </span><span class="s0">in </span><span class="s1">max_expected</span>
        <span class="s0">assert </span><span class="s1">min_result </span><span class="s0">in </span><span class="s1">min_expected</span>

        <span class="s1">max_result = arr.max(skipna=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">min_result = arr.min(skipna=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">np.isnan(raw_data).any():</span>
            <span class="s0">assert </span><span class="s1">np.isnan(max_result)</span>
            <span class="s0">assert </span><span class="s1">np.isnan(min_result)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">max_result </span><span class="s0">in </span><span class="s1">max_expected</span>
            <span class="s0">assert </span><span class="s1">min_result </span><span class="s0">in </span><span class="s1">min_expected</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;fill_value,max_expected,min_expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">100</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(-</span><span class="s2">100</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">100</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_fill_value(self</span><span class="s0">, </span><span class="s1">fill_value</span><span class="s0">, </span><span class="s1">max_expected</span><span class="s0">, </span><span class="s1">min_expected):</span>
        <span class="s1">arr = SparseArray(</span>
            <span class="s1">np.array([fill_value</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(</span><span class="s3">&quot;int&quot;</span><span class="s0">, </span><span class="s1">fill_value)</span>
        <span class="s1">)</span>
        <span class="s1">max_result = arr.max()</span>
        <span class="s0">assert </span><span class="s1">max_result == max_expected</span>

        <span class="s1">min_result = arr.min()</span>
        <span class="s0">assert </span><span class="s1">min_result == min_expected</span>

    <span class="s0">def </span><span class="s1">test_only_fill_value(self):</span>
        <span class="s1">fv = </span><span class="s2">100</span>
        <span class="s1">arr = SparseArray(np.array([fv</span><span class="s0">, </span><span class="s1">fv</span><span class="s0">, </span><span class="s1">fv])</span><span class="s0">, </span><span class="s1">dtype=SparseDtype(</span><span class="s3">&quot;int&quot;</span><span class="s0">, </span><span class="s1">fv))</span>
        <span class="s0">assert </span><span class="s1">len(arr._valid_sp_values) == </span><span class="s2">0</span>

        <span class="s0">assert </span><span class="s1">arr.max() == fv</span>
        <span class="s0">assert </span><span class="s1">arr.min() == fv</span>
        <span class="s0">assert </span><span class="s1">arr.max(skipna=</span><span class="s0">False</span><span class="s1">) == fv</span>
        <span class="s0">assert </span><span class="s1">arr.min(skipna=</span><span class="s0">False</span><span class="s1">) == fv</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;data&quot;</span><span class="s0">, </span><span class="s1">[np.array([])</span><span class="s0">, </span><span class="s1">np.array([np.nan</span><span class="s0">, </span><span class="s1">np.nan])])</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;dtype,expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(SparseDtype(np.float64</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
            <span class="s1">(SparseDtype(np.float64</span><span class="s0">, </span><span class="s2">5.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
            <span class="s1">(SparseDtype(</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s0">, </span><span class="s1">pd.NaT)</span><span class="s0">, </span><span class="s1">pd.NaT)</span><span class="s0">,</span>
            <span class="s1">(SparseDtype(</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s0">, </span><span class="s1">pd.to_datetime(</span><span class="s3">&quot;2018-05-05&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">pd.NaT)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_na_value_if_no_valid_values(self</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">expected):</span>
        <span class="s1">arr = SparseArray(data</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">result = getattr(arr</span><span class="s0">, </span><span class="s1">func)()</span>
        <span class="s0">if </span><span class="s1">expected </span><span class="s0">is </span><span class="s1">pd.NaT:</span>
            <span class="s4"># TODO: pin down whether we wrap datetime64(&quot;NaT&quot;)</span>
            <span class="s0">assert </span><span class="s1">result </span><span class="s0">is </span><span class="s1">pd.NaT </span><span class="s0">or </span><span class="s1">np.isnat(result)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">np.isnan(result)</span>
</pre>
</body>
</html>