<html>
<head>
<title>test_nditer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #a5c261;}
.s6 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_nditer.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">textwrap</span>
<span class="s0">import </span><span class="s1">subprocess</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">numpy.core._multiarray_tests </span><span class="s0">as </span><span class="s1">_multiarray_tests</span>
<span class="s0">from </span><span class="s1">numpy </span><span class="s0">import </span><span class="s1">array</span><span class="s0">, </span><span class="s1">arange</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">all</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_array_equal</span><span class="s0">, </span><span class="s1">assert_raises</span><span class="s0">,</span>
    <span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">suppress_warnings</span><span class="s0">, </span><span class="s1">break_cycles</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">iter_multi_index(i):</span>
    <span class="s1">ret = []</span>
    <span class="s0">while not </span><span class="s1">i.finished:</span>
        <span class="s1">ret.append(i.multi_index)</span>
        <span class="s1">i.iternext()</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s0">def </span><span class="s1">iter_indices(i):</span>
    <span class="s1">ret = []</span>
    <span class="s0">while not </span><span class="s1">i.finished:</span>
        <span class="s1">ret.append(i.index)</span>
        <span class="s1">i.iternext()</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s0">def </span><span class="s1">iter_iterindices(i):</span>
    <span class="s1">ret = []</span>
    <span class="s0">while not </span><span class="s1">i.finished:</span>
        <span class="s1">ret.append(i.iterindex)</span>
        <span class="s1">i.iternext()</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;Python lacks refcounts&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_refcount():</span>
    <span class="s3"># Make sure the iterator doesn't leak</span>

    <span class="s3"># Basic</span>
    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">dt = np.dtype(</span><span class="s2">'f4'</span><span class="s1">).newbyteorder()</span>
    <span class="s1">rc_a = sys.getrefcount(a)</span>
    <span class="s1">rc_dt = sys.getrefcount(dt)</span>
    <span class="s0">with </span><span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[dt]) </span><span class="s0">as </span><span class="s1">it:</span>
        <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">it.iterationneedsapi)</span>
        <span class="s1">assert_(sys.getrefcount(a) &gt; rc_a)</span>
        <span class="s1">assert_(sys.getrefcount(dt) &gt; rc_dt)</span>
    <span class="s3"># del 'it'</span>
    <span class="s1">it = </span><span class="s0">None</span>
    <span class="s1">assert_equal(sys.getrefcount(a)</span><span class="s0">, </span><span class="s1">rc_a)</span>
    <span class="s1">assert_equal(sys.getrefcount(dt)</span><span class="s0">, </span><span class="s1">rc_dt)</span>

    <span class="s3"># With a copy</span>
    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">dt = np.dtype(</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">rc_a = sys.getrefcount(a)</span>
    <span class="s1">rc_dt = sys.getrefcount(dt)</span>
    <span class="s1">it = nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[dt])</span>
    <span class="s1">rc2_a = sys.getrefcount(a)</span>
    <span class="s1">rc2_dt = sys.getrefcount(dt)</span>
    <span class="s1">it2 = it.copy()</span>
    <span class="s1">assert_(sys.getrefcount(a) &gt; rc2_a)</span>
    <span class="s1">assert_(sys.getrefcount(dt) &gt; rc2_dt)</span>
    <span class="s1">it = </span><span class="s0">None</span>
    <span class="s1">assert_equal(sys.getrefcount(a)</span><span class="s0">, </span><span class="s1">rc2_a)</span>
    <span class="s1">assert_equal(sys.getrefcount(dt)</span><span class="s0">, </span><span class="s1">rc2_dt)</span>
    <span class="s1">it2 = </span><span class="s0">None</span>
    <span class="s1">assert_equal(sys.getrefcount(a)</span><span class="s0">, </span><span class="s1">rc_a)</span>
    <span class="s1">assert_equal(sys.getrefcount(dt)</span><span class="s0">, </span><span class="s1">rc_dt)</span>

    <span class="s0">del </span><span class="s1">it2  </span><span class="s3"># avoid pyflakes unused variable warning</span>

<span class="s0">def </span><span class="s1">test_iter_best_order():</span>
    <span class="s3"># The iterator should always find the iteration order</span>
    <span class="s3"># with increasing memory addresses</span>

    <span class="s3"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]:</span>
        <span class="s1">a = arange(np.prod(shape))</span>
        <span class="s3"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">**len(shape)):</span>
            <span class="s1">dirs_index = [slice(</span><span class="s0">None</span><span class="s1">)]*len(shape)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range(len(shape)):</span>
                <span class="s0">if </span><span class="s1">((</span><span class="s4">2</span><span class="s1">**bit) &amp; dirs):</span>
                    <span class="s1">dirs_index[bit] = slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">dirs_index = tuple(dirs_index)</span>

            <span class="s1">aview = a.reshape(shape)[dirs_index]</span>
            <span class="s3"># C-order</span>
            <span class="s1">i = nditer(aview</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s3"># Fortran-order</span>
            <span class="s1">i = nditer(aview.T</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s3"># Other order</span>
            <span class="s0">if </span><span class="s1">len(shape) &gt; </span><span class="s4">2</span><span class="s1">:</span>
                <span class="s1">i = nditer(aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
                <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a)</span>

<span class="s0">def </span><span class="s1">test_iter_c_order():</span>
    <span class="s3"># Test forcing C order</span>

    <span class="s3"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]:</span>
        <span class="s1">a = arange(np.prod(shape))</span>
        <span class="s3"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">**len(shape)):</span>
            <span class="s1">dirs_index = [slice(</span><span class="s0">None</span><span class="s1">)]*len(shape)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range(len(shape)):</span>
                <span class="s0">if </span><span class="s1">((</span><span class="s4">2</span><span class="s1">**bit) &amp; dirs):</span>
                    <span class="s1">dirs_index[bit] = slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">dirs_index = tuple(dirs_index)</span>

            <span class="s1">aview = a.reshape(shape)[dirs_index]</span>
            <span class="s3"># C-order</span>
            <span class="s1">i = nditer(aview</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">aview.ravel(order=</span><span class="s2">'C'</span><span class="s1">))</span>
            <span class="s3"># Fortran-order</span>
            <span class="s1">i = nditer(aview.T</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">aview.T.ravel(order=</span><span class="s2">'C'</span><span class="s1">))</span>
            <span class="s3"># Other order</span>
            <span class="s0">if </span><span class="s1">len(shape) &gt; </span><span class="s4">2</span><span class="s1">:</span>
                <span class="s1">i = nditer(aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
                <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">,</span>
                                    <span class="s1">aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">).ravel(order=</span><span class="s2">'C'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_f_order():</span>
    <span class="s3"># Test forcing F order</span>

    <span class="s3"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]:</span>
        <span class="s1">a = arange(np.prod(shape))</span>
        <span class="s3"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">**len(shape)):</span>
            <span class="s1">dirs_index = [slice(</span><span class="s0">None</span><span class="s1">)]*len(shape)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range(len(shape)):</span>
                <span class="s0">if </span><span class="s1">((</span><span class="s4">2</span><span class="s1">**bit) &amp; dirs):</span>
                    <span class="s1">dirs_index[bit] = slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">dirs_index = tuple(dirs_index)</span>

            <span class="s1">aview = a.reshape(shape)[dirs_index]</span>
            <span class="s3"># C-order</span>
            <span class="s1">i = nditer(aview</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s1">)</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">aview.ravel(order=</span><span class="s2">'F'</span><span class="s1">))</span>
            <span class="s3"># Fortran-order</span>
            <span class="s1">i = nditer(aview.T</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s1">)</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">aview.T.ravel(order=</span><span class="s2">'F'</span><span class="s1">))</span>
            <span class="s3"># Other order</span>
            <span class="s0">if </span><span class="s1">len(shape) &gt; </span><span class="s4">2</span><span class="s1">:</span>
                <span class="s1">i = nditer(aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s1">)</span>
                <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">,</span>
                                    <span class="s1">aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">).ravel(order=</span><span class="s2">'F'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_c_or_f_order():</span>
    <span class="s3"># Test forcing any contiguous (C or F) order</span>

    <span class="s3"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]:</span>
        <span class="s1">a = arange(np.prod(shape))</span>
        <span class="s3"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">**len(shape)):</span>
            <span class="s1">dirs_index = [slice(</span><span class="s0">None</span><span class="s1">)]*len(shape)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range(len(shape)):</span>
                <span class="s0">if </span><span class="s1">((</span><span class="s4">2</span><span class="s1">**bit) &amp; dirs):</span>
                    <span class="s1">dirs_index[bit] = slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">dirs_index = tuple(dirs_index)</span>

            <span class="s1">aview = a.reshape(shape)[dirs_index]</span>
            <span class="s3"># C-order</span>
            <span class="s1">i = nditer(aview</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'A'</span><span class="s1">)</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">aview.ravel(order=</span><span class="s2">'A'</span><span class="s1">))</span>
            <span class="s3"># Fortran-order</span>
            <span class="s1">i = nditer(aview.T</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'A'</span><span class="s1">)</span>
            <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">aview.T.ravel(order=</span><span class="s2">'A'</span><span class="s1">))</span>
            <span class="s3"># Other order</span>
            <span class="s0">if </span><span class="s1">len(shape) &gt; </span><span class="s4">2</span><span class="s1">:</span>
                <span class="s1">i = nditer(aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'A'</span><span class="s1">)</span>
                <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">,</span>
                                    <span class="s1">aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">).ravel(order=</span><span class="s2">'A'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_nditer_multi_index_set():</span>
    <span class="s3"># Test the multi_index set</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">it = np.nditer(a</span><span class="s0">, </span><span class="s1">flags=[</span><span class="s2">'multi_index'</span><span class="s1">])</span>

    <span class="s3"># Removes the iteration on two first elements of a[0]</span>
    <span class="s1">it.multi_index = (</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">assert_equal([i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">it]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    
<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;Python lacks refcounts&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_nditer_multi_index_set_refcount():</span>
    <span class="s3"># Test if the reference count on index variable is decreased</span>
    
    <span class="s1">index = </span><span class="s4">0</span>
    <span class="s1">i = np.nditer(np.array([</span><span class="s4">111</span><span class="s0">, </span><span class="s4">222</span><span class="s0">, </span><span class="s4">333</span><span class="s0">, </span><span class="s4">444</span><span class="s1">])</span><span class="s0">, </span><span class="s1">flags=[</span><span class="s2">'multi_index'</span><span class="s1">])</span>

    <span class="s1">start_count = sys.getrefcount(index)</span>
    <span class="s1">i.multi_index = (index</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">end_count = sys.getrefcount(index)</span>
    
    <span class="s1">assert_equal(start_count</span><span class="s0">, </span><span class="s1">end_count)</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_multi_index_1d():</span>
    <span class="s3"># The multi-indices should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">4</span><span class="s1">)</span>
    <span class="s3"># 1D order</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">,</span><span class="s1">)])</span>
    <span class="s3"># 1D reversed order</span>
    <span class="s1">i = nditer(a[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">)])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_multi_index_2d():</span>
    <span class="s3"># The multi-indices should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s3"># 2D C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>
    <span class="s3"># 2D Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>
    <span class="s3"># 2D reversed C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span>
    <span class="s3"># 2D reversed Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                                   <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                                   <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_multi_index_3d():</span>
    <span class="s3"># The multi-indices should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">)</span>
    <span class="s3"># 3D C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>
    <span class="s3"># 3D Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>
    <span class="s3"># 3D reversed C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span>
    <span class="s3"># 3D reversed Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                                    <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                                    <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                                    <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_multi_index(i)</span><span class="s0">,</span>
                            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_c_index_1d():</span>
    <span class="s3"># The C index should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">4</span><span class="s1">)</span>
    <span class="s3"># 1D order</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
    <span class="s3"># 1D reversed order</span>
    <span class="s1">i = nditer(a[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_c_index_2d():</span>
    <span class="s3"># The C index should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s3"># 2D C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s3"># 2D Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s3"># 2D reversed C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
    <span class="s3"># 2D reversed Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_c_index_3d():</span>
    <span class="s3"># The C index should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">)</span>
    <span class="s3"># 3D C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">])</span>
    <span class="s3"># 3D Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">11</span><span class="s1">])</span>
    <span class="s3"># 3D reversed C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
    <span class="s3"># 3D reversed Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_f_index_1d():</span>
    <span class="s3"># The Fortran index should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">4</span><span class="s1">)</span>
    <span class="s3"># 1D order</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
    <span class="s3"># 1D reversed order</span>
    <span class="s1">i = nditer(a[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_f_index_2d():</span>
    <span class="s3"># The Fortran index should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s3"># 2D C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s3"># 2D Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s3"># 2D reversed C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
    <span class="s3"># 2D reversed Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_f_index_3d():</span>
    <span class="s3"># The Fortran index should be correct with any reordering</span>

    <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">)</span>
    <span class="s3"># 3D C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">11</span><span class="s1">])</span>
    <span class="s3"># 3D Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">])</span>
    <span class="s3"># 3D reversed C-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s3"># 3D reversed Fortran-order</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">])</span>
    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).copy(order=</span><span class="s2">'F'</span><span class="s1">)[:</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(iter_indices(i)</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_no_inner_full_coalesce():</span>
    <span class="s3"># Check no_inner iterators which coalesce into a single inner loop</span>

    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]:</span>
        <span class="s1">size = np.prod(shape)</span>
        <span class="s1">a = arange(size)</span>
        <span class="s3"># Test each combination of forward and backwards indexing</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">**len(shape)):</span>
            <span class="s1">dirs_index = [slice(</span><span class="s0">None</span><span class="s1">)]*len(shape)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range(len(shape)):</span>
                <span class="s0">if </span><span class="s1">((</span><span class="s4">2</span><span class="s1">**bit) &amp; dirs):</span>
                    <span class="s1">dirs_index[bit] = slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">dirs_index = tuple(dirs_index)</span>

            <span class="s1">aview = a.reshape(shape)[dirs_index]</span>
            <span class="s3"># C-order</span>
            <span class="s1">i = nditer(aview</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
            <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(size</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s3"># Fortran-order</span>
            <span class="s1">i = nditer(aview.T</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
            <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(size</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s3"># Other order</span>
            <span class="s0">if </span><span class="s1">len(shape) &gt; </span><span class="s4">2</span><span class="s1">:</span>
                <span class="s1">i = nditer(aview.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
                <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
                <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(size</span><span class="s0">,</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_no_inner_dim_coalescing():</span>
    <span class="s3"># Check no_inner iterators whose dimensions may not coalesce completely</span>

    <span class="s3"># Skipping the last element in a dimension prevents coalescing</span>
    <span class="s3"># with the next-bigger dimension</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)[:</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">:-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">:-</span><span class="s4">1</span><span class="s0">,</span><span class="s1">:]</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)[:-</span><span class="s4">1</span><span class="s0">,</span><span class="s1">:</span><span class="s0">,</span><span class="s1">:]</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">12</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s3"># Even with lots of 1-sized dimensions, should still coalesce</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">24</span><span class="s0">,</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_dim_coalescing():</span>
    <span class="s3"># Check that the correct number of dimensions are coalesced</span>

    <span class="s3"># Tracking a multi-index disables coalescing</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

    <span class="s3"># A tracked index can allow coalescing if it's compatible with the array</span>
    <span class="s1">a3d = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d.T</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d.T</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d.T.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

    <span class="s3"># When C or F order is forced, coalescing may still occur</span>
    <span class="s1">a3d = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d.T</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d.T</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'A'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(a3d.T</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'A'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_iter_broadcasting():</span>
    <span class="s3"># Standard NumPy broadcasting rules</span>

    <span class="s3"># 1D with scalar</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32(</span><span class="s4">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">6</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s3"># 2D with scalar</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32(</span><span class="s4">2</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s3"># 2D with 1D</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s3"># 2D with 2D</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>

    <span class="s3"># 3D with scalar</span>
    <span class="s1">i = nditer([np.int32(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s3"># 3D with 1D</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">8</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s3"># 3D with 2D</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">8</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s3"># 3D with 3D</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">i = nditer([arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_itershape():</span>
    <span class="s3"># Check that allocated outputs work with a specified shape</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i2'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">itershape=(-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">24</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

    <span class="s1">i = nditer([a.T</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">itershape=(-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">, </span><span class="s4">24</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

    <span class="s1">i = nditer([a.T</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">order=</span><span class="s2">'F'</span><span class="s0">,</span>
                            <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">itershape=(-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">12</span><span class="s1">))</span>

    <span class="s3"># If we specify 1 in the itershape, it shouldn't allow broadcasting</span>
    <span class="s3"># of that dimension to a bigger value</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                            <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">itershape=(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s3"># Test bug that for no op_axes but itershape, they are NULLed correctly</span>
    <span class="s1">i = np.nditer([np.ones(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">itershape=(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_broadcasting_errors():</span>
    <span class="s3"># Check that errors are thrown for bad broadcasting shapes</span>

    <span class="s3"># 1D with 1D</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[arange(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s3"># 2D with 1D</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">,</span>
                    <span class="s1">[arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s3"># 2D with 2D</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">,</span>
                    <span class="s1">[arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">9</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">,</span>
                    <span class="s1">[arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s3"># 3D with 3D</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">,</span>
                    <span class="s1">[arange(</span><span class="s4">36</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">,</span>
                    <span class="s1">[arange(</span><span class="s4">8</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s3"># Verify that the error message mentions the right shapes</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">nditer([arange(</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">arange(</span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
               <span class="s1">[]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'no_broadcast'</span><span class="s1">]])</span>
        <span class="s0">raise </span><span class="s1">AssertionError(</span><span class="s2">'Should have raised a broadcast error'</span><span class="s1">)</span>
    <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s1">msg = str(e)</span>
        <span class="s3"># The message should contain the shape of the 3rd operand</span>
        <span class="s1">assert_(msg.find(</span><span class="s2">'(2,3)'</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s0">,</span>
                <span class="s2">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s2">t contain operand shape (2,3)' </span><span class="s1">% msg)</span>
        <span class="s3"># The message should contain the broadcast shape</span>
        <span class="s1">assert_(msg.find(</span><span class="s2">'(1,2,3)'</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s0">,</span>
                <span class="s2">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s2">t contain broadcast shape (1,2,3)' </span><span class="s1">% msg)</span>

    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">nditer([arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s1">)]</span><span class="s0">,</span>
               <span class="s1">[]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">,</span>
               <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">np.newaxis]]</span><span class="s0">,</span>
               <span class="s1">itershape=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s0">raise </span><span class="s1">AssertionError(</span><span class="s2">'Should have raised a broadcast error'</span><span class="s1">)</span>
    <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s1">msg = str(e)</span>
        <span class="s3"># The message should contain &quot;shape-&gt;remappedshape&quot; for each operand</span>
        <span class="s1">assert_(msg.find(</span><span class="s2">'(2,3)-&gt;(2,3)'</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s0">,</span>
            <span class="s2">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s2">t contain operand shape (2,3)-&gt;(2,3)' </span><span class="s1">% msg)</span>
        <span class="s1">assert_(msg.find(</span><span class="s2">'(2,)-&gt;(2,newaxis)'</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s2">t contain remapped operand shape' </span><span class="s1">+</span>
                <span class="s2">'(2,)-&gt;(2,newaxis)'</span><span class="s1">) % msg)</span>
        <span class="s3"># The message should contain the itershape parameter</span>
        <span class="s1">assert_(msg.find(</span><span class="s2">'(4,3)'</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s0">,</span>
                <span class="s2">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s2">t contain itershape parameter (4,3)' </span><span class="s1">% msg)</span>

    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">nditer([np.zeros((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))]</span><span class="s0">,</span>
               <span class="s1">[]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'no_broadcast'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
        <span class="s0">raise </span><span class="s1">AssertionError(</span><span class="s2">'Should have raised a broadcast error'</span><span class="s1">)</span>
    <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s1">msg = str(e)</span>
        <span class="s3"># The message should contain the shape of the bad operand</span>
        <span class="s1">assert_(msg.find(</span><span class="s2">'(2,1,1)'</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s0">,</span>
            <span class="s2">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s2">t contain operand shape (2,1,1)' </span><span class="s1">% msg)</span>
        <span class="s3"># The message should contain the broadcast shape</span>
        <span class="s1">assert_(msg.find(</span><span class="s2">'(2,1,2)'</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s0">,</span>
                <span class="s2">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s2">t contain the broadcast shape (2,1,2)' </span><span class="s1">% msg)</span>

<span class="s0">def </span><span class="s1">test_iter_flags_errors():</span>
    <span class="s3"># Check that bad combinations of flags produce errors</span>

    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>

    <span class="s3"># Not enough operands</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[])</span>
    <span class="s3"># Too many operands</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a]*</span><span class="s4">100</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s3"># Bad global flag</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'bad flag'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s3"># Bad op flag</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'bad flag'</span><span class="s1">]])</span>
    <span class="s3"># Bad order parameter</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'G'</span><span class="s1">)</span>
    <span class="s3"># Bad casting parameter</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">'noon'</span><span class="s1">)</span>
    <span class="s3"># op_flags must match ops</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a]*</span><span class="s4">3</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s3"># Cannot track both a C and an F index</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">'c_index'</span><span class="s0">, </span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s3"># Inner iteration and multi-indices/indices are incompatible</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">'external_loop'</span><span class="s0">, </span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">'external_loop'</span><span class="s0">, </span><span class="s2">'c_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">'external_loop'</span><span class="s0">, </span><span class="s2">'f_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s3"># Must specify exactly one of readwrite/readonly/writeonly per operand</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'writeonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'readwrite'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'readwrite'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">,</span>
                <span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'readwrite'</span><span class="s1">]])</span>
    <span class="s3"># Python scalars are always readonly</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]])</span>
    <span class="s3"># Array scalars are always readonly</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">np.int32(</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">np.int32(</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]])</span>
    <span class="s3"># Check readonly array</span>
    <span class="s1">a.flags.writeable = </span><span class="s0">False</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]])</span>
    <span class="s1">a.flags.writeable = </span><span class="s0">True</span>
    <span class="s3"># Multi-indices available only with the multi_index flag</span>
    <span class="s1">i = nditer(arange(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda </span><span class="s1">i:i.multi_index</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s3"># Index available only with an index flag</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda </span><span class="s1">i:i.index</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s3"># GotoCoords and GotoIndex incompatible with buffering or no_inner</span>

    <span class="s0">def </span><span class="s1">assign_multi_index(i):</span>
        <span class="s1">i.multi_index = (</span><span class="s4">0</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">assign_index(i):</span>
        <span class="s1">i.index = </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">assign_iterindex(i):</span>
        <span class="s1">i.iterindex = </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">assign_iterrange(i):</span>
        <span class="s1">i.iterrange = (</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(arange(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_multi_index</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_index</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_iterindex</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_iterrange</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">i = nditer(arange(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_multi_index</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_index</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_iterrange</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s3"># Can't iterate if size is zero</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">np.array([]))</span>

<span class="s0">def </span><span class="s1">test_iter_slice():</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c = np.arange(</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">3.</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">i[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">] = (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(c</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">i[</span><span class="s4">1</span><span class="s1">] = </span><span class="s4">12</span>
        <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">12</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_assign_mapping():</span>
    <span class="s1">a = np.arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).T</span>
    <span class="s1">it = np.nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                       <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s1">it.operands[</span><span class="s4">0</span><span class="s1">][...] = </span><span class="s4">3</span>
        <span class="s1">it.operands[</span><span class="s4">0</span><span class="s1">][...] = </span><span class="s4">14</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">14</span><span class="s1">)</span>
    <span class="s1">it = np.nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                       <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s1">x = it.operands[</span><span class="s4">0</span><span class="s1">][-</span><span class="s4">1</span><span class="s1">:</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">x[...] = </span><span class="s4">14</span>
        <span class="s1">it.operands[</span><span class="s4">0</span><span class="s1">][...] = -</span><span class="s4">1234</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1234</span><span class="s1">)</span>
    <span class="s3"># check for no warnings on dealloc</span>
    <span class="s1">x = </span><span class="s0">None</span>
    <span class="s1">it = </span><span class="s0">None</span>

<span class="s0">def </span><span class="s1">test_iter_nbo_align_contig():</span>
    <span class="s3"># Check that byte order, alignment, and contig changes work</span>

    <span class="s3"># Byte order change by requesting a specific dtype</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">au = a.byteswap().newbyteorder()</span>
    <span class="s1">assert_(a.dtype.byteorder != au.dtype.byteorder)</span>
    <span class="s1">i = nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s3"># context manager triggers UPDATEIFCOPY on i at exit</span>
        <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">].byteorder</span><span class="s0">, </span><span class="s1">a.dtype.byteorder)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype.byteorder</span><span class="s0">, </span><span class="s1">a.dtype.byteorder)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">i.operands[</span><span class="s4">0</span><span class="s1">][:] = </span><span class="s4">2</span>
    <span class="s1">assert_equal(au</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]*</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s0">del </span><span class="s1">i  </span><span class="s3"># should not raise a warning</span>
    <span class="s3"># Byte order change by requesting NBO</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">au = a.byteswap().newbyteorder()</span>
    <span class="s1">assert_(a.dtype.byteorder != au.dtype.byteorder)</span>
    <span class="s0">with </span><span class="s1">nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s3"># context manager triggers UPDATEIFCOPY on i at exit</span>
        <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">].byteorder</span><span class="s0">, </span><span class="s1">a.dtype.byteorder)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype.byteorder</span><span class="s0">, </span><span class="s1">a.dtype.byteorder)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">i.operands[</span><span class="s4">0</span><span class="s1">][:] = </span><span class="s4">12345</span>
        <span class="s1">i.operands[</span><span class="s4">0</span><span class="s1">][:] = </span><span class="s4">2</span>
    <span class="s1">assert_equal(au</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]*</span><span class="s4">6</span><span class="s1">)</span>

    <span class="s3"># Unaligned input</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s1">*</span><span class="s4">4</span><span class="s1">+</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i1'</span><span class="s1">)[</span><span class="s4">1</span><span class="s1">:]</span>
    <span class="s1">a.dtype = </span><span class="s2">'f4'</span>
    <span class="s1">a[:] = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">a.flags.aligned)</span>
    <span class="s3"># Without 'aligned', shouldn't copy</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">i.operands[</span><span class="s4">0</span><span class="s1">].flags.aligned)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s3"># With 'aligned', should make a copy</span>
    <span class="s0">with </span><span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">assert_(i.operands[</span><span class="s4">0</span><span class="s1">].flags.aligned)</span>
        <span class="s3"># context manager triggers UPDATEIFCOPY on i at exit</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">i.operands[</span><span class="s4">0</span><span class="s1">][:] = </span><span class="s4">3</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">]*</span><span class="s4">6</span><span class="s1">)</span>

    <span class="s3"># Discontiguous input</span>
    <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">)</span>
    <span class="s3"># If it is contiguous, shouldn't copy</span>
    <span class="s1">i = nditer(a[:</span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_(i.operands[</span><span class="s4">0</span><span class="s1">].flags.contiguous)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[:</span><span class="s4">6</span><span class="s1">])</span>
    <span class="s3"># If it isn't contiguous, should buffer</span>
    <span class="s1">i = nditer(a[::</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'contig'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">buffersize=</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">assert_(i[</span><span class="s4">0</span><span class="s1">].flags.contiguous)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[::</span><span class="s4">2</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_array_cast():</span>
    <span class="s3"># Check that arrays are cast as requested</span>

    <span class="s3"># No cast 'f4' -&gt; 'f4'</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>

    <span class="s3"># Byte-order cast '&lt;f4' -&gt; '&gt;f4'</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'&lt;f4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">,</span>
            <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'&gt;f4'</span><span class="s1">)]) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'&gt;f4'</span><span class="s1">))</span>

    <span class="s3"># Safe case 'f4' -&gt; 'f8'</span>
    <span class="s1">a = np.arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).swapaxes(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s0">,</span>
            <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s3"># The memory layout of the temporary should match a (a is (48,4,16))</span>
    <span class="s3"># except negative strides get flipped to positive strides.</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">96</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">32</span><span class="s1">))</span>
    <span class="s1">a = a[::-</span><span class="s4">1</span><span class="s0">,</span><span class="s1">:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s0">,</span>
            <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">96</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">32</span><span class="s1">))</span>

    <span class="s3"># Same-kind cast 'f8' -&gt; 'f4' -&gt; 'f8'</span>
    <span class="s1">a = np.arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).T</span>
    <span class="s0">with </span><span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
            <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)]) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">16</span><span class="s0">, </span><span class="s4">48</span><span class="s1">))</span>
        <span class="s3"># Check that WRITEBACKIFCOPY is activated at exit</span>
        <span class="s1">i.operands[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] = -</span><span class="s4">12.5</span>
        <span class="s1">assert_(a[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] != -</span><span class="s4">12.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(a[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s4">12.5</span><span class="s1">)</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)[::-</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
            <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)]) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
        <span class="s3"># Even though the stride was negative in 'a', it</span>
        <span class="s3"># becomes positive in the temporary</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">i.operands[</span><span class="s4">0</span><span class="s1">][:] = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_array_cast_errors():</span>
    <span class="s3"># Check that invalid casts are caught</span>

    <span class="s3"># Need to enable copying for casts to occur</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s3"># Also need to allow casting for casts to occur</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">'no'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'no'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s3"># '&lt;f4' -&gt; '&gt;f4' should not work with casting='no'</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'&lt;f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">'no'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'&gt;f4'</span><span class="s1">)])</span>
    <span class="s3"># 'f4' -&gt; 'f8' is a safe cast, but 'f8' -&gt; 'f4' isn't</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s3"># 'f4' -&gt; 'i4' is neither a safe nor a same-kind cast</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'i4'</span><span class="s1">)])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>

<span class="s0">def </span><span class="s1">test_iter_scalar_cast():</span>
    <span class="s3"># Check that scalars are cast as requested</span>

    <span class="s3"># No cast 'f4' -&gt; 'f4'</span>
    <span class="s1">i = nditer(np.float32(</span><span class="s4">2.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">)</span>
    <span class="s3"># Safe cast 'f4' -&gt; 'f8'</span>
    <span class="s1">i = nditer(np.float32(</span><span class="s4">2.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">)</span>
    <span class="s3"># Same-kind cast 'f8' -&gt; 'f4'</span>
    <span class="s1">i = nditer(np.float64(</span><span class="s4">2.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">)</span>
    <span class="s3"># Unsafe cast 'f8' -&gt; 'i4'</span>
    <span class="s1">i = nditer(np.float64(</span><span class="s4">3.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'i4'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'i4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'i4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s3"># Readonly scalars may be cast even without setting COPY or BUFFERED</span>
    <span class="s1">i = nditer(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_iter_scalar_cast_errors():</span>
    <span class="s3"># Check that invalid casts are caught</span>

    <span class="s3"># Need to allow copying/buffering for write casts of scalars to occur</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">np.float32(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)])</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s3"># 'f8' -&gt; 'f4' isn't a safe cast if the value would overflow</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">np.float64(</span><span class="s4">1e60</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s3"># 'f4' -&gt; 'i4' is neither a safe nor a same-kind cast</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">np.float32(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'i4'</span><span class="s1">)])</span>

<span class="s0">def </span><span class="s1">test_iter_object_arrays_basic():</span>
    <span class="s3"># Check that object arrays work</span>

    <span class="s1">obj = {</span><span class="s2">'a'</span><span class="s1">:</span><span class="s4">3</span><span class="s0">,</span><span class="s2">'b'</span><span class="s1">:</span><span class="s2">'d'</span><span class="s1">}</span>
    <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, None, </span><span class="s1">obj</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'O'</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">rc = sys.getrefcount(obj)</span>

    <span class="s3"># Need to allow references for object arrays</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">assert_equal(sys.getrefcount(obj)</span><span class="s0">, </span><span class="s1">rc)</span>

    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">])</span>
    <span class="s1">vals = [x_[()] </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i]</span>
    <span class="s1">assert_equal(np.array(vals</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'O'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">vals</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">x = [</span><span class="s0">None</span><span class="s1">]*</span><span class="s4">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">assert_equal(sys.getrefcount(obj)</span><span class="s0">, </span><span class="s1">rc)</span>

    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).T</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'refs_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
    <span class="s1">assert_(i.iterationneedsapi)</span>
    <span class="s1">vals = [x_[()] </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i]</span>
    <span class="s1">assert_equal(np.array(vals</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'O'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).ravel(order=</span><span class="s2">'F'</span><span class="s1">))</span>
    <span class="s1">vals</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">x = [</span><span class="s0">None</span><span class="s1">]*</span><span class="s4">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">assert_equal(sys.getrefcount(obj)</span><span class="s0">, </span><span class="s1">rc)</span>

    <span class="s1">i = nditer(a.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).T</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'refs_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">x[...] = </span><span class="s0">None</span>
        <span class="s1">vals</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">x = [</span><span class="s0">None</span><span class="s1">]*</span><span class="s4">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">assert_(sys.getrefcount(obj) == rc-</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">None</span><span class="s1">]*</span><span class="s4">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'O'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_object_arrays_conversions():</span>
    <span class="s3"># Conversions to/from objects</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'O'</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'refs_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">, </span><span class="s1">op_dtypes=</span><span class="s2">'i4'</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">x[...] += </span><span class="s4">1</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">)+</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'refs_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">, </span><span class="s1">op_dtypes=</span><span class="s2">'O'</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">x[...] += </span><span class="s4">1</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">)+</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s3"># Non-contiguous object array</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s2">'p'</span><span class="s0">, </span><span class="s2">'i1'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)])</span>
    <span class="s1">a = a[</span><span class="s2">'a'</span><span class="s1">]</span>
    <span class="s1">a[:] = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'refs_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">, </span><span class="s1">op_dtypes=</span><span class="s2">'i4'</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">x[...] += </span><span class="s4">1</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">)+</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s3">#Non-contiguous value array</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s2">'p'</span><span class="s0">, </span><span class="s2">'i1'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'i4'</span><span class="s1">)])</span>
    <span class="s1">a = a[</span><span class="s2">'a'</span><span class="s1">]</span>
    <span class="s1">a[:] = np.arange(</span><span class="s4">6</span><span class="s1">) + </span><span class="s4">98172488</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'refs_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">, </span><span class="s1">op_dtypes=</span><span class="s2">'O'</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">ob = i[</span><span class="s4">0</span><span class="s1">][()]</span>
        <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
            <span class="s1">rc = sys.getrefcount(ob)</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">x[...] += </span><span class="s4">1</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">assert_(sys.getrefcount(ob) == rc-</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">)+</span><span class="s4">98172489</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_iter_common_dtype():</span>
    <span class="s3"># Check that the iterator finds a common data type correctly</span>

    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array([</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'common_dtype'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array([</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'common_dtype'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'common_dtype'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'u4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'common_dtype'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'u4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'u4'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'u4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array(-</span><span class="s4">12</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'common_dtype'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'i8'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'i8'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'u4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array(-</span><span class="s4">12</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">,</span>
                 <span class="s1">array([</span><span class="s4">2j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'c8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array([</span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'common_dtype'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]]*</span><span class="s4">4</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">-</span><span class="s4">12</span><span class="s0">, </span><span class="s4">2j</span><span class="s0">, </span><span class="s4">9</span><span class="s1">))</span>

    <span class="s3"># When allocating outputs, other outputs aren't factored in</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">array([</span><span class="s4">2j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'c16'</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'i4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'i4'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>
    <span class="s3"># But, if common data types are requested, they are</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">array([</span><span class="s4">2j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'c16'</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'common_dtype'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'safe'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'c16'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_copy_if_overlap():</span>
    <span class="s3"># Ensure the iterator makes copies on read/write overlap, if requested</span>

    <span class="s3"># Copy not needed, 1 op</span>
    <span class="s0">for </span><span class="s1">flag </span><span class="s0">in </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'readwrite'</span><span class="s1">]:</span>
        <span class="s1">a = arange(</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s1">i = nditer([a]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[flag]])</span>
        <span class="s0">with </span><span class="s1">i:</span>
            <span class="s1">assert_(i.operands[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">is </span><span class="s1">a)</span>

    <span class="s3"># Copy needed, 2 ops, read-write overlap</span>
    <span class="s1">x = arange(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">a = x[</span><span class="s4">1</span><span class="s1">:]</span>
    <span class="s1">b = x[:-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]]) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.shares_memory(*i.operands))</span>

    <span class="s3"># Copy not needed with elementwise, 2 ops, exactly same arrays</span>
    <span class="s1">x = arange(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">a = x</span>
    <span class="s1">b = x</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'overlap_assume_elementwise'</span><span class="s1">]</span><span class="s0">,</span>
                                             <span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'overlap_assume_elementwise'</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">assert_(i.operands[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">is </span><span class="s1">a </span><span class="s0">and </span><span class="s1">i.operands[</span><span class="s4">1</span><span class="s1">] </span><span class="s0">is </span><span class="s1">b)</span>
    <span class="s0">with </span><span class="s1">nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]]) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">assert_(i.operands[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">is </span><span class="s1">a </span><span class="s0">and not </span><span class="s1">np.shares_memory(i.operands[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b))</span>

    <span class="s3"># Copy not needed, 2 ops, no overlap</span>
    <span class="s1">x = arange(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">a = x[::</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">b = x[</span><span class="s4">1</span><span class="s1">::</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]])</span>
    <span class="s1">assert_(i.operands[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">is </span><span class="s1">a </span><span class="s0">and </span><span class="s1">i.operands[</span><span class="s4">1</span><span class="s1">] </span><span class="s0">is </span><span class="s1">b)</span>

    <span class="s3"># Copy needed, 2 ops, read-write overlap</span>
    <span class="s1">x = arange(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
    <span class="s1">a = x[</span><span class="s4">3</span><span class="s1">:]</span>
    <span class="s1">b = x.view(np.int32)[:</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.shares_memory(*i.operands))</span>

    <span class="s3"># Copy needed, 3 ops, read-write overlap</span>
    <span class="s0">for </span><span class="s1">flag </span><span class="s0">in </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'readwrite'</span><span class="s1">]:</span>
        <span class="s1">x = np.ones([</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
        <span class="s1">a = x</span>
        <span class="s1">b = x.T</span>
        <span class="s1">c = x</span>
        <span class="s0">with </span><span class="s1">nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[flag]]) </span><span class="s0">as </span><span class="s1">i:</span>
            <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">c2 = i.operands</span>
            <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.shares_memory(a2</span><span class="s0">, </span><span class="s1">c2))</span>
            <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.shares_memory(b2</span><span class="s0">, </span><span class="s1">c2))</span>

    <span class="s3"># Copy not needed, 3 ops, read-only overlap</span>
    <span class="s1">x = np.ones([</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
    <span class="s1">a = x</span>
    <span class="s1">b = x.T</span>
    <span class="s1">c = x</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">c2 = i.operands</span>
    <span class="s1">assert_(a </span><span class="s0">is </span><span class="s1">a2)</span>
    <span class="s1">assert_(b </span><span class="s0">is </span><span class="s1">b2)</span>
    <span class="s1">assert_(c </span><span class="s0">is </span><span class="s1">c2)</span>

    <span class="s3"># Copy not needed, 3 ops, read-only overlap</span>
    <span class="s1">x = np.ones([</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
    <span class="s1">a = x</span>
    <span class="s1">b = np.ones([</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
    <span class="s1">c = x.T</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">c2 = i.operands</span>
    <span class="s1">assert_(a </span><span class="s0">is </span><span class="s1">a2)</span>
    <span class="s1">assert_(b </span><span class="s0">is </span><span class="s1">b2)</span>
    <span class="s1">assert_(c </span><span class="s0">is </span><span class="s1">c2)</span>

    <span class="s3"># Copy not needed, 3 ops, write-only overlap</span>
    <span class="s1">x = np.arange(</span><span class="s4">7</span><span class="s1">)</span>
    <span class="s1">a = x[:</span><span class="s4">3</span><span class="s1">]</span>
    <span class="s1">b = x[</span><span class="s4">3</span><span class="s1">:</span><span class="s4">6</span><span class="s1">]</span>
    <span class="s1">c = x[</span><span class="s4">4</span><span class="s1">:</span><span class="s4">7</span><span class="s1">]</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'copy_if_overlap'</span><span class="s1">]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]])</span>
    <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">c2 = i.operands</span>
    <span class="s1">assert_(a </span><span class="s0">is </span><span class="s1">a2)</span>
    <span class="s1">assert_(b </span><span class="s0">is </span><span class="s1">b2)</span>
    <span class="s1">assert_(c </span><span class="s0">is </span><span class="s1">c2)</span>

<span class="s0">def </span><span class="s1">test_iter_op_axes():</span>
    <span class="s3"># Check that custom axes work</span>

    <span class="s3"># Reverse the axes</span>
    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">a.T]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">, </span><span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
    <span class="s1">assert_(all([x == y </span><span class="s0">for </span><span class="s1">(x</span><span class="s0">, </span><span class="s1">y) </span><span class="s0">in </span><span class="s1">i]))</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">i = nditer([a.T</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">, </span><span class="s1">op_axes=[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">])</span>
    <span class="s1">assert_(all([x == y </span><span class="s0">for </span><span class="s1">(x</span><span class="s0">, </span><span class="s1">y) </span><span class="s0">in </span><span class="s1">i]))</span>

    <span class="s3"># Broadcast 1D to any dimension</span>
    <span class="s1">a = arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">31</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s1">b = arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">, </span><span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">assert_equal([x*y </span><span class="s0">for </span><span class="s1">(x</span><span class="s0">, </span><span class="s1">y) </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">(a*b.reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)).ravel())</span>
    <span class="s1">b = arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">, </span><span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">assert_equal([x*y </span><span class="s0">for </span><span class="s1">(x</span><span class="s0">, </span><span class="s1">y) </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">(a*b.reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)).ravel())</span>
    <span class="s1">b = arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                            <span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[np.newaxis</span><span class="s0">, </span><span class="s1">np.newaxis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
    <span class="s1">assert_equal([x*y </span><span class="s0">for </span><span class="s1">(x</span><span class="s0">, </span><span class="s1">y) </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">(a*b.reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)).ravel())</span>

    <span class="s3"># Inner product-style broadcasting</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">b = arange(</span><span class="s4">40</span><span class="s1">).reshape(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                            <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

    <span class="s3"># Matrix product-style broadcasting</span>
    <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">b = arange(</span><span class="s4">20</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                            <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_op_axes_errors():</span>
    <span class="s3"># Check that custom axes throws errors for bad inputs</span>

    <span class="s3"># Wrong number of items in op_axes</span>
    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]])</span>
    <span class="s3"># Out of bounds items in op_axes</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                                    <span class="s1">op_axes=[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s3"># Duplicate items in op_axes</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>

    <span class="s3"># Different sized arrays in op_axes</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>

    <span class="s3"># Non-broadcastable dimensions in the result</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s0">,</span>
                                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>

<span class="s0">def </span><span class="s1">test_iter_copy():</span>
    <span class="s3"># Check that copying the iterator works correctly</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>

    <span class="s3"># Simple iterator</span>
    <span class="s1">i = nditer(a)</span>
    <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">[x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j])</span>

    <span class="s1">i.iterindex = </span><span class="s4">3</span>
    <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">[x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j])</span>

    <span class="s3"># Buffered iterator</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'ranged'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">, </span><span class="s1">buffersize=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">[x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j])</span>

    <span class="s1">i.iterindex = </span><span class="s4">3</span>
    <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">[x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j])</span>

    <span class="s1">i.iterrange = (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s1">)</span>
    <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">[x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j])</span>

    <span class="s1">i.iterrange = (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">18</span><span class="s1">)</span>
    <span class="s1">next(i)</span>
    <span class="s1">next(i)</span>
    <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">[x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j])</span>

    <span class="s3"># Casting iterator</span>
    <span class="s0">with </span><span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">buffersize=</span><span class="s4">5</span><span class="s1">) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j]</span><span class="s0">, </span><span class="s1">a.ravel(order=</span><span class="s2">'F'</span><span class="s1">))</span>

    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'&lt;i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=</span><span class="s2">'&gt;f8'</span><span class="s0">, </span><span class="s1">buffersize=</span><span class="s4">5</span><span class="s1">) </span><span class="s0">as </span><span class="s1">i:</span>
        <span class="s1">j = i.copy()</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j]</span><span class="s0">, </span><span class="s1">a.ravel(order=</span><span class="s2">'F'</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">np.typecodes[</span><span class="s2">&quot;All&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;loop_dtype&quot;</span><span class="s0">, </span><span class="s1">np.typecodes[</span><span class="s2">&quot;All&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore::numpy.ComplexWarning&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_copy_casts(dtype</span><span class="s0">, </span><span class="s1">loop_dtype):</span>
    <span class="s3"># Ensure the dtype is never flexible:</span>
    <span class="s0">if </span><span class="s1">loop_dtype.lower() == </span><span class="s2">&quot;m&quot;</span><span class="s1">:</span>
        <span class="s1">loop_dtype = loop_dtype + </span><span class="s2">&quot;[ms]&quot;</span>
    <span class="s0">elif </span><span class="s1">np.dtype(loop_dtype).itemsize == </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s1">loop_dtype = loop_dtype + </span><span class="s2">&quot;50&quot;</span>

    <span class="s3"># Make things a bit more interesting by requiring a byte-swap as well:</span>
    <span class="s1">arr = np.ones(</span><span class="s4">1000</span><span class="s0">, </span><span class="s1">dtype=np.dtype(dtype).newbyteorder())</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">expected = arr.astype(loop_dtype)</span>
    <span class="s0">except </span><span class="s1">Exception:</span>
        <span class="s3"># Some casts are not possible, do not worry about them</span>
        <span class="s0">return</span>

    <span class="s1">it = np.nditer((arr</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;buffered&quot;</span><span class="s0">, </span><span class="s2">&quot;external_loop&quot;</span><span class="s0">, </span><span class="s2">&quot;refs_ok&quot;</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[loop_dtype]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">np.issubdtype(np.dtype(loop_dtype)</span><span class="s0">, </span><span class="s1">np.number):</span>
        <span class="s3"># Casting to strings may be strange, but for simple dtypes do not rely</span>
        <span class="s3"># on the cast being correct:</span>
        <span class="s1">assert_array_equal(expected</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">1000</span><span class="s0">, </span><span class="s1">dtype=loop_dtype))</span>

    <span class="s1">it_copy = it.copy()</span>
    <span class="s1">res = next(it)</span>
    <span class="s0">del </span><span class="s1">it</span>
    <span class="s1">res_copy = next(it_copy)</span>
    <span class="s0">del </span><span class="s1">it_copy</span>

    <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">assert_array_equal(res_copy</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_iter_copy_casts_structured():</span>
    <span class="s3"># Test a complicated structured dtype for casting, as it requires</span>
    <span class="s3"># both multiple steps and a more complex casting setup.</span>
    <span class="s3"># Includes a structured -&gt; unstructured (any to object), and many other</span>
    <span class="s3"># casts, which cause this to require all steps in the casting machinery</span>
    <span class="s3"># one level down as well as the iterator copy (which uses NpyAuxData clone)</span>
    <span class="s1">in_dtype = np.dtype([(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">&quot;i,&quot;</span><span class="s1">))</span><span class="s0">,</span>
                         <span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">&quot;&gt;i,&lt;i,&gt;d,S17,&gt;d,(3)f,O,i1&quot;</span><span class="s1">))])</span>
    <span class="s1">out_dtype = np.dtype([(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">&quot;O&quot;</span><span class="s1">))</span><span class="s0">,</span>
                          <span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">&quot;&gt;i,&gt;i,S17,&gt;d,&gt;U3,(3)d,i1,O&quot;</span><span class="s1">))])</span>
    <span class="s1">arr = np.ones(</span><span class="s4">1000</span><span class="s0">, </span><span class="s1">dtype=in_dtype)</span>

    <span class="s1">it = np.nditer((arr</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;buffered&quot;</span><span class="s0">, </span><span class="s2">&quot;external_loop&quot;</span><span class="s0">, </span><span class="s2">&quot;refs_ok&quot;</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[out_dtype]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s1">)</span>
    <span class="s1">it_copy = it.copy()</span>

    <span class="s1">res1 = next(it)</span>
    <span class="s0">del </span><span class="s1">it</span>
    <span class="s1">res2 = next(it_copy)</span>
    <span class="s0">del </span><span class="s1">it_copy</span>

    <span class="s1">expected = arr[</span><span class="s2">&quot;a&quot;</span><span class="s1">].astype(out_dtype[</span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">assert_array_equal(res1[</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">assert_array_equal(res2[</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">in_dtype[</span><span class="s2">&quot;b&quot;</span><span class="s1">].names:</span>
        <span class="s3"># Note that the .base avoids the subarray field</span>
        <span class="s1">expected = arr[</span><span class="s2">&quot;b&quot;</span><span class="s1">][field].astype(out_dtype[</span><span class="s2">&quot;b&quot;</span><span class="s1">][field].base)</span>
        <span class="s1">assert_array_equal(res1[</span><span class="s2">&quot;b&quot;</span><span class="s1">][field]</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">assert_array_equal(res2[</span><span class="s2">&quot;b&quot;</span><span class="s1">][field]</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_iter_allocate_output_simple():</span>
    <span class="s3"># Check that the iterator will properly allocate outputs</span>

    <span class="s3"># Simple case</span>
    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">a.shape)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_buffered_readwrite():</span>
    <span class="s3"># Allocated output with buffering + delay_bufalloc</span>

    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'delay_bufalloc'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'allocate'</span><span class="s0">, </span><span class="s2">'readwrite'</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">i.operands[</span><span class="s4">1</span><span class="s1">][:] = </span><span class="s4">1</span>
        <span class="s1">i.reset()</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">x[</span><span class="s4">1</span><span class="s1">][...] += x[</span><span class="s4">0</span><span class="s1">][...]</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a+</span><span class="s4">1</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_itorder():</span>
    <span class="s3"># The allocated output should match the iteration order</span>

    <span class="s3"># C-order input, best iteration order</span>
    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">a.shape)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">a.strides)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s3"># F-order input, best iteration order</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).T</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">a.shape)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">a.strides)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s3"># Non-contiguous input, C iteration order</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">order=</span><span class="s2">'C'</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">a.shape)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">32</span><span class="s0">, </span><span class="s4">16</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_opaxes():</span>
    <span class="s3"># Specifying op_axes should work</span>

    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">i = nditer([</span><span class="s0">None, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'u4'</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">op_axes=[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">])</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">48</span><span class="s0">, </span><span class="s4">16</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'u4'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_types_promotion():</span>
    <span class="s3"># Check type promotion of automatic outputs</span>

    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array([</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">+[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array([</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">+[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">+[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'u4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">+[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'u4'</span><span class="s1">))</span>
    <span class="s1">i = nditer([array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'u4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">array(-</span><span class="s4">12</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">+[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'i8'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_types_byte_order():</span>
    <span class="s3"># Verify the rules for byte order changes</span>

    <span class="s3"># When there's just one input, the output type exactly matches</span>
    <span class="s1">a = array([</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'u4'</span><span class="s1">).newbyteorder()</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i.dtypes[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s3"># With two or more inputs, the output type is in native byte order</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_(i.dtypes[</span><span class="s4">0</span><span class="s1">] != i.dtypes[</span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_equal(i.dtypes[</span><span class="s4">0</span><span class="s1">].newbyteorder(</span><span class="s2">'='</span><span class="s1">)</span><span class="s0">, </span><span class="s1">i.dtypes[</span><span class="s4">2</span><span class="s1">])</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_types_scalar():</span>
    <span class="s3"># If the inputs are all scalars, the output should be a scalar</span>

    <span class="s1">i = nditer([</span><span class="s0">None, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2.3</span><span class="s0">, </span><span class="s1">np.float32(</span><span class="s4">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.complex128(</span><span class="s4">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]] + [[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'complex128'</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">0</span><span class="s1">].ndim</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_subtype():</span>
    <span class="s3"># Make sure that the subtype with priority wins</span>
    <span class="s0">class </span><span class="s1">MyNDArray(np.ndarray):</span>
        <span class="s1">__array_priority__ = </span><span class="s4">15</span>

    <span class="s3"># subclass vs ndarray</span>
    <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]).view(MyNDArray)</span>
    <span class="s1">b = np.arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).T</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(type(a)</span><span class="s0">, </span><span class="s1">type(i.operands[</span><span class="s4">2</span><span class="s1">]))</span>
    <span class="s1">assert_(type(b) </span><span class="s0">is not </span><span class="s1">type(i.operands[</span><span class="s4">2</span><span class="s1">]))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">2</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

    <span class="s3"># If subtypes are disabled, we should get back an ndarray.</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
               <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s0">, </span><span class="s2">'no_subtype'</span><span class="s1">]])</span>
    <span class="s1">assert_equal(type(b)</span><span class="s0">, </span><span class="s1">type(i.operands[</span><span class="s4">2</span><span class="s1">]))</span>
    <span class="s1">assert_(type(a) </span><span class="s0">is not </span><span class="s1">type(i.operands[</span><span class="s4">2</span><span class="s1">]))</span>
    <span class="s1">assert_equal(i.operands[</span><span class="s4">2</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_errors():</span>
    <span class="s3"># Check that the iterator will throw errors for bad output allocations</span>

    <span class="s3"># Need an input if no output data type is specified</span>
    <span class="s1">a = arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]])</span>
    <span class="s3"># Allocated output should be flagged for writing</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'allocate'</span><span class="s0">, </span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s3"># Allocated output can't have buffering without delayed bufalloc</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                                            <span class="s1">[</span><span class="s2">'allocate'</span><span class="s0">, </span><span class="s2">'readwrite'</span><span class="s1">])</span>
    <span class="s3"># Must specify at least one input</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s3"># If using op_axes, must specify all the axes</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">np.newaxis</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s3"># If using op_axes, the axes must be within bounds</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s3"># If using op_axes, there can't be duplicates</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
    <span class="s3"># Not all axes may be specified if a reduction. If there is a hole</span>
    <span class="s3"># in op_axes, this is an error.</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;reduce_ok&quot;</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">np.dtype(</span><span class="s2">'f4'</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">np.newaxis</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>

<span class="s0">def </span><span class="s1">test_iter_remove_axis():</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>

    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">])</span>
    <span class="s1">i.remove_axis(</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s4">0</span><span class="s0">,</span><span class="s1">:].ravel())</span>

    <span class="s1">a = a[::-</span><span class="s4">1</span><span class="s0">,</span><span class="s1">:</span><span class="s0">,</span><span class="s1">:]</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">])</span>
    <span class="s1">i.remove_axis(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal([x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a[</span><span class="s4">0</span><span class="s0">,</span><span class="s1">:</span><span class="s0">,</span><span class="s1">:].ravel())</span>

<span class="s0">def </span><span class="s1">test_iter_remove_multi_index_inner_loop():</span>
    <span class="s3"># Check that removing multi-index support works</span>

    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>

    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.itviews[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>

    <span class="s3"># Removing the multi-index tracking causes all dimensions to coalesce</span>
    <span class="s1">before = [x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span>
    <span class="s1">i.remove_multi_index()</span>
    <span class="s1">after = [x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span>

    <span class="s1">assert_equal(before</span><span class="s0">, </span><span class="s1">after)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda </span><span class="s1">i:i.shape</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_equal(i.itviews[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">24</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s3"># Removing the inner loop means there's just one iteration</span>
    <span class="s1">i.reset()</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">tuple())</span>
    <span class="s1">i.enable_external_loop()</span>
    <span class="s1">assert_equal(i.itersize</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">24</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.value</span><span class="s0">, </span><span class="s1">arange(</span><span class="s4">24</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_iterindex():</span>
    <span class="s3"># Make sure iterindex works</span>

    <span class="s1">buffersize = </span><span class="s4">5</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">flags </span><span class="s0">in </span><span class="s1">([]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]):</span>
        <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">flags</span><span class="s0">, </span><span class="s1">buffersize=buffersize)</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">24</span><span class="s1">)))</span>
        <span class="s1">i.iterindex = </span><span class="s4">2</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)))</span>

        <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">flags</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">, </span><span class="s1">buffersize=buffersize)</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">24</span><span class="s1">)))</span>
        <span class="s1">i.iterindex = </span><span class="s4">5</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)))</span>

        <span class="s1">i = nditer(a[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">flags</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">, </span><span class="s1">buffersize=buffersize)</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">24</span><span class="s1">)))</span>
        <span class="s1">i.iterindex = </span><span class="s4">9</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">9</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)))</span>

        <span class="s1">i = nditer(a[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">flags</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s0">, </span><span class="s1">buffersize=buffersize)</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">24</span><span class="s1">)))</span>
        <span class="s1">i.iterindex = </span><span class="s4">13</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">13</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)))</span>

        <span class="s1">i = nditer(a[::</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">flags</span><span class="s0">, </span><span class="s1">buffersize=buffersize)</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">24</span><span class="s1">)))</span>
        <span class="s1">i.iterindex = </span><span class="s4">23</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">23</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)))</span>
        <span class="s1">i.reset()</span>
        <span class="s1">i.iterindex = </span><span class="s4">2</span>
        <span class="s1">assert_equal(iter_iterindices(i)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)))</span>

<span class="s0">def </span><span class="s1">test_iter_iterrange():</span>
    <span class="s3"># Make sure getting and resetting the iterrange works</span>

    <span class="s1">buffersize = </span><span class="s4">5</span>
    <span class="s1">a = arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">a_fort = a.ravel(order=</span><span class="s2">'F'</span><span class="s1">)</span>

    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'ranged'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">,</span>
                <span class="s1">buffersize=buffersize)</span>
    <span class="s1">assert_equal(i.iterrange</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">24</span><span class="s1">))</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a_fort)</span>
    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">23</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)]:</span>
        <span class="s1">i.iterrange = r</span>
        <span class="s1">assert_equal(i.iterrange</span><span class="s0">, </span><span class="s1">r)</span>
        <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a_fort[r[</span><span class="s4">0</span><span class="s1">]:r[</span><span class="s4">1</span><span class="s1">]])</span>

    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'ranged'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">buffersize=buffersize)</span>
    <span class="s1">assert_equal(i.iterrange</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">24</span><span class="s1">))</span>
    <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a_fort)</span>
    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">23</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)]:</span>
        <span class="s1">i.iterrange = r</span>
        <span class="s1">assert_equal(i.iterrange</span><span class="s0">, </span><span class="s1">r)</span>
        <span class="s1">assert_equal([x[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">a_fort[r[</span><span class="s4">0</span><span class="s1">]:r[</span><span class="s4">1</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">get_array(i):</span>
        <span class="s1">val = np.array([]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">val = np.concatenate((val</span><span class="s0">, </span><span class="s1">x))</span>
        <span class="s0">return </span><span class="s1">val</span>

    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'ranged'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s0">,</span>
                <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">buffersize=buffersize)</span>
    <span class="s1">assert_equal(i.iterrange</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">24</span><span class="s1">))</span>
    <span class="s1">assert_equal(get_array(i)</span><span class="s0">, </span><span class="s1">a_fort)</span>
    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">23</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)]:</span>
        <span class="s1">i.iterrange = r</span>
        <span class="s1">assert_equal(i.iterrange</span><span class="s0">, </span><span class="s1">r)</span>
        <span class="s1">assert_equal(get_array(i)</span><span class="s0">, </span><span class="s1">a_fort[r[</span><span class="s4">0</span><span class="s1">]:r[</span><span class="s4">1</span><span class="s1">]])</span>

<span class="s0">def </span><span class="s1">test_iter_buffering():</span>
    <span class="s3"># Test buffering with several buffer sizes and types</span>
    <span class="s1">arrays = []</span>
    <span class="s3"># F-order swapped array</span>
    <span class="s1">arrays.append(np.arange(</span><span class="s4">24</span><span class="s0">,</span>
                    <span class="s1">dtype=</span><span class="s2">'c16'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).T.newbyteorder().byteswap())</span>
    <span class="s3"># Contiguous 1-dimensional array</span>
    <span class="s1">arrays.append(np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">))</span>
    <span class="s3"># Unaligned array</span>
    <span class="s1">a = np.zeros((</span><span class="s4">4</span><span class="s1">*</span><span class="s4">16</span><span class="s1">+</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i1'</span><span class="s1">)[</span><span class="s4">1</span><span class="s1">:]</span>
    <span class="s1">a.dtype = </span><span class="s2">'i4'</span>
    <span class="s1">a[:] = np.arange(</span><span class="s4">16</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">)</span>
    <span class="s1">arrays.append(a)</span>
    <span class="s3"># 4-D F-order array</span>
    <span class="s1">arrays.append(np.arange(</span><span class="s4">120</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).T)</span>
    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrays:</span>
        <span class="s0">for </span><span class="s1">buffersize </span><span class="s0">in </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">16</span><span class="s0">, </span><span class="s4">1024</span><span class="s1">):</span>
            <span class="s1">vals = []</span>
            <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                           <span class="s1">order=</span><span class="s2">'C'</span><span class="s0">,</span>
                           <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">,</span>
                           <span class="s1">buffersize=buffersize)</span>
            <span class="s0">while not </span><span class="s1">i.finished:</span>
                <span class="s1">assert_(i[</span><span class="s4">0</span><span class="s1">].size &lt;= buffersize)</span>
                <span class="s1">vals.append(i[</span><span class="s4">0</span><span class="s1">].copy())</span>
                <span class="s1">i.iternext()</span>
            <span class="s1">assert_equal(np.concatenate(vals)</span><span class="s0">, </span><span class="s1">a.ravel(order=</span><span class="s2">'C'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_write_buffering():</span>
    <span class="s3"># Test that buffering of writes is working</span>

    <span class="s3"># F-order swapped array</span>
    <span class="s1">a = np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">).T.newbyteorder().byteswap()</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">,</span>
                   <span class="s1">order=</span><span class="s2">'C'</span><span class="s0">,</span>
                   <span class="s1">buffersize=</span><span class="s4">16</span><span class="s1">)</span>
    <span class="s1">x = </span><span class="s4">0</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">while not </span><span class="s1">i.finished:</span>
            <span class="s1">i[</span><span class="s4">0</span><span class="s1">] = x</span>
            <span class="s1">x += </span><span class="s4">1</span>
            <span class="s1">i.iternext()</span>
    <span class="s1">assert_equal(a.ravel(order=</span><span class="s2">'C'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">24</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_delayed_alloc():</span>
    <span class="s3"># Test that delaying buffer allocation works</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">b = np.arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'delay_bufalloc'</span><span class="s0">, </span><span class="s2">'multi_index'</span><span class="s0">, </span><span class="s2">'reduce_ok'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">assert_(i.has_delayed_bufalloc)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda </span><span class="s1">i:i.multi_index</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda </span><span class="s1">i:i[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda </span><span class="s1">i:i[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i)</span>

    <span class="s0">def </span><span class="s1">assign_iter(i):</span>
        <span class="s1">i[</span><span class="s4">0</span><span class="s1">] = </span><span class="s4">0</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">assign_iter</span><span class="s0">, </span><span class="s1">i)</span>

    <span class="s1">i.reset()</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">i.has_delayed_bufalloc)</span>
    <span class="s1">assert_equal(i.multi_index</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">i[</span><span class="s4">1</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal([[x[</span><span class="s4">0</span><span class="s1">][()]</span><span class="s0">, </span><span class="s1">x[</span><span class="s4">1</span><span class="s1">][()]] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">list(zip(range(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]*</span><span class="s4">6</span><span class="s1">)))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_simple():</span>
    <span class="s3"># Test that buffering can handle a simple cast</span>

    <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">)]</span><span class="s0">,</span>
                   <span class="s1">buffersize=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">v[...] *= </span><span class="s4">2</span>

    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_byteswapped():</span>
    <span class="s3"># Test that buffering can handle a cast which requires swap-&gt;cast-&gt;swap</span>

    <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">).newbyteorder().byteswap()</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f8'</span><span class="s1">).newbyteorder()]</span><span class="s0">,</span>
                   <span class="s1">buffersize=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">v[...] *= </span><span class="s4">2</span>

    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
        <span class="s1">sup.filter(np.ComplexWarning)</span>

        <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">).newbyteorder().byteswap()</span>
        <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                       <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                       <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'c8'</span><span class="s1">).newbyteorder()]</span><span class="s0">,</span>
                       <span class="s1">buffersize=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">i:</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i:</span>
                <span class="s1">v[...] *= </span><span class="s4">2</span>

        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_byteswapped_complex():</span>
    <span class="s3"># Test that buffering can handle a cast which requires swap-&gt;cast-&gt;copy</span>

    <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'c8'</span><span class="s1">).newbyteorder().byteswap()</span>
    <span class="s1">a += </span><span class="s4">2j</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'c16'</span><span class="s1">)]</span><span class="s0">,</span>
                   <span class="s1">buffersize=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">v[...] *= </span><span class="s4">2</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'c8'</span><span class="s1">) + </span><span class="s4">4j</span><span class="s1">)</span>

    <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'c8'</span><span class="s1">)</span>
    <span class="s1">a += </span><span class="s4">2j</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'c16'</span><span class="s1">).newbyteorder()]</span><span class="s0">,</span>
                   <span class="s1">buffersize=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">v[...] *= </span><span class="s4">2</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'c8'</span><span class="s1">) + </span><span class="s4">4j</span><span class="s1">)</span>

    <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=np.clongdouble).newbyteorder().byteswap()</span>
    <span class="s1">a += </span><span class="s4">2j</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'c16'</span><span class="s1">)]</span><span class="s0">,</span>
                   <span class="s1">buffersize=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">v[...] *= </span><span class="s4">2</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=np.clongdouble) + </span><span class="s4">4j</span><span class="s1">)</span>

    <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=np.longdouble).newbyteorder().byteswap()</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s0">, </span><span class="s2">'aligned'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)]</span><span class="s0">,</span>
                   <span class="s1">buffersize=</span><span class="s4">7</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">v[...] *= </span><span class="s4">2</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=np.longdouble))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_structured_type():</span>
    <span class="s3"># Tests buffering of structured types</span>

    <span class="s3"># simple -&gt; struct type (duplicates the value)</span>
    <span class="s1">sdt = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'i8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'c'</span><span class="s0">, </span><span class="s2">'c8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'d'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)]</span>
    <span class="s1">a = np.arange(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">) + </span><span class="s4">0.5</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt)</span>
    <span class="s1">vals = [np.array(x) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'b'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[(</span><span class="s4">0.5</span><span class="s1">)]*</span><span class="s4">3</span><span class="s1">]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'d'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'b'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[(</span><span class="s4">1.5</span><span class="s1">)]*</span><span class="s4">3</span><span class="s1">]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'d'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt))</span>

    <span class="s3"># object -&gt; struct type</span>
    <span class="s1">sdt = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'i8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'c'</span><span class="s0">, </span><span class="s2">'c8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'d'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'O'</span><span class="s1">)</span>
    <span class="s1">a[</span><span class="s4">0</span><span class="s1">] = (</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]]</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">a[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">]]</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">)</span>
    <span class="s1">a[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">]]</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">rc = sys.getrefcount(a[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt)</span>
    <span class="s1">vals = [x.copy() </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i]</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'b'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[(</span><span class="s4">0.5</span><span class="s1">)]*</span><span class="s4">3</span><span class="s1">]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">][</span><span class="s2">'d'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'b'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[(</span><span class="s4">1.5</span><span class="s1">)]*</span><span class="s4">3</span><span class="s1">]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'d'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt))</span>
    <span class="s1">vals</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">x = [</span><span class="s0">None</span><span class="s1">]*</span><span class="s4">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">assert_equal(sys.getrefcount(a[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">rc)</span>

    <span class="s3"># single-field struct type -&gt; simple</span>
    <span class="s1">sdt = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)]</span>
    <span class="s1">a = np.array([(</span><span class="s4">5.5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=sdt)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=</span><span class="s2">'i4'</span><span class="s1">)</span>
    <span class="s1">assert_equal([x_[()] </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">8</span><span class="s1">])</span>

    <span class="s3"># make sure multi-field struct type -&gt; simple doesn't work</span>
    <span class="s1">sdt = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'i8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'d'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)]</span>
    <span class="s1">a = np.array([(</span><span class="s4">5.5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s2">'test'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=sdt)</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, lambda</span><span class="s1">: (</span>
        <span class="s1">nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
               <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
               <span class="s1">op_dtypes=</span><span class="s2">'i4'</span><span class="s1">)))</span>

    <span class="s3"># struct type -&gt; struct type (field-wise copy)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'i8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'d'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'d'</span><span class="s0">, </span><span class="s2">'u2'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s1">)]</span>
    <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">assert_equal([np.array(x_) </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i]</span><span class="s0">,</span>
                 <span class="s1">[np.array((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt2)</span><span class="s0">,</span>
                  <span class="s1">np.array((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt2)])</span>


<span class="s0">def </span><span class="s1">test_iter_buffered_cast_structured_type_failure_with_cleanup():</span>
    <span class="s3"># make sure struct type -&gt; struct type with different</span>
    <span class="s3"># number of fields fails</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'i8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'d'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s1">)]</span>
    <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>

    <span class="s0">for </span><span class="s1">intent </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;readwrite&quot;</span><span class="s0">, </span><span class="s2">&quot;readonly&quot;</span><span class="s0">, </span><span class="s2">&quot;writeonly&quot;</span><span class="s1">]:</span>
        <span class="s3"># If the following assert fails, the place where the error is raised</span>
        <span class="s3"># within nditer may change. That is fine, but it may make sense for</span>
        <span class="s3"># a new (hard to design) test to replace it. The `simple_arr` is</span>
        <span class="s3"># designed to require a multi-step cast (due to having fields).</span>
        <span class="s0">assert </span><span class="s1">np.can_cast(a.dtype</span><span class="s0">, </span><span class="s1">sdt2</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s1">)</span>
        <span class="s1">simple_arr = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i,i&quot;</span><span class="s1">)  </span><span class="s3"># requires clean up</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">nditer((simple_arr</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[intent</span><span class="s0">, </span><span class="s1">intent]</span><span class="s0">,</span>
                   <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">, </span><span class="s1">op_dtypes=[</span><span class="s2">&quot;f,f&quot;</span><span class="s0">, </span><span class="s1">sdt2])</span>


<span class="s0">def </span><span class="s1">test_buffered_cast_error_paths():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s3"># The input is cast into an `S3` buffer</span>
        <span class="s1">np.nditer((np.array(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;S1&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">op_dtypes=[</span><span class="s2">&quot;i&quot;</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s0">, </span><span class="s1">flags=[</span><span class="s2">&quot;buffered&quot;</span><span class="s1">])</span>

    <span class="s3"># The `M8[ns]` is cast into the `S3` output</span>
    <span class="s1">it = np.nditer((np.array(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">op_dtypes=[</span><span class="s2">&quot;S1&quot;</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">op_flags=[</span><span class="s2">&quot;writeonly&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s0">, </span><span class="s1">flags=[</span><span class="s2">&quot;buffered&quot;</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s0">with </span><span class="s1">it:</span>
            <span class="s1">buf = next(it)</span>
            <span class="s1">buf[...] = </span><span class="s2">&quot;a&quot;  </span><span class="s3"># cannot be converted to int.</span>

<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;PyPy seems to not hit this.&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_buffered_cast_error_paths_unraisable():</span>
    <span class="s3"># The following gives an unraisable error. Pytest sometimes captures that</span>
    <span class="s3"># (depending python and/or pytest version). So with Python&gt;=3.8 this can</span>
    <span class="s3"># probably be cleaned out in the future to check for</span>
    <span class="s3"># pytest.PytestUnraisableExceptionWarning:</span>
    <span class="s1">code = textwrap.dedent(</span><span class="s2">&quot;&quot;&quot; 
        import numpy as np 
     
        it = np.nditer((np.array(1, dtype=&quot;i&quot;),), op_dtypes=[&quot;S1&quot;], 
                       op_flags=[&quot;writeonly&quot;], casting=&quot;unsafe&quot;, flags=[&quot;buffered&quot;]) 
        buf = next(it) 
        buf[...] = &quot;a&quot; 
        del buf, it  # Flushing only happens during deallocate right now. 
        &quot;&quot;&quot;</span><span class="s1">)</span>
    <span class="s1">res = subprocess.check_output([sys.executable</span><span class="s0">, </span><span class="s2">&quot;-c&quot;</span><span class="s0">, </span><span class="s1">code]</span><span class="s0">,</span>
                                  <span class="s1">stderr=subprocess.STDOUT</span><span class="s0">, </span><span class="s1">text=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s2">&quot;ValueError&quot; </span><span class="s0">in </span><span class="s1">res</span>


<span class="s0">def </span><span class="s1">test_iter_buffered_cast_subarray():</span>
    <span class="s3"># Tests buffering of subarrays</span>

    <span class="s3"># one element -&gt; many (copies it to all)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">count </span><span class="s0">in </span><span class="s1">zip(i</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s4">6</span><span class="s1">))):</span>
        <span class="s1">assert_(np.all(x[</span><span class="s2">'a'</span><span class="s1">] == count))</span>

    <span class="s3"># one element -&gt; many -&gt; back (copies it to all)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
        <span class="s1">count = </span><span class="s4">0</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">assert_(np.all(x[</span><span class="s2">'a'</span><span class="s1">] == count))</span>
            <span class="s1">x[</span><span class="s2">'a'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] += </span><span class="s4">2</span>
            <span class="s1">count += </span><span class="s4">1</span>
    <span class="s1">assert_equal(a[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)+</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s3"># many -&gt; one element -&gt; back (copies just element 0)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
        <span class="s1">count = </span><span class="s4">0</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">count)</span>
            <span class="s1">x[</span><span class="s2">'a'</span><span class="s1">] += </span><span class="s4">2</span>
            <span class="s1">count += </span><span class="s4">1</span>
    <span class="s1">assert_equal(a[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)*np.ones((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))+</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s3"># many -&gt; one element -&gt; back (copies just element 0)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">count)</span>
        <span class="s1">count += </span><span class="s4">1</span>

    <span class="s3"># many -&gt; one element (copies just element 0)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">count)</span>
        <span class="s1">count += </span><span class="s4">1</span>

    <span class="s3"># many -&gt; matching shape (straightforward copy)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">*</span><span class="s4">3</span><span class="s1">*</span><span class="s4">2</span><span class="s1">*</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">])</span>
        <span class="s1">count += </span><span class="s4">1</span>

    <span class="s3"># vector -&gt; smaller vector (truncates)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">6</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">*</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">count += </span><span class="s4">1</span>

    <span class="s3"># vector -&gt; bigger vector (pads with zeros)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">6</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">*</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">])</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][</span><span class="s4">2</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">count += </span><span class="s4">1</span>

    <span class="s3"># vector -&gt; matrix (broadcasts)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">*</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">])</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">])</span>
        <span class="s1">count += </span><span class="s4">1</span>

    <span class="s3"># vector -&gt; matrix (broadcasts and zero-pads)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">*</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][</span><span class="s4">2</span><span class="s0">,</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">count += </span><span class="s4">1</span>

    <span class="s3"># matrix -&gt; matrix (truncates and zero-pads)</span>
    <span class="s1">sdt1 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))]</span>
    <span class="s1">sdt2 = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span>
    <span class="s1">a = np.zeros((</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=sdt1)</span>
    <span class="s1">a[</span><span class="s2">'a'</span><span class="s1">] = np.arange(</span><span class="s4">6</span><span class="s1">*</span><span class="s4">2</span><span class="s1">*</span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=sdt2)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(sdt2))</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[count][</span><span class="s2">'a'</span><span class="s1">][:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(x[</span><span class="s2">'a'</span><span class="s1">][</span><span class="s4">2</span><span class="s0">,</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">count += </span><span class="s4">1</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_badwriteback():</span>
    <span class="s3"># Writing back from a buffer cannot combine elements</span>

    <span class="s3"># a needs write buffering, but had a broadcast dimension</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">b = np.arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]</span><span class="s0">,</span>
                  <span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>

    <span class="s3"># But if a is readonly, it's fine</span>
    <span class="s1">nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
           <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]</span><span class="s0">,</span>
           <span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>

    <span class="s3"># If a has just one element, it's fine too (constant 0 stride, a reduction)</span>
    <span class="s1">a = np.arange(</span><span class="s4">1</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s0">, </span><span class="s2">'reduce_ok'</span><span class="s1">]</span><span class="s0">,</span>
           <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]</span><span class="s0">,</span>
           <span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>

    <span class="s3"># check that it fails on other dimensions too</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]</span><span class="s0">,</span>
                  <span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
    <span class="s1">a = np.arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s1">]]</span><span class="s0">,</span>
                  <span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_string():</span>
    <span class="s3"># Safe casting disallows shrinking strings</span>
    <span class="s1">a = np.array([</span><span class="s2">'abc'</span><span class="s0">, </span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'abcd'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.bytes_)</span>
    <span class="s1">assert_equal(a.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'S4'</span><span class="s1">))</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">op_dtypes=</span><span class="s2">'S2'</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">op_dtypes=</span><span class="s2">'S6'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">b'abc'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'S6'</span><span class="s1">))</span>

    <span class="s1">a = np.array([</span><span class="s2">'abc'</span><span class="s0">, </span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'abcd'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
    <span class="s1">assert_equal(a.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'U4'</span><span class="s1">))</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=</span><span class="s2">'U2'</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">op_dtypes=</span><span class="s2">'U6'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">u'abc'</span><span class="s1">)</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'U6'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_growinner():</span>
    <span class="s3"># Test that the inner loop grows when no buffering is needed</span>
    <span class="s1">a = np.arange(</span><span class="s4">30</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'growinner'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s1">buffersize=</span><span class="s4">5</span><span class="s1">)</span>
    <span class="s3"># Should end up with just one inner loop here</span>
    <span class="s1">assert_equal(i[</span><span class="s4">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s1">a.size)</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s0">def </span><span class="s1">test_iter_buffered_reduce_reuse():</span>
    <span class="s3"># large enough array for all views, including negative strides.</span>
    <span class="s1">a = np.arange(</span><span class="s4">2</span><span class="s1">*</span><span class="s4">3</span><span class="s1">**</span><span class="s4">5</span><span class="s1">)[</span><span class="s4">3</span><span class="s1">**</span><span class="s4">5</span><span class="s1">:</span><span class="s4">3</span><span class="s1">**</span><span class="s4">5</span><span class="s1">+</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">flags = [</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'delay_bufalloc'</span><span class="s0">, </span><span class="s2">'multi_index'</span><span class="s0">, </span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span>
    <span class="s1">op_flags = [(</span><span class="s2">'readonly'</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">)]</span>
    <span class="s1">op_axes_list = [[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)]]</span>
    <span class="s3"># wrong dtype to force buffering</span>
    <span class="s1">op_dtypes = [float</span><span class="s0">, </span><span class="s1">a.dtype]</span>

    <span class="s0">def </span><span class="s1">get_params():</span>
        <span class="s0">for </span><span class="s1">xs </span><span class="s0">in </span><span class="s1">range(-</span><span class="s4">3</span><span class="s1">**</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">**</span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">ys </span><span class="s0">in </span><span class="s1">range(xs</span><span class="s0">, </span><span class="s4">3</span><span class="s1">**</span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">):</span>
                <span class="s0">for </span><span class="s1">op_axes </span><span class="s0">in </span><span class="s1">op_axes_list:</span>
                    <span class="s3"># last stride is reduced and because of that not</span>
                    <span class="s3"># important for this test, as it is the inner stride.</span>
                    <span class="s1">strides = (xs * a.itemsize</span><span class="s0">, </span><span class="s1">ys * a.itemsize</span><span class="s0">, </span><span class="s1">a.itemsize)</span>
                    <span class="s1">arr = np.lib.stride_tricks.as_strided(a</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">strides)</span>

                    <span class="s0">for </span><span class="s1">skip </span><span class="s0">in </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]:</span>
                        <span class="s0">yield </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">op_axes</span><span class="s0">, </span><span class="s1">skip</span>

    <span class="s0">for </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">op_axes</span><span class="s0">, </span><span class="s1">skip </span><span class="s0">in </span><span class="s1">get_params():</span>
        <span class="s1">nditer2 = np.nditer([arr.copy()</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">op_axes=op_axes</span><span class="s0">, </span><span class="s1">flags=flags</span><span class="s0">, </span><span class="s1">op_flags=op_flags</span><span class="s0">,</span>
                            <span class="s1">op_dtypes=op_dtypes)</span>
        <span class="s0">with </span><span class="s1">nditer2:</span>
            <span class="s1">nditer2.operands[-</span><span class="s4">1</span><span class="s1">][...] = </span><span class="s4">0</span>
            <span class="s1">nditer2.reset()</span>
            <span class="s1">nditer2.iterindex = skip</span>

            <span class="s0">for </span><span class="s1">(a2_in</span><span class="s0">, </span><span class="s1">b2_in) </span><span class="s0">in </span><span class="s1">nditer2:</span>
                <span class="s1">b2_in += a2_in.astype(np.int_)</span>

            <span class="s1">comp_res = nditer2.operands[-</span><span class="s4">1</span><span class="s1">]</span>

        <span class="s0">for </span><span class="s1">bufsize </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">**</span><span class="s4">3</span><span class="s1">):</span>
            <span class="s1">nditer1 = np.nditer([arr</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">op_axes=op_axes</span><span class="s0">, </span><span class="s1">flags=flags</span><span class="s0">, </span><span class="s1">op_flags=op_flags</span><span class="s0">,</span>
                                <span class="s1">buffersize=bufsize</span><span class="s0">, </span><span class="s1">op_dtypes=op_dtypes)</span>
            <span class="s0">with </span><span class="s1">nditer1:</span>
                <span class="s1">nditer1.operands[-</span><span class="s4">1</span><span class="s1">][...] = </span><span class="s4">0</span>
                <span class="s1">nditer1.reset()</span>
                <span class="s1">nditer1.iterindex = skip</span>

                <span class="s0">for </span><span class="s1">(a1_in</span><span class="s0">, </span><span class="s1">b1_in) </span><span class="s0">in </span><span class="s1">nditer1:</span>
                    <span class="s1">b1_in += a1_in.astype(np.int_)</span>

                <span class="s1">res = nditer1.operands[-</span><span class="s4">1</span><span class="s1">]</span>
            <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">comp_res)</span>


<span class="s0">def </span><span class="s1">test_iter_no_broadcast():</span>
    <span class="s3"># Test that the no_broadcast flag works</span>
    <span class="s1">a = np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">b = np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">c = np.arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>

    <span class="s1">nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
           <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'no_broadcast'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                  <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'no_broadcast'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                  <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'no_broadcast'</span><span class="s1">]])</span>


<span class="s0">class </span><span class="s1">TestIterNested:</span>

    <span class="s0">def </span><span class="s1">test_basic(self):</span>
        <span class="s3"># Test nested iteration basic usage</span>
        <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_reorder(self):</span>
        <span class="s3"># Test nested iteration basic usage</span>
        <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

        <span class="s3"># In 'K' order (default), it gets reordered</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s3"># In 'C' order, it doesn't</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_flip_axes(self):</span>
        <span class="s3"># Test nested iteration with negative axes</span>
        <span class="s1">a = arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span>

        <span class="s3"># In 'K' order (default), the axes all get flipped</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s3"># In 'C' order, flipping axes is disabled</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">11</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">11</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">9</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">)</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">11</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_broadcast(self):</span>
        <span class="s3"># Test nested iteration with broadcasting</span>
        <span class="s1">a = arange(</span><span class="s4">2</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">b = arange(</span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]])</span>

    <span class="s0">def </span><span class="s1">test_dtype_copy(self):</span>
        <span class="s3"># Test nested iteration with a copy to change dtype</span>

        <span class="s3"># copy</span>
        <span class="s1">a = arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">op_flags=[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'copy'</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s1">)</span>
        <span class="s1">assert_equal(j[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]])</span>
        <span class="s1">vals = </span><span class="s0">None</span>

        <span class="s3"># writebackifcopy - using context manager</span>
        <span class="s1">a = arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">op_flags=[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                            <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j:</span>
            <span class="s1">assert_equal(j[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j:</span>
                    <span class="s1">y[...] += </span><span class="s4">1</span>
            <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])</span>

        <span class="s3"># writebackifcopy - using close()</span>
        <span class="s1">a = arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">op_flags=[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                            <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s1">)</span>
        <span class="s1">assert_equal(j[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j:</span>
                <span class="s1">y[...] += </span><span class="s4">1</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]])</span>
        <span class="s1">i.close()</span>
        <span class="s1">j.close()</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_dtype_buffered(self):</span>
        <span class="s3"># Test nested iteration with buffering to change dtype</span>

        <span class="s1">a = arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">flags=[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">op_flags=[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                            <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s1">)</span>
        <span class="s1">assert_equal(j[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j:</span>
                <span class="s1">y[...] += </span><span class="s4">1</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_0d(self):</span>
        <span class="s1">a = np.arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]])</span>
        <span class="s1">vals = [list(j) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i]</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">11</span><span class="s1">]])</span>

        <span class="s1">i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">vals = []</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j:</span>
                <span class="s1">vals.append([z </span><span class="s0">for </span><span class="s1">z </span><span class="s0">in </span><span class="s1">k])</span>
        <span class="s1">assert_equal(vals</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_iter_nested_iters_dtype_buffered(self):</span>
        <span class="s3"># Test nested iteration with buffering to change dtype</span>

        <span class="s1">a = arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">i</span><span class="s0">, </span><span class="s1">j = np.nested_iters(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                            <span class="s1">flags=[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">op_flags=[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s0">,</span>
                            <span class="s1">op_dtypes=</span><span class="s2">'f8'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j:</span>
            <span class="s1">assert_equal(j[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i:</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j:</span>
                    <span class="s1">y[...] += </span><span class="s4">1</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])</span>

<span class="s0">def </span><span class="s1">test_iter_reduction_error():</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s1">]])</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]])</span>

<span class="s0">def </span><span class="s1">test_iter_reduction():</span>
    <span class="s3"># Test doing reductions with the iterator</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s3"># Need to initialize the output operand to the addition unit</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">i.operands[</span><span class="s4">1</span><span class="s1">][...] = </span><span class="s4">0</span>
        <span class="s3"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">y[...] += x</span>
        <span class="s3"># Since no axes were specified, should have allocated a scalar</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].ndim</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.sum(a))</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">i = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s3"># Need to initialize the output operand to the addition unit</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">i.operands[</span><span class="s4">1</span><span class="s1">][...] = </span><span class="s4">0</span>
        <span class="s3"># Reduction shape/strides for the output</span>
        <span class="s1">assert_equal(i[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">6</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(i[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s3"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s3"># Use a for loop instead of ``y[...] += x``</span>
            <span class="s3"># (equivalent to ``y[...] = y[...].copy() + x``),</span>
            <span class="s3"># because y has zero strides we use for the reduction</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(len(y)):</span>
                <span class="s1">y[j] += x[j]</span>
        <span class="s3"># Since no axes were specified, should have allocated a scalar</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">].ndim</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(i.operands[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.sum(a))</span>

    <span class="s3"># This is a tricky reduction case for the buffering double loop</span>
    <span class="s3"># to handle</span>
    <span class="s1">a = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">it1 = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">it2 = nditer([a</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s0">,</span>
                            <span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'delay_bufalloc'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">buffersize=</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">it1</span><span class="s0">, </span><span class="s1">it2:</span>
        <span class="s1">it1.operands[</span><span class="s4">1</span><span class="s1">].fill(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">it2.operands[</span><span class="s4">1</span><span class="s1">].fill(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">it2.reset()</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it1:</span>
            <span class="s1">x[</span><span class="s4">1</span><span class="s1">][...] += x[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it2:</span>
            <span class="s1">x[</span><span class="s4">1</span><span class="s1">][...] += x[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">assert_equal(it1.operands[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">it2.operands[</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(it2.operands[</span><span class="s4">1</span><span class="s1">].sum()</span><span class="s0">, </span><span class="s1">a.size)</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_reduction():</span>
    <span class="s3"># Test doing buffered reductions with the iterator</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">b = np.array(</span><span class="s4">0.</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">).byteswap().newbyteorder()</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i[</span><span class="s4">1</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s2">'f8'</span><span class="s1">))</span>
        <span class="s1">assert_(i[</span><span class="s4">1</span><span class="s1">].dtype != b.dtype)</span>
        <span class="s3"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s1">y[...] += x</span>
    <span class="s3"># Since no axes were specified, should have allocated a scalar</span>
    <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">np.sum(a))</span>

    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">b = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">).byteswap().newbyteorder()</span>
    <span class="s1">i = nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'nbo'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_axes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s3"># Reduction shape/strides for the output</span>
    <span class="s0">with </span><span class="s1">i:</span>
        <span class="s1">assert_equal(i[</span><span class="s4">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(i[</span><span class="s4">1</span><span class="s1">].strides</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s3"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i:</span>
            <span class="s3"># Use a for loop instead of ``y[...] += x``</span>
            <span class="s3"># (equivalent to ``y[...] = y[...].copy() + x``),</span>
            <span class="s3"># because y has zero strides we use for the reduction</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(len(y)):</span>
                <span class="s1">y[j] += x[j]</span>
    <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">))</span>

    <span class="s3"># Iterator inner double loop was wrong on this one</span>
    <span class="s1">p = np.arange(</span><span class="s4">2</span><span class="s1">) + </span><span class="s4">1</span>
    <span class="s1">it = np.nditer([p</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">'delay_bufalloc'</span><span class="s0">, </span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'allocate'</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">op_axes=[[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">itershape=(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s1">it.operands[</span><span class="s4">1</span><span class="s1">].fill(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">it.reset()</span>
        <span class="s1">assert_equal(it[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>

    <span class="s3"># Iterator inner loop should take argument contiguity into account</span>
    <span class="s1">x = np.ones((</span><span class="s4">7</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int8)[</span><span class="s4">4</span><span class="s1">:</span><span class="s4">6</span><span class="s0">,</span><span class="s4">1</span><span class="s1">:</span><span class="s4">11</span><span class="s1">:</span><span class="s4">6</span><span class="s0">,</span><span class="s4">1</span><span class="s1">:</span><span class="s4">5</span><span class="s1">].transpose(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">x[...] = np.arange(x.size).reshape(x.shape)</span>
    <span class="s1">y_base = np.arange(</span><span class="s4">4</span><span class="s1">*</span><span class="s4">4</span><span class="s0">, </span><span class="s1">dtype=np.int8).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">y_base_copy = y_base.copy()</span>
    <span class="s1">y = y_base[::</span><span class="s4">2</span><span class="s0">,</span><span class="s1">:</span><span class="s0">,None</span><span class="s1">]</span>

    <span class="s1">it = np.nditer([y</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s0">, </span><span class="s2">'reduce_ok'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s0">for </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">it:</span>
            <span class="s1">a.fill(</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s1">assert_equal(y_base[</span><span class="s4">1</span><span class="s1">::</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_base_copy[</span><span class="s4">1</span><span class="s1">::</span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_equal(y_base[::</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_reduction_reuse_reduce_loops():</span>
    <span class="s3"># There was a bug triggering reuse of the reduce loop inappropriately,</span>
    <span class="s3"># which caused processing to happen in unnecessarily small chunks</span>
    <span class="s3"># and overran the buffer.</span>

    <span class="s1">a = np.zeros((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">))</span>
    <span class="s1">b = np.zeros((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">))</span>
    <span class="s1">it = np.nditer([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">flags=[</span><span class="s2">'reduce_ok'</span><span class="s0">, </span><span class="s2">'external_loop'</span><span class="s0">, </span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">op_flags=[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">buffersize=</span><span class="s4">5</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s1">bufsizes = [x.shape[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">it]</span>
    <span class="s1">assert_equal(bufsizes</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_equal(sum(bufsizes)</span><span class="s0">, </span><span class="s1">a.size)</span>

<span class="s0">def </span><span class="s1">test_iter_writemasked_badinput():</span>
    <span class="s1">a = np.zeros((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">b = np.zeros((</span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">m = np.array([[</span><span class="s0">True, True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True, False</span><span class="s1">]])</span>
    <span class="s1">m2 = np.array([</span><span class="s0">True, True, False</span><span class="s1">])</span>
    <span class="s1">m3 = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'u1'</span><span class="s1">)</span>
    <span class="s1">mbad1 = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'i1'</span><span class="s1">)</span>
    <span class="s1">mbad2 = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>

    <span class="s3"># Need an 'arraymask' if any operand is 'writemasked'</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">m]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]])</span>

    <span class="s3"># A 'writemasked' operand must not be readonly</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">m]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>

    <span class="s3"># 'writemasked' and 'arraymask' may not be used together</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">m]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]])</span>

    <span class="s3"># 'arraymask' may only be specified once</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">m</span><span class="s0">, </span><span class="s1">m2]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>

    <span class="s3"># An 'arraymask' with nothing 'writemasked' also doesn't make sense</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">m]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>

    <span class="s3"># A writemasked reduction requires a similarly smaller mask</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">m]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>
    <span class="s3"># But this should work with a smaller/equal mask to the reduction operand</span>
    <span class="s1">np.nditer([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">m2]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>
    <span class="s3"># The arraymask itself cannot be a reduction</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">m2]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'reduce_ok'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>

    <span class="s3"># A uint8 mask is ok too</span>
    <span class="s1">np.nditer([a</span><span class="s0">, </span><span class="s1">m3]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=[</span><span class="s2">'f4'</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s1">)</span>
    <span class="s3"># An int8 mask isn't ok</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">mbad1]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=[</span><span class="s2">'f4'</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s1">)</span>
    <span class="s3"># A float32 mask isn't ok</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.nditer</span><span class="s0">, </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">mbad2]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]]</span><span class="s0">,</span>
                    <span class="s1">op_dtypes=[</span><span class="s2">'f4'</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'same_kind'</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">_is_buffered(iterator):</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">iterator.itviews</span>
    <span class="s0">except </span><span class="s1">ValueError:</span>
        <span class="s0">return True</span>
    <span class="s0">return False</span>

<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;a&quot;</span><span class="s0">,</span>
        <span class="s1">[np.zeros((</span><span class="s4">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)</span><span class="s0">,</span>
         <span class="s1">np.zeros((</span><span class="s4">9876</span><span class="s0">, </span><span class="s4">3</span><span class="s1">*</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)[::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">,</span>
         <span class="s1">np.zeros((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">312</span><span class="s0">, </span><span class="s4">124</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)[::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">,</span>
         <span class="s3"># Also test with the last dimension strided (so it does not fit if</span>
         <span class="s3"># there is repeated access)</span>
         <span class="s1">np.zeros((</span><span class="s4">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)[::</span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
         <span class="s1">np.zeros((</span><span class="s4">9876</span><span class="s0">, </span><span class="s4">3</span><span class="s1">*</span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)[::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">::</span><span class="s4">5</span><span class="s1">]</span><span class="s0">,</span>
         <span class="s1">np.zeros((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">312</span><span class="s0">, </span><span class="s4">124</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f8'</span><span class="s1">)[::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]])</span>
<span class="s0">def </span><span class="s1">test_iter_writemasked(a):</span>
    <span class="s3"># Note, the slicing above is to ensure that nditer cannot combine multiple</span>
    <span class="s3"># axes into one.  The repetition is just to make things a bit more</span>
    <span class="s3"># interesting.</span>
    <span class="s1">shape = a.shape</span>
    <span class="s1">reps = shape[-</span><span class="s4">1</span><span class="s1">] // </span><span class="s4">3</span>
    <span class="s1">msk = np.empty(shape</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
    <span class="s1">msk[...] = [</span><span class="s0">True, True, False</span><span class="s1">] * reps</span>

    <span class="s3"># When buffering is unused, 'writemasked' effectively does nothing.</span>
    <span class="s3"># It's up to the user of the iterator to obey the requested semantics.</span>
    <span class="s1">it = np.nditer([a</span><span class="s0">, </span><span class="s1">msk]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">m </span><span class="s0">in </span><span class="s1">it:</span>
            <span class="s1">x[...] = </span><span class="s4">1</span>
    <span class="s3"># Because we violated the semantics, all the values became 1</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.broadcast_to([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] * reps</span><span class="s0">, </span><span class="s1">shape))</span>

    <span class="s3"># Even if buffering is enabled, we still may be accessing the array</span>
    <span class="s3"># directly.</span>
    <span class="s1">it = np.nditer([a</span><span class="s0">, </span><span class="s1">msk]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]])</span>
    <span class="s3"># @seberg: I honestly don't currently understand why a &quot;buffered&quot; iterator</span>
    <span class="s3"># would end up not using a buffer for the small array here at least when</span>
    <span class="s3"># &quot;writemasked&quot; is used, that seems confusing...  Check by testing for</span>
    <span class="s3"># actual memory overlap!</span>
    <span class="s1">is_buffered = </span><span class="s0">True</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">m </span><span class="s0">in </span><span class="s1">it:</span>
            <span class="s1">x[...] = </span><span class="s4">2.5</span>
            <span class="s0">if </span><span class="s1">np.may_share_memory(x</span><span class="s0">, </span><span class="s1">a):</span>
                <span class="s1">is_buffered = </span><span class="s0">False</span>

    <span class="s0">if not </span><span class="s1">is_buffered:</span>
        <span class="s3"># Because we violated the semantics, all the values became 2.5</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.broadcast_to([</span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">] * reps</span><span class="s0">, </span><span class="s1">shape))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s3"># For large sizes, the iterator may be buffered:</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.broadcast_to([</span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">2.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] * reps</span><span class="s0">, </span><span class="s1">shape))</span>
        <span class="s1">a[...] = </span><span class="s4">2.5</span>

    <span class="s3"># If buffering will definitely happening, for instance because of</span>
    <span class="s3"># a cast, only the items selected by the mask will be copied back from</span>
    <span class="s3"># the buffer.</span>
    <span class="s1">it = np.nditer([a</span><span class="s0">, </span><span class="s1">msk]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">op_dtypes=[</span><span class="s2">'i8'</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">m </span><span class="s0">in </span><span class="s1">it:</span>
            <span class="s1">x[...] = </span><span class="s4">3</span>
    <span class="s3"># Even though we violated the semantics, only the selected values</span>
    <span class="s3"># were copied back</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.broadcast_to([</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">] * reps</span><span class="s0">, </span><span class="s1">shape))</span>

<span class="s0">def </span><span class="s1">test_iter_writemasked_decref():</span>
    <span class="s3"># force casting (to make it interesting) by using a structured dtype.</span>
    <span class="s1">arr = np.arange(</span><span class="s4">10000</span><span class="s1">).astype(</span><span class="s2">&quot;&gt;i,O&quot;</span><span class="s1">)</span>
    <span class="s1">original = arr.copy()</span>
    <span class="s1">mask = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">10000</span><span class="s1">).astype(bool)</span>

    <span class="s1">it = np.nditer([arr</span><span class="s0">, </span><span class="s1">mask]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">&quot;refs_ok&quot;</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'writemasked'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">'readonly'</span><span class="s0">, </span><span class="s2">'arraymask'</span><span class="s1">]]</span><span class="s0">,</span>
                   <span class="s1">op_dtypes=[</span><span class="s2">&quot;&lt;i,O&quot;</span><span class="s0">, </span><span class="s2">&quot;?&quot;</span><span class="s1">])</span>
    <span class="s1">singleton = object()</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s1">count = sys.getrefcount(singleton)</span>
    <span class="s0">for </span><span class="s1">buf</span><span class="s0">, </span><span class="s1">mask_buf </span><span class="s0">in </span><span class="s1">it:</span>
        <span class="s1">buf[...] = (</span><span class="s4">3</span><span class="s0">, </span><span class="s1">singleton)</span>

    <span class="s0">del </span><span class="s1">buf</span><span class="s0">, </span><span class="s1">mask_buf</span><span class="s0">, </span><span class="s1">it   </span><span class="s3"># delete everything to ensure correct cleanup</span>

    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s3"># The buffer would have included additional items, they must be</span>
        <span class="s3"># cleared correctly:</span>
        <span class="s0">assert </span><span class="s1">sys.getrefcount(singleton) - count == np.count_nonzero(mask)</span>

    <span class="s1">assert_array_equal(arr[~mask]</span><span class="s0">, </span><span class="s1">original[~mask])</span>
    <span class="s0">assert </span><span class="s1">(arr[mask] == np.array((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">singleton)</span><span class="s0">, </span><span class="s1">arr.dtype)).all()</span>
    <span class="s0">del </span><span class="s1">arr</span>

    <span class="s0">if </span><span class="s1">HAS_REFCOUNT:</span>
        <span class="s0">assert </span><span class="s1">sys.getrefcount(singleton) == count</span>


<span class="s0">def </span><span class="s1">test_iter_non_writable_attribute_deletion():</span>
    <span class="s1">it = np.nditer(np.ones(</span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">attr = [</span><span class="s2">&quot;value&quot;</span><span class="s0">, </span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s2">&quot;operands&quot;</span><span class="s0">, </span><span class="s2">&quot;itviews&quot;</span><span class="s0">, </span><span class="s2">&quot;has_delayed_bufalloc&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;iterationneedsapi&quot;</span><span class="s0">, </span><span class="s2">&quot;has_multi_index&quot;</span><span class="s0">, </span><span class="s2">&quot;has_index&quot;</span><span class="s0">, </span><span class="s2">&quot;dtypes&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;ndim&quot;</span><span class="s0">, </span><span class="s2">&quot;nop&quot;</span><span class="s0">, </span><span class="s2">&quot;itersize&quot;</span><span class="s0">, </span><span class="s2">&quot;finished&quot;</span><span class="s1">]</span>

    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">attr:</span>
        <span class="s1">assert_raises(AttributeError</span><span class="s0">, </span><span class="s1">delattr</span><span class="s0">, </span><span class="s1">it</span><span class="s0">, </span><span class="s1">s)</span>


<span class="s0">def </span><span class="s1">test_iter_writable_attribute_deletion():</span>
    <span class="s1">it = np.nditer(np.ones(</span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">attr = [ </span><span class="s2">&quot;multi_index&quot;</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s2">&quot;iterrange&quot;</span><span class="s0">, </span><span class="s2">&quot;iterindex&quot;</span><span class="s1">]</span>
    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">attr:</span>
        <span class="s1">assert_raises(AttributeError</span><span class="s0">, </span><span class="s1">delattr</span><span class="s0">, </span><span class="s1">it</span><span class="s0">, </span><span class="s1">s)</span>


<span class="s0">def </span><span class="s1">test_iter_element_deletion():</span>
    <span class="s1">it = np.nditer(np.ones(</span><span class="s4">3</span><span class="s1">))</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s0">del </span><span class="s1">it[</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s0">del </span><span class="s1">it[</span><span class="s4">1</span><span class="s1">:</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s0">except </span><span class="s1">TypeError:</span>
        <span class="s0">pass</span>
    <span class="s0">except </span><span class="s1">Exception:</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span>

<span class="s0">def </span><span class="s1">test_iter_allocated_array_dtypes():</span>
    <span class="s3"># If the dtype of an allocated output has a shape, the shape gets</span>
    <span class="s3"># tacked onto the end of the result.</span>
    <span class="s1">it = np.nditer(([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">(</span><span class="s2">'i4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))])</span>
    <span class="s0">for </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">it:</span>
        <span class="s1">b[</span><span class="s4">0</span><span class="s1">] = a - </span><span class="s4">1</span>
        <span class="s1">b[</span><span class="s4">1</span><span class="s1">] = a + </span><span class="s4">1</span>
    <span class="s1">assert_equal(it.operands[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">19</span><span class="s0">, </span><span class="s4">21</span><span class="s1">]])</span>

    <span class="s3"># Check the same (less sensitive) thing when `op_axes` with -1 is given.</span>
    <span class="s1">it = np.nditer(([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]]</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">op_dtypes=[</span><span class="s0">None, </span><span class="s1">(</span><span class="s2">'i4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))]</span><span class="s0">,</span>
                   <span class="s1">flags=[</span><span class="s2">&quot;reduce_ok&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">op_axes=[</span><span class="s0">None, </span><span class="s1">(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span>
    <span class="s0">for </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">it:</span>
        <span class="s1">b[</span><span class="s4">0</span><span class="s1">] = a - </span><span class="s4">1</span>
        <span class="s1">b[</span><span class="s4">1</span><span class="s1">] = a + </span><span class="s4">1</span>
    <span class="s1">assert_equal(it.operands[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">19</span><span class="s0">, </span><span class="s4">21</span><span class="s1">]])</span>

    <span class="s3"># Make sure this works for scalars too</span>
    <span class="s1">it = np.nditer((</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">op_dtypes=[</span><span class="s0">None, None, </span><span class="s1">(</span><span class="s2">'i4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))])</span>
    <span class="s0">for </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c </span><span class="s0">in </span><span class="s1">it:</span>
        <span class="s1">c[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = a - b</span>
        <span class="s1">c[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] = a + b</span>
        <span class="s1">c[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = a * b</span>
        <span class="s1">c[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] = a / b</span>
    <span class="s1">assert_equal(it.operands[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">20</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_0d_iter():</span>
    <span class="s3"># Basic test for iteration of 0-d arrays:</span>
    <span class="s1">i = nditer([</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal(next(i)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">assert_equal(i.multi_index</span><span class="s0">, </span><span class="s1">())</span>
    <span class="s1">assert_equal(i.iterindex</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_raises(StopIteration</span><span class="s0">, </span><span class="s1">next</span><span class="s0">, </span><span class="s1">i)</span>
    <span class="s3"># test reset:</span>
    <span class="s1">i.reset()</span>
    <span class="s1">assert_equal(next(i)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">assert_raises(StopIteration</span><span class="s0">, </span><span class="s1">next</span><span class="s0">, </span><span class="s1">i)</span>

    <span class="s3"># test forcing to 0-d</span>
    <span class="s1">i = nditer(np.arange(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">op_axes=[()])</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal(len(i)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">i = nditer(np.arange(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">,</span>
               <span class="s1">op_axes=[()]</span><span class="s0">, </span><span class="s1">itershape=())</span>
    <span class="s1">assert_equal(i.ndim</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal(len(i)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s3"># passing an itershape alone is not enough, the op_axes are also needed</span>
    <span class="s0">with </span><span class="s1">assert_raises(ValueError):</span>
        <span class="s1">nditer(np.arange(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'multi_index'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">itershape=())</span>

    <span class="s3"># Test a more complex buffered casting case (same as another test above)</span>
    <span class="s1">sdt = [(</span><span class="s2">'a'</span><span class="s0">, </span><span class="s2">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'b'</span><span class="s0">, </span><span class="s2">'i8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'c'</span><span class="s0">, </span><span class="s2">'c8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'d'</span><span class="s0">, </span><span class="s2">'O'</span><span class="s1">)]</span>
    <span class="s1">a = np.array(</span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">i = nditer(a</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'buffered'</span><span class="s0">, </span><span class="s2">'refs_ok'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">casting=</span><span class="s2">'unsafe'</span><span class="s0">, </span><span class="s1">op_dtypes=sdt)</span>
    <span class="s1">vals = next(i)</span>
    <span class="s1">assert_equal(vals[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s2">'b'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s2">'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[(</span><span class="s4">0.5</span><span class="s1">)]*</span><span class="s4">3</span><span class="s1">]*</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(vals[</span><span class="s2">'d'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_object_iter_cleanup():</span>
    <span class="s3"># see gh-18450</span>
    <span class="s3"># object arrays can raise a python exception in ufunc inner loops using</span>
    <span class="s3"># nditer, which should cause iteration to stop &amp; cleanup. There were bugs</span>
    <span class="s3"># in the nditer cleanup when decref'ing object arrays.</span>
    <span class="s3"># This test would trigger valgrind &quot;uninitialized read&quot; before the bugfix.</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, lambda</span><span class="s1">: np.zeros((</span><span class="s4">17000</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">) * </span><span class="s0">None</span><span class="s1">)</span>

    <span class="s3"># this more explicit code also triggers the invalid access</span>
    <span class="s1">arr = np.arange(np.BUFSIZE * </span><span class="s4">10</span><span class="s1">).reshape(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">).astype(str)</span>
    <span class="s1">oarr = arr.astype(object)</span>
    <span class="s1">oarr[:</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">] = </span><span class="s0">None</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, lambda</span><span class="s1">: np.add(oarr[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">arr[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]))</span>

    <span class="s3"># followup: this tests for a bug introduced in the first pass of gh-18450,</span>
    <span class="s3"># caused by an incorrect fallthrough of the TypeError</span>
    <span class="s0">class </span><span class="s1">T:</span>
        <span class="s0">def </span><span class="s1">__bool__(self):</span>
            <span class="s0">raise </span><span class="s1">TypeError(</span><span class="s2">&quot;Ambiguous&quot;</span><span class="s1">)</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.logical_or.reduce</span><span class="s0">, </span>
                             <span class="s1">np.array([T()</span><span class="s0">, </span><span class="s1">T()]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'O'</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_object_iter_cleanup_reduce():</span>
    <span class="s3"># Similar as above, but a complex reduction case that was previously</span>
    <span class="s3"># missed (see gh-18810).</span>
    <span class="s3"># The following array is special in that it cannot be flattened:</span>
    <span class="s1">arr = np.array([[</span><span class="s0">None, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]])[::</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">np.sum(arr)</span>

<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;arr&quot;</span><span class="s0">, </span><span class="s1">[</span>
        <span class="s1">np.ones((</span><span class="s4">8000</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=object)[:</span><span class="s0">, </span><span class="s1">::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">,</span>
        <span class="s1">np.ones((</span><span class="s4">8000</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=object</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">,</span>
        <span class="s1">np.ones((</span><span class="s4">8000</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=object)[:</span><span class="s0">, </span><span class="s1">::</span><span class="s4">2</span><span class="s0">, </span><span class="s1">:].copy(</span><span class="s2">&quot;F&quot;</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_object_iter_cleanup_large_reduce(arr):</span>
    <span class="s3"># More complicated calls are possible for large arrays:</span>
    <span class="s1">out = np.ones(</span><span class="s4">8000</span><span class="s0">, </span><span class="s1">dtype=np.intp)</span>
    <span class="s3"># force casting with `dtype=object`</span>
    <span class="s1">res = np.sum(arr</span><span class="s0">, </span><span class="s1">axis=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=object</span><span class="s0">, </span><span class="s1">out=out)</span>
    <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">np.full(</span><span class="s4">8000</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s1">dtype=object))</span>

<span class="s0">def </span><span class="s1">test_iter_too_large():</span>
    <span class="s3"># The total size of the iterator must not exceed the maximum intp due</span>
    <span class="s3"># to broadcasting. Dividing by 1024 will keep it small enough to</span>
    <span class="s3"># give a legal array.</span>
    <span class="s1">size = np.iinfo(np.intp).max // </span><span class="s4">1024</span>
    <span class="s1">arr = np.lib.stride_tricks.as_strided(np.zeros(</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(size</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">, </span><span class="s1">(arr</span><span class="s0">, </span><span class="s1">arr[:</span><span class="s0">, None</span><span class="s1">]))</span>
    <span class="s3"># test the same for multiindex. That may get more interesting when</span>
    <span class="s3"># removing 0 dimensional axis is allowed (since an iterator can grow then)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">nditer</span><span class="s0">,</span>
                  <span class="s1">(arr</span><span class="s0">, </span><span class="s1">arr[:</span><span class="s0">, None</span><span class="s1">])</span><span class="s0">, </span><span class="s1">flags=[</span><span class="s2">'multi_index'</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_iter_too_large_with_multiindex():</span>
    <span class="s3"># When a multi index is being tracked, the error is delayed this</span>
    <span class="s3"># checks the delayed error messages and getting below that by</span>
    <span class="s3"># removing an axis.</span>
    <span class="s1">base_size = </span><span class="s4">2</span><span class="s1">**</span><span class="s4">10</span>
    <span class="s1">num = </span><span class="s4">1</span>
    <span class="s0">while </span><span class="s1">base_size**num &lt; np.iinfo(np.intp).max:</span>
        <span class="s1">num += </span><span class="s4">1</span>

    <span class="s1">shape_template = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] * num</span>
    <span class="s1">arrays = []</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(num):</span>
        <span class="s1">shape = shape_template[:]</span>
        <span class="s1">shape[i * </span><span class="s4">2</span><span class="s1">] = </span><span class="s4">2</span><span class="s1">**</span><span class="s4">10</span>
        <span class="s1">arrays.append(np.empty(shape))</span>
    <span class="s1">arrays = tuple(arrays)</span>

    <span class="s3"># arrays are now too large to be broadcast. The different modes test</span>
    <span class="s3"># different nditer functionality with or without GIL.</span>
    <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">6</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">assert_raises(ValueError):</span>
            <span class="s1">_multiarray_tests.test_nditer_too_large(arrays</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">mode)</span>
    <span class="s3"># but if we do nothing with the nditer, it can be constructed:</span>
    <span class="s1">_multiarray_tests.test_nditer_too_large(arrays</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span>

    <span class="s3"># When an axis is removed, things should work again (half the time):</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(num):</span>
        <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">6</span><span class="s1">):</span>
            <span class="s3"># an axis with size 1024 is removed:</span>
            <span class="s1">_multiarray_tests.test_nditer_too_large(arrays</span><span class="s0">, </span><span class="s1">i*</span><span class="s4">2</span><span class="s0">, </span><span class="s1">mode)</span>
            <span class="s3"># an axis with size 1 is removed:</span>
            <span class="s0">with </span><span class="s1">assert_raises(ValueError):</span>
                <span class="s1">_multiarray_tests.test_nditer_too_large(arrays</span><span class="s0">, </span><span class="s1">i*</span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">1</span><span class="s0">, </span><span class="s1">mode)</span>

<span class="s0">def </span><span class="s1">test_writebacks():</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">au = a.byteswap().newbyteorder()</span>
    <span class="s1">assert_(a.dtype.byteorder != au.dtype.byteorder)</span>
    <span class="s1">it = nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s1">it.operands[</span><span class="s4">0</span><span class="s1">][:] = </span><span class="s4">100</span>
    <span class="s1">assert_equal(au</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span>
    <span class="s3"># do it again, this time raise an error,</span>
    <span class="s1">it = nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">it:</span>
            <span class="s1">assert_equal(au.flags.writeable</span><span class="s0">, False</span><span class="s1">)</span>
            <span class="s1">it.operands[</span><span class="s4">0</span><span class="s1">][:] = </span><span class="s4">0</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">'exit context manager on exception'</span><span class="s1">)</span>
    <span class="s0">except</span><span class="s1">:</span>
        <span class="s0">pass</span>
    <span class="s1">assert_equal(au</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_equal(au.flags.writeable</span><span class="s0">, True</span><span class="s1">)</span>
    <span class="s3"># cannot reuse i outside context manager</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">getattr</span><span class="s0">, </span><span class="s1">it</span><span class="s0">, </span><span class="s2">'operands'</span><span class="s1">)</span>

    <span class="s1">it = nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s1">x = it.operands[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">x[:] = </span><span class="s4">6</span>
        <span class="s1">assert_(x.flags.writebackifcopy)</span>
    <span class="s1">assert_equal(au</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">x.flags.writebackifcopy)</span>
    <span class="s1">x[:] = </span><span class="s4">123 </span><span class="s3"># x.data still valid</span>
    <span class="s1">assert_equal(au</span><span class="s0">, </span><span class="s4">6</span><span class="s1">) </span><span class="s3"># but not connected to au</span>

    <span class="s1">it = nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                 <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                 <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s3"># reentering works</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s0">with </span><span class="s1">it:</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it:</span>
                <span class="s1">x[...] = </span><span class="s4">123</span>

    <span class="s1">it = nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                 <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                 <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s3"># make sure exiting the inner context manager closes the iterator</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s0">with </span><span class="s1">it:</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it:</span>
                <span class="s1">x[...] = </span><span class="s4">123</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">getattr</span><span class="s0">, </span><span class="s1">it</span><span class="s0">, </span><span class="s2">'operands'</span><span class="s1">)</span>
    <span class="s3"># do not crash if original data array is decrefed</span>
    <span class="s1">it = nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                 <span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                 <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
    <span class="s0">del </span><span class="s1">au</span>
    <span class="s0">with </span><span class="s1">it:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it:</span>
            <span class="s1">x[...] = </span><span class="s4">123</span>
    <span class="s3"># make sure we cannot reenter the closed iterator</span>
    <span class="s1">enter = it.__enter__</span>
    <span class="s1">assert_raises(RuntimeError</span><span class="s0">, </span><span class="s1">enter)</span>

<span class="s0">def </span><span class="s1">test_close_equivalent():</span>
    <span class="s6">''' using a context amanger and using nditer.close are equivalent 
    '''</span>
    <span class="s0">def </span><span class="s1">add_close(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">out=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">addop = np.add</span>
        <span class="s1">it = np.nditer([x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">out]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">,</span><span class="s2">'allocate'</span><span class="s1">]])</span>
        <span class="s0">for </span><span class="s1">(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c) </span><span class="s0">in </span><span class="s1">it:</span>
            <span class="s1">addop(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">out=c)</span>
        <span class="s1">ret = it.operands[</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">it.close()</span>
        <span class="s0">return </span><span class="s1">ret</span>

    <span class="s0">def </span><span class="s1">add_context(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">out=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">addop = np.add</span>
        <span class="s1">it = np.nditer([x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">out]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">,</span>
                    <span class="s1">[[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'readonly'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'writeonly'</span><span class="s0">,</span><span class="s2">'allocate'</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">it:</span>
            <span class="s0">for </span><span class="s1">(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c) </span><span class="s0">in </span><span class="s1">it:</span>
                <span class="s1">addop(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">out=c)</span>
            <span class="s0">return </span><span class="s1">it.operands[</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">z = add_close(range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">assert_equal(z</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">z = add_context(range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">assert_equal(z</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

<span class="s0">def </span><span class="s1">test_close_raises():</span>
    <span class="s1">it = np.nditer(np.arange(</span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">assert_equal (next(it)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">it.close()</span>
    <span class="s1">assert_raises(StopIteration</span><span class="s0">, </span><span class="s1">next</span><span class="s0">, </span><span class="s1">it)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">getattr</span><span class="s0">, </span><span class="s1">it</span><span class="s0">, </span><span class="s2">'operands'</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">test_close_parameters():</span>
    <span class="s1">it = np.nditer(np.arange(</span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">it.close</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;Python lacks refcounts&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_warn_noclose():</span>
    <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'f4'</span><span class="s1">)</span>
    <span class="s1">au = a.byteswap().newbyteorder()</span>
    <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
        <span class="s1">sup.record(RuntimeWarning)</span>
        <span class="s1">it = np.nditer(au</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'readwrite'</span><span class="s0">, </span><span class="s2">'updateifcopy'</span><span class="s1">]]</span><span class="s0">,</span>
                        <span class="s1">casting=</span><span class="s2">'equiv'</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(</span><span class="s2">'f4'</span><span class="s1">)])</span>
        <span class="s0">del </span><span class="s1">it</span>
        <span class="s0">assert </span><span class="s1">len(sup.log) == </span><span class="s4">1</span>


<span class="s1">@pytest.mark.skipif(sys.version_info[:</span><span class="s4">2</span><span class="s1">] == (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s1">) </span><span class="s0">and </span><span class="s1">sys.platform == </span><span class="s2">&quot;win32&quot;</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s2">&quot;Errors with Python 3.9 on Windows&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;Python lacks refcounts&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize([</span><span class="s2">&quot;in_dtype&quot;</span><span class="s0">, </span><span class="s2">&quot;buf_dtype&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s2">&quot;O&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;O&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s3"># most simple cases</span>
         <span class="s1">(</span><span class="s2">&quot;i,O&quot;</span><span class="s0">, </span><span class="s2">&quot;O,O&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s3"># structured partially only copying O</span>
         <span class="s1">(</span><span class="s2">&quot;O,i&quot;</span><span class="s0">, </span><span class="s2">&quot;i,O&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s3"># structured casting to and from O</span>
         <span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;steps&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_partial_iteration_cleanup(in_dtype</span><span class="s0">, </span><span class="s1">buf_dtype</span><span class="s0">, </span><span class="s1">steps):</span>
    <span class="s1">value = </span><span class="s4">123  </span><span class="s3"># relies on python cache (leak-check will still find it)</span>
    <span class="s1">arr = np.full(int(np.BUFSIZE * </span><span class="s4">2.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">value).astype(in_dtype)</span>
    <span class="s1">count = sys.getrefcount(value)</span>

    <span class="s1">it = np.nditer(arr</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(buf_dtype)]</span><span class="s0">,</span>
            <span class="s1">flags=[</span><span class="s2">&quot;buffered&quot;</span><span class="s0">, </span><span class="s2">&quot;external_loop&quot;</span><span class="s0">, </span><span class="s2">&quot;refs_ok&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">step </span><span class="s0">in </span><span class="s1">range(steps):</span>
        <span class="s3"># The iteration finishes in 3 steps, the first two are partial</span>
        <span class="s1">next(it)</span>

    <span class="s3"># Note that resetting does not free references</span>
    <span class="s0">del </span><span class="s1">it</span>
    <span class="s1">break_cycles()</span>
    <span class="s1">break_cycles()</span>
    <span class="s0">assert </span><span class="s1">count == sys.getrefcount(value)</span>

    <span class="s3"># Repeat the test with `iternext`</span>
    <span class="s1">it = np.nditer(arr</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(buf_dtype)]</span><span class="s0">,</span>
                   <span class="s1">flags=[</span><span class="s2">&quot;buffered&quot;</span><span class="s0">, </span><span class="s2">&quot;external_loop&quot;</span><span class="s0">, </span><span class="s2">&quot;refs_ok&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">step </span><span class="s0">in </span><span class="s1">range(steps):</span>
        <span class="s1">it.iternext()</span>

    <span class="s0">del </span><span class="s1">it  </span><span class="s3"># should ensure cleanup</span>
    <span class="s1">break_cycles()</span>
    <span class="s1">break_cycles()</span>
    <span class="s0">assert </span><span class="s1">count == sys.getrefcount(value)</span>


<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;Python lacks refcounts&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize([</span><span class="s2">&quot;in_dtype&quot;</span><span class="s0">, </span><span class="s2">&quot;buf_dtype&quot;</span><span class="s1">]</span><span class="s0">,</span>
         <span class="s1">[(</span><span class="s2">&quot;O&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s3"># most simple cases</span>
          <span class="s1">(</span><span class="s2">&quot;O,i&quot;</span><span class="s0">, </span><span class="s2">&quot;i,O&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s3"># structured casting to and from O</span>
          <span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_partial_iteration_error(in_dtype</span><span class="s0">, </span><span class="s1">buf_dtype):</span>
    <span class="s1">value = </span><span class="s4">123  </span><span class="s3"># relies on python cache (leak-check will still find it)</span>
    <span class="s1">arr = np.full(int(np.BUFSIZE * </span><span class="s4">2.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">value).astype(in_dtype)</span>
    <span class="s0">if </span><span class="s1">in_dtype == </span><span class="s2">&quot;O&quot;</span><span class="s1">:</span>
        <span class="s1">arr[int(np.BUFSIZE * </span><span class="s4">1.5</span><span class="s1">)] = </span><span class="s0">None</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">arr[int(np.BUFSIZE * </span><span class="s4">1.5</span><span class="s1">)][</span><span class="s2">&quot;f0&quot;</span><span class="s1">] = </span><span class="s0">None</span>

    <span class="s1">count = sys.getrefcount(value)</span>

    <span class="s1">it = np.nditer(arr</span><span class="s0">, </span><span class="s1">op_dtypes=[np.dtype(buf_dtype)]</span><span class="s0">,</span>
            <span class="s1">flags=[</span><span class="s2">&quot;buffered&quot;</span><span class="s0">, </span><span class="s2">&quot;external_loop&quot;</span><span class="s0">, </span><span class="s2">&quot;refs_ok&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s3"># pytest.raises seems to have issues with the error originating</span>
        <span class="s3"># in the for loop, so manually unravel:</span>
        <span class="s1">next(it)</span>
        <span class="s1">next(it)  </span><span class="s3"># raises TypeError</span>

    <span class="s3"># Repeat the test with `iternext` after resetting, the buffers should</span>
    <span class="s3"># already be cleared from any references, so resetting is sufficient.</span>
    <span class="s1">it.reset()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">it.iternext()</span>
        <span class="s1">it.iternext()</span>

    <span class="s0">assert </span><span class="s1">count == sys.getrefcount(value)</span>


<span class="s0">def </span><span class="s1">test_debug_print(capfd):</span>
    <span class="s6">&quot;&quot;&quot; 
    Matches the expected output of a debug print with the actual output. 
    Note that the iterator dump should not be considered stable API, 
    this test is mainly to ensure the print does not crash. 
 
    Currently uses a subprocess to avoid dealing with the C level `printf`s. 
    &quot;&quot;&quot;</span>
    <span class="s3"># the expected output with all addresses and sizes stripped (they vary</span>
    <span class="s3"># and/or are platform dependent).</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot; 
    ------ BEGIN ITERATOR DUMP ------ 
    | Iterator Address: 
    | ItFlags: BUFFER REDUCE REUSE_REDUCE_LOOPS 
    | NDim: 2 
    | NOp: 2 
    | IterSize: 50 
    | IterStart: 0 
    | IterEnd: 50 
    | IterIndex: 0 
    | Iterator SizeOf: 
    | BufferData SizeOf: 
    | AxisData SizeOf: 
    | 
    | Perm: 0 1 
    | DTypes: 
    | DTypes: dtype('float64') dtype('int32') 
    | InitDataPtrs: 
    | BaseOffsets: 0 0 
    | Operands: 
    | Operand DTypes: dtype('int64') dtype('float64') 
    | OpItFlags: 
    |   Flags[0]: READ CAST ALIGNED 
    |   Flags[1]: READ WRITE CAST ALIGNED REDUCE 
    | 
    | BufferData: 
    |   BufferSize: 50 
    |   Size: 5 
    |   BufIterEnd: 5 
    |   REDUCE Pos: 0 
    |   REDUCE OuterSize: 10 
    |   REDUCE OuterDim: 1 
    |   Strides: 8 4 
    |   Ptrs: 
    |   REDUCE Outer Strides: 40 0 
    |   REDUCE Outer Ptrs: 
    |   ReadTransferFn: 
    |   ReadTransferData: 
    |   WriteTransferFn: 
    |   WriteTransferData: 
    |   Buffers: 
    | 
    | AxisData[0]: 
    |   Shape: 5 
    |   Index: 0 
    |   Strides: 16 8 
    |   Ptrs: 
    | AxisData[1]: 
    |   Shape: 10 
    |   Index: 0 
    |   Strides: 80 0 
    |   Ptrs: 
    ------- END ITERATOR DUMP ------- 
    &quot;&quot;&quot;</span><span class="s1">.strip().splitlines()</span>

    <span class="s1">arr1 = np.arange(</span><span class="s4">100</span><span class="s0">, </span><span class="s1">dtype=np.int64).reshape(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">::</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">arr2 = np.arange(</span><span class="s4">5.</span><span class="s1">)</span>
    <span class="s1">it = np.nditer((arr1</span><span class="s0">, </span><span class="s1">arr2)</span><span class="s0">, </span><span class="s1">op_dtypes=[</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;i4&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;unsafe&quot;</span><span class="s0">,</span>
                   <span class="s1">flags=[</span><span class="s2">&quot;reduce_ok&quot;</span><span class="s0">, </span><span class="s2">&quot;buffered&quot;</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">op_flags=[[</span><span class="s2">&quot;readonly&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;readwrite&quot;</span><span class="s1">]])</span>
    <span class="s1">it.debug_print()</span>
    <span class="s1">res = capfd.readouterr().out</span>
    <span class="s1">res = res.strip().splitlines()</span>

    <span class="s0">assert </span><span class="s1">len(res) == len(expected)</span>
    <span class="s0">for </span><span class="s1">res_line</span><span class="s0">, </span><span class="s1">expected_line </span><span class="s0">in </span><span class="s1">zip(res</span><span class="s0">, </span><span class="s1">expected):</span>
        <span class="s3"># The actual output may have additional pointers listed that are</span>
        <span class="s3"># stripped from the example output:</span>
        <span class="s0">assert </span><span class="s1">res_line.startswith(expected_line.strip())</span>
</pre>
</body>
</html>