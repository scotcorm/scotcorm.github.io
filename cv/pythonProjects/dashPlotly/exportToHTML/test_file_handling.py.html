<html>
<head>
<title>test_file_handling.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_file_handling.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.compat </span><span class="s0">import </span><span class="s1">is_platform_little_endian</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">HDFStore</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span><span class="s0">,</span>
    <span class="s1">read_hdf</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">pandas.tests.io.pytables.common </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">_maybe_remove</span><span class="s0">,</span>
    <span class="s1">ensure_clean_path</span><span class="s0">,</span>
    <span class="s1">ensure_clean_store</span><span class="s0">,</span>
    <span class="s1">tables</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s0">from </span><span class="s1">pandas.io </span><span class="s0">import </span><span class="s1">pytables </span><span class="s0">as </span><span class="s1">pytables</span>
<span class="s0">from </span><span class="s1">pandas.io.pytables </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">ClosedFileError</span><span class="s0">,</span>
    <span class="s1">PossibleDataLossError</span><span class="s0">,</span>
    <span class="s1">Term</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s1">pytestmark = pytest.mark.single</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;mode&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;r&quot;</span><span class="s0">, </span><span class="s2">&quot;r+&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_mode(setup_path</span><span class="s0">, </span><span class="s1">mode):</span>

    <span class="s1">df = tm.makeTimeDataFrame()</span>
    <span class="s1">msg = </span><span class="s2">r&quot;[\S]* does not exist&quot;</span>
    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s3"># constructor</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;r&quot;</span><span class="s0">, </span><span class="s2">&quot;r+&quot;</span><span class="s1">]:</span>
            <span class="s0">with </span><span class="s1">pytest.raises(OSError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">HDFStore(path</span><span class="s0">, </span><span class="s1">mode=mode)</span>

        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">store = HDFStore(path</span><span class="s0">, </span><span class="s1">mode=mode)</span>
            <span class="s0">assert </span><span class="s1">store._handle.mode == mode</span>
            <span class="s1">store.close()</span>

    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s3"># context</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;r&quot;</span><span class="s0">, </span><span class="s2">&quot;r+&quot;</span><span class="s1">]:</span>
            <span class="s0">with </span><span class="s1">pytest.raises(OSError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s0">with </span><span class="s1">HDFStore(path</span><span class="s0">, </span><span class="s1">mode=mode) </span><span class="s0">as </span><span class="s1">store:</span>
                    <span class="s0">pass</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">with </span><span class="s1">HDFStore(path</span><span class="s0">, </span><span class="s1">mode=mode) </span><span class="s0">as </span><span class="s1">store:</span>
                <span class="s0">assert </span><span class="s1">store._handle.mode == mode</span>

    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s3"># conv write</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;r&quot;</span><span class="s0">, </span><span class="s2">&quot;r+&quot;</span><span class="s1">]:</span>
            <span class="s0">with </span><span class="s1">pytest.raises(OSError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">df.to_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=mode)</span>
            <span class="s1">df.to_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">df.to_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=mode)</span>

        <span class="s3"># conv read</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;w&quot;</span><span class="s1">]:</span>
            <span class="s1">msg = (</span>
                <span class="s2">&quot;mode w is not allowed while performing a read. &quot;</span>
                <span class="s2">r&quot;Allowed modes are r, r\+ and a.&quot;</span>
            <span class="s1">)</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">read_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=mode)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">result = read_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=mode)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_default_mode(setup_path):</span>
    <span class="s3"># read_hdf uses default mode</span>
    <span class="s1">df = tm.makeTimeDataFrame()</span>
    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">df.to_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
        <span class="s1">result = read_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_reopen_handle(setup_path):</span>

    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s1">store = HDFStore(path</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">store[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = tm.makeTimeSeries()</span>

        <span class="s1">msg = (</span>
            <span class="s2">r&quot;Re-opening the file \[[\S]*\] with mode \[a\] will delete the &quot;</span>
            <span class="s2">&quot;current file!&quot;</span>
        <span class="s1">)</span>
        <span class="s3"># invalid mode change</span>
        <span class="s0">with </span><span class="s1">pytest.raises(PossibleDataLossError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.open(</span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>

        <span class="s1">store.close()</span>
        <span class="s0">assert not </span><span class="s1">store.is_open</span>

        <span class="s3"># truncation ok here</span>
        <span class="s1">store.open(</span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">store.is_open</span>
        <span class="s0">assert </span><span class="s1">len(store) == </span><span class="s4">0</span>
        <span class="s1">store.close()</span>
        <span class="s0">assert not </span><span class="s1">store.is_open</span>

        <span class="s1">store = HDFStore(path</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">store[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = tm.makeTimeSeries()</span>

        <span class="s3"># reopen as read</span>
        <span class="s1">store.open(</span><span class="s2">&quot;r&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">store.is_open</span>
        <span class="s0">assert </span><span class="s1">len(store) == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">store._mode == </span><span class="s2">&quot;r&quot;</span>
        <span class="s1">store.close()</span>
        <span class="s0">assert not </span><span class="s1">store.is_open</span>

        <span class="s3"># reopen as append</span>
        <span class="s1">store.open(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">store.is_open</span>
        <span class="s0">assert </span><span class="s1">len(store) == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">store._mode == </span><span class="s2">&quot;a&quot;</span>
        <span class="s1">store.close()</span>
        <span class="s0">assert not </span><span class="s1">store.is_open</span>

        <span class="s3"># reopen as append (again)</span>
        <span class="s1">store.open(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">store.is_open</span>
        <span class="s0">assert </span><span class="s1">len(store) == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">store._mode == </span><span class="s2">&quot;a&quot;</span>
        <span class="s1">store.close()</span>
        <span class="s0">assert not </span><span class="s1">store.is_open</span>


<span class="s0">def </span><span class="s1">test_open_args(setup_path):</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s1">df = tm.makeDataFrame()</span>

        <span class="s3"># create an in memory store</span>
        <span class="s1">store = HDFStore(</span>
            <span class="s1">path</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">driver=</span><span class="s2">&quot;H5FD_CORE&quot;</span><span class="s0">, </span><span class="s1">driver_core_backing_store=</span><span class="s4">0</span>
        <span class="s1">)</span>
        <span class="s1">store[</span><span class="s2">&quot;df&quot;</span><span class="s1">] = df</span>
        <span class="s1">store.append(</span><span class="s2">&quot;df2&quot;</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">tm.assert_frame_equal(store[</span><span class="s2">&quot;df&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df)</span>
        <span class="s1">tm.assert_frame_equal(store[</span><span class="s2">&quot;df2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">store.close()</span>

    <span class="s3"># the file should not have actually been written</span>
    <span class="s0">assert not </span><span class="s1">os.path.exists(path)</span>


<span class="s0">def </span><span class="s1">test_flush(setup_path):</span>

    <span class="s0">with </span><span class="s1">ensure_clean_store(setup_path) </span><span class="s0">as </span><span class="s1">store:</span>
        <span class="s1">store[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = tm.makeTimeSeries()</span>
        <span class="s1">store.flush()</span>
        <span class="s1">store.flush(fsync=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_complibs_default_settings(setup_path):</span>
    <span class="s3"># GH15943</span>
    <span class="s1">df = tm.makeDataFrame()</span>

    <span class="s3"># Set complevel and check if complib is automatically set to</span>
    <span class="s3"># default value</span>
    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">tmpfile:</span>
        <span class="s1">df.to_hdf(tmpfile</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">complevel=</span><span class="s4">9</span><span class="s1">)</span>
        <span class="s1">result = read_hdf(tmpfile</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">tables.open_file(tmpfile</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">h5file:</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">h5file.walk_nodes(where=</span><span class="s2">&quot;/df&quot;</span><span class="s0">, </span><span class="s1">classname=</span><span class="s2">&quot;Leaf&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">node.filters.complevel == </span><span class="s4">9</span>
                <span class="s0">assert </span><span class="s1">node.filters.complib == </span><span class="s2">&quot;zlib&quot;</span>

    <span class="s3"># Set complib and check to see if compression is disabled</span>
    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">tmpfile:</span>
        <span class="s1">df.to_hdf(tmpfile</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">complib=</span><span class="s2">&quot;zlib&quot;</span><span class="s1">)</span>
        <span class="s1">result = read_hdf(tmpfile</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">tables.open_file(tmpfile</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">h5file:</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">h5file.walk_nodes(where=</span><span class="s2">&quot;/df&quot;</span><span class="s0">, </span><span class="s1">classname=</span><span class="s2">&quot;Leaf&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">node.filters.complevel == </span><span class="s4">0</span>
                <span class="s0">assert </span><span class="s1">node.filters.complib </span><span class="s0">is None</span>

    <span class="s3"># Check if not setting complib or complevel results in no compression</span>
    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">tmpfile:</span>
        <span class="s1">df.to_hdf(tmpfile</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>
        <span class="s1">result = read_hdf(tmpfile</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">tables.open_file(tmpfile</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">h5file:</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">h5file.walk_nodes(where=</span><span class="s2">&quot;/df&quot;</span><span class="s0">, </span><span class="s1">classname=</span><span class="s2">&quot;Leaf&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">node.filters.complevel == </span><span class="s4">0</span>
                <span class="s0">assert </span><span class="s1">node.filters.complib </span><span class="s0">is None</span>

    <span class="s3"># Check if file-defaults can be overridden on a per table basis</span>
    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">tmpfile:</span>
        <span class="s1">store = HDFStore(tmpfile)</span>
        <span class="s1">store.append(</span><span class="s2">&quot;dfc&quot;</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">complevel=</span><span class="s4">9</span><span class="s0">, </span><span class="s1">complib=</span><span class="s2">&quot;blosc&quot;</span><span class="s1">)</span>
        <span class="s1">store.append(</span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">df)</span>
        <span class="s1">store.close()</span>

        <span class="s0">with </span><span class="s1">tables.open_file(tmpfile</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">h5file:</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">h5file.walk_nodes(where=</span><span class="s2">&quot;/df&quot;</span><span class="s0">, </span><span class="s1">classname=</span><span class="s2">&quot;Leaf&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">node.filters.complevel == </span><span class="s4">0</span>
                <span class="s0">assert </span><span class="s1">node.filters.complib </span><span class="s0">is None</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">h5file.walk_nodes(where=</span><span class="s2">&quot;/dfc&quot;</span><span class="s0">, </span><span class="s1">classname=</span><span class="s2">&quot;Leaf&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">node.filters.complevel == </span><span class="s4">9</span>
                <span class="s0">assert </span><span class="s1">node.filters.complib == </span><span class="s2">&quot;blosc&quot;</span>


<span class="s0">def </span><span class="s1">test_complibs(setup_path):</span>
    <span class="s3"># GH14478</span>
    <span class="s1">df = tm.makeDataFrame()</span>

    <span class="s3"># Building list of all complibs and complevels tuples</span>
    <span class="s1">all_complibs = tables.filters.all_complibs</span>
    <span class="s3"># Remove lzo if its not available on this platform</span>
    <span class="s0">if not </span><span class="s1">tables.which_lib_version(</span><span class="s2">&quot;lzo&quot;</span><span class="s1">):</span>
        <span class="s1">all_complibs.remove(</span><span class="s2">&quot;lzo&quot;</span><span class="s1">)</span>
    <span class="s3"># Remove bzip2 if its not available on this platform</span>
    <span class="s0">if not </span><span class="s1">tables.which_lib_version(</span><span class="s2">&quot;bzip2&quot;</span><span class="s1">):</span>
        <span class="s1">all_complibs.remove(</span><span class="s2">&quot;bzip2&quot;</span><span class="s1">)</span>

    <span class="s1">all_levels = range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">all_tests = [(lib</span><span class="s0">, </span><span class="s1">lvl) </span><span class="s0">for </span><span class="s1">lib </span><span class="s0">in </span><span class="s1">all_complibs </span><span class="s0">for </span><span class="s1">lvl </span><span class="s0">in </span><span class="s1">all_levels]</span>

    <span class="s0">for </span><span class="s1">(lib</span><span class="s0">, </span><span class="s1">lvl) </span><span class="s0">in </span><span class="s1">all_tests:</span>
        <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">tmpfile:</span>
            <span class="s1">gname = </span><span class="s2">&quot;foo&quot;</span>

            <span class="s3"># Write and read file to see if data is consistent</span>
            <span class="s1">df.to_hdf(tmpfile</span><span class="s0">, </span><span class="s1">gname</span><span class="s0">, </span><span class="s1">complib=lib</span><span class="s0">, </span><span class="s1">complevel=lvl)</span>
            <span class="s1">result = read_hdf(tmpfile</span><span class="s0">, </span><span class="s1">gname)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

            <span class="s3"># Open file and check metadata</span>
            <span class="s3"># for correct amount of compression</span>
            <span class="s1">h5table = tables.open_file(tmpfile</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r&quot;</span><span class="s1">)</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">h5table.walk_nodes(where=</span><span class="s2">&quot;/&quot; </span><span class="s1">+ gname</span><span class="s0">, </span><span class="s1">classname=</span><span class="s2">&quot;Leaf&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">node.filters.complevel == lvl</span>
                <span class="s0">if </span><span class="s1">lvl == </span><span class="s4">0</span><span class="s1">:</span>
                    <span class="s0">assert </span><span class="s1">node.filters.complib </span><span class="s0">is None</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s0">assert </span><span class="s1">node.filters.complib == lib</span>
            <span class="s1">h5table.close()</span>


<span class="s1">@pytest.mark.skipif(</span>
    <span class="s0">not </span><span class="s1">is_platform_little_endian()</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;reason platform is not little endian&quot;</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_encoding(setup_path):</span>

    <span class="s0">with </span><span class="s1">ensure_clean_store(setup_path) </span><span class="s0">as </span><span class="s1">store:</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s2">&quot;bar&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">df.loc[</span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">] = np.nan</span>
        <span class="s1">df.loc[</span><span class="s4">3</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">] = np.nan</span>
        <span class="s1">_maybe_remove(store</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>
        <span class="s1">store.append(</span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;ascii&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(store[</span><span class="s2">&quot;df&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">expected = df.reindex(columns=[</span><span class="s2">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s1">result = store.select(</span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">Term(</span><span class="s2">&quot;columns=A&quot;</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;ascii&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;val&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s5">b&quot;E</span><span class="s0">\xc9</span><span class="s5">, 17&quot;</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">b&quot;E</span><span class="s0">\xc9</span><span class="s5">, 17&quot;</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">b&quot;EE, 17&quot;</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">b&quot;E</span><span class="s0">\xc9</span><span class="s5">, 17&quot;</span><span class="s0">, </span><span class="s5">b&quot;</span><span class="s0">\xf8\xfc</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">b&quot;</span><span class="s0">\xf8\xfc</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">b&quot;A</span><span class="s0">\xf8\xfc</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[np.nan</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">b&quot;A</span><span class="s0">\xf8\xfc</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;b&quot;</span><span class="s0">, </span><span class="s5">b&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;category&quot;</span><span class="s0">, </span><span class="s1">object])</span>
<span class="s0">def </span><span class="s1">test_latin_encoding(setup_path</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">val):</span>
    <span class="s1">enc = </span><span class="s2">&quot;latin-1&quot;</span>
    <span class="s1">nan_rep = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">key = </span><span class="s2">&quot;data&quot;</span>

    <span class="s1">val = [x.decode(enc) </span><span class="s0">if </span><span class="s1">isinstance(x</span><span class="s0">, </span><span class="s1">bytes) </span><span class="s0">else </span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">val]</span>
    <span class="s1">ser = Series(val</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">store:</span>
        <span class="s1">ser.to_hdf(store</span><span class="s0">, </span><span class="s1">key</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">encoding=enc</span><span class="s0">, </span><span class="s1">nan_rep=nan_rep)</span>
        <span class="s1">retr = read_hdf(store</span><span class="s0">, </span><span class="s1">key)</span>

    <span class="s1">s_nan = ser.replace(nan_rep</span><span class="s0">, </span><span class="s1">np.nan)</span>

    <span class="s1">tm.assert_series_equal(s_nan</span><span class="s0">, </span><span class="s1">retr)</span>


<span class="s0">def </span><span class="s1">test_multiple_open_close(setup_path):</span>
    <span class="s3"># gh-4409: open &amp; close multiple times</span>

    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s1">df = tm.makeDataFrame()</span>
        <span class="s1">df.to_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;table&quot;</span><span class="s1">)</span>

        <span class="s3"># single</span>
        <span class="s1">store = HDFStore(path)</span>
        <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">not in </span><span class="s1">store.info()</span>
        <span class="s0">assert </span><span class="s1">store.is_open</span>

        <span class="s1">store.close()</span>
        <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store.info()</span>
        <span class="s0">assert not </span><span class="s1">store.is_open</span>

    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s0">if </span><span class="s1">pytables._table_file_open_policy_is_strict:</span>
            <span class="s3"># multiples</span>
            <span class="s1">store1 = HDFStore(path)</span>
            <span class="s1">msg = (</span>
                <span class="s2">r&quot;The file [\S]* is already opened\.  Please close it before &quot;</span>
                <span class="s2">r&quot;reopening in write mode\.&quot;</span>
            <span class="s1">)</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">HDFStore(path)</span>

            <span class="s1">store1.close()</span>
        <span class="s0">else</span><span class="s1">:</span>

            <span class="s3"># multiples</span>
            <span class="s1">store1 = HDFStore(path)</span>
            <span class="s1">store2 = HDFStore(path)</span>

            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">not in </span><span class="s1">store1.info()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">not in </span><span class="s1">store2.info()</span>
            <span class="s0">assert </span><span class="s1">store1.is_open</span>
            <span class="s0">assert </span><span class="s1">store2.is_open</span>

            <span class="s1">store1.close()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store1.info()</span>
            <span class="s0">assert not </span><span class="s1">store1.is_open</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">not in </span><span class="s1">store2.info()</span>
            <span class="s0">assert </span><span class="s1">store2.is_open</span>

            <span class="s1">store2.close()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store1.info()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store2.info()</span>
            <span class="s0">assert not </span><span class="s1">store1.is_open</span>
            <span class="s0">assert not </span><span class="s1">store2.is_open</span>

            <span class="s3"># nested close</span>
            <span class="s1">store = HDFStore(path</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
            <span class="s1">store.append(</span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">df)</span>

            <span class="s1">store2 = HDFStore(path)</span>
            <span class="s1">store2.append(</span><span class="s2">&quot;df2&quot;</span><span class="s0">, </span><span class="s1">df)</span>
            <span class="s1">store2.close()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store2.info()</span>
            <span class="s0">assert not </span><span class="s1">store2.is_open</span>

            <span class="s1">store.close()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store.info()</span>
            <span class="s0">assert not </span><span class="s1">store.is_open</span>

            <span class="s3"># double closing</span>
            <span class="s1">store = HDFStore(path</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
            <span class="s1">store.append(</span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">df)</span>

            <span class="s1">store2 = HDFStore(path)</span>
            <span class="s1">store.close()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store.info()</span>
            <span class="s0">assert not </span><span class="s1">store.is_open</span>

            <span class="s1">store2.close()</span>
            <span class="s0">assert </span><span class="s2">&quot;CLOSED&quot; </span><span class="s0">in </span><span class="s1">store2.info()</span>
            <span class="s0">assert not </span><span class="s1">store2.is_open</span>

    <span class="s3"># ops on a closed store</span>
    <span class="s0">with </span><span class="s1">ensure_clean_path(setup_path) </span><span class="s0">as </span><span class="s1">path:</span>

        <span class="s1">df = tm.makeDataFrame()</span>
        <span class="s1">df.to_hdf(path</span><span class="s0">, </span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;table&quot;</span><span class="s1">)</span>

        <span class="s1">store = HDFStore(path)</span>
        <span class="s1">store.close()</span>

        <span class="s1">msg = </span><span class="s2">r&quot;[\S]* file is not open!&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.keys()</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s2">&quot;df&quot; </span><span class="s0">in </span><span class="s1">store</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">len(store)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store[</span><span class="s2">&quot;df&quot;</span><span class="s1">]</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.select(</span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.get(</span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.append(</span><span class="s2">&quot;df2&quot;</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.put(</span><span class="s2">&quot;df3&quot;</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.get_storer(</span><span class="s2">&quot;df2&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.remove(</span><span class="s2">&quot;df2&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ClosedFileError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.select(</span><span class="s2">&quot;df&quot;</span><span class="s1">)</span>

        <span class="s1">msg = </span><span class="s2">&quot;'HDFStore' object has no attribute 'df'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(AttributeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">store.df</span>


<span class="s0">def </span><span class="s1">test_fspath():</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;foo.h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s0">with </span><span class="s1">HDFStore(path) </span><span class="s0">as </span><span class="s1">store:</span>
            <span class="s0">assert </span><span class="s1">os.fspath(store) == str(path)</span>
</pre>
</body>
</html>