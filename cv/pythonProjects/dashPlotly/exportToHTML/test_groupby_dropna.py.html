<html>
<head>
<title>test_groupby_dropna.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_groupby_dropna.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, tuples, outputs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">123.23</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">123.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">12.3</span><span class="s0">, </span><span class="s3">123.23</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">233.0</span><span class="s0">, </span><span class="s3">123.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_dropna_multi_index_dataframe_nan_in_one_group(</span>
    <span class="s1">dropna</span><span class="s0">, </span><span class="s1">tuples</span><span class="s0">, </span><span class="s1">outputs</span><span class="s0">, </span><span class="s1">nulls_fixture</span>
<span class="s1">):</span>
    <span class="s4"># GH 3729 this is to test that NA is in one group</span>
    <span class="s1">df_list = [</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">nulls_fixture</span><span class="s0">, </span><span class="s3">12.3</span><span class="s0">, </span><span class="s3">233.0</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">123.23</span><span class="s0">, </span><span class="s3">123</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">df = pd.DataFrame(df_list</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">])</span>
    <span class="s1">grouped = df.groupby([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=dropna).sum()</span>

    <span class="s1">mi = pd.MultiIndex.from_tuples(tuples</span><span class="s0">, </span><span class="s1">names=list(</span><span class="s2">&quot;ab&quot;</span><span class="s1">))</span>

    <span class="s4"># Since right now, by default MI will drop NA from levels when we create MI</span>
    <span class="s4"># via `from_*`, so we need to add NA for level manually afterwards.</span>
    <span class="s0">if not </span><span class="s1">dropna:</span>
        <span class="s1">mi = mi.set_levels([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s1">expected = pd.DataFrame(outputs</span><span class="s0">, </span><span class="s1">index=mi)</span>

    <span class="s1">tm.assert_frame_equal(grouped</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, tuples, outputs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">123.23</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">123.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">13.3</span><span class="s0">, </span><span class="s3">123.23</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">234.0</span><span class="s0">, </span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_dropna_multi_index_dataframe_nan_in_two_groups(</span>
    <span class="s1">dropna</span><span class="s0">, </span><span class="s1">tuples</span><span class="s0">, </span><span class="s1">outputs</span><span class="s0">, </span><span class="s1">nulls_fixture</span><span class="s0">, </span><span class="s1">nulls_fixture2</span>
<span class="s1">):</span>
    <span class="s4"># GH 3729 this is to test that NA in different groups with different representations</span>
    <span class="s1">df_list = [</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">nulls_fixture</span><span class="s0">, </span><span class="s3">12.3</span><span class="s0">, </span><span class="s3">233.0</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">123.23</span><span class="s0">, </span><span class="s3">123</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[nulls_fixture2</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">nulls_fixture2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">df = pd.DataFrame(df_list</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">])</span>
    <span class="s1">grouped = df.groupby([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=dropna).sum()</span>

    <span class="s1">mi = pd.MultiIndex.from_tuples(tuples</span><span class="s0">, </span><span class="s1">names=list(</span><span class="s2">&quot;ab&quot;</span><span class="s1">))</span>

    <span class="s4"># Since right now, by default MI will drop NA from levels when we create MI</span>
    <span class="s4"># via `from_*`, so we need to add NA for level manually afterwards.</span>
    <span class="s0">if not </span><span class="s1">dropna:</span>
        <span class="s1">mi = mi.set_levels([[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan]])</span>
    <span class="s1">expected = pd.DataFrame(outputs</span><span class="s0">, </span><span class="s1">index=mi)</span>

    <span class="s1">tm.assert_frame_equal(grouped</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, idx, outputs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">True, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">123.23</span><span class="s0">, </span><span class="s3">13.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s1">]})</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">123.23</span><span class="s0">, </span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">12.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">233.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">12.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_dropna_normal_index_dataframe(dropna</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">outputs):</span>
    <span class="s4"># GH 3729</span>
    <span class="s1">df_list = [</span>
        <span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s0">None, </span><span class="s3">12.3</span><span class="s0">, </span><span class="s3">233.0</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">123.23</span><span class="s0">, </span><span class="s3">123</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">df = pd.DataFrame(df_list</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">])</span>
    <span class="s1">grouped = df.groupby(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna).sum()</span>

    <span class="s1">expected = pd.DataFrame(outputs</span><span class="s0">, </span><span class="s1">index=pd.Index(idx</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;object&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">tm.assert_frame_equal(grouped</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, idx, expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">True, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">pd.Series([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">pd.Series([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_dropna_series_level(dropna</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">ser = pd.Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=idx)</span>

    <span class="s1">result = ser.groupby(level=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">dropna=dropna).sum()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">True, </span><span class="s1">pd.Series([</span><span class="s3">210.0</span><span class="s0">, </span><span class="s3">350.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;Max Speed&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">pd.Series([</span><span class="s3">210.0</span><span class="s0">, </span><span class="s3">350.0</span><span class="s0">, </span><span class="s3">20.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;Max Speed&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_dropna_series_by(dropna</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">ser = pd.Series(</span>
        <span class="s1">[</span><span class="s3">390.0</span><span class="s0">, </span><span class="s3">350.0</span><span class="s0">, </span><span class="s3">30.0</span><span class="s0">, </span><span class="s3">20.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s2">&quot;Falcon&quot;</span><span class="s0">, </span><span class="s2">&quot;Falcon&quot;</span><span class="s0">, </span><span class="s2">&quot;Parrot&quot;</span><span class="s0">, </span><span class="s2">&quot;Parrot&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">name=</span><span class="s2">&quot;Max Speed&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">result = ser.groupby([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">dropna=dropna).mean()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dropna&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, True</span><span class="s1">))</span>
<span class="s0">def </span><span class="s1">test_grouper_dropna_propagation(dropna):</span>
    <span class="s4"># GH 36604</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, None</span><span class="s1">]})</span>
    <span class="s1">gb = df.groupby(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>
    <span class="s0">assert </span><span class="s1">gb.grouper.dropna == dropna</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna,input_index,expected_data,expected_index&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">True, </span><span class="s1">pd.RangeIndex(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">pd.RangeIndex(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, </span><span class="s1">list(</span><span class="s2">&quot;abcd&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">pd.MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;num&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">pd.MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;num&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">False, </span><span class="s1">pd.RangeIndex(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">pd.RangeIndex(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">False, </span><span class="s1">list(</span><span class="s2">&quot;abcd&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">list(</span><span class="s2">&quot;abcd&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">pd.MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;num&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">pd.MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;R&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;num&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_dataframe_slice_then_transform(</span>
    <span class="s1">dropna</span><span class="s0">, </span><span class="s1">input_index</span><span class="s0">, </span><span class="s1">expected_data</span><span class="s0">, </span><span class="s1">expected_index</span>
<span class="s1">):</span>
    <span class="s4"># GH35014 &amp; GH35612</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, None</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=input_index)</span>
    <span class="s1">gb = df.groupby(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>

    <span class="s1">result = gb.transform(len)</span>
    <span class="s1">expected = pd.DataFrame(expected_data</span><span class="s0">, </span><span class="s1">index=expected_index)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = gb[[</span><span class="s2">&quot;B&quot;</span><span class="s1">]].transform(len)</span>
    <span class="s1">expected = pd.DataFrame(expected_data</span><span class="s0">, </span><span class="s1">index=expected_index)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = gb[</span><span class="s2">&quot;B&quot;</span><span class="s1">].transform(len)</span>
    <span class="s1">expected = pd.Series(expected_data[</span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=expected_index</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;B&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, tuples, outputs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s0">True,</span>
            <span class="s1">[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">123.23</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">123.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s0">False,</span>
            <span class="s1">[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">12.3</span><span class="s0">, </span><span class="s3">123.23</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">233.0</span><span class="s0">, </span><span class="s3">123.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;e&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_dropna_multi_index_dataframe_agg(dropna</span><span class="s0">, </span><span class="s1">tuples</span><span class="s0">, </span><span class="s1">outputs):</span>
    <span class="s4"># GH 3729</span>
    <span class="s1">df_list = [</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, None, </span><span class="s3">12.3</span><span class="s0">, </span><span class="s3">233.0</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">123.23</span><span class="s0">, </span><span class="s3">123</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">df = pd.DataFrame(df_list</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">])</span>
    <span class="s1">agg_dict = {</span><span class="s2">&quot;c&quot;</span><span class="s1">: sum</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: max</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s1">: </span><span class="s2">&quot;min&quot;</span><span class="s1">}</span>
    <span class="s1">grouped = df.groupby([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=dropna).agg(agg_dict)</span>

    <span class="s1">mi = pd.MultiIndex.from_tuples(tuples</span><span class="s0">, </span><span class="s1">names=list(</span><span class="s2">&quot;ab&quot;</span><span class="s1">))</span>

    <span class="s4"># Since right now, by default MI will drop NA from levels when we create MI</span>
    <span class="s4"># via `from_*`, so we need to add NA for level manually afterwards.</span>
    <span class="s0">if not </span><span class="s1">dropna:</span>
        <span class="s1">mi = mi.set_levels([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s1">expected = pd.DataFrame(outputs</span><span class="s0">, </span><span class="s1">index=mi)</span>

    <span class="s1">tm.assert_frame_equal(grouped</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.arm_slow</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;datetime1, datetime2&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(pd.Timestamp(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Timestamp(</span><span class="s2">&quot;2020-02-01&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(pd.Timedelta(</span><span class="s2">&quot;-2 days&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Timedelta(</span><span class="s2">&quot;-1 days&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(pd.Period(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Period(</span><span class="s2">&quot;2020-02-01&quot;</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dropna, values&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">True, </span><span class="s1">[</span><span class="s3">12</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, </span><span class="s1">[</span><span class="s3">12</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])])</span>
<span class="s0">def </span><span class="s1">test_groupby_dropna_datetime_like_data(</span>
    <span class="s1">dropna</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">datetime1</span><span class="s0">, </span><span class="s1">datetime2</span><span class="s0">, </span><span class="s1">unique_nulls_fixture</span><span class="s0">, </span><span class="s1">unique_nulls_fixture2</span>
<span class="s1">):</span>
    <span class="s4"># 3729</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;dt&quot;</span><span class="s1">: [</span>
                <span class="s1">datetime1</span><span class="s0">,</span>
                <span class="s1">unique_nulls_fixture</span><span class="s0">,</span>
                <span class="s1">datetime2</span><span class="s0">,</span>
                <span class="s1">unique_nulls_fixture2</span><span class="s0">,</span>
                <span class="s1">datetime1</span><span class="s0">,</span>
                <span class="s1">datetime1</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">dropna:</span>
        <span class="s1">indexes = [datetime1</span><span class="s0">, </span><span class="s1">datetime2]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">indexes = [datetime1</span><span class="s0">, </span><span class="s1">datetime2</span><span class="s0">, </span><span class="s1">np.nan]</span>

    <span class="s1">grouped = df.groupby(</span><span class="s2">&quot;dt&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna).agg({</span><span class="s2">&quot;values&quot;</span><span class="s1">: sum})</span>
    <span class="s1">expected = pd.DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: values}</span><span class="s0">, </span><span class="s1">index=pd.Index(indexes</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;dt&quot;</span><span class="s1">))</span>

    <span class="s1">tm.assert_frame_equal(grouped</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dropna, data, selected_data, levels&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">pytest.param(</span>
            <span class="s0">False,</span>
            <span class="s1">{</span><span class="s2">&quot;groups&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">id=</span><span class="s2">&quot;dropna_false_has_nan&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s0">True,</span>
            <span class="s1">{</span><span class="s2">&quot;groups&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s0">None,</span>
            <span class="s1">id=</span><span class="s2">&quot;dropna_true_has_nan&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s4"># no nan in &quot;groups&quot;; dropna=True|False should be same.</span>
            <span class="s0">False,</span>
            <span class="s1">{</span><span class="s2">&quot;groups&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s0">None,</span>
            <span class="s1">id=</span><span class="s2">&quot;dropna_false_no_nan&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s4"># no nan in &quot;groups&quot;; dropna=True|False should be same.</span>
            <span class="s0">True,</span>
            <span class="s1">{</span><span class="s2">&quot;groups&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s0">None,</span>
            <span class="s1">id=</span><span class="s2">&quot;dropna_true_no_nan&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_apply_with_dropna_for_multi_index(dropna</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">selected_data</span><span class="s0">, </span><span class="s1">levels):</span>
    <span class="s4"># GH 35889</span>

    <span class="s1">df = pd.DataFrame(data)</span>
    <span class="s1">gb = df.groupby(</span><span class="s2">&quot;groups&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>
    <span class="s1">result = gb.apply(</span><span class="s0">lambda </span><span class="s1">grp: pd.DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: range(len(grp))}))</span>

    <span class="s1">mi_tuples = tuple(zip(data[</span><span class="s2">&quot;groups&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">selected_data[</span><span class="s2">&quot;values&quot;</span><span class="s1">]))</span>
    <span class="s1">mi = pd.MultiIndex.from_tuples(mi_tuples</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;groups&quot;</span><span class="s0">, None</span><span class="s1">])</span>
    <span class="s4"># Since right now, by default MI will drop NA from levels when we create MI</span>
    <span class="s4"># via `from_*`, so we need to add NA for level manually afterwards.</span>
    <span class="s0">if not </span><span class="s1">dropna </span><span class="s0">and </span><span class="s1">levels:</span>
        <span class="s1">mi = mi.set_levels(levels</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">&quot;groups&quot;</span><span class="s1">)</span>

    <span class="s1">expected = pd.DataFrame(selected_data</span><span class="s0">, </span><span class="s1">index=mi)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_groupby_nan_included():</span>
    <span class="s4"># GH 35646</span>
    <span class="s1">data = {</span><span class="s2">&quot;group&quot;</span><span class="s1">: [</span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s2">&quot;g2&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]}</span>
    <span class="s1">df = pd.DataFrame(data)</span>
    <span class="s1">grouped = df.groupby(</span><span class="s2">&quot;group&quot;</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">result = grouped.indices</span>
    <span class="s1">dtype = np.intp</span>
    <span class="s1">expected = {</span>
        <span class="s2">&quot;g1&quot;</span><span class="s1">: np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span><span class="s0">,</span>
        <span class="s2">&quot;g2&quot;</span><span class="s1">: np.array([</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span><span class="s0">,</span>
        <span class="s1">np.nan: np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">for </span><span class="s1">result_values</span><span class="s0">, </span><span class="s1">expected_values </span><span class="s0">in </span><span class="s1">zip(result.values()</span><span class="s0">, </span><span class="s1">expected.values()):</span>
        <span class="s1">tm.assert_numpy_array_equal(result_values</span><span class="s0">, </span><span class="s1">expected_values)</span>
    <span class="s0">assert </span><span class="s1">np.isnan(list(result.keys())[</span><span class="s3">2</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">list(result.keys())[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] == [</span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s2">&quot;g2&quot;</span><span class="s1">]</span>
</pre>
</body>
</html>