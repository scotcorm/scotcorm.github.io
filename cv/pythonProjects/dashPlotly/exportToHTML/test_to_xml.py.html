<html>
<head>
<title>test_to_xml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_to_xml.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">BytesIO</span><span class="s0">,</span>
    <span class="s1">StringIO</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">os</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas.util._test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">NA</span><span class="s0">,</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>

<span class="s0">import </span><span class="s1">pandas.io.common </span><span class="s0">as </span><span class="s1">icom</span>
<span class="s0">from </span><span class="s1">pandas.io.common </span><span class="s0">import </span><span class="s1">get_handle</span>
<span class="s0">from </span><span class="s1">pandas.io.xml </span><span class="s0">import </span><span class="s1">read_xml</span>

<span class="s2">&quot;&quot;&quot; 
CHECKLIST 
 
[x] - ValueError: &quot;Values for parser can only be lxml or etree.&quot; 
 
etree 
[x] - ImportError: &quot;lxml not found, please install or use the etree parser.&quot; 
[X] - TypeError: &quot;...is not a valid type for attr_cols&quot; 
[X] - TypeError: &quot;...is not a valid type for elem_cols&quot; 
[X] - LookupError: &quot;unknown encoding&quot; 
[X] - KeyError: &quot;...is not included in namespaces&quot; 
[X] - KeyError: &quot;no valid column&quot; 
[X] - ValueError: &quot;To use stylesheet, you need lxml installed...&quot; 
[]  - OSError: (NEED PERMISSOIN ISSUE, DISK FULL, ETC.) 
[X] - FileNotFoundError: &quot;No such file or directory&quot; 
[X] - PermissionError: &quot;Forbidden&quot; 
 
lxml 
[X] - TypeError: &quot;...is not a valid type for attr_cols&quot; 
[X] - TypeError: &quot;...is not a valid type for elem_cols&quot; 
[X] - LookupError: &quot;unknown encoding&quot; 
[]  - OSError: (NEED PERMISSOIN ISSUE, DISK FULL, ETC.) 
[X] - FileNotFoundError: &quot;No such file or directory&quot; 
[X] - KeyError: &quot;...is not included in namespaces&quot; 
[X] - KeyError: &quot;no valid column&quot; 
[X] - ValueError: &quot;stylesheet is not a url, file, or xml string.&quot; 
[]  - LookupError: (NEED WRONG ENCODING FOR FILE OUTPUT) 
[]  - URLError: (USUALLY DUE TO NETWORKING) 
[]  - HTTPError: (NEED AN ONLINE STYLESHEET) 
[X] - OSError: &quot;failed to load external entity&quot; 
[X] - XMLSyntaxError: &quot;Opening and ending tag mismatch&quot; 
[X] - XSLTApplyError: &quot;Cannot resolve URI&quot; 
[X] - XSLTParseError: &quot;failed to compile&quot; 
[X] - PermissionError: &quot;Forbidden&quot; 
&quot;&quot;&quot;</span>

<span class="s1">geom_df = DataFrame(</span>
    <span class="s1">{</span>
        <span class="s2">&quot;shape&quot;</span><span class="s1">: [</span><span class="s2">&quot;square&quot;</span><span class="s0">, </span><span class="s2">&quot;circle&quot;</span><span class="s0">, </span><span class="s2">&quot;triangle&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s2">&quot;degrees&quot;</span><span class="s1">: [</span><span class="s3">360</span><span class="s0">, </span><span class="s3">360</span><span class="s0">, </span><span class="s3">180</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s2">&quot;sides&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">}</span>
<span class="s1">)</span>

<span class="s1">planet_df = DataFrame(</span>
    <span class="s1">{</span>
        <span class="s2">&quot;planet&quot;</span><span class="s1">: [</span>
            <span class="s2">&quot;Mercury&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Venus&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Earth&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Mars&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Jupiter&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Saturn&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Uranus&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;Neptune&quot;</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s2">&quot;type&quot;</span><span class="s1">: [</span>
            <span class="s2">&quot;terrestrial&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;terrestrial&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;terrestrial&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;terrestrial&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;gas giant&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;gas giant&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;ice giant&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;ice giant&quot;</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s2">&quot;location&quot;</span><span class="s1">: [</span>
            <span class="s2">&quot;inner&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;inner&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;inner&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;inner&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;outer&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;outer&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;outer&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;outer&quot;</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s2">&quot;mass&quot;</span><span class="s1">: [</span>
            <span class="s3">0.330114</span><span class="s0">,</span>
            <span class="s3">4.86747</span><span class="s0">,</span>
            <span class="s3">5.97237</span><span class="s0">,</span>
            <span class="s3">0.641712</span><span class="s0">,</span>
            <span class="s3">1898.187</span><span class="s0">,</span>
            <span class="s3">568.3174</span><span class="s0">,</span>
            <span class="s3">86.8127</span><span class="s0">,</span>
            <span class="s3">102.4126</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">}</span>
<span class="s1">)</span>

<span class="s1">from_file_expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;category&gt;cooking&lt;/category&gt; 
    &lt;title&gt;Everyday Italian&lt;/title&gt; 
    &lt;author&gt;Giada De Laurentiis&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;30.0&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;category&gt;children&lt;/category&gt; 
    &lt;title&gt;Harry Potter&lt;/title&gt; 
    &lt;author&gt;J K. Rowling&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;29.99&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;category&gt;web&lt;/category&gt; 
    &lt;title&gt;Learning XML&lt;/title&gt; 
    &lt;author&gt;Erik T. Ray&lt;/author&gt; 
    &lt;year&gt;2003&lt;/year&gt; 
    &lt;price&gt;39.95&lt;/price&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">equalize_decl(doc):</span>
    <span class="s4"># etree and lxml differ on quotes and case in xml declaration</span>
    <span class="s0">if </span><span class="s1">doc </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">doc = doc.replace(</span>
            <span class="s2">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?'</span><span class="s0">,</span>
            <span class="s2">&quot;&lt;?xml version='1.0' encoding='utf-8'?&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">return </span><span class="s1">doc</span>


<span class="s1">@pytest.fixture(params=[</span><span class="s2">&quot;rb&quot;</span><span class="s0">, </span><span class="s2">&quot;r&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">mode(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s1">@pytest.fixture(params=[pytest.param(</span><span class="s2">&quot;lxml&quot;</span><span class="s0">, </span><span class="s1">marks=td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;etree&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">parser(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s4"># FILE OUTPUT</span>


<span class="s0">def </span><span class="s1">test_file_output_str_read(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;test.xml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">df_file.to_xml(path</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">output = f.read().decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">).strip()</span>

        <span class="s1">output = equalize_decl(output)</span>

        <span class="s0">assert </span><span class="s1">output == from_file_expected</span>


<span class="s0">def </span><span class="s1">test_file_output_bytes_read(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;test.xml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">df_file.to_xml(path</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">output = f.read().decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">).strip()</span>

        <span class="s1">output = equalize_decl(output)</span>

        <span class="s0">assert </span><span class="s1">output == from_file_expected</span>


<span class="s0">def </span><span class="s1">test_str_output(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s1">output = df_file.to_xml(parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == from_file_expected</span>


<span class="s0">def </span><span class="s1">test_wrong_file_path(parser):</span>
    <span class="s1">path = </span><span class="s2">&quot;/my/fake/path/output.xml&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">OSError</span><span class="s0">,</span>
        <span class="s1">match=(</span><span class="s2">r&quot;Cannot save file into a non-existent directory: .*path&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">geom_df.to_xml(path</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s4"># INDEX</span>


<span class="s0">def </span><span class="s1">test_index_false(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;category&gt;cooking&lt;/category&gt; 
    &lt;title&gt;Everyday Italian&lt;/title&gt; 
    &lt;author&gt;Giada De Laurentiis&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;30.0&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;category&gt;children&lt;/category&gt; 
    &lt;title&gt;Harry Potter&lt;/title&gt; 
    &lt;author&gt;J K. Rowling&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;29.99&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;category&gt;web&lt;/category&gt; 
    &lt;title&gt;Learning XML&lt;/title&gt; 
    &lt;author&gt;Erik T. Ray&lt;/author&gt; 
    &lt;year&gt;2003&lt;/year&gt; 
    &lt;price&gt;39.95&lt;/price&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;test.xml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">df_file.to_xml(path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">parser=parser)</span>
        <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">output = f.read().decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">).strip()</span>

        <span class="s1">output = equalize_decl(output)</span>

        <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_index_false_rename_row_root(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;books&gt; 
  &lt;book&gt; 
    &lt;category&gt;cooking&lt;/category&gt; 
    &lt;title&gt;Everyday Italian&lt;/title&gt; 
    &lt;author&gt;Giada De Laurentiis&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;30.0&lt;/price&gt; 
  &lt;/book&gt; 
  &lt;book&gt; 
    &lt;category&gt;children&lt;/category&gt; 
    &lt;title&gt;Harry Potter&lt;/title&gt; 
    &lt;author&gt;J K. Rowling&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;29.99&lt;/price&gt; 
  &lt;/book&gt; 
  &lt;book&gt; 
    &lt;category&gt;web&lt;/category&gt; 
    &lt;title&gt;Learning XML&lt;/title&gt; 
    &lt;author&gt;Erik T. Ray&lt;/author&gt; 
    &lt;year&gt;2003&lt;/year&gt; 
    &lt;price&gt;39.95&lt;/price&gt; 
  &lt;/book&gt; 
&lt;/books&gt;&quot;&quot;&quot;</span>

    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;test.xml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">df_file.to_xml(</span>
            <span class="s1">path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">root_name=</span><span class="s2">&quot;books&quot;</span><span class="s0">, </span><span class="s1">row_name=</span><span class="s2">&quot;book&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">output = f.read().decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">).strip()</span>

        <span class="s1">output = equalize_decl(output)</span>

        <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;offset_index&quot;</span><span class="s0">, </span><span class="s1">[list(range(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">13</span><span class="s1">))</span><span class="s0">, </span><span class="s1">[str(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)]]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_index_false_with_offset_input_index(parser</span><span class="s0">, </span><span class="s1">offset_index):</span>
    <span class="s5">&quot;&quot;&quot; 
    Tests that the output does not contain the `&lt;index&gt;` field when the index of the 
    input Dataframe has an offset. 
 
    This is a regression test for issue #42458. 
    &quot;&quot;&quot;</span>

    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">offset_geom_df = geom_df.copy()</span>
    <span class="s1">offset_geom_df.index = Index(offset_index)</span>
    <span class="s1">output = offset_geom_df.to_xml(index=</span><span class="s0">False, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s4"># NA_REP</span>

<span class="s1">na_expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_na_elem_output(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">output = geom_df.to_xml(parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == na_expected</span>


<span class="s0">def </span><span class="s1">test_na_empty_str_elem_option(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">output = geom_df.to_xml(na_rep=</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == na_expected</span>


<span class="s0">def </span><span class="s1">test_na_empty_elem_option(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;0.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(na_rep=</span><span class="s2">&quot;0.0&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s4"># ATTR_COLS</span>


<span class="s0">def </span><span class="s1">test_attrs_cols_nan_output(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row index=&quot;0&quot; shape=&quot;square&quot; degrees=&quot;360&quot; sides=&quot;4.0&quot;/&gt; 
  &lt;row index=&quot;1&quot; shape=&quot;circle&quot; degrees=&quot;360&quot;/&gt; 
  &lt;row index=&quot;2&quot; shape=&quot;triangle&quot; degrees=&quot;180&quot; sides=&quot;3.0&quot;/&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(attr_cols=[</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s2">&quot;degrees&quot;</span><span class="s0">, </span><span class="s2">&quot;sides&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_attrs_cols_prefix(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns:doc=&quot;http://example.xom&quot;&gt; 
  &lt;doc:row doc:index=&quot;0&quot; doc:shape=&quot;square&quot; </span><span class="s0">\ 
</span><span class="s2">doc:degrees=&quot;360&quot; doc:sides=&quot;4.0&quot;/&gt; 
  &lt;doc:row doc:index=&quot;1&quot; doc:shape=&quot;circle&quot; </span><span class="s0">\ 
</span><span class="s2">doc:degrees=&quot;360&quot;/&gt; 
  &lt;doc:row doc:index=&quot;2&quot; doc:shape=&quot;triangle&quot; </span><span class="s0">\ 
</span><span class="s2">doc:degrees=&quot;180&quot; doc:sides=&quot;3.0&quot;/&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(</span>
        <span class="s1">attr_cols=[</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s2">&quot;degrees&quot;</span><span class="s0">, </span><span class="s2">&quot;sides&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;doc&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.xom&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">prefix=</span><span class="s2">&quot;doc&quot;</span><span class="s0">,</span>
        <span class="s1">parser=parser</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_attrs_unknown_column(parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;no valid column&quot;</span><span class="s1">)):</span>
        <span class="s1">geom_df.to_xml(attr_cols=[</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s2">&quot;degree&quot;</span><span class="s0">, </span><span class="s2">&quot;sides&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_attrs_wrong_type(parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;is not a valid type for attr_cols&quot;</span><span class="s1">)):</span>
        <span class="s1">geom_df.to_xml(attr_cols=</span><span class="s2">'&quot;shape&quot;, &quot;degree&quot;, &quot;sides&quot;'</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s4"># ELEM_COLS</span>


<span class="s0">def </span><span class="s1">test_elems_cols_nan_output(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">elems_cols_expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(</span>
        <span class="s1">index=</span><span class="s0">False, </span><span class="s1">elem_cols=[</span><span class="s2">&quot;degrees&quot;</span><span class="s0">, </span><span class="s2">&quot;sides&quot;</span><span class="s0">, </span><span class="s2">&quot;shape&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parser=parser</span>
    <span class="s1">)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == elems_cols_expected</span>


<span class="s0">def </span><span class="s1">test_elems_unknown_column(parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;no valid column&quot;</span><span class="s1">)):</span>
        <span class="s1">geom_df.to_xml(elem_cols=[</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s2">&quot;degree&quot;</span><span class="s0">, </span><span class="s2">&quot;sides&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_elems_wrong_type(parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;is not a valid type for elem_cols&quot;</span><span class="s1">)):</span>
        <span class="s1">geom_df.to_xml(elem_cols=</span><span class="s2">'&quot;shape&quot;, &quot;degree&quot;, &quot;sides&quot;'</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_elems_and_attrs_cols(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">elems_cols_expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row shape=&quot;square&quot;&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row shape=&quot;circle&quot;&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row shape=&quot;triangle&quot;&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(</span>
        <span class="s1">index=</span><span class="s0">False,</span>
        <span class="s1">elem_cols=[</span><span class="s2">&quot;degrees&quot;</span><span class="s0">, </span><span class="s2">&quot;sides&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">attr_cols=[</span><span class="s2">&quot;shape&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">parser=parser</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == elems_cols_expected</span>


<span class="s4"># HIERARCHICAL COLUMNS</span>


<span class="s0">def </span><span class="s1">test_hierarchical_columns(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;location&gt;inner&lt;/location&gt; 
    &lt;type&gt;terrestrial&lt;/type&gt; 
    &lt;count_mass&gt;4&lt;/count_mass&gt; 
    &lt;sum_mass&gt;11.81&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;2.95&lt;/mean_mass&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;gas giant&lt;/type&gt; 
    &lt;count_mass&gt;2&lt;/count_mass&gt; 
    &lt;sum_mass&gt;2466.5&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;1233.25&lt;/mean_mass&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;ice giant&lt;/type&gt; 
    &lt;count_mass&gt;2&lt;/count_mass&gt; 
    &lt;sum_mass&gt;189.23&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;94.61&lt;/mean_mass&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;All&lt;/location&gt; 
    &lt;type/&gt; 
    &lt;count_mass&gt;8&lt;/count_mass&gt; 
    &lt;sum_mass&gt;2667.54&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;333.44&lt;/mean_mass&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">pvt = planet_df.pivot_table(</span>
        <span class="s1">index=[</span><span class="s2">&quot;location&quot;</span><span class="s0">, </span><span class="s2">&quot;type&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">values=</span><span class="s2">&quot;mass&quot;</span><span class="s0">,</span>
        <span class="s1">aggfunc=[</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">margins=</span><span class="s0">True,</span>
    <span class="s1">).round(</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">output = pvt.to_xml(parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_hierarchical_attrs_columns(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row location=&quot;inner&quot; type=&quot;terrestrial&quot; count_mass=&quot;4&quot; </span><span class="s0">\ 
</span><span class="s2">sum_mass=&quot;11.81&quot; mean_mass=&quot;2.95&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;gas giant&quot; count_mass=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s2">sum_mass=&quot;2466.5&quot; mean_mass=&quot;1233.25&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;ice giant&quot; count_mass=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s2">sum_mass=&quot;189.23&quot; mean_mass=&quot;94.61&quot;/&gt; 
  &lt;row location=&quot;All&quot; type=&quot;&quot; count_mass=&quot;8&quot; </span><span class="s0">\ 
</span><span class="s2">sum_mass=&quot;2667.54&quot; mean_mass=&quot;333.44&quot;/&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">pvt = planet_df.pivot_table(</span>
        <span class="s1">index=[</span><span class="s2">&quot;location&quot;</span><span class="s0">, </span><span class="s2">&quot;type&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">values=</span><span class="s2">&quot;mass&quot;</span><span class="s0">,</span>
        <span class="s1">aggfunc=[</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">margins=</span><span class="s0">True,</span>
    <span class="s1">).round(</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">output = pvt.to_xml(attr_cols=list(pvt.reset_index().columns.values)</span><span class="s0">, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s4"># MULTIINDEX</span>


<span class="s0">def </span><span class="s1">test_multi_index(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;location&gt;inner&lt;/location&gt; 
    &lt;type&gt;terrestrial&lt;/type&gt; 
    &lt;count&gt;4&lt;/count&gt; 
    &lt;sum&gt;11.81&lt;/sum&gt; 
    &lt;mean&gt;2.95&lt;/mean&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;gas giant&lt;/type&gt; 
    &lt;count&gt;2&lt;/count&gt; 
    &lt;sum&gt;2466.5&lt;/sum&gt; 
    &lt;mean&gt;1233.25&lt;/mean&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;ice giant&lt;/type&gt; 
    &lt;count&gt;2&lt;/count&gt; 
    &lt;sum&gt;189.23&lt;/sum&gt; 
    &lt;mean&gt;94.61&lt;/mean&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">agg = (</span>
        <span class="s1">planet_df.groupby([</span><span class="s2">&quot;location&quot;</span><span class="s0">, </span><span class="s2">&quot;type&quot;</span><span class="s1">])[</span><span class="s2">&quot;mass&quot;</span><span class="s1">]</span>
        <span class="s1">.agg([</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s1">])</span>
        <span class="s1">.round(</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s1">output = agg.to_xml(parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_multi_index_attrs_cols(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row location=&quot;inner&quot; type=&quot;terrestrial&quot; count=&quot;4&quot; </span><span class="s0">\ 
</span><span class="s2">sum=&quot;11.81&quot; mean=&quot;2.95&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;gas giant&quot; count=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s2">sum=&quot;2466.5&quot; mean=&quot;1233.25&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;ice giant&quot; count=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s2">sum=&quot;189.23&quot; mean=&quot;94.61&quot;/&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">agg = (</span>
        <span class="s1">planet_df.groupby([</span><span class="s2">&quot;location&quot;</span><span class="s0">, </span><span class="s2">&quot;type&quot;</span><span class="s1">])[</span><span class="s2">&quot;mass&quot;</span><span class="s1">]</span>
        <span class="s1">.agg([</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s1">])</span>
        <span class="s1">.round(</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">output = agg.to_xml(attr_cols=list(agg.reset_index().columns.values)</span><span class="s0">, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s4"># NAMESPACE</span>


<span class="s0">def </span><span class="s1">test_default_namespace(parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data xmlns=&quot;http://example.com&quot;&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(namespaces={</span><span class="s2">&quot;&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s4"># PREFIX</span>


<span class="s0">def </span><span class="s1">test_namespace_prefix(parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns:doc=&quot;http://example.com&quot;&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;0&lt;/doc:index&gt; 
    &lt;doc:shape&gt;square&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;4.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;1&lt;/doc:index&gt; 
    &lt;doc:shape&gt;circle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides/&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;2&lt;/doc:index&gt; 
    &lt;doc:shape&gt;triangle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;180&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;3.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;doc&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">prefix=</span><span class="s2">&quot;doc&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span>
    <span class="s1">)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_missing_prefix_in_nmsp(parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;doc is not included in namespaces&quot;</span><span class="s1">)):</span>

        <span class="s1">geom_df.to_xml(</span>
            <span class="s1">namespaces={</span><span class="s2">&quot;&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">prefix=</span><span class="s2">&quot;doc&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_namespace_prefix_and_default(parser):</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns=&quot;http://example.com&quot; xmlns:doc=&quot;http://other.org&quot;&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;0&lt;/doc:index&gt; 
    &lt;doc:shape&gt;square&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;4.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;1&lt;/doc:index&gt; 
    &lt;doc:shape&gt;circle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides/&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;2&lt;/doc:index&gt; 
    &lt;doc:shape&gt;triangle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;180&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;3.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s0">, </span><span class="s2">&quot;doc&quot;</span><span class="s1">: </span><span class="s2">&quot;http://other.org&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">prefix=</span><span class="s2">&quot;doc&quot;</span><span class="s0">,</span>
        <span class="s1">parser=parser</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">if </span><span class="s1">output </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s4"># etree and lxml differs on order of namespace prefixes</span>
        <span class="s1">output = output.replace(</span>
            <span class="s2">'xmlns:doc=&quot;http://other.org&quot; xmlns=&quot;http://example.com&quot;'</span><span class="s0">,</span>
            <span class="s2">'xmlns=&quot;http://example.com&quot; xmlns:doc=&quot;http://other.org&quot;'</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s4"># ENCODING</span>

<span class="s1">encoding_expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='ISO-8859-1'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;rank&gt;1&lt;/rank&gt; 
    &lt;malename&gt;José&lt;/malename&gt; 
    &lt;femalename&gt;Sofía&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;rank&gt;2&lt;/rank&gt; 
    &lt;malename&gt;Luis&lt;/malename&gt; 
    &lt;femalename&gt;Valentina&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;rank&gt;3&lt;/rank&gt; 
    &lt;malename&gt;Carlos&lt;/malename&gt; 
    &lt;femalename&gt;Isabella&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;3&lt;/index&gt; 
    &lt;rank&gt;4&lt;/rank&gt; 
    &lt;malename&gt;Juan&lt;/malename&gt; 
    &lt;femalename&gt;Camila&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;4&lt;/index&gt; 
    &lt;rank&gt;5&lt;/rank&gt; 
    &lt;malename&gt;Jorge&lt;/malename&gt; 
    &lt;femalename&gt;Valeria&lt;/femalename&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_encoding_option_str(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="s1">).head(</span><span class="s3">5</span><span class="s1">)</span>

    <span class="s1">output = df_file.to_xml(encoding=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">if </span><span class="s1">output </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s4"># etree and lxml differ on quotes and case in xml declaration</span>
        <span class="s1">output = output.replace(</span>
            <span class="s2">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?'</span><span class="s0">,</span>
            <span class="s2">&quot;&lt;?xml version='1.0' encoding='ISO-8859-1'?&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">output == encoding_expected</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_correct_encoding_file(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;test.xml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">df_file.to_xml(path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">encoding=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;encoding&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;UTF-8&quot;</span><span class="s0">, </span><span class="s2">&quot;UTF-16&quot;</span><span class="s0">, </span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_wrong_encoding_option_lxml(datapath</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">encoding):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;test.xml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">df_file.to_xml(path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">encoding=encoding</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_misspelled_encoding(parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(LookupError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;unknown encoding&quot;</span><span class="s1">)):</span>
        <span class="s1">geom_df.to_xml(encoding=</span><span class="s2">&quot;uft-8&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s4"># PRETTY PRINT</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_xml_declaration_pretty_print():</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output = geom_df.to_xml(xml_declaration=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_no_pretty_print_with_decl(parser):</span>
    <span class="s1">expected = (</span>
        <span class="s2">&quot;&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;data&gt;&lt;row&gt;&lt;index&gt;0&lt;/index&gt;&lt;shape&gt;square&lt;/shape&gt;&quot;</span>
        <span class="s2">&quot;&lt;degrees&gt;360&lt;/degrees&gt;&lt;sides&gt;4.0&lt;/sides&gt;&lt;/row&gt;&lt;row&gt;&quot;</span>
        <span class="s2">&quot;&lt;index&gt;1&lt;/index&gt;&lt;shape&gt;circle&lt;/shape&gt;&lt;degrees&gt;360&quot;</span>
        <span class="s2">&quot;&lt;/degrees&gt;&lt;sides/&gt;&lt;/row&gt;&lt;row&gt;&lt;index&gt;2&lt;/index&gt;&lt;shape&gt;&quot;</span>
        <span class="s2">&quot;triangle&lt;/shape&gt;&lt;degrees&gt;180&lt;/degrees&gt;&lt;sides&gt;3.0&lt;/sides&gt;&quot;</span>
        <span class="s2">&quot;&lt;/row&gt;&lt;/data&gt;&quot;</span>
    <span class="s1">)</span>

    <span class="s1">output = geom_df.to_xml(pretty_print=</span><span class="s0">False, </span><span class="s1">parser=parser)</span>
    <span class="s1">output = equalize_decl(output)</span>

    <span class="s4"># etree adds space for closed tags</span>
    <span class="s0">if </span><span class="s1">output </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">output = output.replace(</span><span class="s2">&quot; /&gt;&quot;</span><span class="s0">, </span><span class="s2">&quot;/&gt;&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s0">def </span><span class="s1">test_no_pretty_print_no_decl(parser):</span>
    <span class="s1">expected = (</span>
        <span class="s2">&quot;&lt;data&gt;&lt;row&gt;&lt;index&gt;0&lt;/index&gt;&lt;shape&gt;square&lt;/shape&gt;&quot;</span>
        <span class="s2">&quot;&lt;degrees&gt;360&lt;/degrees&gt;&lt;sides&gt;4.0&lt;/sides&gt;&lt;/row&gt;&lt;row&gt;&quot;</span>
        <span class="s2">&quot;&lt;index&gt;1&lt;/index&gt;&lt;shape&gt;circle&lt;/shape&gt;&lt;degrees&gt;360&quot;</span>
        <span class="s2">&quot;&lt;/degrees&gt;&lt;sides/&gt;&lt;/row&gt;&lt;row&gt;&lt;index&gt;2&lt;/index&gt;&lt;shape&gt;&quot;</span>
        <span class="s2">&quot;triangle&lt;/shape&gt;&lt;degrees&gt;180&lt;/degrees&gt;&lt;sides&gt;3.0&lt;/sides&gt;&quot;</span>
        <span class="s2">&quot;&lt;/row&gt;&lt;/data&gt;&quot;</span>
    <span class="s1">)</span>

    <span class="s1">output = geom_df.to_xml(xml_declaration=</span><span class="s0">False, </span><span class="s1">pretty_print=</span><span class="s0">False, </span><span class="s1">parser=parser)</span>

    <span class="s4"># etree adds space for closed tags</span>
    <span class="s0">if </span><span class="s1">output </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">output = output.replace(</span><span class="s2">&quot; /&gt;&quot;</span><span class="s0">, </span><span class="s2">&quot;/&gt;&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">output == expected</span>


<span class="s4"># PARSER</span>


<span class="s1">@td.skip_if_installed(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_default_parser_no_lxml():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ImportError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;lxml not found, please install or use the etree parser.&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">geom_df.to_xml()</span>


<span class="s0">def </span><span class="s1">test_unknown_parser():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Values for parser can only be lxml or etree.&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">geom_df.to_xml(parser=</span><span class="s2">&quot;bs4&quot;</span><span class="s1">)</span>


<span class="s4"># STYLESHEET</span>

<span class="s1">xsl_expected = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;field field=&quot;index&quot;&gt;0&lt;/field&gt; 
    &lt;field field=&quot;shape&quot;&gt;square&lt;/field&gt; 
    &lt;field field=&quot;degrees&quot;&gt;360&lt;/field&gt; 
    &lt;field field=&quot;sides&quot;&gt;4.0&lt;/field&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;field field=&quot;index&quot;&gt;1&lt;/field&gt; 
    &lt;field field=&quot;shape&quot;&gt;circle&lt;/field&gt; 
    &lt;field field=&quot;degrees&quot;&gt;360&lt;/field&gt; 
    &lt;field field=&quot;sides&quot;/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;field field=&quot;index&quot;&gt;2&lt;/field&gt; 
    &lt;field field=&quot;shape&quot;&gt;triangle&lt;/field&gt; 
    &lt;field field=&quot;degrees&quot;&gt;180&lt;/field&gt; 
    &lt;field field=&quot;sides&quot;&gt;3.0&lt;/field&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_file_like(datapath</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;row_field_output.xsl&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">open(xsl</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">assert </span><span class="s1">geom_df.to_xml(stylesheet=f) == xsl_expected</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_io(datapath</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">xsl_path = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;row_field_output.xsl&quot;</span><span class="s1">)</span>

    <span class="s1">xsl_obj: BytesIO | StringIO</span>

    <span class="s0">with </span><span class="s1">open(xsl_path</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">if </span><span class="s1">mode == </span><span class="s2">&quot;rb&quot;</span><span class="s1">:</span>
            <span class="s1">xsl_obj = BytesIO(f.read())</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">xsl_obj = StringIO(f.read())</span>

    <span class="s1">output = geom_df.to_xml(stylesheet=xsl_obj)</span>

    <span class="s0">assert </span><span class="s1">output == xsl_expected</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_buffered_reader(datapath</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;row_field_output.xsl&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">open(xsl</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">xsl_obj = f.read()</span>

    <span class="s1">output = geom_df.to_xml(stylesheet=xsl_obj)</span>

    <span class="s0">assert </span><span class="s1">output == xsl_expected</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_wrong_path(datapath):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s1">xsl = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;row_field_output.xslt&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">XMLSyntaxError</span><span class="s0">,</span>
        <span class="s1">match=(</span><span class="s2">&quot;Start tag expected, '&lt;' not found&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">geom_df.to_xml(stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s6">b&quot;&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_empty_string_stylesheet(val):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">XMLSyntaxError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Document is empty|Start tag expected, '&lt;' not found&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">geom_df.to_xml(stylesheet=val)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_incorrect_xsl_syntax():</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; &gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node()&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:apply-templates select=&quot;@*|node()&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row/*&quot;&gt; 
        &lt;field&gt; 
            &lt;xsl:attribute name=&quot;field&quot;&gt; 
                &lt;xsl:value-of select=&quot;name()&quot;/&gt; 
            &lt;/xsl:attribute&gt; 
            &lt;xsl:value-of select=&quot;text()&quot;/&gt; 
        &lt;/field&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(XMLSyntaxError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Opening and ending tag mismatch&quot;</span><span class="s1">)):</span>
        <span class="s1">geom_df.to_xml(stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_incorrect_xsl_eval():</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XSLTParseError</span>

    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node(*)&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:apply-templates select=&quot;@*|node()&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row/*&quot;&gt; 
        &lt;field&gt; 
            &lt;xsl:attribute name=&quot;field&quot;&gt; 
                &lt;xsl:value-of select=&quot;name()&quot;/&gt; 
            &lt;/xsl:attribute&gt; 
            &lt;xsl:value-of select=&quot;text()&quot;/&gt; 
        &lt;/field&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(XSLTParseError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;failed to compile&quot;</span><span class="s1">)):</span>
        <span class="s1">geom_df.to_xml(stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_incorrect_xsl_apply(parser):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XSLTApplyError</span>

    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node()&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:copy-of select=&quot;document('non_existent.xml')/*&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(XSLTApplyError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Cannot resolve URI&quot;</span><span class="s1">)):</span>
        <span class="s0">with </span><span class="s1">tm.ensure_clean(</span><span class="s2">&quot;test.xml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">geom_df.to_xml(path</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s0">def </span><span class="s1">test_stylesheet_with_etree(datapath):</span>
    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node(*)&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:apply-templates select=&quot;@*|node()&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;To use stylesheet, you need lxml installed&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">geom_df.to_xml(parser=</span><span class="s2">&quot;etree&quot;</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_style_to_csv():</span>
    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;text&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:param name=&quot;delim&quot;&gt;,&lt;/xsl:param&gt; 
    &lt;xsl:template match=&quot;/data&quot;&gt; 
        &lt;xsl:text&gt;,shape,degrees,sides&amp;#xa;&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;row&quot;/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row&quot;&gt; 
        &lt;xsl:value-of select=&quot;concat(index, $delim, shape, $delim, 
                                     degrees, $delim, sides)&quot;/&gt; 
         &lt;xsl:text&gt;&amp;#xa;&lt;/xsl:text&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">out_csv = geom_df.to_csv(line_terminator=</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">out_csv </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">out_csv = out_csv.strip()</span>
    <span class="s1">out_xml = geom_df.to_xml(stylesheet=xsl)</span>

    <span class="s0">assert </span><span class="s1">out_csv == out_xml</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_style_to_string():</span>
    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;text&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:param name=&quot;delim&quot;&gt;&lt;xsl:text&gt;               &lt;/xsl:text&gt;&lt;/xsl:param&gt; 
    &lt;xsl:template match=&quot;/data&quot;&gt; 
        &lt;xsl:text&gt;      shape  degrees  sides&amp;#xa;&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;row&quot;/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row&quot;&gt; 
        &lt;xsl:value-of select=&quot;concat(index, ' ', 
                                     substring($delim, 1, string-length('triangle') 
                                               - string-length(shape) + 1), 
                                     shape, 
                                     substring($delim, 1, string-length(name(degrees)) 
                                               - string-length(degrees) + 2), 
                                     degrees, 
                                     substring($delim, 1, string-length(name(sides)) 
                                               - string-length(sides) + 2), 
                                     sides)&quot;/&gt; 
         &lt;xsl:text&gt;&amp;#xa;&lt;/xsl:text&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">out_str = geom_df.to_string()</span>
    <span class="s1">out_xml = geom_df.to_xml(na_rep=</span><span class="s2">&quot;NaN&quot;</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>

    <span class="s0">assert </span><span class="s1">out_xml == out_str</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_style_to_json():</span>
    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;text&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:param name=&quot;quot&quot;&gt;&quot;&lt;/xsl:param&gt; 
 
    &lt;xsl:template match=&quot;/data&quot;&gt; 
        &lt;xsl:text&gt;{&quot;shape&quot;:{&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;descendant::row/shape&quot;/&gt; 
        &lt;xsl:text&gt;},&quot;degrees&quot;:{&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;descendant::row/degrees&quot;/&gt; 
        &lt;xsl:text&gt;},&quot;sides&quot;:{&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;descendant::row/sides&quot;/&gt; 
        &lt;xsl:text&gt;}}&lt;/xsl:text&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;shape|degrees|sides&quot;&gt; 
        &lt;xsl:variable name=&quot;val&quot;&gt; 
            &lt;xsl:if test = &quot;.=''&quot;&gt; 
                &lt;xsl:value-of select=&quot;'null'&quot;/&gt; 
            &lt;/xsl:if&gt; 
            &lt;xsl:if test = &quot;number(text()) = text()&quot;&gt; 
                &lt;xsl:value-of select=&quot;text()&quot;/&gt; 
            &lt;/xsl:if&gt; 
            &lt;xsl:if test = &quot;number(text()) != text()&quot;&gt; 
                &lt;xsl:value-of select=&quot;concat($quot, text(), $quot)&quot;/&gt; 
            &lt;/xsl:if&gt; 
        &lt;/xsl:variable&gt; 
        &lt;xsl:value-of select=&quot;concat($quot, preceding-sibling::index, 
                                     $quot,':', $val)&quot;/&gt; 
        &lt;xsl:if test=&quot;preceding-sibling::index != //row[last()]/index&quot;&gt; 
            &lt;xsl:text&gt;,&lt;/xsl:text&gt; 
        &lt;/xsl:if&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">out_json = geom_df.to_json()</span>
    <span class="s1">out_xml = geom_df.to_xml(stylesheet=xsl)</span>

    <span class="s0">assert </span><span class="s1">out_json == out_xml</span>


<span class="s4"># COMPRESSION</span>


<span class="s1">geom_xml = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_compression_output(parser</span><span class="s0">, </span><span class="s1">compression_only):</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean() </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">geom_df.to_xml(path</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=compression_only)</span>

        <span class="s0">with </span><span class="s1">get_handle(</span>
            <span class="s1">path</span><span class="s0">,</span>
            <span class="s2">&quot;r&quot;</span><span class="s0">,</span>
            <span class="s1">compression=compression_only</span><span class="s0">,</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">handle_obj:</span>
            <span class="s1">output = handle_obj.handle.read()</span>

    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">geom_xml == output.strip()</span>


<span class="s0">def </span><span class="s1">test_filename_and_suffix_comp(parser</span><span class="s0">, </span><span class="s1">compression_only):</span>
    <span class="s1">compfile = </span><span class="s2">&quot;xml.&quot; </span><span class="s1">+ icom._compression_to_extension[compression_only]</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean(filename=compfile) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">geom_df.to_xml(path</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=compression_only)</span>

        <span class="s0">with </span><span class="s1">get_handle(</span>
            <span class="s1">path</span><span class="s0">,</span>
            <span class="s2">&quot;r&quot;</span><span class="s0">,</span>
            <span class="s1">compression=compression_only</span><span class="s0">,</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">handle_obj:</span>
            <span class="s1">output = handle_obj.handle.read()</span>

    <span class="s1">output = equalize_decl(output)</span>

    <span class="s0">assert </span><span class="s1">geom_xml == output.strip()</span>


<span class="s0">def </span><span class="s1">test_ea_dtypes(any_numeric_ea_dtype</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s4"># GH#43903</span>
    <span class="s1">expected = </span><span class="s2">&quot;&quot;&quot;&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;a/&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [NA]}).astype(any_numeric_ea_dtype)</span>
    <span class="s1">result = df.to_xml(parser=parser)</span>
    <span class="s0">assert </span><span class="s1">equalize_decl(result).strip() == expected</span>


<span class="s0">def </span><span class="s1">test_unsuported_compression(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Unrecognized compression type&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">tm.ensure_clean() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">geom_df.to_xml(path</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;7z&quot;</span><span class="s1">)</span>


<span class="s4"># STORAGE OPTIONS</span>


<span class="s1">@tm.network</span>
<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;s3fs&quot;</span><span class="s1">)</span>
<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_s3_permission_output(parser):</span>
    <span class="s0">import </span><span class="s1">s3fs</span>

    <span class="s0">with </span><span class="s1">pytest.raises(PermissionError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Access Denied&quot;</span><span class="s1">):</span>
        <span class="s1">fs = s3fs.S3FileSystem(anon=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">fs.ls(</span><span class="s2">&quot;pandas-test&quot;</span><span class="s1">)</span>

        <span class="s1">geom_df.to_xml(</span><span class="s2">&quot;s3://pandas-test/geom.xml&quot;</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;zip&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>
</pre>
</body>
</html>