<html>
<head>
<title>test_symbolic.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_symbolic.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_raises</span>
<span class="s0">from </span><span class="s1">numpy.f2py.symbolic </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Expr</span><span class="s0">, </span><span class="s1">Op</span><span class="s0">, </span><span class="s1">ArithOp</span><span class="s0">, </span><span class="s1">Language</span><span class="s0">,</span>
    <span class="s1">as_symbol</span><span class="s0">, </span><span class="s1">as_number</span><span class="s0">, </span><span class="s1">as_string</span><span class="s0">, </span><span class="s1">as_array</span><span class="s0">, </span><span class="s1">as_complex</span><span class="s0">,</span>
    <span class="s1">as_terms</span><span class="s0">, </span><span class="s1">as_factors</span><span class="s0">, </span><span class="s1">eliminate_quotes</span><span class="s0">, </span><span class="s1">insert_quotes</span><span class="s0">,</span>
    <span class="s1">fromstring</span><span class="s0">, </span><span class="s1">as_expr</span><span class="s0">, </span><span class="s1">as_apply</span><span class="s0">,</span>
    <span class="s1">as_numer_denom</span><span class="s0">, </span><span class="s1">as_ternary</span><span class="s0">, </span><span class="s1">as_ref</span><span class="s0">, </span><span class="s1">as_deref</span><span class="s0">,</span>
    <span class="s1">normalize</span><span class="s0">, </span><span class="s1">as_eq</span><span class="s0">, </span><span class="s1">as_ne</span><span class="s0">, </span><span class="s1">as_lt</span><span class="s0">, </span><span class="s1">as_gt</span><span class="s0">, </span><span class="s1">as_le</span><span class="s0">, </span><span class="s1">as_ge</span>
    <span class="s1">)</span>
<span class="s0">from </span><span class="s1">. </span><span class="s0">import </span><span class="s1">util</span>


<span class="s0">class </span><span class="s1">TestSymbolic(util.F2PyTest):</span>

    <span class="s0">def </span><span class="s1">test_eliminate_quotes(self):</span>
        <span class="s0">def </span><span class="s1">worker(s):</span>
            <span class="s1">r</span><span class="s0">, </span><span class="s1">d = eliminate_quotes(s)</span>
            <span class="s1">s1 = insert_quotes(r</span><span class="s0">, </span><span class="s1">d)</span>
            <span class="s0">assert </span><span class="s1">s1 == s</span>

        <span class="s0">for </span><span class="s1">kind </span><span class="s0">in </span><span class="s1">[</span><span class="s2">''</span><span class="s0">, </span><span class="s2">'mykind_'</span><span class="s1">]:</span>
            <span class="s1">worker(kind + </span><span class="s2">'&quot;1234&quot; // &quot;ABCD&quot;'</span><span class="s1">)</span>
            <span class="s1">worker(kind + </span><span class="s2">'&quot;1234&quot; // ' </span><span class="s1">+ kind + </span><span class="s2">'&quot;ABCD&quot;'</span><span class="s1">)</span>
            <span class="s1">worker(kind + </span><span class="s2">'&quot;1234&quot; // </span><span class="s0">\'</span><span class="s2">ABCD</span><span class="s0">\'</span><span class="s2">'</span><span class="s1">)</span>
            <span class="s1">worker(kind + </span><span class="s2">'&quot;1234&quot; // ' </span><span class="s1">+ kind + </span><span class="s2">'</span><span class="s0">\'</span><span class="s2">ABCD</span><span class="s0">\'</span><span class="s2">'</span><span class="s1">)</span>
            <span class="s1">worker(kind + </span><span class="s2">'&quot;1</span><span class="s0">\\</span><span class="s2">&quot;2</span><span class="s0">\'</span><span class="s2">AB</span><span class="s0">\'</span><span class="s2">34&quot;'</span><span class="s1">)</span>
            <span class="s1">worker(</span><span class="s2">'a = ' </span><span class="s1">+ kind + </span><span class="s2">&quot;'1</span><span class="s0">\\</span><span class="s2">'2</span><span class="s0">\&quot;</span><span class="s2">AB</span><span class="s0">\&quot;</span><span class="s2">34'&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_sanity(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">x.op == Op.SYMBOL</span>
        <span class="s0">assert </span><span class="s1">repr(x) == </span><span class="s2">&quot;Expr(Op.SYMBOL, 'x')&quot;</span>
        <span class="s0">assert </span><span class="s1">x == x</span>
        <span class="s0">assert </span><span class="s1">x != y</span>
        <span class="s0">assert </span><span class="s1">hash(x) </span><span class="s0">is not None</span>

        <span class="s1">n = as_number(</span><span class="s3">123</span><span class="s1">)</span>
        <span class="s1">m = as_number(</span><span class="s3">456</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">n.op == Op.INTEGER</span>
        <span class="s0">assert </span><span class="s1">repr(n) == </span><span class="s2">&quot;Expr(Op.INTEGER, (123, 4))&quot;</span>
        <span class="s0">assert </span><span class="s1">n == n</span>
        <span class="s0">assert </span><span class="s1">n != m</span>
        <span class="s0">assert </span><span class="s1">hash(n) </span><span class="s0">is not None</span>

        <span class="s1">fn = as_number(</span><span class="s3">12.3</span><span class="s1">)</span>
        <span class="s1">fm = as_number(</span><span class="s3">45.6</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fn.op == Op.REAL</span>
        <span class="s0">assert </span><span class="s1">repr(fn) == </span><span class="s2">&quot;Expr(Op.REAL, (12.3, 4))&quot;</span>
        <span class="s0">assert </span><span class="s1">fn == fn</span>
        <span class="s0">assert </span><span class="s1">fn != fm</span>
        <span class="s0">assert </span><span class="s1">hash(fn) </span><span class="s0">is not None</span>

        <span class="s1">c = as_complex(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">c2 = as_complex(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">c.op == Op.COMPLEX</span>
        <span class="s0">assert </span><span class="s1">repr(c) == (</span><span class="s2">&quot;Expr(Op.COMPLEX, (Expr(Op.INTEGER, (1, 4)),&quot;</span>
                           <span class="s2">&quot; Expr(Op.INTEGER, (2, 4))))&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">c == c</span>
        <span class="s0">assert </span><span class="s1">c != c2</span>
        <span class="s0">assert </span><span class="s1">hash(c) </span><span class="s0">is not None</span>

        <span class="s1">s = as_string(</span><span class="s2">&quot;'123'&quot;</span><span class="s1">)</span>
        <span class="s1">s2 = as_string(</span><span class="s2">'&quot;ABC&quot;'</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">s.op == Op.STRING</span>
        <span class="s0">assert </span><span class="s1">repr(s) == </span><span class="s2">&quot;Expr(Op.STRING, (</span><span class="s0">\&quot;</span><span class="s2">'123'</span><span class="s0">\&quot;</span><span class="s2">, 1))&quot;</span><span class="s0">, </span><span class="s1">repr(s)</span>
        <span class="s0">assert </span><span class="s1">s == s</span>
        <span class="s0">assert </span><span class="s1">s != s2</span>

        <span class="s1">a = as_array((n</span><span class="s0">, </span><span class="s1">m))</span>
        <span class="s1">b = as_array((n</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">a.op == Op.ARRAY</span>
        <span class="s0">assert </span><span class="s1">repr(a) == (</span><span class="s2">&quot;Expr(Op.ARRAY, (Expr(Op.INTEGER, (123, 4)),&quot;</span>
                           <span class="s2">&quot; Expr(Op.INTEGER, (456, 4))))&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a == a</span>
        <span class="s0">assert </span><span class="s1">a != b</span>

        <span class="s1">t = as_terms(x)</span>
        <span class="s1">u = as_terms(y)</span>
        <span class="s0">assert </span><span class="s1">t.op == Op.TERMS</span>
        <span class="s0">assert </span><span class="s1">repr(t) == </span><span class="s2">&quot;Expr(Op.TERMS, {Expr(Op.SYMBOL, 'x'): 1})&quot;</span>
        <span class="s0">assert </span><span class="s1">t == t</span>
        <span class="s0">assert </span><span class="s1">t != u</span>
        <span class="s0">assert </span><span class="s1">hash(t) </span><span class="s0">is not None</span>

        <span class="s1">v = as_factors(x)</span>
        <span class="s1">w = as_factors(y)</span>
        <span class="s0">assert </span><span class="s1">v.op == Op.FACTORS</span>
        <span class="s0">assert </span><span class="s1">repr(v) == </span><span class="s2">&quot;Expr(Op.FACTORS, {Expr(Op.SYMBOL, 'x'): 1})&quot;</span>
        <span class="s0">assert </span><span class="s1">v == v</span>
        <span class="s0">assert </span><span class="s1">w != v</span>
        <span class="s0">assert </span><span class="s1">hash(v) </span><span class="s0">is not None</span>

        <span class="s1">t = as_ternary(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span>
        <span class="s1">u = as_ternary(x</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">t.op == Op.TERNARY</span>
        <span class="s0">assert </span><span class="s1">t == t</span>
        <span class="s0">assert </span><span class="s1">t != u</span>
        <span class="s0">assert </span><span class="s1">hash(t) </span><span class="s0">is not None</span>

        <span class="s1">e = as_eq(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s1">f = as_lt(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">e.op == Op.RELATIONAL</span>
        <span class="s0">assert </span><span class="s1">e == e</span>
        <span class="s0">assert </span><span class="s1">e != f</span>
        <span class="s0">assert </span><span class="s1">hash(e) </span><span class="s0">is not None</span>

    <span class="s0">def </span><span class="s1">test_tostring_fortran(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>
        <span class="s1">n = as_number(</span><span class="s3">123</span><span class="s1">)</span>
        <span class="s1">m = as_number(</span><span class="s3">456</span><span class="s1">)</span>
        <span class="s1">a = as_array((n</span><span class="s0">, </span><span class="s1">m))</span>
        <span class="s1">c = as_complex(n</span><span class="s0">, </span><span class="s1">m)</span>

        <span class="s0">assert </span><span class="s1">str(x) == </span><span class="s2">'x'</span>
        <span class="s0">assert </span><span class="s1">str(n) == </span><span class="s2">'123'</span>
        <span class="s0">assert </span><span class="s1">str(a) == </span><span class="s2">'[123, 456]'</span>
        <span class="s0">assert </span><span class="s1">str(c) == </span><span class="s2">'(123, 456)'</span>

        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s1">})) == </span><span class="s2">'x'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">})) == </span><span class="s2">'2 * x'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: -</span><span class="s3">1</span><span class="s1">})) == </span><span class="s2">'-x'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: -</span><span class="s3">2</span><span class="s1">})) == </span><span class="s2">'-2 * x'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">1</span><span class="s1">})) == </span><span class="s2">'x + y'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: -</span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: -</span><span class="s3">1</span><span class="s1">})) == </span><span class="s2">'-x - y'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">3</span><span class="s1">})) == </span><span class="s2">'2 * x + 3 * y'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: -</span><span class="s3">2</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">3</span><span class="s1">})) == </span><span class="s2">'-2 * x + 3 * y'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y: -</span><span class="s3">3</span><span class="s1">})) == </span><span class="s2">'2 * x - 3 * y'</span>

        <span class="s0">assert </span><span class="s1">str(Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s1">})) == </span><span class="s2">'x'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">})) == </span><span class="s2">'x ** 2'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: -</span><span class="s3">1</span><span class="s1">})) == </span><span class="s2">'x ** -1'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: -</span><span class="s3">2</span><span class="s1">})) == </span><span class="s2">'x ** -2'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">1</span><span class="s1">})) == </span><span class="s2">'x * y'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">3</span><span class="s1">})) == </span><span class="s2">'x ** 2 * y ** 3'</span>

        <span class="s1">v = Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s0">, </span><span class="s1">Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">1</span><span class="s1">}): </span><span class="s3">3</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">str(v) == </span><span class="s2">'x ** 2 * (x + y) ** 3'</span><span class="s0">, </span><span class="s1">str(v)</span>
        <span class="s1">v = Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s0">, </span><span class="s1">Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">1</span><span class="s1">}): </span><span class="s3">3</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">str(v) == </span><span class="s2">'x ** 2 * (x * y) ** 3'</span><span class="s0">, </span><span class="s1">str(v)</span>

        <span class="s0">assert </span><span class="s1">str(Expr(Op.APPLY</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'f'</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">{}))) == </span><span class="s2">'f()'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.APPLY</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'f'</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{}))) == </span><span class="s2">'f(x)'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.APPLY</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'f'</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">{}))) == </span><span class="s2">'f(x, y)'</span>
        <span class="s0">assert </span><span class="s1">str(Expr(Op.INDEXING</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'f'</span><span class="s0">, </span><span class="s1">x))) == </span><span class="s2">'f[x]'</span>

        <span class="s0">assert </span><span class="s1">str(as_ternary(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)) == </span><span class="s2">'merge(y, z, x)'</span>
        <span class="s0">assert </span><span class="s1">str(as_eq(x</span><span class="s0">, </span><span class="s1">y)) == </span><span class="s2">'x .eq. y'</span>
        <span class="s0">assert </span><span class="s1">str(as_ne(x</span><span class="s0">, </span><span class="s1">y)) == </span><span class="s2">'x .ne. y'</span>
        <span class="s0">assert </span><span class="s1">str(as_lt(x</span><span class="s0">, </span><span class="s1">y)) == </span><span class="s2">'x .lt. y'</span>
        <span class="s0">assert </span><span class="s1">str(as_le(x</span><span class="s0">, </span><span class="s1">y)) == </span><span class="s2">'x .le. y'</span>
        <span class="s0">assert </span><span class="s1">str(as_gt(x</span><span class="s0">, </span><span class="s1">y)) == </span><span class="s2">'x .gt. y'</span>
        <span class="s0">assert </span><span class="s1">str(as_ge(x</span><span class="s0">, </span><span class="s1">y)) == </span><span class="s2">'x .ge. y'</span>

    <span class="s0">def </span><span class="s1">test_tostring_c(self):</span>
        <span class="s1">language = Language.C</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>
        <span class="s1">n = as_number(</span><span class="s3">123</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">}).tostring(language=language) == </span><span class="s2">'x * x'</span>
        <span class="s0">assert </span><span class="s1">Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x + y: </span><span class="s3">2</span><span class="s1">}).tostring(</span>
            <span class="s1">language=language) == </span><span class="s2">'(x + y) * (x + y)'</span>
        <span class="s0">assert </span><span class="s1">Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">12</span><span class="s1">}).tostring(</span>
            <span class="s1">language=language) == </span><span class="s2">'pow(x, 12)'</span>

        <span class="s0">assert </span><span class="s1">as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y).tostring(</span>
            <span class="s1">language=language) == </span><span class="s2">'x / y'</span>
        <span class="s0">assert </span><span class="s1">as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x + y).tostring(</span>
            <span class="s1">language=language) == </span><span class="s2">'x / (x + y)'</span>
        <span class="s0">assert </span><span class="s1">as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s1">x - y</span><span class="s0">, </span><span class="s1">x + y).tostring(</span>
            <span class="s1">language=language) == </span><span class="s2">'(x - y) / (x + y)'</span>
        <span class="s0">assert </span><span class="s1">(x + (x - y) / (x + y) + n).tostring(</span>
            <span class="s1">language=language) == </span><span class="s2">'123 + x + (x - y) / (x + y)'</span>

        <span class="s0">assert </span><span class="s1">as_ternary(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z).tostring(language=language) == </span><span class="s2">&quot;(x?y:z)&quot;</span>
        <span class="s0">assert </span><span class="s1">as_eq(x</span><span class="s0">, </span><span class="s1">y).tostring(language=language) == </span><span class="s2">&quot;x == y&quot;</span>
        <span class="s0">assert </span><span class="s1">as_ne(x</span><span class="s0">, </span><span class="s1">y).tostring(language=language) == </span><span class="s2">&quot;x != y&quot;</span>
        <span class="s0">assert </span><span class="s1">as_lt(x</span><span class="s0">, </span><span class="s1">y).tostring(language=language) == </span><span class="s2">&quot;x &lt; y&quot;</span>
        <span class="s0">assert </span><span class="s1">as_le(x</span><span class="s0">, </span><span class="s1">y).tostring(language=language) == </span><span class="s2">&quot;x &lt;= y&quot;</span>
        <span class="s0">assert </span><span class="s1">as_gt(x</span><span class="s0">, </span><span class="s1">y).tostring(language=language) == </span><span class="s2">&quot;x &gt; y&quot;</span>
        <span class="s0">assert </span><span class="s1">as_ge(x</span><span class="s0">, </span><span class="s1">y).tostring(language=language) == </span><span class="s2">&quot;x &gt;= y&quot;</span>

    <span class="s0">def </span><span class="s1">test_operations(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">x + x == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">x - x == Expr(Op.INTEGER</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">x + y == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">1</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">x - y == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: -</span><span class="s3">1</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">x * x == Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">x * y == Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">1</span><span class="s1">})</span>

        <span class="s0">assert </span><span class="s1">+x == x</span>
        <span class="s0">assert </span><span class="s1">-x == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: -</span><span class="s3">1</span><span class="s1">})</span><span class="s0">, </span><span class="s1">repr(-x)</span>
        <span class="s0">assert </span><span class="s3">2 </span><span class="s1">* x == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s3">2 </span><span class="s1">+ x == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">1</span><span class="s1">): </span><span class="s3">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s3">2 </span><span class="s1">* x + </span><span class="s3">3 </span><span class="s1">* y == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">3</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">(x + y) * </span><span class="s3">2 </span><span class="s1">== Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">2</span><span class="s1">})</span>

        <span class="s0">assert </span><span class="s1">x ** </span><span class="s3">2 </span><span class="s1">== Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">(x + y) ** </span><span class="s3">2 </span><span class="s1">== Expr(Op.TERMS</span><span class="s0">,</span>
                                    <span class="s1">{Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">2</span><span class="s1">}): </span><span class="s3">1</span><span class="s0">,</span>
                                     <span class="s1">Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{y: </span><span class="s3">2</span><span class="s1">}): </span><span class="s3">1</span><span class="s0">,</span>
                                     <span class="s1">Expr(Op.FACTORS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s3">1</span><span class="s1">}): </span><span class="s3">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">(x + y) * x == x ** </span><span class="s3">2 </span><span class="s1">+ x * y</span>
        <span class="s0">assert </span><span class="s1">(x + y) ** </span><span class="s3">2 </span><span class="s1">== x ** </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">2 </span><span class="s1">* x * y + y ** </span><span class="s3">2</span>
        <span class="s0">assert </span><span class="s1">(x + y) ** </span><span class="s3">2 </span><span class="s1">+ (x - y) ** </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">2 </span><span class="s1">* x ** </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">2 </span><span class="s1">* y ** </span><span class="s3">2</span>
        <span class="s0">assert </span><span class="s1">(x + y) * z == x * z + y * z</span>
        <span class="s0">assert </span><span class="s1">z * (x + y) == x * z + y * z</span>

        <span class="s0">assert </span><span class="s1">(x / </span><span class="s3">2</span><span class="s1">) == as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">2 </span><span class="s1">* x / </span><span class="s3">2</span><span class="s1">) == x</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">3 </span><span class="s1">* x / </span><span class="s3">2</span><span class="s1">) == as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s3">3</span><span class="s1">*x</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">4 </span><span class="s1">* x / </span><span class="s3">2</span><span class="s1">) == </span><span class="s3">2 </span><span class="s1">* x</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">5 </span><span class="s1">* x / </span><span class="s3">2</span><span class="s1">) == as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s3">5</span><span class="s1">*x</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">6 </span><span class="s1">* x / </span><span class="s3">2</span><span class="s1">) == </span><span class="s3">3 </span><span class="s1">* x</span>
        <span class="s0">assert </span><span class="s1">((</span><span class="s3">3</span><span class="s1">*</span><span class="s3">5</span><span class="s1">) * x / </span><span class="s3">6</span><span class="s1">) == as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s3">5</span><span class="s1">*x</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">30</span><span class="s1">*x**</span><span class="s3">2</span><span class="s1">*y**</span><span class="s3">4 </span><span class="s1">/ (</span><span class="s3">24</span><span class="s1">*x**</span><span class="s3">3</span><span class="s1">*y**</span><span class="s3">3</span><span class="s1">)) == as_apply(ArithOp.DIV</span><span class="s0">,</span>
                                                           <span class="s3">5</span><span class="s1">*y</span><span class="s0">, </span><span class="s3">4</span><span class="s1">*x)</span>
        <span class="s0">assert </span><span class="s1">((</span><span class="s3">15 </span><span class="s1">* x / </span><span class="s3">6</span><span class="s1">) / </span><span class="s3">5</span><span class="s1">) == as_apply(</span>
            <span class="s1">ArithOp.DIV</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15 </span><span class="s1">* x / </span><span class="s3">6</span><span class="s1">) / </span><span class="s3">5</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(x / (</span><span class="s3">5 </span><span class="s1">/ x)) == as_apply(ArithOp.DIV</span><span class="s0">, </span><span class="s1">x**</span><span class="s3">2</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">5</span><span class="s1">))</span>

        <span class="s0">assert </span><span class="s1">(x / </span><span class="s3">2.0</span><span class="s1">) == Expr(Op.TERMS</span><span class="s0">, </span><span class="s1">{x: </span><span class="s3">0.5</span><span class="s1">})</span>

        <span class="s1">s = as_string(</span><span class="s2">'&quot;ABC&quot;'</span><span class="s1">)</span>
        <span class="s1">t = as_string(</span><span class="s2">'&quot;123&quot;'</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">s // t == Expr(Op.STRING</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'&quot;ABC123&quot;'</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">s // x == Expr(Op.CONCAT</span><span class="s0">, </span><span class="s1">(s</span><span class="s0">, </span><span class="s1">x))</span>
        <span class="s0">assert </span><span class="s1">x // s == Expr(Op.CONCAT</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s1">s))</span>

        <span class="s1">c = as_complex(</span><span class="s3">1.</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">-c == as_complex(-</span><span class="s3">1.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">c + c == as_expr((</span><span class="s3">1</span><span class="s1">+</span><span class="s3">2j</span><span class="s1">)*</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">c * c == as_expr((</span><span class="s3">1</span><span class="s1">+</span><span class="s3">2j</span><span class="s1">)**</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_substitute(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>
        <span class="s1">a = as_array((x</span><span class="s0">, </span><span class="s1">y))</span>

        <span class="s0">assert </span><span class="s1">x.substitute({x: y}) == y</span>
        <span class="s0">assert </span><span class="s1">(x + y).substitute({x: z}) == y + z</span>
        <span class="s0">assert </span><span class="s1">(x * y).substitute({x: z}) == y * z</span>
        <span class="s0">assert </span><span class="s1">(x ** </span><span class="s3">4</span><span class="s1">).substitute({x: z}) == z ** </span><span class="s3">4</span>
        <span class="s0">assert </span><span class="s1">(x / y).substitute({x: z}) == z / y</span>
        <span class="s0">assert </span><span class="s1">x.substitute({x: y + z}) == y + z</span>
        <span class="s0">assert </span><span class="s1">a.substitute({x: y + z}) == as_array((y + z</span><span class="s0">, </span><span class="s1">y))</span>

        <span class="s0">assert </span><span class="s1">as_ternary(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z).substitute(</span>
            <span class="s1">{x: y + z}) == as_ternary(y + z</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span>
        <span class="s0">assert </span><span class="s1">as_eq(x</span><span class="s0">, </span><span class="s1">y).substitute(</span>
            <span class="s1">{x: y + z}) == as_eq(y + z</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s0">def </span><span class="s1">test_fromstring(self):</span>

        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>
        <span class="s1">f = as_symbol(</span><span class="s2">'f'</span><span class="s1">)</span>
        <span class="s1">s = as_string(</span><span class="s2">'&quot;ABC&quot;'</span><span class="s1">)</span>
        <span class="s1">t = as_string(</span><span class="s2">'&quot;123&quot;'</span><span class="s1">)</span>
        <span class="s1">a = as_array((x</span><span class="s0">, </span><span class="s1">y))</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x'</span><span class="s1">) == x</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'+ x'</span><span class="s1">) == x</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'-  x'</span><span class="s1">) == -x</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x + y'</span><span class="s1">) == x + y</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x + 1'</span><span class="s1">) == x + </span><span class="s3">1</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x * y'</span><span class="s1">) == x * y</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x * 2'</span><span class="s1">) == x * </span><span class="s3">2</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x / y'</span><span class="s1">) == x / y</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x ** 2'</span><span class="s0">,</span>
                          <span class="s1">language=Language.Python) == x ** </span><span class="s3">2</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x ** 2 ** 3'</span><span class="s0">,</span>
                          <span class="s1">language=Language.Python) == x ** </span><span class="s3">2 </span><span class="s1">** </span><span class="s3">3</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'(x + y) * z'</span><span class="s1">) == (x + y) * z</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'f(x)'</span><span class="s1">) == f(x)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'f(x,y)'</span><span class="s1">) == f(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'f[x]'</span><span class="s1">) == f[x]</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'f[x][y]'</span><span class="s1">) == f[x][y]</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'&quot;ABC&quot;'</span><span class="s1">) == s</span>
        <span class="s0">assert </span><span class="s1">normalize(fromstring(</span><span class="s2">'&quot;ABC&quot; // &quot;123&quot; '</span><span class="s0">,</span>
                                    <span class="s1">language=Language.Fortran)) == s // t</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'f(&quot;ABC&quot;)'</span><span class="s1">) == f(s)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'MYSTRKIND_&quot;ABC&quot;'</span><span class="s1">) == as_string(</span><span class="s2">'&quot;ABC&quot;'</span><span class="s0">, </span><span class="s2">'MYSTRKIND'</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'(/x, y/)'</span><span class="s1">) == a</span><span class="s0">, </span><span class="s1">fromstring(</span><span class="s2">'(/x, y/)'</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'f((/x, y/))'</span><span class="s1">) == f(a)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'(/(x+y)*z/)'</span><span class="s1">) == as_array(((x+y)*z</span><span class="s0">,</span><span class="s1">))</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123'</span><span class="s1">) == as_number(</span><span class="s3">123</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123_2'</span><span class="s1">) == as_number(</span><span class="s3">123</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123_myintkind'</span><span class="s1">) == as_number(</span><span class="s3">123</span><span class="s0">, </span><span class="s2">'myintkind'</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123.0'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123.0_4'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123.0_8'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123.0e0'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123.0d0'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123d0'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123e-0'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123d+0'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'123.0_myrealkind'</span><span class="s1">) == as_number(</span><span class="s3">123.0</span><span class="s0">, </span><span class="s2">'myrealkind'</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'3E4'</span><span class="s1">) == as_number(</span><span class="s3">30000.0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'(1, 2)'</span><span class="s1">) == as_complex(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'(1e2, PI)'</span><span class="s1">) == as_complex(</span>
            <span class="s1">as_number(</span><span class="s3">100.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_symbol(</span><span class="s2">'PI'</span><span class="s1">))</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'[1, 2]'</span><span class="s1">) == as_array((as_number(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">2</span><span class="s1">)))</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'POINT(x, y=1)'</span><span class="s1">) == as_apply(</span>
            <span class="s1">as_symbol(</span><span class="s2">'POINT'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y=as_number(</span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(fromstring(</span><span class="s2">'PERSON(name=&quot;John&quot;, age=50, shape=(/34, 23/))'</span><span class="s1">)</span>
                <span class="s1">== as_apply(as_symbol(</span><span class="s2">'PERSON'</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">name=as_string(</span><span class="s2">'&quot;John&quot;'</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">age=as_number(</span><span class="s3">50</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">shape=as_array((as_number(</span><span class="s3">34</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">23</span><span class="s1">)))))</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x?y:z'</span><span class="s1">) == as_ternary(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'*x'</span><span class="s1">) == as_deref(x)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'**x'</span><span class="s1">) == as_deref(as_deref(x))</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'&amp;x'</span><span class="s1">) == as_ref(x)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'(*x) * (*y)'</span><span class="s1">) == as_deref(x) * as_deref(y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'(*x) * *y'</span><span class="s1">) == as_deref(x) * as_deref(y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'*x * *y'</span><span class="s1">) == as_deref(x) * as_deref(y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'*x**y'</span><span class="s1">) == as_deref(x) * as_deref(y)</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x == y'</span><span class="s1">) == as_eq(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x != y'</span><span class="s1">) == as_ne(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x &lt; y'</span><span class="s1">) == as_lt(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x &gt; y'</span><span class="s1">) == as_gt(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x &lt;= y'</span><span class="s1">) == as_le(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x &gt;= y'</span><span class="s1">) == as_ge(x</span><span class="s0">, </span><span class="s1">y)</span>

        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x .eq. y'</span><span class="s0">, </span><span class="s1">language=Language.Fortran) == as_eq(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x .ne. y'</span><span class="s0">, </span><span class="s1">language=Language.Fortran) == as_ne(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x .lt. y'</span><span class="s0">, </span><span class="s1">language=Language.Fortran) == as_lt(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x .gt. y'</span><span class="s0">, </span><span class="s1">language=Language.Fortran) == as_gt(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x .le. y'</span><span class="s0">, </span><span class="s1">language=Language.Fortran) == as_le(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">fromstring(</span><span class="s2">'x .ge. y'</span><span class="s0">, </span><span class="s1">language=Language.Fortran) == as_ge(x</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s0">def </span><span class="s1">test_traverse(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>
        <span class="s1">f = as_symbol(</span><span class="s2">'f'</span><span class="s1">)</span>

        <span class="s4"># Use traverse to substitute a symbol</span>
        <span class="s0">def </span><span class="s1">replace_visit(s</span><span class="s0">, </span><span class="s1">r=z):</span>
            <span class="s0">if </span><span class="s1">s == x:</span>
                <span class="s0">return </span><span class="s1">r</span>

        <span class="s0">assert </span><span class="s1">x.traverse(replace_visit) == z</span>
        <span class="s0">assert </span><span class="s1">y.traverse(replace_visit) == y</span>
        <span class="s0">assert </span><span class="s1">z.traverse(replace_visit) == z</span>
        <span class="s0">assert </span><span class="s1">(f(y)).traverse(replace_visit) == f(y)</span>
        <span class="s0">assert </span><span class="s1">(f(x)).traverse(replace_visit) == f(z)</span>
        <span class="s0">assert </span><span class="s1">(f[y]).traverse(replace_visit) == f[y]</span>
        <span class="s0">assert </span><span class="s1">(f[z]).traverse(replace_visit) == f[z]</span>
        <span class="s0">assert </span><span class="s1">(x + y + z).traverse(replace_visit) == (</span><span class="s3">2 </span><span class="s1">* z + y)</span>
        <span class="s0">assert </span><span class="s1">(x + f(y</span><span class="s0">, </span><span class="s1">x - z)).traverse(</span>
            <span class="s1">replace_visit) == (z + f(y</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">0</span><span class="s1">)))</span>
        <span class="s0">assert </span><span class="s1">as_eq(x</span><span class="s0">, </span><span class="s1">y).traverse(replace_visit) == as_eq(z</span><span class="s0">, </span><span class="s1">y)</span>

        <span class="s4"># Use traverse to collect symbols, method 1</span>
        <span class="s1">function_symbols = set()</span>
        <span class="s1">symbols = set()</span>

        <span class="s0">def </span><span class="s1">collect_symbols(s):</span>
            <span class="s0">if </span><span class="s1">s.op </span><span class="s0">is </span><span class="s1">Op.APPLY:</span>
                <span class="s1">oper = s.data[</span><span class="s3">0</span><span class="s1">]</span>
                <span class="s1">function_symbols.add(oper)</span>
                <span class="s0">if </span><span class="s1">oper </span><span class="s0">in </span><span class="s1">symbols:</span>
                    <span class="s1">symbols.remove(oper)</span>
            <span class="s0">elif </span><span class="s1">s.op </span><span class="s0">is </span><span class="s1">Op.SYMBOL </span><span class="s0">and </span><span class="s1">s </span><span class="s0">not in </span><span class="s1">function_symbols:</span>
                <span class="s1">symbols.add(s)</span>

        <span class="s1">(x + f(y</span><span class="s0">, </span><span class="s1">x - z)).traverse(collect_symbols)</span>
        <span class="s0">assert </span><span class="s1">function_symbols == {f}</span>
        <span class="s0">assert </span><span class="s1">symbols == {x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z}</span>

        <span class="s4"># Use traverse to collect symbols, method 2</span>
        <span class="s0">def </span><span class="s1">collect_symbols2(expr</span><span class="s0">, </span><span class="s1">symbols):</span>
            <span class="s0">if </span><span class="s1">expr.op </span><span class="s0">is </span><span class="s1">Op.SYMBOL:</span>
                <span class="s1">symbols.add(expr)</span>

        <span class="s1">symbols = set()</span>
        <span class="s1">(x + f(y</span><span class="s0">, </span><span class="s1">x - z)).traverse(collect_symbols2</span><span class="s0">, </span><span class="s1">symbols)</span>
        <span class="s0">assert </span><span class="s1">symbols == {x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">f}</span>

        <span class="s4"># Use traverse to partially collect symbols</span>
        <span class="s0">def </span><span class="s1">collect_symbols3(expr</span><span class="s0">, </span><span class="s1">symbols):</span>
            <span class="s0">if </span><span class="s1">expr.op </span><span class="s0">is </span><span class="s1">Op.APPLY:</span>
                <span class="s4"># skip traversing function calls</span>
                <span class="s0">return </span><span class="s1">expr</span>
            <span class="s0">if </span><span class="s1">expr.op </span><span class="s0">is </span><span class="s1">Op.SYMBOL:</span>
                <span class="s1">symbols.add(expr)</span>

        <span class="s1">symbols = set()</span>
        <span class="s1">(x + f(y</span><span class="s0">, </span><span class="s1">x - z)).traverse(collect_symbols3</span><span class="s0">, </span><span class="s1">symbols)</span>
        <span class="s0">assert </span><span class="s1">symbols == {x}</span>

    <span class="s0">def </span><span class="s1">test_linear_solve(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">z = as_symbol(</span><span class="s2">'z'</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">x.linear_solve(x) == (as_number(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">0</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(x+</span><span class="s3">1</span><span class="s1">).linear_solve(x) == (as_number(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">2</span><span class="s1">*x).linear_solve(x) == (as_number(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">0</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(</span><span class="s3">2</span><span class="s1">*x+</span><span class="s3">3</span><span class="s1">).linear_solve(x) == (as_number(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">as_number(</span><span class="s3">3</span><span class="s1">).linear_solve(x) == (as_number(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">y.linear_solve(x) == (as_number(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">(y*z).linear_solve(x) == (as_number(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">y * z)</span>

        <span class="s0">assert </span><span class="s1">(x+y).linear_solve(x) == (as_number(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">(z*x+y).linear_solve(x) == (z</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">((z+y)*x+y).linear_solve(x) == (z + y</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">(z*y*x+y).linear_solve(x) == (z * y</span><span class="s0">, </span><span class="s1">y)</span>

        <span class="s1">assert_raises(RuntimeError</span><span class="s0">, lambda</span><span class="s1">: (x*x).linear_solve(x))</span>

    <span class="s0">def </span><span class="s1">test_as_numer_denom(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">n = as_number(</span><span class="s3">123</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">as_numer_denom(x) == (x</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">as_numer_denom(x / n) == (x</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s0">assert </span><span class="s1">as_numer_denom(n / x) == (n</span><span class="s0">, </span><span class="s1">x)</span>
        <span class="s0">assert </span><span class="s1">as_numer_denom(x / y) == (x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">as_numer_denom(x * y) == (x * y</span><span class="s0">, </span><span class="s1">as_number(</span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">as_numer_denom(n + x / y) == (x + n * y</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">assert </span><span class="s1">as_numer_denom(n + x / (y - x / n)) == (y * n ** </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y * n - x)</span>

    <span class="s0">def </span><span class="s1">test_polynomial_atoms(self):</span>
        <span class="s1">x = as_symbol(</span><span class="s2">'x'</span><span class="s1">)</span>
        <span class="s1">y = as_symbol(</span><span class="s2">'y'</span><span class="s1">)</span>
        <span class="s1">n = as_number(</span><span class="s3">123</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">x.polynomial_atoms() == {x}</span>
        <span class="s0">assert </span><span class="s1">n.polynomial_atoms() == set()</span>
        <span class="s0">assert </span><span class="s1">(y[x]).polynomial_atoms() == {y[x]}</span>
        <span class="s0">assert </span><span class="s1">(y(x)).polynomial_atoms() == {y(x)}</span>
        <span class="s0">assert </span><span class="s1">(y(x) + x).polynomial_atoms() == {y(x)</span><span class="s0">, </span><span class="s1">x}</span>
        <span class="s0">assert </span><span class="s1">(y(x) * x[y]).polynomial_atoms() == {y(x)</span><span class="s0">, </span><span class="s1">x[y]}</span>
        <span class="s0">assert </span><span class="s1">(y(x) ** x).polynomial_atoms() == {y(x)}</span>
</pre>
</body>
</html>