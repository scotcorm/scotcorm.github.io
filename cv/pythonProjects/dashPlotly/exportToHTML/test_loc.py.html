<html>
<head>
<title>test_loc.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_loc.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.errors </span><span class="s0">import </span><span class="s1">PerformanceWarning</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.indexing </span><span class="s0">import </span><span class="s1">IndexingError</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">single_level_multiindex():</span>
    <span class="s2">&quot;&quot;&quot;single level MultiIndex&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">MultiIndex(</span>
        <span class="s1">levels=[[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;qux&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">codes=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;first&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">frame_random_data_integer_multi_index():</span>
    <span class="s1">levels = [[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span>
    <span class="s1">codes = [[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span>
    <span class="s1">index = MultiIndex(levels=levels</span><span class="s0">, </span><span class="s1">codes=codes)</span>
    <span class="s0">return </span><span class="s1">DataFrame(np.random.randn(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>


<span class="s0">class </span><span class="s1">TestMultiIndexLoc:</span>
    <span class="s0">def </span><span class="s1">test_loc_setitem_frame_with_multiindex(self</span><span class="s0">, </span><span class="s1">multiindex_dataframe_random_data):</span>
        <span class="s1">frame = multiindex_dataframe_random_data</span>
        <span class="s1">frame.loc[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = </span><span class="s4">5</span>
        <span class="s0">assert </span><span class="s1">frame.loc[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] == </span><span class="s4">5</span>

        <span class="s5"># with integer labels</span>
        <span class="s1">df = frame.copy()</span>
        <span class="s1">df.columns = list(range(</span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">df.loc[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] = </span><span class="s4">7</span>
        <span class="s0">assert </span><span class="s1">df.loc[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">] == </span><span class="s4">7</span>

    <span class="s0">def </span><span class="s1">test_loc_getitem_general(self):</span>

        <span class="s5"># GH#2817</span>
        <span class="s1">data = {</span>
            <span class="s3">&quot;amount&quot;</span><span class="s1">: {</span><span class="s4">0</span><span class="s1">: </span><span class="s4">700</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s4">600</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: </span><span class="s4">222</span><span class="s0">, </span><span class="s4">3</span><span class="s1">: </span><span class="s4">333</span><span class="s0">, </span><span class="s4">4</span><span class="s1">: </span><span class="s4">444</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;col&quot;</span><span class="s1">: {</span><span class="s4">0</span><span class="s1">: </span><span class="s4">3.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s4">3.5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: </span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">: </span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">: </span><span class="s4">4.0</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;year&quot;</span><span class="s1">: {</span><span class="s4">0</span><span class="s1">: </span><span class="s4">2012</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s4">2011</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: </span><span class="s4">2012</span><span class="s0">, </span><span class="s4">3</span><span class="s1">: </span><span class="s4">2012</span><span class="s0">, </span><span class="s4">4</span><span class="s1">: </span><span class="s4">2012</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">df = DataFrame(data).set_index(keys=[</span><span class="s3">&quot;col&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])</span>
        <span class="s1">key = </span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">2012</span>

        <span class="s5"># emits a PerformanceWarning, ok</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(PerformanceWarning):</span>
            <span class="s1">tm.assert_frame_equal(df.loc[key]</span><span class="s0">, </span><span class="s1">df.iloc[</span><span class="s4">2</span><span class="s1">:])</span>

        <span class="s5"># this is ok</span>
        <span class="s1">return_value = df.sort_index(inplace=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res = df.loc[key]</span>

        <span class="s5"># col has float dtype, result should be Float64Index</span>
        <span class="s1">index = MultiIndex.from_arrays([[</span><span class="s4">4.0</span><span class="s1">] * </span><span class="s4">3</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2012</span><span class="s1">] * </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;col&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;amount&quot;</span><span class="s1">: [</span><span class="s4">222</span><span class="s0">, </span><span class="s4">333</span><span class="s0">, </span><span class="s4">444</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_loc_getitem_multiindex_missing_label_raises(self):</span>
        <span class="s5"># GH#21593</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randn(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=[[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;^2$&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[</span><span class="s4">2</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_loc_getitem_list_of_tuples_with_multiindex(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">multiindex_year_month_day_dataframe_random_data</span>
    <span class="s1">):</span>
        <span class="s1">ser = multiindex_year_month_day_dataframe_random_data[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = ser.reindex(ser.index[</span><span class="s4">49</span><span class="s1">:</span><span class="s4">51</span><span class="s1">])</span>
        <span class="s1">result = ser.loc[[(</span><span class="s4">2000</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2000</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">13</span><span class="s1">)]]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_loc_getitem_series(self):</span>
        <span class="s5"># GH14730</span>
        <span class="s5"># passing a series as a key with a MultiIndex</span>
        <span class="s1">index = MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]])</span>
        <span class="s1">x = Series(index=index</span><span class="s0">, </span><span class="s1">data=range(</span><span class="s4">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">y = Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">data=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">dtype=np.float64</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = x.loc[y]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = x.loc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># GH15424</span>
        <span class="s1">y1 = Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">result = x.loc[y1]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">empty = Series(data=[]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex(levels=index.levels</span><span class="s0">, </span><span class="s1">codes=[[]</span><span class="s0">, </span><span class="s1">[]]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span><span class="s0">,</span>
            <span class="s1">dtype=np.float64</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = x.loc[empty]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_loc_getitem_array(self):</span>
        <span class="s5"># GH15434</span>
        <span class="s5"># passing an array as a key with a MultiIndex</span>
        <span class="s1">index = MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]])</span>
        <span class="s1">x = Series(index=index</span><span class="s0">, </span><span class="s1">data=range(</span><span class="s4">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">y = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">data=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">dtype=np.float64</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = x.loc[y]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># empty array:</span>
        <span class="s1">empty = np.array([])</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex(levels=index.levels</span><span class="s0">, </span><span class="s1">codes=[[]</span><span class="s0">, </span><span class="s1">[]]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span><span class="s0">,</span>
            <span class="s1">dtype=</span><span class="s3">&quot;float64&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = x.loc[empty]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># 0-dim array (scalar):</span>
        <span class="s1">scalar = np.int64(</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = Series(data=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">result = x.loc[scalar]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_loc_multiindex_labels(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randn(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[[</span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s3">&quot;j&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=[[</span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s3">&quot;j&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s5"># the first 2 rows</span>
        <span class="s1">expected = df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]].droplevel(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">result = df.loc[</span><span class="s3">&quot;i&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># 2nd (last) column</span>
        <span class="s1">expected = df.iloc[:</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]].droplevel(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">result = df.loc[:</span><span class="s0">, </span><span class="s3">&quot;j&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># bottom right corner</span>
        <span class="s1">expected = df.iloc[[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]].droplevel(</span><span class="s4">0</span><span class="s1">).droplevel(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">result = df.loc[</span><span class="s3">&quot;j&quot;</span><span class="s1">].loc[:</span><span class="s0">, </span><span class="s3">&quot;j&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># with a tuple</span>
        <span class="s1">expected = df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span>
        <span class="s1">result = df.loc[(</span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s1">)]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_loc_multiindex_ints(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randn(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=[[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]].droplevel(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">result = df.loc[</span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_loc_multiindex_missing_label_raises(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randn(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=[[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;^2$&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[</span><span class="s4">2</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;key, pos&quot;</span><span class="s0">, </span><span class="s1">[([</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">, </span><span class="s1">([</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[])])</span>
    <span class="s0">def </span><span class="s1">test_loc_multiindex_list_missing_label(self</span><span class="s0">, </span><span class="s1">key</span><span class="s0">, </span><span class="s1">pos):</span>
        <span class="s5"># GH 27148 - lists with missing labels _do_ raise</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randn(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=[[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;not in index&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[key]</span>

    <span class="s0">def </span><span class="s1">test_loc_multiindex_too_many_dims_raises(self):</span>
        <span class="s5"># GH 14885</span>
        <span class="s1">s = Series(</span>
            <span class="s1">range(</span><span class="s4">8</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_product([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;^\('a', 'b'\)$&quot;</span><span class="s1">):</span>
            <span class="s1">s.loc[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;^\('a', 'd', 'g'\)$&quot;</span><span class="s1">):</span>
            <span class="s1">s.loc[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s1">]</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexingError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;Too many indexers&quot;</span><span class="s1">):</span>
            <span class="s1">s.loc[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s3">&quot;j&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_loc_multiindex_indexer_none(self):</span>

        <span class="s5"># GH6788</span>
        <span class="s5"># multi-index indexer is None (meaning take all)</span>
        <span class="s1">attributes = [</span><span class="s3">&quot;Attribute&quot; </span><span class="s1">+ str(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s1">)]</span>
        <span class="s1">attribute_values = [</span><span class="s3">&quot;Value&quot; </span><span class="s1">+ str(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">5</span><span class="s1">)]</span>

        <span class="s1">index = MultiIndex.from_product([attributes</span><span class="s0">, </span><span class="s1">attribute_values])</span>
        <span class="s1">df = </span><span class="s4">0.1 </span><span class="s1">* np.random.randn(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">* </span><span class="s4">5</span><span class="s1">) + </span><span class="s4">0.5</span>
        <span class="s1">df = DataFrame(df</span><span class="s0">, </span><span class="s1">columns=index)</span>
        <span class="s1">result = df[attributes]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s5"># GH 7349</span>
        <span class="s5"># loc with a multi-index seems to be doing fallback</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s4">12</span><span class="s1">).reshape(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected = df.loc[([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">result = df.loc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_loc_multiindex_incomplete(self):</span>

        <span class="s5"># GH 7399</span>
        <span class="s5"># incomplete indexers</span>
        <span class="s1">s = Series(</span>
            <span class="s1">np.arange(</span><span class="s4">15</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">MultiIndex.from_product([range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = s.loc[:</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">:</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>

        <span class="s1">result = s.loc[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">4</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">:</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = s.loc[:</span><span class="s4">4</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">:</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = s.loc[</span><span class="s4">0</span><span class="s1">:</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">:</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># GH 7400</span>
        <span class="s5"># multiindexer getitem with list of indexers skips wrong element</span>
        <span class="s1">s = Series(</span>
            <span class="s1">np.arange(</span><span class="s4">15</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">MultiIndex.from_product([range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = s.iloc[[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s1">]]</span>
        <span class="s1">result = s.loc[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">4</span><span class="s1">:</span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">:</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_get_loc_single_level(self</span><span class="s0">, </span><span class="s1">single_level_multiindex):</span>
        <span class="s1">single_level = single_level_multiindex</span>
        <span class="s1">s = Series(np.random.randn(len(single_level))</span><span class="s0">, </span><span class="s1">index=single_level)</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">single_level.values:</span>
            <span class="s1">s[k]</span>

    <span class="s0">def </span><span class="s1">test_loc_getitem_int_slice(self):</span>
        <span class="s5"># GH 3053</span>
        <span class="s5"># loc should treat integer slices like label slices</span>

        <span class="s1">index = MultiIndex.from_product([[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]])</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">index)</span>
        <span class="s1">result = df.loc[</span><span class="s4">6</span><span class="s1">:</span><span class="s4">8</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">expected = df</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">index = MultiIndex.from_product([[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">30</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]])</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">index)</span>
        <span class="s1">result = df.loc[</span><span class="s4">20</span><span class="s1">:</span><span class="s4">30</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">expected = df.iloc[</span><span class="s4">2</span><span class="s1">:]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># doc examples</span>
        <span class="s1">result = df.loc[</span><span class="s4">10</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">expected = df.iloc[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">expected.index = [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.loc[:</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span>
        <span class="s1">expected = df[</span><span class="s4">10</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;indexer_type_1&quot;</span><span class="s0">, </span><span class="s1">(list</span><span class="s0">, </span><span class="s1">tuple</span><span class="s0">, </span><span class="s1">set</span><span class="s0">, </span><span class="s1">slice</span><span class="s0">, </span><span class="s1">np.ndarray</span><span class="s0">, </span><span class="s1">Series</span><span class="s0">, </span><span class="s1">Index)</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;indexer_type_2&quot;</span><span class="s0">, </span><span class="s1">(list</span><span class="s0">, </span><span class="s1">tuple</span><span class="s0">, </span><span class="s1">set</span><span class="s0">, </span><span class="s1">slice</span><span class="s0">, </span><span class="s1">np.ndarray</span><span class="s0">, </span><span class="s1">Series</span><span class="s0">, </span><span class="s1">Index)</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_loc_getitem_nested_indexer(self</span><span class="s0">, </span><span class="s1">indexer_type_1</span><span class="s0">, </span><span class="s1">indexer_type_2):</span>
        <span class="s5"># GH #19686</span>
        <span class="s5"># .loc should work with nested indexers which can be</span>
        <span class="s5"># any list-like objects (see `is_list_like` (`pandas.api.types`)) or slices</span>

        <span class="s0">def </span><span class="s1">convert_nested_indexer(indexer_type</span><span class="s0">, </span><span class="s1">keys):</span>
            <span class="s0">if </span><span class="s1">indexer_type == np.ndarray:</span>
                <span class="s0">return </span><span class="s1">np.array(keys)</span>
            <span class="s0">if </span><span class="s1">indexer_type == slice:</span>
                <span class="s0">return </span><span class="s1">slice(*keys)</span>
            <span class="s0">return </span><span class="s1">indexer_type(keys)</span>

        <span class="s1">a = [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">30</span><span class="s1">]</span>
        <span class="s1">b = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
        <span class="s1">index = MultiIndex.from_product([a</span><span class="s0">, </span><span class="s1">b])</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.arange(len(index)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;Data&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s1">keys = ([</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">types = (indexer_type_1</span><span class="s0">, </span><span class="s1">indexer_type_2)</span>

        <span class="s5"># check indexers with all the combinations of nested objects</span>
        <span class="s5"># of all the valid types</span>
        <span class="s1">indexer = tuple(</span>
            <span class="s1">convert_nested_indexer(indexer_type</span><span class="s0">, </span><span class="s1">k)</span>
            <span class="s0">for </span><span class="s1">indexer_type</span><span class="s0">, </span><span class="s1">k </span><span class="s0">in </span><span class="s1">zip(types</span><span class="s0">, </span><span class="s1">keys)</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">indexer_type_1 </span><span class="s0">is </span><span class="s1">set </span><span class="s0">or </span><span class="s1">indexer_type_2 </span><span class="s0">is </span><span class="s1">set:</span>
            <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
                <span class="s1">result = df.loc[indexer</span><span class="s0">, </span><span class="s3">&quot;Data&quot;</span><span class="s1">]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">result = df.loc[indexer</span><span class="s0">, </span><span class="s3">&quot;Data&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;Data&quot;</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_product(keys)</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_multiindex_loc_one_dimensional_tuple(self</span><span class="s0">, </span><span class="s1">frame_or_series):</span>
        <span class="s5"># GH#37711</span>
        <span class="s1">mi = MultiIndex.from_tuples([(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">)])</span>
        <span class="s1">obj = frame_or_series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=mi)</span>
        <span class="s1">obj.loc[(</span><span class="s3">&quot;a&quot;</span><span class="s0">,</span><span class="s1">)] = </span><span class="s4">0</span>
        <span class="s1">expected = frame_or_series([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=mi)</span>
        <span class="s1">tm.assert_equal(obj</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;indexer&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">&quot;a&quot;</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s1">)])</span>
    <span class="s0">def </span><span class="s1">test_multiindex_one_dimensional_tuple_columns(self</span><span class="s0">, </span><span class="s1">indexer):</span>
        <span class="s5"># GH#37711</span>
        <span class="s1">mi = MultiIndex.from_tuples([(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">)])</span>
        <span class="s1">obj = DataFrame([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=mi)</span>
        <span class="s1">obj.loc[indexer</span><span class="s0">, </span><span class="s1">:] = </span><span class="s4">0</span>
        <span class="s1">expected = DataFrame([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=mi)</span>
        <span class="s1">tm.assert_frame_equal(obj</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;indexer, exp_value&quot;</span><span class="s0">, </span><span class="s1">[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nan)]</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_multiindex_setitem_columns_enlarging(self</span><span class="s0">, </span><span class="s1">indexer</span><span class="s0">, </span><span class="s1">exp_value):</span>
        <span class="s5"># GH#39147</span>
        <span class="s1">mi = MultiIndex.from_tuples([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)])</span>
        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=mi</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">df.loc[indexer</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]] = </span><span class="s4">1.0</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s1">exp_value</span><span class="s0">, </span><span class="s1">exp_value]]</span><span class="s0">,</span>
            <span class="s1">index=mi</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_sorted_multiindex_after_union(self):</span>
        <span class="s5"># GH#44752</span>
        <span class="s1">midx = MultiIndex.from_product(</span>
            <span class="s1">[pd.date_range(</span><span class="s3">&quot;20110101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])]</span>
        <span class="s1">)</span>
        <span class="s1">ser1 = Series(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">index=midx)</span>
        <span class="s1">ser2 = Series(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">index=midx[:</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">df = pd.concat([ser1</span><span class="s0">, </span><span class="s1">ser2]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">result = df.loc[</span><span class="s3">&quot;2011-01-01&quot;</span><span class="s1">:</span><span class="s3">&quot;2011-01-02&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s4">0</span><span class="s1">: ser1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: ser2})</span>
        <span class="s1">result = df.loc[</span><span class="s3">&quot;2011-01-01&quot;</span><span class="s1">:</span><span class="s3">&quot;2011-01-02&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = pd.concat([ser1</span><span class="s0">, </span><span class="s1">ser2.reindex(ser1.index)]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">result = df.loc[</span><span class="s3">&quot;2011-01-01&quot;</span><span class="s1">:</span><span class="s3">&quot;2011-01-02&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;indexer, pos&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([]</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,  </span><span class="s5"># empty ok</span>
        <span class="s1">([</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,  </span><span class="s5"># &quot;D&quot; isn't present -&gt; raise</span>
        <span class="s1">([</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,  </span><span class="s5"># no values found -&gt; raise</span>
        <span class="s1">([</span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,  </span><span class="s5"># same, with single item list: GH 27148</span>
        <span class="s1">(pd.IndexSlice[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;foo&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, None, </span><span class="s4">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(pd.IndexSlice[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bah&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, None, </span><span class="s4">3</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_loc_getitem_duplicates_multiindex_missing_indexers(indexer</span><span class="s0">, </span><span class="s1">pos):</span>
    <span class="s5"># GH 7866</span>
    <span class="s5"># multi-index slicing with missing indexers</span>
    <span class="s1">idx = MultiIndex.from_product(</span>
        <span class="s1">[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">ser = Series(np.arange(</span><span class="s4">9</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=idx).sort_index()</span>
    <span class="s1">expected = ser.iloc[pos]</span>

    <span class="s0">if </span><span class="s1">expected.size == </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">indexer != []:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=str(indexer)):</span>
            <span class="s1">ser.loc[indexer]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">warn = </span><span class="s0">None</span>
        <span class="s1">msg = </span><span class="s3">&quot;MultiIndex with a nested sequence&quot;</span>
        <span class="s0">if </span><span class="s1">indexer == (slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bah&quot;</span><span class="s1">]):</span>
            <span class="s5"># &quot;bah&quot; is not in idx.levels[1], so is ignored, will raise KeyError</span>
            <span class="s1">warn = FutureWarning</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(warn</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">result = ser.loc[indexer]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;columns_indexer&quot;</span><span class="s0">, </span><span class="s1">[([]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">([</span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[])])</span>
<span class="s0">def </span><span class="s1">test_loc_getitem_duplicates_multiindex_empty_indexer(columns_indexer):</span>
    <span class="s5"># GH 8737</span>
    <span class="s5"># empty indexer</span>
    <span class="s1">multi_index = MultiIndex.from_product(([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;alpha&quot;</span><span class="s0">, </span><span class="s3">&quot;beta&quot;</span><span class="s1">]))</span>
    <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=multi_index)</span>
    <span class="s1">df = df.sort_index(level=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">expected = DataFrame(index=range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=multi_index.reindex([])[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">result = df.loc[:</span><span class="s0">, </span><span class="s1">columns_indexer]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_getitem_duplicates_multiindex_non_scalar_type_object():</span>
    <span class="s5"># regression from &lt; 0.14.0</span>
    <span class="s5"># GH 7914</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[np.mean</span><span class="s0">, </span><span class="s1">np.median]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;median&quot;</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex.from_tuples([(</span><span class="s3">&quot;functs&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;functs&quot;</span><span class="s0">, </span><span class="s3">&quot;median&quot;</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s3">&quot;function&quot;</span><span class="s0">, </span><span class="s3">&quot;name&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[</span><span class="s3">&quot;function&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;functs&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">)]</span>
    <span class="s1">expected = np.mean</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_loc_getitem_tuple_plus_slice():</span>
    <span class="s5"># GH 671</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: np.arange(</span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: np.arange(</span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">).set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">expected = df.loc[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">result = df.loc[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_getitem_int(frame_random_data_integer_multi_index):</span>
    <span class="s1">df = frame_random_data_integer_multi_index</span>
    <span class="s1">result = df.loc[</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">expected = df[-</span><span class="s4">3</span><span class="s1">:]</span>
    <span class="s1">expected.index = expected.index.droplevel(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_getitem_int_raises_exception(frame_random_data_integer_multi_index):</span>
    <span class="s1">df = frame_random_data_integer_multi_index</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;^3$&quot;</span><span class="s1">):</span>
        <span class="s1">df.loc[</span><span class="s4">3</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_loc_getitem_lowerdim_corner(multiindex_dataframe_random_data):</span>
    <span class="s1">df = multiindex_dataframe_random_data</span>

    <span class="s5"># test setup - check key not in dataframe</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;^\('bar', 'three'\)$&quot;</span><span class="s1">):</span>
        <span class="s1">df.loc[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;three&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span>

    <span class="s5"># in theory should be inserting in a sorted space????</span>
    <span class="s1">df.loc[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;three&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = </span><span class="s4">0</span>
    <span class="s1">expected = </span><span class="s4">0</span>
    <span class="s1">result = df.sort_index().loc[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;three&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_loc_setitem_single_column_slice():</span>
    <span class="s5"># case from https://github.com/pandas-dev/pandas/issues/27841</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s3">&quot;string&quot;</span><span class="s0">,</span>
        <span class="s1">index=list(</span><span class="s3">&quot;abcd&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex.from_product([[</span><span class="s3">&quot;Main&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;another&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df[</span><span class="s3">&quot;labels&quot;</span><span class="s1">] = </span><span class="s3">&quot;a&quot;</span>
    <span class="s1">df.loc[:</span><span class="s0">, </span><span class="s3">&quot;labels&quot;</span><span class="s1">] = df.index</span>
    <span class="s1">tm.assert_numpy_array_equal(np.asarray(df[</span><span class="s3">&quot;labels&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.asarray(df.index))</span>

    <span class="s5"># test with non-object block</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">np.nan</span><span class="s0">,</span>
        <span class="s1">index=range(</span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex.from_tuples([(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">df.loc[:</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = np.arange(</span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">expected.iloc[:</span><span class="s0">, </span><span class="s4">2</span><span class="s1">] = np.arange(</span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_nan_multiindex():</span>
    <span class="s5"># GH 5286</span>
    <span class="s1">tups = [</span>
        <span class="s1">(</span><span class="s3">&quot;Good Things&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Good Things&quot;</span><span class="s0">, </span><span class="s3">&quot;R&quot;</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Bad Things&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Bad Things&quot;</span><span class="s0">, </span><span class="s3">&quot;T&quot;</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Okay Things&quot;</span><span class="s0">, </span><span class="s3">&quot;N&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Okay Things&quot;</span><span class="s0">, </span><span class="s3">&quot;N&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Okay Things&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Okay Things&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">np.ones((</span><span class="s4">8</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">columns=Index([</span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples(tups</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;u1&quot;</span><span class="s0">, </span><span class="s3">&quot;u2&quot;</span><span class="s0">, </span><span class="s3">&quot;u3&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[</span><span class="s3">&quot;Good Things&quot;</span><span class="s1">].loc[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">np.ones((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">index=Index([np.nan]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;u3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=Index([</span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_period_string_indexing():</span>
    <span class="s5"># GH 9892</span>
    <span class="s1">a = pd.period_range(</span><span class="s3">&quot;2013Q1&quot;</span><span class="s0">, </span><span class="s3">&quot;2013Q4&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;Q&quot;</span><span class="s1">)</span>
    <span class="s1">i = (</span><span class="s4">1111</span><span class="s0">, </span><span class="s4">2222</span><span class="s0">, </span><span class="s4">3333</span><span class="s1">)</span>
    <span class="s1">idx = MultiIndex.from_product((a</span><span class="s0">, </span><span class="s1">i)</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;Period&quot;</span><span class="s0">, </span><span class="s3">&quot;CVR&quot;</span><span class="s1">))</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">index=idx</span><span class="s0">,</span>
        <span class="s1">columns=(</span>
            <span class="s3">&quot;OMS&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;OMK&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;RES&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;DRIFT_IND&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;OEVRIG_IND&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;FIN_IND&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;VARE_UD&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;LOEN_UD&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;FIN_UD&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[(</span><span class="s3">&quot;2013Q1&quot;</span><span class="s0">, </span><span class="s4">1111</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;OMS&quot;</span><span class="s1">]</span>

    <span class="s1">alt = df.loc[(a[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1111</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;OMS&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">np.isnan(alt)</span>

    <span class="s5"># Because the resolution of the string matches, it is an exact lookup,</span>
    <span class="s5">#  not a slice</span>
    <span class="s0">assert </span><span class="s1">np.isnan(result)</span>

    <span class="s5"># TODO: should it figure this out?</span>
    <span class="s5"># alt = df.loc[&quot;2013Q1&quot;, 1111, &quot;OMS&quot;]</span>
    <span class="s5"># assert np.isnan(alt)</span>


<span class="s0">def </span><span class="s1">test_loc_datetime_mask_slicing():</span>
    <span class="s5"># GH 16699</span>
    <span class="s1">dt_idx = pd.to_datetime([</span><span class="s3">&quot;2017-05-04&quot;</span><span class="s0">, </span><span class="s3">&quot;2017-05-05&quot;</span><span class="s1">])</span>
    <span class="s1">m_idx = MultiIndex.from_product([dt_idx</span><span class="s0">, </span><span class="s1">dt_idx]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;Idx1&quot;</span><span class="s0">, </span><span class="s3">&quot;Idx2&quot;</span><span class="s1">])</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">data=[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=m_idx</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">&quot;C2&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[(dt_idx[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(df.index.get_level_values(</span><span class="s4">1</span><span class="s1">) &gt; </span><span class="s3">&quot;2017-05-04&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;C1&quot;</span><span class="s1">]</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">name=</span><span class="s3">&quot;C1&quot;</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples(</span>
            <span class="s1">[(pd.Timestamp(</span><span class="s3">&quot;2017-05-04&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Timestamp(</span><span class="s3">&quot;2017-05-05&quot;</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s3">&quot;Idx1&quot;</span><span class="s0">, </span><span class="s3">&quot;Idx2&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_datetime_series_tuple_slicing():</span>
    <span class="s5"># https://github.com/pandas-dev/pandas/issues/35858</span>
    <span class="s1">date = pd.Timestamp(</span><span class="s3">&quot;2000&quot;</span><span class="s1">)</span>
    <span class="s1">ser = Series(</span>
        <span class="s4">1</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples([(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">date)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">name=</span><span class="s3">&quot;c&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = ser.loc[:</span><span class="s0">, </span><span class="s1">[date]]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">ser)</span>


<span class="s0">def </span><span class="s1">test_loc_with_mi_indexer():</span>
    <span class="s5"># https://github.com/pandas-dev/pandas/issues/35351</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">data=[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s3">&quot;date&quot;</span><span class="s1">]</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;author&quot;</span><span class="s0">, </span><span class="s3">&quot;price&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">idx = MultiIndex.from_tuples([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s3">&quot;date&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.loc[idx</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s3">&quot;date&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;author&quot;</span><span class="s0">, </span><span class="s3">&quot;price&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_mi_with_level1_named_0():</span>
    <span class="s5"># GH#37194</span>
    <span class="s1">dti = pd.date_range(</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span>

    <span class="s1">ser = Series(range(</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=dti)</span>
    <span class="s1">df = ser.to_frame()</span>
    <span class="s1">df[</span><span class="s4">1</span><span class="s1">] = dti</span>

    <span class="s1">df2 = df.set_index(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">append=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">df2.index.names == (</span><span class="s0">None, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">df2.index.get_loc(dti[</span><span class="s4">0</span><span class="s1">])  </span><span class="s5"># smoke test</span>

    <span class="s1">result = df2.loc[dti[</span><span class="s4">0</span><span class="s1">]]</span>
    <span class="s1">expected = df2.iloc[[</span><span class="s4">0</span><span class="s1">]].droplevel(</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">ser2 = df2[</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">ser2.index.names == (</span><span class="s0">None, </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">result = ser2.loc[dti[</span><span class="s4">0</span><span class="s1">]]</span>
    <span class="s1">expected = ser2.iloc[[</span><span class="s4">0</span><span class="s1">]].droplevel(</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_getitem_str_slice(datapath):</span>
    <span class="s5"># GH#15928</span>
    <span class="s1">path = datapath(</span><span class="s3">&quot;reshape&quot;</span><span class="s0">, </span><span class="s3">&quot;merge&quot;</span><span class="s0">, </span><span class="s3">&quot;data&quot;</span><span class="s0">, </span><span class="s3">&quot;quotes2.csv&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.read_csv(path</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s3">&quot;time&quot;</span><span class="s1">])</span>
    <span class="s1">df2 = df.set_index([</span><span class="s3">&quot;ticker&quot;</span><span class="s0">, </span><span class="s3">&quot;time&quot;</span><span class="s1">]).sort_index()</span>

    <span class="s1">res = df2.loc[(</span><span class="s3">&quot;AAPL&quot;</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">&quot;2016-05-25 13:30:00&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">:].droplevel(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">expected = df2.loc[</span><span class="s3">&quot;AAPL&quot;</span><span class="s1">].loc[slice(</span><span class="s3">&quot;2016-05-25 13:30:00&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_3levels_leading_period_index():</span>
    <span class="s5"># GH#24091</span>
    <span class="s1">pi = pd.PeriodIndex(</span>
        <span class="s1">[</span><span class="s3">&quot;20181101 1100&quot;</span><span class="s0">, </span><span class="s3">&quot;20181101 1200&quot;</span><span class="s0">, </span><span class="s3">&quot;20181102 1300&quot;</span><span class="s0">, </span><span class="s3">&quot;20181102 1400&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">name=</span><span class="s3">&quot;datetime&quot;</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s3">&quot;B&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">lev2 = [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;Z&quot;</span><span class="s0">, </span><span class="s3">&quot;W&quot;</span><span class="s1">]</span>
    <span class="s1">lev3 = [</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;Q&quot;</span><span class="s0">, </span><span class="s3">&quot;F&quot;</span><span class="s1">]</span>
    <span class="s1">mi = MultiIndex.from_arrays([pi</span><span class="s0">, </span><span class="s1">lev2</span><span class="s0">, </span><span class="s1">lev3])</span>

    <span class="s1">ser = Series(range(</span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=mi</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">result = ser.loc[(pi[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">result == </span><span class="s4">0.0</span>


<span class="s0">class </span><span class="s1">TestKeyErrorsWithMultiIndex:</span>
    <span class="s0">def </span><span class="s1">test_missing_keys_raises_keyerror(self):</span>
        <span class="s5"># GH#27420 KeyError, not TypeError</span>
        <span class="s1">df = DataFrame(np.arange(</span><span class="s4">12</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">])</span>
        <span class="s1">df2 = df.set_index([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>

        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;1&quot;</span><span class="s1">):</span>
            <span class="s1">df2.loc[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span>

    <span class="s0">def </span><span class="s1">test_missing_key_raises_keyerror2(self):</span>
        <span class="s5"># GH#21168 KeyError, not &quot;IndexingError: Too many indexers&quot;</span>
        <span class="s1">ser = Series(-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_product([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]] * </span><span class="s4">2</span><span class="s1">))</span>

        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;\(0, 3\)&quot;</span><span class="s1">):</span>
            <span class="s1">ser.loc[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_missing_key_combination(self):</span>
        <span class="s5"># GH: 19556</span>
        <span class="s1">mi = MultiIndex.from_arrays(</span>
            <span class="s1">[</span>
                <span class="s1">np.array([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">np.array([</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;3&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">np.array([</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;three&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(np.random.rand(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=mi)</span>
        <span class="s1">msg = </span><span class="s3">r&quot;\('b', '1', slice\(None, None, None\)\)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.loc[(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.index.get_locs((</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;\('b', '1'\)&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:]</span>


<span class="s0">def </span><span class="s1">test_getitem_loc_commutability(multiindex_year_month_day_dataframe_random_data):</span>
    <span class="s1">df = multiindex_year_month_day_dataframe_random_data</span>
    <span class="s1">ser = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
    <span class="s1">result = ser[</span><span class="s4">2000</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span>
    <span class="s1">expected = df.loc[</span><span class="s4">2000</span><span class="s0">, </span><span class="s4">5</span><span class="s1">][</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_with_nan():</span>
    <span class="s5"># GH: 27104</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;col&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;ind1&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s3">&quot;ind2&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]}</span>
    <span class="s1">).set_index([</span><span class="s3">&quot;ind1&quot;</span><span class="s0">, </span><span class="s3">&quot;ind2&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.loc[[</span><span class="s3">&quot;a&quot;</span><span class="s1">]]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;col&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_tuples([(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;ind1&quot;</span><span class="s0">, </span><span class="s3">&quot;ind2&quot;</span><span class="s1">])</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.loc[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span>
    <span class="s1">expected = DataFrame({</span><span class="s3">&quot;col&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;ind2&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_getitem_non_found_tuple():</span>
    <span class="s5"># GH: 25236</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]).set_index(</span>
        <span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;\(2\.0, 2\.0, 3\.0\)&quot;</span><span class="s1">):</span>
        <span class="s1">df.loc[(</span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_get_loc_datetime_index():</span>
    <span class="s5"># GH#24263</span>
    <span class="s1">index = pd.date_range(</span><span class="s3">&quot;2001-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">mi = MultiIndex.from_arrays([index])</span>
    <span class="s5"># Check if get_loc matches for Index and MultiIndex</span>
    <span class="s0">assert </span><span class="s1">mi.get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">) == slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">31</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">index.get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">) == slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">31</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">loc = mi[::</span><span class="s4">2</span><span class="s1">].get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">)</span>
    <span class="s1">expected = index[::</span><span class="s4">2</span><span class="s1">].get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">loc == expected</span>

    <span class="s1">loc = mi.repeat(</span><span class="s4">2</span><span class="s1">).get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">)</span>
    <span class="s1">expected = index.repeat(</span><span class="s4">2</span><span class="s1">).get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">loc == expected</span>

    <span class="s1">loc = mi.append(mi).get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">)</span>
    <span class="s1">expected = index.append(index).get_loc(</span><span class="s3">&quot;2001-01&quot;</span><span class="s1">)</span>
    <span class="s5"># TODO: standardize return type for MultiIndex.get_loc</span>
    <span class="s1">tm.assert_numpy_array_equal(loc.nonzero()[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_setitem_indexer_differently_ordered():</span>
    <span class="s5"># GH#34603</span>
    <span class="s1">mi = MultiIndex.from_product([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=mi)</span>

    <span class="s1">indexer = (</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">df.loc[indexer</span><span class="s0">, </span><span class="s1">:] = np.array([[</span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]])</span>
    <span class="s1">expected = DataFrame([[</span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=mi)</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_getitem_index_differently_ordered_slice_none():</span>
    <span class="s5"># GH#31330</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;indexer&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]])</span>
<span class="s0">def </span><span class="s1">test_loc_getitem_index_differently_ordered_slice_none_duplicates(indexer):</span>
    <span class="s5"># GH#40978</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span><span class="s4">1</span><span class="s1">] * </span><span class="s4">8</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)]</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">indexer)</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[</span><span class="s4">1</span><span class="s1">] * </span><span class="s4">8</span><span class="s0">,</span>
        <span class="s1">index=[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.loc[df.index.isin(indexer</span><span class="s0">, </span><span class="s1">level=</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_loc_getitem_drops_levels_for_one_row_dataframe():</span>
    <span class="s5"># GH#10521 &quot;x&quot; and &quot;z&quot; are both scalar indexing, so those levels are dropped</span>
    <span class="s1">mi = MultiIndex.from_arrays([[</span><span class="s3">&quot;x&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;z&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">df = DataFrame({</span><span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=mi)</span>
    <span class="s1">expected = df.droplevel([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">result = df.loc[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">ser = Series([</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=mi)</span>
    <span class="s1">result = ser.loc[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span>
    <span class="s1">expected = Series([</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_mi_columns_loc_list_label_order():</span>
    <span class="s5"># GH 10710</span>
    <span class="s1">cols = MultiIndex.from_product([[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
    <span class="s1">df = DataFrame(np.zeros((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">))</span><span class="s0">, </span><span class="s1">columns=cols)</span>
    <span class="s1">result = df.loc[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">np.zeros((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex.from_tuples([(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_mi_partial_indexing_list_raises():</span>
    <span class="s5"># GH 13501</span>
    <span class="s1">frame = DataFrame(</span>
        <span class="s1">np.arange(</span><span class="s4">12</span><span class="s1">).reshape((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">index=[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=[[</span><span class="s3">&quot;Ohio&quot;</span><span class="s0">, </span><span class="s3">&quot;Ohio&quot;</span><span class="s0">, </span><span class="s3">&quot;Colorado&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;Green&quot;</span><span class="s0">, </span><span class="s3">&quot;Red&quot;</span><span class="s0">, </span><span class="s3">&quot;Green&quot;</span><span class="s1">]]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">frame.index.names = [</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span>
    <span class="s1">frame.columns.names = [</span><span class="s3">&quot;state&quot;</span><span class="s0">, </span><span class="s3">&quot;color&quot;</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">[2</span><span class="s0">\\</span><span class="s3">] not in index&quot;</span><span class="s1">):</span>
        <span class="s1">frame.loc[[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;Colorado&quot;</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_mi_indexing_list_nonexistent_raises():</span>
    <span class="s5"># GH 15452</span>
    <span class="s1">s = Series(range(</span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]]))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">['not' 'found'</span><span class="s0">\\</span><span class="s3">] not in index&quot;</span><span class="s1">):</span>
        <span class="s1">s.loc[[</span><span class="s3">&quot;not&quot;</span><span class="s0">, </span><span class="s3">&quot;found&quot;</span><span class="s1">]]</span>


<span class="s0">def </span><span class="s1">test_mi_add_cell_missing_row_non_unique():</span>
    <span class="s5"># GH 16018</span>
    <span class="s1">result = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result.loc[</span><span class="s3">&quot;c&quot;</span><span class="s1">] = -</span><span class="s4">1</span>
    <span class="s1">result.loc[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">)] = </span><span class="s4">3</span>
    <span class="s1">result.loc[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">)] = </span><span class="s4">3</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">6.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">7.0</span><span class="s0">, </span><span class="s4">8.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">3.0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">3.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=MultiIndex.from_product([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_get_scalar_casting_to_float():</span>
    <span class="s5"># GH#41369</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1.0</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=MultiIndex.from_arrays([[</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">])</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">np.int64)</span>
    <span class="s1">result = df.loc[[(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">np.int64)</span>


<span class="s0">def </span><span class="s1">test_loc_empty_single_selector_with_names():</span>
    <span class="s5"># GH 19517</span>
    <span class="s1">idx = MultiIndex.from_product([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">s2 = Series(index=idx</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">result = s2.loc[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span>
    <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s4">0</span><span class="s1">))</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_loc_keyerror_rightmost_key_missing():</span>
    <span class="s5"># GH 20951</span>

    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">200</span><span class="s0">, </span><span class="s4">200</span><span class="s0">, </span><span class="s4">300</span><span class="s0">, </span><span class="s4">300</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">31</span><span class="s0">, </span><span class="s4">33</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;C&quot;</span><span class="s1">: range(</span><span class="s4">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">df = df.set_index([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;^1$&quot;</span><span class="s1">):</span>
        <span class="s1">df.loc[(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_multindex_series_loc_with_tuple_label():</span>
    <span class="s5"># GH#43908</span>
    <span class="s1">mi = MultiIndex.from_tuples([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))])</span>
    <span class="s1">ser = Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=mi)</span>
    <span class="s1">result = ser.loc[(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))]</span>
    <span class="s0">assert </span><span class="s1">result == </span><span class="s4">2</span>
</pre>
</body>
</html>