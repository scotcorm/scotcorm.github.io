<html>
<head>
<title>data_utils.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
data_utils.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>
<span class="s0">import </span><span class="s1">base64</span>
<span class="s0">from </span><span class="s1">.png </span><span class="s0">import </span><span class="s1">Writer</span><span class="s0">, </span><span class="s1">from_array</span>

<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">from </span><span class="s1">PIL </span><span class="s0">import </span><span class="s1">Image</span>

    <span class="s1">pil_imported = </span><span class="s0">True</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s1">pil_imported = </span><span class="s0">False</span>


<span class="s0">def </span><span class="s1">image_array_to_data_uri(img</span><span class="s0">, </span><span class="s1">backend=</span><span class="s2">&quot;pil&quot;</span><span class="s0">, </span><span class="s1">compression=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">ext=</span><span class="s2">&quot;png&quot;</span><span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot;Converts a numpy array of uint8 into a base64 png or jpg string. 
 
    Parameters 
    ---------- 
    img: ndarray of uint8 
        array image 
    backend: str 
        'auto', 'pil' or 'pypng'. If 'auto', Pillow is used if installed, 
        otherwise pypng. 
    compression: int, between 0 and 9 
        compression level to be passed to the backend 
    ext: str, 'png' or 'jpg' 
        compression format used to generate b64 string 
    &quot;&quot;&quot;</span>
    <span class="s5"># PIL and pypng error messages are quite obscure so we catch invalid compression values</span>
    <span class="s0">if </span><span class="s1">compression &lt; </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">compression &gt; </span><span class="s3">9</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">&quot;compression level must be between 0 and 9.&quot;</span><span class="s1">)</span>
    <span class="s1">alpha = </span><span class="s0">False</span>
    <span class="s0">if </span><span class="s1">img.ndim == </span><span class="s3">2</span><span class="s1">:</span>
        <span class="s1">mode = </span><span class="s2">&quot;L&quot;</span>
    <span class="s0">elif </span><span class="s1">img.ndim == </span><span class="s3">3 </span><span class="s0">and </span><span class="s1">img.shape[-</span><span class="s3">1</span><span class="s1">] == </span><span class="s3">3</span><span class="s1">:</span>
        <span class="s1">mode = </span><span class="s2">&quot;RGB&quot;</span>
    <span class="s0">elif </span><span class="s1">img.ndim == </span><span class="s3">3 </span><span class="s0">and </span><span class="s1">img.shape[-</span><span class="s3">1</span><span class="s1">] == </span><span class="s3">4</span><span class="s1">:</span>
        <span class="s1">mode = </span><span class="s2">&quot;RGBA&quot;</span>
        <span class="s1">alpha = </span><span class="s0">True</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">&quot;Invalid image shape&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">backend == </span><span class="s2">&quot;auto&quot;</span><span class="s1">:</span>
        <span class="s1">backend = </span><span class="s2">&quot;pil&quot; </span><span class="s0">if </span><span class="s1">pil_imported </span><span class="s0">else </span><span class="s2">&quot;pypng&quot;</span>
    <span class="s0">if </span><span class="s1">ext != </span><span class="s2">&quot;png&quot; </span><span class="s0">and </span><span class="s1">backend != </span><span class="s2">&quot;pil&quot;</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">&quot;jpg binary strings are only available with PIL backend&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">backend == </span><span class="s2">&quot;pypng&quot;</span><span class="s1">:</span>
        <span class="s1">ndim = img.ndim</span>
        <span class="s1">sh = img.shape</span>
        <span class="s0">if </span><span class="s1">ndim == </span><span class="s3">3</span><span class="s1">:</span>
            <span class="s1">img = img.reshape((sh[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sh[</span><span class="s3">1</span><span class="s1">] * sh[</span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s1">w = Writer(</span>
            <span class="s1">sh[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sh[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">greyscale=(ndim == </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">alpha=alpha</span><span class="s0">, </span><span class="s1">compression=compression</span>
        <span class="s1">)</span>
        <span class="s1">img_png = from_array(img</span><span class="s0">, </span><span class="s1">mode=mode)</span>
        <span class="s1">prefix = </span><span class="s2">&quot;data:image/png;base64,&quot;</span>
        <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">stream:</span>
            <span class="s1">w.write(stream</span><span class="s0">, </span><span class="s1">img_png.rows)</span>
            <span class="s1">base64_string = prefix + base64.b64encode(stream.getvalue()).decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:  </span><span class="s5"># pil</span>
        <span class="s0">if not </span><span class="s1">pil_imported:</span>
            <span class="s0">raise </span><span class="s1">ImportError(</span>
                <span class="s2">&quot;pillow needs to be installed to use `backend='pil'. Please&quot;</span>
                <span class="s2">&quot;install pillow or use `backend='pypng'.&quot;</span>
            <span class="s1">)</span>
        <span class="s1">pil_img = Image.fromarray(img)</span>
        <span class="s0">if </span><span class="s1">ext == </span><span class="s2">&quot;jpg&quot; </span><span class="s0">or </span><span class="s1">ext == </span><span class="s2">&quot;jpeg&quot;</span><span class="s1">:</span>
            <span class="s1">prefix = </span><span class="s2">&quot;data:image/jpeg;base64,&quot;</span>
            <span class="s1">ext = </span><span class="s2">&quot;jpeg&quot;</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">prefix = </span><span class="s2">&quot;data:image/png;base64,&quot;</span>
            <span class="s1">ext = </span><span class="s2">&quot;png&quot;</span>
        <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">stream:</span>
            <span class="s1">pil_img.save(stream</span><span class="s0">, </span><span class="s1">format=ext</span><span class="s0">, </span><span class="s1">compress_level=compression)</span>
            <span class="s1">base64_string = prefix + base64.b64encode(stream.getvalue()).decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">base64_string</span>
</pre>
</body>
</html>