<html>
<head>
<title>test_block_internals.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_block_internals.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">datetime</span><span class="s0">,</span>
    <span class="s1">timedelta</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">itertools</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.errors </span><span class="s0">import </span><span class="s1">PerformanceWarning</span>
<span class="s0">import </span><span class="s1">pandas.util._test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Categorical</span><span class="s0">,</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
    <span class="s1">compat</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
    <span class="s1">option_context</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.internals </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">NumericBlock</span><span class="s0">,</span>
    <span class="s1">ObjectBlock</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s2"># Segregated collection of methods that require the BlockManager internal data</span>
<span class="s2"># structure</span>


<span class="s2"># TODO(ArrayManager) check which of those tests need to be rewritten to test the</span>
<span class="s2"># equivalent for ArrayManager</span>
<span class="s1">pytestmark = td.skip_array_manager_invalid_test</span>


<span class="s0">class </span><span class="s1">TestDataFrameBlockInternals:</span>
    <span class="s0">def </span><span class="s1">test_setitem_invalidates_datetime_index_freq(self):</span>
        <span class="s2"># GH#24096 altering a datetime64tz column inplace invalidates the</span>
        <span class="s2">#  `freq` attribute on the underlying DatetimeIndex</span>

        <span class="s1">dti = date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span>
        <span class="s1">ts = dti[</span><span class="s4">1</span><span class="s1">]</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;B&quot;</span><span class="s1">: dti})</span>
        <span class="s0">assert </span><span class="s1">df[</span><span class="s3">&quot;B&quot;</span><span class="s1">]._values.freq </span><span class="s0">is None</span>

        <span class="s1">df.iloc[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = pd.NaT</span>
        <span class="s0">assert </span><span class="s1">df[</span><span class="s3">&quot;B&quot;</span><span class="s1">]._values.freq </span><span class="s0">is None</span>

        <span class="s2"># check that the DatetimeIndex was not altered in place</span>
        <span class="s0">assert </span><span class="s1">dti.freq == </span><span class="s3">&quot;D&quot;</span>
        <span class="s0">assert </span><span class="s1">dti[</span><span class="s4">1</span><span class="s1">] == ts</span>

    <span class="s0">def </span><span class="s1">test_cast_internals(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s1">casted = DataFrame(float_frame._mgr</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">expected = DataFrame(float_frame._series</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">tm.assert_frame_equal(casted</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">casted = DataFrame(float_frame._mgr</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">expected = DataFrame(float_frame._series</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">tm.assert_frame_equal(casted</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_consolidate(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s1">float_frame[</span><span class="s3">&quot;E&quot;</span><span class="s1">] = </span><span class="s4">7.0</span>
        <span class="s1">consolidated = float_frame._consolidate()</span>
        <span class="s0">assert </span><span class="s1">len(consolidated._mgr.blocks) == </span><span class="s4">1</span>

        <span class="s2"># Ensure copy, do I want this?</span>
        <span class="s1">recons = consolidated._consolidate()</span>
        <span class="s0">assert </span><span class="s1">recons </span><span class="s0">is not </span><span class="s1">consolidated</span>
        <span class="s1">tm.assert_frame_equal(recons</span><span class="s0">, </span><span class="s1">consolidated)</span>

        <span class="s1">float_frame[</span><span class="s3">&quot;F&quot;</span><span class="s1">] = </span><span class="s4">8.0</span>
        <span class="s0">assert </span><span class="s1">len(float_frame._mgr.blocks) == </span><span class="s4">3</span>

        <span class="s1">return_value = float_frame._consolidate_inplace()</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s0">assert </span><span class="s1">len(float_frame._mgr.blocks) == </span><span class="s4">1</span>

    <span class="s0">def </span><span class="s1">test_consolidate_inplace(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s1">frame = float_frame.copy()  </span><span class="s2"># noqa</span>

        <span class="s2"># triggers in-place consolidation</span>
        <span class="s0">for </span><span class="s1">letter </span><span class="s0">in </span><span class="s1">range(ord(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">&quot;Z&quot;</span><span class="s1">)):</span>
            <span class="s1">float_frame[chr(letter)] = chr(letter)</span>

    <span class="s0">def </span><span class="s1">test_values_consolidate(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s1">float_frame[</span><span class="s3">&quot;E&quot;</span><span class="s1">] = </span><span class="s4">7.0</span>
        <span class="s0">assert not </span><span class="s1">float_frame._mgr.is_consolidated()</span>
        <span class="s1">_ = float_frame.values</span>
        <span class="s0">assert </span><span class="s1">float_frame._mgr.is_consolidated()</span>

    <span class="s0">def </span><span class="s1">test_modify_values(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s1">float_frame.values[</span><span class="s4">5</span><span class="s1">] = </span><span class="s4">5</span>
        <span class="s0">assert </span><span class="s1">(float_frame.values[</span><span class="s4">5</span><span class="s1">] == </span><span class="s4">5</span><span class="s1">).all()</span>

        <span class="s2"># unconsolidated</span>
        <span class="s1">float_frame[</span><span class="s3">&quot;E&quot;</span><span class="s1">] = </span><span class="s4">7.0</span>
        <span class="s1">col = float_frame[</span><span class="s3">&quot;E&quot;</span><span class="s1">]</span>
        <span class="s1">float_frame.values[</span><span class="s4">6</span><span class="s1">] = </span><span class="s4">6</span>
        <span class="s0">assert </span><span class="s1">(float_frame.values[</span><span class="s4">6</span><span class="s1">] == </span><span class="s4">6</span><span class="s1">).all()</span>

        <span class="s2"># check that item_cache was cleared</span>
        <span class="s0">assert </span><span class="s1">float_frame[</span><span class="s3">&quot;E&quot;</span><span class="s1">] </span><span class="s0">is not </span><span class="s1">col</span>
        <span class="s0">assert </span><span class="s1">(col == </span><span class="s4">7</span><span class="s1">).all()</span>

    <span class="s0">def </span><span class="s1">test_boolean_set_uncons(self</span><span class="s0">, </span><span class="s1">float_frame):</span>
        <span class="s1">float_frame[</span><span class="s3">&quot;E&quot;</span><span class="s1">] = </span><span class="s4">7.0</span>

        <span class="s1">expected = float_frame.values.copy()</span>
        <span class="s1">expected[expected &gt; </span><span class="s4">1</span><span class="s1">] = </span><span class="s4">2</span>

        <span class="s1">float_frame[float_frame &gt; </span><span class="s4">1</span><span class="s1">] = </span><span class="s4">2</span>
        <span class="s1">tm.assert_almost_equal(expected</span><span class="s0">, </span><span class="s1">float_frame.values)</span>

    <span class="s0">def </span><span class="s1">test_constructor_with_convert(self):</span>
        <span class="s2"># this is actually mostly a test of lib.maybe_convert_objects</span>
        <span class="s2"># #2845</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">2 </span><span class="s1">** </span><span class="s4">63 </span><span class="s1">- </span><span class="s4">1</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">2 </span><span class="s1">** </span><span class="s4">63 </span><span class="s1">- </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.int64)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">2 </span><span class="s1">** </span><span class="s4">63</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">2 </span><span class="s1">** </span><span class="s4">63</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.uint64)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [datetime(</span><span class="s4">2005</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, True</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">np.asarray([datetime(</span><span class="s4">2005</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.object_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s0">None, </span><span class="s4">1</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([np.nan</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.float_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.float_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.complex_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.complex_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, True</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.object_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, None</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">1.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">np.float_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, None</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">1.0 </span><span class="s1">+ </span><span class="s4">2.0j</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">np.complex_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, True, None</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(np.asarray([</span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, True, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.object_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2006</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]})</span>
        <span class="s1">result = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">np.asarray([</span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2006</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.object_)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_construction_with_mixed(self</span><span class="s0">, </span><span class="s1">float_string_frame):</span>
        <span class="s2"># test construction edge cases with mixed types</span>

        <span class="s2"># f7u12, this does not work without extensive workaround</span>
        <span class="s1">data = [</span>
            <span class="s1">[datetime(</span><span class="s4">2001</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2001</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">[datetime(</span><span class="s4">2000</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">df = DataFrame(data)</span>

        <span class="s2"># check dtypes</span>
        <span class="s1">result = df.dtypes</span>
        <span class="s1">expected = Series({</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">})</span>

        <span class="s2"># mixed-type frames</span>
        <span class="s1">float_string_frame[</span><span class="s3">&quot;datetime&quot;</span><span class="s1">] = datetime.now()</span>
        <span class="s1">float_string_frame[</span><span class="s3">&quot;timedelta&quot;</span><span class="s1">] = timedelta(days=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">seconds=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">float_string_frame[</span><span class="s3">&quot;datetime&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;M8[ns]&quot;</span>
        <span class="s0">assert </span><span class="s1">float_string_frame[</span><span class="s3">&quot;timedelta&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;m8[ns]&quot;</span>
        <span class="s1">result = float_string_frame.dtypes</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[np.dtype(</span><span class="s3">&quot;float64&quot;</span><span class="s1">)] * </span><span class="s4">4</span>
            <span class="s1">+ [</span>
                <span class="s1">np.dtype(</span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">np.dtype(</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">np.dtype(</span><span class="s3">&quot;timedelta64[ns]&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=list(</span><span class="s3">&quot;ABCD&quot;</span><span class="s1">) + [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;datetime&quot;</span><span class="s0">, </span><span class="s3">&quot;timedelta&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_construction_with_conversions(self):</span>

        <span class="s2"># convert from a numpy array of non-ns timedelta64</span>
        <span class="s1">arr = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;timedelta64[s]&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(index=range(</span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = arr</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: pd.timedelta_range(</span><span class="s3">&quot;00:00:01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;dt1&quot;</span><span class="s1">: Timestamp(</span><span class="s3">&quot;20130101&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;dt2&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2"># 'dt3' : date_range('20130101 00:00:01',periods=3,freq='s'),</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df = DataFrame(index=range(</span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">] = np.datetime64(</span><span class="s3">&quot;2013-01-01&quot;</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">] = np.array(</span>
            <span class="s1">[</span><span class="s3">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2013-01-02&quot;</span><span class="s0">, </span><span class="s3">&quot;2013-01-03&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;datetime64[D]&quot;</span>
        <span class="s1">)</span>

        <span class="s2"># df['dt3'] = np.array(['2013-01-01 00:00:01','2013-01-01</span>
        <span class="s2"># 00:00:02','2013-01-01 00:00:03'],dtype='datetime64[s]')</span>

        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_constructor_compound_dtypes(self):</span>
        <span class="s2"># GH 5191</span>
        <span class="s2"># compound dtypes should raise not-implementederror</span>

        <span class="s0">def </span><span class="s1">f(dtype):</span>
            <span class="s1">data = list(itertools.repeat((datetime(</span><span class="s4">2001</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;aa&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s4">9</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">DataFrame(data=data</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

        <span class="s1">msg = </span><span class="s3">&quot;compound dtypes are not implemented in the DataFrame constructor&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">f([(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;datetime64[h]&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;str&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;int32&quot;</span><span class="s1">)])</span>

        <span class="s2"># these work (though results may be unexpected)</span>
        <span class="s1">depr_msg = </span><span class="s3">&quot;either all columns will be cast to that dtype, or a TypeError will&quot;</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=depr_msg):</span>
            <span class="s1">f(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=depr_msg):</span>
            <span class="s1">f(</span><span class="s3">&quot;float64&quot;</span><span class="s1">)</span>

        <span class="s2"># 10822</span>
        <span class="s2"># invalid error message on dt inference</span>
        <span class="s0">if not </span><span class="s1">compat.is_platform_windows():</span>
            <span class="s1">f(</span><span class="s3">&quot;M8[ns]&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pickle(self</span><span class="s0">, </span><span class="s1">float_string_frame</span><span class="s0">, </span><span class="s1">timezone_frame):</span>
        <span class="s1">empty_frame = DataFrame()</span>

        <span class="s1">unpickled = tm.round_trip_pickle(float_string_frame)</span>
        <span class="s1">tm.assert_frame_equal(float_string_frame</span><span class="s0">, </span><span class="s1">unpickled)</span>

        <span class="s2"># buglet</span>
        <span class="s1">float_string_frame._mgr.ndim</span>

        <span class="s2"># empty</span>
        <span class="s1">unpickled = tm.round_trip_pickle(empty_frame)</span>
        <span class="s1">repr(unpickled)</span>

        <span class="s2"># tz frame</span>
        <span class="s1">unpickled = tm.round_trip_pickle(timezone_frame)</span>
        <span class="s1">tm.assert_frame_equal(timezone_frame</span><span class="s0">, </span><span class="s1">unpickled)</span>

    <span class="s0">def </span><span class="s1">test_consolidate_datetime64(self):</span>
        <span class="s2"># numpy vstack bug</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;starting&quot;</span><span class="s1">: pd.to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s3">&quot;2012-06-21 00:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-23 07:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-23 16:30&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-25 08:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-26 12:00&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;ending&quot;</span><span class="s1">: pd.to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s3">&quot;2012-06-23 07:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-23 16:30&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-25 08:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-26 12:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2012-06-27 08:00&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;measure&quot;</span><span class="s1">: [</span><span class="s4">77</span><span class="s0">, </span><span class="s4">65</span><span class="s0">, </span><span class="s4">77</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">77</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">ser_starting = df.starting</span>
        <span class="s1">ser_starting.index = ser_starting.values</span>
        <span class="s1">ser_starting = ser_starting.tz_localize(</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span>
        <span class="s1">ser_starting = ser_starting.tz_convert(</span><span class="s3">&quot;UTC&quot;</span><span class="s1">)</span>
        <span class="s1">ser_starting.index.name = </span><span class="s3">&quot;starting&quot;</span>

        <span class="s1">ser_ending = df.ending</span>
        <span class="s1">ser_ending.index = ser_ending.values</span>
        <span class="s1">ser_ending = ser_ending.tz_localize(</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span>
        <span class="s1">ser_ending = ser_ending.tz_convert(</span><span class="s3">&quot;UTC&quot;</span><span class="s1">)</span>
        <span class="s1">ser_ending.index.name = </span><span class="s3">&quot;ending&quot;</span>

        <span class="s1">df.starting = ser_starting.index</span>
        <span class="s1">df.ending = ser_ending.index</span>

        <span class="s1">tm.assert_index_equal(pd.DatetimeIndex(df.starting)</span><span class="s0">, </span><span class="s1">ser_starting.index)</span>
        <span class="s1">tm.assert_index_equal(pd.DatetimeIndex(df.ending)</span><span class="s0">, </span><span class="s1">ser_ending.index)</span>

    <span class="s0">def </span><span class="s1">test_is_mixed_type(self</span><span class="s0">, </span><span class="s1">float_frame</span><span class="s0">, </span><span class="s1">float_string_frame):</span>
        <span class="s0">assert not </span><span class="s1">float_frame._is_mixed_type</span>
        <span class="s0">assert </span><span class="s1">float_string_frame._is_mixed_type</span>

    <span class="s0">def </span><span class="s1">test_stale_cached_series_bug_473(self):</span>

        <span class="s2"># this is chained, but ok</span>
        <span class="s0">with </span><span class="s1">option_context(</span><span class="s3">&quot;chained_assignment&quot;</span><span class="s0">, None</span><span class="s1">):</span>
            <span class="s1">Y = DataFrame(</span>
                <span class="s1">np.random.random((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">index=(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">columns=(</span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s3">&quot;h&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">repr(Y)</span>
            <span class="s1">Y[</span><span class="s3">&quot;e&quot;</span><span class="s1">] = Y[</span><span class="s3">&quot;e&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;object&quot;</span><span class="s1">)</span>
            <span class="s1">Y[</span><span class="s3">&quot;g&quot;</span><span class="s1">][</span><span class="s3">&quot;c&quot;</span><span class="s1">] = np.NaN</span>
            <span class="s1">repr(Y)</span>
            <span class="s1">result = Y.sum()  </span><span class="s2"># noqa</span>
            <span class="s1">exp = Y[</span><span class="s3">&quot;g&quot;</span><span class="s1">].sum()  </span><span class="s2"># noqa</span>
            <span class="s0">assert </span><span class="s1">pd.isna(Y[</span><span class="s3">&quot;g&quot;</span><span class="s1">][</span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_strange_column_corruption_issue(self):</span>
        <span class="s2"># TODO(wesm): Unclear how exactly this is related to internal matters</span>
        <span class="s1">df = DataFrame(index=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">df[</span><span class="s4">0</span><span class="s1">] = np.nan</span>
        <span class="s1">wasCol = {}</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(PerformanceWarning):</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">enumerate(df.index):</span>
                <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">200</span><span class="s1">):</span>
                    <span class="s0">if </span><span class="s1">col </span><span class="s0">not in </span><span class="s1">wasCol:</span>
                        <span class="s1">wasCol[col] = </span><span class="s4">1</span>
                        <span class="s1">df[col] = np.nan</span>
                    <span class="s1">df[col][dt] = i</span>

        <span class="s1">myid = </span><span class="s4">100</span>

        <span class="s1">first = len(df.loc[pd.isna(df[myid])</span><span class="s0">, </span><span class="s1">[myid]])</span>
        <span class="s1">second = len(df.loc[pd.isna(df[myid])</span><span class="s0">, </span><span class="s1">[myid]])</span>
        <span class="s0">assert </span><span class="s1">first == second == </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">test_constructor_no_pandas_array(self):</span>
        <span class="s2"># Ensure that PandasArray isn't allowed inside Series</span>
        <span class="s2"># See https://github.com/pandas-dev/pandas/issues/23995 for more.</span>
        <span class="s1">arr = Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]).array</span>
        <span class="s1">result = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: arr})</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">isinstance(result._mgr.blocks[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">NumericBlock)</span>

    <span class="s0">def </span><span class="s1">test_add_column_with_pandas_array(self):</span>
        <span class="s2"># GH 26390</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]})</span>
        <span class="s1">df[</span><span class="s3">&quot;c&quot;</span><span class="s1">] = pd.arrays.PandasArray(np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object))</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: pd.arrays.PandasArray(np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">type(df[</span><span class="s3">&quot;c&quot;</span><span class="s1">]._mgr.blocks[</span><span class="s4">0</span><span class="s1">]) == ObjectBlock</span>
        <span class="s0">assert </span><span class="s1">type(df2[</span><span class="s3">&quot;c&quot;</span><span class="s1">]._mgr.blocks[</span><span class="s4">0</span><span class="s1">]) == ObjectBlock</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df2)</span>


<span class="s0">def </span><span class="s1">test_update_inplace_sets_valid_block_values():</span>
    <span class="s2"># https://github.com/pandas-dev/pandas/issues/33457</span>
    <span class="s1">df = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;category&quot;</span><span class="s1">)})</span>

    <span class="s2"># inplace update of a single column</span>
    <span class="s1">df[</span><span class="s3">&quot;a&quot;</span><span class="s1">].fillna(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s2"># check we haven't put a Series into any block.values</span>
    <span class="s0">assert </span><span class="s1">isinstance(df._mgr.blocks[</span><span class="s4">0</span><span class="s1">].values</span><span class="s0">, </span><span class="s1">Categorical)</span>

    <span class="s2"># smoketest for OP bug from GH#35731</span>
    <span class="s0">assert </span><span class="s1">df.isnull().sum().sum() == </span><span class="s4">0</span>


<span class="s0">def </span><span class="s1">test_nonconsolidated_item_cache_take():</span>
    <span class="s2"># https://github.com/pandas-dev/pandas/issues/35521</span>

    <span class="s2"># create non-consolidated dataframe with object dtype columns</span>
    <span class="s1">df = DataFrame()</span>
    <span class="s1">df[</span><span class="s3">&quot;col1&quot;</span><span class="s1">] = Series([</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s1">df[</span><span class="s3">&quot;col2&quot;</span><span class="s1">] = Series([</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span>

    <span class="s2"># access column (item cache)</span>
    <span class="s1">df[</span><span class="s3">&quot;col1&quot;</span><span class="s1">] == </span><span class="s3">&quot;A&quot;</span>
    <span class="s2"># take operation</span>
    <span class="s2"># (regression was that this consolidated but didn't reset item cache,</span>
    <span class="s2"># resulting in an invalid cache and the .at operation not working properly)</span>
    <span class="s1">df[df[</span><span class="s3">&quot;col2&quot;</span><span class="s1">] == </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s2"># now setting value should update actual dataframe</span>
    <span class="s1">df.at[</span><span class="s4">0</span><span class="s0">, </span><span class="s3">&quot;col1&quot;</span><span class="s1">] = </span><span class="s3">&quot;A&quot;</span>

    <span class="s1">expected = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">df.at[</span><span class="s4">0</span><span class="s0">, </span><span class="s3">&quot;col1&quot;</span><span class="s1">] == </span><span class="s3">&quot;A&quot;</span>
</pre>
</body>
</html>