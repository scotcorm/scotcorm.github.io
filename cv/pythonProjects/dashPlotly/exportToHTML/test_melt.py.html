<html>
<head>
<title>test_melt.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_melt.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">lreshape</span><span class="s0">,</span>
    <span class="s1">melt</span><span class="s0">,</span>
    <span class="s1">wide_to_long</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>


<span class="s0">class </span><span class="s1">TestMelt:</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s1">self.df = tm.makeTimeDataFrame()[:</span><span class="s2">10</span><span class="s1">]</span>
        <span class="s1">self.df[</span><span class="s3">&quot;id1&quot;</span><span class="s1">] = (self.df[</span><span class="s3">&quot;A&quot;</span><span class="s1">] &gt; </span><span class="s2">0</span><span class="s1">).astype(np.int64)</span>
        <span class="s1">self.df[</span><span class="s3">&quot;id2&quot;</span><span class="s1">] = (self.df[</span><span class="s3">&quot;B&quot;</span><span class="s1">] &gt; </span><span class="s2">0</span><span class="s1">).astype(np.int64)</span>

        <span class="s1">self.var_name = </span><span class="s3">&quot;var&quot;</span>
        <span class="s1">self.value_name = </span><span class="s3">&quot;val&quot;</span>

        <span class="s1">self.df1 = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">1.067683</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.110463</span><span class="s0">, </span><span class="s2">0.20867</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[-</span><span class="s2">1.321405</span><span class="s0">, </span><span class="s2">0.368915</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.055342</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[-</span><span class="s2">0.807333</span><span class="s0">, </span><span class="s2">0.08298</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.873361</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">self.df1.columns = [list(</span><span class="s3">&quot;ABC&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(</span><span class="s3">&quot;abc&quot;</span><span class="s1">)]</span>
        <span class="s1">self.df1.columns.names = [</span><span class="s3">&quot;CAP&quot;</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_top_level_method(self):</span>
        <span class="s1">result = melt(self.df)</span>
        <span class="s0">assert </span><span class="s1">result.columns.tolist() == [</span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_method_signatures(self):</span>
        <span class="s1">tm.assert_frame_equal(self.df.melt()</span><span class="s0">, </span><span class="s1">melt(self.df))</span>

        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">melt(self.df</span><span class="s0">, </span><span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">self.df.melt(var_name=self.var_name</span><span class="s0">, </span><span class="s1">value_name=self.value_name)</span><span class="s0">,</span>
            <span class="s1">melt(self.df</span><span class="s0">, </span><span class="s1">var_name=self.var_name</span><span class="s0">, </span><span class="s1">value_name=self.value_name)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(self.df1.melt(col_level=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">melt(self.df1</span><span class="s0">, </span><span class="s1">col_level=</span><span class="s2">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_default_col_names(self):</span>
        <span class="s1">result = self.df.melt()</span>
        <span class="s0">assert </span><span class="s1">result.columns.tolist() == [</span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

        <span class="s1">result1 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">result1.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

        <span class="s1">result2 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">result2.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_value_vars(self):</span>
        <span class="s1">result3 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">len(result3) == </span><span class="s2">10</span>

        <span class="s1">result4 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">expected4 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id1&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id1&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;id2&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id2&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">] * </span><span class="s2">10 </span><span class="s1">+ [</span><span class="s3">&quot;B&quot;</span><span class="s1">] * </span><span class="s2">10</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: (self.df[</span><span class="s3">&quot;A&quot;</span><span class="s1">].tolist() + self.df[</span><span class="s3">&quot;B&quot;</span><span class="s1">].tolist())</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result4</span><span class="s0">, </span><span class="s1">expected4)</span>

    <span class="s0">def </span><span class="s1">test_value_vars_types(self):</span>
        <span class="s4"># GH 15348</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id1&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id1&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;id2&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id2&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">] * </span><span class="s2">10 </span><span class="s1">+ [</span><span class="s3">&quot;B&quot;</span><span class="s1">] * </span><span class="s2">10</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: (self.df[</span><span class="s3">&quot;A&quot;</span><span class="s1">].tolist() + self.df[</span><span class="s3">&quot;B&quot;</span><span class="s1">].tolist())</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">for </span><span class="s1">type_ </span><span class="s0">in </span><span class="s1">(tuple</span><span class="s0">, </span><span class="s1">list</span><span class="s0">, </span><span class="s1">np.array):</span>
            <span class="s1">result = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=type_((</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">)))</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_vars_work_with_multiindex(self):</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">): self.df1[(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s3">&quot;CAP&quot;</span><span class="s1">: [</span><span class="s3">&quot;B&quot;</span><span class="s1">] * len(self.df1)</span><span class="s0">,</span>
                <span class="s3">&quot;low&quot;</span><span class="s1">: [</span><span class="s3">&quot;b&quot;</span><span class="s1">] * len(self.df1)</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: self.df1[(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;CAP&quot;</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = self.df1.melt(id_vars=[(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">value_vars=[(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;id_vars, value_vars, col_level, expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">0</span><span class="s0">,</span>
                <span class="s1">DataFrame(</span>
                    <span class="s1">{</span>
                        <span class="s3">&quot;A&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">1.067683</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: -</span><span class="s2">1.321405</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: -</span><span class="s2">0.807333</span><span class="s1">}</span><span class="s0">,</span>
                        <span class="s3">&quot;CAP&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;B&quot;</span><span class="s1">}</span><span class="s0">,</span>
                        <span class="s3">&quot;value&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: -</span><span class="s2">1.110463</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">0.368915</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.08298</span><span class="s1">}</span><span class="s0">,</span>
                    <span class="s1">}</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">1</span><span class="s0">,</span>
                <span class="s1">DataFrame(</span>
                    <span class="s1">{</span>
                        <span class="s3">&quot;a&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">1.067683</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: -</span><span class="s2">1.321405</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: -</span><span class="s2">0.807333</span><span class="s1">}</span><span class="s0">,</span>
                        <span class="s3">&quot;low&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s1">}</span><span class="s0">,</span>
                        <span class="s3">&quot;value&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: -</span><span class="s2">1.110463</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">0.368915</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.08298</span><span class="s1">}</span><span class="s0">,</span>
                    <span class="s1">}</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_single_vars_work_with_multiindex(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">id_vars</span><span class="s0">, </span><span class="s1">value_vars</span><span class="s0">, </span><span class="s1">col_level</span><span class="s0">, </span><span class="s1">expected</span>
    <span class="s1">):</span>
        <span class="s1">result = self.df1.melt(id_vars</span><span class="s0">, </span><span class="s1">value_vars</span><span class="s0">, </span><span class="s1">col_level=col_level)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_tuple_vars_fail_with_multiindex(self):</span>
        <span class="s4"># melt should fail with an informative error message if</span>
        <span class="s4"># the columns have a MultiIndex and a tuple is passed</span>
        <span class="s4"># for id_vars or value_vars.</span>
        <span class="s1">tuple_a = (</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">list_a = [tuple_a]</span>
        <span class="s1">tuple_b = (</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span>
        <span class="s1">list_b = [tuple_b]</span>

        <span class="s1">msg = </span><span class="s3">r&quot;(id|value)_vars must be a list of tuples when columns are a MultiIndex&quot;</span>
        <span class="s0">for </span><span class="s1">id_vars</span><span class="s0">, </span><span class="s1">value_vars </span><span class="s0">in </span><span class="s1">(</span>
            <span class="s1">(tuple_a</span><span class="s0">, </span><span class="s1">list_b)</span><span class="s0">,</span>
            <span class="s1">(list_a</span><span class="s0">, </span><span class="s1">tuple_b)</span><span class="s0">,</span>
            <span class="s1">(tuple_a</span><span class="s0">, </span><span class="s1">tuple_b)</span><span class="s0">,</span>
        <span class="s1">):</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">self.df1.melt(id_vars=id_vars</span><span class="s0">, </span><span class="s1">value_vars=value_vars)</span>

    <span class="s0">def </span><span class="s1">test_custom_var_name(self):</span>
        <span class="s1">result5 = self.df.melt(var_name=self.var_name)</span>
        <span class="s0">assert </span><span class="s1">result5.columns.tolist() == [</span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

        <span class="s1">result6 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">var_name=self.var_name)</span>
        <span class="s0">assert </span><span class="s1">result6.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

        <span class="s1">result7 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">var_name=self.var_name)</span>
        <span class="s0">assert </span><span class="s1">result7.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

        <span class="s1">result8 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">var_name=self.var_name</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result8.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

        <span class="s1">result9 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">var_name=self.var_name</span>
        <span class="s1">)</span>
        <span class="s1">expected9 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id1&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id1&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;id2&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id2&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s1">self.var_name: [</span><span class="s3">&quot;A&quot;</span><span class="s1">] * </span><span class="s2">10 </span><span class="s1">+ [</span><span class="s3">&quot;B&quot;</span><span class="s1">] * </span><span class="s2">10</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: (self.df[</span><span class="s3">&quot;A&quot;</span><span class="s1">].tolist() + self.df[</span><span class="s3">&quot;B&quot;</span><span class="s1">].tolist())</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s1">self.var_name</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result9</span><span class="s0">, </span><span class="s1">expected9)</span>

    <span class="s0">def </span><span class="s1">test_custom_value_name(self):</span>
        <span class="s1">result10 = self.df.melt(value_name=self.value_name)</span>
        <span class="s0">assert </span><span class="s1">result10.columns.tolist() == [</span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result11 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_name=self.value_name)</span>
        <span class="s0">assert </span><span class="s1">result11.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result12 = self.df.melt(id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_name=self.value_name)</span>
        <span class="s0">assert </span><span class="s1">result12.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result13 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">value_name=self.value_name</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result13.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result14 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_name=self.value_name</span>
        <span class="s1">)</span>
        <span class="s1">expected14 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id1&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id1&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;id2&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id2&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">] * </span><span class="s2">10 </span><span class="s1">+ [</span><span class="s3">&quot;B&quot;</span><span class="s1">] * </span><span class="s2">10</span><span class="s0">,</span>
                <span class="s1">self.value_name: (self.df[</span><span class="s3">&quot;A&quot;</span><span class="s1">].tolist() + self.df[</span><span class="s3">&quot;B&quot;</span><span class="s1">].tolist())</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s1">self.value_name]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result14</span><span class="s0">, </span><span class="s1">expected14)</span>

    <span class="s0">def </span><span class="s1">test_custom_var_and_value_name(self):</span>

        <span class="s1">result15 = self.df.melt(var_name=self.var_name</span><span class="s0">, </span><span class="s1">value_name=self.value_name)</span>
        <span class="s0">assert </span><span class="s1">result15.columns.tolist() == [</span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result16 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">var_name=self.var_name</span><span class="s0">, </span><span class="s1">value_name=self.value_name</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result16.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result17 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">var_name=self.var_name</span><span class="s0">, </span><span class="s1">value_name=self.value_name</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result17.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result18 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">value_vars=</span><span class="s3">&quot;A&quot;</span><span class="s0">,</span>
            <span class="s1">var_name=self.var_name</span><span class="s0">,</span>
            <span class="s1">value_name=self.value_name</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result18.columns.tolist() == [</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s3">&quot;var&quot;</span><span class="s0">, </span><span class="s3">&quot;val&quot;</span><span class="s1">]</span>

        <span class="s1">result19 = self.df.melt(</span>
            <span class="s1">id_vars=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">value_vars=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">var_name=self.var_name</span><span class="s0">,</span>
            <span class="s1">value_name=self.value_name</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected19 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id1&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id1&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;id2&quot;</span><span class="s1">: self.df[</span><span class="s3">&quot;id2&quot;</span><span class="s1">].tolist() * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s1">self.var_name: [</span><span class="s3">&quot;A&quot;</span><span class="s1">] * </span><span class="s2">10 </span><span class="s1">+ [</span><span class="s3">&quot;B&quot;</span><span class="s1">] * </span><span class="s2">10</span><span class="s0">,</span>
                <span class="s1">self.value_name: (self.df[</span><span class="s3">&quot;A&quot;</span><span class="s1">].tolist() + self.df[</span><span class="s3">&quot;B&quot;</span><span class="s1">].tolist())</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;id1&quot;</span><span class="s0">, </span><span class="s3">&quot;id2&quot;</span><span class="s0">, </span><span class="s1">self.var_name</span><span class="s0">, </span><span class="s1">self.value_name]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result19</span><span class="s0">, </span><span class="s1">expected19)</span>

        <span class="s1">df20 = self.df.copy()</span>
        <span class="s1">df20.columns.name = </span><span class="s3">&quot;foo&quot;</span>
        <span class="s1">result20 = df20.melt()</span>
        <span class="s0">assert </span><span class="s1">result20.columns.tolist() == [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_col_level(self):</span>
        <span class="s1">res1 = self.df1.melt(col_level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">res2 = self.df1.melt(col_level=</span><span class="s3">&quot;CAP&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">res1.columns.tolist() == [</span><span class="s3">&quot;CAP&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">res2.columns.tolist() == [</span><span class="s3">&quot;CAP&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_multiindex(self):</span>
        <span class="s1">res = self.df1.melt()</span>
        <span class="s0">assert </span><span class="s1">res.columns.tolist() == [</span><span class="s3">&quot;CAP&quot;</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;col&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">pd.Series(pd.date_range(</span><span class="s3">&quot;2010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">pd.Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">pd.Series([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_pandas_dtypes(self</span><span class="s0">, </span><span class="s1">col):</span>
        <span class="s4"># GH 15785</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;klass&quot;</span><span class="s1">: range(</span><span class="s2">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s1">: col</span><span class="s0">, </span><span class="s3">&quot;attr1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;attr2&quot;</span><span class="s1">: col}</span>
        <span class="s1">)</span>
        <span class="s1">expected_value = pd.concat([pd.Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">col]</span><span class="s0">, </span><span class="s1">ignore_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = melt(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">id_vars=[</span><span class="s3">&quot;klass&quot;</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">var_name=</span><span class="s3">&quot;attribute&quot;</span><span class="s0">, </span><span class="s1">value_name=</span><span class="s3">&quot;value&quot;</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">0</span><span class="s1">: list(range(</span><span class="s2">5</span><span class="s1">)) * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s2">1</span><span class="s1">: pd.concat([col] * </span><span class="s2">2</span><span class="s0">, </span><span class="s1">ignore_index=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">2</span><span class="s1">: [</span><span class="s3">&quot;attr1&quot;</span><span class="s1">] * </span><span class="s2">5 </span><span class="s1">+ [</span><span class="s3">&quot;attr2&quot;</span><span class="s1">] * </span><span class="s2">5</span><span class="s0">,</span>
                <span class="s2">3</span><span class="s1">: expected_value</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected.columns = [</span><span class="s3">&quot;klass&quot;</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s0">, </span><span class="s3">&quot;attribute&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_preserve_category(self):</span>
        <span class="s4"># GH 15853</span>
        <span class="s1">data = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: pd.Categorical([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">])})</span>
        <span class="s1">result = melt(data</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;B&quot;</span><span class="s1">: pd.Categorical([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_melt_missing_columns_raises(self):</span>
        <span class="s4"># GH-23575</span>
        <span class="s4"># This test is to ensure that pandas raises an error if melting is</span>
        <span class="s4"># attempted with column names absent from the dataframe</span>

        <span class="s4"># Generate data</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s3">&quot;abcd&quot;</span><span class="s1">))</span>

        <span class="s4"># Try to melt with missing `value_vars` column name</span>
        <span class="s1">msg = </span><span class="s3">&quot;The following '{Var}' are not present in the DataFrame: {Col}&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">KeyError</span><span class="s0">, </span><span class="s1">match=msg.format(Var=</span><span class="s3">&quot;value_vars&quot;</span><span class="s0">, </span><span class="s1">Col=</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">['C'</span><span class="s0">\\</span><span class="s3">]&quot;</span><span class="s1">)</span>
        <span class="s1">):</span>
            <span class="s1">df.melt([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">])</span>

        <span class="s4"># Try to melt with missing `id_vars` column name</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=msg.format(Var=</span><span class="s3">&quot;id_vars&quot;</span><span class="s0">, </span><span class="s1">Col=</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">['A'</span><span class="s0">\\</span><span class="s3">]&quot;</span><span class="s1">)):</span>
            <span class="s1">df.melt([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">])</span>

        <span class="s4"># Multiple missing</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">KeyError</span><span class="s0">,</span>
            <span class="s1">match=msg.format(Var=</span><span class="s3">&quot;id_vars&quot;</span><span class="s0">, </span><span class="s1">Col=</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">['not_here', 'or_there'</span><span class="s0">\\</span><span class="s3">]&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">):</span>
            <span class="s1">df.melt([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;not_here&quot;</span><span class="s0">, </span><span class="s3">&quot;or_there&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">])</span>

        <span class="s4"># Multiindex melt fails if column is missing from multilevel melt</span>
        <span class="s1">multi = df.copy()</span>
        <span class="s1">multi.columns = [list(</span><span class="s3">&quot;ABCD&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(</span><span class="s3">&quot;abcd&quot;</span><span class="s1">)]</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=msg.format(Var=</span><span class="s3">&quot;id_vars&quot;</span><span class="s0">, </span><span class="s1">Col=</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">['E'</span><span class="s0">\\</span><span class="s3">]&quot;</span><span class="s1">)):</span>
            <span class="s1">multi.melt([(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)])</span>
        <span class="s4"># Multiindex fails if column is missing from single level melt</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">KeyError</span><span class="s0">, </span><span class="s1">match=msg.format(Var=</span><span class="s3">&quot;value_vars&quot;</span><span class="s0">, </span><span class="s1">Col=</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">['F'</span><span class="s0">\\</span><span class="s3">]&quot;</span><span class="s1">)</span>
        <span class="s1">):</span>
            <span class="s1">multi.melt([</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;F&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">col_level=</span><span class="s2">0</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_melt_mixed_int_str_id_vars(self):</span>
        <span class="s4"># GH 29718</span>
        <span class="s1">df = DataFrame({</span><span class="s2">0</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s1">]})</span>
        <span class="s1">result = melt(df</span><span class="s0">, </span><span class="s1">id_vars=[</span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">0</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;bar&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s1">: list(</span><span class="s3">&quot;bd&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_melt_mixed_int_str_value_vars(self):</span>
        <span class="s4"># GH 29718</span>
        <span class="s1">df = DataFrame({</span><span class="s2">0</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;bar&quot;</span><span class="s1">]})</span>
        <span class="s1">result = melt(df</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ignore_index(self):</span>
        <span class="s4"># GH 17440</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;first&quot;</span><span class="s1">])</span>
        <span class="s1">result = melt(df</span><span class="s0">, </span><span class="s1">ignore_index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;first&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ignore_multiindex(self):</span>
        <span class="s4"># GH 17440</span>
        <span class="s1">index = pd.MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;third&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;foobar&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">result = melt(df</span><span class="s0">, </span><span class="s1">ignore_index=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">expected_index = pd.MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;third&quot;</span><span class="s1">)] * </span><span class="s2">2</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;foobar&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s1">] * </span><span class="s2">2 </span><span class="s1">+ [</span><span class="s3">&quot;bar&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=expected_index</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ignore_index_name_and_type(self):</span>
        <span class="s4"># GH 17440</span>
        <span class="s1">index = pd.Index([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;category&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;baz&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">result = melt(df</span><span class="s0">, </span><span class="s1">ignore_index=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">expected_index = pd.Index([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;category&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;baz&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;variable&quot;</span><span class="s1">: [</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=expected_index</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_melt_with_duplicate_columns(self):</span>
        <span class="s4"># GH#41951</span>
        <span class="s1">df = DataFrame([[</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">result = df.melt(id_vars=[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">value_vars=[</span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">class </span><span class="s1">TestLreshape:</span>
    <span class="s0">def </span><span class="s1">test_pairs(self):</span>
        <span class="s1">data = {</span>
            <span class="s3">&quot;birthdt&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;08jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;30dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;birthwt&quot;</span><span class="s1">: [</span><span class="s2">1766</span><span class="s0">, </span><span class="s2">3301</span><span class="s0">, </span><span class="s2">1454</span><span class="s0">, </span><span class="s2">3139</span><span class="s0">, </span><span class="s2">4133</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s0">, </span><span class="s2">103</span><span class="s0">, </span><span class="s2">104</span><span class="s0">, </span><span class="s2">105</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;sex&quot;</span><span class="s1">: [</span><span class="s3">&quot;Male&quot;</span><span class="s0">, </span><span class="s3">&quot;Female&quot;</span><span class="s0">, </span><span class="s3">&quot;Female&quot;</span><span class="s0">, </span><span class="s3">&quot;Female&quot;</span><span class="s0">, </span><span class="s3">&quot;Female&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;visitdt1&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;22dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;04jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;29dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20jan2009&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;visitdt2&quot;</span><span class="s1">: [</span><span class="s3">&quot;21jan2009&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">&quot;22jan2009&quot;</span><span class="s0">, </span><span class="s3">&quot;31dec2008&quot;</span><span class="s0">, </span><span class="s3">&quot;03feb2009&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;visitdt3&quot;</span><span class="s1">: [</span><span class="s3">&quot;05feb2009&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">&quot;02jan2009&quot;</span><span class="s0">, </span><span class="s3">&quot;15feb2009&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;wt1&quot;</span><span class="s1">: [</span><span class="s2">1823</span><span class="s0">, </span><span class="s2">3338</span><span class="s0">, </span><span class="s2">1549</span><span class="s0">, </span><span class="s2">3298</span><span class="s0">, </span><span class="s2">4306</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;wt2&quot;</span><span class="s1">: [</span><span class="s2">2011.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1892.0</span><span class="s0">, </span><span class="s2">3338.0</span><span class="s0">, </span><span class="s2">4575.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;wt3&quot;</span><span class="s1">: [</span><span class="s2">2293.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3377.0</span><span class="s0">, </span><span class="s2">4805.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>

        <span class="s1">df = DataFrame(data)</span>

        <span class="s1">spec = {</span>
            <span class="s3">&quot;visitdt&quot;</span><span class="s1">: [</span><span class="s3">f&quot;visitdt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s3">d</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s3">&quot;wt&quot;</span><span class="s1">: [</span><span class="s3">f&quot;wt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s3">d</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">result = lreshape(df</span><span class="s0">, </span><span class="s1">spec)</span>

        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;birthdt&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;08jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;30dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;08jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;30dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;08jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;birthwt&quot;</span><span class="s1">: [</span>
                <span class="s2">1766</span><span class="s0">,</span>
                <span class="s2">3301</span><span class="s0">,</span>
                <span class="s2">1454</span><span class="s0">,</span>
                <span class="s2">3139</span><span class="s0">,</span>
                <span class="s2">4133</span><span class="s0">,</span>
                <span class="s2">1766</span><span class="s0">,</span>
                <span class="s2">1454</span><span class="s0">,</span>
                <span class="s2">3139</span><span class="s0">,</span>
                <span class="s2">4133</span><span class="s0">,</span>
                <span class="s2">1766</span><span class="s0">,</span>
                <span class="s2">3139</span><span class="s0">,</span>
                <span class="s2">4133</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s0">, </span><span class="s2">103</span><span class="s0">, </span><span class="s2">104</span><span class="s0">, </span><span class="s2">105</span><span class="s0">, </span><span class="s2">101</span><span class="s0">, </span><span class="s2">103</span><span class="s0">, </span><span class="s2">104</span><span class="s0">, </span><span class="s2">105</span><span class="s0">, </span><span class="s2">101</span><span class="s0">, </span><span class="s2">104</span><span class="s0">, </span><span class="s2">105</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;sex&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;Male&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Male&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Male&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;visitdt&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;22dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;04jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;29dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;22jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;31dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;03feb2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;05feb2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;02jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;15feb2009&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;wt&quot;</span><span class="s1">: [</span>
                <span class="s2">1823.0</span><span class="s0">,</span>
                <span class="s2">3338.0</span><span class="s0">,</span>
                <span class="s2">1549.0</span><span class="s0">,</span>
                <span class="s2">3298.0</span><span class="s0">,</span>
                <span class="s2">4306.0</span><span class="s0">,</span>
                <span class="s2">2011.0</span><span class="s0">,</span>
                <span class="s2">1892.0</span><span class="s0">,</span>
                <span class="s2">3338.0</span><span class="s0">,</span>
                <span class="s2">4575.0</span><span class="s0">,</span>
                <span class="s2">2293.0</span><span class="s0">,</span>
                <span class="s2">3377.0</span><span class="s0">,</span>
                <span class="s2">4805.0</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">exp = DataFrame(exp_data</span><span class="s0">, </span><span class="s1">columns=result.columns)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">result = lreshape(df</span><span class="s0">, </span><span class="s1">spec</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;birthdt&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;08jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;30dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;08jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;30dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;08jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;30dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;birthwt&quot;</span><span class="s1">: [</span>
                <span class="s2">1766</span><span class="s0">,</span>
                <span class="s2">3301</span><span class="s0">,</span>
                <span class="s2">1454</span><span class="s0">,</span>
                <span class="s2">3139</span><span class="s0">,</span>
                <span class="s2">4133</span><span class="s0">,</span>
                <span class="s2">1766</span><span class="s0">,</span>
                <span class="s2">3301</span><span class="s0">,</span>
                <span class="s2">1454</span><span class="s0">,</span>
                <span class="s2">3139</span><span class="s0">,</span>
                <span class="s2">4133</span><span class="s0">,</span>
                <span class="s2">1766</span><span class="s0">,</span>
                <span class="s2">3301</span><span class="s0">,</span>
                <span class="s2">1454</span><span class="s0">,</span>
                <span class="s2">3139</span><span class="s0">,</span>
                <span class="s2">4133</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: [</span>
                <span class="s2">101</span><span class="s0">,</span>
                <span class="s2">102</span><span class="s0">,</span>
                <span class="s2">103</span><span class="s0">,</span>
                <span class="s2">104</span><span class="s0">,</span>
                <span class="s2">105</span><span class="s0">,</span>
                <span class="s2">101</span><span class="s0">,</span>
                <span class="s2">102</span><span class="s0">,</span>
                <span class="s2">103</span><span class="s0">,</span>
                <span class="s2">104</span><span class="s0">,</span>
                <span class="s2">105</span><span class="s0">,</span>
                <span class="s2">101</span><span class="s0">,</span>
                <span class="s2">102</span><span class="s0">,</span>
                <span class="s2">103</span><span class="s0">,</span>
                <span class="s2">104</span><span class="s0">,</span>
                <span class="s2">105</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;sex&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;Male&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Male&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Male&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;Female&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;visitdt&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;11jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;22dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;04jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;29dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;20jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;21jan2009&quot;</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s3">&quot;22jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;31dec2008&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;03feb2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;05feb2009&quot;</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s3">&quot;02jan2009&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;15feb2009&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;wt&quot;</span><span class="s1">: [</span>
                <span class="s2">1823.0</span><span class="s0">,</span>
                <span class="s2">3338.0</span><span class="s0">,</span>
                <span class="s2">1549.0</span><span class="s0">,</span>
                <span class="s2">3298.0</span><span class="s0">,</span>
                <span class="s2">4306.0</span><span class="s0">,</span>
                <span class="s2">2011.0</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s2">1892.0</span><span class="s0">,</span>
                <span class="s2">3338.0</span><span class="s0">,</span>
                <span class="s2">4575.0</span><span class="s0">,</span>
                <span class="s2">2293.0</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s2">3377.0</span><span class="s0">,</span>
                <span class="s2">4805.0</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">exp = DataFrame(exp_data</span><span class="s0">, </span><span class="s1">columns=result.columns)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
            <span class="s1">result = lreshape(df</span><span class="s0">, </span><span class="s1">spec</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False, </span><span class="s1">label=</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

        <span class="s1">spec = {</span>
            <span class="s3">&quot;visitdt&quot;</span><span class="s1">: [</span><span class="s3">f&quot;visitdt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s3">d</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s3">&quot;wt&quot;</span><span class="s1">: [</span><span class="s3">f&quot;wt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s3">d</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">msg = </span><span class="s3">&quot;All column lists must be same length&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">lreshape(df</span><span class="s0">, </span><span class="s1">spec)</span>


<span class="s0">class </span><span class="s1">TestWideToLong:</span>
    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">np.random.seed(</span><span class="s2">123</span><span class="s1">)</span>
        <span class="s1">x = np.random.randn(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A1970&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;c&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;A1980&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;B1970&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.7</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;B1980&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.1</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;X&quot;</span><span class="s1">: dict(zip(range(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;X&quot;</span><span class="s1">: x.tolist() + x.tolist()</span><span class="s0">,</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">0.7</span><span class="s0">, </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;year&quot;</span><span class="s1">: [</span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1980</span><span class="s0">, </span><span class="s2">1980</span><span class="s0">, </span><span class="s2">1980</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">expected = DataFrame(exp_data)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])[[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]]</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_stubs(self):</span>
        <span class="s4"># GH9204 wide_to_long call should not modify 'stubs' list</span>
        <span class="s1">df = DataFrame([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]])</span>
        <span class="s1">df.columns = [</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;inc1&quot;</span><span class="s0">, </span><span class="s3">&quot;inc2&quot;</span><span class="s0">, </span><span class="s3">&quot;edu1&quot;</span><span class="s0">, </span><span class="s3">&quot;edu2&quot;</span><span class="s1">]</span>
        <span class="s1">stubs = [</span><span class="s3">&quot;inc&quot;</span><span class="s0">, </span><span class="s3">&quot;edu&quot;</span><span class="s1">]</span>

        <span class="s1">wide_to_long(df</span><span class="s0">, </span><span class="s1">stubs</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;age&quot;</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">stubs == [</span><span class="s3">&quot;inc&quot;</span><span class="s0">, </span><span class="s3">&quot;edu&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_separating_character(self):</span>
        <span class="s4"># GH14779</span>
        <span class="s1">np.random.seed(</span><span class="s2">123</span><span class="s1">)</span>
        <span class="s1">x = np.random.randn(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A.1970&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;c&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;A.1980&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;B.1970&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.7</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;B.1980&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.1</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;X&quot;</span><span class="s1">: dict(zip(range(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;X&quot;</span><span class="s1">: x.tolist() + x.tolist()</span><span class="s0">,</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">0.7</span><span class="s0">, </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;year&quot;</span><span class="s1">: [</span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1980</span><span class="s0">, </span><span class="s2">1980</span><span class="s0">, </span><span class="s2">1980</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">expected = DataFrame(exp_data)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])[[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]]</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s3">&quot;.&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_escapable_characters(self):</span>
        <span class="s1">np.random.seed(</span><span class="s2">123</span><span class="s1">)</span>
        <span class="s1">x = np.random.randn(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A(quarterly)1970&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;c&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;A(quarterly)1980&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;B(quarterly)1970&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.7</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;B(quarterly)1980&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.1</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;X&quot;</span><span class="s1">: dict(zip(range(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;X&quot;</span><span class="s1">: x.tolist() + x.tolist()</span><span class="s0">,</span>
            <span class="s3">&quot;A(quarterly)&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;B(quarterly)&quot;</span><span class="s1">: [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">0.7</span><span class="s0">, </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;year&quot;</span><span class="s1">: [</span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1970</span><span class="s0">, </span><span class="s2">1980</span><span class="s0">, </span><span class="s2">1980</span><span class="s0">, </span><span class="s2">1980</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">expected = DataFrame(exp_data)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])[</span>
            <span class="s1">[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;A(quarterly)&quot;</span><span class="s0">, </span><span class="s3">&quot;B(quarterly)&quot;</span><span class="s1">]</span>
        <span class="s1">]</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A(quarterly)&quot;</span><span class="s0">, </span><span class="s3">&quot;B(quarterly)&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_unbalanced(self):</span>
        <span class="s4"># test that we can have a varying amount of time variables</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A2010&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A2011&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B2010&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s0">, </span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;year&quot;</span><span class="s1">: [</span><span class="s2">2010</span><span class="s0">, </span><span class="s2">2010</span><span class="s0">, </span><span class="s2">2011</span><span class="s0">, </span><span class="s2">2011</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">expected = DataFrame(exp_data)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])[[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]]</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_character_overlap(self):</span>
        <span class="s4"># Test we handle overlapping characters in both id_vars and value_vars</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A11&quot;</span><span class="s1">: [</span><span class="s3">&quot;a11&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a33&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A12&quot;</span><span class="s1">: [</span><span class="s3">&quot;a21&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B11&quot;</span><span class="s1">: [</span><span class="s3">&quot;b11&quot;</span><span class="s0">, </span><span class="s3">&quot;b12&quot;</span><span class="s0">, </span><span class="s3">&quot;b13&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B12&quot;</span><span class="s1">: [</span><span class="s3">&quot;b21&quot;</span><span class="s0">, </span><span class="s3">&quot;b22&quot;</span><span class="s0">, </span><span class="s3">&quot;b23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BB11&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BB12&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BBBX&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BBBZ&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;BBBX&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s0">, </span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BBBZ&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s0">, </span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;a11&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a33&quot;</span><span class="s0">, </span><span class="s3">&quot;a21&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">&quot;b11&quot;</span><span class="s0">, </span><span class="s3">&quot;b12&quot;</span><span class="s0">, </span><span class="s3">&quot;b13&quot;</span><span class="s0">, </span><span class="s3">&quot;b21&quot;</span><span class="s0">, </span><span class="s3">&quot;b22&quot;</span><span class="s0">, </span><span class="s3">&quot;b23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BB&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;year&quot;</span><span class="s1">: [</span><span class="s2">11</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])[[</span><span class="s3">&quot;BBBX&quot;</span><span class="s0">, </span><span class="s3">&quot;BBBZ&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;BB&quot;</span><span class="s1">]]</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;BB&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result.sort_index(axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected.sort_index(axis=</span><span class="s2">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_invalid_separator(self):</span>
        <span class="s4"># if an invalid separator is supplied a empty data frame is returned</span>
        <span class="s1">sep = </span><span class="s3">&quot;nope!&quot;</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A2010&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A2011&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B2010&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;X&quot;</span><span class="s1">: </span><span class="s3">&quot;&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;A2010&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;A2011&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;B2010&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;year&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: []</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">expected = DataFrame(exp_data).astype({</span><span class="s3">&quot;year&quot;</span><span class="s1">: </span><span class="s3">&quot;int&quot;</span><span class="s1">})</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])[</span>
            <span class="s1">[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;A2010&quot;</span><span class="s0">, </span><span class="s3">&quot;A2011&quot;</span><span class="s0">, </span><span class="s3">&quot;B2010&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span>
        <span class="s1">]</span>
        <span class="s1">expected.index = expected.index.set_levels([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s0">, </span><span class="s1">sep=sep)</span>
        <span class="s1">tm.assert_frame_equal(result.sort_index(axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected.sort_index(axis=</span><span class="s2">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_num_string_disambiguation(self):</span>
        <span class="s4"># Test that we can disambiguate number value_vars from</span>
        <span class="s4"># string value_vars</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A11&quot;</span><span class="s1">: [</span><span class="s3">&quot;a11&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a33&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A12&quot;</span><span class="s1">: [</span><span class="s3">&quot;a21&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B11&quot;</span><span class="s1">: [</span><span class="s3">&quot;b11&quot;</span><span class="s0">, </span><span class="s3">&quot;b12&quot;</span><span class="s0">, </span><span class="s3">&quot;b13&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B12&quot;</span><span class="s1">: [</span><span class="s3">&quot;b21&quot;</span><span class="s0">, </span><span class="s3">&quot;b22&quot;</span><span class="s0">, </span><span class="s3">&quot;b23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BB11&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BB12&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Arating&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Arating_old&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Arating&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s0">, </span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Arating_old&quot;</span><span class="s1">: [</span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s0">, </span><span class="s2">91</span><span class="s0">, </span><span class="s2">92</span><span class="s0">, </span><span class="s2">93</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;a11&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a33&quot;</span><span class="s0">, </span><span class="s3">&quot;a21&quot;</span><span class="s0">, </span><span class="s3">&quot;a22&quot;</span><span class="s0">, </span><span class="s3">&quot;a23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">&quot;b11&quot;</span><span class="s0">, </span><span class="s3">&quot;b12&quot;</span><span class="s0">, </span><span class="s3">&quot;b13&quot;</span><span class="s0">, </span><span class="s3">&quot;b21&quot;</span><span class="s0">, </span><span class="s3">&quot;b22&quot;</span><span class="s0">, </span><span class="s3">&quot;b23&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;BB&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;year&quot;</span><span class="s1">: [</span><span class="s2">11</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])[</span>
            <span class="s1">[</span><span class="s3">&quot;Arating&quot;</span><span class="s0">, </span><span class="s3">&quot;Arating_old&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;BB&quot;</span><span class="s1">]</span>
        <span class="s1">]</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;BB&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result.sort_index(axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected.sort_index(axis=</span><span class="s2">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_invalid_suffixtype(self):</span>
        <span class="s4"># If all stubs names end with a string, but a numeric suffix is</span>
        <span class="s4"># assumed,  an empty data frame is returned</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Aone&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Atwo&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Bone&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = df.index</span>
        <span class="s1">exp_data = {</span>
            <span class="s3">&quot;X&quot;</span><span class="s1">: </span><span class="s3">&quot;&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;Aone&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;Atwo&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;Bone&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;id&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;year&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: []</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: []</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">expected = DataFrame(exp_data).astype({</span><span class="s3">&quot;year&quot;</span><span class="s1">: </span><span class="s3">&quot;int&quot;</span><span class="s1">})</span>

        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;year&quot;</span><span class="s1">])</span>
        <span class="s1">expected.index = expected.index.set_levels([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;year&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result.sort_index(axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected.sort_index(axis=</span><span class="s2">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_multiple_id_columns(self):</span>
        <span class="s4"># Taken from http://www.ats.ucla.edu/stat/stata/modules/reshapel.htm</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;famid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;birth&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;ht1&quot;</span><span class="s1">: [</span><span class="s2">2.8</span><span class="s0">, </span><span class="s2">2.9</span><span class="s0">, </span><span class="s2">2.2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1.8</span><span class="s0">, </span><span class="s2">1.9</span><span class="s0">, </span><span class="s2">2.2</span><span class="s0">, </span><span class="s2">2.3</span><span class="s0">, </span><span class="s2">2.1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;ht2&quot;</span><span class="s1">: [</span><span class="s2">3.4</span><span class="s0">, </span><span class="s2">3.8</span><span class="s0">, </span><span class="s2">2.9</span><span class="s0">, </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">2.8</span><span class="s0">, </span><span class="s2">2.4</span><span class="s0">, </span><span class="s2">3.3</span><span class="s0">, </span><span class="s2">3.4</span><span class="s0">, </span><span class="s2">2.9</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;ht&quot;</span><span class="s1">: [</span>
                    <span class="s2">2.8</span><span class="s0">,</span>
                    <span class="s2">3.4</span><span class="s0">,</span>
                    <span class="s2">2.9</span><span class="s0">,</span>
                    <span class="s2">3.8</span><span class="s0">,</span>
                    <span class="s2">2.2</span><span class="s0">,</span>
                    <span class="s2">2.9</span><span class="s0">,</span>
                    <span class="s2">2.0</span><span class="s0">,</span>
                    <span class="s2">3.2</span><span class="s0">,</span>
                    <span class="s2">1.8</span><span class="s0">,</span>
                    <span class="s2">2.8</span><span class="s0">,</span>
                    <span class="s2">1.9</span><span class="s0">,</span>
                    <span class="s2">2.4</span><span class="s0">,</span>
                    <span class="s2">2.2</span><span class="s0">,</span>
                    <span class="s2">3.3</span><span class="s0">,</span>
                    <span class="s2">2.3</span><span class="s0">,</span>
                    <span class="s2">3.4</span><span class="s0">,</span>
                    <span class="s2">2.1</span><span class="s0">,</span>
                    <span class="s2">2.9</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;famid&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;birth&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;age&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;famid&quot;</span><span class="s0">, </span><span class="s3">&quot;birth&quot;</span><span class="s0">, </span><span class="s3">&quot;age&quot;</span><span class="s1">])[[</span><span class="s3">&quot;ht&quot;</span><span class="s1">]]</span>
        <span class="s1">result = wide_to_long(df</span><span class="s0">, </span><span class="s3">&quot;ht&quot;</span><span class="s0">, </span><span class="s1">i=[</span><span class="s3">&quot;famid&quot;</span><span class="s0">, </span><span class="s3">&quot;birth&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;age&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_non_unique_idvars(self):</span>
        <span class="s4"># GH16382</span>
        <span class="s4"># Raise an error message if non unique id vars (i) are passed</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A_A1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B_B1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">&quot;the id variables need to uniquely identify each row&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A_A&quot;</span><span class="s0">, </span><span class="s3">&quot;B_B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;colname&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_cast_j_int(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;actor_1&quot;</span><span class="s1">: [</span><span class="s3">&quot;CCH Pounder&quot;</span><span class="s0">, </span><span class="s3">&quot;Johnny Depp&quot;</span><span class="s0">, </span><span class="s3">&quot;Christoph Waltz&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;actor_2&quot;</span><span class="s1">: [</span><span class="s3">&quot;Joel David Moore&quot;</span><span class="s0">, </span><span class="s3">&quot;Orlando Bloom&quot;</span><span class="s0">, </span><span class="s3">&quot;Rory Kinnear&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;actor_fb_likes_1&quot;</span><span class="s1">: [</span><span class="s2">1000.0</span><span class="s0">, </span><span class="s2">40000.0</span><span class="s0">, </span><span class="s2">11000.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;actor_fb_likes_2&quot;</span><span class="s1">: [</span><span class="s2">936.0</span><span class="s0">, </span><span class="s2">5000.0</span><span class="s0">, </span><span class="s2">393.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;title&quot;</span><span class="s1">: [</span><span class="s3">&quot;Avatar&quot;</span><span class="s0">, </span><span class="s3">&quot;Pirates of the Caribbean&quot;</span><span class="s0">, </span><span class="s3">&quot;Spectre&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;actor&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;CCH Pounder&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Johnny Depp&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Christoph Waltz&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Joel David Moore&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Orlando Bloom&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Rory Kinnear&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;actor_fb_likes&quot;</span><span class="s1">: [</span><span class="s2">1000.0</span><span class="s0">, </span><span class="s2">40000.0</span><span class="s0">, </span><span class="s2">11000.0</span><span class="s0">, </span><span class="s2">936.0</span><span class="s0">, </span><span class="s2">5000.0</span><span class="s0">, </span><span class="s2">393.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;num&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;title&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;Avatar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Pirates of the Caribbean&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Spectre&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Avatar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Pirates of the Caribbean&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;Spectre&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">).set_index([</span><span class="s3">&quot;title&quot;</span><span class="s0">, </span><span class="s3">&quot;num&quot;</span><span class="s1">])</span>
        <span class="s1">result = wide_to_long(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;actor&quot;</span><span class="s0">, </span><span class="s3">&quot;actor_fb_likes&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;title&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;num&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s3">&quot;_&quot;</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_identical_stubnames(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A2010&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A2011&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B2010&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">&quot;stubname can't be identical to a column name&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">wide_to_long(df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;colname&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_nonnumeric_suffix(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;treatment_placebo&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;treatment_test&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result_placebo&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s0">, </span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;colname&quot;</span><span class="s1">: [</span><span class="s3">&quot;placebo&quot;</span><span class="s0">, </span><span class="s3">&quot;placebo&quot;</span><span class="s0">, </span><span class="s3">&quot;test&quot;</span><span class="s0">, </span><span class="s3">&quot;test&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s3">&quot;treatment&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;colname&quot;</span><span class="s1">])</span>
        <span class="s1">result = wide_to_long(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;result&quot;</span><span class="s0">, </span><span class="s3">&quot;treatment&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;colname&quot;</span><span class="s0">, </span><span class="s1">suffix=</span><span class="s3">&quot;[a-z]+&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s3">&quot;_&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_mixed_type_suffix(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result_1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result_foo&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;treatment_1&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;treatment_foo&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s0">, </span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;colname&quot;</span><span class="s1">: [</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result&quot;</span><span class="s1">: [</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">9.0</span><span class="s0">, </span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;treatment&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">).set_index([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;colname&quot;</span><span class="s1">])</span>
        <span class="s1">result = wide_to_long(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;result&quot;</span><span class="s0">, </span><span class="s3">&quot;treatment&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;colname&quot;</span><span class="s0">, </span><span class="s1">suffix=</span><span class="s3">&quot;.+&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s3">&quot;_&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_float_suffix(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;treatment_1.1&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;treatment_2.1&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result_1.2&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result_1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s0">, </span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s0">, </span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s0">, </span><span class="s3">&quot;X1&quot;</span><span class="s0">, </span><span class="s3">&quot;X2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;colname&quot;</span><span class="s1">: [</span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">2.1</span><span class="s0">, </span><span class="s2">2.1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;result&quot;</span><span class="s1">: [</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">6.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">9.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s3">&quot;treatment&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = expected.set_index([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;colname&quot;</span><span class="s1">])</span>
        <span class="s1">result = wide_to_long(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;result&quot;</span><span class="s0">, </span><span class="s3">&quot;treatment&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;colname&quot;</span><span class="s0">, </span><span class="s1">suffix=</span><span class="s3">&quot;[0-9.]+&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s3">&quot;_&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_col_substring_of_stubname(self):</span>
        <span class="s4"># GH22468</span>
        <span class="s4"># Don't raise ValueError when a column name is a substring</span>
        <span class="s4"># of a stubname that's been passed as a string</span>
        <span class="s1">wide_data = {</span>
            <span class="s3">&quot;node_id&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s2">4</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.80</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.25</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s2">0.81</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;PA0&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.74</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">0.56</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.56</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">0.98</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s2">0.6</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;PA1&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.77</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">0.64</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.52</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">0.98</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s2">0.67</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;PA3&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.34</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">0.70</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">0.52</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">0.98</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s2">0.67</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">wide_df = DataFrame.from_dict(wide_data)</span>
        <span class="s1">expected = wide_to_long(wide_df</span><span class="s0">, </span><span class="s1">stubnames=[</span><span class="s3">&quot;PA&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i=[</span><span class="s3">&quot;node_id&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">result = wide_to_long(wide_df</span><span class="s0">, </span><span class="s1">stubnames=</span><span class="s3">&quot;PA&quot;</span><span class="s0">, </span><span class="s1">i=[</span><span class="s3">&quot;node_id&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">j=</span><span class="s3">&quot;time&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_warn_of_column_name_value(self):</span>
        <span class="s4"># GH34731</span>
        <span class="s4"># raise a warning if the resultant value column name matches</span>
        <span class="s4"># a name in the dataframe already (default name is &quot;value&quot;)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;col&quot;</span><span class="s1">: list(</span><span class="s3">&quot;ABC&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: range(</span><span class="s2">10</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)})</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;value&quot;</span><span class="s0">, </span><span class="s3">&quot;variable&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
            <span class="s1">result = df.melt(id_vars=</span><span class="s3">&quot;value&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>