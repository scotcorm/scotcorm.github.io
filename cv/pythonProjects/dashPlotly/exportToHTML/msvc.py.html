<html>
<head>
<title>msvc.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
msvc.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Improved support for Microsoft Visual C++ compilers. 
 
Known supported compilers: 
-------------------------- 
Microsoft Visual C++ 9.0: 
    Microsoft Visual C++ Compiler for Python 2.7 (x86, amd64) 
    Microsoft Windows SDK 6.1 (x86, x64, ia64) 
    Microsoft Windows SDK 7.0 (x86, x64, ia64) 
 
Microsoft Visual C++ 10.0: 
    Microsoft Windows SDK 7.1 (x86, x64, ia64) 
 
Microsoft Visual C++ 14.X: 
    Microsoft Visual C++ Build Tools 2015 (x86, x64, arm) 
    Microsoft Visual Studio Build Tools 2017 (x86, x64, arm, arm64) 
    Microsoft Visual Studio Build Tools 2019 (x86, x64, arm, arm64) 
 
This may also support compilers shipped with compatible Visual Studio versions. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">json</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">open</span>
<span class="s2">from </span><span class="s1">os </span><span class="s2">import </span><span class="s1">listdir</span><span class="s2">, </span><span class="s1">pathsep</span>
<span class="s2">from </span><span class="s1">os.path </span><span class="s2">import </span><span class="s1">join</span><span class="s2">, </span><span class="s1">isfile</span><span class="s2">, </span><span class="s1">isdir</span><span class="s2">, </span><span class="s1">dirname</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">contextlib</span>
<span class="s2">import </span><span class="s1">platform</span>
<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">subprocess</span>
<span class="s2">import </span><span class="s1">distutils.errors</span>
<span class="s2">from </span><span class="s1">setuptools.extern.packaging.version </span><span class="s2">import </span><span class="s1">LegacyVersion</span>
<span class="s2">from </span><span class="s1">setuptools.extern.more_itertools </span><span class="s2">import </span><span class="s1">unique_everseen</span>

<span class="s2">from </span><span class="s1">.monkey </span><span class="s2">import </span><span class="s1">get_unpatched</span>

<span class="s2">if </span><span class="s1">platform.system() == </span><span class="s3">'Windows'</span><span class="s1">:</span>
    <span class="s2">import </span><span class="s1">winreg</span>
    <span class="s2">from </span><span class="s1">os </span><span class="s2">import </span><span class="s1">environ</span>
<span class="s2">else</span><span class="s1">:</span>
    <span class="s4"># Mock winreg and environ so the module can be imported on this platform.</span>

    <span class="s2">class </span><span class="s1">winreg:</span>
        <span class="s1">HKEY_USERS = </span><span class="s2">None</span>
        <span class="s1">HKEY_CURRENT_USER = </span><span class="s2">None</span>
        <span class="s1">HKEY_LOCAL_MACHINE = </span><span class="s2">None</span>
        <span class="s1">HKEY_CLASSES_ROOT = </span><span class="s2">None</span>

    <span class="s1">environ = dict()</span>

<span class="s1">_msvc9_suppress_errors = (</span>
    <span class="s4"># msvc9compiler isn't available on some platforms</span>
    <span class="s1">ImportError</span><span class="s2">,</span>

    <span class="s4"># msvc9compiler raises DistutilsPlatformError in some</span>
    <span class="s4"># environments. See #1118.</span>
    <span class="s1">distutils.errors.DistutilsPlatformError</span><span class="s2">,</span>
<span class="s1">)</span>

<span class="s2">try</span><span class="s1">:</span>
    <span class="s2">from </span><span class="s1">distutils.msvc9compiler </span><span class="s2">import </span><span class="s1">Reg</span>
<span class="s2">except </span><span class="s1">_msvc9_suppress_errors:</span>
    <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">msvc9_find_vcvarsall(version):</span>
    <span class="s0">&quot;&quot;&quot; 
    Patched &quot;distutils.msvc9compiler.find_vcvarsall&quot; to use the standalone 
    compiler build for Python 
    (VCForPython / Microsoft Visual C++ Compiler for Python 2.7). 
 
    Fall back to original behavior when the standalone compiler is not 
    available. 
 
    Redirect the path of &quot;vcvarsall.bat&quot;. 
 
    Parameters 
    ---------- 
    version: float 
        Required Microsoft Visual C++ version. 
 
    Return 
    ------ 
    str 
        vcvarsall.bat path 
    &quot;&quot;&quot;</span>
    <span class="s1">vc_base = </span><span class="s3">r'Software\%sMicrosoft\DevDiv\VCForPython\%0.1f'</span>
    <span class="s1">key = vc_base % (</span><span class="s3">''</span><span class="s2">, </span><span class="s1">version)</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s4"># Per-user installs register the compiler path here</span>
        <span class="s1">productdir = Reg.get_value(key</span><span class="s2">, </span><span class="s3">&quot;installdir&quot;</span><span class="s1">)</span>
    <span class="s2">except </span><span class="s1">KeyError:</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s4"># All-user installs on a 64-bit system register here</span>
            <span class="s1">key = vc_base % (</span><span class="s3">'Wow6432Node</span><span class="s2">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s1">version)</span>
            <span class="s1">productdir = Reg.get_value(key</span><span class="s2">, </span><span class="s3">&quot;installdir&quot;</span><span class="s1">)</span>
        <span class="s2">except </span><span class="s1">KeyError:</span>
            <span class="s1">productdir = </span><span class="s2">None</span>

    <span class="s2">if </span><span class="s1">productdir:</span>
        <span class="s1">vcvarsall = join(productdir</span><span class="s2">, </span><span class="s3">&quot;vcvarsall.bat&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">isfile(vcvarsall):</span>
            <span class="s2">return </span><span class="s1">vcvarsall</span>

    <span class="s2">return </span><span class="s1">get_unpatched(msvc9_find_vcvarsall)(version)</span>


<span class="s2">def </span><span class="s1">msvc9_query_vcvarsall(ver</span><span class="s2">, </span><span class="s1">arch=</span><span class="s3">'x86'</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
    <span class="s0">&quot;&quot;&quot; 
    Patched &quot;distutils.msvc9compiler.query_vcvarsall&quot; for support extra 
    Microsoft Visual C++ 9.0 and 10.0 compilers. 
 
    Set environment without use of &quot;vcvarsall.bat&quot;. 
 
    Parameters 
    ---------- 
    ver: float 
        Required Microsoft Visual C++ version. 
    arch: str 
        Target architecture. 
 
    Return 
    ------ 
    dict 
        environment 
    &quot;&quot;&quot;</span>
    <span class="s4"># Try to get environment from vcvarsall.bat (Classical way)</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">orig = get_unpatched(msvc9_query_vcvarsall)</span>
        <span class="s2">return </span><span class="s1">orig(ver</span><span class="s2">, </span><span class="s1">arch</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>
    <span class="s2">except </span><span class="s1">distutils.errors.DistutilsPlatformError:</span>
        <span class="s4"># Pass error if Vcvarsall.bat is missing</span>
        <span class="s2">pass</span>
    <span class="s2">except </span><span class="s1">ValueError:</span>
        <span class="s4"># Pass error if environment not set after executing vcvarsall.bat</span>
        <span class="s2">pass</span>

    <span class="s4"># If error, try to set environment directly</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s1">EnvironmentInfo(arch</span><span class="s2">, </span><span class="s1">ver).return_env()</span>
    <span class="s2">except </span><span class="s1">distutils.errors.DistutilsPlatformError </span><span class="s2">as </span><span class="s1">exc:</span>
        <span class="s1">_augment_exception(exc</span><span class="s2">, </span><span class="s1">ver</span><span class="s2">, </span><span class="s1">arch)</span>
        <span class="s2">raise</span>


<span class="s2">def </span><span class="s1">_msvc14_find_vc2015():</span>
    <span class="s0">&quot;&quot;&quot;Python 3.8 &quot;distutils/_msvccompiler.py&quot; backport&quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">key = winreg.OpenKey(</span>
            <span class="s1">winreg.HKEY_LOCAL_MACHINE</span><span class="s2">,</span>
            <span class="s3">r&quot;Software\Microsoft\VisualStudio\SxS\VC7&quot;</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">winreg.KEY_READ | winreg.KEY_WOW64_32KEY</span>
        <span class="s1">)</span>
    <span class="s2">except </span><span class="s1">OSError:</span>
        <span class="s2">return None, None</span>

    <span class="s1">best_version = </span><span class="s5">0</span>
    <span class="s1">best_dir = </span><span class="s2">None</span>
    <span class="s2">with </span><span class="s1">key:</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">itertools.count():</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">v</span><span class="s2">, </span><span class="s1">vc_dir</span><span class="s2">, </span><span class="s1">vt = winreg.EnumValue(key</span><span class="s2">, </span><span class="s1">i)</span>
            <span class="s2">except </span><span class="s1">OSError:</span>
                <span class="s2">break</span>
            <span class="s2">if </span><span class="s1">v </span><span class="s2">and </span><span class="s1">vt == winreg.REG_SZ </span><span class="s2">and </span><span class="s1">isdir(vc_dir):</span>
                <span class="s2">try</span><span class="s1">:</span>
                    <span class="s1">version = int(float(v))</span>
                <span class="s2">except </span><span class="s1">(ValueError</span><span class="s2">, </span><span class="s1">TypeError):</span>
                    <span class="s2">continue</span>
                <span class="s2">if </span><span class="s1">version &gt;= </span><span class="s5">14 </span><span class="s2">and </span><span class="s1">version &gt; best_version:</span>
                    <span class="s1">best_version</span><span class="s2">, </span><span class="s1">best_dir = version</span><span class="s2">, </span><span class="s1">vc_dir</span>
    <span class="s2">return </span><span class="s1">best_version</span><span class="s2">, </span><span class="s1">best_dir</span>


<span class="s2">def </span><span class="s1">_msvc14_find_vc2017():</span>
    <span class="s0">&quot;&quot;&quot;Python 3.8 &quot;distutils/_msvccompiler.py&quot; backport 
 
    Returns &quot;15, path&quot; based on the result of invoking vswhere.exe 
    If no install is found, returns &quot;None, None&quot; 
 
    The version is returned to avoid unnecessarily changing the function 
    result. It may be ignored when the path is not None. 
 
    If vswhere.exe is not available, by definition, VS 2017 is not 
    installed. 
    &quot;&quot;&quot;</span>
    <span class="s1">root = environ.get(</span><span class="s3">&quot;ProgramFiles(x86)&quot;</span><span class="s1">) </span><span class="s2">or </span><span class="s1">environ.get(</span><span class="s3">&quot;ProgramFiles&quot;</span><span class="s1">)</span>
    <span class="s2">if not </span><span class="s1">root:</span>
        <span class="s2">return None, None</span>

    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">path = subprocess.check_output([</span>
            <span class="s1">join(root</span><span class="s2">, </span><span class="s3">&quot;Microsoft Visual Studio&quot;</span><span class="s2">, </span><span class="s3">&quot;Installer&quot;</span><span class="s2">, </span><span class="s3">&quot;vswhere.exe&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s3">&quot;-latest&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-prerelease&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-requiresAny&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-requires&quot;</span><span class="s2">, </span><span class="s3">&quot;Microsoft.VisualStudio.Component.VC.Tools.x86.x64&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-requires&quot;</span><span class="s2">, </span><span class="s3">&quot;Microsoft.VisualStudio.Workload.WDExpress&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-property&quot;</span><span class="s2">, </span><span class="s3">&quot;installationPath&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;-products&quot;</span><span class="s2">, </span><span class="s3">&quot;*&quot;</span><span class="s2">,</span>
        <span class="s1">]).decode(encoding=</span><span class="s3">&quot;mbcs&quot;</span><span class="s2">, </span><span class="s1">errors=</span><span class="s3">&quot;strict&quot;</span><span class="s1">).strip()</span>
    <span class="s2">except </span><span class="s1">(subprocess.CalledProcessError</span><span class="s2">, </span><span class="s1">OSError</span><span class="s2">, </span><span class="s1">UnicodeDecodeError):</span>
        <span class="s2">return None, None</span>

    <span class="s1">path = join(path</span><span class="s2">, </span><span class="s3">&quot;VC&quot;</span><span class="s2">, </span><span class="s3">&quot;Auxiliary&quot;</span><span class="s2">, </span><span class="s3">&quot;Build&quot;</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">isdir(path):</span>
        <span class="s2">return </span><span class="s5">15</span><span class="s2">, </span><span class="s1">path</span>

    <span class="s2">return None, None</span>


<span class="s1">PLAT_SPEC_TO_RUNTIME = {</span>
    <span class="s3">'x86'</span><span class="s1">: </span><span class="s3">'x86'</span><span class="s2">,</span>
    <span class="s3">'x86_amd64'</span><span class="s1">: </span><span class="s3">'x64'</span><span class="s2">,</span>
    <span class="s3">'x86_arm'</span><span class="s1">: </span><span class="s3">'arm'</span><span class="s2">,</span>
    <span class="s3">'x86_arm64'</span><span class="s1">: </span><span class="s3">'arm64'</span>
<span class="s1">}</span>


<span class="s2">def </span><span class="s1">_msvc14_find_vcvarsall(plat_spec):</span>
    <span class="s0">&quot;&quot;&quot;Python 3.8 &quot;distutils/_msvccompiler.py&quot; backport&quot;&quot;&quot;</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">best_dir = _msvc14_find_vc2017()</span>
    <span class="s1">vcruntime = </span><span class="s2">None</span>

    <span class="s2">if </span><span class="s1">plat_spec </span><span class="s2">in </span><span class="s1">PLAT_SPEC_TO_RUNTIME:</span>
        <span class="s1">vcruntime_plat = PLAT_SPEC_TO_RUNTIME[plat_spec]</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">vcruntime_plat = </span><span class="s3">'x64' </span><span class="s2">if </span><span class="s3">'amd64' </span><span class="s2">in </span><span class="s1">plat_spec </span><span class="s2">else </span><span class="s3">'x86'</span>

    <span class="s2">if </span><span class="s1">best_dir:</span>
        <span class="s1">vcredist = join(best_dir</span><span class="s2">, </span><span class="s3">&quot;..&quot;</span><span class="s2">, </span><span class="s3">&quot;..&quot;</span><span class="s2">, </span><span class="s3">&quot;redist&quot;</span><span class="s2">, </span><span class="s3">&quot;MSVC&quot;</span><span class="s2">, </span><span class="s3">&quot;**&quot;</span><span class="s2">,</span>
                        <span class="s1">vcruntime_plat</span><span class="s2">, </span><span class="s3">&quot;Microsoft.VC14*.CRT&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;vcruntime140.dll&quot;</span><span class="s1">)</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s2">import </span><span class="s1">glob</span>
            <span class="s1">vcruntime = glob.glob(vcredist</span><span class="s2">, </span><span class="s1">recursive=</span><span class="s2">True</span><span class="s1">)[-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s2">except </span><span class="s1">(ImportError</span><span class="s2">, </span><span class="s1">OSError</span><span class="s2">, </span><span class="s1">LookupError):</span>
            <span class="s1">vcruntime = </span><span class="s2">None</span>

    <span class="s2">if not </span><span class="s1">best_dir:</span>
        <span class="s1">best_version</span><span class="s2">, </span><span class="s1">best_dir = _msvc14_find_vc2015()</span>
        <span class="s2">if </span><span class="s1">best_version:</span>
            <span class="s1">vcruntime = join(best_dir</span><span class="s2">, </span><span class="s3">'redist'</span><span class="s2">, </span><span class="s1">vcruntime_plat</span><span class="s2">,</span>
                             <span class="s3">&quot;Microsoft.VC140.CRT&quot;</span><span class="s2">, </span><span class="s3">&quot;vcruntime140.dll&quot;</span><span class="s1">)</span>

    <span class="s2">if not </span><span class="s1">best_dir:</span>
        <span class="s2">return None, None</span>

    <span class="s1">vcvarsall = join(best_dir</span><span class="s2">, </span><span class="s3">&quot;vcvarsall.bat&quot;</span><span class="s1">)</span>
    <span class="s2">if not </span><span class="s1">isfile(vcvarsall):</span>
        <span class="s2">return None, None</span>

    <span class="s2">if not </span><span class="s1">vcruntime </span><span class="s2">or not </span><span class="s1">isfile(vcruntime):</span>
        <span class="s1">vcruntime = </span><span class="s2">None</span>

    <span class="s2">return </span><span class="s1">vcvarsall</span><span class="s2">, </span><span class="s1">vcruntime</span>


<span class="s2">def </span><span class="s1">_msvc14_get_vc_env(plat_spec):</span>
    <span class="s0">&quot;&quot;&quot;Python 3.8 &quot;distutils/_msvccompiler.py&quot; backport&quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s3">&quot;DISTUTILS_USE_SDK&quot; </span><span class="s2">in </span><span class="s1">environ:</span>
        <span class="s2">return </span><span class="s1">{</span>
            <span class="s1">key.lower(): value</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">environ.items()</span>
        <span class="s1">}</span>

    <span class="s1">vcvarsall</span><span class="s2">, </span><span class="s1">vcruntime = _msvc14_find_vcvarsall(plat_spec)</span>
    <span class="s2">if not </span><span class="s1">vcvarsall:</span>
        <span class="s2">raise </span><span class="s1">distutils.errors.DistutilsPlatformError(</span>
            <span class="s3">&quot;Unable to find vcvarsall.bat&quot;</span>
        <span class="s1">)</span>

    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">out = subprocess.check_output(</span>
            <span class="s3">'cmd /u /c &quot;{}&quot; {} &amp;&amp; set'</span><span class="s1">.format(vcvarsall</span><span class="s2">, </span><span class="s1">plat_spec)</span><span class="s2">,</span>
            <span class="s1">stderr=subprocess.STDOUT</span><span class="s2">,</span>
        <span class="s1">).decode(</span><span class="s3">'utf-16le'</span><span class="s2">, </span><span class="s1">errors=</span><span class="s3">'replace'</span><span class="s1">)</span>
    <span class="s2">except </span><span class="s1">subprocess.CalledProcessError </span><span class="s2">as </span><span class="s1">exc:</span>
        <span class="s2">raise </span><span class="s1">distutils.errors.DistutilsPlatformError(</span>
            <span class="s3">&quot;Error executing {}&quot;</span><span class="s1">.format(exc.cmd)</span>
        <span class="s1">) </span><span class="s2">from </span><span class="s1">exc</span>

    <span class="s1">env = {</span>
        <span class="s1">key.lower(): value</span>
        <span class="s2">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in</span>
        <span class="s1">(line.partition(</span><span class="s3">'='</span><span class="s1">) </span><span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">out.splitlines())</span>
        <span class="s2">if </span><span class="s1">key </span><span class="s2">and </span><span class="s1">value</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">vcruntime:</span>
        <span class="s1">env[</span><span class="s3">'py_vcruntime_redist'</span><span class="s1">] = vcruntime</span>
    <span class="s2">return </span><span class="s1">env</span>


<span class="s2">def </span><span class="s1">msvc14_get_vc_env(plat_spec):</span>
    <span class="s0">&quot;&quot;&quot; 
    Patched &quot;distutils._msvccompiler._get_vc_env&quot; for support extra 
    Microsoft Visual C++ 14.X compilers. 
 
    Set environment without use of &quot;vcvarsall.bat&quot;. 
 
    Parameters 
    ---------- 
    plat_spec: str 
        Target architecture. 
 
    Return 
    ------ 
    dict 
        environment 
    &quot;&quot;&quot;</span>

    <span class="s4"># Always use backport from CPython 3.8</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s1">_msvc14_get_vc_env(plat_spec)</span>
    <span class="s2">except </span><span class="s1">distutils.errors.DistutilsPlatformError </span><span class="s2">as </span><span class="s1">exc:</span>
        <span class="s1">_augment_exception(exc</span><span class="s2">, </span><span class="s5">14.0</span><span class="s1">)</span>
        <span class="s2">raise</span>


<span class="s2">def </span><span class="s1">msvc14_gen_lib_options(*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
    <span class="s0">&quot;&quot;&quot; 
    Patched &quot;distutils._msvccompiler.gen_lib_options&quot; for fix 
    compatibility between &quot;numpy.distutils&quot; and &quot;distutils._msvccompiler&quot; 
    (for Numpy &lt; 1.11.2) 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s3">&quot;numpy.distutils&quot; </span><span class="s2">in </span><span class="s1">sys.modules:</span>
        <span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
        <span class="s2">if </span><span class="s1">LegacyVersion(np.__version__) &lt; LegacyVersion(</span><span class="s3">'1.11.2'</span><span class="s1">):</span>
            <span class="s2">return </span><span class="s1">np.distutils.ccompiler.gen_lib_options(*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>
    <span class="s2">return </span><span class="s1">get_unpatched(msvc14_gen_lib_options)(*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>


<span class="s2">def </span><span class="s1">_augment_exception(exc</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">arch=</span><span class="s3">''</span><span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Add details to the exception message to help guide the user 
    as to what action will resolve it. 
    &quot;&quot;&quot;</span>
    <span class="s4"># Error if MSVC++ directory not found or environment not set</span>
    <span class="s1">message = exc.args[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s2">if </span><span class="s3">&quot;vcvarsall&quot; </span><span class="s2">in </span><span class="s1">message.lower() </span><span class="s2">or </span><span class="s3">&quot;visual c&quot; </span><span class="s2">in </span><span class="s1">message.lower():</span>
        <span class="s4"># Special error message if MSVC++ not installed</span>
        <span class="s1">tmpl = </span><span class="s3">'Microsoft Visual C++ {version:0.1f} or greater is required.'</span>
        <span class="s1">message = tmpl.format(**locals())</span>
        <span class="s1">msdownload = </span><span class="s3">'www.microsoft.com/download/details.aspx?id=%d'</span>
        <span class="s2">if </span><span class="s1">version == </span><span class="s5">9.0</span><span class="s1">:</span>
            <span class="s2">if </span><span class="s1">arch.lower().find(</span><span class="s3">'ia64'</span><span class="s1">) &gt; -</span><span class="s5">1</span><span class="s1">:</span>
                <span class="s4"># For VC++ 9.0, if IA64 support is needed, redirect user</span>
                <span class="s4"># to Windows SDK 7.0.</span>
                <span class="s4"># Note: No download link available from Microsoft.</span>
                <span class="s1">message += </span><span class="s3">' Get it with &quot;Microsoft Windows SDK 7.0&quot;'</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s4"># For VC++ 9.0 redirect user to Vc++ for Python 2.7 :</span>
                <span class="s4"># This redirection link is maintained by Microsoft.</span>
                <span class="s4"># Contact vspython@microsoft.com if it needs updating.</span>
                <span class="s1">message += </span><span class="s3">' Get it from http://aka.ms/vcpython27'</span>
        <span class="s2">elif </span><span class="s1">version == </span><span class="s5">10.0</span><span class="s1">:</span>
            <span class="s4"># For VC++ 10.0 Redirect user to Windows SDK 7.1</span>
            <span class="s1">message += </span><span class="s3">' Get it with &quot;Microsoft Windows SDK 7.1&quot;: '</span>
            <span class="s1">message += msdownload % </span><span class="s5">8279</span>
        <span class="s2">elif </span><span class="s1">version &gt;= </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s4"># For VC++ 14.X Redirect user to latest Visual C++ Build Tools</span>
            <span class="s1">message += (</span><span class="s3">' Get it with &quot;Microsoft C++ Build Tools&quot;: '</span>
                        <span class="s3">r'https://visualstudio.microsoft.com'</span>
                        <span class="s3">r'/visual-cpp-build-tools/'</span><span class="s1">)</span>

    <span class="s1">exc.args = (message</span><span class="s2">, </span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">PlatformInfo:</span>
    <span class="s0">&quot;&quot;&quot; 
    Current and Target Architectures information. 
 
    Parameters 
    ---------- 
    arch: str 
        Target architecture. 
    &quot;&quot;&quot;</span>
    <span class="s1">current_cpu = environ.get(</span><span class="s3">'processor_architecture'</span><span class="s2">, </span><span class="s3">''</span><span class="s1">).lower()</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">arch):</span>
        <span class="s1">self.arch = arch.lower().replace(</span><span class="s3">'x64'</span><span class="s2">, </span><span class="s3">'amd64'</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">target_cpu(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return Target CPU architecture. 
 
        Return 
        ------ 
        str 
            Target CPU 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self.arch[self.arch.find(</span><span class="s3">'_'</span><span class="s1">) + </span><span class="s5">1</span><span class="s1">:]</span>

    <span class="s2">def </span><span class="s1">target_is_x86(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return True if target CPU is x86 32 bits.. 
 
        Return 
        ------ 
        bool 
            CPU is x86 32 bits 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self.target_cpu == </span><span class="s3">'x86'</span>

    <span class="s2">def </span><span class="s1">current_is_x86(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return True if current CPU is x86 32 bits.. 
 
        Return 
        ------ 
        bool 
            CPU is x86 32 bits 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self.current_cpu == </span><span class="s3">'x86'</span>

    <span class="s2">def </span><span class="s1">current_dir(self</span><span class="s2">, </span><span class="s1">hidex86=</span><span class="s2">False, </span><span class="s1">x64=</span><span class="s2">False</span><span class="s1">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Current platform specific subfolder. 
 
        Parameters 
        ---------- 
        hidex86: bool 
            return '' and not '\x86' if architecture is x86. 
        x64: bool 
            return '\x64' and not '\amd64' if architecture is amd64. 
 
        Return 
        ------ 
        str 
            subfolder: '\target', or '' (see hidex86 parameter) 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">(</span>
            <span class="s3">'' </span><span class="s2">if </span><span class="s1">(self.current_cpu == </span><span class="s3">'x86' </span><span class="s2">and </span><span class="s1">hidex86) </span><span class="s2">else</span>
            <span class="s3">r'\x64' </span><span class="s2">if </span><span class="s1">(self.current_cpu == </span><span class="s3">'amd64' </span><span class="s2">and </span><span class="s1">x64) </span><span class="s2">else</span>
            <span class="s3">r'\%s' </span><span class="s1">% self.current_cpu</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">target_dir(self</span><span class="s2">, </span><span class="s1">hidex86=</span><span class="s2">False, </span><span class="s1">x64=</span><span class="s2">False</span><span class="s1">):</span>
        <span class="s0">r&quot;&quot;&quot; 
        Target platform specific subfolder. 
 
        Parameters 
        ---------- 
        hidex86: bool 
            return '' and not '\x86' if architecture is x86. 
        x64: bool 
            return '\x64' and not '\amd64' if architecture is amd64. 
 
        Return 
        ------ 
        str 
            subfolder: '\current', or '' (see hidex86 parameter) 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">(</span>
            <span class="s3">'' </span><span class="s2">if </span><span class="s1">(self.target_cpu == </span><span class="s3">'x86' </span><span class="s2">and </span><span class="s1">hidex86) </span><span class="s2">else</span>
            <span class="s3">r'\x64' </span><span class="s2">if </span><span class="s1">(self.target_cpu == </span><span class="s3">'amd64' </span><span class="s2">and </span><span class="s1">x64) </span><span class="s2">else</span>
            <span class="s3">r'\%s' </span><span class="s1">% self.target_cpu</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">cross_dir(self</span><span class="s2">, </span><span class="s1">forcex86=</span><span class="s2">False</span><span class="s1">):</span>
        <span class="s0">r&quot;&quot;&quot; 
        Cross platform specific subfolder. 
 
        Parameters 
        ---------- 
        forcex86: bool 
            Use 'x86' as current architecture even if current architecture is 
            not x86. 
 
        Return 
        ------ 
        str 
            subfolder: '' if target architecture is current architecture, 
            '\current_target' if not. 
        &quot;&quot;&quot;</span>
        <span class="s1">current = </span><span class="s3">'x86' </span><span class="s2">if </span><span class="s1">forcex86 </span><span class="s2">else </span><span class="s1">self.current_cpu</span>
        <span class="s2">return </span><span class="s1">(</span>
            <span class="s3">'' </span><span class="s2">if </span><span class="s1">self.target_cpu == current </span><span class="s2">else</span>
            <span class="s1">self.target_dir().replace(</span><span class="s3">'</span><span class="s2">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s3">'</span><span class="s2">\\</span><span class="s3">%s_' </span><span class="s1">% current)</span>
        <span class="s1">)</span>


<span class="s2">class </span><span class="s1">RegistryInfo:</span>
    <span class="s0">&quot;&quot;&quot; 
    Microsoft Visual Studio related registry information. 
 
    Parameters 
    ---------- 
    platform_info: PlatformInfo 
        &quot;PlatformInfo&quot; instance. 
    &quot;&quot;&quot;</span>
    <span class="s1">HKEYS = (winreg.HKEY_USERS</span><span class="s2">,</span>
             <span class="s1">winreg.HKEY_CURRENT_USER</span><span class="s2">,</span>
             <span class="s1">winreg.HKEY_LOCAL_MACHINE</span><span class="s2">,</span>
             <span class="s1">winreg.HKEY_CLASSES_ROOT)</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">platform_info):</span>
        <span class="s1">self.pi = platform_info</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">visualstudio(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual Studio root registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s3">'VisualStudio'</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">sxs(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual Studio SxS registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">join(self.visualstudio</span><span class="s2">, </span><span class="s3">'SxS'</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">vc(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ VC7 registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">join(self.sxs</span><span class="s2">, </span><span class="s3">'VC7'</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">vs(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual Studio VS7 registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">join(self.sxs</span><span class="s2">, </span><span class="s3">'VS7'</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">vc_for_python(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ for Python registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s3">r'DevDiv\VCForPython'</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">microsoft_sdk(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft SDK registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s3">'Microsoft SDKs'</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">windows_sdk(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows/Platform SDK registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">join(self.microsoft_sdk</span><span class="s2">, </span><span class="s3">'Windows'</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">netfx_sdk(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework SDK registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">join(self.microsoft_sdk</span><span class="s2">, </span><span class="s3">'NETFXSDK'</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">windows_kits_roots(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows Kits Roots registry key. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s3">r'Windows Kits\Installed Roots'</span>

    <span class="s2">def </span><span class="s1">microsoft(self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">x86=</span><span class="s2">False</span><span class="s1">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return key in Microsoft software registry. 
 
        Parameters 
        ---------- 
        key: str 
            Registry key path where look. 
        x86: str 
            Force x86 software registry. 
 
        Return 
        ------ 
        str 
            Registry key 
        &quot;&quot;&quot;</span>
        <span class="s1">node64 = </span><span class="s3">'' </span><span class="s2">if </span><span class="s1">self.pi.current_is_x86() </span><span class="s2">or </span><span class="s1">x86 </span><span class="s2">else </span><span class="s3">'Wow6432Node'</span>
        <span class="s2">return </span><span class="s1">join(</span><span class="s3">'Software'</span><span class="s2">, </span><span class="s1">node64</span><span class="s2">, </span><span class="s3">'Microsoft'</span><span class="s2">, </span><span class="s1">key)</span>

    <span class="s2">def </span><span class="s1">lookup(self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">name):</span>
        <span class="s0">&quot;&quot;&quot; 
        Look for values in registry in Microsoft software registry. 
 
        Parameters 
        ---------- 
        key: str 
            Registry key path where look. 
        name: str 
            Value name to find. 
 
        Return 
        ------ 
        str 
            value 
        &quot;&quot;&quot;</span>
        <span class="s1">key_read = winreg.KEY_READ</span>
        <span class="s1">openkey = winreg.OpenKey</span>
        <span class="s1">closekey = winreg.CloseKey</span>
        <span class="s1">ms = self.microsoft</span>
        <span class="s2">for </span><span class="s1">hkey </span><span class="s2">in </span><span class="s1">self.HKEYS:</span>
            <span class="s1">bkey = </span><span class="s2">None</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">bkey = openkey(hkey</span><span class="s2">, </span><span class="s1">ms(key)</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">key_read)</span>
            <span class="s2">except </span><span class="s1">(OSError</span><span class="s2">, </span><span class="s1">IOError):</span>
                <span class="s2">if not </span><span class="s1">self.pi.current_is_x86():</span>
                    <span class="s2">try</span><span class="s1">:</span>
                        <span class="s1">bkey = openkey(hkey</span><span class="s2">, </span><span class="s1">ms(key</span><span class="s2">, True</span><span class="s1">)</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">key_read)</span>
                    <span class="s2">except </span><span class="s1">(OSError</span><span class="s2">, </span><span class="s1">IOError):</span>
                        <span class="s2">continue</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s2">continue</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">winreg.QueryValueEx(bkey</span><span class="s2">, </span><span class="s1">name)[</span><span class="s5">0</span><span class="s1">]</span>
            <span class="s2">except </span><span class="s1">(OSError</span><span class="s2">, </span><span class="s1">IOError):</span>
                <span class="s2">pass</span>
            <span class="s2">finally</span><span class="s1">:</span>
                <span class="s2">if </span><span class="s1">bkey:</span>
                    <span class="s1">closekey(bkey)</span>


<span class="s2">class </span><span class="s1">SystemInfo:</span>
    <span class="s0">&quot;&quot;&quot; 
    Microsoft Windows and Visual Studio related system information. 
 
    Parameters 
    ---------- 
    registry_info: RegistryInfo 
        &quot;RegistryInfo&quot; instance. 
    vc_ver: float 
        Required Microsoft Visual C++ version. 
    &quot;&quot;&quot;</span>

    <span class="s4"># Variables and properties in this class use originals CamelCase variables</span>
    <span class="s4"># names from Microsoft source files for more easy comparison.</span>
    <span class="s1">WinDir = environ.get(</span><span class="s3">'WinDir'</span><span class="s2">, </span><span class="s3">''</span><span class="s1">)</span>
    <span class="s1">ProgramFiles = environ.get(</span><span class="s3">'ProgramFiles'</span><span class="s2">, </span><span class="s3">''</span><span class="s1">)</span>
    <span class="s1">ProgramFilesx86 = environ.get(</span><span class="s3">'ProgramFiles(x86)'</span><span class="s2">, </span><span class="s1">ProgramFiles)</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">registry_info</span><span class="s2">, </span><span class="s1">vc_ver=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">self.ri = registry_info</span>
        <span class="s1">self.pi = self.ri.pi</span>

        <span class="s1">self.known_vs_paths = self.find_programdata_vs_vers()</span>

        <span class="s4"># Except for VS15+, VC version is aligned with VS version</span>
        <span class="s1">self.vs_ver = self.vc_ver = (</span>
            <span class="s1">vc_ver </span><span class="s2">or </span><span class="s1">self._find_latest_available_vs_ver())</span>

    <span class="s2">def </span><span class="s1">_find_latest_available_vs_ver(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Find the latest VC version 
 
        Return 
        ------ 
        float 
            version 
        &quot;&quot;&quot;</span>
        <span class="s1">reg_vc_vers = self.find_reg_vs_vers()</span>

        <span class="s2">if not </span><span class="s1">(reg_vc_vers </span><span class="s2">or </span><span class="s1">self.known_vs_paths):</span>
            <span class="s2">raise </span><span class="s1">distutils.errors.DistutilsPlatformError(</span>
                <span class="s3">'No Microsoft Visual C++ version found'</span><span class="s1">)</span>

        <span class="s1">vc_vers = set(reg_vc_vers)</span>
        <span class="s1">vc_vers.update(self.known_vs_paths)</span>
        <span class="s2">return </span><span class="s1">sorted(vc_vers)[-</span><span class="s5">1</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">find_reg_vs_vers(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Find Microsoft Visual Studio versions available in registry. 
 
        Return 
        ------ 
        list of float 
            Versions 
        &quot;&quot;&quot;</span>
        <span class="s1">ms = self.ri.microsoft</span>
        <span class="s1">vckeys = (self.ri.vc</span><span class="s2">, </span><span class="s1">self.ri.vc_for_python</span><span class="s2">, </span><span class="s1">self.ri.vs)</span>
        <span class="s1">vs_vers = []</span>
        <span class="s2">for </span><span class="s1">hkey</span><span class="s2">, </span><span class="s1">key </span><span class="s2">in </span><span class="s1">itertools.product(self.ri.HKEYS</span><span class="s2">, </span><span class="s1">vckeys):</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">bkey = winreg.OpenKey(hkey</span><span class="s2">, </span><span class="s1">ms(key)</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">winreg.KEY_READ)</span>
            <span class="s2">except </span><span class="s1">(OSError</span><span class="s2">, </span><span class="s1">IOError):</span>
                <span class="s2">continue</span>
            <span class="s2">with </span><span class="s1">bkey:</span>
                <span class="s1">subkeys</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">_ = winreg.QueryInfoKey(bkey)</span>
                <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(values):</span>
                    <span class="s2">with </span><span class="s1">contextlib.suppress(ValueError):</span>
                        <span class="s1">ver = float(winreg.EnumValue(bkey</span><span class="s2">, </span><span class="s1">i)[</span><span class="s5">0</span><span class="s1">])</span>
                        <span class="s2">if </span><span class="s1">ver </span><span class="s2">not in </span><span class="s1">vs_vers:</span>
                            <span class="s1">vs_vers.append(ver)</span>
                <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(subkeys):</span>
                    <span class="s2">with </span><span class="s1">contextlib.suppress(ValueError):</span>
                        <span class="s1">ver = float(winreg.EnumKey(bkey</span><span class="s2">, </span><span class="s1">i))</span>
                        <span class="s2">if </span><span class="s1">ver </span><span class="s2">not in </span><span class="s1">vs_vers:</span>
                            <span class="s1">vs_vers.append(ver)</span>
        <span class="s2">return </span><span class="s1">sorted(vs_vers)</span>

    <span class="s2">def </span><span class="s1">find_programdata_vs_vers(self):</span>
        <span class="s0">r&quot;&quot;&quot; 
        Find Visual studio 2017+ versions from information in 
        &quot;C:\ProgramData\Microsoft\VisualStudio\Packages\_Instances&quot;. 
 
        Return 
        ------ 
        dict 
            float version as key, path as value. 
        &quot;&quot;&quot;</span>
        <span class="s1">vs_versions = {}</span>
        <span class="s1">instances_dir = \</span>
            <span class="s3">r'C:\ProgramData\Microsoft\VisualStudio\Packages\_Instances'</span>

        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">hashed_names = listdir(instances_dir)</span>

        <span class="s2">except </span><span class="s1">(OSError</span><span class="s2">, </span><span class="s1">IOError):</span>
            <span class="s4"># Directory not exists with all Visual Studio versions</span>
            <span class="s2">return </span><span class="s1">vs_versions</span>

        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">hashed_names:</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s4"># Get VS installation path from &quot;state.json&quot; file</span>
                <span class="s1">state_path = join(instances_dir</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s3">'state.json'</span><span class="s1">)</span>
                <span class="s2">with </span><span class="s1">open(state_path</span><span class="s2">, </span><span class="s3">'rt'</span><span class="s2">, </span><span class="s1">encoding=</span><span class="s3">'utf-8'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">state_file:</span>
                    <span class="s1">state = json.load(state_file)</span>
                <span class="s1">vs_path = state[</span><span class="s3">'installationPath'</span><span class="s1">]</span>

                <span class="s4"># Raises OSError if this VS installation does not contain VC</span>
                <span class="s1">listdir(join(vs_path</span><span class="s2">, </span><span class="s3">r'VC\Tools\MSVC'</span><span class="s1">))</span>

                <span class="s4"># Store version and path</span>
                <span class="s1">vs_versions[self._as_float_version(</span>
                    <span class="s1">state[</span><span class="s3">'installationVersion'</span><span class="s1">])] = vs_path</span>

            <span class="s2">except </span><span class="s1">(OSError</span><span class="s2">, </span><span class="s1">IOError</span><span class="s2">, </span><span class="s1">KeyError):</span>
                <span class="s4"># Skip if &quot;state.json&quot; file is missing or bad format</span>
                <span class="s2">continue</span>

        <span class="s2">return </span><span class="s1">vs_versions</span>

    <span class="s1">@staticmethod</span>
    <span class="s2">def </span><span class="s1">_as_float_version(version):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return a string version as a simplified float version (major.minor) 
 
        Parameters 
        ---------- 
        version: str 
            Version. 
 
        Return 
        ------ 
        float 
            version 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">float(</span><span class="s3">'.'</span><span class="s1">.join(version.split(</span><span class="s3">'.'</span><span class="s1">)[:</span><span class="s5">2</span><span class="s1">]))</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VSInstallDir(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual Studio directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s4"># Default path</span>
        <span class="s1">default = join(self.ProgramFilesx86</span><span class="s2">,</span>
                       <span class="s3">'Microsoft Visual Studio %0.1f' </span><span class="s1">% self.vs_ver)</span>

        <span class="s4"># Try to get path from registry, if fail use default path</span>
        <span class="s2">return </span><span class="s1">self.ri.lookup(self.ri.vs</span><span class="s2">, </span><span class="s3">'%0.1f' </span><span class="s1">% self.vs_ver) </span><span class="s2">or </span><span class="s1">default</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VCInstallDir(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s1">path = self._guess_vc() </span><span class="s2">or </span><span class="s1">self._guess_vc_legacy()</span>

        <span class="s2">if not </span><span class="s1">isdir(path):</span>
            <span class="s1">msg = </span><span class="s3">'Microsoft Visual C++ directory not found'</span>
            <span class="s2">raise </span><span class="s1">distutils.errors.DistutilsPlatformError(msg)</span>

        <span class="s2">return </span><span class="s1">path</span>

    <span class="s2">def </span><span class="s1">_guess_vc(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Locate Visual C++ for VS2017+. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">''</span>

        <span class="s2">try</span><span class="s1">:</span>
            <span class="s4"># First search in known VS paths</span>
            <span class="s1">vs_dir = self.known_vs_paths[self.vs_ver]</span>
        <span class="s2">except </span><span class="s1">KeyError:</span>
            <span class="s4"># Else, search with path from registry</span>
            <span class="s1">vs_dir = self.VSInstallDir</span>

        <span class="s1">guess_vc = join(vs_dir</span><span class="s2">, </span><span class="s3">r'VC\Tools\MSVC'</span><span class="s1">)</span>

        <span class="s4"># Subdir with VC exact version as name</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s4"># Update the VC version with real one instead of VS version</span>
            <span class="s1">vc_ver = listdir(guess_vc)[-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.vc_ver = self._as_float_version(vc_ver)</span>
            <span class="s2">return </span><span class="s1">join(guess_vc</span><span class="s2">, </span><span class="s1">vc_ver)</span>
        <span class="s2">except </span><span class="s1">(OSError</span><span class="s2">, </span><span class="s1">IOError</span><span class="s2">, </span><span class="s1">IndexError):</span>
            <span class="s2">return </span><span class="s3">''</span>

    <span class="s2">def </span><span class="s1">_guess_vc_legacy(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Locate Visual C++ for versions prior to 2017. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s1">default = join(self.ProgramFilesx86</span><span class="s2">,</span>
                       <span class="s3">r'Microsoft Visual Studio %0.1f\VC' </span><span class="s1">% self.vs_ver)</span>

        <span class="s4"># Try to get &quot;VC++ for Python&quot; path from registry as default path</span>
        <span class="s1">reg_path = join(self.ri.vc_for_python</span><span class="s2">, </span><span class="s3">'%0.1f' </span><span class="s1">% self.vs_ver)</span>
        <span class="s1">python_vc = self.ri.lookup(reg_path</span><span class="s2">, </span><span class="s3">'installdir'</span><span class="s1">)</span>
        <span class="s1">default_vc = join(python_vc</span><span class="s2">, </span><span class="s3">'VC'</span><span class="s1">) </span><span class="s2">if </span><span class="s1">python_vc </span><span class="s2">else </span><span class="s1">default</span>

        <span class="s4"># Try to get path from registry, if fail use default path</span>
        <span class="s2">return </span><span class="s1">self.ri.lookup(self.ri.vc</span><span class="s2">, </span><span class="s3">'%0.1f' </span><span class="s1">% self.vs_ver) </span><span class="s2">or </span><span class="s1">default_vc</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">WindowsSdkVersion(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK versions for specified MSVC++ version. 
 
        Return 
        ------ 
        tuple of str 
            versions 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">9.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'7.0'</span><span class="s2">, </span><span class="s3">'6.1'</span><span class="s2">, </span><span class="s3">'6.0a'</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver == </span><span class="s5">10.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'7.1'</span><span class="s2">, </span><span class="s3">'7.0a'</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver == </span><span class="s5">11.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'8.0'</span><span class="s2">, </span><span class="s3">'8.0a'</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver == </span><span class="s5">12.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'8.1'</span><span class="s2">, </span><span class="s3">'8.1a'</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'10.0'</span><span class="s2">, </span><span class="s3">'8.1'</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">WindowsSdkLastVersion(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK last version. 
 
        Return 
        ------ 
        str 
            version 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self._use_last_dir_name(join(self.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'lib'</span><span class="s1">))</span>

    <span class="s1">@property  </span><span class="s4"># noqa: C901</span>
    <span class="s2">def </span><span class="s1">WindowsSdkDir(self):  </span><span class="s4"># noqa: C901  # is too complex (12)  # FIXME</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s1">sdkdir = </span><span class="s3">''</span>
        <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">self.WindowsSdkVersion:</span>
            <span class="s4"># Try to get it from registry</span>
            <span class="s1">loc = join(self.ri.windows_sdk</span><span class="s2">, </span><span class="s3">'v%s' </span><span class="s1">% ver)</span>
            <span class="s1">sdkdir = self.ri.lookup(loc</span><span class="s2">, </span><span class="s3">'installationfolder'</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">sdkdir:</span>
                <span class="s2">break</span>
        <span class="s2">if not </span><span class="s1">sdkdir </span><span class="s2">or not </span><span class="s1">isdir(sdkdir):</span>
            <span class="s4"># Try to get &quot;VC++ for Python&quot; version from registry</span>
            <span class="s1">path = join(self.ri.vc_for_python</span><span class="s2">, </span><span class="s3">'%0.1f' </span><span class="s1">% self.vc_ver)</span>
            <span class="s1">install_base = self.ri.lookup(path</span><span class="s2">, </span><span class="s3">'installdir'</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">install_base:</span>
                <span class="s1">sdkdir = join(install_base</span><span class="s2">, </span><span class="s3">'WinSDK'</span><span class="s1">)</span>
        <span class="s2">if not </span><span class="s1">sdkdir </span><span class="s2">or not </span><span class="s1">isdir(sdkdir):</span>
            <span class="s4"># If fail, use default new path</span>
            <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">self.WindowsSdkVersion:</span>
                <span class="s1">intver = ver[:ver.rfind(</span><span class="s3">'.'</span><span class="s1">)]</span>
                <span class="s1">path = </span><span class="s3">r'Microsoft SDKs\Windows Kits\%s' </span><span class="s1">% intver</span>
                <span class="s1">d = join(self.ProgramFiles</span><span class="s2">, </span><span class="s1">path)</span>
                <span class="s2">if </span><span class="s1">isdir(d):</span>
                    <span class="s1">sdkdir = d</span>
        <span class="s2">if not </span><span class="s1">sdkdir </span><span class="s2">or not </span><span class="s1">isdir(sdkdir):</span>
            <span class="s4"># If fail, use default old path</span>
            <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">self.WindowsSdkVersion:</span>
                <span class="s1">path = </span><span class="s3">r'Microsoft SDKs\Windows\v%s' </span><span class="s1">% ver</span>
                <span class="s1">d = join(self.ProgramFiles</span><span class="s2">, </span><span class="s1">path)</span>
                <span class="s2">if </span><span class="s1">isdir(d):</span>
                    <span class="s1">sdkdir = d</span>
        <span class="s2">if not </span><span class="s1">sdkdir:</span>
            <span class="s4"># If fail, use Platform SDK</span>
            <span class="s1">sdkdir = join(self.VCInstallDir</span><span class="s2">, </span><span class="s3">'PlatformSDK'</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">sdkdir</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">WindowsSDKExecutablePath(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK executable directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s4"># Find WinSDK NetFx Tools registry dir name</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">11.0</span><span class="s1">:</span>
            <span class="s1">netfxver = </span><span class="s5">35</span>
            <span class="s1">arch = </span><span class="s3">''</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">netfxver = </span><span class="s5">40</span>
            <span class="s1">hidex86 = </span><span class="s2">True if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">12.0 </span><span class="s2">else False</span>
            <span class="s1">arch = self.pi.current_dir(x64=</span><span class="s2">True, </span><span class="s1">hidex86=hidex86)</span>
        <span class="s1">fx = </span><span class="s3">'WinSDK-NetFx%dTools%s' </span><span class="s1">% (netfxver</span><span class="s2">, </span><span class="s1">arch.replace(</span><span class="s3">'</span><span class="s2">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s3">'-'</span><span class="s1">))</span>

        <span class="s4"># list all possibles registry paths</span>
        <span class="s1">regpaths = []</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">self.NetFxSdkVersion:</span>
                <span class="s1">regpaths += [join(self.ri.netfx_sdk</span><span class="s2">, </span><span class="s1">ver</span><span class="s2">, </span><span class="s1">fx)]</span>

        <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">self.WindowsSdkVersion:</span>
            <span class="s1">regpaths += [join(self.ri.windows_sdk</span><span class="s2">, </span><span class="s3">'v%sA' </span><span class="s1">% ver</span><span class="s2">, </span><span class="s1">fx)]</span>

        <span class="s4"># Return installation folder from the more recent path</span>
        <span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s1">regpaths:</span>
            <span class="s1">execpath = self.ri.lookup(path</span><span class="s2">, </span><span class="s3">'installationfolder'</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">execpath:</span>
                <span class="s2">return </span><span class="s1">execpath</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">FSharpInstallDir(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual F# directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s1">path = join(self.ri.visualstudio</span><span class="s2">, </span><span class="s3">r'%0.1f\Setup\F#' </span><span class="s1">% self.vs_ver)</span>
        <span class="s2">return </span><span class="s1">self.ri.lookup(path</span><span class="s2">, </span><span class="s3">'productdir'</span><span class="s1">) </span><span class="s2">or </span><span class="s3">''</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">UniversalCRTSdkDir(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Universal CRT SDK directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s4"># Set Kit Roots versions for specified MSVC++ version</span>
        <span class="s1">vers = (</span><span class="s3">'10'</span><span class="s2">, </span><span class="s3">'81'</span><span class="s1">) </span><span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0 </span><span class="s2">else </span><span class="s1">()</span>

        <span class="s4"># Find path of the more recent Kit</span>
        <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">vers:</span>
            <span class="s1">sdkdir = self.ri.lookup(self.ri.windows_kits_roots</span><span class="s2">,</span>
                                    <span class="s3">'kitsroot%s' </span><span class="s1">% ver)</span>
            <span class="s2">if </span><span class="s1">sdkdir:</span>
                <span class="s2">return </span><span class="s1">sdkdir </span><span class="s2">or </span><span class="s3">''</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">UniversalCRTSdkLastVersion(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Universal C Runtime SDK last version. 
 
        Return 
        ------ 
        str 
            version 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self._use_last_dir_name(join(self.UniversalCRTSdkDir</span><span class="s2">, </span><span class="s3">'lib'</span><span class="s1">))</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">NetFxSdkVersion(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework SDK versions. 
 
        Return 
        ------ 
        tuple of str 
            versions 
        &quot;&quot;&quot;</span>
        <span class="s4"># Set FxSdk versions for specified VS version</span>
        <span class="s2">return </span><span class="s1">((</span><span class="s3">'4.7.2'</span><span class="s2">, </span><span class="s3">'4.7.1'</span><span class="s2">, </span><span class="s3">'4.7'</span><span class="s2">,</span>
                 <span class="s3">'4.6.2'</span><span class="s2">, </span><span class="s3">'4.6.1'</span><span class="s2">, </span><span class="s3">'4.6'</span><span class="s2">,</span>
                 <span class="s3">'4.5.2'</span><span class="s2">, </span><span class="s3">'4.5.1'</span><span class="s2">, </span><span class="s3">'4.5'</span><span class="s1">)</span>
                <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0 </span><span class="s2">else </span><span class="s1">())</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">NetFxSdkDir(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework SDK directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s1">sdkdir = </span><span class="s3">''</span>
        <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">self.NetFxSdkVersion:</span>
            <span class="s1">loc = join(self.ri.netfx_sdk</span><span class="s2">, </span><span class="s1">ver)</span>
            <span class="s1">sdkdir = self.ri.lookup(loc</span><span class="s2">, </span><span class="s3">'kitsinstallationfolder'</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">sdkdir:</span>
                <span class="s2">break</span>
        <span class="s2">return </span><span class="s1">sdkdir</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">FrameworkDir32(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework 32bit directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s4"># Default path</span>
        <span class="s1">guess_fw = join(self.WinDir</span><span class="s2">, </span><span class="s3">r'Microsoft.NET\Framework'</span><span class="s1">)</span>

        <span class="s4"># Try to get path from registry, if fail use default path</span>
        <span class="s2">return </span><span class="s1">self.ri.lookup(self.ri.vc</span><span class="s2">, </span><span class="s3">'frameworkdir32'</span><span class="s1">) </span><span class="s2">or </span><span class="s1">guess_fw</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">FrameworkDir64(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework 64bit directory. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s4"># Default path</span>
        <span class="s1">guess_fw = join(self.WinDir</span><span class="s2">, </span><span class="s3">r'Microsoft.NET\Framework64'</span><span class="s1">)</span>

        <span class="s4"># Try to get path from registry, if fail use default path</span>
        <span class="s2">return </span><span class="s1">self.ri.lookup(self.ri.vc</span><span class="s2">, </span><span class="s3">'frameworkdir64'</span><span class="s1">) </span><span class="s2">or </span><span class="s1">guess_fw</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">FrameworkVersion32(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework 32bit versions. 
 
        Return 
        ------ 
        tuple of str 
            versions 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self._find_dot_net_versions(</span><span class="s5">32</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">FrameworkVersion64(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework 64bit versions. 
 
        Return 
        ------ 
        tuple of str 
            versions 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self._find_dot_net_versions(</span><span class="s5">64</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_find_dot_net_versions(self</span><span class="s2">, </span><span class="s1">bits):</span>
        <span class="s0">&quot;&quot;&quot; 
        Find Microsoft .NET Framework versions. 
 
        Parameters 
        ---------- 
        bits: int 
            Platform number of bits: 32 or 64. 
 
        Return 
        ------ 
        tuple of str 
            versions 
        &quot;&quot;&quot;</span>
        <span class="s4"># Find actual .NET version in registry</span>
        <span class="s1">reg_ver = self.ri.lookup(self.ri.vc</span><span class="s2">, </span><span class="s3">'frameworkver%d' </span><span class="s1">% bits)</span>
        <span class="s1">dot_net_dir = getattr(self</span><span class="s2">, </span><span class="s3">'FrameworkDir%d' </span><span class="s1">% bits)</span>
        <span class="s1">ver = reg_ver </span><span class="s2">or </span><span class="s1">self._use_last_dir_name(dot_net_dir</span><span class="s2">, </span><span class="s3">'v'</span><span class="s1">) </span><span class="s2">or </span><span class="s3">''</span>

        <span class="s4"># Set .NET versions for specified MSVC++ version</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">12.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">ver</span><span class="s2">, </span><span class="s3">'v4.0'</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">10.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'v4.0.30319' </span><span class="s2">if </span><span class="s1">ver.lower()[:</span><span class="s5">2</span><span class="s1">] != </span><span class="s3">'v4' </span><span class="s2">else </span><span class="s1">ver</span><span class="s2">, </span><span class="s3">'v3.5'</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver == </span><span class="s5">9.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'v3.5'</span><span class="s2">, </span><span class="s3">'v2.0.50727'</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver == </span><span class="s5">8.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s3">'v3.0'</span><span class="s2">, </span><span class="s3">'v2.0.50727'</span>

    <span class="s1">@staticmethod</span>
    <span class="s2">def </span><span class="s1">_use_last_dir_name(path</span><span class="s2">, </span><span class="s1">prefix=</span><span class="s3">''</span><span class="s1">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return name of the last dir in path or '' if no dir found. 
 
        Parameters 
        ---------- 
        path: str 
            Use dirs in this path 
        prefix: str 
            Use only dirs starting by this prefix 
 
        Return 
        ------ 
        str 
            name 
        &quot;&quot;&quot;</span>
        <span class="s1">matching_dirs = (</span>
            <span class="s1">dir_name</span>
            <span class="s2">for </span><span class="s1">dir_name </span><span class="s2">in </span><span class="s1">reversed(listdir(path))</span>
            <span class="s2">if </span><span class="s1">isdir(join(path</span><span class="s2">, </span><span class="s1">dir_name)) </span><span class="s2">and</span>
            <span class="s1">dir_name.startswith(prefix)</span>
        <span class="s1">)</span>
        <span class="s2">return </span><span class="s1">next(matching_dirs</span><span class="s2">, None</span><span class="s1">) </span><span class="s2">or </span><span class="s3">''</span>


<span class="s2">class </span><span class="s1">EnvironmentInfo:</span>
    <span class="s0">&quot;&quot;&quot; 
    Return environment variables for specified Microsoft Visual C++ version 
    and platform : Lib, Include, Path and libpath. 
 
    This function is compatible with Microsoft Visual C++ 9.0 to 14.X. 
 
    Script created by analysing Microsoft environment configuration files like 
    &quot;vcvars[...].bat&quot;, &quot;SetEnv.Cmd&quot;, &quot;vcbuildtools.bat&quot;, ... 
 
    Parameters 
    ---------- 
    arch: str 
        Target architecture. 
    vc_ver: float 
        Required Microsoft Visual C++ version. If not set, autodetect the last 
        version. 
    vc_min_ver: float 
        Minimum Microsoft Visual C++ version. 
    &quot;&quot;&quot;</span>

    <span class="s4"># Variables and properties in this class use originals CamelCase variables</span>
    <span class="s4"># names from Microsoft source files for more easy comparison.</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">arch</span><span class="s2">, </span><span class="s1">vc_ver=</span><span class="s2">None, </span><span class="s1">vc_min_ver=</span><span class="s5">0</span><span class="s1">):</span>
        <span class="s1">self.pi = PlatformInfo(arch)</span>
        <span class="s1">self.ri = RegistryInfo(self.pi)</span>
        <span class="s1">self.si = SystemInfo(self.ri</span><span class="s2">, </span><span class="s1">vc_ver)</span>

        <span class="s2">if </span><span class="s1">self.vc_ver &lt; vc_min_ver:</span>
            <span class="s1">err = </span><span class="s3">'No suitable Microsoft Visual C++ version found'</span>
            <span class="s2">raise </span><span class="s1">distutils.errors.DistutilsPlatformError(err)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">vs_ver(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual Studio. 
 
        Return 
        ------ 
        float 
            version 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self.si.vs_ver</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">vc_ver(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ version. 
 
        Return 
        ------ 
        float 
            version 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self.si.vc_ver</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VSTools(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual Studio Tools. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s1">paths = [</span><span class="s3">r'Common7\IDE'</span><span class="s2">, </span><span class="s3">r'Common7\Tools'</span><span class="s1">]</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s1">arch_subdir = self.pi.current_dir(hidex86=</span><span class="s2">True, </span><span class="s1">x64=</span><span class="s2">True</span><span class="s1">)</span>
            <span class="s1">paths += [</span><span class="s3">r'Common7\IDE\CommonExtensions\Microsoft\TestWindow'</span><span class="s1">]</span>
            <span class="s1">paths += [</span><span class="s3">r'Team Tools\Performance Tools'</span><span class="s1">]</span>
            <span class="s1">paths += [</span><span class="s3">r'Team Tools\Performance Tools%s' </span><span class="s1">% arch_subdir]</span>

        <span class="s2">return </span><span class="s1">[join(self.si.VSInstallDir</span><span class="s2">, </span><span class="s1">path) </span><span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s1">paths]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VCIncludes(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ &amp; Microsoft Foundation Class Includes. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">[join(self.si.VCInstallDir</span><span class="s2">, </span><span class="s3">'Include'</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">join(self.si.VCInstallDir</span><span class="s2">, </span><span class="s3">r'ATLMFC\Include'</span><span class="s1">)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VCLibraries(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ &amp; Microsoft Foundation Class Libraries. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">15.0</span><span class="s1">:</span>
            <span class="s1">arch_subdir = self.pi.target_dir(x64=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">arch_subdir = self.pi.target_dir(hidex86=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">paths = [</span><span class="s3">'Lib%s' </span><span class="s1">% arch_subdir</span><span class="s2">, </span><span class="s3">r'ATLMFC\Lib%s' </span><span class="s1">% arch_subdir]</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s1">paths += [</span><span class="s3">r'Lib\store%s' </span><span class="s1">% arch_subdir]</span>

        <span class="s2">return </span><span class="s1">[join(self.si.VCInstallDir</span><span class="s2">, </span><span class="s1">path) </span><span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s1">paths]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VCStoreRefs(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ store references Libraries. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[]</span>
        <span class="s2">return </span><span class="s1">[join(self.si.VCInstallDir</span><span class="s2">, </span><span class="s3">r'Lib\store\references'</span><span class="s1">)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VCTools(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ Tools. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s1">si = self.si</span>
        <span class="s1">tools = [join(si.VCInstallDir</span><span class="s2">, </span><span class="s3">'VCPackages'</span><span class="s1">)]</span>

        <span class="s1">forcex86 = </span><span class="s2">True if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">10.0 </span><span class="s2">else False</span>
        <span class="s1">arch_subdir = self.pi.cross_dir(forcex86)</span>
        <span class="s2">if </span><span class="s1">arch_subdir:</span>
            <span class="s1">tools += [join(si.VCInstallDir</span><span class="s2">, </span><span class="s3">'Bin%s' </span><span class="s1">% arch_subdir)]</span>

        <span class="s2">if </span><span class="s1">self.vs_ver == </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s1">path = </span><span class="s3">'Bin%s' </span><span class="s1">% self.pi.current_dir(hidex86=</span><span class="s2">True</span><span class="s1">)</span>
            <span class="s1">tools += [join(si.VCInstallDir</span><span class="s2">, </span><span class="s1">path)]</span>

        <span class="s2">elif </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">15.0</span><span class="s1">:</span>
            <span class="s1">host_dir = (</span><span class="s3">r'bin\HostX86%s' </span><span class="s2">if </span><span class="s1">self.pi.current_is_x86() </span><span class="s2">else</span>
                        <span class="s3">r'bin\HostX64%s'</span><span class="s1">)</span>
            <span class="s1">tools += [join(</span>
                <span class="s1">si.VCInstallDir</span><span class="s2">, </span><span class="s1">host_dir % self.pi.target_dir(x64=</span><span class="s2">True</span><span class="s1">))]</span>

            <span class="s2">if </span><span class="s1">self.pi.current_cpu != self.pi.target_cpu:</span>
                <span class="s1">tools += [join(</span>
                    <span class="s1">si.VCInstallDir</span><span class="s2">, </span><span class="s1">host_dir % self.pi.current_dir(x64=</span><span class="s2">True</span><span class="s1">))]</span>

        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">tools += [join(si.VCInstallDir</span><span class="s2">, </span><span class="s3">'Bin'</span><span class="s1">)]</span>

        <span class="s2">return </span><span class="s1">tools</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">OSLibraries(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK Libraries. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">10.0</span><span class="s1">:</span>
            <span class="s1">arch_subdir = self.pi.target_dir(hidex86=</span><span class="s2">True, </span><span class="s1">x64=</span><span class="s2">True</span><span class="s1">)</span>
            <span class="s2">return </span><span class="s1">[join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'Lib%s' </span><span class="s1">% arch_subdir)]</span>

        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">arch_subdir = self.pi.target_dir(x64=</span><span class="s2">True</span><span class="s1">)</span>
            <span class="s1">lib = join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'lib'</span><span class="s1">)</span>
            <span class="s1">libver = self._sdk_subdir</span>
            <span class="s2">return </span><span class="s1">[join(lib</span><span class="s2">, </span><span class="s3">'%sum%s' </span><span class="s1">% (libver</span><span class="s2">, </span><span class="s1">arch_subdir))]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">OSIncludes(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK Include. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s1">include = join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'include'</span><span class="s1">)</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">10.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[include</span><span class="s2">, </span><span class="s1">join(include</span><span class="s2">, </span><span class="s3">'gl'</span><span class="s1">)]</span>

        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0</span><span class="s1">:</span>
                <span class="s1">sdkver = self._sdk_subdir</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">sdkver = </span><span class="s3">''</span>
            <span class="s2">return </span><span class="s1">[join(include</span><span class="s2">, </span><span class="s3">'%sshared' </span><span class="s1">% sdkver)</span><span class="s2">,</span>
                    <span class="s1">join(include</span><span class="s2">, </span><span class="s3">'%sum' </span><span class="s1">% sdkver)</span><span class="s2">,</span>
                    <span class="s1">join(include</span><span class="s2">, </span><span class="s3">'%swinrt' </span><span class="s1">% sdkver)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">OSLibpath(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK Libraries Paths. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s1">ref = join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'References'</span><span class="s1">)</span>
        <span class="s1">libpath = []</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">9.0</span><span class="s1">:</span>
            <span class="s1">libpath += self.OSLibraries</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">11.0</span><span class="s1">:</span>
            <span class="s1">libpath += [join(ref</span><span class="s2">, </span><span class="s3">r'CommonConfiguration\Neutral'</span><span class="s1">)]</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s1">libpath += [</span>
                <span class="s1">ref</span><span class="s2">,</span>
                <span class="s1">join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'UnionMetadata'</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">join(</span>
                    <span class="s1">ref</span><span class="s2">, </span><span class="s3">'Windows.Foundation.UniversalApiContract'</span><span class="s2">, </span><span class="s3">'1.0.0.0'</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">join(ref</span><span class="s2">, </span><span class="s3">'Windows.Foundation.FoundationContract'</span><span class="s2">, </span><span class="s3">'1.0.0.0'</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">join(</span>
                    <span class="s1">ref</span><span class="s2">, </span><span class="s3">'Windows.Networking.Connectivity.WwanContract'</span><span class="s2">,</span>
                    <span class="s3">'1.0.0.0'</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">join(</span>
                    <span class="s1">self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'ExtensionSDKs'</span><span class="s2">, </span><span class="s3">'Microsoft.VCLibs'</span><span class="s2">,</span>
                    <span class="s3">'%0.1f' </span><span class="s1">% self.vs_ver</span><span class="s2">, </span><span class="s3">'References'</span><span class="s2">, </span><span class="s3">'CommonConfiguration'</span><span class="s2">,</span>
                    <span class="s3">'neutral'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">]</span>
        <span class="s2">return </span><span class="s1">libpath</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">SdkTools(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK Tools. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">list(self._sdk_tools())</span>

    <span class="s2">def </span><span class="s1">_sdk_tools(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK Tools paths generator. 
 
        Return 
        ------ 
        generator of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">15.0</span><span class="s1">:</span>
            <span class="s1">bin_dir = </span><span class="s3">'Bin' </span><span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">11.0 </span><span class="s2">else </span><span class="s3">r'Bin\x86'</span>
            <span class="s2">yield </span><span class="s1">join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s1">bin_dir)</span>

        <span class="s2">if not </span><span class="s1">self.pi.current_is_x86():</span>
            <span class="s1">arch_subdir = self.pi.current_dir(x64=</span><span class="s2">True</span><span class="s1">)</span>
            <span class="s1">path = </span><span class="s3">'Bin%s' </span><span class="s1">% arch_subdir</span>
            <span class="s2">yield </span><span class="s1">join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s1">path)</span>

        <span class="s2">if </span><span class="s1">self.vs_ver </span><span class="s2">in </span><span class="s1">(</span><span class="s5">10.0</span><span class="s2">, </span><span class="s5">11.0</span><span class="s1">):</span>
            <span class="s2">if </span><span class="s1">self.pi.target_is_x86():</span>
                <span class="s1">arch_subdir = </span><span class="s3">''</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">arch_subdir = self.pi.current_dir(hidex86=</span><span class="s2">True, </span><span class="s1">x64=</span><span class="s2">True</span><span class="s1">)</span>
            <span class="s1">path = </span><span class="s3">r'Bin\NETFX 4.0 Tools%s' </span><span class="s1">% arch_subdir</span>
            <span class="s2">yield </span><span class="s1">join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s1">path)</span>

        <span class="s2">elif </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">15.0</span><span class="s1">:</span>
            <span class="s1">path = join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'Bin'</span><span class="s1">)</span>
            <span class="s1">arch_subdir = self.pi.current_dir(x64=</span><span class="s2">True</span><span class="s1">)</span>
            <span class="s1">sdkver = self.si.WindowsSdkLastVersion</span>
            <span class="s2">yield </span><span class="s1">join(path</span><span class="s2">, </span><span class="s3">'%s%s' </span><span class="s1">% (sdkver</span><span class="s2">, </span><span class="s1">arch_subdir))</span>

        <span class="s2">if </span><span class="s1">self.si.WindowsSDKExecutablePath:</span>
            <span class="s2">yield </span><span class="s1">self.si.WindowsSDKExecutablePath</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">_sdk_subdir(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK version subdir. 
 
        Return 
        ------ 
        str 
            subdir 
        &quot;&quot;&quot;</span>
        <span class="s1">ucrtver = self.si.WindowsSdkLastVersion</span>
        <span class="s2">return </span><span class="s1">(</span><span class="s3">'%s</span><span class="s2">\\</span><span class="s3">' </span><span class="s1">% ucrtver) </span><span class="s2">if </span><span class="s1">ucrtver </span><span class="s2">else </span><span class="s3">''</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">SdkSetup(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Windows SDK Setup. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &gt; </span><span class="s5">9.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[]</span>

        <span class="s2">return </span><span class="s1">[join(self.si.WindowsSdkDir</span><span class="s2">, </span><span class="s3">'Setup'</span><span class="s1">)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">FxTools(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .NET Framework Tools. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s1">pi = self.pi</span>
        <span class="s1">si = self.si</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &lt;= </span><span class="s5">10.0</span><span class="s1">:</span>
            <span class="s1">include32 = </span><span class="s2">True</span>
            <span class="s1">include64 = </span><span class="s2">not </span><span class="s1">pi.target_is_x86() </span><span class="s2">and not </span><span class="s1">pi.current_is_x86()</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">include32 = pi.target_is_x86() </span><span class="s2">or </span><span class="s1">pi.current_is_x86()</span>
            <span class="s1">include64 = pi.current_cpu == </span><span class="s3">'amd64' </span><span class="s2">or </span><span class="s1">pi.target_cpu == </span><span class="s3">'amd64'</span>

        <span class="s1">tools = []</span>
        <span class="s2">if </span><span class="s1">include32:</span>
            <span class="s1">tools += [join(si.FrameworkDir32</span><span class="s2">, </span><span class="s1">ver)</span>
                      <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">si.FrameworkVersion32]</span>
        <span class="s2">if </span><span class="s1">include64:</span>
            <span class="s1">tools += [join(si.FrameworkDir64</span><span class="s2">, </span><span class="s1">ver)</span>
                      <span class="s2">for </span><span class="s1">ver </span><span class="s2">in </span><span class="s1">si.FrameworkVersion64]</span>
        <span class="s2">return </span><span class="s1">tools</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">NetFxSDKLibraries(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .Net Framework SDK Libraries. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">14.0 </span><span class="s2">or not </span><span class="s1">self.si.NetFxSdkDir:</span>
            <span class="s2">return </span><span class="s1">[]</span>

        <span class="s1">arch_subdir = self.pi.target_dir(x64=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">[join(self.si.NetFxSdkDir</span><span class="s2">, </span><span class="s3">r'lib\um%s' </span><span class="s1">% arch_subdir)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">NetFxSDKIncludes(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft .Net Framework SDK Includes. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">14.0 </span><span class="s2">or not </span><span class="s1">self.si.NetFxSdkDir:</span>
            <span class="s2">return </span><span class="s1">[]</span>

        <span class="s2">return </span><span class="s1">[join(self.si.NetFxSdkDir</span><span class="s2">, </span><span class="s3">r'include\um'</span><span class="s1">)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VsTDb(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual Studio Team System Database. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">[join(self.si.VSInstallDir</span><span class="s2">, </span><span class="s3">r'VSTSDB\Deploy'</span><span class="s1">)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">MSBuild(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Build Engine. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">12.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[]</span>
        <span class="s2">elif </span><span class="s1">self.vs_ver &lt; </span><span class="s5">15.0</span><span class="s1">:</span>
            <span class="s1">base_path = self.si.ProgramFilesx86</span>
            <span class="s1">arch_subdir = self.pi.current_dir(hidex86=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">base_path = self.si.VSInstallDir</span>
            <span class="s1">arch_subdir = </span><span class="s3">''</span>

        <span class="s1">path = </span><span class="s3">r'MSBuild\%0.1f\bin%s' </span><span class="s1">% (self.vs_ver</span><span class="s2">, </span><span class="s1">arch_subdir)</span>
        <span class="s1">build = [join(base_path</span><span class="s2">, </span><span class="s1">path)]</span>

        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">15.0</span><span class="s1">:</span>
            <span class="s4"># Add Roslyn C# &amp; Visual Basic Compiler</span>
            <span class="s1">build += [join(base_path</span><span class="s2">, </span><span class="s1">path</span><span class="s2">, </span><span class="s3">'Roslyn'</span><span class="s1">)]</span>

        <span class="s2">return </span><span class="s1">build</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">HTMLHelpWorkshop(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft HTML Help Workshop. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">11.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[]</span>

        <span class="s2">return </span><span class="s1">[join(self.si.ProgramFilesx86</span><span class="s2">, </span><span class="s3">'HTML Help Workshop'</span><span class="s1">)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">UCRTLibraries(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Universal C Runtime SDK Libraries. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[]</span>

        <span class="s1">arch_subdir = self.pi.target_dir(x64=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">lib = join(self.si.UniversalCRTSdkDir</span><span class="s2">, </span><span class="s3">'lib'</span><span class="s1">)</span>
        <span class="s1">ucrtver = self._ucrt_subdir</span>
        <span class="s2">return </span><span class="s1">[join(lib</span><span class="s2">, </span><span class="s3">'%sucrt%s' </span><span class="s1">% (ucrtver</span><span class="s2">, </span><span class="s1">arch_subdir))]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">UCRTIncludes(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Universal C Runtime SDK Include. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &lt; </span><span class="s5">14.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[]</span>

        <span class="s1">include = join(self.si.UniversalCRTSdkDir</span><span class="s2">, </span><span class="s3">'include'</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">[join(include</span><span class="s2">, </span><span class="s3">'%sucrt' </span><span class="s1">% self._ucrt_subdir)]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">_ucrt_subdir(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Universal C Runtime SDK version subdir. 
 
        Return 
        ------ 
        str 
            subdir 
        &quot;&quot;&quot;</span>
        <span class="s1">ucrtver = self.si.UniversalCRTSdkLastVersion</span>
        <span class="s2">return </span><span class="s1">(</span><span class="s3">'%s</span><span class="s2">\\</span><span class="s3">' </span><span class="s1">% ucrtver) </span><span class="s2">if </span><span class="s1">ucrtver </span><span class="s2">else </span><span class="s3">''</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">FSharp(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual F#. 
 
        Return 
        ------ 
        list of str 
            paths 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s5">11.0 </span><span class="s1">&gt; self.vs_ver &gt; </span><span class="s5">12.0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">[]</span>

        <span class="s2">return </span><span class="s1">[self.si.FSharpInstallDir]</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">VCRuntimeRedist(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Microsoft Visual C++ runtime redistributable dll. 
 
        Return 
        ------ 
        str 
            path 
        &quot;&quot;&quot;</span>
        <span class="s1">vcruntime = </span><span class="s3">'vcruntime%d0.dll' </span><span class="s1">% self.vc_ver</span>
        <span class="s1">arch_subdir = self.pi.target_dir(x64=</span><span class="s2">True</span><span class="s1">).strip(</span><span class="s3">'</span><span class="s2">\\</span><span class="s3">'</span><span class="s1">)</span>

        <span class="s4"># Installation prefixes candidates</span>
        <span class="s1">prefixes = []</span>
        <span class="s1">tools_path = self.si.VCInstallDir</span>
        <span class="s1">redist_path = dirname(tools_path.replace(</span><span class="s3">r'\Tools'</span><span class="s2">, </span><span class="s3">r'\Redist'</span><span class="s1">))</span>
        <span class="s2">if </span><span class="s1">isdir(redist_path):</span>
            <span class="s4"># Redist version may not be exactly the same as tools</span>
            <span class="s1">redist_path = join(redist_path</span><span class="s2">, </span><span class="s1">listdir(redist_path)[-</span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">prefixes += [redist_path</span><span class="s2">, </span><span class="s1">join(redist_path</span><span class="s2">, </span><span class="s3">'onecore'</span><span class="s1">)]</span>

        <span class="s1">prefixes += [join(tools_path</span><span class="s2">, </span><span class="s3">'redist'</span><span class="s1">)]  </span><span class="s4"># VS14 legacy path</span>

        <span class="s4"># CRT directory</span>
        <span class="s1">crt_dirs = (</span><span class="s3">'Microsoft.VC%d.CRT' </span><span class="s1">% (self.vc_ver * </span><span class="s5">10</span><span class="s1">)</span><span class="s2">,</span>
                    <span class="s4"># Sometime store in directory with VS version instead of VC</span>
                    <span class="s3">'Microsoft.VC%d.CRT' </span><span class="s1">% (int(self.vs_ver) * </span><span class="s5">10</span><span class="s1">))</span>

        <span class="s4"># vcruntime path</span>
        <span class="s2">for </span><span class="s1">prefix</span><span class="s2">, </span><span class="s1">crt_dir </span><span class="s2">in </span><span class="s1">itertools.product(prefixes</span><span class="s2">, </span><span class="s1">crt_dirs):</span>
            <span class="s1">path = join(prefix</span><span class="s2">, </span><span class="s1">arch_subdir</span><span class="s2">, </span><span class="s1">crt_dir</span><span class="s2">, </span><span class="s1">vcruntime)</span>
            <span class="s2">if </span><span class="s1">isfile(path):</span>
                <span class="s2">return </span><span class="s1">path</span>

    <span class="s2">def </span><span class="s1">return_env(self</span><span class="s2">, </span><span class="s1">exists=</span><span class="s2">True</span><span class="s1">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return environment dict. 
 
        Parameters 
        ---------- 
        exists: bool 
            It True, only return existing paths. 
 
        Return 
        ------ 
        dict 
            environment 
        &quot;&quot;&quot;</span>
        <span class="s1">env = dict(</span>
            <span class="s1">include=self._build_paths(</span><span class="s3">'include'</span><span class="s2">,</span>
                                      <span class="s1">[self.VCIncludes</span><span class="s2">,</span>
                                       <span class="s1">self.OSIncludes</span><span class="s2">,</span>
                                       <span class="s1">self.UCRTIncludes</span><span class="s2">,</span>
                                       <span class="s1">self.NetFxSDKIncludes]</span><span class="s2">,</span>
                                      <span class="s1">exists)</span><span class="s2">,</span>
            <span class="s1">lib=self._build_paths(</span><span class="s3">'lib'</span><span class="s2">,</span>
                                  <span class="s1">[self.VCLibraries</span><span class="s2">,</span>
                                   <span class="s1">self.OSLibraries</span><span class="s2">,</span>
                                   <span class="s1">self.FxTools</span><span class="s2">,</span>
                                   <span class="s1">self.UCRTLibraries</span><span class="s2">,</span>
                                   <span class="s1">self.NetFxSDKLibraries]</span><span class="s2">,</span>
                                  <span class="s1">exists)</span><span class="s2">,</span>
            <span class="s1">libpath=self._build_paths(</span><span class="s3">'libpath'</span><span class="s2">,</span>
                                      <span class="s1">[self.VCLibraries</span><span class="s2">,</span>
                                       <span class="s1">self.FxTools</span><span class="s2">,</span>
                                       <span class="s1">self.VCStoreRefs</span><span class="s2">,</span>
                                       <span class="s1">self.OSLibpath]</span><span class="s2">,</span>
                                      <span class="s1">exists)</span><span class="s2">,</span>
            <span class="s1">path=self._build_paths(</span><span class="s3">'path'</span><span class="s2">,</span>
                                   <span class="s1">[self.VCTools</span><span class="s2">,</span>
                                    <span class="s1">self.VSTools</span><span class="s2">,</span>
                                    <span class="s1">self.VsTDb</span><span class="s2">,</span>
                                    <span class="s1">self.SdkTools</span><span class="s2">,</span>
                                    <span class="s1">self.SdkSetup</span><span class="s2">,</span>
                                    <span class="s1">self.FxTools</span><span class="s2">,</span>
                                    <span class="s1">self.MSBuild</span><span class="s2">,</span>
                                    <span class="s1">self.HTMLHelpWorkshop</span><span class="s2">,</span>
                                    <span class="s1">self.FSharp]</span><span class="s2">,</span>
                                   <span class="s1">exists)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s2">if </span><span class="s1">self.vs_ver &gt;= </span><span class="s5">14 </span><span class="s2">and </span><span class="s1">isfile(self.VCRuntimeRedist):</span>
            <span class="s1">env[</span><span class="s3">'py_vcruntime_redist'</span><span class="s1">] = self.VCRuntimeRedist</span>
        <span class="s2">return </span><span class="s1">env</span>

    <span class="s2">def </span><span class="s1">_build_paths(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">spec_path_lists</span><span class="s2">, </span><span class="s1">exists):</span>
        <span class="s0">&quot;&quot;&quot; 
        Given an environment variable name and specified paths, 
        return a pathsep-separated string of paths containing 
        unique, extant, directories from those paths and from 
        the environment variable. Raise an error if no paths 
        are resolved. 
 
        Parameters 
        ---------- 
        name: str 
            Environment variable name 
        spec_path_lists: list of str 
            Paths 
        exists: bool 
            It True, only return existing paths. 
 
        Return 
        ------ 
        str 
            Pathsep-separated paths 
        &quot;&quot;&quot;</span>
        <span class="s4"># flatten spec_path_lists</span>
        <span class="s1">spec_paths = itertools.chain.from_iterable(spec_path_lists)</span>
        <span class="s1">env_paths = environ.get(name</span><span class="s2">, </span><span class="s3">''</span><span class="s1">).split(pathsep)</span>
        <span class="s1">paths = itertools.chain(spec_paths</span><span class="s2">, </span><span class="s1">env_paths)</span>
        <span class="s1">extant_paths = list(filter(isdir</span><span class="s2">, </span><span class="s1">paths)) </span><span class="s2">if </span><span class="s1">exists </span><span class="s2">else </span><span class="s1">paths</span>
        <span class="s2">if not </span><span class="s1">extant_paths:</span>
            <span class="s1">msg = </span><span class="s3">&quot;%s environment variable is empty&quot; </span><span class="s1">% name.upper()</span>
            <span class="s2">raise </span><span class="s1">distutils.errors.DistutilsPlatformError(msg)</span>
        <span class="s1">unique_paths = unique_everseen(extant_paths)</span>
        <span class="s2">return </span><span class="s1">pathsep.join(unique_paths)</span>
</pre>
</body>
</html>