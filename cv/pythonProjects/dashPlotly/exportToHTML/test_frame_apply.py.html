<html>
<head>
<title>test_frame_apply.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_frame_apply.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.core.dtypes.dtypes </span><span class="s0">import </span><span class="s1">CategoricalDtype</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.tests.frame.common </span><span class="s0">import </span><span class="s1">zip_frames</span>


<span class="s0">def </span><span class="s1">test_apply(float_frame):</span>
    <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s2">&quot;ignore&quot;</span><span class="s1">):</span>
        <span class="s3"># ufunc</span>
        <span class="s1">result = np.sqrt(float_frame[</span><span class="s2">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s1">expected = float_frame.apply(np.sqrt)[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s3"># aggregator</span>
        <span class="s1">result = float_frame.apply(np.mean)[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">expected = np.mean(float_frame[</span><span class="s2">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">result == expected</span>

        <span class="s1">d = float_frame.index[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">result = float_frame.apply(np.mean</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = np.mean(float_frame.xs(d))</span>
        <span class="s0">assert </span><span class="s1">result[d] == expected</span>
        <span class="s0">assert </span><span class="s1">result.index </span><span class="s0">is </span><span class="s1">float_frame.index</span>


<span class="s0">def </span><span class="s1">test_apply_categorical_func():</span>
    <span class="s3"># GH 9573</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;c0&quot;</span><span class="s1">: [</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c1&quot;</span><span class="s1">: [</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;D&quot;</span><span class="s1">]})</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">ts: ts.astype(</span><span class="s2">&quot;category&quot;</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">result.shape == (</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(result[</span><span class="s2">&quot;c0&quot;</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">CategoricalDtype)</span>
    <span class="s0">assert </span><span class="s1">isinstance(result[</span><span class="s2">&quot;c1&quot;</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">CategoricalDtype)</span>


<span class="s0">def </span><span class="s1">test_apply_axis1_with_ea():</span>
    <span class="s3"># GH#36785</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [Timestamp(</span><span class="s2">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)]})</span>
    <span class="s1">result = expected.apply(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;data, dtype&quot;</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">CategoricalDtype([</span><span class="s4">1</span><span class="s1">]))</span><span class="s0">, </span><span class="s1">(Timestamp(</span><span class="s2">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_agg_axis1_duplicate_index(data</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s3"># GH 42380</span>
    <span class="s1">expected = DataFrame([[data]</span><span class="s0">, </span><span class="s1">[data]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">result = expected.agg(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_mixed_datetimelike():</span>
    <span class="s3"># mixed datetimelike</span>
    <span class="s3"># GH 7778</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: pd.to_timedelta(np.arange(</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">unit=</span><span class="s2">&quot;s&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">result = expected.apply(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[np.sqrt</span><span class="s0">, </span><span class="s1">np.mean])</span>
<span class="s0">def </span><span class="s1">test_apply_empty(func):</span>
    <span class="s3"># empty</span>
    <span class="s1">empty_frame = DataFrame()</span>

    <span class="s1">result = empty_frame.apply(func)</span>
    <span class="s0">assert </span><span class="s1">result.empty</span>


<span class="s0">def </span><span class="s1">test_apply_float_frame(float_frame):</span>
    <span class="s1">no_rows = float_frame[:</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">result = no_rows.apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean())</span>
    <span class="s1">expected = Series(np.nan</span><span class="s0">, </span><span class="s1">index=float_frame.columns)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">no_cols = float_frame.loc[:</span><span class="s0">, </span><span class="s1">[]]</span>
    <span class="s1">result = no_cols.apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series(np.nan</span><span class="s0">, </span><span class="s1">index=float_frame.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_empty_except_index():</span>
    <span class="s3"># GH 2476</span>
    <span class="s1">expected = DataFrame(index=[</span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">result = expected.apply(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_with_reduce_empty():</span>
    <span class="s3"># reduce with an empty DataFrame</span>
    <span class="s1">empty_frame = DataFrame()</span>

    <span class="s1">x = []</span>
    <span class="s1">result = empty_frame.apply(x.append</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">empty_frame)</span>
    <span class="s1">result = empty_frame.apply(x.append</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;reduce&quot;</span><span class="s1">)</span>
    <span class="s1">expected = Series([]</span><span class="s0">, </span><span class="s1">index=pd.Index([]</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">empty_with_cols = DataFrame(columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">result = empty_with_cols.apply(x.append</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">empty_with_cols)</span>
    <span class="s1">result = empty_with_cols.apply(x.append</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;reduce&quot;</span><span class="s1">)</span>
    <span class="s1">expected = Series([]</span><span class="s0">, </span><span class="s1">index=pd.Index([]</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Ensure that x.append hasn't been called</span>
    <span class="s0">assert </span><span class="s1">x == []</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;prod&quot;</span><span class="s0">, </span><span class="s2">&quot;any&quot;</span><span class="s0">, </span><span class="s2">&quot;all&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_apply_funcs_over_empty(func):</span>
    <span class="s3"># GH 28213</span>
    <span class="s1">df = DataFrame(columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.apply(getattr(np</span><span class="s0">, </span><span class="s1">func))</span>
    <span class="s1">expected = getattr(df</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nunique_empty():</span>
    <span class="s3"># GH 28213</span>
    <span class="s1">df = DataFrame(columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.nunique()</span>
    <span class="s1">expected = Series(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">index=df.columns)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.T.nunique()</span>
    <span class="s1">expected = Series([]</span><span class="s0">, </span><span class="s1">index=pd.Index([])</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_standard_nonunique():</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">s: s[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.T.apply(</span><span class="s0">lambda </span><span class="s1">s: s[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_scalars(float_frame):</span>
    <span class="s3"># scalars</span>
    <span class="s1">result = float_frame.apply(np.mean</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame([float_frame.mean()]</span><span class="s0">, </span><span class="s1">index=float_frame.index)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_scalars_axis1(float_frame):</span>
    <span class="s1">result = float_frame.apply(np.mean</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span><span class="s1">)</span>
    <span class="s1">m = float_frame.mean(axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({c: m </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">float_frame.columns})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_lists_columns(float_frame):</span>
    <span class="s3"># lists</span>
    <span class="s1">result = float_frame.apply(</span>
        <span class="s0">lambda </span><span class="s1">x: list(range(len(float_frame.columns)))</span><span class="s0">,</span>
        <span class="s1">axis=</span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">m = list(range(len(float_frame.columns)))</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[m] * len(float_frame.index)</span><span class="s0">,</span>
        <span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s0">,</span>
        <span class="s1">index=float_frame.index</span><span class="s0">,</span>
        <span class="s1">columns=float_frame.columns</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_lists_index(float_frame):</span>
    <span class="s1">result = float_frame.apply(</span>
        <span class="s0">lambda </span><span class="s1">x: list(range(len(float_frame.index)))</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span>
    <span class="s1">)</span>
    <span class="s1">m = list(range(len(float_frame.index)))</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{c: m </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">float_frame.columns}</span><span class="s0">,</span>
        <span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s0">,</span>
        <span class="s1">index=float_frame.index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_list_lambda_func(int_frame_const_col):</span>
    <span class="s3"># preserve columns</span>
    <span class="s1">df = int_frame_const_col</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_series_lambda_func(int_frame_const_col):</span>
    <span class="s1">df = int_frame_const_col</span>
    <span class="s1">result = df.apply(</span>
        <span class="s0">lambda </span><span class="s1">x: Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">axis=</span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_apply_raw_float_frame(float_frame</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s0">def </span><span class="s1">_assert_raw(x):</span>
        <span class="s0">assert </span><span class="s1">isinstance(x</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
        <span class="s0">assert </span><span class="s1">x.ndim == </span><span class="s4">1</span>

    <span class="s1">float_frame.apply(_assert_raw</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_apply_raw_float_frame_lambda(float_frame</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">result = float_frame.apply(np.mean</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: x.values.mean()</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_raw_float_frame_no_reduction(float_frame):</span>
    <span class="s3"># no reduction</span>
    <span class="s1">result = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: x * </span><span class="s4">2</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = float_frame * </span><span class="s4">2</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_apply_raw_mixed_type_frame(mixed_type_frame</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s0">def </span><span class="s1">_assert_raw(x):</span>
        <span class="s0">assert </span><span class="s1">isinstance(x</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
        <span class="s0">assert </span><span class="s1">x.ndim == </span><span class="s4">1</span>

    <span class="s3"># Mixed dtype (GH-32423)</span>
    <span class="s1">mixed_type_frame.apply(_assert_raw</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_apply_axis1(float_frame):</span>
    <span class="s1">d = float_frame.index[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">result = float_frame.apply(np.mean</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)[d]</span>
    <span class="s1">expected = np.mean(float_frame.xs(d))</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_apply_mixed_dtype_corner():</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s1">]})</span>
    <span class="s1">result = df[:</span><span class="s4">0</span><span class="s1">].apply(np.mean</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s3"># the result here is actually kind of ambiguous, should it be a Series</span>
    <span class="s3"># or a DataFrame?</span>
    <span class="s1">expected = Series(np.nan</span><span class="s0">, </span><span class="s1">index=pd.Index([]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_mixed_dtype_corner_indexing():</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s1">]})</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s2">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;ax&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s2">&quot;columns&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, lambda </span><span class="s1">x: x.mean()]</span><span class="s0">, </span><span class="s1">ids=[</span><span class="s2">&quot;identity&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;raw&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_apply_empty_infer_type(ax</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">raw</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">df = DataFrame(**{ax: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>

    <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s2">&quot;ignore&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">):</span>
            <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">RuntimeWarning)</span>
            <span class="s1">test_res = func(np.array([]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">))</span>
        <span class="s1">is_reduction = </span><span class="s0">not </span><span class="s1">isinstance(test_res</span><span class="s0">, </span><span class="s1">np.ndarray)</span>

        <span class="s1">result = df.apply(func</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">raw=raw)</span>
        <span class="s0">if </span><span class="s1">is_reduction:</span>
            <span class="s1">agg_axis = df._get_agg_axis(axis)</span>
            <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">Series)</span>
            <span class="s0">assert </span><span class="s1">result.index </span><span class="s0">is </span><span class="s1">agg_axis</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">DataFrame)</span>


<span class="s0">def </span><span class="s1">test_apply_empty_infer_type_broadcast():</span>
    <span class="s1">no_cols = DataFrame(index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">result = no_cols.apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">DataFrame)</span>


<span class="s0">def </span><span class="s1">test_apply_with_args_kwds_add_some(float_frame):</span>
    <span class="s0">def </span><span class="s1">add_some(x</span><span class="s0">, </span><span class="s1">howmuch=</span><span class="s4">0</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">x + howmuch</span>

    <span class="s1">result = float_frame.apply(add_some</span><span class="s0">, </span><span class="s1">howmuch=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">expected = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: x + </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_with_args_kwds_agg_and_add(float_frame):</span>
    <span class="s0">def </span><span class="s1">agg_and_add(x</span><span class="s0">, </span><span class="s1">howmuch=</span><span class="s4">0</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">x.mean() + howmuch</span>

    <span class="s1">result = float_frame.apply(agg_and_add</span><span class="s0">, </span><span class="s1">howmuch=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">expected = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean() + </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_with_args_kwds_subtract_and_divide(float_frame):</span>
    <span class="s0">def </span><span class="s1">subtract_and_divide(x</span><span class="s0">, </span><span class="s1">sub</span><span class="s0">, </span><span class="s1">divide=</span><span class="s4">1</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">(x - sub) / divide</span>

    <span class="s1">result = float_frame.apply(subtract_and_divide</span><span class="s0">, </span><span class="s1">args=(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">divide=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">expected = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: (x - </span><span class="s4">2.0</span><span class="s1">) / </span><span class="s4">2.0</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_yield_list(float_frame):</span>
    <span class="s1">result = float_frame.apply(list)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">float_frame)</span>


<span class="s0">def </span><span class="s1">test_apply_reduce_Series(float_frame):</span>
    <span class="s1">float_frame[</span><span class="s2">&quot;A&quot;</span><span class="s1">].iloc[::</span><span class="s4">2</span><span class="s1">] = np.nan</span>
    <span class="s1">expected = float_frame.mean(</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">result = float_frame.apply(np.mean</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_reduce_to_dict():</span>
    <span class="s3"># GH 25196 37544</span>
    <span class="s1">data = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;c0&quot;</span><span class="s0">, </span><span class="s2">&quot;c1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;i0&quot;</span><span class="s0">, </span><span class="s2">&quot;i1&quot;</span><span class="s1">])</span>

    <span class="s1">result = data.apply(dict</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">expected = Series([{</span><span class="s2">&quot;i0&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;i1&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;i0&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;i1&quot;</span><span class="s1">: </span><span class="s4">4</span><span class="s1">}]</span><span class="s0">, </span><span class="s1">index=data.columns)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = data.apply(dict</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([{</span><span class="s2">&quot;c0&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;c1&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;c0&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s0">, </span><span class="s2">&quot;c1&quot;</span><span class="s1">: </span><span class="s4">4</span><span class="s1">}]</span><span class="s0">, </span><span class="s1">index=data.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_differently_indexed():</span>
    <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">20</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>

    <span class="s1">result = df.apply(Series.describe</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({i: v.describe() </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">df.items()}</span><span class="s0">, </span><span class="s1">columns=df.columns)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.apply(Series.describe</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({i: v.describe() </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">df.T.items()}</span><span class="s0">, </span><span class="s1">columns=df.index).T</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_bug():</span>

    <span class="s3"># GH 6125</span>
    <span class="s1">positions = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;ABC0&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;YUM0&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;DEF0&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;ABC1&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;YUM1&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;DEF1&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;market&quot;</span><span class="s0">, </span><span class="s2">&quot;position&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">f(r):</span>
        <span class="s0">return </span><span class="s1">r[</span><span class="s2">&quot;market&quot;</span><span class="s1">]</span>

    <span class="s1">expected = positions.apply(f</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">positions = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[datetime(</span><span class="s4">2013</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;ABC0&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[datetime(</span><span class="s4">2013</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;YUM0&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[datetime(</span><span class="s4">2013</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;DEF0&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[datetime(</span><span class="s4">2013</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;ABC1&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[datetime(</span><span class="s4">2013</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;YUM1&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[datetime(</span><span class="s4">2013</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;DEF1&quot;</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;market&quot;</span><span class="s0">, </span><span class="s2">&quot;position&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = positions.apply(f</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_convert_objects():</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span>
                <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span>
                <span class="s2">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;one&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;C&quot;</span><span class="s1">: [</span>
                <span class="s2">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;shiny&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;D&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">11</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;E&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">11</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;F&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">11</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">result = expected.apply(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)._convert(datetime=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name(float_frame):</span>
    <span class="s1">result = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: x.name)</span>
    <span class="s1">expected = Series(float_frame.columns</span><span class="s0">, </span><span class="s1">index=float_frame.columns)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name_axis1(float_frame):</span>
    <span class="s1">result = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: x.name</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series(float_frame.index</span><span class="s0">, </span><span class="s1">index=float_frame.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name_non_reduction(float_frame):</span>
    <span class="s3"># non-reductions</span>
    <span class="s1">result = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: np.repeat(x.name</span><span class="s0">, </span><span class="s1">len(x)))</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">np.tile(float_frame.columns</span><span class="s0">, </span><span class="s1">(len(float_frame.index)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">index=float_frame.index</span><span class="s0">,</span>
        <span class="s1">columns=float_frame.columns</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name_non_reduction_axis1(float_frame):</span>
    <span class="s1">result = float_frame.apply(</span><span class="s0">lambda </span><span class="s1">x: np.repeat(x.name</span><span class="s0">, </span><span class="s1">len(x))</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">np.repeat(t[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">len(float_frame.columns)) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">float_frame.itertuples()</span>
    <span class="s1">)</span>
    <span class="s1">expected.index = float_frame.index</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_multi_index():</span>
    <span class="s1">index = MultiIndex.from_arrays([[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]])</span>
    <span class="s1">s = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;col1&quot;</span><span class="s0">, </span><span class="s2">&quot;col2&quot;</span><span class="s1">])</span>
    <span class="s1">result = s.apply(</span><span class="s0">lambda </span><span class="s1">x: Series({</span><span class="s2">&quot;min&quot;</span><span class="s1">: min(x)</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">: max(x)})</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_like=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;df, dicts&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span>
            <span class="s1">DataFrame([[</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;spam&quot;</span><span class="s0">, </span><span class="s2">&quot;eggs&quot;</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">Series([{</span><span class="s4">0</span><span class="s1">: </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s2">&quot;spam&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s4">0</span><span class="s1">: </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s2">&quot;eggs&quot;</span><span class="s1">}])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[DataFrame([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">Series([{</span><span class="s4">0</span><span class="s1">: </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s4">2</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s4">0</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}])]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_apply_dict(df</span><span class="s0">, </span><span class="s1">dicts):</span>
    <span class="s3"># GH 8735</span>
    <span class="s1">fn = </span><span class="s0">lambda </span><span class="s1">x: x.to_dict()</span>
    <span class="s1">reduce_true = df.apply(fn</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;reduce&quot;</span><span class="s1">)</span>
    <span class="s1">reduce_false = df.apply(fn</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">reduce_none = df.apply(fn)</span>

    <span class="s1">tm.assert_series_equal(reduce_true</span><span class="s0">, </span><span class="s1">dicts)</span>
    <span class="s1">tm.assert_frame_equal(reduce_false</span><span class="s0">, </span><span class="s1">df)</span>
    <span class="s1">tm.assert_series_equal(reduce_none</span><span class="s0">, </span><span class="s1">dicts)</span>


<span class="s0">def </span><span class="s1">test_applymap(float_frame):</span>
    <span class="s1">applied = float_frame.applymap(</span><span class="s0">lambda </span><span class="s1">x: x * </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(applied</span><span class="s0">, </span><span class="s1">float_frame * </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">float_frame.applymap(type)</span>

    <span class="s3"># GH 465: function returning tuples</span>
    <span class="s1">result = float_frame.applymap(</span><span class="s0">lambda </span><span class="s1">x: (x</span><span class="s0">, </span><span class="s1">x))[</span><span class="s2">&quot;A&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">tuple)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_applymap_float_object_conversion(val):</span>
    <span class="s3"># GH 2909: object conversion to float in constructor?</span>
    <span class="s1">df = DataFrame(data=[val</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.applymap(</span><span class="s0">lambda </span><span class="s1">x: x).dtypes[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == object</span>


<span class="s0">def </span><span class="s1">test_applymap_str():</span>
    <span class="s3"># GH 2786</span>
    <span class="s1">df = DataFrame(np.random.random((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)))</span>
    <span class="s1">df2 = df.copy()</span>
    <span class="s1">cols = [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
    <span class="s1">df.columns = cols</span>

    <span class="s1">expected = df2.applymap(str)</span>
    <span class="s1">expected.columns = cols</span>
    <span class="s1">result = df.applymap(str)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;col, val&quot;</span><span class="s0">,</span>
    <span class="s1">[[</span><span class="s2">&quot;datetime&quot;</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s2">&quot;20130101&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;timedelta&quot;</span><span class="s0">, </span><span class="s1">pd.Timedelta(</span><span class="s2">&quot;1 min&quot;</span><span class="s1">)]]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_applymap_datetimelike(col</span><span class="s0">, </span><span class="s1">val):</span>
    <span class="s3"># datetime/timedelta</span>
    <span class="s1">df = DataFrame(np.random.random((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)))</span>
    <span class="s1">df[col] = val</span>
    <span class="s1">result = df.applymap(str)</span>
    <span class="s0">assert </span><span class="s1">result.loc[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">col] == str(df.loc[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">col])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">DataFrame()</span><span class="s0">,</span>
        <span class="s1">DataFrame(columns=list(</span><span class="s2">&quot;ABC&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">DataFrame(index=list(</span><span class="s2">&quot;ABC&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: []})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[round</span><span class="s0">, lambda </span><span class="s1">x: x])</span>
<span class="s0">def </span><span class="s1">test_applymap_empty(expected</span><span class="s0">, </span><span class="s1">func):</span>
    <span class="s3"># GH 8222</span>
    <span class="s1">result = expected.applymap(func)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_applymap_kwargs():</span>
    <span class="s3"># GH 40652</span>
    <span class="s1">result = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]).applymap(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">y=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame([[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_applymap_na_ignore(float_frame):</span>
    <span class="s3"># GH 23803</span>
    <span class="s1">strlen_frame = float_frame.applymap(</span><span class="s0">lambda </span><span class="s1">x: len(str(x)))</span>
    <span class="s1">float_frame_with_na = float_frame.copy()</span>
    <span class="s1">mask = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=float_frame.shape</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
    <span class="s1">float_frame_with_na[mask] = pd.NA</span>
    <span class="s1">strlen_frame_na_ignore = float_frame_with_na.applymap(</span>
        <span class="s0">lambda </span><span class="s1">x: len(str(x))</span><span class="s0">, </span><span class="s1">na_action=</span><span class="s2">&quot;ignore&quot;</span>
    <span class="s1">)</span>
    <span class="s1">strlen_frame_with_na = strlen_frame.copy()</span>
    <span class="s1">strlen_frame_with_na[mask] = pd.NA</span>
    <span class="s1">tm.assert_frame_equal(strlen_frame_na_ignore</span><span class="s0">, </span><span class="s1">strlen_frame_with_na)</span>


<span class="s0">def </span><span class="s1">test_applymap_box_timestamps():</span>
    <span class="s3"># GH 2689, GH 2627</span>
    <span class="s1">ser = Series(date_range(</span><span class="s2">&quot;1/1/2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">10</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">func(x):</span>
        <span class="s0">return </span><span class="s1">(x.hour</span><span class="s0">, </span><span class="s1">x.day</span><span class="s0">, </span><span class="s1">x.month)</span>

    <span class="s3"># it works!</span>
    <span class="s1">DataFrame(ser).applymap(func)</span>


<span class="s0">def </span><span class="s1">test_applymap_box():</span>
    <span class="s3"># ufunc will not be boxed. Same test cases as the test_map_box</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [Timestamp(</span><span class="s2">&quot;2011-01-01&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s2">&quot;2011-01-02&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: [</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2011-01-01&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2011-01-02&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: [pd.Timedelta(</span><span class="s2">&quot;1 days&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Timedelta(</span><span class="s2">&quot;2 days&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;d&quot;</span><span class="s1">: [</span>
                <span class="s1">pd.Period(</span><span class="s2">&quot;2011-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">pd.Period(</span><span class="s2">&quot;2011-01-02&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">result = df.applymap(</span><span class="s0">lambda </span><span class="s1">x: type(x).__name__)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;Timestamp&quot;</span><span class="s0">, </span><span class="s2">&quot;Timestamp&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;Timestamp&quot;</span><span class="s0">, </span><span class="s2">&quot;Timestamp&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">&quot;Timedelta&quot;</span><span class="s0">, </span><span class="s2">&quot;Timedelta&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s2">&quot;Period&quot;</span><span class="s0">, </span><span class="s2">&quot;Period&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_frame_apply_dont_convert_datetime64():</span>
    <span class="s0">from </span><span class="s1">pandas.tseries.offsets </span><span class="s0">import </span><span class="s1">BDay</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;x1&quot;</span><span class="s1">: [datetime(</span><span class="s4">1996</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]})</span>

    <span class="s1">df = df.applymap(</span><span class="s0">lambda </span><span class="s1">x: x + BDay())</span>
    <span class="s1">df = df.applymap(</span><span class="s0">lambda </span><span class="s1">x: x + BDay())</span>

    <span class="s1">result = df.x1.dtype</span>
    <span class="s0">assert </span><span class="s1">result == </span><span class="s2">&quot;M8[ns]&quot;</span>


<span class="s0">def </span><span class="s1">test_apply_non_numpy_dtype():</span>
    <span class="s3"># GH 12244</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;dt&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;2015-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;Europe/Brussels&quot;</span><span class="s1">)})</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x + pd.Timedelta(</span><span class="s2">&quot;1day&quot;</span><span class="s1">))</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;dt&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;2015-01-02&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;Europe/Brussels&quot;</span><span class="s1">)}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_non_numpy_dtype_category():</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;dt&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_apply_dup_names_multi_agg():</span>
    <span class="s3"># GH 21063</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;min&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.agg([</span><span class="s2">&quot;min&quot;</span><span class="s1">])</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;op&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;apply&quot;</span><span class="s0">, </span><span class="s2">&quot;agg&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_apply_nested_result_axis_1(op):</span>
    <span class="s3"># GH 13820</span>
    <span class="s0">def </span><span class="s1">apply_list(row):</span>
        <span class="s0">return </span><span class="s1">[</span><span class="s4">2 </span><span class="s1">* row[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">* row[</span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">* row[</span><span class="s2">&quot;B&quot;</span><span class="s1">]]</span>

    <span class="s1">df = DataFrame(np.zeros((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;ABCD&quot;</span><span class="s1">))</span>
    <span class="s1">result = getattr(df</span><span class="s0">, </span><span class="s1">op)(apply_list</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">[[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]]</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_noreduction_tzaware_object():</span>
    <span class="s3"># https://github.com/pandas-dev/pandas/issues/31505</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;foo&quot;</span><span class="s1">: [Timestamp(</span><span class="s2">&quot;2020&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)]}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;datetime64[ns, UTC]&quot;</span>
    <span class="s1">)</span>
    <span class="s1">result = expected.apply(</span><span class="s0">lambda </span><span class="s1">x: x)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">result = expected.apply(</span><span class="s0">lambda </span><span class="s1">x: x.copy())</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_function_runs_once():</span>
    <span class="s3"># https://github.com/pandas-dev/pandas/issues/30815</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
    <span class="s1">names = []  </span><span class="s3"># Save row names function is applied to</span>

    <span class="s0">def </span><span class="s1">reducing_function(row):</span>
        <span class="s1">names.append(row.name)</span>

    <span class="s0">def </span><span class="s1">non_reducing_function(row):</span>
        <span class="s1">names.append(row.name)</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s1">[reducing_function</span><span class="s0">, </span><span class="s1">non_reducing_function]:</span>
        <span class="s0">del </span><span class="s1">names[:]</span>

        <span class="s1">df.apply(func</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">names == list(df.index)</span>


<span class="s0">def </span><span class="s1">test_apply_raw_function_runs_once():</span>
    <span class="s3"># https://github.com/pandas-dev/pandas/issues/34506</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
    <span class="s1">values = []  </span><span class="s3"># Save row values function is applied to</span>

    <span class="s0">def </span><span class="s1">reducing_function(row):</span>
        <span class="s1">values.extend(row)</span>

    <span class="s0">def </span><span class="s1">non_reducing_function(row):</span>
        <span class="s1">values.extend(row)</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s1">[reducing_function</span><span class="s0">, </span><span class="s1">non_reducing_function]:</span>
        <span class="s0">del </span><span class="s1">values[:]</span>

        <span class="s1">df.apply(func</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">values == list(df.a.to_list())</span>


<span class="s0">def </span><span class="s1">test_applymap_function_runs_once():</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
    <span class="s1">values = []  </span><span class="s3"># Save values function is applied to</span>

    <span class="s0">def </span><span class="s1">reducing_function(val):</span>
        <span class="s1">values.append(val)</span>

    <span class="s0">def </span><span class="s1">non_reducing_function(val):</span>
        <span class="s1">values.append(val)</span>
        <span class="s0">return </span><span class="s1">val</span>

    <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s1">[reducing_function</span><span class="s0">, </span><span class="s1">non_reducing_function]:</span>
        <span class="s0">del </span><span class="s1">values[:]</span>

        <span class="s1">df.applymap(func)</span>
        <span class="s0">assert </span><span class="s1">values == df.a.to_list()</span>


<span class="s0">def </span><span class="s1">test_apply_with_byte_string():</span>
    <span class="s3"># GH 34529</span>
    <span class="s1">df = DataFrame(np.array([</span><span class="s5">b&quot;abcd&quot;</span><span class="s0">, </span><span class="s5">b&quot;efgh&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;col&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame(np.array([</span><span class="s5">b&quot;abcd&quot;</span><span class="s0">, </span><span class="s5">b&quot;efgh&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;col&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s3"># After we make the apply we expect a dataframe just</span>
    <span class="s3"># like the original but with the object datatype</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x.astype(</span><span class="s2">&quot;object&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;asd&quot;</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, None, </span><span class="s1">np.NaN])</span>
<span class="s0">def </span><span class="s1">test_apply_category_equalness(val):</span>
    <span class="s3"># Check if categorical comparisons on apply, GH 21239</span>
    <span class="s1">df_values = [</span><span class="s2">&quot;asd&quot;</span><span class="s0">, None, </span><span class="s4">12</span><span class="s0">, </span><span class="s2">&quot;asd&quot;</span><span class="s0">, </span><span class="s2">&quot;cde&quot;</span><span class="s0">, </span><span class="s1">np.NaN]</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: df_values}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>

    <span class="s1">result = df.a.apply(</span><span class="s0">lambda </span><span class="s1">x: x == val)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">[np.NaN </span><span class="s0">if </span><span class="s1">pd.isnull(x) </span><span class="s0">else </span><span class="s1">x == val </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">df_values]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s3"># the user has supplied an opaque UDF where</span>
<span class="s3"># they are transforming the input that requires</span>
<span class="s3"># us to infer the output</span>


<span class="s0">def </span><span class="s1">test_infer_row_shape():</span>
    <span class="s3"># GH 17437</span>
    <span class="s3"># if row shape is changing, infer it</span>
    <span class="s1">df = DataFrame(np.random.rand(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">result = df.apply(np.fft.fft</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">).shape</span>
    <span class="s0">assert </span><span class="s1">result == (</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s1">result = df.apply(np.fft.rfft</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">).shape</span>
    <span class="s0">assert </span><span class="s1">result == (</span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_with_dictlike_columns():</span>
    <span class="s3"># GH 17602</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: {</span><span class="s2">&quot;s&quot;</span><span class="s1">: x[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + x[</span><span class="s2">&quot;b&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([{</span><span class="s2">&quot;s&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">} </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">df[</span><span class="s2">&quot;tm&quot;</span><span class="s1">] = [</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;2017-05-01 00:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;2017-05-02 00:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: {</span><span class="s2">&quot;s&quot;</span><span class="s1">: x[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + x[</span><span class="s2">&quot;b&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># compose a series</span>
    <span class="s1">result = (df[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;b&quot;</span><span class="s1">]).apply(</span><span class="s0">lambda </span><span class="s1">x: {</span><span class="s2">&quot;s&quot;</span><span class="s1">: x})</span>
    <span class="s1">expected = Series([{</span><span class="s2">&quot;s&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;s&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_with_dictlike_columns_with_datetime():</span>
    <span class="s3"># GH 18775</span>
    <span class="s1">df = DataFrame()</span>
    <span class="s1">df[</span><span class="s2">&quot;author&quot;</span><span class="s1">] = [</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s0">, </span><span class="s2">&quot;Z&quot;</span><span class="s1">]</span>
    <span class="s1">df[</span><span class="s2">&quot;publisher&quot;</span><span class="s1">] = [</span><span class="s2">&quot;BBC&quot;</span><span class="s0">, </span><span class="s2">&quot;NBC&quot;</span><span class="s0">, </span><span class="s2">&quot;N24&quot;</span><span class="s1">]</span>
    <span class="s1">df[</span><span class="s2">&quot;date&quot;</span><span class="s1">] = pd.to_datetime(</span>
        <span class="s1">[</span><span class="s2">&quot;17-10-2010 07:15:30&quot;</span><span class="s0">, </span><span class="s2">&quot;13-05-2011 08:20:35&quot;</span><span class="s0">, </span><span class="s2">&quot;15-01-2013 09:09:09&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: {}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([{}</span><span class="s0">, </span><span class="s1">{}</span><span class="s0">, </span><span class="s1">{}])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_with_dictlike_columns_with_infer():</span>
    <span class="s3"># GH 17602</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: {</span><span class="s2">&quot;s&quot;</span><span class="s1">: x[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + x[</span><span class="s2">&quot;b&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;s&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">df[</span><span class="s2">&quot;tm&quot;</span><span class="s1">] = [</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;2017-05-01 00:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;2017-05-02 00:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: {</span><span class="s2">&quot;s&quot;</span><span class="s1">: x[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + x[</span><span class="s2">&quot;b&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_with_listlike_columns():</span>
    <span class="s3"># GH 17348</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: Series(np.random.randn(</span><span class="s4">4</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;list&quot;</span><span class="s0">, </span><span class="s2">&quot;of&quot;</span><span class="s0">, </span><span class="s2">&quot;words&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;ts&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;2016-10-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">4</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;H&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">result = df[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]].apply(tuple</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([t[</span><span class="s4">1</span><span class="s1">:] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]].itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;ts&quot;</span><span class="s1">]].apply(tuple</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([t[</span><span class="s4">1</span><span class="s1">:] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;ts&quot;</span><span class="s1">]].itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_with_listlike_columns_returning_list():</span>
    <span class="s3"># GH 18919</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: Series([[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;q&quot;</span><span class="s1">]])</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: Series([[</span><span class="s2">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;q&quot;</span><span class="s0">, </span><span class="s2">&quot;t&quot;</span><span class="s1">]])})</span>
    <span class="s1">df.index = MultiIndex.from_tuples([(</span><span class="s2">&quot;i0&quot;</span><span class="s0">, </span><span class="s2">&quot;j0&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;i1&quot;</span><span class="s0">, </span><span class="s2">&quot;j1&quot;</span><span class="s1">)])</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">row: [el </span><span class="s0">for </span><span class="s1">el </span><span class="s0">in </span><span class="s1">row[</span><span class="s2">&quot;x&quot;</span><span class="s1">] </span><span class="s0">if </span><span class="s1">el </span><span class="s0">in </span><span class="s1">row[</span><span class="s2">&quot;y&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([[]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;q&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=df.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_infer_output_shape_columns():</span>
    <span class="s3"># GH 18573</span>

    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;number&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;string&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="s1">: [</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2017-11-29 03:30:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2017-11-29 03:45:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">row: (row.number</span><span class="s0">, </span><span class="s1">row.string)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([(t.number</span><span class="s0">, </span><span class="s1">t.string) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_infer_output_shape_listlike_columns():</span>
    <span class="s3"># GH 16353</span>

    <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_infer_output_shape_listlike_columns_np_func(val):</span>
    <span class="s3"># GH 17970</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">row: np.ones(val)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([np.ones(val) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()]</span><span class="s0">, </span><span class="s1">index=df.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_infer_output_shape_listlike_columns_with_timestamp():</span>
    <span class="s3"># GH 17892</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2010-02-01&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2010-02-04&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2010-02-05&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s2">&quot;2010-02-06&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">9</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;d&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">fun(x):</span>
        <span class="s0">return </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s1">result = df.apply(fun</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;lst&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
<span class="s0">def </span><span class="s1">test_consistent_coerce_for_shapes(lst):</span>
    <span class="s3"># we want column names to NOT be propagated</span>
    <span class="s3"># just because the shape matches the input shape</span>
    <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: lst</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([lst </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_consistent_names(int_frame_const_col):</span>
    <span class="s3"># if a Series is returned, we should use the resulting index names</span>
    <span class="s1">df = int_frame_const_col</span>

    <span class="s1">result = df.apply(</span>
        <span class="s0">lambda </span><span class="s1">x: Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s2">&quot;other&quot;</span><span class="s0">, </span><span class="s2">&quot;cols&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span>
    <span class="s1">)</span>
    <span class="s1">expected = int_frame_const_col.rename(</span>
        <span class="s1">columns={</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s2">&quot;other&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: </span><span class="s2">&quot;cols&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s2">&quot;other&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = expected[[</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s2">&quot;other&quot;</span><span class="s1">]]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_result_type(int_frame_const_col):</span>
    <span class="s3"># result_type should be consistent no matter which</span>
    <span class="s3"># path we take in the code</span>
    <span class="s1">df = int_frame_const_col</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected.columns = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_result_type_shorter_list(int_frame_const_col):</span>
    <span class="s3"># result_type should be consistent no matter which</span>
    <span class="s3"># path we take in the code</span>
    <span class="s1">df = int_frame_const_col</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">expected = df[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]].copy()</span>
    <span class="s1">expected.columns = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_result_type_broadcast(int_frame_const_col):</span>
    <span class="s3"># result_type should be consistent no matter which</span>
    <span class="s3"># path we take in the code</span>
    <span class="s1">df = int_frame_const_col</span>
    <span class="s3"># broadcast result</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_result_type_broadcast_series_func(int_frame_const_col):</span>
    <span class="s3"># result_type should be consistent no matter which</span>
    <span class="s3"># path we take in the code</span>
    <span class="s1">df = int_frame_const_col</span>
    <span class="s1">columns = [</span><span class="s2">&quot;other&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;names&quot;</span><span class="s1">]</span>
    <span class="s1">result = df.apply(</span>
        <span class="s0">lambda </span><span class="s1">x: Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=columns)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;broadcast&quot;</span>
    <span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_result_type_series_result(int_frame_const_col):</span>
    <span class="s3"># result_type should be consistent no matter which</span>
    <span class="s3"># path we take in the code</span>
    <span class="s1">df = int_frame_const_col</span>
    <span class="s3"># series result</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=x.index)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_result_type_series_result_other_index(int_frame_const_col):</span>
    <span class="s3"># result_type should be consistent no matter which</span>
    <span class="s3"># path we take in the code</span>
    <span class="s1">df = int_frame_const_col</span>
    <span class="s3"># series result with other index</span>
    <span class="s1">columns = [</span><span class="s2">&quot;other&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;names&quot;</span><span class="s1">]</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=columns)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected.columns = columns</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;box&quot;</span><span class="s0">,</span>
    <span class="s1">[</span><span class="s0">lambda </span><span class="s1">x: list(x)</span><span class="s0">, lambda </span><span class="s1">x: tuple(x)</span><span class="s0">, lambda </span><span class="s1">x: np.array(x</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">ids=[</span><span class="s2">&quot;list&quot;</span><span class="s0">, </span><span class="s2">&quot;tuple&quot;</span><span class="s0">, </span><span class="s2">&quot;array&quot;</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_consistency_for_boxed(box</span><span class="s0">, </span><span class="s1">int_frame_const_col):</span>
    <span class="s3"># passing an array or list should not affect the output shape</span>
    <span class="s1">df = int_frame_const_col</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: box([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([box([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df.itertuples()])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: box([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;expand&quot;</span><span class="s1">)</span>
    <span class="s1">expected = int_frame_const_col[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]].rename(columns={</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s4">0</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_agg_transform(axis</span><span class="s0">, </span><span class="s1">float_frame):</span>
    <span class="s1">other_axis = </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">{</span><span class="s4">0</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">} </span><span class="s0">else </span><span class="s4">0</span>

    <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s2">&quot;ignore&quot;</span><span class="s1">):</span>

        <span class="s1">f_abs = np.abs(float_frame)</span>
        <span class="s1">f_sqrt = np.sqrt(float_frame)</span>

        <span class="s3"># ufunc</span>
        <span class="s1">expected = f_sqrt.copy()</span>
        <span class="s1">result = float_frame.apply(np.sqrt</span><span class="s0">, </span><span class="s1">axis=axis)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s3"># list-like</span>
        <span class="s1">result = float_frame.apply([np.sqrt]</span><span class="s0">, </span><span class="s1">axis=axis)</span>
        <span class="s1">expected = f_sqrt.copy()</span>
        <span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">{</span><span class="s4">0</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">}:</span>
            <span class="s1">expected.columns = MultiIndex.from_product([float_frame.columns</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;sqrt&quot;</span><span class="s1">]])</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">expected.index = MultiIndex.from_product([float_frame.index</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;sqrt&quot;</span><span class="s1">]])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s3"># multiple items in list</span>
        <span class="s3"># these are in the order as if we are applying both</span>
        <span class="s3"># functions per series and then concatting</span>
        <span class="s1">result = float_frame.apply([np.abs</span><span class="s0">, </span><span class="s1">np.sqrt]</span><span class="s0">, </span><span class="s1">axis=axis)</span>
        <span class="s1">expected = zip_frames([f_abs</span><span class="s0">, </span><span class="s1">f_sqrt]</span><span class="s0">, </span><span class="s1">axis=other_axis)</span>
        <span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">{</span><span class="s4">0</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">}:</span>
            <span class="s1">expected.columns = MultiIndex.from_product(</span>
                <span class="s1">[float_frame.columns</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;absolute&quot;</span><span class="s0">, </span><span class="s2">&quot;sqrt&quot;</span><span class="s1">]]</span>
            <span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">expected.index = MultiIndex.from_product(</span>
                <span class="s1">[float_frame.index</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;absolute&quot;</span><span class="s0">, </span><span class="s2">&quot;sqrt&quot;</span><span class="s1">]]</span>
            <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_demo():</span>
    <span class="s3"># demonstration tests</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span>

    <span class="s1">result = df.agg([</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_demo_dict_agg():</span>
    <span class="s3"># demonstration tests</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span>
    <span class="s1">result = df.agg({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">]})</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">5.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">25.0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result.reindex_like(expected)</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_agg_with_name_as_column_name():</span>
    <span class="s3"># GH 36212 - Column name is &quot;name&quot;</span>
    <span class="s1">data = {</span><span class="s2">&quot;name&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]}</span>
    <span class="s1">df = DataFrame(data)</span>

    <span class="s3"># result's name should be None</span>
    <span class="s1">result = df.agg({</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;count&quot;</span><span class="s1">})</span>
    <span class="s1">expected = Series({</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">})</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Check if name is still preserved when aggregating series instead</span>
    <span class="s1">result = df[</span><span class="s2">&quot;name&quot;</span><span class="s1">].agg({</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;count&quot;</span><span class="s1">})</span>
    <span class="s1">expected = Series({</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">}</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;name&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_agg_multiple_mixed_no_warning():</span>
    <span class="s3"># GH 20909</span>
    <span class="s1">mdf = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">&quot;baz&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;D&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">6.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">&quot;foobarbaz&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;D&quot;</span><span class="s1">: [Timestamp(</span><span class="s2">&quot;2013-01-01&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.NaT]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s3"># sorted index</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(</span>
        <span class="s1">FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">r&quot;\['D'\] did not aggregate successfully&quot;</span>
    <span class="s1">):</span>
        <span class="s1">result = mdf.agg([</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">])</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(</span>
        <span class="s1">FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">r&quot;\['D'\] did not aggregate successfully&quot;</span>
    <span class="s1">):</span>
        <span class="s1">result = mdf[[</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]].agg([</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s1">])</span>

    <span class="s3"># GH40420: the result of .agg should have an index that is sorted</span>
    <span class="s3"># according to the arguments provided to agg.</span>
    <span class="s1">expected = expected[[</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]].reindex([</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_agg_reduce(axis</span><span class="s0">, </span><span class="s1">float_frame):</span>
    <span class="s1">other_axis = </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">{</span><span class="s4">0</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">} </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">name1</span><span class="s0">, </span><span class="s1">name2 = float_frame.axes[other_axis].unique()[:</span><span class="s4">2</span><span class="s1">].sort_values()</span>

    <span class="s3"># all reducers</span>
    <span class="s1">expected = pd.concat(</span>
        <span class="s1">[</span>
            <span class="s1">float_frame.mean(axis=axis)</span><span class="s0">,</span>
            <span class="s1">float_frame.max(axis=axis)</span><span class="s0">,</span>
            <span class="s1">float_frame.sum(axis=axis)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">axis=</span><span class="s4">1</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected.columns = [</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">]</span>
    <span class="s1">expected = expected.T </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">{</span><span class="s4">0</span><span class="s0">, </span><span class="s2">&quot;index&quot;</span><span class="s1">} </span><span class="s0">else </span><span class="s1">expected</span>

    <span class="s1">result = float_frame.agg([</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># dict input with scalars</span>
    <span class="s1">func = {name1: </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">name2: </span><span class="s2">&quot;sum&quot;</span><span class="s1">}</span>
    <span class="s1">result = float_frame.agg(func</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">[</span>
            <span class="s1">float_frame.loc(other_axis)[name1].mean()</span><span class="s0">,</span>
            <span class="s1">float_frame.loc(other_axis)[name2].sum()</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[name1</span><span class="s0">, </span><span class="s1">name2]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># dict input with lists</span>
    <span class="s1">func = {name1: [</span><span class="s2">&quot;mean&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name2: [</span><span class="s2">&quot;sum&quot;</span><span class="s1">]}</span>
    <span class="s1">result = float_frame.agg(func</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s1">name1: Series([float_frame.loc(other_axis)[name1].mean()]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;mean&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">name2: Series([float_frame.loc(other_axis)[name2].sum()]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;sum&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">expected = expected.T </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">{</span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;columns&quot;</span><span class="s1">} </span><span class="s0">else </span><span class="s1">expected</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># dict input with lists with multiple</span>
    <span class="s1">func = {name1: [</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name2: [</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">]}</span>
    <span class="s1">result = float_frame.agg(func</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s1">expected = pd.concat(</span>
        <span class="s1">{</span>
            <span class="s1">name1: Series(</span>
                <span class="s1">[</span>
                    <span class="s1">float_frame.loc(other_axis)[name1].mean()</span><span class="s0">,</span>
                    <span class="s1">float_frame.loc(other_axis)[name1].sum()</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">index=[</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">name2: Series(</span>
                <span class="s1">[</span>
                    <span class="s1">float_frame.loc(other_axis)[name2].sum()</span><span class="s0">,</span>
                    <span class="s1">float_frame.loc(other_axis)[name2].max()</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">index=[</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">axis=</span><span class="s4">1</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = expected.T </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">{</span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;columns&quot;</span><span class="s1">} </span><span class="s0">else </span><span class="s1">expected</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nuiscance_columns():</span>

    <span class="s3"># GH 15015</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">&quot;baz&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;D&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">result = df.agg(</span><span class="s2">&quot;min&quot;</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s2">&quot;20130101&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">index=df.columns)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.agg([</span><span class="s2">&quot;min&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s2">&quot;20130101&quot;</span><span class="s1">)]]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s2">&quot;min&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=df.columns</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Select only valid&quot;</span><span class="s1">):</span>
        <span class="s1">result = df.agg(</span><span class="s2">&quot;sum&quot;</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s4">6</span><span class="s0">, </span><span class="s4">6.0</span><span class="s0">, </span><span class="s2">&quot;foobarbaz&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(</span>
        <span class="s1">FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">r&quot;\['D'\] did not aggregate successfully&quot;</span>
    <span class="s1">):</span>
        <span class="s1">result = df.agg([</span><span class="s2">&quot;sum&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">6.0</span><span class="s0">, </span><span class="s2">&quot;foobarbaz&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;sum&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;how&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;agg&quot;</span><span class="s0">, </span><span class="s2">&quot;apply&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_non_callable_aggregates(how):</span>

    <span class="s3"># GH 16405</span>
    <span class="s3"># 'size' is a property of frame/series</span>
    <span class="s3"># validate that this is working</span>
    <span class="s3"># GH 39116 - expand to apply</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s0">None, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s0">, None, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]}</span>
    <span class="s1">)</span>

    <span class="s3"># Function aggregate</span>
    <span class="s1">result = getattr(df</span><span class="s0">, </span><span class="s1">how)({</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s2">&quot;count&quot;</span><span class="s1">})</span>
    <span class="s1">expected = Series({</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">})</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Non-function aggregate</span>
    <span class="s1">result = getattr(df</span><span class="s0">, </span><span class="s1">how)({</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s2">&quot;size&quot;</span><span class="s1">})</span>
    <span class="s1">expected = Series({</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">})</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s3"># Mix function and non-function aggs</span>
    <span class="s1">result1 = getattr(df</span><span class="s0">, </span><span class="s1">how)([</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">])</span>
    <span class="s1">result2 = getattr(df</span><span class="s0">, </span><span class="s1">how)(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">]}</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;A&quot;</span><span class="s1">: {</span><span class="s2">&quot;count&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s2">&quot;B&quot;</span><span class="s1">: {</span><span class="s2">&quot;count&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s2">&quot;C&quot;</span><span class="s1">: {</span><span class="s2">&quot;count&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">result2</span><span class="s0">, </span><span class="s1">check_like=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_like=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s3"># Just functional string arg is same as calling df.arg()</span>
    <span class="s1">result = getattr(df</span><span class="s0">, </span><span class="s1">how)(</span><span class="s2">&quot;count&quot;</span><span class="s1">)</span>
    <span class="s1">expected = df.count()</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;how&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;agg&quot;</span><span class="s0">, </span><span class="s2">&quot;apply&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_size_as_str(how</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s3"># GH 39934</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s0">None, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s0">, None, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]}</span>
    <span class="s1">)</span>
    <span class="s3"># Just a string attribute arg same as calling df.arg</span>
    <span class="s3"># on the columns</span>
    <span class="s1">result = getattr(df</span><span class="s0">, </span><span class="s1">how)(</span><span class="s2">&quot;size&quot;</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s0">if </span><span class="s1">axis == </span><span class="s4">0 </span><span class="s0">or </span><span class="s1">axis == </span><span class="s2">&quot;index&quot;</span><span class="s1">:</span>
        <span class="s1">expected = Series(df.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=df.columns)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = Series(df.shape[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=df.index)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_agg_listlike_result():</span>
    <span class="s3"># GH-29587 user defined function returning list-likes</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1.5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">&quot;foo&quot;</span><span class="s0">, None, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]})</span>

    <span class="s0">def </span><span class="s1">func(group_col):</span>
        <span class="s0">return </span><span class="s1">list(group_col.dropna().unique())</span>

    <span class="s1">result = df.agg(func)</span>
    <span class="s1">expected = Series([[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.agg([func])</span>
    <span class="s1">expected = expected.to_frame(</span><span class="s2">&quot;func&quot;</span><span class="s1">).T</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;args, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s4">8</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(()</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(()</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(()</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s1">})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_agg_args_kwargs(axis</span><span class="s0">, </span><span class="s1">args</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s0">def </span><span class="s1">f(x</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c=</span><span class="s4">3</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">x.sum() + (a + b) / c</span>

    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]])</span>

    <span class="s0">if </span><span class="s1">axis == </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s1">expected = Series([</span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">7.0</span><span class="s1">])</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = Series([</span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">8.0</span><span class="s1">])</span>

    <span class="s1">result = df.agg(f</span><span class="s0">, </span><span class="s1">axis</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;num_cols&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_frequency_is_original(num_cols):</span>
    <span class="s3"># GH 22150</span>
    <span class="s1">index = pd.DatetimeIndex([</span><span class="s2">&quot;1950-06-30&quot;</span><span class="s0">, </span><span class="s2">&quot;1952-10-24&quot;</span><span class="s0">, </span><span class="s2">&quot;1953-05-29&quot;</span><span class="s1">])</span>
    <span class="s1">original = index.copy()</span>
    <span class="s1">df = DataFrame(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=range(num_cols))</span>
    <span class="s1">df.apply(</span><span class="s0">lambda </span><span class="s1">x: x)</span>
    <span class="s0">assert </span><span class="s1">index.freq == original.freq</span>


<span class="s0">def </span><span class="s1">test_apply_datetime_tz_issue():</span>
    <span class="s3"># GH 29052</span>

    <span class="s1">timestamps = [</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;2019-03-15 12:34:31.909000+0000&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;2019-03-15 12:34:34.359000+0000&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Timestamp(</span><span class="s2">&quot;2019-03-15 12:34:34.660000+0000&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;UTC&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">df = DataFrame(data=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=timestamps)</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x.name</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series(index=timestamps</span><span class="s0">, </span><span class="s1">data=timestamps)</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;df&quot;</span><span class="s0">, </span><span class="s1">[DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]})])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_consistency_of_aggregates_of_columns_with_missing_values(df</span><span class="s0">, </span><span class="s1">method):</span>
    <span class="s3"># GH 16832</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Select only valid&quot;</span><span class="s1">):</span>
        <span class="s1">none_in_first_column_result = getattr(df[[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">method)()</span>
        <span class="s1">none_in_second_column_result = getattr(df[[</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">method)()</span>

    <span class="s1">tm.assert_series_equal(none_in_first_column_result</span><span class="s0">, </span><span class="s1">none_in_second_column_result)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, True, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">np.nan])</span>
<span class="s0">def </span><span class="s1">test_apply_dtype(col):</span>
    <span class="s3"># GH 31466</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s1">col]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x.dtype)</span>
    <span class="s1">expected = df.dtypes</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_mutating(using_array_manager):</span>
    <span class="s3"># GH#35462 case where applied func pins a new BlockManager to a row</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: range(</span><span class="s4">100</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: range(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">200</span><span class="s1">)})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s0">def </span><span class="s1">func(row):</span>
        <span class="s1">mgr = row._mgr</span>
        <span class="s1">row.loc[</span><span class="s2">&quot;a&quot;</span><span class="s1">] += </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">row._mgr </span><span class="s0">is not </span><span class="s1">mgr</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s1">expected = df.copy()</span>
    <span class="s1">expected[</span><span class="s2">&quot;a&quot;</span><span class="s1">] += </span><span class="s4">1</span>

    <span class="s1">result = df.apply(func</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">if not </span><span class="s1">using_array_manager:</span>
        <span class="s3"># INFO(ArrayManager) With BlockManager, the row is a view and mutated in place,</span>
        <span class="s3"># with ArrayManager the row is not a view, and thus not mutated in place</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">result)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_apply_empty_list_reduce():</span>
    <span class="s3"># GH#35683 get columns correct</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: []</span><span class="s0">, </span><span class="s1">result_type=</span><span class="s2">&quot;reduce&quot;</span><span class="s1">)</span>
    <span class="s1">expected = Series({</span><span class="s2">&quot;a&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: []}</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_no_suffix_index():</span>
    <span class="s3"># GH36189</span>
    <span class="s1">pdf = DataFrame([[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]] * </span><span class="s4">3</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">result = pdf.apply([</span><span class="s2">&quot;sum&quot;</span><span class="s0">, lambda </span><span class="s1">x: x.sum()</span><span class="s0">, lambda </span><span class="s1">x: x.sum()])</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">27</span><span class="s0">, </span><span class="s4">27</span><span class="s0">, </span><span class="s4">27</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;&lt;lambda&gt;&quot;</span><span class="s0">, </span><span class="s2">&quot;&lt;lambda&gt;&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_raw_returns_string():</span>
    <span class="s3"># https://github.com/pandas-dev/pandas/issues/35940</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">&quot;aa&quot;</span><span class="s0">, </span><span class="s2">&quot;bbb&quot;</span><span class="s1">]})</span>
    <span class="s1">result = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s2">&quot;aa&quot;</span><span class="s0">, </span><span class="s2">&quot;bbb&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_aggregation_func_column_order():</span>
    <span class="s3"># GH40420: the result of .agg should have an index that is sorted</span>
    <span class="s3"># according to the arguments provided to agg.</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;3&quot;</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;4&quot;</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;5&quot;</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;6&quot;</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=(</span><span class="s2">&quot;item&quot;</span><span class="s0">, </span><span class="s2">&quot;att1&quot;</span><span class="s0">, </span><span class="s2">&quot;att2&quot;</span><span class="s0">, </span><span class="s2">&quot;att3&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">foo(s):</span>
        <span class="s0">return </span><span class="s1">s.sum() / </span><span class="s4">2</span>

    <span class="s1">aggs = [</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">foo</span><span class="s0">, </span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(</span>
        <span class="s1">FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">r&quot;\['item'\] did not aggregate successfully&quot;</span>
    <span class="s1">):</span>
        <span class="s1">result = df.agg(aggs)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;item&quot;</span><span class="s1">: [</span><span class="s2">&quot;123456&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s2">&quot;1&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;att1&quot;</span><span class="s1">: [</span><span class="s4">21.0</span><span class="s0">, </span><span class="s4">10.5</span><span class="s0">, </span><span class="s4">6.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;att2&quot;</span><span class="s1">: [</span><span class="s4">18.0</span><span class="s0">, </span><span class="s4">9.0</span><span class="s0">, </span><span class="s4">6.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;att3&quot;</span><span class="s1">: [</span><span class="s4">17.0</span><span class="s0">, </span><span class="s4">8.5</span><span class="s0">, </span><span class="s4">6.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_apply_getitem_axis_1():</span>
    <span class="s3"># GH 13427</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
    <span class="s1">result = df[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]].apply(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s4">0</span><span class="s1">] + x[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = Series([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nuisance_depr_passes_through_warnings():</span>
    <span class="s3"># GH 43740</span>
    <span class="s3"># DataFrame.agg with list-likes may emit warnings for both individual</span>
    <span class="s3"># args and for entire columns, but we only want to emit once. We</span>
    <span class="s3"># catch and suppress the warnings for individual args, but need to make</span>
    <span class="s3"># sure if some other warnings were raised, they get passed through to</span>
    <span class="s3"># the user.</span>

    <span class="s0">def </span><span class="s1">foo(x):</span>
        <span class="s1">warnings.warn(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">x.sum()</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]})</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Hello, World!&quot;</span><span class="s1">):</span>
        <span class="s1">df.agg([foo])</span>
</pre>
</body>
</html>