<html>
<head>
<title>test_timeseries_window.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_timeseries_window.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
    <span class="s1">to_datetime</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>

<span class="s0">import </span><span class="s1">pandas.tseries.offsets </span><span class="s0">as </span><span class="s1">offsets</span>


<span class="s0">class </span><span class="s1">TestRollingTS:</span>

    <span class="s2"># rolling time-series friendly</span>
    <span class="s2"># xref GH13327</span>

    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>

        <span class="s1">self.regular = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: range(</span><span class="s4">5</span><span class="s1">)}</span>
        <span class="s1">).set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>

        <span class="s1">self.ragged = DataFrame({</span><span class="s3">&quot;B&quot;</span><span class="s1">: range(</span><span class="s4">5</span><span class="s1">)})</span>
        <span class="s1">self.ragged.index = [</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:03&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:05&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:06&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_doc_string(self):</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=[</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:03&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:05&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:06&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df</span>
        <span class="s1">df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).sum()</span>

    <span class="s0">def </span><span class="s1">test_invalid_window_non_int(self):</span>

        <span class="s2"># not a valid freq</span>
        <span class="s1">msg = </span><span class="s3">&quot;passed window foobar is not compatible with a datetimelike index&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">self.regular.rolling(window=</span><span class="s3">&quot;foobar&quot;</span><span class="s1">)</span>
        <span class="s2"># not a datetimelike index</span>
        <span class="s1">msg = </span><span class="s3">&quot;window must be an integer&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">self.regular.reset_index().rolling(window=</span><span class="s3">&quot;foobar&quot;</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;freq&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;2MS&quot;</span><span class="s0">, </span><span class="s1">offsets.MonthBegin(</span><span class="s4">2</span><span class="s1">)])</span>
    <span class="s0">def </span><span class="s1">test_invalid_window_nonfixed(self</span><span class="s0">, </span><span class="s1">freq):</span>

        <span class="s2"># non-fixed freqs</span>
        <span class="s1">msg = </span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">&lt;2 </span><span class="s0">\\</span><span class="s3">* MonthBegins</span><span class="s0">\\</span><span class="s3">&gt; is a non-fixed frequency&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">self.regular.rolling(window=freq)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;freq&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;1D&quot;</span><span class="s0">, </span><span class="s1">offsets.Day(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;2ms&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_valid_window(self</span><span class="s0">, </span><span class="s1">freq):</span>
        <span class="s1">self.regular.rolling(window=freq)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;minp&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])])</span>
    <span class="s0">def </span><span class="s1">test_invalid_minp(self</span><span class="s0">, </span><span class="s1">minp):</span>
        <span class="s2"># non-integer min_periods</span>
        <span class="s1">msg = (</span>
            <span class="s3">r&quot;local variable 'minp' referenced before assignment|&quot;</span>
            <span class="s3">&quot;min_periods must be an integer&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">self.regular.rolling(window=</span><span class="s3">&quot;1D&quot;</span><span class="s0">, </span><span class="s1">min_periods=minp)</span>

    <span class="s0">def </span><span class="s1">test_on(self):</span>

        <span class="s1">df = self.regular</span>

        <span class="s2"># not a valid column</span>
        <span class="s1">msg = (</span>
            <span class="s3">r&quot;invalid on specified as foobar, must be a column &quot;</span>
            <span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">(of DataFrame</span><span class="s0">\\</span><span class="s3">), an Index or None&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;foobar&quot;</span><span class="s1">)</span>

        <span class="s2"># column is valid</span>
        <span class="s1">df = df.copy()</span>
        <span class="s1">df[</span><span class="s3">&quot;C&quot;</span><span class="s1">] = date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=len(df))</span>
        <span class="s1">df.rolling(window=</span><span class="s3">&quot;2d&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">).sum()</span>

        <span class="s2"># invalid columns</span>
        <span class="s1">msg = </span><span class="s3">&quot;window must be an integer&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.rolling(window=</span><span class="s3">&quot;2d&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;B&quot;</span><span class="s1">)</span>

        <span class="s2"># ok even though on non-selected</span>
        <span class="s1">df.rolling(window=</span><span class="s3">&quot;2d&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">).B.sum()</span>

    <span class="s0">def </span><span class="s1">test_monotonic_on(self):</span>

        <span class="s2"># on/index must be monotonic</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: range(</span><span class="s4">5</span><span class="s1">)}</span>
        <span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">df.A.is_monotonic</span>
        <span class="s1">df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s1">).sum()</span>

        <span class="s1">df = df.set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.index.is_monotonic</span>
        <span class="s1">df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).sum()</span>

    <span class="s0">def </span><span class="s1">test_non_monotonic_on(self):</span>
        <span class="s2"># GH 19248</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: range(</span><span class="s4">5</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">df = df.set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">non_monotonic_index = df.index.to_list()</span>
        <span class="s1">non_monotonic_index[</span><span class="s4">0</span><span class="s1">] = non_monotonic_index[</span><span class="s4">3</span><span class="s1">]</span>
        <span class="s1">df.index = non_monotonic_index</span>

        <span class="s0">assert not </span><span class="s1">df.index.is_monotonic</span>

        <span class="s1">msg = </span><span class="s3">&quot;index must be monotonic&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).sum()</span>

        <span class="s1">df = df.reset_index()</span>

        <span class="s1">msg = (</span>
            <span class="s3">r&quot;invalid on specified as A, must be a column &quot;</span>
            <span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">(of DataFrame</span><span class="s0">\\</span><span class="s3">), an Index or None&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s1">).sum()</span>

    <span class="s0">def </span><span class="s1">test_frame_on(self):</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;B&quot;</span><span class="s1">: range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;20130101 09:00:00&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;3s&quot;</span><span class="s1">)}</span>
        <span class="s1">)</span>

        <span class="s1">df[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = [</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:03&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:05&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:06&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span>

        <span class="s2"># we are doing simulating using 'on'</span>
        <span class="s1">expected = df.set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">).rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).B.sum().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s1">).B.sum()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s2"># test as a frame</span>
        <span class="s2"># we should be ignoring the 'on' as an aggregation column</span>
        <span class="s2"># note that the expected is setting, computing, and resetting</span>
        <span class="s2"># so the columns need to be switched compared</span>
        <span class="s2"># to the actual result where they are ordered as in the</span>
        <span class="s2"># original</span>
        <span class="s1">expected = (</span>
            <span class="s1">df.set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">).rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">)[[</span><span class="s3">&quot;B&quot;</span><span class="s1">]].sum().reset_index()[[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]]</span>
        <span class="s1">)</span>

        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s1">)[[</span><span class="s3">&quot;B&quot;</span><span class="s1">]].sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_frame_on2(self):</span>

        <span class="s2"># using multiple aggregation columns</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: Index(</span>
                    <span class="s1">[</span>
                        <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:00&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:03&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:05&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:06&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected1 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: df[</span><span class="s3">&quot;C&quot;</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">).sum()</span>
        <span class="s1">expected = expected1</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = Series([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">).B.sum()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = expected1[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]]</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;C&quot;</span><span class="s1">)[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]].sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic_regular(self):</span>

        <span class="s1">df = self.regular.copy()</span>

        <span class="s1">df.index = date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span>
        <span class="s1">expected = df.rolling(window=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1D&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df.index = date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;2D&quot;</span><span class="s1">)</span>
        <span class="s1">expected = df.rolling(window=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2D&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df.rolling(window=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2D&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df.rolling(window=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2D&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_min_periods(self):</span>

        <span class="s2"># compare for min_periods</span>
        <span class="s1">df = self.regular</span>

        <span class="s2"># these slightly different</span>
        <span class="s1">expected = df.rolling(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df.rolling(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_closed(self):</span>

        <span class="s2"># xref GH13965</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">] * </span><span class="s4">5</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=[</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:01&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:02&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:03&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:04&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Timestamp(</span><span class="s3">&quot;20130101 09:00:06&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s2"># closed must be 'right', 'left', 'both', 'neither'</span>
        <span class="s1">msg = </span><span class="s3">&quot;closed must be 'right', 'left', 'both' or 'neither'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">self.regular.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s3">&quot;blabla&quot;</span><span class="s1">)</span>

        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s3">&quot;right&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s2"># default should be 'right'</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s3">&quot;both&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = [np.nan</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s3">&quot;left&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = [np.nan</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">closed=</span><span class="s3">&quot;neither&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_sum(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">2</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;3s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;3s&quot;</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;4s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;4s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">3</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;5s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_mean(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).mean()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).mean()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">3.5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_median(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).median()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).median()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">3.5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_quantile(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).quantile(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).quantile(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1.5</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">3.5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_std(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).std(ddof=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">5</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).std(ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan] * </span><span class="s4">5</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;3s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).std(ddof=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s1">] + [</span><span class="s4">0.5</span><span class="s1">] * </span><span class="s4">4</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;5s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).std(ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan</span><span class="s0">, </span><span class="s4">0.707107</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.290994</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_var(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).var(ddof=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">5</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).var(ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan] * </span><span class="s4">5</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;3s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).var(ddof=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s1">] + [</span><span class="s4">0.25</span><span class="s1">] * </span><span class="s4">4</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;5s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).var(ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3.0</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_skew(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;3s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).skew()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan] * </span><span class="s4">5</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;5s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).skew()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan] * </span><span class="s4">2 </span><span class="s1">+ [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_kurt(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;3s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).kurt()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan] * </span><span class="s4">5</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;5s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).kurt()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan] * </span><span class="s4">4 </span><span class="s1">+ [-</span><span class="s4">1.2</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_count(self):</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).count()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = self.ragged</span>
        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s1">).count()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).count()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">2</span><span class="s1">).count()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_regular_min(self):</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span>
        <span class="s1">).set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;1s&quot;</span><span class="s1">).min()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]}</span>
        <span class="s1">).set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).min()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(</span><span class="s3">&quot;5s&quot;</span><span class="s1">).min()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_ragged_min(self):</span>

        <span class="s1">df = self.ragged</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).min()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).min()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;5s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).min()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_perf_min(self):</span>

        <span class="s1">N = </span><span class="s4">10000</span>

        <span class="s1">dfp = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;B&quot;</span><span class="s1">: np.random.randn(N)}</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=N</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">expected = dfp.rolling(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).min()</span>
        <span class="s1">result = dfp.rolling(</span><span class="s3">&quot;2s&quot;</span><span class="s1">).min()</span>
        <span class="s0">assert </span><span class="s1">((result - expected) &lt; </span><span class="s4">0.01</span><span class="s1">).all().bool()</span>

        <span class="s1">expected = dfp.rolling(</span><span class="s4">200</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).min()</span>
        <span class="s1">result = dfp.rolling(</span><span class="s3">&quot;200s&quot;</span><span class="s1">).min()</span>
        <span class="s0">assert </span><span class="s1">((result - expected) &lt; </span><span class="s4">0.01</span><span class="s1">).all().bool()</span>

    <span class="s0">def </span><span class="s1">test_ragged_max(self):</span>

        <span class="s1">df = self.ragged</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).max()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;2s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).max()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.rolling(window=</span><span class="s3">&quot;5s&quot;</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).max()</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;freq, op, result_data&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s3">&quot;ms&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;ms&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0 </span><span class="s1">/ </span><span class="s4">9</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;ms&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;s&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;s&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0 </span><span class="s1">/ </span><span class="s4">9</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;s&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0 </span><span class="s1">/ </span><span class="s4">9</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0 </span><span class="s1">/ </span><span class="s4">9</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0 </span><span class="s1">/ </span><span class="s4">9</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">] * </span><span class="s4">9 </span><span class="s1">+ [</span><span class="s4">2.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_freqs_ops(self</span><span class="s0">, </span><span class="s1">freq</span><span class="s0">, </span><span class="s1">op</span><span class="s0">, </span><span class="s1">result_data):</span>
        <span class="s2"># GH 21096</span>
        <span class="s1">index = date_range(start=</span><span class="s3">&quot;2018-1-1 01:00:00&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">f&quot;1</span><span class="s0">{</span><span class="s1">freq</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s1">s = Series(data=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">s.iloc[</span><span class="s4">1</span><span class="s1">] = np.nan</span>
        <span class="s1">s.iloc[-</span><span class="s4">1</span><span class="s1">] = </span><span class="s4">2</span>
        <span class="s1">result = getattr(s.rolling(window=</span><span class="s3">f&quot;10</span><span class="s0">{</span><span class="s1">freq</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">op)()</span>
        <span class="s1">expected = Series(data=result_data</span><span class="s0">, </span><span class="s1">index=index)</span>

        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s3">&quot;sum&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;mean&quot;</span><span class="s0">,</span>
            <span class="s1">pytest.param(</span>
                <span class="s3">&quot;count&quot;</span><span class="s0">,</span>
                <span class="s1">marks=pytest.mark.filterwarnings(</span><span class="s3">&quot;ignore:min_periods:FutureWarning&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;median&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;std&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;var&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;kurt&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;skew&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;min&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;max&quot;</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_all(self</span><span class="s0">, </span><span class="s1">f):</span>

        <span class="s2"># simple comparison of integer vs time-based windowing</span>
        <span class="s1">df = self.regular * </span><span class="s4">2</span>
        <span class="s1">er = df.rolling(window=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">r = df.rolling(window=</span><span class="s3">&quot;1s&quot;</span><span class="s1">)</span>

        <span class="s1">result = getattr(r</span><span class="s0">, </span><span class="s1">f)()</span>
        <span class="s1">expected = getattr(er</span><span class="s0">, </span><span class="s1">f)()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = r.quantile(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">expected = er.quantile(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_all2(self</span><span class="s0">, </span><span class="s1">arithmetic_win_operators):</span>
        <span class="s1">f = arithmetic_win_operators</span>
        <span class="s2"># more sophisticated comparison of integer vs.</span>
        <span class="s2"># time-based windowing</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;B&quot;</span><span class="s1">: np.arange(</span><span class="s4">50</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">index=date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">50</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;H&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s2"># in-range data</span>
        <span class="s1">dft = df.between_time(</span><span class="s3">&quot;09:00&quot;</span><span class="s0">, </span><span class="s3">&quot;16:00&quot;</span><span class="s1">)</span>

        <span class="s1">r = dft.rolling(window=</span><span class="s3">&quot;5H&quot;</span><span class="s1">)</span>

        <span class="s1">result = getattr(r</span><span class="s0">, </span><span class="s1">f)()</span>

        <span class="s2"># we need to roll the days separately</span>
        <span class="s2"># to compare with a time-based roll</span>
        <span class="s2"># finally groupby-apply will return a multi-index</span>
        <span class="s2"># so we need to drop the day</span>
        <span class="s0">def </span><span class="s1">agg_by_day(x):</span>
            <span class="s1">x = x.between_time(</span><span class="s3">&quot;09:00&quot;</span><span class="s0">, </span><span class="s3">&quot;16:00&quot;</span><span class="s1">)</span>
            <span class="s0">return </span><span class="s1">getattr(x.rolling(</span><span class="s4">5</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">f)()</span>

        <span class="s1">expected = (</span>
            <span class="s1">df.groupby(df.index.day).apply(agg_by_day).reset_index(level=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_groupby_monotonic(self):</span>

        <span class="s2"># GH 15130</span>
        <span class="s2"># we don't need to validate monotonicity when grouping</span>

        <span class="s2"># GH 43909 we should raise an error here to match</span>
        <span class="s2"># behaviour of non-groupby rolling.</span>

        <span class="s1">data = [</span>
            <span class="s1">[</span><span class="s3">&quot;David&quot;</span><span class="s0">, </span><span class="s3">&quot;1/1/2015&quot;</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;David&quot;</span><span class="s0">, </span><span class="s3">&quot;1/5/2015&quot;</span><span class="s0">, </span><span class="s4">500</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;David&quot;</span><span class="s0">, </span><span class="s3">&quot;5/30/2015&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;David&quot;</span><span class="s0">, </span><span class="s3">&quot;7/25/2015&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;Ryan&quot;</span><span class="s0">, </span><span class="s3">&quot;1/4/2014&quot;</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;Ryan&quot;</span><span class="s0">, </span><span class="s3">&quot;1/19/2015&quot;</span><span class="s0">, </span><span class="s4">500</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;Ryan&quot;</span><span class="s0">, </span><span class="s3">&quot;3/31/2016&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;Joe&quot;</span><span class="s0">, </span><span class="s3">&quot;7/1/2015&quot;</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;Joe&quot;</span><span class="s0">, </span><span class="s3">&quot;9/9/2015&quot;</span><span class="s0">, </span><span class="s4">500</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;Joe&quot;</span><span class="s0">, </span><span class="s3">&quot;10/15/2015&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>

        <span class="s1">df = DataFrame(data=data</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;name&quot;</span><span class="s0">, </span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;amount&quot;</span><span class="s1">])</span>
        <span class="s1">df[</span><span class="s3">&quot;date&quot;</span><span class="s1">] = to_datetime(df[</span><span class="s3">&quot;date&quot;</span><span class="s1">])</span>
        <span class="s1">df = df.sort_values(</span><span class="s3">&quot;date&quot;</span><span class="s1">)</span>

        <span class="s1">expected = (</span>
            <span class="s1">df.set_index(</span><span class="s3">&quot;date&quot;</span><span class="s1">)</span>
            <span class="s1">.groupby(</span><span class="s3">&quot;name&quot;</span><span class="s1">)</span>
            <span class="s1">.apply(</span><span class="s0">lambda </span><span class="s1">x: x.rolling(</span><span class="s3">&quot;180D&quot;</span><span class="s1">)[</span><span class="s3">&quot;amount&quot;</span><span class="s1">].sum())</span>
        <span class="s1">)</span>
        <span class="s1">result = df.groupby(</span><span class="s3">&quot;name&quot;</span><span class="s1">).rolling(</span><span class="s3">&quot;180D&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;date&quot;</span><span class="s1">)[</span><span class="s3">&quot;amount&quot;</span><span class="s1">].sum()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_non_monotonic_raises(self):</span>
        <span class="s2"># GH 13966 (similar to #15130, closed by #15175)</span>

        <span class="s2"># superseded by 43909</span>

        <span class="s1">dates = date_range(start=</span><span class="s3">&quot;2016-01-01 09:30:00&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">20</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;s&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">] * </span><span class="s4">20 </span><span class="s1">+ [</span><span class="s4">2</span><span class="s1">] * </span><span class="s4">12 </span><span class="s1">+ [</span><span class="s4">3</span><span class="s1">] * </span><span class="s4">8</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: np.concatenate((dates</span><span class="s0">, </span><span class="s1">dates))</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: np.arange(</span><span class="s4">40</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = (</span>
            <span class="s1">df.set_index(</span><span class="s3">&quot;B&quot;</span><span class="s1">).groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">).apply(</span><span class="s0">lambda </span><span class="s1">x: x.rolling(</span><span class="s3">&quot;4s&quot;</span><span class="s1">)[</span><span class="s3">&quot;C&quot;</span><span class="s1">].mean())</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;.* must be monotonic&quot;</span><span class="s1">):</span>
            <span class="s1">df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">).rolling(</span>
                <span class="s3">&quot;4s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;B&quot;</span>
            <span class="s1">).C.mean()  </span><span class="s2"># should raise for non-monotonic t series</span>

        <span class="s1">df2 = df.sort_values(</span><span class="s3">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">result = df2.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">).rolling(</span><span class="s3">&quot;4s&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;B&quot;</span><span class="s1">).C.mean()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_rolling_cov_offset(self):</span>
        <span class="s2"># GH16058</span>

        <span class="s1">idx = date_range(</span><span class="s3">&quot;2017-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">24</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;1h&quot;</span><span class="s1">)</span>
        <span class="s1">ss = Series(np.arange(len(idx))</span><span class="s0">, </span><span class="s1">index=idx)</span>

        <span class="s1">result = ss.rolling(</span><span class="s3">&quot;2h&quot;</span><span class="s1">).cov()</span>
        <span class="s1">expected = Series([np.nan] + [</span><span class="s4">0.5</span><span class="s1">] * (len(idx) - </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected2 = ss.rolling(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).cov()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected2)</span>

        <span class="s1">result = ss.rolling(</span><span class="s3">&quot;3h&quot;</span><span class="s1">).cov()</span>
        <span class="s1">expected = Series([np.nan</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">] + [</span><span class="s4">1.0</span><span class="s1">] * (len(idx) - </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected2 = ss.rolling(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s4">1</span><span class="s1">).cov()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected2)</span>

    <span class="s0">def </span><span class="s1">test_rolling_on_decreasing_index(self):</span>
        <span class="s2"># GH-19248, GH-32385</span>
        <span class="s1">index = [</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20190101 09:00:30&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20190101 09:00:27&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20190101 09:00:20&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20190101 09:00:18&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;20190101 09:00:10&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span>

        <span class="s1">df = DataFrame({</span><span class="s3">&quot;column&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;5s&quot;</span><span class="s1">).min()</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;column&quot;</span><span class="s1">: [</span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">6.0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_rolling_on_empty(self):</span>
        <span class="s2"># GH-32385</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;column&quot;</span><span class="s1">: []}</span><span class="s0">, </span><span class="s1">index=[])</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;5s&quot;</span><span class="s1">).min()</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;column&quot;</span><span class="s1">: []}</span><span class="s0">, </span><span class="s1">index=[])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_rolling_on_multi_index_level(self):</span>
        <span class="s2"># GH-15584</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;column&quot;</span><span class="s1">: range(</span><span class="s4">6</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_product(</span>
                <span class="s1">[date_range(</span><span class="s3">&quot;20190101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;seq&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df.rolling(</span><span class="s3">&quot;10d&quot;</span><span class="s0">, </span><span class="s1">on=df.index.get_level_values(</span><span class="s3">&quot;date&quot;</span><span class="s1">)).sum()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;column&quot;</span><span class="s1">: [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">6.0</span><span class="s0">, </span><span class="s4">10.0</span><span class="s0">, </span><span class="s4">15.0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=df.index</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>