<html>
<head>
<title>np_datetime.pyx</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
np_datetime.pyx</font>
</center></td></tr></table>
<pre><span class="s0">from cpython.datetime cimport (</span>
    <span class="s0">PyDateTime_DATE_GET_HOUR,</span>
    <span class="s0">PyDateTime_DATE_GET_MICROSECOND,</span>
    <span class="s0">PyDateTime_DATE_GET_MINUTE,</span>
    <span class="s0">PyDateTime_DATE_GET_SECOND,</span>
    <span class="s0">PyDateTime_GET_DAY,</span>
    <span class="s0">PyDateTime_GET_MONTH,</span>
    <span class="s0">PyDateTime_GET_YEAR,</span>
    <span class="s0">PyDateTime_IMPORT,</span>
<span class="s0">)</span>
<span class="s0">from cpython.object cimport (</span>
    <span class="s0">Py_EQ,</span>
    <span class="s0">Py_GE,</span>
    <span class="s0">Py_GT,</span>
    <span class="s0">Py_LE,</span>
    <span class="s0">Py_LT,</span>
    <span class="s0">Py_NE,</span>
<span class="s0">)</span>

<span class="s0">PyDateTime_IMPORT</span>

<span class="s0">from numpy cimport int64_t</span>

<span class="s0">from pandas._libs.tslibs.util cimport get_c_string_buf_and_size</span>


<span class="s0">cdef extern from &quot;src/datetime/np_datetime.h&quot;:</span>
    <span class="s0">int cmp_npy_datetimestruct(npy_datetimestruct *a,</span>
                               <span class="s0">npy_datetimestruct *b)</span>

    <span class="s0">npy_datetime npy_datetimestruct_to_datetime(NPY_DATETIMEUNIT fr,</span>
                                                <span class="s0">npy_datetimestruct *d) nogil</span>

    <span class="s0">void pandas_datetime_to_datetimestruct(npy_datetime val,</span>
                                           <span class="s0">NPY_DATETIMEUNIT fr,</span>
                                           <span class="s0">npy_datetimestruct *result) nogil</span>

    <span class="s0">void pandas_timedelta_to_timedeltastruct(npy_timedelta val,</span>
                                             <span class="s0">NPY_DATETIMEUNIT fr,</span>
                                             <span class="s0">pandas_timedeltastruct *result</span>
                                             <span class="s0">) nogil</span>

    <span class="s0">npy_datetimestruct _NS_MIN_DTS, _NS_MAX_DTS</span>

<span class="s0">cdef extern from &quot;src/datetime/np_datetime_strings.h&quot;:</span>
    <span class="s0">int parse_iso_8601_datetime(const char *str, int len, int want_exc,</span>
                                <span class="s0">npy_datetimestruct *out,</span>
                                <span class="s0">int *out_local, int *out_tzoffset)</span>


<span class="s0"># ----------------------------------------------------------------------</span>
<span class="s0"># numpy object inspection</span>

<span class="s0">cdef inline npy_datetime get_datetime64_value(object obj) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">returns the int64 value underlying scalar numpy datetime64 object</span>

    <span class="s0">Note that to interpret this as a datetime, the corresponding unit is</span>
    <span class="s0">also needed.  That can be found using `get_datetime64_unit`.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">return (&lt;PyDatetimeScalarObject*&gt;obj).obval</span>


<span class="s0">cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">returns the int64 value underlying scalar numpy timedelta64 object</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">return (&lt;PyTimedeltaScalarObject*&gt;obj).obval</span>


<span class="s0">cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">returns the unit part of the dtype for a numpy datetime64 object.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">return &lt;NPY_DATETIMEUNIT&gt;(&lt;PyDatetimeScalarObject*&gt;obj).obmeta.base</span>

<span class="s0"># ----------------------------------------------------------------------</span>
<span class="s0"># Comparison</span>


<span class="s0">cdef inline bint cmp_scalar(int64_t lhs, int64_t rhs, int op) except -1:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">cmp_scalar is a more performant version of PyObject_RichCompare</span>
    <span class="s0">typed for int64_t arguments.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">if op == Py_EQ:</span>
        <span class="s0">return lhs == rhs</span>
    <span class="s0">elif op == Py_NE:</span>
        <span class="s0">return lhs != rhs</span>
    <span class="s0">elif op == Py_LT:</span>
        <span class="s0">return lhs &lt; rhs</span>
    <span class="s0">elif op == Py_LE:</span>
        <span class="s0">return lhs &lt;= rhs</span>
    <span class="s0">elif op == Py_GT:</span>
        <span class="s0">return lhs &gt; rhs</span>
    <span class="s0">elif op == Py_GE:</span>
        <span class="s0">return lhs &gt;= rhs</span>


<span class="s0">class OutOfBoundsDatetime(ValueError):</span>
    <span class="s0">pass</span>


<span class="s0">cdef inline check_dts_bounds(npy_datetimestruct *dts):</span>
    <span class="s0">&quot;&quot;&quot;Raises OutOfBoundsDatetime if the given date is outside the range that</span>
    <span class="s0">can be represented by nanosecond-resolution 64-bit integers.&quot;&quot;&quot;</span>
    <span class="s0">cdef:</span>
        <span class="s0">bint error = False</span>

    <span class="s0">if (dts.year &lt;= 1677 and</span>
            <span class="s0">cmp_npy_datetimestruct(dts, &amp;_NS_MIN_DTS) == -1):</span>
        <span class="s0">error = True</span>
    <span class="s0">elif (dts.year &gt;= 2262 and</span>
          <span class="s0">cmp_npy_datetimestruct(dts, &amp;_NS_MAX_DTS) == 1):</span>
        <span class="s0">error = True</span>

    <span class="s0">if error:</span>
        <span class="s0">fmt = (f'{dts.year}-{dts.month:02d}-{dts.day:02d} '</span>
               <span class="s0">f'{dts.hour:02d}:{dts.min:02d}:{dts.sec:02d}')</span>
        <span class="s0">raise OutOfBoundsDatetime(f'Out of bounds nanosecond timestamp: {fmt}')</span>


<span class="s0"># ----------------------------------------------------------------------</span>
<span class="s0"># Conversion</span>

<span class="s0">cdef inline int64_t dtstruct_to_dt64(npy_datetimestruct* dts) nogil:</span>
    <span class="s0">&quot;&quot;&quot;Convenience function to call npy_datetimestruct_to_datetime</span>
    <span class="s0">with the by-far-most-common frequency NPY_FR_ns&quot;&quot;&quot;</span>
    <span class="s0">return npy_datetimestruct_to_datetime(NPY_FR_ns, dts)</span>


<span class="s0">cdef inline void dt64_to_dtstruct(int64_t dt64,</span>
                                  <span class="s0">npy_datetimestruct* out) nogil:</span>
    <span class="s0">&quot;&quot;&quot;Convenience function to call pandas_datetime_to_datetimestruct</span>
    <span class="s0">with the by-far-most-common frequency NPY_FR_ns&quot;&quot;&quot;</span>
    <span class="s0">pandas_datetime_to_datetimestruct(dt64, NPY_FR_ns, out)</span>
    <span class="s0">return</span>


<span class="s0">cdef inline void td64_to_tdstruct(int64_t td64,</span>
                                  <span class="s0">pandas_timedeltastruct* out) nogil:</span>
    <span class="s0">&quot;&quot;&quot;Convenience function to call pandas_timedelta_to_timedeltastruct</span>
    <span class="s0">with the by-far-most-common frequency NPY_FR_ns&quot;&quot;&quot;</span>
    <span class="s0">pandas_timedelta_to_timedeltastruct(td64, NPY_FR_ns, out)</span>
    <span class="s0">return</span>


<span class="s0">cdef inline int64_t pydatetime_to_dt64(datetime val,</span>
                                       <span class="s0">npy_datetimestruct *dts):</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Note we are assuming that the datetime object is timezone-naive.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">dts.year = PyDateTime_GET_YEAR(val)</span>
    <span class="s0">dts.month = PyDateTime_GET_MONTH(val)</span>
    <span class="s0">dts.day = PyDateTime_GET_DAY(val)</span>
    <span class="s0">dts.hour = PyDateTime_DATE_GET_HOUR(val)</span>
    <span class="s0">dts.min = PyDateTime_DATE_GET_MINUTE(val)</span>
    <span class="s0">dts.sec = PyDateTime_DATE_GET_SECOND(val)</span>
    <span class="s0">dts.us = PyDateTime_DATE_GET_MICROSECOND(val)</span>
    <span class="s0">dts.ps = dts.as = 0</span>
    <span class="s0">return dtstruct_to_dt64(dts)</span>


<span class="s0">cdef inline void pydate_to_dtstruct(date val, npy_datetimestruct *dts):</span>
    <span class="s0">dts.year = PyDateTime_GET_YEAR(val)</span>
    <span class="s0">dts.month = PyDateTime_GET_MONTH(val)</span>
    <span class="s0">dts.day = PyDateTime_GET_DAY(val)</span>
    <span class="s0">dts.hour = dts.min = dts.sec = dts.us = 0</span>
    <span class="s0">dts.ps = dts.as = 0</span>
    <span class="s0">return</span>

<span class="s0">cdef inline int64_t pydate_to_dt64(date val, npy_datetimestruct *dts):</span>
    <span class="s0">pydate_to_dtstruct(val, dts)</span>
    <span class="s0">return dtstruct_to_dt64(dts)</span>


<span class="s0">cdef inline int _string_to_dts(str val, npy_datetimestruct* dts,</span>
                               <span class="s0">int* out_local, int* out_tzoffset,</span>
                               <span class="s0">bint want_exc) except? -1:</span>
    <span class="s0">cdef:</span>
        <span class="s0">Py_ssize_t length</span>
        <span class="s0">const char* buf</span>

    <span class="s0">buf = get_c_string_buf_and_size(val, &amp;length)</span>
    <span class="s0">return parse_iso_8601_datetime(buf, length, want_exc,</span>
                                   <span class="s0">dts, out_local, out_tzoffset)</span>
</pre>
</body>
</html>