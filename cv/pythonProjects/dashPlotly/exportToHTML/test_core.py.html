<html>
<head>
<title>test_core.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_core.py</font>
</center></td></tr></table>
<pre><span class="s0"># pylint: disable-msg=W0400,W0511,W0611,W0612,W0614,R0201,E1102</span>
<span class="s2">&quot;&quot;&quot;Tests suite for MaskedArray &amp; subclassing. 
 
:author: Pierre Gerard-Marchant 
:contact: pierregm_at_uga_dot_edu 
&quot;&quot;&quot;</span>
<span class="s1">__author__ = </span><span class="s3">&quot;Pierre GF Gerard-Marchant&quot;</span>

<span class="s4">import </span><span class="s1">sys</span>
<span class="s4">import </span><span class="s1">warnings</span>
<span class="s4">import </span><span class="s1">operator</span>
<span class="s4">import </span><span class="s1">itertools</span>
<span class="s4">import </span><span class="s1">textwrap</span>
<span class="s4">import </span><span class="s1">pytest</span>

<span class="s4">from </span><span class="s1">functools </span><span class="s4">import </span><span class="s1">reduce</span>


<span class="s4">import </span><span class="s1">numpy </span><span class="s4">as </span><span class="s1">np</span>
<span class="s4">import </span><span class="s1">numpy.ma.core</span>
<span class="s4">import </span><span class="s1">numpy.core.fromnumeric </span><span class="s4">as </span><span class="s1">fromnumeric</span>
<span class="s4">import </span><span class="s1">numpy.core.umath </span><span class="s4">as </span><span class="s1">umath</span>
<span class="s4">from </span><span class="s1">numpy.testing </span><span class="s4">import </span><span class="s1">(</span>
    <span class="s1">assert_raises</span><span class="s4">, </span><span class="s1">assert_warns</span><span class="s4">, </span><span class="s1">suppress_warnings</span>
    <span class="s1">)</span>
<span class="s4">from </span><span class="s1">numpy </span><span class="s4">import </span><span class="s1">ndarray</span>
<span class="s4">from </span><span class="s1">numpy.compat </span><span class="s4">import </span><span class="s1">asbytes</span>
<span class="s4">from </span><span class="s1">numpy.ma.testutils </span><span class="s4">import </span><span class="s1">(</span>
    <span class="s1">assert_</span><span class="s4">, </span><span class="s1">assert_array_equal</span><span class="s4">, </span><span class="s1">assert_equal</span><span class="s4">, </span><span class="s1">assert_almost_equal</span><span class="s4">,</span>
    <span class="s1">assert_equal_records</span><span class="s4">, </span><span class="s1">fail_if_equal</span><span class="s4">, </span><span class="s1">assert_not_equal</span><span class="s4">,</span>
    <span class="s1">assert_mask_equal</span>
    <span class="s1">)</span>
<span class="s4">from </span><span class="s1">numpy.ma.core </span><span class="s4">import </span><span class="s1">(</span>
    <span class="s1">MAError</span><span class="s4">, </span><span class="s1">MaskError</span><span class="s4">, </span><span class="s1">MaskType</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">, </span><span class="s1">abs</span><span class="s4">, </span><span class="s1">absolute</span><span class="s4">, </span><span class="s1">add</span><span class="s4">, </span><span class="s1">all</span><span class="s4">,</span>
    <span class="s1">allclose</span><span class="s4">, </span><span class="s1">allequal</span><span class="s4">, </span><span class="s1">alltrue</span><span class="s4">, </span><span class="s1">angle</span><span class="s4">, </span><span class="s1">anom</span><span class="s4">, </span><span class="s1">arange</span><span class="s4">, </span><span class="s1">arccos</span><span class="s4">, </span><span class="s1">arccosh</span><span class="s4">, </span><span class="s1">arctan2</span><span class="s4">,</span>
    <span class="s1">arcsin</span><span class="s4">, </span><span class="s1">arctan</span><span class="s4">, </span><span class="s1">argsort</span><span class="s4">, </span><span class="s1">array</span><span class="s4">, </span><span class="s1">asarray</span><span class="s4">, </span><span class="s1">choose</span><span class="s4">, </span><span class="s1">concatenate</span><span class="s4">,</span>
    <span class="s1">conjugate</span><span class="s4">, </span><span class="s1">cos</span><span class="s4">, </span><span class="s1">cosh</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">default_fill_value</span><span class="s4">, </span><span class="s1">diag</span><span class="s4">, </span><span class="s1">divide</span><span class="s4">, </span><span class="s1">doc_note</span><span class="s4">,</span>
    <span class="s1">empty</span><span class="s4">, </span><span class="s1">empty_like</span><span class="s4">, </span><span class="s1">equal</span><span class="s4">, </span><span class="s1">exp</span><span class="s4">, </span><span class="s1">flatten_mask</span><span class="s4">, </span><span class="s1">filled</span><span class="s4">, </span><span class="s1">fix_invalid</span><span class="s4">,</span>
    <span class="s1">flatten_structured_array</span><span class="s4">, </span><span class="s1">fromflex</span><span class="s4">, </span><span class="s1">getmask</span><span class="s4">, </span><span class="s1">getmaskarray</span><span class="s4">, </span><span class="s1">greater</span><span class="s4">,</span>
    <span class="s1">greater_equal</span><span class="s4">, </span><span class="s1">identity</span><span class="s4">, </span><span class="s1">inner</span><span class="s4">, </span><span class="s1">isMaskedArray</span><span class="s4">, </span><span class="s1">less</span><span class="s4">, </span><span class="s1">less_equal</span><span class="s4">, </span><span class="s1">log</span><span class="s4">,</span>
    <span class="s1">log10</span><span class="s4">, </span><span class="s1">make_mask</span><span class="s4">, </span><span class="s1">make_mask_descr</span><span class="s4">, </span><span class="s1">mask_or</span><span class="s4">, </span><span class="s1">masked</span><span class="s4">, </span><span class="s1">masked_array</span><span class="s4">,</span>
    <span class="s1">masked_equal</span><span class="s4">, </span><span class="s1">masked_greater</span><span class="s4">, </span><span class="s1">masked_greater_equal</span><span class="s4">, </span><span class="s1">masked_inside</span><span class="s4">,</span>
    <span class="s1">masked_less</span><span class="s4">, </span><span class="s1">masked_less_equal</span><span class="s4">, </span><span class="s1">masked_not_equal</span><span class="s4">, </span><span class="s1">masked_outside</span><span class="s4">,</span>
    <span class="s1">masked_print_option</span><span class="s4">, </span><span class="s1">masked_values</span><span class="s4">, </span><span class="s1">masked_where</span><span class="s4">, </span><span class="s1">max</span><span class="s4">, </span><span class="s1">maximum</span><span class="s4">,</span>
    <span class="s1">maximum_fill_value</span><span class="s4">, </span><span class="s1">min</span><span class="s4">, </span><span class="s1">minimum</span><span class="s4">, </span><span class="s1">minimum_fill_value</span><span class="s4">, </span><span class="s1">mod</span><span class="s4">, </span><span class="s1">multiply</span><span class="s4">,</span>
    <span class="s1">mvoid</span><span class="s4">, </span><span class="s1">nomask</span><span class="s4">, </span><span class="s1">not_equal</span><span class="s4">, </span><span class="s1">ones</span><span class="s4">, </span><span class="s1">ones_like</span><span class="s4">, </span><span class="s1">outer</span><span class="s4">, </span><span class="s1">power</span><span class="s4">, </span><span class="s1">product</span><span class="s4">, </span><span class="s1">put</span><span class="s4">,</span>
    <span class="s1">putmask</span><span class="s4">, </span><span class="s1">ravel</span><span class="s4">, </span><span class="s1">repeat</span><span class="s4">, </span><span class="s1">reshape</span><span class="s4">, </span><span class="s1">resize</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">sin</span><span class="s4">, </span><span class="s1">sinh</span><span class="s4">, </span><span class="s1">sometrue</span><span class="s4">, </span><span class="s1">sort</span><span class="s4">,</span>
    <span class="s1">sqrt</span><span class="s4">, </span><span class="s1">subtract</span><span class="s4">, </span><span class="s1">sum</span><span class="s4">, </span><span class="s1">take</span><span class="s4">, </span><span class="s1">tan</span><span class="s4">, </span><span class="s1">tanh</span><span class="s4">, </span><span class="s1">transpose</span><span class="s4">, </span><span class="s1">where</span><span class="s4">, </span><span class="s1">zeros</span><span class="s4">, </span><span class="s1">zeros_like</span><span class="s4">,</span>
    <span class="s1">)</span>
<span class="s4">from </span><span class="s1">numpy.compat </span><span class="s4">import </span><span class="s1">pickle</span>

<span class="s1">pi = np.pi</span>


<span class="s1">suppress_copy_mask_on_assignment = suppress_warnings()</span>
<span class="s1">suppress_copy_mask_on_assignment.filter(</span>
    <span class="s1">numpy.ma.core.MaskedArrayFutureWarning</span><span class="s4">,</span>
    <span class="s3">&quot;setting an item on a masked array which has a shared mask will not copy&quot;</span><span class="s1">)</span>


<span class="s0"># For parametrized numeric testing</span>
<span class="s1">num_dts = [np.dtype(dt_) </span><span class="s4">for </span><span class="s1">dt_ </span><span class="s4">in </span><span class="s3">'?bhilqBHILQefdgFD'</span><span class="s1">]</span>
<span class="s1">num_ids = [dt_.char </span><span class="s4">for </span><span class="s1">dt_ </span><span class="s4">in </span><span class="s1">num_dts]</span>


<span class="s4">class </span><span class="s1">TestMaskedArray:</span>
    <span class="s0"># Base test class for MaskedArrays.</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s0"># Base data definition.</span>
        <span class="s1">x = np.array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2.</span><span class="s4">, </span><span class="s1">pi/</span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s5">5.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">a10 = </span><span class="s5">10.</span>
        <span class="s1">m1 = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">m2 = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">xm = masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1)</span>
        <span class="s1">ym = masked_array(y</span><span class="s4">, </span><span class="s1">mask=m2)</span>
        <span class="s1">z = np.array([-</span><span class="s5">.5</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">.5</span><span class="s4">, </span><span class="s5">.8</span><span class="s1">])</span>
        <span class="s1">zm = masked_array(z</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">xf = np.where(m1</span><span class="s4">, </span><span class="s5">1e+20</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">xm.set_fill_value(</span><span class="s5">1e+20</span><span class="s1">)</span>
        <span class="s1">self.d = (x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf)</span>

    <span class="s4">def </span><span class="s1">test_basicattributes(self):</span>
        <span class="s0"># Tests some basic array attributes.</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.ndim</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(b.ndim</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.size</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(b.size</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">,</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_basic0d(self):</span>
        <span class="s0"># Checks masking a scalar</span>
        <span class="s1">x = masked_array(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(str(x)</span><span class="s4">, </span><span class="s3">'0'</span><span class="s1">)</span>
        <span class="s1">x = masked_array(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(str(x)</span><span class="s4">, </span><span class="s1">str(masked_print_option))</span>
        <span class="s1">x = masked_array(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(str(x)</span><span class="s4">, </span><span class="s3">'0'</span><span class="s1">)</span>
        <span class="s1">x = array(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">mask=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_(x.filled().dtype </span><span class="s4">is </span><span class="s1">x._data.dtype)</span>

    <span class="s4">def </span><span class="s1">test_basic1d(self):</span>
        <span class="s0"># Test of basic array creation and properties in 1 dimension.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isMaskedArray(x))</span>
        <span class="s1">assert_(isMaskedArray(xm))</span>
        <span class="s1">assert_((xm - ym).filled(</span><span class="s5">0</span><span class="s1">).any())</span>
        <span class="s1">fail_if_equal(xm.mask.astype(int)</span><span class="s4">, </span><span class="s1">ym.mask.astype(int))</span>
        <span class="s1">s = x.shape</span>
        <span class="s1">assert_equal(np.shape(xm)</span><span class="s4">, </span><span class="s1">s)</span>
        <span class="s1">assert_equal(xm.shape</span><span class="s4">, </span><span class="s1">s)</span>
        <span class="s1">assert_equal(xm.dtype</span><span class="s4">, </span><span class="s1">x.dtype)</span>
        <span class="s1">assert_equal(zm.dtype</span><span class="s4">, </span><span class="s1">z.dtype)</span>
        <span class="s1">assert_equal(xm.size</span><span class="s4">, </span><span class="s1">reduce(</span><span class="s4">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y:x * y</span><span class="s4">, </span><span class="s1">s))</span>
        <span class="s1">assert_equal(count(xm)</span><span class="s4">, </span><span class="s1">len(m1) - reduce(</span><span class="s4">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y:x + y</span><span class="s4">, </span><span class="s1">m1))</span>
        <span class="s1">assert_array_equal(xm</span><span class="s4">, </span><span class="s1">xf)</span>
        <span class="s1">assert_array_equal(filled(xm</span><span class="s4">, </span><span class="s5">1.e20</span><span class="s1">)</span><span class="s4">, </span><span class="s1">xf)</span>
        <span class="s1">assert_array_equal(x</span><span class="s4">, </span><span class="s1">xm)</span>

    <span class="s4">def </span><span class="s1">test_basic2d(self):</span>
        <span class="s0"># Test of basic array creation and properties in 2 dimensions.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s4">for </span><span class="s1">s </span><span class="s4">in </span><span class="s1">[(</span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">6</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]:</span>
            <span class="s1">x.shape = s</span>
            <span class="s1">y.shape = s</span>
            <span class="s1">xm.shape = s</span>
            <span class="s1">ym.shape = s</span>
            <span class="s1">xf.shape = s</span>

            <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isMaskedArray(x))</span>
            <span class="s1">assert_(isMaskedArray(xm))</span>
            <span class="s1">assert_equal(shape(xm)</span><span class="s4">, </span><span class="s1">s)</span>
            <span class="s1">assert_equal(xm.shape</span><span class="s4">, </span><span class="s1">s)</span>
            <span class="s1">assert_equal(xm.size</span><span class="s4">, </span><span class="s1">reduce(</span><span class="s4">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y:x * y</span><span class="s4">, </span><span class="s1">s))</span>
            <span class="s1">assert_equal(count(xm)</span><span class="s4">, </span><span class="s1">len(m1) - reduce(</span><span class="s4">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y:x + y</span><span class="s4">, </span><span class="s1">m1))</span>
            <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">xf)</span>
            <span class="s1">assert_equal(filled(xm</span><span class="s4">, </span><span class="s5">1.e20</span><span class="s1">)</span><span class="s4">, </span><span class="s1">xf)</span>
            <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">xm)</span>

    <span class="s4">def </span><span class="s1">test_concatenate_basic(self):</span>
        <span class="s0"># Tests concatenations.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s0"># basic concatenation</span>
        <span class="s1">assert_equal(np.concatenate((x</span><span class="s4">, </span><span class="s1">y))</span><span class="s4">, </span><span class="s1">concatenate((xm</span><span class="s4">, </span><span class="s1">ym)))</span>
        <span class="s1">assert_equal(np.concatenate((x</span><span class="s4">, </span><span class="s1">y))</span><span class="s4">, </span><span class="s1">concatenate((x</span><span class="s4">, </span><span class="s1">y)))</span>
        <span class="s1">assert_equal(np.concatenate((x</span><span class="s4">, </span><span class="s1">y))</span><span class="s4">, </span><span class="s1">concatenate((xm</span><span class="s4">, </span><span class="s1">y)))</span>
        <span class="s1">assert_equal(np.concatenate((x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">x))</span><span class="s4">, </span><span class="s1">concatenate((x</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">x)))</span>

    <span class="s4">def </span><span class="s1">test_concatenate_alongaxis(self):</span>
        <span class="s0"># Tests concatenations.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s0"># Concatenation along an axis</span>
        <span class="s1">s = (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">x.shape = y.shape = xm.shape = ym.shape = s</span>
        <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">np.reshape(m1</span><span class="s4">, </span><span class="s1">s))</span>
        <span class="s1">assert_equal(ym.mask</span><span class="s4">, </span><span class="s1">np.reshape(m2</span><span class="s4">, </span><span class="s1">s))</span>
        <span class="s1">xmym = concatenate((xm</span><span class="s4">, </span><span class="s1">ym)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.concatenate((x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">xmym)</span>
        <span class="s1">assert_equal(np.concatenate((xm.mask</span><span class="s4">, </span><span class="s1">ym.mask)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">xmym._mask)</span>

        <span class="s1">x = zeros(</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">y = array(ones(</span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">z = concatenate((x</span><span class="s4">, </span><span class="s1">y))</span>
        <span class="s1">assert_array_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_array_equal(z.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False, False, True</span><span class="s1">])</span>
        <span class="s1">z = concatenate((y</span><span class="s4">, </span><span class="s1">x))</span>
        <span class="s1">assert_array_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_array_equal(z.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True, False, False</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_concatenate_flexible(self):</span>
        <span class="s0"># Tests the concatenation on flexible arrays.</span>
        <span class="s1">data = masked_array(list(zip(np.random.rand(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">,</span>
                                     <span class="s1">np.arange(</span><span class="s5">10</span><span class="s1">)))</span><span class="s4">,</span>
                            <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)])</span>

        <span class="s1">test = concatenate([data[:</span><span class="s5">5</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data[</span><span class="s5">5</span><span class="s1">:]])</span>
        <span class="s1">assert_equal_records(test</span><span class="s4">, </span><span class="s1">data)</span>

    <span class="s4">def </span><span class="s1">test_creation_ndmin(self):</span>
        <span class="s0"># Check the use of ndmin</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">ndmin=</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(x.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">))</span>
        <span class="s1">assert_equal(x._data</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">assert_equal(x._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_creation_ndmin_from_maskedarray(self):</span>
        <span class="s0"># Make sure we're not losing the original mask w/ ndmin</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">x[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">xx = array(x</span><span class="s4">, </span><span class="s1">ndmin=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(x.shape</span><span class="s4">, </span><span class="s1">x._mask.shape)</span>
        <span class="s1">assert_equal(xx.shape</span><span class="s4">, </span><span class="s1">xx._mask.shape)</span>

    <span class="s4">def </span><span class="s1">test_creation_maskcreation(self):</span>
        <span class="s0"># Tests how masks are initialized at the creation of Maskedarrays.</span>
        <span class="s1">data = arange(</span><span class="s5">24</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">data[[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">15</span><span class="s1">]] = masked</span>
        <span class="s1">dma_1 = MaskedArray(data)</span>
        <span class="s1">assert_equal(dma_1.mask</span><span class="s4">, </span><span class="s1">data.mask)</span>
        <span class="s1">dma_2 = MaskedArray(dma_1)</span>
        <span class="s1">assert_equal(dma_2.mask</span><span class="s4">, </span><span class="s1">dma_1.mask)</span>
        <span class="s1">dma_3 = MaskedArray(dma_1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] * </span><span class="s5">6</span><span class="s1">)</span>
        <span class="s1">fail_if_equal(dma_3.mask</span><span class="s4">, </span><span class="s1">dma_1.mask)</span>

        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(x._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True, True</span><span class="s1">])</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(x._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False, False</span><span class="s1">])</span>
        <span class="s1">y = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=x._mask</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_(np.may_share_memory(x.mask</span><span class="s4">, </span><span class="s1">y.mask))</span>
        <span class="s1">y = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=x._mask</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">np.may_share_memory(x.mask</span><span class="s4">, </span><span class="s1">y.mask))</span>

    <span class="s4">def </span><span class="s1">test_masked_singleton_array_creation_warns(self):</span>
        <span class="s0"># The first works, but should not (ideally), there may be no way</span>
        <span class="s0"># to solve this, however, as long as `np.ma.masked` is an ndarray.</span>
        <span class="s1">np.array(np.ma.masked)</span>
        <span class="s4">with </span><span class="s1">pytest.warns(UserWarning):</span>
            <span class="s0"># Tries to create a float array, using `float(np.ma.masked)`.</span>
            <span class="s0"># We may want to define this is invalid behaviour in the future!</span>
            <span class="s0"># (requiring np.ma.masked to be a known NumPy scalar probably</span>
            <span class="s0"># with a DType.)</span>
            <span class="s1">np.array([</span><span class="s5">3.</span><span class="s4">, </span><span class="s1">np.ma.masked])</span>

    <span class="s4">def </span><span class="s1">test_creation_with_list_of_maskedarrays(self):</span>
        <span class="s0"># Tests creating a masked array from a list of masked arrays.</span>
        <span class="s1">x = array(np.arange(</span><span class="s5">5</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">data = array((x</span><span class="s4">, </span><span class="s1">x[::-</span><span class="s5">1</span><span class="s1">]))</span>
        <span class="s1">assert_equal(data</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">assert_equal(data._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>

        <span class="s1">x.mask = nomask</span>
        <span class="s1">data = array((x</span><span class="s4">, </span><span class="s1">x[::-</span><span class="s5">1</span><span class="s1">]))</span>
        <span class="s1">assert_equal(data</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">assert_(data.mask </span><span class="s4">is </span><span class="s1">nomask)</span>

    <span class="s4">def </span><span class="s1">test_creation_with_list_of_maskedarrays_no_bool_cast(self):</span>
        <span class="s0"># Tests the regression in gh-18551</span>
        <span class="s1">masked_str = np.ma.masked_array([</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">normal_int = np.arange(</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">res = np.ma.asarray([masked_str</span><span class="s4">, </span><span class="s1">normal_int]</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">&quot;U21&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(res.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">True, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">]])</span>

        <span class="s0"># The above only failed due a long chain of oddity, try also with</span>
        <span class="s0"># an object array that cannot be converted to bool always:</span>
        <span class="s4">class </span><span class="s1">NotBool():</span>
            <span class="s4">def </span><span class="s1">__bool__(self):</span>
                <span class="s4">raise </span><span class="s1">ValueError(</span><span class="s3">&quot;not a bool!&quot;</span><span class="s1">)</span>
        <span class="s1">masked_obj = np.ma.masked_array([NotBool()</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s0"># Check that the NotBool actually fails like we would expect:</span>
        <span class="s4">with </span><span class="s1">pytest.raises(ValueError</span><span class="s4">, </span><span class="s1">match=</span><span class="s3">&quot;not a bool!&quot;</span><span class="s1">):</span>
            <span class="s1">np.asarray([masked_obj]</span><span class="s4">, </span><span class="s1">dtype=bool)</span>

        <span class="s1">res = np.ma.asarray([masked_obj</span><span class="s4">, </span><span class="s1">normal_int])</span>
        <span class="s1">assert_array_equal(res.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">True, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_creation_from_ndarray_with_padding(self):</span>
        <span class="s1">x = np.array([(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype={</span><span class="s3">'names'</span><span class="s1">:[</span><span class="s3">'f0'</span><span class="s4">,</span><span class="s3">'f1'</span><span class="s1">]</span><span class="s4">,</span>
                                        <span class="s3">'formats'</span><span class="s1">:[</span><span class="s3">'S4'</span><span class="s4">,</span><span class="s3">'i8'</span><span class="s1">]</span><span class="s4">,</span>
                                        <span class="s3">'offsets'</span><span class="s1">:[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">8</span><span class="s1">]})</span>
        <span class="s1">array(x)  </span><span class="s0"># used to fail due to 'V' padding field in x.dtype.descr</span>

    <span class="s4">def </span><span class="s1">test_unknown_keyword_parameter(self):</span>
        <span class="s4">with </span><span class="s1">pytest.raises(TypeError</span><span class="s4">, </span><span class="s1">match=</span><span class="s3">&quot;unexpected keyword argument&quot;</span><span class="s1">):</span>
            <span class="s1">MaskedArray([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">maks=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])  </span><span class="s0"># `mask` is misspelled.</span>

    <span class="s4">def </span><span class="s1">test_asarray(self):</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s1">xm.fill_value = -</span><span class="s5">9999</span>
        <span class="s1">xm._hardmask = </span><span class="s4">True</span>
        <span class="s1">xmm = asarray(xm)</span>
        <span class="s1">assert_equal(xmm._data</span><span class="s4">, </span><span class="s1">xm._data)</span>
        <span class="s1">assert_equal(xmm._mask</span><span class="s4">, </span><span class="s1">xm._mask)</span>
        <span class="s1">assert_equal(xmm.fill_value</span><span class="s4">, </span><span class="s1">xm.fill_value)</span>
        <span class="s1">assert_equal(xmm._hardmask</span><span class="s4">, </span><span class="s1">xm._hardmask)</span>

    <span class="s4">def </span><span class="s1">test_asarray_default_order(self):</span>
        <span class="s0"># See Issue #6646</span>
        <span class="s1">m = np.eye(</span><span class="s5">3</span><span class="s1">).T</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">m.flags.c_contiguous)</span>

        <span class="s1">new_m = asarray(m)</span>
        <span class="s1">assert_(new_m.flags.c_contiguous)</span>

    <span class="s4">def </span><span class="s1">test_asarray_enforce_order(self):</span>
        <span class="s0"># See Issue #6646</span>
        <span class="s1">m = np.eye(</span><span class="s5">3</span><span class="s1">).T</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">m.flags.c_contiguous)</span>

        <span class="s1">new_m = asarray(m</span><span class="s4">, </span><span class="s1">order=</span><span class="s3">'C'</span><span class="s1">)</span>
        <span class="s1">assert_(new_m.flags.c_contiguous)</span>

    <span class="s4">def </span><span class="s1">test_fix_invalid(self):</span>
        <span class="s0"># Checks fix_invalid.</span>
        <span class="s4">with </span><span class="s1">np.errstate(invalid=</span><span class="s3">'ignore'</span><span class="s1">):</span>
            <span class="s1">data = masked_array([np.nan</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">data_fixed = fix_invalid(data)</span>
            <span class="s1">assert_equal(data_fixed._data</span><span class="s4">, </span><span class="s1">[data.fill_value</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">])</span>
            <span class="s1">assert_equal(data_fixed._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_maskedelement(self):</span>
        <span class="s0"># Test of masked element</span>
        <span class="s1">x = arange(</span><span class="s5">6</span><span class="s1">)</span>
        <span class="s1">x[</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">assert_(str(masked) == </span><span class="s3">'--'</span><span class="s1">)</span>
        <span class="s1">assert_(x[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(filled(x[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_set_element_as_object(self):</span>
        <span class="s0"># Tests setting elements with object</span>
        <span class="s1">a = empty(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">x = (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">] = x</span>
        <span class="s1">assert_equal(a[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">assert_(a[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">x)</span>

        <span class="s4">import </span><span class="s1">datetime</span>
        <span class="s1">dt = datetime.datetime.now()</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">] = dt</span>
        <span class="s1">assert_(a[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">dt)</span>

    <span class="s4">def </span><span class="s1">test_indexing(self):</span>
        <span class="s0"># Tests conversions and indexing</span>
        <span class="s1">x1 = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">x2 = array(x1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">x3 = array(x1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x4 = array(x1)</span>
        <span class="s0"># test conversion to strings</span>
        <span class="s1">str(x2)  </span><span class="s0"># raises?</span>
        <span class="s1">repr(x2)  </span><span class="s0"># raises?</span>
        <span class="s1">assert_equal(np.sort(x1)</span><span class="s4">, </span><span class="s1">sort(x2</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">False</span><span class="s1">))</span>
        <span class="s0"># tests of indexing</span>
        <span class="s1">assert_(type(x2[</span><span class="s5">1</span><span class="s1">]) </span><span class="s4">is </span><span class="s1">type(x1[</span><span class="s5">1</span><span class="s1">]))</span>
        <span class="s1">assert_(x1[</span><span class="s5">1</span><span class="s1">] == x2[</span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_(x2[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(x1[</span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x2[</span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(x1[</span><span class="s5">2</span><span class="s1">:</span><span class="s5">5</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x2[</span><span class="s5">2</span><span class="s1">:</span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(x1[:]</span><span class="s4">, </span><span class="s1">x2[:])</span>
        <span class="s1">assert_equal(x1[</span><span class="s5">1</span><span class="s1">:]</span><span class="s4">, </span><span class="s1">x3[</span><span class="s5">1</span><span class="s1">:])</span>
        <span class="s1">x1[</span><span class="s5">2</span><span class="s1">] = </span><span class="s5">9</span>
        <span class="s1">x2[</span><span class="s5">2</span><span class="s1">] = </span><span class="s5">9</span>
        <span class="s1">assert_equal(x1</span><span class="s4">, </span><span class="s1">x2)</span>
        <span class="s1">x1[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">3</span><span class="s1">] = </span><span class="s5">99</span>
        <span class="s1">x2[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">3</span><span class="s1">] = </span><span class="s5">99</span>
        <span class="s1">assert_equal(x1</span><span class="s4">, </span><span class="s1">x2)</span>
        <span class="s1">x2[</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(x1</span><span class="s4">, </span><span class="s1">x2)</span>
        <span class="s1">x2[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">3</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(x1</span><span class="s4">, </span><span class="s1">x2)</span>
        <span class="s1">x2[:] = x1</span>
        <span class="s1">x2[</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">assert_(allequal(getmask(x2)</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])))</span>
        <span class="s1">x3[:] = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_(allequal(getmask(x3)</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])))</span>
        <span class="s1">x4[:] = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_(allequal(getmask(x4)</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])))</span>
        <span class="s1">assert_(allequal(x4</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])))</span>
        <span class="s1">x1 = np.arange(</span><span class="s5">5</span><span class="s1">) * </span><span class="s5">1.0</span>
        <span class="s1">x2 = masked_values(x1</span><span class="s4">, </span><span class="s5">3.0</span><span class="s1">)</span>
        <span class="s1">assert_equal(x1</span><span class="s4">, </span><span class="s1">x2)</span>
        <span class="s1">assert_(allequal(array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">MaskType)</span><span class="s4">, </span><span class="s1">x2.mask))</span>
        <span class="s1">assert_equal(</span><span class="s5">3.0</span><span class="s4">, </span><span class="s1">x2.fill_value)</span>
        <span class="s1">x1 = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s3">'hello'</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">object)</span>
        <span class="s1">x2 = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s3">'hello'</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">object)</span>
        <span class="s1">s1 = x1[</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">s2 = x2[</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">assert_equal(type(s2)</span><span class="s4">, </span><span class="s1">str)</span>
        <span class="s1">assert_equal(type(s1)</span><span class="s4">, </span><span class="s1">str)</span>
        <span class="s1">assert_equal(s1</span><span class="s4">, </span><span class="s1">s2)</span>
        <span class="s1">assert_(x1[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">1</span><span class="s1">].shape == (</span><span class="s5">0</span><span class="s4">,</span><span class="s1">))</span>

    <span class="s1">@suppress_copy_mask_on_assignment</span>
    <span class="s4">def </span><span class="s1">test_copy(self):</span>
        <span class="s0"># Tests of some subtle points of copying and sizing.</span>
        <span class="s1">n = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">m = make_mask(n)</span>
        <span class="s1">m2 = make_mask(m)</span>
        <span class="s1">assert_(m </span><span class="s4">is </span><span class="s1">m2)</span>
        <span class="s1">m3 = make_mask(m</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_(m </span><span class="s4">is not </span><span class="s1">m3)</span>

        <span class="s1">x1 = np.arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">y1 = array(x1</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">assert_equal(y1._data.__array_interface__</span><span class="s4">, </span><span class="s1">x1.__array_interface__)</span>
        <span class="s1">assert_(allequal(x1</span><span class="s4">, </span><span class="s1">y1.data))</span>
        <span class="s1">assert_equal(y1._mask.__array_interface__</span><span class="s4">, </span><span class="s1">m.__array_interface__)</span>

        <span class="s1">y1a = array(y1)</span>
        <span class="s0"># Default for masked array is not to copy; see gh-10318.</span>
        <span class="s1">assert_(y1a._data.__array_interface__ ==</span>
                        <span class="s1">y1._data.__array_interface__)</span>
        <span class="s1">assert_(y1a._mask.__array_interface__ ==</span>
                        <span class="s1">y1._mask.__array_interface__)</span>

        <span class="s1">y2 = array(x1</span><span class="s4">, </span><span class="s1">mask=m3)</span>
        <span class="s1">assert_(y2._data.__array_interface__ == x1.__array_interface__)</span>
        <span class="s1">assert_(y2._mask.__array_interface__ == m3.__array_interface__)</span>
        <span class="s1">assert_(y2[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">y2[</span><span class="s5">2</span><span class="s1">] = </span><span class="s5">9</span>
        <span class="s1">assert_(y2[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(y2._mask.__array_interface__ == m3.__array_interface__)</span>
        <span class="s1">assert_(allequal(y2.mask</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span>

        <span class="s1">y2a = array(x1</span><span class="s4">, </span><span class="s1">mask=m</span><span class="s4">, </span><span class="s1">copy=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_(y2a._data.__array_interface__ != x1.__array_interface__)</span>
        <span class="s0">#assert_( y2a._mask is not m)</span>
        <span class="s1">assert_(y2a._mask.__array_interface__ != m.__array_interface__)</span>
        <span class="s1">assert_(y2a[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">y2a[</span><span class="s5">2</span><span class="s1">] = </span><span class="s5">9</span>
        <span class="s1">assert_(y2a[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s0">#assert_( y2a._mask is not m)</span>
        <span class="s1">assert_(y2a._mask.__array_interface__ != m.__array_interface__)</span>
        <span class="s1">assert_(allequal(y2a.mask</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span>

        <span class="s1">y3 = array(x1 * </span><span class="s5">1.0</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">assert_(filled(y3).dtype </span><span class="s4">is </span><span class="s1">(x1 * </span><span class="s5">1.0</span><span class="s1">).dtype)</span>

        <span class="s1">x4 = arange(</span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">x4[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">y4 = resize(x4</span><span class="s4">, </span><span class="s1">(</span><span class="s5">8</span><span class="s4">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(concatenate([x4</span><span class="s4">, </span><span class="s1">x4])</span><span class="s4">, </span><span class="s1">y4)</span>
        <span class="s1">assert_equal(getmask(y4)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">y5 = repeat(x4</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(y5</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">y6 = repeat(x4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(y5</span><span class="s4">, </span><span class="s1">y6)</span>
        <span class="s1">y7 = x4.repeat((</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(y5</span><span class="s4">, </span><span class="s1">y7)</span>
        <span class="s1">y8 = x4.repeat(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(y5</span><span class="s4">, </span><span class="s1">y8)</span>

        <span class="s1">y9 = x4.copy()</span>
        <span class="s1">assert_equal(y9._data</span><span class="s4">, </span><span class="s1">x4._data)</span>
        <span class="s1">assert_equal(y9._mask</span><span class="s4">, </span><span class="s1">x4._mask)</span>

        <span class="s1">x = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># Copy is False by default</span>
        <span class="s1">y = masked_array(x)</span>
        <span class="s1">assert_equal(y._data.ctypes.data</span><span class="s4">, </span><span class="s1">x._data.ctypes.data)</span>
        <span class="s1">assert_equal(y._mask.ctypes.data</span><span class="s4">, </span><span class="s1">x._mask.ctypes.data)</span>
        <span class="s1">y = masked_array(x</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_not_equal(y._data.ctypes.data</span><span class="s4">, </span><span class="s1">x._data.ctypes.data)</span>
        <span class="s1">assert_not_equal(y._mask.ctypes.data</span><span class="s4">, </span><span class="s1">x._mask.ctypes.data)</span>

    <span class="s4">def </span><span class="s1">test_copy_0d(self):</span>
        <span class="s0"># gh-9430</span>
        <span class="s1">x = np.ma.array(</span><span class="s5">43</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">xc = x.copy()</span>
        <span class="s1">assert_equal(xc.mask</span><span class="s4">, True</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_copy_on_python_builtins(self):</span>
        <span class="s0"># Tests copy works on python builtins (issue#8019)</span>
        <span class="s1">assert_(isMaskedArray(np.ma.copy([</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s1">])))</span>
        <span class="s1">assert_(isMaskedArray(np.ma.copy((</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s1">))))</span>

    <span class="s4">def </span><span class="s1">test_copy_immutable(self):</span>
        <span class="s0"># Tests that the copy method is immutable, GitHub issue #5247</span>
        <span class="s1">a = np.ma.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">b = np.ma.array([</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">])</span>
        <span class="s1">a_copy_method = a.copy</span>
        <span class="s1">b.copy</span>
        <span class="s1">assert_equal(a_copy_method()</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_deepcopy(self):</span>
        <span class="s4">from </span><span class="s1">copy </span><span class="s4">import </span><span class="s1">deepcopy</span>
        <span class="s1">a = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True, False</span><span class="s1">])</span>
        <span class="s1">copied = deepcopy(a)</span>
        <span class="s1">assert_equal(copied.mask</span><span class="s4">, </span><span class="s1">a.mask)</span>
        <span class="s1">assert_not_equal(id(a._mask)</span><span class="s4">, </span><span class="s1">id(copied._mask))</span>

        <span class="s1">copied[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1</span>
        <span class="s1">assert_equal(copied.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">copied = deepcopy(a)</span>
        <span class="s1">assert_equal(copied.mask</span><span class="s4">, </span><span class="s1">a.mask)</span>
        <span class="s1">copied.mask[</span><span class="s5">1</span><span class="s1">] = </span><span class="s4">False</span>
        <span class="s1">assert_equal(copied.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_format(self):</span>
        <span class="s1">a = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(format(a)</span><span class="s4">, </span><span class="s3">&quot;[0 -- 2]&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(format(masked)</span><span class="s4">, </span><span class="s3">&quot;--&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(format(masked</span><span class="s4">, </span><span class="s3">&quot;&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s3">&quot;--&quot;</span><span class="s1">)</span>

        <span class="s0"># Postponed from PR #15410, perhaps address in the future.</span>
        <span class="s0"># assert_equal(format(masked, &quot; &gt;5&quot;), &quot;   --&quot;)</span>
        <span class="s0"># assert_equal(format(masked, &quot; &lt;5&quot;), &quot;--   &quot;)</span>

        <span class="s0"># Expect a FutureWarning for using format_spec with MaskedElement</span>
        <span class="s4">with </span><span class="s1">assert_warns(FutureWarning):</span>
            <span class="s1">with_format_string = format(masked</span><span class="s4">, </span><span class="s3">&quot; &gt;5&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(with_format_string</span><span class="s4">, </span><span class="s3">&quot;--&quot;</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_str_repr(self):</span>
        <span class="s1">a = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(str(a)</span><span class="s4">, </span><span class="s3">'[0 -- 2]'</span><span class="s1">)</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">repr(a)</span><span class="s4">,</span>
            <span class="s1">textwrap.dedent(</span><span class="s3">'''</span><span class="s4">\ 
            </span><span class="s3">masked_array(data=[0, --, 2], 
                         mask=[False,  True, False], 
                   fill_value=999999)'''</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s0"># arrays with a continuation</span>
        <span class="s1">a = np.ma.arange(</span><span class="s5">2000</span><span class="s1">)</span>
        <span class="s1">a[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">50</span><span class="s1">] = np.ma.masked</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">repr(a)</span><span class="s4">,</span>
            <span class="s1">textwrap.dedent(</span><span class="s3">'''</span><span class="s4">\ 
            </span><span class="s3">masked_array(data=[0, --, --, ..., 1997, 1998, 1999], 
                         mask=[False,  True,  True, ..., False, False, False], 
                   fill_value=999999)'''</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s0"># line-wrapped 1d arrays are correctly aligned</span>
        <span class="s1">a = np.ma.arange(</span><span class="s5">20</span><span class="s1">)</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">repr(a)</span><span class="s4">,</span>
            <span class="s1">textwrap.dedent(</span><span class="s3">'''</span><span class="s4">\ 
            </span><span class="s3">masked_array(data=[ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 
                               14, 15, 16, 17, 18, 19], 
                         mask=False, 
                   fill_value=999999)'''</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s0"># 2d arrays cause wrapping</span>
        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">a[</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s1">] = np.ma.masked</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">repr(a)</span><span class="s4">,</span>
            <span class="s1">textwrap.dedent(</span><span class="s3">'''</span><span class="s4">\ 
            </span><span class="s3">masked_array( 
              data=[[1, 2, 3], 
                    [4, --, 6]], 
              mask=[[False, False, False], 
                    [False,  True, False]], 
              fill_value=999999, 
              dtype=int8)'''</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s0"># but not it they're a row vector</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">repr(a[:</span><span class="s5">1</span><span class="s1">])</span><span class="s4">,</span>
            <span class="s1">textwrap.dedent(</span><span class="s3">'''</span><span class="s4">\ 
            </span><span class="s3">masked_array(data=[[1, 2, 3]], 
                         mask=[[False, False, False]], 
                   fill_value=999999, 
                        dtype=int8)'''</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s0"># dtype=int is implied, so not shown</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">repr(a.astype(int))</span><span class="s4">,</span>
            <span class="s1">textwrap.dedent(</span><span class="s3">'''</span><span class="s4">\ 
            </span><span class="s3">masked_array( 
              data=[[1, 2, 3], 
                    [4, --, 6]], 
              mask=[[False, False, False], 
                    [False,  True, False]], 
              fill_value=999999)'''</span><span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_str_repr_legacy(self):</span>
        <span class="s1">oldopts = np.get_printoptions()</span>
        <span class="s1">np.set_printoptions(legacy=</span><span class="s3">'1.13'</span><span class="s1">)</span>
        <span class="s4">try</span><span class="s1">:</span>
            <span class="s1">a = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True, False</span><span class="s1">])</span>
            <span class="s1">assert_equal(str(a)</span><span class="s4">, </span><span class="s3">'[0 -- 2]'</span><span class="s1">)</span>
            <span class="s1">assert_equal(repr(a)</span><span class="s4">, </span><span class="s3">'masked_array(data = [0 -- 2],</span><span class="s4">\n</span><span class="s3">'</span>
                                  <span class="s3">'             mask = [False  True False],</span><span class="s4">\n</span><span class="s3">'</span>
                                  <span class="s3">'       fill_value = 999999)</span><span class="s4">\n</span><span class="s3">'</span><span class="s1">)</span>

            <span class="s1">a = np.ma.arange(</span><span class="s5">2000</span><span class="s1">)</span>
            <span class="s1">a[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">50</span><span class="s1">] = np.ma.masked</span>
            <span class="s1">assert_equal(</span>
                <span class="s1">repr(a)</span><span class="s4">,</span>
                <span class="s3">'masked_array(data = [0 -- -- ..., 1997 1998 1999],</span><span class="s4">\n</span><span class="s3">'</span>
                <span class="s3">'             mask = [False  True  True ..., False False False],</span><span class="s4">\n</span><span class="s3">'</span>
                <span class="s3">'       fill_value = 999999)</span><span class="s4">\n</span><span class="s3">'</span>
            <span class="s1">)</span>
        <span class="s4">finally</span><span class="s1">:</span>
            <span class="s1">np.set_printoptions(**oldopts)</span>

    <span class="s4">def </span><span class="s1">test_0d_unicode(self):</span>
        <span class="s1">u = </span><span class="s3">u'caf</span><span class="s4">\xe9</span><span class="s3">'</span>
        <span class="s1">utype = type(u)</span>

        <span class="s1">arr_nomask = np.ma.array(u)</span>
        <span class="s1">arr_masked = np.ma.array(u</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">assert_equal(utype(arr_nomask)</span><span class="s4">, </span><span class="s1">u)</span>
        <span class="s1">assert_equal(utype(arr_masked)</span><span class="s4">, </span><span class="s3">u'--'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_pickling(self):</span>
        <span class="s0"># Tests pickling</span>
        <span class="s4">for </span><span class="s1">dtype </span><span class="s4">in </span><span class="s1">(int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">object):</span>
            <span class="s1">a = arange(</span><span class="s5">10</span><span class="s1">).astype(dtype)</span>
            <span class="s1">a.fill_value = </span><span class="s5">999</span>

            <span class="s1">masks = ([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">,  </span><span class="s0"># partially masked</span>
                     <span class="s4">True,                            </span><span class="s0"># Fully masked</span>
                     <span class="s4">False</span><span class="s1">)                           </span><span class="s0"># Fully unmasked</span>

            <span class="s4">for </span><span class="s1">proto </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">pickle.HIGHEST_PROTOCOL + </span><span class="s5">1</span><span class="s1">):</span>
                <span class="s4">for </span><span class="s1">mask </span><span class="s4">in </span><span class="s1">masks:</span>
                    <span class="s1">a.mask = mask</span>
                    <span class="s1">a_pickled = pickle.loads(pickle.dumps(a</span><span class="s4">, </span><span class="s1">protocol=proto))</span>
                    <span class="s1">assert_equal(a_pickled._mask</span><span class="s4">, </span><span class="s1">a._mask)</span>
                    <span class="s1">assert_equal(a_pickled._data</span><span class="s4">, </span><span class="s1">a._data)</span>
                    <span class="s4">if </span><span class="s1">dtype </span><span class="s4">in </span><span class="s1">(object</span><span class="s4">, </span><span class="s1">int):</span>
                        <span class="s1">assert_equal(a_pickled.fill_value</span><span class="s4">, </span><span class="s5">999</span><span class="s1">)</span>
                    <span class="s4">else</span><span class="s1">:</span>
                        <span class="s1">assert_equal(a_pickled.fill_value</span><span class="s4">, </span><span class="s1">dtype(</span><span class="s5">999</span><span class="s1">))</span>
                    <span class="s1">assert_array_equal(a_pickled.mask</span><span class="s4">, </span><span class="s1">mask)</span>

    <span class="s4">def </span><span class="s1">test_pickling_subbaseclass(self):</span>
        <span class="s0"># Test pickling w/ a subclass of ndarray</span>
        <span class="s1">x = np.array([(</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3.0</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)]</span><span class="s4">,</span>
                     <span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s4">, </span><span class="s1">int)]).view(np.recarray)</span>
        <span class="s1">a = masked_array(x</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s4">True, False</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s4">False, True</span><span class="s1">)])</span>
        <span class="s4">for </span><span class="s1">proto </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">pickle.HIGHEST_PROTOCOL + </span><span class="s5">1</span><span class="s1">):</span>
            <span class="s1">a_pickled = pickle.loads(pickle.dumps(a</span><span class="s4">, </span><span class="s1">protocol=proto))</span>
            <span class="s1">assert_equal(a_pickled._mask</span><span class="s4">, </span><span class="s1">a._mask)</span>
            <span class="s1">assert_equal(a_pickled</span><span class="s4">, </span><span class="s1">a)</span>
            <span class="s1">assert_(isinstance(a_pickled._data</span><span class="s4">, </span><span class="s1">np.recarray))</span>

    <span class="s4">def </span><span class="s1">test_pickling_maskedconstant(self):</span>
        <span class="s0"># Test pickling MaskedConstant</span>
        <span class="s1">mc = np.ma.masked</span>
        <span class="s4">for </span><span class="s1">proto </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">pickle.HIGHEST_PROTOCOL + </span><span class="s5">1</span><span class="s1">):</span>
            <span class="s1">mc_pickled = pickle.loads(pickle.dumps(mc</span><span class="s4">, </span><span class="s1">protocol=proto))</span>
            <span class="s1">assert_equal(mc_pickled._baseclass</span><span class="s4">, </span><span class="s1">mc._baseclass)</span>
            <span class="s1">assert_equal(mc_pickled._mask</span><span class="s4">, </span><span class="s1">mc._mask)</span>
            <span class="s1">assert_equal(mc_pickled._data</span><span class="s4">, </span><span class="s1">mc._data)</span>

    <span class="s4">def </span><span class="s1">test_pickling_wstructured(self):</span>
        <span class="s0"># Tests pickling w/ structured array</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">,</span>
                  <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s4">for </span><span class="s1">proto </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">pickle.HIGHEST_PROTOCOL + </span><span class="s5">1</span><span class="s1">):</span>
            <span class="s1">a_pickled = pickle.loads(pickle.dumps(a</span><span class="s4">, </span><span class="s1">protocol=proto))</span>
            <span class="s1">assert_equal(a_pickled._mask</span><span class="s4">, </span><span class="s1">a._mask)</span>
            <span class="s1">assert_equal(a_pickled</span><span class="s4">, </span><span class="s1">a)</span>

    <span class="s4">def </span><span class="s1">test_pickling_keepalignment(self):</span>
        <span class="s0"># Tests pickling w/ F_CONTIGUOUS arrays</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">a.shape = (-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">b = a.T</span>
        <span class="s4">for </span><span class="s1">proto </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">pickle.HIGHEST_PROTOCOL + </span><span class="s5">1</span><span class="s1">):</span>
            <span class="s1">test = pickle.loads(pickle.dumps(b</span><span class="s4">, </span><span class="s1">protocol=proto))</span>
            <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">b)</span>

    <span class="s4">def </span><span class="s1">test_single_element_subscript(self):</span>
        <span class="s0"># Tests single element subscripts of Maskedarrays.</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(a[</span><span class="s5">0</span><span class="s1">].shape</span><span class="s4">, </span><span class="s1">())</span>
        <span class="s1">assert_equal(b[</span><span class="s5">0</span><span class="s1">].shape</span><span class="s4">, </span><span class="s1">())</span>
        <span class="s1">assert_equal(b[</span><span class="s5">1</span><span class="s1">].shape</span><span class="s4">, </span><span class="s1">())</span>

    <span class="s4">def </span><span class="s1">test_topython(self):</span>
        <span class="s0"># Tests some communication issues with Python.</span>
        <span class="s1">assert_equal(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">int(array(</span><span class="s5">1</span><span class="s1">)))</span>
        <span class="s1">assert_equal(</span><span class="s5">1.0</span><span class="s4">, </span><span class="s1">float(array(</span><span class="s5">1</span><span class="s1">)))</span>
        <span class="s1">assert_equal(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">int(array([[[</span><span class="s5">1</span><span class="s1">]]])))</span>
        <span class="s1">assert_equal(</span><span class="s5">1.0</span><span class="s4">, </span><span class="s1">float(array([[</span><span class="s5">1</span><span class="s1">]])))</span>
        <span class="s1">assert_raises(TypeError</span><span class="s4">, </span><span class="s1">float</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]))</span>

        <span class="s4">with </span><span class="s1">suppress_warnings() </span><span class="s4">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(UserWarning</span><span class="s4">, </span><span class="s3">'Warning: converting a masked element'</span><span class="s1">)</span>
            <span class="s1">assert_(np.isnan(float(array([</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s1">]))))</span>

            <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
            <span class="s1">assert_raises(TypeError</span><span class="s4">, lambda</span><span class="s1">: float(a))</span>
            <span class="s1">assert_equal(float(a[-</span><span class="s5">1</span><span class="s1">])</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">)</span>
            <span class="s1">assert_(np.isnan(float(a[</span><span class="s5">0</span><span class="s1">])))</span>
        <span class="s1">assert_raises(TypeError</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(int(a[-</span><span class="s5">1</span><span class="s1">])</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_raises(MAError</span><span class="s4">, lambda</span><span class="s1">:int(a[</span><span class="s5">0</span><span class="s1">]))</span>

    <span class="s4">def </span><span class="s1">test_oddfeatures_1(self):</span>
        <span class="s0"># Test of other odd features</span>
        <span class="s1">x = arange(</span><span class="s5">20</span><span class="s1">)</span>
        <span class="s1">x = x.reshape(</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">x.flat[</span><span class="s5">5</span><span class="s1">] = </span><span class="s5">12</span>
        <span class="s1">assert_(x[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] == </span><span class="s5">12</span><span class="s1">)</span>
        <span class="s1">z = x + </span><span class="s5">10j </span><span class="s1">* x</span>
        <span class="s1">assert_equal(z.real</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">assert_equal(z.imag</span><span class="s4">, </span><span class="s5">10 </span><span class="s1">* x)</span>
        <span class="s1">assert_equal((z * conjugate(z)).real</span><span class="s4">, </span><span class="s5">101 </span><span class="s1">* x * x)</span>
        <span class="s1">z.imag[...] = </span><span class="s5">0.0</span>

        <span class="s1">x = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">x[</span><span class="s5">3</span><span class="s1">] = masked</span>
        <span class="s1">assert_(str(x[</span><span class="s5">3</span><span class="s1">]) == str(masked))</span>
        <span class="s1">c = x &gt;= </span><span class="s5">8</span>
        <span class="s1">assert_(count(where(c</span><span class="s4">, </span><span class="s1">masked</span><span class="s4">, </span><span class="s1">masked)) == </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_(shape(where(c</span><span class="s4">, </span><span class="s1">masked</span><span class="s4">, </span><span class="s1">masked)) == c.shape)</span>

        <span class="s1">z = masked_where(c</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">assert_(z.dtype </span><span class="s4">is </span><span class="s1">x.dtype)</span>
        <span class="s1">assert_(z[</span><span class="s5">3</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">4</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">7</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">8</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">9</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">z)</span>

    <span class="s4">def </span><span class="s1">test_oddfeatures_2(self):</span>
        <span class="s0"># Tests some more features.</span>
        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">])</span>
        <span class="s1">c = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">x[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">-x)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">c[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">-x)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_(z[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>

    <span class="s1">@suppress_copy_mask_on_assignment</span>
    <span class="s4">def </span><span class="s1">test_oddfeatures_3(self):</span>
        <span class="s0"># Tests some generic features</span>
        <span class="s1">atest = array([</span><span class="s5">10</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">btest = array([</span><span class="s5">20</span><span class="s1">])</span>
        <span class="s1">idx = atest.mask</span>
        <span class="s1">atest[idx] = btest[idx]</span>
        <span class="s1">assert_equal(atest</span><span class="s4">, </span><span class="s1">[</span><span class="s5">20</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_filled_with_object_dtype(self):</span>
        <span class="s1">a = np.ma.masked_all(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'O'</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.filled(</span><span class="s3">'x'</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s3">'x'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_filled_with_flexible_dtype(self):</span>
        <span class="s0"># Test filled w/ flexible dtype</span>
        <span class="s1">flexi = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">,</span>
                      <span class="s1">dtype=[(</span><span class="s3">'i'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'f'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">flexi[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(flexi.filled()</span><span class="s4">,</span>
                     <span class="s1">np.array([(default_fill_value(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">,</span>
                                <span class="s1">default_fill_value(</span><span class="s3">'0'</span><span class="s1">)</span><span class="s4">,</span>
                                <span class="s1">default_fill_value(</span><span class="s5">0.</span><span class="s1">)</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=flexi.dtype))</span>
        <span class="s1">flexi[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(flexi.filled(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">,</span>
                     <span class="s1">np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s3">'1'</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=flexi.dtype))</span>

    <span class="s4">def </span><span class="s1">test_filled_with_mvoid(self):</span>
        <span class="s0"># Test filled w/ mvoid</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">a = mvoid((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s0"># Filled using default</span>
        <span class="s1">test = a.filled()</span>
        <span class="s1">assert_equal(tuple(test)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s5">1.</span><span class="s1">)))</span>
        <span class="s0"># Explicit fill_value</span>
        <span class="s1">test = a.filled((-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_equal(tuple(test)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s0"># Using predefined filling values</span>
        <span class="s1">a.fill_value = (-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">999</span><span class="s1">)</span>
        <span class="s1">assert_equal(tuple(a.filled())</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">999</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_filled_with_nested_dtype(self):</span>
        <span class="s0"># Test filled w/ nested dtype</span>
        <span class="s1">ndtype = [(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'BA'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'BB'</span><span class="s4">, </span><span class="s1">int)])]</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]</span><span class="s4">,</span>
                  <span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = a.filled(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

        <span class="s1">test = a[</span><span class="s3">'B'</span><span class="s1">].filled(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=a[</span><span class="s3">'B'</span><span class="s1">].dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

        <span class="s0"># test if mask gets set correctly (see #6760)</span>
        <span class="s1">Z = numpy.ma.zeros(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">numpy.dtype([(</span><span class="s3">&quot;A&quot;</span><span class="s4">, </span><span class="s3">&quot;(2,2)i1,(2,2)i1&quot;</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">,</span><span class="s5">2</span><span class="s1">))]))</span>
        <span class="s1">assert_equal(Z.data.dtype</span><span class="s4">, </span><span class="s1">numpy.dtype([(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'f0'</span><span class="s4">, </span><span class="s3">'i1'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span><span class="s4">,</span>
                                          <span class="s1">(</span><span class="s3">'f1'</span><span class="s4">, </span><span class="s3">'i1'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]))</span>
        <span class="s1">assert_equal(Z.mask.dtype</span><span class="s4">, </span><span class="s1">numpy.dtype([(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'f0'</span><span class="s4">, </span><span class="s3">'?'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span><span class="s4">,</span>
                                          <span class="s1">(</span><span class="s3">'f1'</span><span class="s4">, </span><span class="s3">'?'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]))</span>

    <span class="s4">def </span><span class="s1">test_filled_with_f_order(self):</span>
        <span class="s0"># Test filled w/ F-contiguous array</span>
        <span class="s1">a = array(np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span><span class="s4">,</span>
                  <span class="s1">mask=np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span><span class="s4">,</span>
                  <span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)  </span><span class="s0"># this is currently ignored</span>
        <span class="s1">assert_(a.flags[</span><span class="s3">'F_CONTIGUOUS'</span><span class="s1">])</span>
        <span class="s1">assert_(a.filled(</span><span class="s5">0</span><span class="s1">).flags[</span><span class="s3">'F_CONTIGUOUS'</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_optinfo_propagation(self):</span>
        <span class="s0"># Checks that _optinfo dictionary isn't back-propagated</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">x._optinfo[</span><span class="s3">'info'</span><span class="s1">] = </span><span class="s3">'???'</span>
        <span class="s1">y = x.copy()</span>
        <span class="s1">assert_equal(y._optinfo[</span><span class="s3">'info'</span><span class="s1">]</span><span class="s4">, </span><span class="s3">'???'</span><span class="s1">)</span>
        <span class="s1">y._optinfo[</span><span class="s3">'info'</span><span class="s1">] = </span><span class="s3">'!!!'</span>
        <span class="s1">assert_equal(x._optinfo[</span><span class="s3">'info'</span><span class="s1">]</span><span class="s4">, </span><span class="s3">'???'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_optinfo_forward_propagation(self):</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">] = </span><span class="s3">&quot;value&quot;</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a == </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a != </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a &gt; </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a &gt;= </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a &lt;= </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a + </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a - </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a * </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(a / </span><span class="s5">2</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[:</span><span class="s5">2</span><span class="s1">]._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">0</span><span class="s4">,</span><span class="s5">2</span><span class="s1">]]._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.exp(a)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.abs(a)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">array(a</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">True</span><span class="s1">)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(a._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.zeros_like(a)._optinfo[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_fancy_printoptions(self):</span>
        <span class="s0"># Test printing a masked array w/ fancy dtype.</span>
        <span class="s1">fancydtype = np.dtype([(</span><span class="s3">'x'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'t'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s4">, </span><span class="s1">float)])])</span>
        <span class="s1">test = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3.0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">6.0</span><span class="s1">))]</span><span class="s4">,</span>
                     <span class="s1">mask=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))]</span><span class="s4">,</span>
                     <span class="s1">dtype=fancydtype)</span>
        <span class="s1">control = </span><span class="s3">&quot;[(--, (2, --)) (4, (--, 6.0))]&quot;</span>
        <span class="s1">assert_equal(str(test)</span><span class="s4">, </span><span class="s1">control)</span>

        <span class="s0"># Test 0-d array with multi-dimensional dtype</span>
        <span class="s1">t_2d0 = masked_array(data = (</span><span class="s5">0</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s1">]</span><span class="s4">,</span>
                                        <span class="s1">[</span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s1">]]</span><span class="s4">,</span>
                                    <span class="s5">0.0</span><span class="s1">)</span><span class="s4">,</span>
                             <span class="s1">mask = (</span><span class="s4">False, </span><span class="s1">[[</span><span class="s4">True, False, True</span><span class="s1">]</span><span class="s4">,</span>
                                             <span class="s1">[</span><span class="s4">False, False, True</span><span class="s1">]]</span><span class="s4">,</span>
                                     <span class="s4">False</span><span class="s1">)</span><span class="s4">,</span>
                             <span class="s1">dtype = </span><span class="s3">&quot;int, (2,3)float, float&quot;</span><span class="s1">)</span>
        <span class="s1">control = </span><span class="s3">&quot;(0, [[--, 0.0, --], [0.0, 0.0, --]], 0.0)&quot;</span>
        <span class="s1">assert_equal(str(t_2d0)</span><span class="s4">, </span><span class="s1">control)</span>

    <span class="s4">def </span><span class="s1">test_flatten_structured_array(self):</span>
        <span class="s0"># Test flatten_structured_array on arrays</span>
        <span class="s0"># On ndarray</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">a = np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = flatten_structured_array(a)</span>
        <span class="s1">control = np.array([[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">control.dtype)</span>
        <span class="s0"># On masked_array</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = flatten_structured_array(a)</span>
        <span class="s1">control = array([[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">control.dtype)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>
        <span class="s0"># On masked array with nested structure</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'ba'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'bb'</span><span class="s4">, </span><span class="s1">float)])]</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.2</span><span class="s1">))]</span><span class="s4">,</span>
                  <span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = flatten_structured_array(a)</span>
        <span class="s1">control = array([[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2.2</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">control.dtype)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>
        <span class="s0"># Keeping the initial shape</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">a = np.array([[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">]</span><span class="s4">, </span><span class="s1">[(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = flatten_structured_array(a)</span>
        <span class="s1">control = np.array([[[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">]</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">control.dtype)</span>

    <span class="s4">def </span><span class="s1">test_void0d(self):</span>
        <span class="s0"># Test creating a mvoid object</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)]</span>
        <span class="s1">a = np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">f = mvoid(a)</span>
        <span class="s1">assert_(isinstance(f</span><span class="s4">, </span><span class="s1">mvoid))</span>

        <span class="s1">a = masked_array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">assert_(isinstance(a</span><span class="s4">, </span><span class="s1">mvoid))</span>

        <span class="s1">a = masked_array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">f = mvoid(a._data[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a._mask[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_(isinstance(f</span><span class="s4">, </span><span class="s1">mvoid))</span>

    <span class="s4">def </span><span class="s1">test_mvoid_getitem(self):</span>
        <span class="s0"># Test mvoid.__getitem__</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)]</span>
        <span class="s1">a = masked_array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
                         <span class="s1">dtype=ndtype)</span>
        <span class="s0"># w/o mask</span>
        <span class="s1">f = a[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">assert_(isinstance(f</span><span class="s4">, </span><span class="s1">mvoid))</span>
        <span class="s1">assert_equal((f[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">f[</span><span class="s3">'a'</span><span class="s1">])</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_equal(f[</span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s0"># w/ mask</span>
        <span class="s1">f = a[</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">assert_(isinstance(f</span><span class="s4">, </span><span class="s1">mvoid))</span>
        <span class="s1">assert_(f[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(f[</span><span class="s3">'a'</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(f[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>

        <span class="s0"># exotic dtype</span>
        <span class="s1">A = masked_array(data=[([</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">,</span>
                         <span class="s1">mask=[([</span><span class="s4">True, False</span><span class="s1">]</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">,</span>
                         <span class="s1">dtype=[(</span><span class="s3">&quot;A&quot;</span><span class="s4">, </span><span class="s3">&quot;&gt;i2&quot;</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">,</span><span class="s1">))])</span>
        <span class="s1">assert_equal(A[</span><span class="s5">0</span><span class="s1">][</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">A[</span><span class="s3">&quot;A&quot;</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(A[</span><span class="s5">0</span><span class="s1">][</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">masked_array(data=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                         <span class="s1">mask=[</span><span class="s4">True, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">&quot;&gt;i2&quot;</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_mvoid_iter(self):</span>
        <span class="s0"># Test iteration on __getitem__</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)]</span>
        <span class="s1">a = masked_array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
                         <span class="s1">dtype=ndtype)</span>
        <span class="s0"># w/o mask</span>
        <span class="s1">assert_equal(list(a[</span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s0"># w/ mask</span>
        <span class="s1">assert_equal(list(a[</span><span class="s5">1</span><span class="s1">])</span><span class="s4">, </span><span class="s1">[masked</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_mvoid_print(self):</span>
        <span class="s0"># Test printing a mvoid</span>
        <span class="s1">mx = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(str(mx[</span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s3">&quot;(1, 1)&quot;</span><span class="s1">)</span>
        <span class="s1">mx[</span><span class="s3">'b'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">ini_display = masked_print_option._display</span>
        <span class="s1">masked_print_option.set_display(</span><span class="s3">&quot;-X-&quot;</span><span class="s1">)</span>
        <span class="s4">try</span><span class="s1">:</span>
            <span class="s1">assert_equal(str(mx[</span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s3">&quot;(1, -X-)&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(repr(mx[</span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s3">&quot;(1, -X-)&quot;</span><span class="s1">)</span>
        <span class="s4">finally</span><span class="s1">:</span>
            <span class="s1">masked_print_option.set_display(ini_display)</span>

        <span class="s0"># also check if there are object datatypes (see gh-7493)</span>
        <span class="s1">mx = array([(</span><span class="s5">1</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'O'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(str(mx[</span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s3">&quot;(1,)&quot;</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_mvoid_multidim_print(self):</span>

        <span class="s0"># regression test for gh-6019</span>
        <span class="s1">t_ma = masked_array(data = [([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">mask = [([</span><span class="s4">False, True, False</span><span class="s1">]</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">fill_value = ([</span><span class="s5">999999</span><span class="s4">, </span><span class="s5">999999</span><span class="s4">, </span><span class="s5">999999</span><span class="s1">]</span><span class="s4">,</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">dtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'&lt;i4'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">,</span><span class="s1">))])</span>
        <span class="s1">assert_(str(t_ma[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;([1, --, 3],)&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(repr(t_ma[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;([1, --, 3],)&quot;</span><span class="s1">)</span>

        <span class="s0"># additional tests with structured arrays</span>

        <span class="s1">t_2d = masked_array(data = [([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">]]</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">mask = [([[</span><span class="s4">False, True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">]]</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">dtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'&lt;i4'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">,</span><span class="s5">2</span><span class="s1">))])</span>
        <span class="s1">assert_(str(t_2d[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;([[1, --], [--, 4]],)&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(repr(t_2d[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;([[1, --], [--, 4]],)&quot;</span><span class="s1">)</span>

        <span class="s1">t_0d = masked_array(data = [(</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">mask = [(</span><span class="s4">True,False</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">dtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'&lt;i4'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s3">'&lt;i4'</span><span class="s1">)])</span>
        <span class="s1">assert_(str(t_0d[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;(--, 2)&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(repr(t_0d[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;(--, 2)&quot;</span><span class="s1">)</span>

        <span class="s1">t_2d = masked_array(data = [([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">]]</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">mask = [([[</span><span class="s4">False, True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">]]</span><span class="s4">, False</span><span class="s1">)]</span><span class="s4">,</span>
                            <span class="s1">dtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'&lt;i4'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">,</span><span class="s5">2</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">assert_(str(t_2d[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;([[1, --], [--, 4]], 1.0)&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(repr(t_2d[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;([[1, --], [--, 4]], 1.0)&quot;</span><span class="s1">)</span>

        <span class="s1">t_ne = masked_array(data=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]</span><span class="s4">,</span>
                            <span class="s1">mask=[(</span><span class="s4">True, </span><span class="s1">(</span><span class="s4">True, False</span><span class="s1">))]</span><span class="s4">,</span>
                            <span class="s1">dtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'&lt;i4'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s3">'i4,i4'</span><span class="s1">)])</span>
        <span class="s1">assert_(str(t_ne[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;(--, (--, 1))&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(repr(t_ne[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s3">&quot;(--, (--, 1))&quot;</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_object_with_array(self):</span>
        <span class="s1">mx1 = masked_array([</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">True</span><span class="s1">])</span>
        <span class="s1">mx2 = masked_array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">])</span>
        <span class="s1">mx = masked_array([mx1</span><span class="s4">, </span><span class="s1">mx2]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">assert_(mx[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">mx1)</span>
        <span class="s1">assert_(mx[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">mx2)</span>
        <span class="s1">assert_(np.all(mx[</span><span class="s5">1</span><span class="s1">].data == mx2.data))</span>
        <span class="s1">assert_(np.all(mx[</span><span class="s5">1</span><span class="s1">].mask))</span>
        <span class="s0"># check that we return a view.</span>
        <span class="s1">mx[</span><span class="s5">1</span><span class="s1">].data[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">0.</span>
        <span class="s1">assert_(mx2[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">0.</span><span class="s1">)</span>


<span class="s4">class </span><span class="s1">TestMaskedArrayArithmetic:</span>
    <span class="s0"># Base test class for MaskedArrays.</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s0"># Base data definition.</span>
        <span class="s1">x = np.array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2.</span><span class="s4">, </span><span class="s1">pi/</span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s5">5.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">a10 = </span><span class="s5">10.</span>
        <span class="s1">m1 = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">m2 = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">xm = masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1)</span>
        <span class="s1">ym = masked_array(y</span><span class="s4">, </span><span class="s1">mask=m2)</span>
        <span class="s1">z = np.array([-</span><span class="s5">.5</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">.5</span><span class="s4">, </span><span class="s5">.8</span><span class="s1">])</span>
        <span class="s1">zm = masked_array(z</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">xf = np.where(m1</span><span class="s4">, </span><span class="s5">1e+20</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">xm.set_fill_value(</span><span class="s5">1e+20</span><span class="s1">)</span>
        <span class="s1">self.d = (x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf)</span>
        <span class="s1">self.err_status = np.geterr()</span>
        <span class="s1">np.seterr(divide=</span><span class="s3">'ignore'</span><span class="s4">, </span><span class="s1">invalid=</span><span class="s3">'ignore'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">teardown(self):</span>
        <span class="s1">np.seterr(**self.err_status)</span>

    <span class="s4">def </span><span class="s1">test_basic_arithmetic(self):</span>
        <span class="s0"># Test of basic arithmetic.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s1">a2d = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]])</span>
        <span class="s1">a2dm = masked_array(a2d</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a2d * a2d</span><span class="s4">, </span><span class="s1">a2d * a2dm)</span>
        <span class="s1">assert_equal(a2d + a2d</span><span class="s4">, </span><span class="s1">a2d + a2dm)</span>
        <span class="s1">assert_equal(a2d - a2d</span><span class="s4">, </span><span class="s1">a2d - a2dm)</span>
        <span class="s4">for </span><span class="s1">s </span><span class="s4">in </span><span class="s1">[(</span><span class="s5">12</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)]:</span>
            <span class="s1">x = x.reshape(s)</span>
            <span class="s1">y = y.reshape(s)</span>
            <span class="s1">xm = xm.reshape(s)</span>
            <span class="s1">ym = ym.reshape(s)</span>
            <span class="s1">xf = xf.reshape(s)</span>
            <span class="s1">assert_equal(-x</span><span class="s4">, </span><span class="s1">-xm)</span>
            <span class="s1">assert_equal(x + y</span><span class="s4">, </span><span class="s1">xm + ym)</span>
            <span class="s1">assert_equal(x - y</span><span class="s4">, </span><span class="s1">xm - ym)</span>
            <span class="s1">assert_equal(x * y</span><span class="s4">, </span><span class="s1">xm * ym)</span>
            <span class="s1">assert_equal(x / y</span><span class="s4">, </span><span class="s1">xm / ym)</span>
            <span class="s1">assert_equal(a10 + y</span><span class="s4">, </span><span class="s1">a10 + ym)</span>
            <span class="s1">assert_equal(a10 - y</span><span class="s4">, </span><span class="s1">a10 - ym)</span>
            <span class="s1">assert_equal(a10 * y</span><span class="s4">, </span><span class="s1">a10 * ym)</span>
            <span class="s1">assert_equal(a10 / y</span><span class="s4">, </span><span class="s1">a10 / ym)</span>
            <span class="s1">assert_equal(x + a10</span><span class="s4">, </span><span class="s1">xm + a10)</span>
            <span class="s1">assert_equal(x - a10</span><span class="s4">, </span><span class="s1">xm - a10)</span>
            <span class="s1">assert_equal(x * a10</span><span class="s4">, </span><span class="s1">xm * a10)</span>
            <span class="s1">assert_equal(x / a10</span><span class="s4">, </span><span class="s1">xm / a10)</span>
            <span class="s1">assert_equal(x ** </span><span class="s5">2</span><span class="s4">, </span><span class="s1">xm ** </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">assert_equal(abs(x) ** </span><span class="s5">2.5</span><span class="s4">, </span><span class="s1">abs(xm) ** </span><span class="s5">2.5</span><span class="s1">)</span>
            <span class="s1">assert_equal(x ** y</span><span class="s4">, </span><span class="s1">xm ** ym)</span>
            <span class="s1">assert_equal(np.add(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">add(xm</span><span class="s4">, </span><span class="s1">ym))</span>
            <span class="s1">assert_equal(np.subtract(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">subtract(xm</span><span class="s4">, </span><span class="s1">ym))</span>
            <span class="s1">assert_equal(np.multiply(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">multiply(xm</span><span class="s4">, </span><span class="s1">ym))</span>
            <span class="s1">assert_equal(np.divide(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">divide(xm</span><span class="s4">, </span><span class="s1">ym))</span>

    <span class="s4">def </span><span class="s1">test_divide_on_different_shapes(self):</span>
        <span class="s1">x = arange(</span><span class="s5">6</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">x.shape = (</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">y = arange(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">dtype=float)</span>

        <span class="s1">z = x / y</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[[-</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">2.5</span><span class="s1">]])</span>
        <span class="s1">assert_equal(z.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

        <span class="s1">z = x / y[</span><span class="s4">None,</span><span class="s1">:]</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[[-</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">2.5</span><span class="s1">]])</span>
        <span class="s1">assert_equal(z.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

        <span class="s1">y = arange(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">z = x / y[:</span><span class="s4">, None</span><span class="s1">]</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[[-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]])</span>
        <span class="s1">assert_equal(z.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_mixed_arithmetic(self):</span>
        <span class="s0"># Tests mixed arithmetic.</span>
        <span class="s1">na = np.array([</span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">ma = array([</span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_(isinstance(na + ma</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_(isinstance(ma + na</span><span class="s4">, </span><span class="s1">MaskedArray))</span>

    <span class="s4">def </span><span class="s1">test_limits_arithmetic(self):</span>
        <span class="s1">tiny = np.finfo(float).tiny</span>
        <span class="s1">a = array([tiny</span><span class="s4">, </span><span class="s5">1. </span><span class="s1">/ tiny</span><span class="s4">, </span><span class="s5">0.</span><span class="s1">])</span>
        <span class="s1">assert_equal(getmaskarray(a / </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(getmaskarray(</span><span class="s5">2 </span><span class="s1">/ a)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_masked_singleton_arithmetic(self):</span>
        <span class="s0"># Tests some scalar arithmetic on MaskedArrays.</span>
        <span class="s0"># Masked singleton should remain masked no matter what</span>
        <span class="s1">xm = array(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">mask=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_((</span><span class="s5">1 </span><span class="s1">/ array(</span><span class="s5">0</span><span class="s1">)).mask)</span>
        <span class="s1">assert_((</span><span class="s5">1 </span><span class="s1">+ xm).mask)</span>
        <span class="s1">assert_((-xm).mask)</span>
        <span class="s1">assert_(maximum(xm</span><span class="s4">, </span><span class="s1">xm).mask)</span>
        <span class="s1">assert_(minimum(xm</span><span class="s4">, </span><span class="s1">xm).mask)</span>

    <span class="s4">def </span><span class="s1">test_masked_singleton_equality(self):</span>
        <span class="s0"># Tests (in)equality on masked singleton</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_((a[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">0</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_((a[</span><span class="s5">0</span><span class="s1">] != </span><span class="s5">0</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_equal((a[-</span><span class="s5">1</span><span class="s1">] == </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, False</span><span class="s1">)</span>
        <span class="s1">assert_equal((a[-</span><span class="s5">1</span><span class="s1">] != </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, True</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_arithmetic_with_masked_singleton(self):</span>
        <span class="s0"># Checks that there's no collapsing to masked</span>
        <span class="s1">x = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">y = x * masked</span>
        <span class="s1">assert_equal(y.shape</span><span class="s4">, </span><span class="s1">x.shape)</span>
        <span class="s1">assert_equal(y._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">y = x[</span><span class="s5">0</span><span class="s1">] * masked</span>
        <span class="s1">assert_(y </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">y = x + masked</span>
        <span class="s1">assert_equal(y.shape</span><span class="s4">, </span><span class="s1">x.shape)</span>
        <span class="s1">assert_equal(y._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_arithmetic_with_masked_singleton_on_1d_singleton(self):</span>
        <span class="s0"># Check that we're not losing the shape of a singleton</span>
        <span class="s1">x = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s1">])</span>
        <span class="s1">y = x + masked</span>
        <span class="s1">assert_equal(y.shape</span><span class="s4">, </span><span class="s1">x.shape)</span>
        <span class="s1">assert_equal(y.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, </span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_scalar_arithmetic(self):</span>
        <span class="s1">x = array(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">mask=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(x.filled().ctypes.data</span><span class="s4">, </span><span class="s1">x.ctypes.data)</span>
        <span class="s0"># Make sure we don't lose the shape in some circumstances</span>
        <span class="s1">xm = array((</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)) / </span><span class="s5">0.</span>
        <span class="s1">assert_equal(xm.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_basic_ufuncs(self):</span>
        <span class="s0"># Test various functions such as sin, cos.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s1">assert_equal(np.cos(x)</span><span class="s4">, </span><span class="s1">cos(xm))</span>
        <span class="s1">assert_equal(np.cosh(x)</span><span class="s4">, </span><span class="s1">cosh(xm))</span>
        <span class="s1">assert_equal(np.sin(x)</span><span class="s4">, </span><span class="s1">sin(xm))</span>
        <span class="s1">assert_equal(np.sinh(x)</span><span class="s4">, </span><span class="s1">sinh(xm))</span>
        <span class="s1">assert_equal(np.tan(x)</span><span class="s4">, </span><span class="s1">tan(xm))</span>
        <span class="s1">assert_equal(np.tanh(x)</span><span class="s4">, </span><span class="s1">tanh(xm))</span>
        <span class="s1">assert_equal(np.sqrt(abs(x))</span><span class="s4">, </span><span class="s1">sqrt(xm))</span>
        <span class="s1">assert_equal(np.log(abs(x))</span><span class="s4">, </span><span class="s1">log(xm))</span>
        <span class="s1">assert_equal(np.log10(abs(x))</span><span class="s4">, </span><span class="s1">log10(xm))</span>
        <span class="s1">assert_equal(np.exp(x)</span><span class="s4">, </span><span class="s1">exp(xm))</span>
        <span class="s1">assert_equal(np.arcsin(z)</span><span class="s4">, </span><span class="s1">arcsin(zm))</span>
        <span class="s1">assert_equal(np.arccos(z)</span><span class="s4">, </span><span class="s1">arccos(zm))</span>
        <span class="s1">assert_equal(np.arctan(z)</span><span class="s4">, </span><span class="s1">arctan(zm))</span>
        <span class="s1">assert_equal(np.arctan2(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">arctan2(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(np.absolute(x)</span><span class="s4">, </span><span class="s1">absolute(xm))</span>
        <span class="s1">assert_equal(np.angle(x + </span><span class="s5">1j</span><span class="s1">*y)</span><span class="s4">, </span><span class="s1">angle(xm + </span><span class="s5">1j</span><span class="s1">*ym))</span>
        <span class="s1">assert_equal(np.angle(x + </span><span class="s5">1j</span><span class="s1">*y</span><span class="s4">, </span><span class="s1">deg=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s1">angle(xm + </span><span class="s5">1j</span><span class="s1">*ym</span><span class="s4">, </span><span class="s1">deg=</span><span class="s4">True</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.equal(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">equal(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(np.not_equal(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">not_equal(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(np.less(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">less(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(np.greater(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">greater(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(np.less_equal(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">less_equal(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(np.greater_equal(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">greater_equal(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(np.conjugate(x)</span><span class="s4">, </span><span class="s1">conjugate(xm))</span>

    <span class="s4">def </span><span class="s1">test_count_func(self):</span>
        <span class="s0"># Tests count</span>
        <span class="s1">assert_equal(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">count(</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_equal(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">array(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s1">]))</span>

        <span class="s1">ott = array([</span><span class="s5">0.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">res = count(ott)</span>
        <span class="s1">assert_(res.dtype.type </span><span class="s4">is </span><span class="s1">np.intp)</span>
        <span class="s1">assert_equal(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">res)</span>

        <span class="s1">ott = ott.reshape((</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">res = count(ott)</span>
        <span class="s1">assert_(res.dtype.type </span><span class="s4">is </span><span class="s1">np.intp)</span>
        <span class="s1">assert_equal(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">res)</span>
        <span class="s1">res = count(ott</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_(isinstance(res</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_equal([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">res)</span>
        <span class="s1">assert_(getmask(res) </span><span class="s4">is </span><span class="s1">nomask)</span>

        <span class="s1">ott = array([</span><span class="s5">0.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">res = count(ott</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_(isinstance(res</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_(res.dtype.type </span><span class="s4">is </span><span class="s1">np.intp)</span>
        <span class="s1">assert_raises(np.AxisError</span><span class="s4">, </span><span class="s1">ott.count</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_count_on_python_builtins(self):</span>
        <span class="s0"># Tests count works on python builtins (issue#8019)</span>
        <span class="s1">assert_equal(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">count([</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s1">]))</span>
        <span class="s1">assert_equal(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">count((</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s1">)))</span>

    <span class="s4">def </span><span class="s1">test_minmax_func(self):</span>
        <span class="s0"># Tests minimum and maximum.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s0"># max doesn't work if shaped</span>
        <span class="s1">xr = np.ravel(x)</span>
        <span class="s1">xmr = ravel(xm)</span>
        <span class="s0"># following are true because of careful selection of data</span>
        <span class="s1">assert_equal(max(xr)</span><span class="s4">, </span><span class="s1">maximum.reduce(xmr))</span>
        <span class="s1">assert_equal(min(xr)</span><span class="s4">, </span><span class="s1">minimum.reduce(xmr))</span>

        <span class="s1">assert_equal(minimum([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">9</span><span class="s1">])</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(maximum([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">9</span><span class="s1">])</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">9</span><span class="s1">])</span>
        <span class="s1">x = arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">y = arange(</span><span class="s5">5</span><span class="s1">) - </span><span class="s5">2</span>
        <span class="s1">x[</span><span class="s5">3</span><span class="s1">] = masked</span>
        <span class="s1">y[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(minimum(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">where(less(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y))</span>
        <span class="s1">assert_equal(maximum(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">where(greater(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y))</span>
        <span class="s1">assert_(minimum.reduce(x) == </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_(maximum.reduce(x) == </span><span class="s5">4</span><span class="s1">)</span>

        <span class="s1">x = arange(</span><span class="s5">4</span><span class="s1">).reshape(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">x[-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(maximum.reduce(x</span><span class="s4">, </span><span class="s1">axis=</span><span class="s4">None</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_minimummaximum_func(self):</span>
        <span class="s1">a = np.ones((</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">aminimum = minimum(a</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_(isinstance(aminimum</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(aminimum</span><span class="s4">, </span><span class="s1">np.minimum(a</span><span class="s4">, </span><span class="s1">a))</span>

        <span class="s1">aminimum = minimum.outer(a</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_(isinstance(aminimum</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(aminimum</span><span class="s4">, </span><span class="s1">np.minimum.outer(a</span><span class="s4">, </span><span class="s1">a))</span>

        <span class="s1">amaximum = maximum(a</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_(isinstance(amaximum</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(amaximum</span><span class="s4">, </span><span class="s1">np.maximum(a</span><span class="s4">, </span><span class="s1">a))</span>

        <span class="s1">amaximum = maximum.outer(a</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_(isinstance(amaximum</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(amaximum</span><span class="s4">, </span><span class="s1">np.maximum.outer(a</span><span class="s4">, </span><span class="s1">a))</span>

    <span class="s4">def </span><span class="s1">test_minmax_reduce(self):</span>
        <span class="s0"># Test np.min/maximum.reduce on array w/ full False mask</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, False, False</span><span class="s1">])</span>
        <span class="s1">b = np.maximum.reduce(a)</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_minmax_funcs_with_output(self):</span>
        <span class="s0"># Tests the min/max functions with explicit outputs</span>
        <span class="s1">mask = np.random.rand(</span><span class="s5">12</span><span class="s1">).round()</span>
        <span class="s1">xm = array(np.random.uniform(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">12</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=mask)</span>
        <span class="s1">xm.shape = (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s4">for </span><span class="s1">funcname </span><span class="s4">in </span><span class="s1">(</span><span class="s3">'min'</span><span class="s4">, </span><span class="s3">'max'</span><span class="s1">):</span>
            <span class="s0"># Initialize</span>
            <span class="s1">npfunc = getattr(np</span><span class="s4">, </span><span class="s1">funcname)</span>
            <span class="s1">mafunc = getattr(numpy.ma.core</span><span class="s4">, </span><span class="s1">funcname)</span>
            <span class="s0"># Use the np version</span>
            <span class="s1">nout = np.empty((</span><span class="s5">4</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=int)</span>
            <span class="s4">try</span><span class="s1">:</span>
                <span class="s1">result = npfunc(xm</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=nout)</span>
            <span class="s4">except </span><span class="s1">MaskError:</span>
                <span class="s4">pass</span>
            <span class="s1">nout = np.empty((</span><span class="s5">4</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=float)</span>
            <span class="s1">result = npfunc(xm</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=nout)</span>
            <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">nout)</span>
            <span class="s0"># Use the ma version</span>
            <span class="s1">nout.fill(-</span><span class="s5">999</span><span class="s1">)</span>
            <span class="s1">result = mafunc(xm</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=nout)</span>
            <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">nout)</span>

    <span class="s4">def </span><span class="s1">test_minmax_methods(self):</span>
        <span class="s0"># Additional tests on max/min</span>
        <span class="s1">(_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_) = self.d</span>
        <span class="s1">xm.shape = (xm.size</span><span class="s4">,</span><span class="s1">)</span>
        <span class="s1">assert_equal(xm.max()</span><span class="s4">, </span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].max() </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].max(</span><span class="s5">0</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].max(-</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(xm.min()</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s1">)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].min() </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].min(</span><span class="s5">0</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].min(-</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(xm.ptp()</span><span class="s4">, </span><span class="s5">20.</span><span class="s1">)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].ptp() </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].ptp(</span><span class="s5">0</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(xm[</span><span class="s5">0</span><span class="s1">].ptp(-</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>

        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_(x.min() </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(x.max() </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(x.ptp() </span><span class="s4">is </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_minmax_dtypes(self):</span>
        <span class="s0"># Additional tests on max/min for non-standard float and complex dtypes</span>
        <span class="s1">x = np.array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2.</span><span class="s4">, </span><span class="s1">pi/</span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">a10 = </span><span class="s5">10.</span>
        <span class="s1">an10 = -</span><span class="s5">10.0</span>
        <span class="s1">m1 = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">xm = masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1)</span>
        <span class="s1">xm.set_fill_value(</span><span class="s5">1e+20</span><span class="s1">)</span>
        <span class="s1">float_dtypes = [np.half</span><span class="s4">, </span><span class="s1">np.single</span><span class="s4">, </span><span class="s1">np.double</span><span class="s4">,</span>
                        <span class="s1">np.longdouble</span><span class="s4">, </span><span class="s1">np.cfloat</span><span class="s4">, </span><span class="s1">np.cdouble</span><span class="s4">, </span><span class="s1">np.clongdouble]</span>
        <span class="s4">for </span><span class="s1">float_dtype </span><span class="s4">in </span><span class="s1">float_dtypes:</span>
            <span class="s1">assert_equal(masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1</span><span class="s4">, </span><span class="s1">dtype=float_dtype).max()</span><span class="s4">,</span>
                         <span class="s1">float_dtype(a10))</span>
            <span class="s1">assert_equal(masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1</span><span class="s4">, </span><span class="s1">dtype=float_dtype).min()</span><span class="s4">,</span>
                         <span class="s1">float_dtype(an10))</span>

        <span class="s1">assert_equal(xm.min()</span><span class="s4">, </span><span class="s1">an10)</span>
        <span class="s1">assert_equal(xm.max()</span><span class="s4">, </span><span class="s1">a10)</span>

        <span class="s0"># Non-complex type only test</span>
        <span class="s4">for </span><span class="s1">float_dtype </span><span class="s4">in </span><span class="s1">float_dtypes[:</span><span class="s5">4</span><span class="s1">]:</span>
            <span class="s1">assert_equal(masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1</span><span class="s4">, </span><span class="s1">dtype=float_dtype).max()</span><span class="s4">,</span>
                         <span class="s1">float_dtype(a10))</span>
            <span class="s1">assert_equal(masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1</span><span class="s4">, </span><span class="s1">dtype=float_dtype).min()</span><span class="s4">,</span>
                         <span class="s1">float_dtype(an10))</span>

        <span class="s0"># Complex types only test</span>
        <span class="s4">for </span><span class="s1">float_dtype </span><span class="s4">in </span><span class="s1">float_dtypes[-</span><span class="s5">3</span><span class="s1">:]:</span>
            <span class="s1">ym = masked_array([</span><span class="s5">1e20</span><span class="s1">+</span><span class="s5">1j</span><span class="s4">, </span><span class="s5">1e20</span><span class="s1">-</span><span class="s5">2j</span><span class="s4">, </span><span class="s5">1e20</span><span class="s1">-</span><span class="s5">1j</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">,</span>
                          <span class="s1">dtype=float_dtype)</span>
            <span class="s1">assert_equal(ym.min()</span><span class="s4">, </span><span class="s1">float_dtype(</span><span class="s5">1e20</span><span class="s1">-</span><span class="s5">1j</span><span class="s1">))</span>
            <span class="s1">assert_equal(ym.max()</span><span class="s4">, </span><span class="s1">float_dtype(</span><span class="s5">1e20</span><span class="s1">+</span><span class="s5">1j</span><span class="s1">))</span>

            <span class="s1">zm = masked_array([np.inf+</span><span class="s5">2j</span><span class="s4">, </span><span class="s1">np.inf+</span><span class="s5">3j</span><span class="s4">, </span><span class="s1">-np.inf-</span><span class="s5">1j</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">,</span>
                              <span class="s1">dtype=float_dtype)</span>
            <span class="s1">assert_equal(zm.min()</span><span class="s4">, </span><span class="s1">float_dtype(-np.inf-</span><span class="s5">1j</span><span class="s1">))</span>
            <span class="s1">assert_equal(zm.max()</span><span class="s4">, </span><span class="s1">float_dtype(np.inf+</span><span class="s5">2j</span><span class="s1">))</span>

            <span class="s1">cmax = np.inf - </span><span class="s5">1j </span><span class="s1">* np.finfo(np.float64).max</span>
            <span class="s4">assert </span><span class="s1">masked_array([-cmax</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]).max() == -cmax</span>
            <span class="s4">assert </span><span class="s1">masked_array([cmax</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]).min() == cmax</span>

    <span class="s4">def </span><span class="s1">test_addsumprod(self):</span>
        <span class="s0"># Tests add, sum, product.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s1">assert_equal(np.add.reduce(x)</span><span class="s4">, </span><span class="s1">add.reduce(x))</span>
        <span class="s1">assert_equal(np.add.accumulate(x)</span><span class="s4">, </span><span class="s1">add.accumulate(x))</span>
        <span class="s1">assert_equal(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">sum(array(</span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">sum(array(</span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.sum(x</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">sum(x</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.sum(filled(xm</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">sum(xm</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.sum(x</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">sum(x</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.product(x</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">product(x</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.product(x</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">product(x</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.product(filled(xm</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">product(xm</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">s = (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">x.shape = y.shape = xm.shape = ym.shape = s</span>
        <span class="s4">if </span><span class="s1">len(s) &gt; </span><span class="s5">1</span><span class="s1">:</span>
            <span class="s1">assert_equal(np.concatenate((x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">concatenate((xm</span><span class="s4">, </span><span class="s1">ym)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span>
            <span class="s1">assert_equal(np.add.reduce(x</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">add.reduce(x</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span>
            <span class="s1">assert_equal(np.sum(x</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">sum(x</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span>
            <span class="s1">assert_equal(np.product(x</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">product(x</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_binops_d2D(self):</span>
        <span class="s0"># Test binary operations on 2D data</span>
        <span class="s1">a = array([[</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3.</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s4">False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True</span><span class="s1">]])</span>
        <span class="s1">b = array([[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6.</span><span class="s4">, </span><span class="s5">7.</span><span class="s1">]])</span>

        <span class="s1">test = a * b</span>
        <span class="s1">control = array([[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

        <span class="s1">test = b * a</span>
        <span class="s1">control = array([[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6.</span><span class="s4">, </span><span class="s5">7.</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

        <span class="s1">a = array([[</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3.</span><span class="s1">]])</span>
        <span class="s1">b = array([[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6.</span><span class="s4">, </span><span class="s5">7.</span><span class="s1">]]</span><span class="s4">,</span>
                  <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">test = a * b</span>
        <span class="s1">control = array([[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">10</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">18</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

        <span class="s1">test = b * a</span>
        <span class="s1">control = array([[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">10</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">18</span><span class="s4">, </span><span class="s5">7</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

    <span class="s4">def </span><span class="s1">test_domained_binops_d2D(self):</span>
        <span class="s0"># Test domained binary operations on 2D data</span>
        <span class="s1">a = array([[</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3.</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s4">False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True</span><span class="s1">]])</span>
        <span class="s1">b = array([[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6.</span><span class="s4">, </span><span class="s5">7.</span><span class="s1">]])</span>

        <span class="s1">test = a / b</span>
        <span class="s1">control = array([[</span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

        <span class="s1">test = b / a</span>
        <span class="s1">control = array([[</span><span class="s5">2. </span><span class="s1">/ </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">3. </span><span class="s1">/ </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6.</span><span class="s4">, </span><span class="s5">7.</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

        <span class="s1">a = array([[</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3.</span><span class="s1">]])</span>
        <span class="s1">b = array([[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6.</span><span class="s4">, </span><span class="s5">7.</span><span class="s1">]]</span><span class="s4">,</span>
                  <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">test = a / b</span>
        <span class="s1">control = array([[</span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2. </span><span class="s1">/ </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2. </span><span class="s1">/ </span><span class="s5">5</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3. </span><span class="s1">/ </span><span class="s5">6</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

        <span class="s1">test = b / a</span>
        <span class="s1">control = array([[</span><span class="s5">2 </span><span class="s1">/ </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">3 </span><span class="s1">/ </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4 </span><span class="s1">/ </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">5 </span><span class="s1">/ </span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6 </span><span class="s1">/ </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">7</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>

    <span class="s4">def </span><span class="s1">test_noshrinking(self):</span>
        <span class="s0"># Check that we don't shrink a mask when not wanted</span>
        <span class="s0"># Binary operations</span>
        <span class="s1">a = masked_array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, False, False</span><span class="s1">]</span><span class="s4">,</span>
                         <span class="s1">shrink=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">b = a + </span><span class="s5">1</span>
        <span class="s1">assert_equal(b.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># In place binary operation</span>
        <span class="s1">a += </span><span class="s5">1</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># Domained binary operation</span>
        <span class="s1">b = a / </span><span class="s5">1.</span>
        <span class="s1">assert_equal(b.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># In place binary operation</span>
        <span class="s1">a /= </span><span class="s5">1.</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_ufunc_nomask(self):</span>
        <span class="s0"># check the case ufuncs should set the mask to false</span>
        <span class="s1">m = np.ma.array([</span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># check we don't get array([False], dtype=bool)</span>
        <span class="s1">assert_equal(np.true_divide(m</span><span class="s4">, </span><span class="s5">5</span><span class="s1">).mask.shape</span><span class="s4">, </span><span class="s1">())</span>

    <span class="s4">def </span><span class="s1">test_noshink_on_creation(self):</span>
        <span class="s0"># Check that the mask is not shrunk on array creation when not wanted</span>
        <span class="s1">a = np.ma.masked_values([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.5</span><span class="s4">, </span><span class="s5">3.1</span><span class="s1">]</span><span class="s4">, </span><span class="s5">1.5</span><span class="s4">, </span><span class="s1">shrink=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_mod(self):</span>
        <span class="s0"># Tests mod</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">a10</span><span class="s4">, </span><span class="s1">m1</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">ym</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">zm</span><span class="s4">, </span><span class="s1">xf) = self.d</span>
        <span class="s1">assert_equal(mod(x</span><span class="s4">, </span><span class="s1">y)</span><span class="s4">, </span><span class="s1">mod(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">test = mod(ym</span><span class="s4">, </span><span class="s1">xm)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">np.mod(ym</span><span class="s4">, </span><span class="s1">xm))</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">mask_or(xm.mask</span><span class="s4">, </span><span class="s1">ym.mask))</span>
        <span class="s1">test = mod(xm</span><span class="s4">, </span><span class="s1">ym)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">np.mod(xm</span><span class="s4">, </span><span class="s1">ym))</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">mask_or(mask_or(xm.mask</span><span class="s4">, </span><span class="s1">ym.mask)</span><span class="s4">, </span><span class="s1">(ym == </span><span class="s5">0</span><span class="s1">)))</span>

    <span class="s4">def </span><span class="s1">test_TakeTransposeInnerOuter(self):</span>
        <span class="s0"># Test of take, transpose, inner, outer products</span>
        <span class="s1">x = arange(</span><span class="s5">24</span><span class="s1">)</span>
        <span class="s1">y = np.arange(</span><span class="s5">24</span><span class="s1">)</span>
        <span class="s1">x[</span><span class="s5">5</span><span class="s1">:</span><span class="s5">6</span><span class="s1">] = masked</span>
        <span class="s1">x = x.reshape(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">y = y.reshape(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.transpose(y</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">transpose(x</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)))</span>
        <span class="s1">assert_equal(np.take(y</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">take(x</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.inner(filled(x</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">filled(y</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">,</span>
                     <span class="s1">inner(x</span><span class="s4">, </span><span class="s1">y))</span>
        <span class="s1">assert_equal(np.outer(filled(x</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">filled(y</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">,</span>
                     <span class="s1">outer(x</span><span class="s4">, </span><span class="s1">y))</span>
        <span class="s1">y = array([</span><span class="s3">'abc'</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s3">'def'</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">object)</span>
        <span class="s1">y[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">t = take(y</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_(t[</span><span class="s5">0</span><span class="s1">] == </span><span class="s3">'abc'</span><span class="s1">)</span>
        <span class="s1">assert_(t[</span><span class="s5">1</span><span class="s1">] == </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_(t[</span><span class="s5">2</span><span class="s1">] == </span><span class="s5">3</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_imag_real(self):</span>
        <span class="s0"># Check complex</span>
        <span class="s1">xx = array([</span><span class="s5">1 </span><span class="s1">+ </span><span class="s5">10j</span><span class="s4">, </span><span class="s5">20 </span><span class="s1">+ </span><span class="s5">2j</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.imag</span><span class="s4">, </span><span class="s1">[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.imag.filled()</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1e+20</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.imag.dtype</span><span class="s4">, </span><span class="s1">xx._data.imag.dtype)</span>
        <span class="s1">assert_equal(xx.real</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">20</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.real.filled()</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1e+20</span><span class="s4">, </span><span class="s5">20</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.real.dtype</span><span class="s4">, </span><span class="s1">xx._data.real.dtype)</span>

    <span class="s4">def </span><span class="s1">test_methods_with_output(self):</span>
        <span class="s1">xm = array(np.random.uniform(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">12</span><span class="s1">)).reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">xm[:</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] = xm[</span><span class="s5">0</span><span class="s1">] = xm[-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = masked</span>

        <span class="s1">funclist = (</span><span class="s3">'sum'</span><span class="s4">, </span><span class="s3">'prod'</span><span class="s4">, </span><span class="s3">'var'</span><span class="s4">, </span><span class="s3">'std'</span><span class="s4">, </span><span class="s3">'max'</span><span class="s4">, </span><span class="s3">'min'</span><span class="s4">, </span><span class="s3">'ptp'</span><span class="s4">, </span><span class="s3">'mean'</span><span class="s4">,</span><span class="s1">)</span>

        <span class="s4">for </span><span class="s1">funcname </span><span class="s4">in </span><span class="s1">funclist:</span>
            <span class="s1">npfunc = getattr(np</span><span class="s4">, </span><span class="s1">funcname)</span>
            <span class="s1">xmmeth = getattr(xm</span><span class="s4">, </span><span class="s1">funcname)</span>
            <span class="s0"># A ndarray as explicit input</span>
            <span class="s1">output = np.empty(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=float)</span>
            <span class="s1">output.fill(-</span><span class="s5">9999</span><span class="s1">)</span>
            <span class="s1">result = npfunc(xm</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=output)</span>
            <span class="s0"># ... the result should be the given output</span>
            <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">output)</span>
            <span class="s1">assert_equal(result</span><span class="s4">, </span><span class="s1">xmmeth(axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=output))</span>

            <span class="s1">output = empty(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=int)</span>
            <span class="s1">result = xmmeth(axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=output)</span>
            <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">output)</span>
            <span class="s1">assert_(output[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_eq_on_structured(self):</span>
        <span class="s0"># Test the equality of structured arrays</span>
        <span class="s1">ndtype = [(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">int)]</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>

        <span class="s1">test = (a == a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a == a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = (a == b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s1">] == b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = (a == b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s0"># complicated dtype, 2-dimensional array.</span>
        <span class="s1">ndtype = [(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'BA'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'BB'</span><span class="s4">, </span><span class="s1">int)])]</span>
        <span class="s1">a = array([[(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]</span><span class="s4">,</span>
                   <span class="s1">[(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s1">))]]</span><span class="s4">,</span>
                  <span class="s1">mask=[[(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]</span><span class="s4">,</span>
                        <span class="s1">[(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] == a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">True, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">False, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">]])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_ne_on_structured(self):</span>
        <span class="s0"># Test the equality of structured arrays</span>
        <span class="s1">ndtype = [(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">int)]</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>

        <span class="s1">test = (a != a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a != a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = (a != b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s1">] != b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = (a != b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s0"># complicated dtype, 2-dimensional array.</span>
        <span class="s1">ndtype = [(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'BA'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'BB'</span><span class="s4">, </span><span class="s1">int)])]</span>
        <span class="s1">a = array([[(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]</span><span class="s4">,</span>
                   <span class="s1">[(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s1">))]]</span><span class="s4">,</span>
                  <span class="s1">mask=[[(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]</span><span class="s4">,</span>
                        <span class="s1">[(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] != a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">False, True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">False, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">]])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_eq_ne_structured_extra(self):</span>
        <span class="s0"># ensure simple examples are symmetric and make sense.</span>
        <span class="s0"># from https://github.com/numpy/numpy/pull/8590#discussion_r101126465</span>
        <span class="s1">dt = np.dtype(</span><span class="s3">'i4,i4'</span><span class="s1">)</span>
        <span class="s4">for </span><span class="s1">m1 </span><span class="s4">in </span><span class="s1">(mvoid((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)</span><span class="s4">,</span>
                   <span class="s1">mvoid((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)</span><span class="s4">,</span>
                   <span class="s1">mvoid((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)</span><span class="s4">,</span>
                   <span class="s1">mvoid((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)):</span>
            <span class="s1">ma1 = m1.view(MaskedArray)</span>
            <span class="s1">r1 = ma1.view(</span><span class="s3">'2i4'</span><span class="s1">)</span>
            <span class="s4">for </span><span class="s1">m2 </span><span class="s4">in </span><span class="s1">(np.array((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)</span><span class="s4">,</span>
                       <span class="s1">mvoid((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)</span><span class="s4">,</span>
                       <span class="s1">mvoid((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)</span><span class="s4">,</span>
                       <span class="s1">mvoid((</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)):</span>
                <span class="s1">ma2 = m2.view(MaskedArray)</span>
                <span class="s1">r2 = ma2.view(</span><span class="s3">'2i4'</span><span class="s1">)</span>
                <span class="s1">eq_expected = (r1 == r2).all()</span>
                <span class="s1">assert_equal(m1 == m2</span><span class="s4">, </span><span class="s1">eq_expected)</span>
                <span class="s1">assert_equal(m2 == m1</span><span class="s4">, </span><span class="s1">eq_expected)</span>
                <span class="s1">assert_equal(ma1 == m2</span><span class="s4">, </span><span class="s1">eq_expected)</span>
                <span class="s1">assert_equal(m1 == ma2</span><span class="s4">, </span><span class="s1">eq_expected)</span>
                <span class="s1">assert_equal(ma1 == ma2</span><span class="s4">, </span><span class="s1">eq_expected)</span>
                <span class="s0"># Also check it is the same if we do it element by element.</span>
                <span class="s1">el_by_el = [m1[name] == m2[name] </span><span class="s4">for </span><span class="s1">name </span><span class="s4">in </span><span class="s1">dt.names]</span>
                <span class="s1">assert_equal(array(el_by_el</span><span class="s4">, </span><span class="s1">dtype=bool).all()</span><span class="s4">, </span><span class="s1">eq_expected)</span>
                <span class="s1">ne_expected = (r1 != r2).any()</span>
                <span class="s1">assert_equal(m1 != m2</span><span class="s4">, </span><span class="s1">ne_expected)</span>
                <span class="s1">assert_equal(m2 != m1</span><span class="s4">, </span><span class="s1">ne_expected)</span>
                <span class="s1">assert_equal(ma1 != m2</span><span class="s4">, </span><span class="s1">ne_expected)</span>
                <span class="s1">assert_equal(m1 != ma2</span><span class="s4">, </span><span class="s1">ne_expected)</span>
                <span class="s1">assert_equal(ma1 != ma2</span><span class="s4">, </span><span class="s1">ne_expected)</span>
                <span class="s1">el_by_el = [m1[name] != m2[name] </span><span class="s4">for </span><span class="s1">name </span><span class="s4">in </span><span class="s1">dt.names]</span>
                <span class="s1">assert_equal(array(el_by_el</span><span class="s4">, </span><span class="s1">dtype=bool).any()</span><span class="s4">, </span><span class="s1">ne_expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt'</span><span class="s4">, </span><span class="s1">[</span><span class="s3">'S'</span><span class="s4">, </span><span class="s3">'U'</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'fill'</span><span class="s4">, </span><span class="s1">[</span><span class="s4">None, </span><span class="s3">'A'</span><span class="s1">])</span>
    <span class="s4">def </span><span class="s1">test_eq_for_strings(self</span><span class="s4">, </span><span class="s1">dt</span><span class="s4">, </span><span class="s1">fill):</span>
        <span class="s0"># Test the equality of structured arrays</span>
        <span class="s1">a = array([</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>

        <span class="s1">test = (a == a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a == a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>
        <span class="s1">test = (a == b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s1">] == b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (b == a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt'</span><span class="s4">, </span><span class="s1">[</span><span class="s3">'S'</span><span class="s4">, </span><span class="s3">'U'</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'fill'</span><span class="s4">, </span><span class="s1">[</span><span class="s4">None, </span><span class="s3">'A'</span><span class="s1">])</span>
    <span class="s4">def </span><span class="s1">test_ne_for_strings(self</span><span class="s4">, </span><span class="s1">dt</span><span class="s4">, </span><span class="s1">fill):</span>
        <span class="s0"># Test the equality of structured arrays</span>
        <span class="s1">a = array([</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>

        <span class="s1">test = (a != a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a != a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>
        <span class="s1">test = (a != b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s1">] != b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (b != a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt1'</span><span class="s4">, </span><span class="s1">num_dts</span><span class="s4">, </span><span class="s1">ids=num_ids)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt2'</span><span class="s4">, </span><span class="s1">num_dts</span><span class="s4">, </span><span class="s1">ids=num_ids)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'fill'</span><span class="s4">, </span><span class="s1">[</span><span class="s4">None, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s4">def </span><span class="s1">test_eq_for_numeric(self</span><span class="s4">, </span><span class="s1">dt1</span><span class="s4">, </span><span class="s1">dt2</span><span class="s4">, </span><span class="s1">fill):</span>
        <span class="s0"># Test the equality of structured arrays</span>
        <span class="s1">a = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>

        <span class="s1">test = (a == a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a == a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt2</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>
        <span class="s1">test = (a == b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s1">] == b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (b == a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt1'</span><span class="s4">, </span><span class="s1">num_dts</span><span class="s4">, </span><span class="s1">ids=num_ids)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt2'</span><span class="s4">, </span><span class="s1">num_dts</span><span class="s4">, </span><span class="s1">ids=num_ids)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'fill'</span><span class="s4">, </span><span class="s1">[</span><span class="s4">None, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s4">def </span><span class="s1">test_ne_for_numeric(self</span><span class="s4">, </span><span class="s1">dt1</span><span class="s4">, </span><span class="s1">dt2</span><span class="s4">, </span><span class="s1">fill):</span>
        <span class="s0"># Test the equality of structured arrays</span>
        <span class="s1">a = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>

        <span class="s1">test = (a != a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a != a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">b = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=dt2</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=fill)</span>
        <span class="s1">test = (a != b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (a[</span><span class="s5">0</span><span class="s1">] != b)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">test = (b != a[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
        <span class="s1">assert_(test.fill_value == </span><span class="s4">True</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_eq_with_None(self):</span>
        <span class="s0"># Really, comparisons with None should not be done, but check them</span>
        <span class="s0"># anyway. Note that pep8 will flag these tests.</span>
        <span class="s0"># Deprecation is in place for arrays, and when it happens this</span>
        <span class="s0"># test will fail (and have to be changed accordingly).</span>

        <span class="s0"># With partial mask</span>
        <span class="s4">with </span><span class="s1">suppress_warnings() </span><span class="s4">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(FutureWarning</span><span class="s4">, </span><span class="s3">&quot;Comparison to `None`&quot;</span><span class="s1">)</span>
            <span class="s1">a = array([</span><span class="s4">None, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">assert_equal(a == </span><span class="s4">None, </span><span class="s1">array([</span><span class="s4">True, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]))</span>
            <span class="s1">assert_equal(a.data == </span><span class="s4">None, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
            <span class="s1">assert_equal(a != </span><span class="s4">None, </span><span class="s1">array([</span><span class="s4">False, True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]))</span>
            <span class="s0"># With nomask</span>
            <span class="s1">a = array([</span><span class="s4">None, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">False</span><span class="s1">)</span>
            <span class="s1">assert_equal(a == </span><span class="s4">None, </span><span class="s1">[</span><span class="s4">True, False</span><span class="s1">])</span>
            <span class="s1">assert_equal(a != </span><span class="s4">None, </span><span class="s1">[</span><span class="s4">False, True</span><span class="s1">])</span>
            <span class="s0"># With complete mask</span>
            <span class="s1">a = array([</span><span class="s4">None, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
            <span class="s1">assert_equal(a == </span><span class="s4">None, </span><span class="s1">array([</span><span class="s4">False, True</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">))</span>
            <span class="s1">assert_equal(a != </span><span class="s4">None, </span><span class="s1">array([</span><span class="s4">True, False</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">))</span>
            <span class="s0"># Fully masked, even comparison to None should return &quot;masked&quot;</span>
            <span class="s1">a = masked</span>
            <span class="s1">assert_equal(a == </span><span class="s4">None, </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_eq_with_scalar(self):</span>
        <span class="s1">a = array(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(a == </span><span class="s5">1</span><span class="s4">, True</span><span class="s1">)</span>
        <span class="s1">assert_equal(a == </span><span class="s5">0</span><span class="s4">, False</span><span class="s1">)</span>
        <span class="s1">assert_equal(a != </span><span class="s5">1</span><span class="s4">, False</span><span class="s1">)</span>
        <span class="s1">assert_equal(a != </span><span class="s5">0</span><span class="s4">, True</span><span class="s1">)</span>
        <span class="s1">b = array(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(b == </span><span class="s5">0</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(b == </span><span class="s5">1</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(b != </span><span class="s5">0</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(b != </span><span class="s5">1</span><span class="s4">, </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_eq_different_dimensions(self):</span>
        <span class="s1">m1 = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># test comparison with both masked and regular arrays.</span>
        <span class="s4">for </span><span class="s1">m2 </span><span class="s4">in </span><span class="s1">(array([[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]])</span><span class="s4">,</span>
                   <span class="s1">np.array([[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]])):</span>
            <span class="s1">test = (m1 == m2)</span>
            <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">False, False</span><span class="s1">]</span><span class="s4">,</span>
                                     <span class="s1">[</span><span class="s4">True, False</span><span class="s1">]])</span>
            <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s4">False, True</span><span class="s1">]</span><span class="s4">,</span>
                                     <span class="s1">[</span><span class="s4">False, True</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_numpyarithmetic(self):</span>
        <span class="s0"># Check that the mask is not back-propagated when using numpy functions</span>
        <span class="s1">a = masked_array([-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">control = masked_array([np.nan</span><span class="s4">, </span><span class="s1">np.nan</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">np.log(</span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                               <span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

        <span class="s1">test = log(a)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

        <span class="s1">test = np.log(a)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>


<span class="s4">class </span><span class="s1">TestMaskedArrayAttributes:</span>

    <span class="s4">def </span><span class="s1">test_keepmask(self):</span>
        <span class="s0"># Tests the keep mask flag</span>
        <span class="s1">x = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">mx = masked_array(x)</span>
        <span class="s1">assert_equal(mx.mask</span><span class="s4">, </span><span class="s1">x.mask)</span>
        <span class="s1">mx = masked_array(x</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">keep_mask=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(mx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">mx = masked_array(x</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">keep_mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(mx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># We default to true</span>
        <span class="s1">mx = masked_array(x</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(mx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_hardmask(self):</span>
        <span class="s0"># Test hard_mask</span>
        <span class="s1">d = arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">n = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">m = make_mask(n)</span>
        <span class="s1">xh = array(d</span><span class="s4">, </span><span class="s1">mask=m</span><span class="s4">, </span><span class="s1">hard_mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s0"># We need to copy, to avoid updating d in xh !</span>
        <span class="s1">xs = array(d</span><span class="s4">, </span><span class="s1">mask=m</span><span class="s4">, </span><span class="s1">hard_mask=</span><span class="s4">False, </span><span class="s1">copy=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">xh[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]] = [</span><span class="s5">10</span><span class="s4">, </span><span class="s5">40</span><span class="s1">]</span>
        <span class="s1">xs[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]] = [</span><span class="s5">10</span><span class="s4">, </span><span class="s5">40</span><span class="s1">]</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(xs._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">40</span><span class="s1">])</span>
        <span class="s1">assert_equal(xs.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_(xh._hardmask)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">xs._hardmask)</span>
        <span class="s1">xh[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">4</span><span class="s1">] = [</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span>
        <span class="s1">xs[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">4</span><span class="s1">] = [</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(xs._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s4">, </span><span class="s5">40</span><span class="s1">])</span>
        <span class="s1">assert_equal(xs.mask</span><span class="s4">, </span><span class="s1">nomask)</span>
        <span class="s1">xh[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">xs[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(xh.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(xs.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">xh[:] = </span><span class="s5">1</span>
        <span class="s1">xs[:] = </span><span class="s5">1</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(xs._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(xh.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(xs.mask</span><span class="s4">, </span><span class="s1">nomask)</span>
        <span class="s0"># Switch to soft mask</span>
        <span class="s1">xh.soften_mask()</span>
        <span class="s1">xh[:] = arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(xh.mask</span><span class="s4">, </span><span class="s1">nomask)</span>
        <span class="s0"># Switch back to hard mask</span>
        <span class="s1">xh.harden_mask()</span>
        <span class="s1">xh[xh &lt; </span><span class="s5">3</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(xh._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">xh[filled(xh &gt; </span><span class="s5">1</span><span class="s4">, False</span><span class="s1">)] = </span><span class="s5">5</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(xh._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">xh = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">hard_mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">xh[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">0</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]])</span>
        <span class="s1">assert_equal(xh._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">xh[-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">5</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">5</span><span class="s1">]])</span>
        <span class="s1">assert_equal(xh._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">xh[filled(xh &lt; </span><span class="s5">5</span><span class="s4">, False</span><span class="s1">)] = </span><span class="s5">2</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s1">]])</span>
        <span class="s1">assert_equal(xh._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_hardmask_again(self):</span>
        <span class="s0"># Another test of hardmask</span>
        <span class="s1">d = arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">n = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">m = make_mask(n)</span>
        <span class="s1">xh = array(d</span><span class="s4">, </span><span class="s1">mask=m</span><span class="s4">, </span><span class="s1">hard_mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">xh[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">5</span><span class="s1">] = </span><span class="s5">999</span>
        <span class="s1">xh[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">999</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">999</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_hardmask_oncemore_yay(self):</span>
        <span class="s0"># OK, yet another test of hardmask</span>
        <span class="s0"># Make sure that harden_mask/soften_mask//unshare_mask returns self</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">b = a.harden_mask()</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">b)</span>
        <span class="s1">b[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">0</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]))</span>
        <span class="s1">a = b.soften_mask()</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">0</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]))</span>

    <span class="s4">def </span><span class="s1">test_smallmask(self):</span>
        <span class="s0"># Checks the behaviour of _smallmask</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">a[</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">a[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1</span>
        <span class="s1">assert_equal(a._mask</span><span class="s4">, </span><span class="s1">nomask)</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">a._smallmask = </span><span class="s4">False</span>
        <span class="s1">a[</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">a[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1</span>
        <span class="s1">assert_equal(a._mask</span><span class="s4">, </span><span class="s1">zeros(</span><span class="s5">10</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_shrink_mask(self):</span>
        <span class="s0"># Tests .shrink_mask()</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">b = a.shrink_mask()</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">nomask)</span>

        <span class="s0"># Mask cannot be shrunk on structured types, so is a no-op</span>
        <span class="s1">a = np.ma.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2.0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">b = a.copy()</span>
        <span class="s1">a.shrink_mask()</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">b.mask)</span>

    <span class="s4">def </span><span class="s1">test_flat(self):</span>
        <span class="s0"># Test that flat can return all types of items [#4585, #4615]</span>
        <span class="s0"># test 2-D record array</span>
        <span class="s0"># ... on structured array w/ masked records</span>
        <span class="s1">x = array([[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s3">'one'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s3">'two'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s3">'thr'</span><span class="s1">)]</span><span class="s4">,</span>
                   <span class="s1">[(</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4.4</span><span class="s4">, </span><span class="s3">'fou'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">5.5</span><span class="s4">, </span><span class="s3">'fiv'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">6</span><span class="s4">, </span><span class="s5">6.6</span><span class="s4">, </span><span class="s3">'six'</span><span class="s1">)]]</span><span class="s4">,</span>
                  <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)])</span>
        <span class="s1">x[</span><span class="s3">'a'</span><span class="s1">][</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">x[</span><span class="s3">'b'</span><span class="s1">][</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">x[</span><span class="s3">'c'</span><span class="s1">][</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">x[-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">xflat = x.flat</span>
        <span class="s1">assert_equal(xflat[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[</span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[:</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[</span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[</span><span class="s5">5</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[</span><span class="s5">3</span><span class="s1">:]</span><span class="s4">, </span><span class="s1">x[</span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(xflat[-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x[-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">i = </span><span class="s5">0</span>
        <span class="s1">j = </span><span class="s5">0</span>
        <span class="s4">for </span><span class="s1">xf </span><span class="s4">in </span><span class="s1">xflat:</span>
            <span class="s1">assert_equal(xf</span><span class="s4">, </span><span class="s1">x[j</span><span class="s4">, </span><span class="s1">i])</span>
            <span class="s1">i += </span><span class="s5">1</span>
            <span class="s4">if </span><span class="s1">i &gt;= x.shape[-</span><span class="s5">1</span><span class="s1">]:</span>
                <span class="s1">i = </span><span class="s5">0</span>
                <span class="s1">j += </span><span class="s5">1</span>

    <span class="s4">def </span><span class="s1">test_assign_dtype(self):</span>
        <span class="s0"># check that the mask's dtype is updated when dtype is changed</span>
        <span class="s1">a = np.zeros(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'f4,i4'</span><span class="s1">)</span>

        <span class="s1">m = np.ma.array(a)</span>
        <span class="s1">m.dtype = np.dtype(</span><span class="s3">'f4'</span><span class="s1">)</span>
        <span class="s1">repr(m)  </span><span class="s0"># raises?</span>
        <span class="s1">assert_equal(m.dtype</span><span class="s4">, </span><span class="s1">np.dtype(</span><span class="s3">'f4'</span><span class="s1">))</span>

        <span class="s0"># check that dtype changes that change shape of mask too much</span>
        <span class="s0"># are not allowed</span>
        <span class="s4">def </span><span class="s1">assign():</span>
            <span class="s1">m = np.ma.array(a)</span>
            <span class="s1">m.dtype = np.dtype(</span><span class="s3">'f8'</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">assign)</span>

        <span class="s1">b = a.view(dtype=</span><span class="s3">'f4'</span><span class="s4">, </span><span class="s1">type=np.ma.MaskedArray)  </span><span class="s0"># raises?</span>
        <span class="s1">assert_equal(b.dtype</span><span class="s4">, </span><span class="s1">np.dtype(</span><span class="s3">'f4'</span><span class="s1">))</span>

        <span class="s0"># check that nomask is preserved</span>
        <span class="s1">a = np.zeros(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'f4'</span><span class="s1">)</span>
        <span class="s1">m = np.ma.array(a)</span>
        <span class="s1">m.dtype = np.dtype(</span><span class="s3">'f4,i4'</span><span class="s1">)</span>
        <span class="s1">assert_equal(m.dtype</span><span class="s4">, </span><span class="s1">np.dtype(</span><span class="s3">'f4,i4'</span><span class="s1">))</span>
        <span class="s1">assert_equal(m._mask</span><span class="s4">, </span><span class="s1">np.ma.nomask)</span>


<span class="s4">class </span><span class="s1">TestFillingValues:</span>

    <span class="s4">def </span><span class="s1">test_check_on_scalar(self):</span>
        <span class="s0"># Test _check_fill_value set to valid and invalid values</span>
        <span class="s1">_check_fill_value = np.ma.core._check_fill_value</span>

        <span class="s1">fval = _check_fill_value(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">int)</span>
        <span class="s1">assert_equal(fval</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">fval = _check_fill_value(</span><span class="s4">None, </span><span class="s1">int)</span>
        <span class="s1">assert_equal(fval</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s5">0</span><span class="s1">))</span>

        <span class="s1">fval = _check_fill_value(</span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;|S3&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(fval</span><span class="s4">, </span><span class="s6">b&quot;0&quot;</span><span class="s1">)</span>
        <span class="s1">fval = _check_fill_value(</span><span class="s4">None, </span><span class="s3">&quot;|S3&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(fval</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s6">b&quot;camelot!&quot;</span><span class="s1">))</span>
        <span class="s1">assert_raises(TypeError</span><span class="s4">, </span><span class="s1">_check_fill_value</span><span class="s4">, </span><span class="s5">1e+20</span><span class="s4">, </span><span class="s1">int)</span>
        <span class="s1">assert_raises(TypeError</span><span class="s4">, </span><span class="s1">_check_fill_value</span><span class="s4">, </span><span class="s3">'stuff'</span><span class="s4">, </span><span class="s1">int)</span>

    <span class="s4">def </span><span class="s1">test_check_on_fields(self):</span>
        <span class="s0"># Tests _check_fill_value with records</span>
        <span class="s1">_check_fill_value = np.ma.core._check_fill_value</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s3">&quot;|S3&quot;</span><span class="s1">)]</span>
        <span class="s0"># A check on a list should return a single record</span>
        <span class="s1">fval = _check_fill_value([-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s3">&quot;???&quot;</span><span class="s1">]</span><span class="s4">, </span><span class="s1">ndtype)</span>
        <span class="s1">assert_(isinstance(fval</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_equal(fval.item()</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s6">b&quot;???&quot;</span><span class="s1">])</span>
        <span class="s0"># A check on None should output the defaults</span>
        <span class="s1">fval = _check_fill_value(</span><span class="s4">None, </span><span class="s1">ndtype)</span>
        <span class="s1">assert_(isinstance(fval</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_equal(fval.item()</span><span class="s4">, </span><span class="s1">[default_fill_value(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">,</span>
                                   <span class="s1">default_fill_value(</span><span class="s5">0.</span><span class="s1">)</span><span class="s4">,</span>
                                   <span class="s1">asbytes(default_fill_value(</span><span class="s3">&quot;0&quot;</span><span class="s1">))])</span>
        <span class="s0">#.....Using a structured type as fill_value should work</span>
        <span class="s1">fill_val = np.array((-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s3">&quot;???&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">fval = _check_fill_value(fill_val</span><span class="s4">, </span><span class="s1">ndtype)</span>
        <span class="s1">assert_(isinstance(fval</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_equal(fval.item()</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s6">b&quot;???&quot;</span><span class="s1">])</span>

        <span class="s0">#.....Using a flexible type w/ a different type shouldn't matter</span>
        <span class="s0"># BEHAVIOR in 1.5 and earlier, and 1.13 and later: match structured</span>
        <span class="s0"># types by position</span>
        <span class="s1">fill_val = np.array((-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s3">&quot;???&quot;</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">dtype=[(</span><span class="s3">&quot;A&quot;</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">&quot;C&quot;</span><span class="s4">, </span><span class="s3">&quot;|S3&quot;</span><span class="s1">)])</span>
        <span class="s1">fval = _check_fill_value(fill_val</span><span class="s4">, </span><span class="s1">ndtype)</span>
        <span class="s1">assert_(isinstance(fval</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_equal(fval.item()</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s6">b&quot;???&quot;</span><span class="s1">])</span>

        <span class="s0">#.....Using an object-array shouldn't matter either</span>
        <span class="s1">fill_val = np.ndarray(shape=(</span><span class="s5">1</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">fill_val[</span><span class="s5">0</span><span class="s1">] = (-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s6">b&quot;???&quot;</span><span class="s1">)</span>
        <span class="s1">fval = _check_fill_value(fill_val</span><span class="s4">, </span><span class="s1">object)</span>
        <span class="s1">assert_(isinstance(fval</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_equal(fval.item()</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">12345678.9</span><span class="s4">, </span><span class="s6">b&quot;???&quot;</span><span class="s1">])</span>
        <span class="s0"># NOTE: This test was never run properly as &quot;fill_value&quot; rather than</span>
        <span class="s0"># &quot;fill_val&quot; was assigned.  Written properly, it fails.</span>
        <span class="s0">#fill_val = np.array((-999, -12345678.9, &quot;???&quot;))</span>
        <span class="s0">#fval = _check_fill_value(fill_val, ndtype)</span>
        <span class="s0">#assert_(isinstance(fval, ndarray))</span>
        <span class="s0">#assert_equal(fval.item(), [-999, -12345678.9, b&quot;???&quot;])</span>
        <span class="s0">#.....One-field-only flexible type should work as well</span>
        <span class="s1">ndtype = [(</span><span class="s3">&quot;a&quot;</span><span class="s4">, </span><span class="s1">int)]</span>
        <span class="s1">fval = _check_fill_value(-</span><span class="s5">999999999</span><span class="s4">, </span><span class="s1">ndtype)</span>
        <span class="s1">assert_(isinstance(fval</span><span class="s4">, </span><span class="s1">ndarray))</span>
        <span class="s1">assert_equal(fval.item()</span><span class="s4">, </span><span class="s1">(-</span><span class="s5">999999999</span><span class="s4">,</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_conversion(self):</span>
        <span class="s0"># Tests the behavior of fill_value during conversion</span>
        <span class="s0"># We had a tailored comment to make sure special attributes are</span>
        <span class="s0"># properly dealt with</span>
        <span class="s1">a = array([</span><span class="s6">b'3'</span><span class="s4">, </span><span class="s6">b'4'</span><span class="s4">, </span><span class="s6">b'5'</span><span class="s1">])</span>
        <span class="s1">a._optinfo.update({</span><span class="s3">'comment'</span><span class="s1">:</span><span class="s3">&quot;updated!&quot;</span><span class="s1">})</span>

        <span class="s1">b = array(a</span><span class="s4">, </span><span class="s1">dtype=int)</span>
        <span class="s1">assert_equal(b._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s5">0</span><span class="s1">))</span>

        <span class="s1">b = array(a</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(b._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s5">0.</span><span class="s1">))</span>

        <span class="s1">b = a.astype(int)</span>
        <span class="s1">assert_equal(b._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(b._optinfo[</span><span class="s3">'comment'</span><span class="s1">]</span><span class="s4">, </span><span class="s3">&quot;updated!&quot;</span><span class="s1">)</span>

        <span class="s1">b = a.astype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'|S3'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(b[</span><span class="s3">'a'</span><span class="s1">]._data</span><span class="s4">, </span><span class="s1">a._data)</span>
        <span class="s1">assert_equal(b[</span><span class="s3">'a'</span><span class="s1">].fill_value</span><span class="s4">, </span><span class="s1">a.fill_value)</span>

    <span class="s4">def </span><span class="s1">test_default_fill_value(self):</span>
        <span class="s0"># check all calling conventions</span>
        <span class="s1">f1 = default_fill_value(</span><span class="s5">1.</span><span class="s1">)</span>
        <span class="s1">f2 = default_fill_value(np.array(</span><span class="s5">1.</span><span class="s1">))</span>
        <span class="s1">f3 = default_fill_value(np.array(</span><span class="s5">1.</span><span class="s1">).dtype)</span>
        <span class="s1">assert_equal(f1</span><span class="s4">, </span><span class="s1">f2)</span>
        <span class="s1">assert_equal(f1</span><span class="s4">, </span><span class="s1">f3)</span>

    <span class="s4">def </span><span class="s1">test_default_fill_value_structured(self):</span>
        <span class="s1">fields = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">,</span>
                      <span class="s1">dtype=[(</span><span class="s3">'i'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'f'</span><span class="s4">, </span><span class="s1">float)])</span>

        <span class="s1">f1 = default_fill_value(fields)</span>
        <span class="s1">f2 = default_fill_value(fields.dtype)</span>
        <span class="s1">expected = np.array((default_fill_value(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">,</span>
                             <span class="s1">default_fill_value(</span><span class="s3">'0'</span><span class="s1">)</span><span class="s4">,</span>
                             <span class="s1">default_fill_value(</span><span class="s5">0.</span><span class="s1">))</span><span class="s4">, </span><span class="s1">dtype=fields.dtype)</span>
        <span class="s1">assert_equal(f1</span><span class="s4">, </span><span class="s1">expected)</span>
        <span class="s1">assert_equal(f2</span><span class="s4">, </span><span class="s1">expected)</span>

    <span class="s4">def </span><span class="s1">test_default_fill_value_void(self):</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'v'</span><span class="s4">, </span><span class="s3">'V7'</span><span class="s1">)])</span>
        <span class="s1">f = default_fill_value(dt)</span>
        <span class="s1">assert_equal(f[</span><span class="s3">'v'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.array(default_fill_value(dt[</span><span class="s3">'v'</span><span class="s1">])</span><span class="s4">, </span><span class="s1">dt[</span><span class="s3">'v'</span><span class="s1">]))</span>

    <span class="s4">def </span><span class="s1">test_fillvalue(self):</span>
        <span class="s0"># Yet more fun with the fill_value</span>
        <span class="s1">data = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=-</span><span class="s5">999</span><span class="s1">)</span>
        <span class="s1">series = data[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]]</span>
        <span class="s1">assert_equal(series._fill_value</span><span class="s4">, </span><span class="s1">data._fill_value)</span>

        <span class="s1">mtype = [(</span><span class="s3">'f'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s4">, </span><span class="s3">'|S3'</span><span class="s1">)]</span>
        <span class="s1">x = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s3">'a'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(pi</span><span class="s4">, </span><span class="s3">'pi'</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mtype)</span>
        <span class="s1">x.fill_value = </span><span class="s5">999</span>
        <span class="s1">assert_equal(x.fill_value.item()</span><span class="s4">, </span><span class="s1">[</span><span class="s5">999.</span><span class="s4">, </span><span class="s6">b'999'</span><span class="s1">])</span>
        <span class="s1">assert_equal(x[</span><span class="s3">'f'</span><span class="s1">].fill_value</span><span class="s4">, </span><span class="s5">999</span><span class="s1">)</span>
        <span class="s1">assert_equal(x[</span><span class="s3">'s'</span><span class="s1">].fill_value</span><span class="s4">, </span><span class="s6">b'999'</span><span class="s1">)</span>

        <span class="s1">x.fill_value = (</span><span class="s5">9</span><span class="s4">, </span><span class="s3">'???'</span><span class="s1">)</span>
        <span class="s1">assert_equal(x.fill_value.item()</span><span class="s4">, </span><span class="s1">(</span><span class="s5">9</span><span class="s4">, </span><span class="s6">b'???'</span><span class="s1">))</span>
        <span class="s1">assert_equal(x[</span><span class="s3">'f'</span><span class="s1">].fill_value</span><span class="s4">, </span><span class="s5">9</span><span class="s1">)</span>
        <span class="s1">assert_equal(x[</span><span class="s3">'s'</span><span class="s1">].fill_value</span><span class="s4">, </span><span class="s6">b'???'</span><span class="s1">)</span>

        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3.1</span><span class="s1">])</span>
        <span class="s1">x.fill_value = </span><span class="s5">999</span>
        <span class="s1">assert_equal(np.asarray(x.fill_value).dtype</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s1">assert_equal(x.fill_value</span><span class="s4">, </span><span class="s5">999.</span><span class="s1">)</span>
        <span class="s1">assert_equal(x._fill_value</span><span class="s4">, </span><span class="s1">np.array(</span><span class="s5">999.</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_subarray_fillvalue(self):</span>
        <span class="s0"># gh-10483   test multi-field index fill value</span>
        <span class="s1">fields = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">,</span>
                      <span class="s1">dtype=[(</span><span class="s3">'i'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'f'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s4">with </span><span class="s1">suppress_warnings() </span><span class="s4">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(FutureWarning</span><span class="s4">, </span><span class="s3">&quot;Numpy has detected&quot;</span><span class="s1">)</span>
            <span class="s1">subfields = fields[[</span><span class="s3">'i'</span><span class="s4">, </span><span class="s3">'f'</span><span class="s1">]]</span>
            <span class="s1">assert_equal(tuple(subfields.fill_value)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">999999</span><span class="s4">, </span><span class="s5">1.e+20</span><span class="s1">))</span>
            <span class="s0"># test comparison does not raise:</span>
            <span class="s1">subfields[</span><span class="s5">1</span><span class="s1">:] == subfields[:-</span><span class="s5">1</span><span class="s1">]</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_exotic_dtype(self):</span>
        <span class="s0"># Tests yet more exotic flexible dtypes</span>
        <span class="s1">_check_fill_value = np.ma.core._check_fill_value</span>
        <span class="s1">ndtype = [(</span><span class="s3">'i'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'f'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">control = np.array((default_fill_value(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">default_fill_value(</span><span class="s3">'0'</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">default_fill_value(</span><span class="s5">0.</span><span class="s1">)</span><span class="s4">,</span><span class="s1">)</span><span class="s4">,</span>
                           <span class="s1">dtype=ndtype)</span>
        <span class="s1">assert_equal(_check_fill_value(</span><span class="s4">None, </span><span class="s1">ndtype)</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s0"># The shape shouldn't matter</span>
        <span class="s1">ndtype = [(</span><span class="s3">'f0'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]</span>
        <span class="s1">control = np.array((default_fill_value(</span><span class="s5">0.</span><span class="s1">)</span><span class="s4">,</span><span class="s1">)</span><span class="s4">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'f0'</span><span class="s4">, </span><span class="s1">float)]).astype(ndtype)</span>
        <span class="s1">assert_equal(_check_fill_value(</span><span class="s4">None, </span><span class="s1">ndtype)</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">control = np.array((</span><span class="s5">0</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'f0'</span><span class="s4">, </span><span class="s1">float)]).astype(ndtype)</span>
        <span class="s1">assert_equal(_check_fill_value(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">ndtype)</span><span class="s4">, </span><span class="s1">control)</span>

        <span class="s1">ndtype = np.dtype(</span><span class="s3">&quot;int, (2,3)float, float&quot;</span><span class="s1">)</span>
        <span class="s1">control = np.array((default_fill_value(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">default_fill_value(</span><span class="s5">0.</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">default_fill_value(</span><span class="s5">0.</span><span class="s1">)</span><span class="s4">,</span><span class="s1">)</span><span class="s4">,</span>
                           <span class="s1">dtype=</span><span class="s3">&quot;int, float, float&quot;</span><span class="s1">).astype(ndtype)</span>
        <span class="s1">test = _check_fill_value(</span><span class="s4">None, </span><span class="s1">ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">control = np.array((</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">&quot;int, float, float&quot;</span><span class="s1">).astype(ndtype)</span>
        <span class="s1">assert_equal(_check_fill_value(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">ndtype)</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s0"># but when indexing, fill value should become scalar not tuple</span>
        <span class="s0"># See issue #6723</span>
        <span class="s1">M = masked_array(control)</span>
        <span class="s1">assert_equal(M[</span><span class="s3">&quot;f1&quot;</span><span class="s1">].fill_value.ndim</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_datetime_timedelta(self):</span>
        <span class="s0"># Test default fillvalue for datetime64 and timedelta64 types.</span>
        <span class="s0"># See issue #4476, this would return '?' which would cause errors</span>
        <span class="s0"># elsewhere</span>

        <span class="s4">for </span><span class="s1">timecode </span><span class="s4">in </span><span class="s1">(</span><span class="s3">&quot;as&quot;</span><span class="s4">, </span><span class="s3">&quot;fs&quot;</span><span class="s4">, </span><span class="s3">&quot;ps&quot;</span><span class="s4">, </span><span class="s3">&quot;ns&quot;</span><span class="s4">, </span><span class="s3">&quot;us&quot;</span><span class="s4">, </span><span class="s3">&quot;ms&quot;</span><span class="s4">, </span><span class="s3">&quot;s&quot;</span><span class="s4">, </span><span class="s3">&quot;m&quot;</span><span class="s4">,</span>
                         <span class="s3">&quot;h&quot;</span><span class="s4">, </span><span class="s3">&quot;D&quot;</span><span class="s4">, </span><span class="s3">&quot;W&quot;</span><span class="s4">, </span><span class="s3">&quot;M&quot;</span><span class="s4">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">):</span>
            <span class="s1">control = numpy.datetime64(</span><span class="s3">&quot;NaT&quot;</span><span class="s4">, </span><span class="s1">timecode)</span>
            <span class="s1">test = default_fill_value(numpy.dtype(</span><span class="s3">&quot;&lt;M8[&quot; </span><span class="s1">+ timecode + </span><span class="s3">&quot;]&quot;</span><span class="s1">))</span>
            <span class="s1">np.testing.assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

            <span class="s1">control = numpy.timedelta64(</span><span class="s3">&quot;NaT&quot;</span><span class="s4">, </span><span class="s1">timecode)</span>
            <span class="s1">test = default_fill_value(numpy.dtype(</span><span class="s3">&quot;&lt;m8[&quot; </span><span class="s1">+ timecode + </span><span class="s3">&quot;]&quot;</span><span class="s1">))</span>
            <span class="s1">np.testing.assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

    <span class="s4">def </span><span class="s1">test_extremum_fill_value(self):</span>
        <span class="s0"># Tests extremum fill values for flexible type.</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">))]</span><span class="s4">,</span>
                  <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'BA'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'BB'</span><span class="s4">, </span><span class="s1">int)])])</span>
        <span class="s1">test = a.fill_value</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">a.dtype)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'A'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">default_fill_value(a[</span><span class="s3">'A'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BA'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">default_fill_value(a[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BA'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BB'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">default_fill_value(a[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BB'</span><span class="s1">]))</span>

        <span class="s1">test = minimum_fill_value(a)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">a.dtype)</span>
        <span class="s1">assert_equal(test[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">minimum_fill_value(a[</span><span class="s3">'A'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">minimum_fill_value(a[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BA'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">minimum_fill_value(a[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BB'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">minimum_fill_value(a[</span><span class="s3">'B'</span><span class="s1">]))</span>

        <span class="s1">test = maximum_fill_value(a)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">a.dtype)</span>
        <span class="s1">assert_equal(test[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">maximum_fill_value(a[</span><span class="s3">'A'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">maximum_fill_value(a[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BA'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">maximum_fill_value(a[</span><span class="s3">'B'</span><span class="s1">][</span><span class="s3">'BB'</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">maximum_fill_value(a[</span><span class="s3">'B'</span><span class="s1">]))</span>

    <span class="s4">def </span><span class="s1">test_extremum_fill_value_subdtype(self):</span>
        <span class="s1">a = array(([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'value'</span><span class="s4">, </span><span class="s1">np.int8</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)])</span>

        <span class="s1">test = minimum_fill_value(a)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">a.dtype)</span>
        <span class="s1">assert_equal(test[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.full(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">minimum_fill_value(a[</span><span class="s3">'value'</span><span class="s1">])))</span>

        <span class="s1">test = maximum_fill_value(a)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">a.dtype)</span>
        <span class="s1">assert_equal(test[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.full(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">maximum_fill_value(a[</span><span class="s3">'value'</span><span class="s1">])))</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_individual_fields(self):</span>
        <span class="s0"># Test setting fill_value on individual fields</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)]</span>
        <span class="s0"># Explicit fill_value</span>
        <span class="s1">a = array(list(zip([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]))</span><span class="s4">,</span>
                  <span class="s1">fill_value=(-</span><span class="s5">999</span><span class="s4">, </span><span class="s1">-</span><span class="s5">999</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">aa = a[</span><span class="s3">'a'</span><span class="s1">]</span>
        <span class="s1">aa.set_fill_value(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">assert_equal(aa._fill_value</span><span class="s4">, </span><span class="s1">np.array(</span><span class="s5">10</span><span class="s1">))</span>
        <span class="s1">assert_equal(tuple(a.fill_value)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">-</span><span class="s5">999</span><span class="s1">))</span>
        <span class="s1">a.fill_value[</span><span class="s3">'b'</span><span class="s1">] = -</span><span class="s5">10</span>
        <span class="s1">assert_equal(tuple(a.fill_value)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10</span><span class="s1">))</span>
        <span class="s0"># Implicit fill_value</span>
        <span class="s1">t = array(list(zip([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]))</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">tt = t[</span><span class="s3">'a'</span><span class="s1">]</span>
        <span class="s1">tt.set_fill_value(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">assert_equal(tt._fill_value</span><span class="s4">, </span><span class="s1">np.array(</span><span class="s5">10</span><span class="s1">))</span>
        <span class="s1">assert_equal(tuple(t.fill_value)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s5">0</span><span class="s1">)))</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_implicit_structured_array(self):</span>
        <span class="s0"># Check that fill_value is always defined for structured arrays</span>
        <span class="s1">ndtype = (</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s1">adtype = (</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s1">a = array([(</span><span class="s5">1.</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2.</span><span class="s4">,</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s4">False,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s4">False,</span><span class="s1">)]</span><span class="s4">,</span>
                  <span class="s1">fill_value=(np.nan</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=np.dtype([adtype]))</span>
        <span class="s1">b = empty(a.shape</span><span class="s4">, </span><span class="s1">dtype=[adtype</span><span class="s4">, </span><span class="s1">ndtype])</span>
        <span class="s1">b[</span><span class="s3">'a'</span><span class="s1">] = a[</span><span class="s3">'a'</span><span class="s1">]</span>
        <span class="s1">b[</span><span class="s3">'a'</span><span class="s1">].set_fill_value(a[</span><span class="s3">'a'</span><span class="s1">].fill_value)</span>
        <span class="s1">f = b._fill_value[()]</span>
        <span class="s1">assert_(np.isnan(f[</span><span class="s5">0</span><span class="s1">]))</span>
        <span class="s1">assert_equal(f[-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s5">1.</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_as_arguments(self):</span>
        <span class="s0"># Test adding a fill_value parameter to empty/ones/zeros</span>
        <span class="s1">a = empty(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">999.</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.fill_value</span><span class="s4">, </span><span class="s5">999.</span><span class="s1">)</span>

        <span class="s1">a = ones(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">999.</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(a.fill_value</span><span class="s4">, </span><span class="s5">999.</span><span class="s1">)</span>

        <span class="s1">a = zeros(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">0.</span><span class="s4">, </span><span class="s1">dtype=complex)</span>
        <span class="s1">assert_equal(a.fill_value</span><span class="s4">, </span><span class="s5">0.</span><span class="s1">)</span>

        <span class="s1">a = identity(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">0.</span><span class="s4">, </span><span class="s1">dtype=complex)</span>
        <span class="s1">assert_equal(a.fill_value</span><span class="s4">, </span><span class="s5">0.</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_shape_argument(self):</span>
        <span class="s0"># Test that shape can be provides as an argument</span>
        <span class="s0"># GH issue 6106</span>
        <span class="s1">a = empty(shape=(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">))</span>
        <span class="s1">assert_equal(a.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">))</span>

        <span class="s1">a = ones(shape=(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(a.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">))</span>

        <span class="s1">a = zeros(shape=(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=complex)</span>
        <span class="s1">assert_equal(a.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_in_view(self):</span>
        <span class="s0"># Test the behavior of fill_value in view</span>

        <span class="s0"># Create initial masked array</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype=np.int64)</span>

        <span class="s0"># Check that fill_value is preserved by default</span>
        <span class="s1">y = x.view()</span>
        <span class="s1">assert_(y.fill_value == </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s0"># Check that fill_value is preserved if dtype is specified and the</span>
        <span class="s0"># dtype is an ndarray sub-class and has a _fill_value attribute</span>
        <span class="s1">y = x.view(MaskedArray)</span>
        <span class="s1">assert_(y.fill_value == </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s0"># Check that fill_value is preserved if type is specified and the</span>
        <span class="s0"># dtype is an ndarray sub-class and has a _fill_value attribute (by</span>
        <span class="s0"># default, the first argument is dtype, not type)</span>
        <span class="s1">y = x.view(type=MaskedArray)</span>
        <span class="s1">assert_(y.fill_value == </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s0"># Check that code does not crash if passed an ndarray sub-class that</span>
        <span class="s0"># does not have a _fill_value attribute</span>
        <span class="s1">y = x.view(np.ndarray)</span>
        <span class="s1">y = x.view(type=np.ndarray)</span>

        <span class="s0"># Check that fill_value can be overridden with view</span>
        <span class="s1">y = x.view(MaskedArray</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_(y.fill_value == </span><span class="s5">2</span><span class="s1">)</span>

        <span class="s0"># Check that fill_value can be overridden with view (using type=)</span>
        <span class="s1">y = x.view(type=MaskedArray</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_(y.fill_value == </span><span class="s5">2</span><span class="s1">)</span>

        <span class="s0"># Check that fill_value gets reset if passed a dtype but not a</span>
        <span class="s0"># fill_value. This is because even though in some cases one can safely</span>
        <span class="s0"># cast the fill_value, e.g. if taking an int64 view of an int32 array,</span>
        <span class="s0"># in other cases, this cannot be done (e.g. int32 view of an int64</span>
        <span class="s0"># array with a large fill_value).</span>
        <span class="s1">y = x.view(dtype=np.int32)</span>
        <span class="s1">assert_(y.fill_value == </span><span class="s5">999999</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_fillvalue_bytes_or_str(self):</span>
        <span class="s0"># Test whether fill values work as expected for structured dtypes</span>
        <span class="s0"># containing bytes or str.  See issue #7259.</span>
        <span class="s1">a = empty(shape=(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">&quot;(2)3S,(2)3U&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(a[</span><span class="s3">&quot;f0&quot;</span><span class="s1">].fill_value</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s6">b&quot;spam&quot;</span><span class="s1">))</span>
        <span class="s1">assert_equal(a[</span><span class="s3">&quot;f1&quot;</span><span class="s1">].fill_value</span><span class="s4">, </span><span class="s1">default_fill_value(</span><span class="s3">&quot;eggs&quot;</span><span class="s1">))</span>


<span class="s4">class </span><span class="s1">TestUfuncs:</span>
    <span class="s0"># Test class for the application of ufuncs on MaskedArrays.</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s0"># Base data definition.</span>
        <span class="s1">self.d = (array([</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">pi / </span><span class="s5">2</span><span class="s1">] * </span><span class="s5">2</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">] + [</span><span class="s5">0</span><span class="s1">] * </span><span class="s5">6</span><span class="s1">)</span><span class="s4">,</span>
                  <span class="s1">array([</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">pi / </span><span class="s5">2</span><span class="s1">] * </span><span class="s5">2</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] + [</span><span class="s5">0</span><span class="s1">] * </span><span class="s5">6</span><span class="s1">)</span><span class="s4">,</span><span class="s1">)</span>
        <span class="s1">self.err_status = np.geterr()</span>
        <span class="s1">np.seterr(divide=</span><span class="s3">'ignore'</span><span class="s4">, </span><span class="s1">invalid=</span><span class="s3">'ignore'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">teardown(self):</span>
        <span class="s1">np.seterr(**self.err_status)</span>

    <span class="s4">def </span><span class="s1">test_testUfuncRegression(self):</span>
        <span class="s0"># Tests new ufuncs on MaskedArrays.</span>
        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">[</span><span class="s3">'sqrt'</span><span class="s4">, </span><span class="s3">'log'</span><span class="s4">, </span><span class="s3">'log10'</span><span class="s4">, </span><span class="s3">'exp'</span><span class="s4">, </span><span class="s3">'conjugate'</span><span class="s4">,</span>
                  <span class="s3">'sin'</span><span class="s4">, </span><span class="s3">'cos'</span><span class="s4">, </span><span class="s3">'tan'</span><span class="s4">,</span>
                  <span class="s3">'arcsin'</span><span class="s4">, </span><span class="s3">'arccos'</span><span class="s4">, </span><span class="s3">'arctan'</span><span class="s4">,</span>
                  <span class="s3">'sinh'</span><span class="s4">, </span><span class="s3">'cosh'</span><span class="s4">, </span><span class="s3">'tanh'</span><span class="s4">,</span>
                  <span class="s3">'arcsinh'</span><span class="s4">,</span>
                  <span class="s3">'arccosh'</span><span class="s4">,</span>
                  <span class="s3">'arctanh'</span><span class="s4">,</span>
                  <span class="s3">'absolute'</span><span class="s4">, </span><span class="s3">'fabs'</span><span class="s4">, </span><span class="s3">'negative'</span><span class="s4">,</span>
                  <span class="s3">'floor'</span><span class="s4">, </span><span class="s3">'ceil'</span><span class="s4">,</span>
                  <span class="s3">'logical_not'</span><span class="s4">,</span>
                  <span class="s3">'add'</span><span class="s4">, </span><span class="s3">'subtract'</span><span class="s4">, </span><span class="s3">'multiply'</span><span class="s4">,</span>
                  <span class="s3">'divide'</span><span class="s4">, </span><span class="s3">'true_divide'</span><span class="s4">, </span><span class="s3">'floor_divide'</span><span class="s4">,</span>
                  <span class="s3">'remainder'</span><span class="s4">, </span><span class="s3">'fmod'</span><span class="s4">, </span><span class="s3">'hypot'</span><span class="s4">, </span><span class="s3">'arctan2'</span><span class="s4">,</span>
                  <span class="s3">'equal'</span><span class="s4">, </span><span class="s3">'not_equal'</span><span class="s4">, </span><span class="s3">'less_equal'</span><span class="s4">, </span><span class="s3">'greater_equal'</span><span class="s4">,</span>
                  <span class="s3">'less'</span><span class="s4">, </span><span class="s3">'greater'</span><span class="s4">,</span>
                  <span class="s3">'logical_and'</span><span class="s4">, </span><span class="s3">'logical_or'</span><span class="s4">, </span><span class="s3">'logical_xor'</span><span class="s4">,</span>
                  <span class="s1">]:</span>
            <span class="s4">try</span><span class="s1">:</span>
                <span class="s1">uf = getattr(umath</span><span class="s4">, </span><span class="s1">f)</span>
            <span class="s4">except </span><span class="s1">AttributeError:</span>
                <span class="s1">uf = getattr(fromnumeric</span><span class="s4">, </span><span class="s1">f)</span>
            <span class="s1">mf = getattr(numpy.ma.core</span><span class="s4">, </span><span class="s1">f)</span>
            <span class="s1">args = self.d[:uf.nin]</span>
            <span class="s1">ur = uf(*args)</span>
            <span class="s1">mr = mf(*args)</span>
            <span class="s1">assert_equal(ur.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mr.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">f)</span>
            <span class="s1">assert_mask_equal(ur.mask</span><span class="s4">, </span><span class="s1">mr.mask</span><span class="s4">, </span><span class="s1">err_msg=f)</span>

    <span class="s4">def </span><span class="s1">test_reduce(self):</span>
        <span class="s0"># Tests reduce on MaskedArrays.</span>
        <span class="s1">a = self.d[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">alltrue(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_(sometrue(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(sum(a[:</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(product(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(add.reduce(a)</span><span class="s4">, </span><span class="s1">pi)</span>

    <span class="s4">def </span><span class="s1">test_minmax(self):</span>
        <span class="s0"># Tests extrema on MaskedArrays.</span>
        <span class="s1">a = arange(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">13</span><span class="s1">).reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">amask = masked_where(a &lt; </span><span class="s5">5</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(amask.max()</span><span class="s4">, </span><span class="s1">a.max())</span>
        <span class="s1">assert_equal(amask.min()</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">assert_equal(amask.max(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">a.max(</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(amask.min(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s1">])</span>
        <span class="s1">assert_(amask.max(</span><span class="s5">1</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">].mask)</span>
        <span class="s1">assert_(amask.min(</span><span class="s5">1</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">].mask)</span>

    <span class="s4">def </span><span class="s1">test_ndarray_mask(self):</span>
        <span class="s0"># Check that the mask of the result is a ndarray (not a MaskedArray...)</span>
        <span class="s1">a = masked_array([-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">test = np.sqrt(a)</span>
        <span class="s1">control = masked_array([-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">np.sqrt(</span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                               <span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">control.mask)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(test.mask</span><span class="s4">, </span><span class="s1">MaskedArray))</span>

    <span class="s4">def </span><span class="s1">test_treatment_of_NotImplemented(self):</span>
        <span class="s0"># Check that NotImplemented is returned at appropriate places</span>

        <span class="s1">a = masked_array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_raises(TypeError</span><span class="s4">, </span><span class="s1">operator.mul</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s3">&quot;abc&quot;</span><span class="s1">)</span>
        <span class="s1">assert_raises(TypeError</span><span class="s4">, </span><span class="s1">operator.truediv</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s3">&quot;abc&quot;</span><span class="s1">)</span>

        <span class="s4">class </span><span class="s1">MyClass:</span>
            <span class="s1">__array_priority__ = a.__array_priority__ + </span><span class="s5">1</span>

            <span class="s4">def </span><span class="s1">__mul__(self</span><span class="s4">, </span><span class="s1">other):</span>
                <span class="s4">return </span><span class="s3">&quot;My mul&quot;</span>

            <span class="s4">def </span><span class="s1">__rmul__(self</span><span class="s4">, </span><span class="s1">other):</span>
                <span class="s4">return </span><span class="s3">&quot;My rmul&quot;</span>

        <span class="s1">me = MyClass()</span>
        <span class="s1">assert_(me * a == </span><span class="s3">&quot;My mul&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(a * me == </span><span class="s3">&quot;My rmul&quot;</span><span class="s1">)</span>

        <span class="s0"># and that __array_priority__ is respected</span>
        <span class="s4">class </span><span class="s1">MyClass2:</span>
            <span class="s1">__array_priority__ = </span><span class="s5">100</span>

            <span class="s4">def </span><span class="s1">__mul__(self</span><span class="s4">, </span><span class="s1">other):</span>
                <span class="s4">return </span><span class="s3">&quot;Me2mul&quot;</span>

            <span class="s4">def </span><span class="s1">__rmul__(self</span><span class="s4">, </span><span class="s1">other):</span>
                <span class="s4">return </span><span class="s3">&quot;Me2rmul&quot;</span>

            <span class="s4">def </span><span class="s1">__rdiv__(self</span><span class="s4">, </span><span class="s1">other):</span>
                <span class="s4">return </span><span class="s3">&quot;Me2rdiv&quot;</span>

            <span class="s1">__rtruediv__ = __rdiv__</span>

        <span class="s1">me_too = MyClass2()</span>
        <span class="s1">assert_(a.__mul__(me_too) </span><span class="s4">is </span><span class="s1">NotImplemented)</span>
        <span class="s1">assert_(all(multiply.outer(a</span><span class="s4">, </span><span class="s1">me_too) == </span><span class="s3">&quot;Me2rmul&quot;</span><span class="s1">))</span>
        <span class="s1">assert_(a.__truediv__(me_too) </span><span class="s4">is </span><span class="s1">NotImplemented)</span>
        <span class="s1">assert_(me_too * a == </span><span class="s3">&quot;Me2mul&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(a * me_too == </span><span class="s3">&quot;Me2rmul&quot;</span><span class="s1">)</span>
        <span class="s1">assert_(a / me_too == </span><span class="s3">&quot;Me2rdiv&quot;</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_no_masked_nan_warnings(self):</span>
        <span class="s0"># check that a nan in masked position does not</span>
        <span class="s0"># cause ufunc warnings</span>

        <span class="s1">m = np.ma.array([</span><span class="s5">0.5</span><span class="s4">, </span><span class="s1">np.nan]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">])</span>

        <span class="s4">with </span><span class="s1">warnings.catch_warnings():</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;error&quot;</span><span class="s1">)</span>

            <span class="s0"># test unary and binary ufuncs</span>
            <span class="s1">exp(m)</span>
            <span class="s1">add(m</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">m &gt; </span><span class="s5">0</span>

            <span class="s0"># test different unary domains</span>
            <span class="s1">sqrt(m)</span>
            <span class="s1">log(m)</span>
            <span class="s1">tan(m)</span>
            <span class="s1">arcsin(m)</span>
            <span class="s1">arccos(m)</span>
            <span class="s1">arccosh(m)</span>

            <span class="s0"># test binary domains</span>
            <span class="s1">divide(m</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>

            <span class="s0"># also check that allclose uses ma ufuncs, to avoid warning</span>
            <span class="s1">allclose(m</span><span class="s4">, </span><span class="s5">0.5</span><span class="s1">)</span>

<span class="s4">class </span><span class="s1">TestMaskedArrayInPlaceArithmetic:</span>
    <span class="s0"># Test MaskedArray Arithmetic</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s1">x = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">y = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">xm = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">xm[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">self.intdata = (x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm)</span>
        <span class="s1">self.floatdata = (x.astype(float)</span><span class="s4">, </span><span class="s1">y.astype(float)</span><span class="s4">, </span><span class="s1">xm.astype(float))</span>
        <span class="s1">self.othertypes = np.typecodes[</span><span class="s3">'AllInteger'</span><span class="s1">] + np.typecodes[</span><span class="s3">'AllFloat'</span><span class="s1">]</span>
        <span class="s1">self.othertypes = [np.dtype(_).type </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.othertypes]</span>
        <span class="s1">self.uint8data = (</span>
            <span class="s1">x.astype(np.uint8)</span><span class="s4">,</span>
            <span class="s1">y.astype(np.uint8)</span><span class="s4">,</span>
            <span class="s1">xm.astype(np.uint8)</span>
        <span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_addition_scalar(self):</span>
        <span class="s0"># Test of inplace additions</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.intdata</span>
        <span class="s1">xm[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">x += </span><span class="s5">1</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y + </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">xm += </span><span class="s5">1</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y + </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s1">(x</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">xm) = self.floatdata</span>
        <span class="s1">id1 = x.data.ctypes.data</span>
        <span class="s1">x += </span><span class="s5">1.</span>
        <span class="s1">assert_(id1 == x.data.ctypes.data)</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y + </span><span class="s5">1.</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_addition_array(self):</span>
        <span class="s0"># Test of inplace additions</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.intdata</span>
        <span class="s1">m = xm.mask</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=np.int16)</span>
        <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">x += a</span>
        <span class="s1">xm += a</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y + a)</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y + a)</span>
        <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">mask_or(m</span><span class="s4">, </span><span class="s1">a.mask))</span>

    <span class="s4">def </span><span class="s1">test_inplace_subtraction_scalar(self):</span>
        <span class="s0"># Test of inplace subtractions</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.intdata</span>
        <span class="s1">x -= </span><span class="s5">1</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y - </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">xm -= </span><span class="s5">1</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y - </span><span class="s5">1</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_subtraction_array(self):</span>
        <span class="s0"># Test of inplace subtractions</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.floatdata</span>
        <span class="s1">m = xm.mask</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">x -= a</span>
        <span class="s1">xm -= a</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y - a)</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y - a)</span>
        <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">mask_or(m</span><span class="s4">, </span><span class="s1">a.mask))</span>

    <span class="s4">def </span><span class="s1">test_inplace_multiplication_scalar(self):</span>
        <span class="s0"># Test of inplace multiplication</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.floatdata</span>
        <span class="s1">x *= </span><span class="s5">2.0</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y * </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">xm *= </span><span class="s5">2.0</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y * </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_multiplication_array(self):</span>
        <span class="s0"># Test of inplace multiplication</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.floatdata</span>
        <span class="s1">m = xm.mask</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">x *= a</span>
        <span class="s1">xm *= a</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y * a)</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y * a)</span>
        <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">mask_or(m</span><span class="s4">, </span><span class="s1">a.mask))</span>

    <span class="s4">def </span><span class="s1">test_inplace_division_scalar_int(self):</span>
        <span class="s0"># Test of inplace division</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.intdata</span>
        <span class="s1">x = arange(</span><span class="s5">10</span><span class="s1">) * </span><span class="s5">2</span>
        <span class="s1">xm = arange(</span><span class="s5">10</span><span class="s1">) * </span><span class="s5">2</span>
        <span class="s1">xm[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">x //= </span><span class="s5">2</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y)</span>
        <span class="s1">xm //= </span><span class="s5">2</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y)</span>

    <span class="s4">def </span><span class="s1">test_inplace_division_scalar_float(self):</span>
        <span class="s0"># Test of inplace division</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.floatdata</span>
        <span class="s1">x /= </span><span class="s5">2.0</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y / </span><span class="s5">2.0</span><span class="s1">)</span>
        <span class="s1">xm /= arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">ones((</span><span class="s5">10</span><span class="s4">,</span><span class="s1">)))</span>

    <span class="s4">def </span><span class="s1">test_inplace_division_array_float(self):</span>
        <span class="s0"># Test of inplace division</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = self.floatdata</span>
        <span class="s1">m = xm.mask</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">x /= a</span>
        <span class="s1">xm /= a</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y / a)</span>
        <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y / a)</span>
        <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">mask_or(mask_or(m</span><span class="s4">, </span><span class="s1">a.mask)</span><span class="s4">, </span><span class="s1">(a == </span><span class="s5">0</span><span class="s1">)))</span>

    <span class="s4">def </span><span class="s1">test_inplace_division_misc(self):</span>

        <span class="s1">x = [</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2.</span><span class="s4">, </span><span class="s1">pi / </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span>
        <span class="s1">y = [</span><span class="s5">5.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span>
        <span class="s1">m1 = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">m2 = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">xm = masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1)</span>
        <span class="s1">ym = masked_array(y</span><span class="s4">, </span><span class="s1">mask=m2)</span>

        <span class="s1">z = xm / ym</span>
        <span class="s1">assert_equal(z._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(z._data</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-pi / </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>

        <span class="s1">xm = xm.copy()</span>
        <span class="s1">xm /= ym</span>
        <span class="s1">assert_equal(xm._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(z._data</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-pi / </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_add(self):</span>
        <span class="s0"># Test keeping data w/ (inplace) addition</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test add w/ scalar</span>
        <span class="s1">xx = x + </span><span class="s5">1</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test iadd w/ scalar</span>
        <span class="s1">x += </span><span class="s5">1</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test add w/ array</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x + array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test iadd w/ array</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x += array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_sub(self):</span>
        <span class="s0"># Test keeping data w/ (inplace) subtraction</span>
        <span class="s0"># Test sub w/ scalar</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x - </span><span class="s5">1</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test isub w/ scalar</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x -= </span><span class="s5">1</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test sub w/ array</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x - array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test isub w/ array</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x -= array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_mul(self):</span>
        <span class="s0"># Test keeping data w/ (inplace) multiplication</span>
        <span class="s0"># Test mul w/ scalar</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x * </span><span class="s5">2</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test imul w/ scalar</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x *= </span><span class="s5">2</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test mul w/ array</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x * array([</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">40</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test imul w/ array</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x *= array([</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">40</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_div(self):</span>
        <span class="s0"># Test keeping data w/ (inplace) division</span>
        <span class="s0"># Test div on scalar</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x / </span><span class="s5">2.</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1 </span><span class="s1">/ </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2 </span><span class="s1">/ </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test idiv on scalar</span>
        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x /= </span><span class="s5">2.</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1 </span><span class="s1">/ </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">2 </span><span class="s1">/ </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test div on array</span>
        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x / array([</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">20.</span><span class="s4">, </span><span class="s5">30.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2. </span><span class="s1">/ </span><span class="s5">20.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test idiv on array</span>
        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">x /= array([</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">20.</span><span class="s4">, </span><span class="s5">30.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2 </span><span class="s1">/ </span><span class="s5">20.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_pow(self):</span>
        <span class="s0"># Test keeping data w/ (inplace) power</span>
        <span class="s0"># Test pow on scalar</span>
        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">xx = x ** </span><span class="s5">2.5</span>
        <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2. </span><span class="s1">** </span><span class="s5">2.5</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Test ipow on scalar</span>
        <span class="s1">x **= </span><span class="s5">2.5</span>
        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2. </span><span class="s1">** </span><span class="s5">2.5</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_add_arrays(self):</span>
        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">a += b</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]])</span>
        <span class="s4">if </span><span class="s1">a.mask </span><span class="s4">is not </span><span class="s1">nomask:</span>
            <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">a += b</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_sub_arrays(self):</span>
        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">a -= b</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]])</span>
        <span class="s4">if </span><span class="s1">a.mask </span><span class="s4">is not </span><span class="s1">nomask:</span>
            <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">a -= b</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_datafriendly_mul_arrays(self):</span>
        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">a *= b</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s4">if </span><span class="s1">a.mask </span><span class="s4">is not </span><span class="s1">nomask:</span>
            <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">b = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">a *= b</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_inplace_addition_scalar_type(self):</span>
        <span class="s0"># Test of inplace additions</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">xm[</span><span class="s5">2</span><span class="s1">] = masked</span>
                <span class="s1">x += t(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y + t(</span><span class="s5">1</span><span class="s1">))</span>
                <span class="s1">xm += t(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y + t(</span><span class="s5">1</span><span class="s1">))</span>

                <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_addition_array_type(self):</span>
        <span class="s0"># Test of inplace additions</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">m = xm.mask</span>
                <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t)</span>
                <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
                <span class="s1">x += a</span>
                <span class="s1">xm += a</span>
                <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y + a)</span>
                <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y + a)</span>
                <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">mask_or(m</span><span class="s4">, </span><span class="s1">a.mask))</span>

                <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_subtraction_scalar_type(self):</span>
        <span class="s0"># Test of inplace subtractions</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">x -= t(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y - t(</span><span class="s5">1</span><span class="s1">))</span>
                <span class="s1">xm -= t(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y - t(</span><span class="s5">1</span><span class="s1">))</span>

                <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_subtraction_array_type(self):</span>
        <span class="s0"># Test of inplace subtractions</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">m = xm.mask</span>
                <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t)</span>
                <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
                <span class="s1">x -= a</span>
                <span class="s1">xm -= a</span>
                <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y - a)</span>
                <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y - a)</span>
                <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">mask_or(m</span><span class="s4">, </span><span class="s1">a.mask))</span>

                <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_multiplication_scalar_type(self):</span>
        <span class="s0"># Test of inplace multiplication</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">x *= t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y * t(</span><span class="s5">2</span><span class="s1">))</span>
                <span class="s1">xm *= t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y * t(</span><span class="s5">2</span><span class="s1">))</span>

                <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_multiplication_array_type(self):</span>
        <span class="s0"># Test of inplace multiplication</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">m = xm.mask</span>
                <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t)</span>
                <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
                <span class="s1">x *= a</span>
                <span class="s1">xm *= a</span>
                <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y * a)</span>
                <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y * a)</span>
                <span class="s1">assert_equal(xm.mask</span><span class="s4">, </span><span class="s1">mask_or(m</span><span class="s4">, </span><span class="s1">a.mask))</span>

                <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_floor_division_scalar_type(self):</span>
        <span class="s0"># Test of inplace division</span>
        <span class="s0"># Check for TypeError in case of unsupported types</span>
        <span class="s1">unsupported = {np.dtype(t).type </span><span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">np.typecodes[</span><span class="s3">&quot;Complex&quot;</span><span class="s1">]}</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">x = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t) * t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">xm = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t) * t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">xm[</span><span class="s5">2</span><span class="s1">] = masked</span>
                <span class="s4">try</span><span class="s1">:</span>
                    <span class="s1">x //= t(</span><span class="s5">2</span><span class="s1">)</span>
                    <span class="s1">xm //= t(</span><span class="s5">2</span><span class="s1">)</span>
                    <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y)</span>
                    <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y)</span>

                    <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;Failed on type=%s.&quot; </span><span class="s1">% t)</span>
                <span class="s4">except </span><span class="s1">TypeError:</span>
                    <span class="s1">msg = </span><span class="s3">f&quot;Supported type </span><span class="s4">{</span><span class="s1">t</span><span class="s4">} </span><span class="s3">throwing TypeError&quot;</span>
                    <span class="s4">assert </span><span class="s1">t </span><span class="s4">in </span><span class="s1">unsupported</span><span class="s4">, </span><span class="s1">msg</span>

    <span class="s4">def </span><span class="s1">test_inplace_floor_division_array_type(self):</span>
        <span class="s0"># Test of inplace division</span>
        <span class="s0"># Check for TypeError in case of unsupported types</span>
        <span class="s1">unsupported = {np.dtype(t).type </span><span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">np.typecodes[</span><span class="s3">&quot;Complex&quot;</span><span class="s1">]}</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">m = xm.mask</span>
                <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t)</span>
                <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
                <span class="s4">try</span><span class="s1">:</span>
                    <span class="s1">x //= a</span>
                    <span class="s1">xm //= a</span>
                    <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y // a)</span>
                    <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y // a)</span>
                    <span class="s1">assert_equal(</span>
                        <span class="s1">xm.mask</span><span class="s4">,</span>
                        <span class="s1">mask_or(mask_or(m</span><span class="s4">, </span><span class="s1">a.mask)</span><span class="s4">, </span><span class="s1">(a == t(</span><span class="s5">0</span><span class="s1">)))</span>
                    <span class="s1">)</span>

                    <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>
                <span class="s4">except </span><span class="s1">TypeError:</span>
                    <span class="s1">msg = </span><span class="s3">f&quot;Supported type </span><span class="s4">{</span><span class="s1">t</span><span class="s4">} </span><span class="s3">throwing TypeError&quot;</span>
                    <span class="s4">assert </span><span class="s1">t </span><span class="s4">in </span><span class="s1">unsupported</span><span class="s4">, </span><span class="s1">msg</span>

    <span class="s4">def </span><span class="s1">test_inplace_division_scalar_type(self):</span>
        <span class="s0"># Test of inplace division</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">suppress_warnings() </span><span class="s4">as </span><span class="s1">sup:</span>
                <span class="s1">sup.record(UserWarning)</span>

                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">x = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t) * t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">xm = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t) * t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">xm[</span><span class="s5">2</span><span class="s1">] = masked</span>

                <span class="s0"># May get a DeprecationWarning or a TypeError.</span>
                <span class="s0">#</span>
                <span class="s0"># This is a consequence of the fact that this is true divide</span>
                <span class="s0"># and will require casting to float for calculation and</span>
                <span class="s0"># casting back to the original type. This will only be raised</span>
                <span class="s0"># with integers. Whether it is an error or warning is only</span>
                <span class="s0"># dependent on how stringent the casting rules are.</span>
                <span class="s0">#</span>
                <span class="s0"># Will handle the same way.</span>
                <span class="s4">try</span><span class="s1">:</span>
                    <span class="s1">x /= t(</span><span class="s5">2</span><span class="s1">)</span>
                    <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y)</span>
                <span class="s4">except </span><span class="s1">(DeprecationWarning</span><span class="s4">, </span><span class="s1">TypeError) </span><span class="s4">as </span><span class="s1">e:</span>
                    <span class="s1">warnings.warn(str(e)</span><span class="s4">, </span><span class="s1">stacklevel=</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s4">try</span><span class="s1">:</span>
                    <span class="s1">xm /= t(</span><span class="s5">2</span><span class="s1">)</span>
                    <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y)</span>
                <span class="s4">except </span><span class="s1">(DeprecationWarning</span><span class="s4">, </span><span class="s1">TypeError) </span><span class="s4">as </span><span class="s1">e:</span>
                    <span class="s1">warnings.warn(str(e)</span><span class="s4">, </span><span class="s1">stacklevel=</span><span class="s5">1</span><span class="s1">)</span>

                <span class="s4">if </span><span class="s1">issubclass(t</span><span class="s4">, </span><span class="s1">np.integer):</span>
                    <span class="s1">assert_equal(len(sup.log)</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>
                <span class="s4">else</span><span class="s1">:</span>
                    <span class="s1">assert_equal(len(sup.log)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_division_array_type(self):</span>
        <span class="s0"># Test of inplace division</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">suppress_warnings() </span><span class="s4">as </span><span class="s1">sup:</span>
                <span class="s1">sup.record(UserWarning)</span>
                <span class="s1">(x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">xm) = (_.astype(t) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">self.uint8data)</span>
                <span class="s1">m = xm.mask</span>
                <span class="s1">a = arange(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=t)</span>
                <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>

                <span class="s0"># May get a DeprecationWarning or a TypeError.</span>
                <span class="s0">#</span>
                <span class="s0"># This is a consequence of the fact that this is true divide</span>
                <span class="s0"># and will require casting to float for calculation and</span>
                <span class="s0"># casting back to the original type. This will only be raised</span>
                <span class="s0"># with integers. Whether it is an error or warning is only</span>
                <span class="s0"># dependent on how stringent the casting rules are.</span>
                <span class="s0">#</span>
                <span class="s0"># Will handle the same way.</span>
                <span class="s4">try</span><span class="s1">:</span>
                    <span class="s1">x /= a</span>
                    <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">y / a)</span>
                <span class="s4">except </span><span class="s1">(DeprecationWarning</span><span class="s4">, </span><span class="s1">TypeError) </span><span class="s4">as </span><span class="s1">e:</span>
                    <span class="s1">warnings.warn(str(e)</span><span class="s4">, </span><span class="s1">stacklevel=</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s4">try</span><span class="s1">:</span>
                    <span class="s1">xm /= a</span>
                    <span class="s1">assert_equal(xm</span><span class="s4">, </span><span class="s1">y / a)</span>
                    <span class="s1">assert_equal(</span>
                        <span class="s1">xm.mask</span><span class="s4">,</span>
                        <span class="s1">mask_or(mask_or(m</span><span class="s4">, </span><span class="s1">a.mask)</span><span class="s4">, </span><span class="s1">(a == t(</span><span class="s5">0</span><span class="s1">)))</span>
                    <span class="s1">)</span>
                <span class="s4">except </span><span class="s1">(DeprecationWarning</span><span class="s4">, </span><span class="s1">TypeError) </span><span class="s4">as </span><span class="s1">e:</span>
                    <span class="s1">warnings.warn(str(e)</span><span class="s4">, </span><span class="s1">stacklevel=</span><span class="s5">1</span><span class="s1">)</span>

                <span class="s4">if </span><span class="s1">issubclass(t</span><span class="s4">, </span><span class="s1">np.integer):</span>
                    <span class="s1">assert_equal(len(sup.log)</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>
                <span class="s4">else</span><span class="s1">:</span>
                    <span class="s1">assert_equal(len(sup.log)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_inplace_pow_type(self):</span>
        <span class="s0"># Test keeping data w/ (inplace) power</span>
        <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">self.othertypes:</span>
            <span class="s4">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s4">True</span><span class="s1">) </span><span class="s4">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">&quot;always&quot;</span><span class="s1">)</span>
                <span class="s0"># Test pow on scalar</span>
                <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=t)</span>
                <span class="s1">xx = x ** t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">xx_r = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2 </span><span class="s1">** </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=t)</span>
                <span class="s1">assert_equal(xx.data</span><span class="s4">, </span><span class="s1">xx_r.data)</span>
                <span class="s1">assert_equal(xx.mask</span><span class="s4">, </span><span class="s1">xx_r.mask)</span>
                <span class="s0"># Test ipow on scalar</span>
                <span class="s1">x **= t(</span><span class="s5">2</span><span class="s1">)</span>
                <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">xx_r.data)</span>
                <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">xx_r.mask)</span>

                <span class="s1">assert_equal(len(w)</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">f'Failed on type=</span><span class="s4">{</span><span class="s1">t</span><span class="s4">}</span><span class="s3">.'</span><span class="s1">)</span>


<span class="s4">class </span><span class="s1">TestMaskedArrayMethods:</span>
    <span class="s0"># Test class for miscellaneous MaskedArrays methods.</span>
    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s0"># Base data definition.</span>
        <span class="s1">x = np.array([</span><span class="s5">8.375</span><span class="s4">, </span><span class="s5">7.545</span><span class="s4">, </span><span class="s5">8.828</span><span class="s4">, </span><span class="s5">8.5</span><span class="s4">, </span><span class="s5">1.757</span><span class="s4">, </span><span class="s5">5.928</span><span class="s4">,</span>
                      <span class="s5">8.43</span><span class="s4">, </span><span class="s5">7.78</span><span class="s4">, </span><span class="s5">9.865</span><span class="s4">, </span><span class="s5">5.878</span><span class="s4">, </span><span class="s5">8.979</span><span class="s4">, </span><span class="s5">4.732</span><span class="s4">,</span>
                      <span class="s5">3.012</span><span class="s4">, </span><span class="s5">6.022</span><span class="s4">, </span><span class="s5">5.095</span><span class="s4">, </span><span class="s5">3.116</span><span class="s4">, </span><span class="s5">5.238</span><span class="s4">, </span><span class="s5">3.957</span><span class="s4">,</span>
                      <span class="s5">6.04</span><span class="s4">, </span><span class="s5">9.63</span><span class="s4">, </span><span class="s5">7.712</span><span class="s4">, </span><span class="s5">3.382</span><span class="s4">, </span><span class="s5">4.489</span><span class="s4">, </span><span class="s5">6.479</span><span class="s4">,</span>
                      <span class="s5">7.189</span><span class="s4">, </span><span class="s5">9.645</span><span class="s4">, </span><span class="s5">5.395</span><span class="s4">, </span><span class="s5">4.961</span><span class="s4">, </span><span class="s5">9.894</span><span class="s4">, </span><span class="s5">2.893</span><span class="s4">,</span>
                      <span class="s5">7.357</span><span class="s4">, </span><span class="s5">9.828</span><span class="s4">, </span><span class="s5">6.272</span><span class="s4">, </span><span class="s5">3.758</span><span class="s4">, </span><span class="s5">6.693</span><span class="s4">, </span><span class="s5">0.993</span><span class="s1">])</span>
        <span class="s1">X = x.reshape(</span><span class="s5">6</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)</span>
        <span class="s1">XX = x.reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>

        <span class="s1">m = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                     <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">mx = array(data=x</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">mX = array(data=X</span><span class="s4">, </span><span class="s1">mask=m.reshape(X.shape))</span>
        <span class="s1">mXX = array(data=XX</span><span class="s4">, </span><span class="s1">mask=m.reshape(XX.shape))</span>

        <span class="s1">m2 = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">m2x = array(data=x</span><span class="s4">, </span><span class="s1">mask=m2)</span>
        <span class="s1">m2X = array(data=X</span><span class="s4">, </span><span class="s1">mask=m2.reshape(X.shape))</span>
        <span class="s1">m2XX = array(data=XX</span><span class="s4">, </span><span class="s1">mask=m2.reshape(XX.shape))</span>
        <span class="s1">self.d = (x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX)</span>

    <span class="s4">def </span><span class="s1">test_generic_methods(self):</span>
        <span class="s0"># Tests some MaskedArray methods.</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.any()</span><span class="s4">, </span><span class="s1">a._data.any())</span>
        <span class="s1">assert_equal(a.all()</span><span class="s4">, </span><span class="s1">a._data.all())</span>
        <span class="s1">assert_equal(a.argmax()</span><span class="s4">, </span><span class="s1">a._data.argmax())</span>
        <span class="s1">assert_equal(a.argmin()</span><span class="s4">, </span><span class="s1">a._data.argmin())</span>
        <span class="s1">assert_equal(a.choose(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">a._data.choose(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">))</span>
        <span class="s1">assert_equal(a.compress([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span><span class="s4">, </span><span class="s1">a._data.compress([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]))</span>
        <span class="s1">assert_equal(a.conj()</span><span class="s4">, </span><span class="s1">a._data.conj())</span>
        <span class="s1">assert_equal(a.conjugate()</span><span class="s4">, </span><span class="s1">a._data.conjugate())</span>

        <span class="s1">m = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]])</span>
        <span class="s1">assert_equal(m.diagonal()</span><span class="s4">, </span><span class="s1">m._data.diagonal())</span>
        <span class="s1">assert_equal(a.sum()</span><span class="s4">, </span><span class="s1">a._data.sum())</span>
        <span class="s1">assert_equal(a.take([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span><span class="s4">, </span><span class="s1">a._data.take([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]))</span>
        <span class="s1">assert_equal(m.transpose()</span><span class="s4">, </span><span class="s1">m._data.transpose())</span>

    <span class="s4">def </span><span class="s1">test_allclose(self):</span>
        <span class="s0"># Tests allclose on arrays</span>
        <span class="s1">a = np.random.rand(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">b = a + np.random.rand(</span><span class="s5">10</span><span class="s1">) * </span><span class="s5">1e-8</span>
        <span class="s1">assert_(allclose(a</span><span class="s4">, </span><span class="s1">b))</span>
        <span class="s0"># Test allclose w/ infs</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">] = np.inf</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">allclose(a</span><span class="s4">, </span><span class="s1">b))</span>
        <span class="s1">b[</span><span class="s5">0</span><span class="s1">] = np.inf</span>
        <span class="s1">assert_(allclose(a</span><span class="s4">, </span><span class="s1">b))</span>
        <span class="s0"># Test allclose w/ masked</span>
        <span class="s1">a = masked_array(a)</span>
        <span class="s1">a[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">assert_(allclose(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">masked_equal=</span><span class="s4">True</span><span class="s1">))</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">allclose(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">masked_equal=</span><span class="s4">False</span><span class="s1">))</span>
        <span class="s0"># Test comparison w/ scalar</span>
        <span class="s1">a *= </span><span class="s5">1e-8</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">0</span>
        <span class="s1">assert_(allclose(a</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">masked_equal=</span><span class="s4">True</span><span class="s1">))</span>

        <span class="s0"># Test that the function works for MIN_INT integer typed arrays</span>
        <span class="s1">a = masked_array([np.iinfo(np.int_).min]</span><span class="s4">, </span><span class="s1">dtype=np.int_)</span>
        <span class="s1">assert_(allclose(a</span><span class="s4">, </span><span class="s1">a))</span>

    <span class="s4">def </span><span class="s1">test_allclose_timedelta(self):</span>
        <span class="s0"># Allclose currently works for timedelta64 as long as `atol` is</span>
        <span class="s0"># an integer or also a timedelta64</span>
        <span class="s1">a = np.array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">&quot;m8[ns]&quot;</span><span class="s1">)</span>
        <span class="s4">assert </span><span class="s1">allclose(a</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">atol=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s4">assert </span><span class="s1">allclose(a</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">atol=np.timedelta64(</span><span class="s5">1</span><span class="s4">, </span><span class="s3">&quot;ns&quot;</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_allany(self):</span>
        <span class="s0"># Checks the any/all methods/functions.</span>
        <span class="s1">x = np.array([[</span><span class="s5">0.13</span><span class="s4">, </span><span class="s5">0.26</span><span class="s4">, </span><span class="s5">0.90</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">0.28</span><span class="s4">, </span><span class="s5">0.33</span><span class="s4">, </span><span class="s5">0.63</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">0.31</span><span class="s4">, </span><span class="s5">0.87</span><span class="s4">, </span><span class="s5">0.70</span><span class="s1">]])</span>
        <span class="s1">m = np.array([[</span><span class="s4">True, False, False</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s4">False, False, False</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s4">True, True, False</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=np.bool_)</span>
        <span class="s1">mx = masked_array(x</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">mxbig = (mx &gt; </span><span class="s5">0.5</span><span class="s1">)</span>
        <span class="s1">mxsmall = (mx &lt; </span><span class="s5">0.5</span><span class="s1">)</span>

        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">mxbig.all())</span>
        <span class="s1">assert_(mxbig.any())</span>
        <span class="s1">assert_equal(mxbig.all(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxbig.all(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxbig.any(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxbig.any(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True, True</span><span class="s1">])</span>

        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">mxsmall.all())</span>
        <span class="s1">assert_(mxsmall.any())</span>
        <span class="s1">assert_equal(mxsmall.all(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxsmall.all(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxsmall.any(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxsmall.any(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, True, False</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_allany_oddities(self):</span>
        <span class="s0"># Some fun with all and any</span>
        <span class="s1">store = empty(()</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">full = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>

        <span class="s1">assert_(full.all() </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">full.all(out=store)</span>
        <span class="s1">assert_(store)</span>
        <span class="s1">assert_(store._mask</span><span class="s4">, True</span><span class="s1">)</span>
        <span class="s1">assert_(store </span><span class="s4">is not </span><span class="s1">masked)</span>

        <span class="s1">store = empty(()</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">assert_(full.any() </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">full.any(out=store)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">store)</span>
        <span class="s1">assert_(store._mask</span><span class="s4">, True</span><span class="s1">)</span>
        <span class="s1">assert_(store </span><span class="s4">is not </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_argmax_argmin(self):</span>
        <span class="s0"># Tests argmin &amp; argmax on MaskedArrays.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX) = self.d</span>

        <span class="s1">assert_equal(mx.argmin()</span><span class="s4">, </span><span class="s5">35</span><span class="s1">)</span>
        <span class="s1">assert_equal(mX.argmin()</span><span class="s4">, </span><span class="s5">35</span><span class="s1">)</span>
        <span class="s1">assert_equal(m2x.argmin()</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">assert_equal(m2X.argmin()</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">assert_equal(mx.argmax()</span><span class="s4">, </span><span class="s5">28</span><span class="s1">)</span>
        <span class="s1">assert_equal(mX.argmax()</span><span class="s4">, </span><span class="s5">28</span><span class="s1">)</span>
        <span class="s1">assert_equal(m2x.argmax()</span><span class="s4">, </span><span class="s5">31</span><span class="s1">)</span>
        <span class="s1">assert_equal(m2X.argmax()</span><span class="s4">, </span><span class="s5">31</span><span class="s1">)</span>

        <span class="s1">assert_equal(mX.argmin(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(m2X.argmin(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(mX.argmax(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(m2X.argmax(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">assert_equal(mX.argmin(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s1">])</span>
        <span class="s1">assert_equal(m2X.argmin(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(mX.argmax(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(m2X.argmax(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_clip(self):</span>
        <span class="s0"># Tests clip on MaskedArrays.</span>
        <span class="s1">x = np.array([</span><span class="s5">8.375</span><span class="s4">, </span><span class="s5">7.545</span><span class="s4">, </span><span class="s5">8.828</span><span class="s4">, </span><span class="s5">8.5</span><span class="s4">, </span><span class="s5">1.757</span><span class="s4">, </span><span class="s5">5.928</span><span class="s4">,</span>
                      <span class="s5">8.43</span><span class="s4">, </span><span class="s5">7.78</span><span class="s4">, </span><span class="s5">9.865</span><span class="s4">, </span><span class="s5">5.878</span><span class="s4">, </span><span class="s5">8.979</span><span class="s4">, </span><span class="s5">4.732</span><span class="s4">,</span>
                      <span class="s5">3.012</span><span class="s4">, </span><span class="s5">6.022</span><span class="s4">, </span><span class="s5">5.095</span><span class="s4">, </span><span class="s5">3.116</span><span class="s4">, </span><span class="s5">5.238</span><span class="s4">, </span><span class="s5">3.957</span><span class="s4">,</span>
                      <span class="s5">6.04</span><span class="s4">, </span><span class="s5">9.63</span><span class="s4">, </span><span class="s5">7.712</span><span class="s4">, </span><span class="s5">3.382</span><span class="s4">, </span><span class="s5">4.489</span><span class="s4">, </span><span class="s5">6.479</span><span class="s4">,</span>
                      <span class="s5">7.189</span><span class="s4">, </span><span class="s5">9.645</span><span class="s4">, </span><span class="s5">5.395</span><span class="s4">, </span><span class="s5">4.961</span><span class="s4">, </span><span class="s5">9.894</span><span class="s4">, </span><span class="s5">2.893</span><span class="s4">,</span>
                      <span class="s5">7.357</span><span class="s4">, </span><span class="s5">9.828</span><span class="s4">, </span><span class="s5">6.272</span><span class="s4">, </span><span class="s5">3.758</span><span class="s4">, </span><span class="s5">6.693</span><span class="s4">, </span><span class="s5">0.993</span><span class="s1">])</span>
        <span class="s1">m = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">mx = array(x</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">clipped = mx.clip(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">8</span><span class="s1">)</span>
        <span class="s1">assert_equal(clipped.mask</span><span class="s4">, </span><span class="s1">mx.mask)</span>
        <span class="s1">assert_equal(clipped._data</span><span class="s4">, </span><span class="s1">x.clip(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">8</span><span class="s1">))</span>
        <span class="s1">assert_equal(clipped._data</span><span class="s4">, </span><span class="s1">mx._data.clip(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">8</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_clip_out(self):</span>
        <span class="s0"># gh-14140</span>
        <span class="s1">a = np.arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">m = np.ma.MaskedArray(a</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">] * </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">m.clip(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s1">out=m)</span>
        <span class="s1">assert_equal(m.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">] * </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_compress(self):</span>
        <span class="s0"># test compress</span>
        <span class="s1">a = masked_array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">9999</span><span class="s1">)</span>
        <span class="s1">condition = (a &gt; </span><span class="s5">1.5</span><span class="s1">) &amp; (a &lt; </span><span class="s5">3.5</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.compress(condition)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>

        <span class="s1">a[[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]] = masked</span>
        <span class="s1">b = a.compress(condition)</span>
        <span class="s1">assert_equal(b._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">assert_equal(b._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s5">9999</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s1">a[condition])</span>

        <span class="s1">condition = (a &lt; </span><span class="s5">4.</span><span class="s1">)</span>
        <span class="s1">b = a.compress(condition)</span>
        <span class="s1">assert_equal(b._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">assert_equal(b._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s5">9999</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s1">a[condition])</span>

        <span class="s1">a = masked_array([[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">40</span><span class="s4">, </span><span class="s5">50</span><span class="s4">, </span><span class="s5">60</span><span class="s1">]]</span><span class="s4">,</span>
                         <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">b = a.compress(a.ravel() &gt;= </span><span class="s5">22</span><span class="s1">)</span>
        <span class="s1">assert_equal(b._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">30</span><span class="s4">, </span><span class="s5">40</span><span class="s4">, </span><span class="s5">50</span><span class="s4">, </span><span class="s5">60</span><span class="s1">])</span>
        <span class="s1">assert_equal(b._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">x = np.array([</span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">b = a.compress(x &gt;= </span><span class="s5">2</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(b._data</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">40</span><span class="s4">, </span><span class="s5">60</span><span class="s1">]])</span>
        <span class="s1">assert_equal(b._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_compressed(self):</span>
        <span class="s0"># Tests compressed</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">b = a.compressed()</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">b = a.compressed()</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_empty(self):</span>
        <span class="s0"># Tests empty/like</span>
        <span class="s1">datatype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)]</span>
        <span class="s1">a = masked_array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s3">'1.1'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s3">'2.2'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s3">'3.3'</span><span class="s1">)]</span><span class="s4">,</span>
                         <span class="s1">dtype=datatype)</span>
        <span class="s1">assert_equal(len(a.fill_value.item())</span><span class="s4">, </span><span class="s1">len(datatype))</span>

        <span class="s1">b = empty_like(a)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">a.fill_value)</span>

        <span class="s1">b = empty(len(a)</span><span class="s4">, </span><span class="s1">dtype=datatype)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">a.fill_value)</span>

        <span class="s0"># check empty_like mask handling</span>
        <span class="s1">a = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True, False</span><span class="s1">])</span>
        <span class="s1">b = empty_like(a)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">np.may_share_memory(a.mask</span><span class="s4">, </span><span class="s1">b.mask))</span>
        <span class="s1">b = a.view(masked_array)</span>
        <span class="s1">assert_(np.may_share_memory(a.mask</span><span class="s4">, </span><span class="s1">b.mask))</span>

    <span class="s4">def </span><span class="s1">test_zeros(self):</span>
        <span class="s0"># Tests zeros/like</span>
        <span class="s1">datatype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)]</span>
        <span class="s1">a = masked_array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s3">'1.1'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s3">'2.2'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s3">'3.3'</span><span class="s1">)]</span><span class="s4">,</span>
                         <span class="s1">dtype=datatype)</span>
        <span class="s1">assert_equal(len(a.fill_value.item())</span><span class="s4">, </span><span class="s1">len(datatype))</span>

        <span class="s1">b = zeros(len(a)</span><span class="s4">, </span><span class="s1">dtype=datatype)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">a.fill_value)</span>

        <span class="s1">b = zeros_like(a)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">a.fill_value)</span>

        <span class="s0"># check zeros_like mask handling</span>
        <span class="s1">a = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True, False</span><span class="s1">])</span>
        <span class="s1">b = zeros_like(a)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">np.may_share_memory(a.mask</span><span class="s4">, </span><span class="s1">b.mask))</span>
        <span class="s1">b = a.view()</span>
        <span class="s1">assert_(np.may_share_memory(a.mask</span><span class="s4">, </span><span class="s1">b.mask))</span>

    <span class="s4">def </span><span class="s1">test_ones(self):</span>
        <span class="s0"># Tests ones/like</span>
        <span class="s1">datatype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)]</span>
        <span class="s1">a = masked_array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s3">'1.1'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s3">'2.2'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s3">'3.3'</span><span class="s1">)]</span><span class="s4">,</span>
                         <span class="s1">dtype=datatype)</span>
        <span class="s1">assert_equal(len(a.fill_value.item())</span><span class="s4">, </span><span class="s1">len(datatype))</span>

        <span class="s1">b = ones(len(a)</span><span class="s4">, </span><span class="s1">dtype=datatype)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">a.fill_value)</span>

        <span class="s1">b = ones_like(a)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">assert_equal(b.fill_value</span><span class="s4">, </span><span class="s1">a.fill_value)</span>

        <span class="s0"># check ones_like mask handling</span>
        <span class="s1">a = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True, False</span><span class="s1">])</span>
        <span class="s1">b = ones_like(a)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">np.may_share_memory(a.mask</span><span class="s4">, </span><span class="s1">b.mask))</span>
        <span class="s1">b = a.view()</span>
        <span class="s1">assert_(np.may_share_memory(a.mask</span><span class="s4">, </span><span class="s1">b.mask))</span>

    <span class="s1">@suppress_copy_mask_on_assignment</span>
    <span class="s4">def </span><span class="s1">test_put(self):</span>
        <span class="s0"># Tests put.</span>
        <span class="s1">d = arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">n = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">m = make_mask(n)</span>
        <span class="s1">x = array(d</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">assert_(x[</span><span class="s5">3</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(x[</span><span class="s5">4</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">x[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]] = [</span><span class="s5">10</span><span class="s4">, </span><span class="s5">40</span><span class="s1">]</span>
        <span class="s1">assert_(x[</span><span class="s5">3</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(x[</span><span class="s5">4</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">40</span><span class="s1">])</span>

        <span class="s1">x = masked_array(arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] * </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">i = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]</span>
        <span class="s1">x.put(i</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">asarray([</span><span class="s5">6</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s1">]))</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">x.put(i</span><span class="s4">, </span><span class="s1">masked_array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]))</span>
        <span class="s1">assert_array_equal(x</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">x = masked_array(arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] * </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">put(x</span><span class="s4">, </span><span class="s1">i</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">asarray([</span><span class="s5">6</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s1">]))</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">put(x</span><span class="s4">, </span><span class="s1">i</span><span class="s4">, </span><span class="s1">masked_array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]))</span>
        <span class="s1">assert_array_equal(x</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s1">])</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_put_nomask(self):</span>
        <span class="s0"># GitHub issue 6425</span>
        <span class="s1">x = zeros(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">z = array([</span><span class="s5">3.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False, True</span><span class="s1">])</span>

        <span class="s1">x.put([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">z)</span>
        <span class="s1">assert_(x[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(x[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_(x[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(x[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_(x[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(x[</span><span class="s5">3</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(x[</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_put_hardmask(self):</span>
        <span class="s0"># Tests put on hardmask</span>
        <span class="s1">d = arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">n = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">m = make_mask(n)</span>
        <span class="s1">xh = array(d + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">mask=m</span><span class="s4">, </span><span class="s1">hard_mask=</span><span class="s4">True, </span><span class="s1">copy=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">xh.put([</span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(xh._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_putmask(self):</span>
        <span class="s1">x = arange(</span><span class="s5">6</span><span class="s1">) + </span><span class="s5">1</span>
        <span class="s1">mx = array(x</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">mask = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s0"># w/o mask, w/o masked values</span>
        <span class="s1">xx = x.copy()</span>
        <span class="s1">putmask(xx</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">, </span><span class="s5">99</span><span class="s1">)</span>
        <span class="s1">assert_equal(xx</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">99</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">99</span><span class="s1">])</span>
        <span class="s0"># w/ mask, w/o masked values</span>
        <span class="s1">mxx = mx.copy()</span>
        <span class="s1">putmask(mxx</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">, </span><span class="s5">99</span><span class="s1">)</span>
        <span class="s1">assert_equal(mxx._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">99</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">99</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># w/o mask, w/ masked values</span>
        <span class="s1">values = array([</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s4">, </span><span class="s5">40</span><span class="s4">, </span><span class="s5">50</span><span class="s4">, </span><span class="s5">60</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">xx = x.copy()</span>
        <span class="s1">putmask(xx</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">, </span><span class="s1">values)</span>
        <span class="s1">assert_equal(xx._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">30</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">60</span><span class="s1">])</span>
        <span class="s1">assert_equal(xx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># w/ mask, w/ masked values</span>
        <span class="s1">mxx = mx.copy()</span>
        <span class="s1">putmask(mxx</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">, </span><span class="s1">values)</span>
        <span class="s1">assert_equal(mxx._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">30</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">60</span><span class="s1">])</span>
        <span class="s1">assert_equal(mxx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># w/ mask, w/ masked values + hardmask</span>
        <span class="s1">mxx = mx.copy()</span>
        <span class="s1">mxx.harden_mask()</span>
        <span class="s1">putmask(mxx</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">, </span><span class="s1">values)</span>
        <span class="s1">assert_equal(mxx</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">30</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">60</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_ravel(self):</span>
        <span class="s0"># Tests ravel</span>
        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">aravel = a.ravel()</span>
        <span class="s1">assert_equal(aravel._mask.shape</span><span class="s4">, </span><span class="s1">aravel.shape)</span>
        <span class="s1">a = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">aravel = a.ravel()</span>
        <span class="s1">assert_equal(aravel._mask.shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s0"># Checks that small_mask is preserved</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">shrink=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.ravel()._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s0"># Test that the fill_value is preserved</span>
        <span class="s1">a.fill_value = -</span><span class="s5">99</span>
        <span class="s1">a.shape = (</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">ar = a.ravel()</span>
        <span class="s1">assert_equal(ar._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(ar._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(ar.fill_value</span><span class="s4">, </span><span class="s1">-</span><span class="s5">99</span><span class="s1">)</span>
        <span class="s0"># Test index ordering</span>
        <span class="s1">assert_equal(a.ravel(order=</span><span class="s3">'C'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.ravel(order=</span><span class="s3">'F'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_reshape(self):</span>
        <span class="s0"># Tests reshape</span>
        <span class="s1">x = arange(</span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">x[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">y = x.reshape(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(y.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(y._mask.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(x.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(x._mask.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4</span><span class="s4">,</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_sort(self):</span>
        <span class="s0"># Test sort</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=np.uint8)</span>

        <span class="s1">sortedx = sort(x)</span>
        <span class="s1">assert_equal(sortedx._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(sortedx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

        <span class="s1">sortedx = sort(x</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(sortedx._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(sortedx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">x.sort()</span>
        <span class="s1">assert_equal(x._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(x._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=np.uint8)</span>
        <span class="s1">x.sort(endwith=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(x._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(x._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">x = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span>
        <span class="s1">sortedx = sort(x)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(sorted</span><span class="s4">, </span><span class="s1">MaskedArray))</span>

        <span class="s1">x = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=nomask</span><span class="s4">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">sortedx = sort(x</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(sortedx._data</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">x = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">sortedx = sort(x</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(sortedx._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(sortedx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">x = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=np.int8)</span>
        <span class="s1">sortedx = sort(x</span><span class="s4">, </span><span class="s1">kind=</span><span class="s3">&quot;stable&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(sortedx</span><span class="s4">, </span><span class="s1">array([-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=np.int8))</span>

    <span class="s4">def </span><span class="s1">test_stable_sort(self):</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=np.uint8)</span>
        <span class="s1">expected = array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">computed = argsort(x</span><span class="s4">, </span><span class="s1">kind=</span><span class="s3">'stable'</span><span class="s1">)</span>
        <span class="s1">assert_equal(computed</span><span class="s4">, </span><span class="s1">expected)</span>

    <span class="s4">def </span><span class="s1">test_argsort_matches_sort(self):</span>
        <span class="s1">x = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=np.uint8)</span>

        <span class="s4">for </span><span class="s1">kwargs </span><span class="s4">in </span><span class="s1">[dict()</span><span class="s4">,</span>
                       <span class="s1">dict(endwith=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">,</span>
                       <span class="s1">dict(endwith=</span><span class="s4">False</span><span class="s1">)</span><span class="s4">,</span>
                       <span class="s1">dict(fill_value=</span><span class="s5">2</span><span class="s1">)</span><span class="s4">,</span>
                       <span class="s1">dict(fill_value=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">,</span>
                       <span class="s1">dict(fill_value=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">False</span><span class="s1">)]:</span>
            <span class="s1">sortedx = sort(x</span><span class="s4">, </span><span class="s1">**kwargs)</span>
            <span class="s1">argsortedx = x[argsort(x</span><span class="s4">, </span><span class="s1">**kwargs)]</span>
            <span class="s1">assert_equal(sortedx._data</span><span class="s4">, </span><span class="s1">argsortedx._data)</span>
            <span class="s1">assert_equal(sortedx._mask</span><span class="s4">, </span><span class="s1">argsortedx._mask)</span>

    <span class="s4">def </span><span class="s1">test_sort_2d(self):</span>
        <span class="s0"># Check sort of 2D array.</span>
        <span class="s0"># 2D array w/o mask</span>
        <span class="s1">a = masked_array([[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]])</span>
        <span class="s1">a.sort(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]])</span>
        <span class="s1">a = masked_array([[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]])</span>
        <span class="s1">a.sort(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">8</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]])</span>
        <span class="s0"># 2D array w/mask</span>
        <span class="s1">a = masked_array([[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">a.sort(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">a = masked_array([[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">a.sort(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">8</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a._mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s0"># 3D</span>
        <span class="s1">a = masked_array([[[</span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s4">,</span>
                          <span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]]</span><span class="s4">,</span>
                          <span class="s1">[[</span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]]</span><span class="s4">,</span>
                          <span class="s1">[[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]]])</span>
        <span class="s1">a[a % </span><span class="s5">4 </span><span class="s1">== </span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">am = a.copy()</span>
        <span class="s1">an = a.filled(</span><span class="s5">99</span><span class="s1">)</span>
        <span class="s1">am.sort(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">an.sort(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(am</span><span class="s4">, </span><span class="s1">an)</span>
        <span class="s1">am = a.copy()</span>
        <span class="s1">an = a.filled(</span><span class="s5">99</span><span class="s1">)</span>
        <span class="s1">am.sort(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">an.sort(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(am</span><span class="s4">, </span><span class="s1">an)</span>
        <span class="s1">am = a.copy()</span>
        <span class="s1">an = a.filled(</span><span class="s5">99</span><span class="s1">)</span>
        <span class="s1">am.sort(</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">an.sort(</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(am</span><span class="s4">, </span><span class="s1">an)</span>

    <span class="s4">def </span><span class="s1">test_sort_flexible(self):</span>
        <span class="s0"># Test sort on structured dtype.</span>
        <span class="s1">a = array(</span>
            <span class="s1">data=[(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">,</span>
            <span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
            <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s1">mask_last = array(</span>
            <span class="s1">data=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
            <span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
            <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s1">mask_first = array(</span>
            <span class="s1">data=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)]</span><span class="s4">,</span>
            <span class="s1">mask=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
            <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">int)])</span>

        <span class="s1">test = sort(a)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">mask_last)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">mask_last.mask)</span>

        <span class="s1">test = sort(a</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">mask_first)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">mask_first.mask)</span>

        <span class="s0"># Test sort on dtype with subarray (gh-8069)</span>
        <span class="s0"># Just check that the sort does not error, structured array subarrays</span>
        <span class="s0"># are treated as byte strings and that leads to differing behavior</span>
        <span class="s0"># depending on endianness and `endwith`.</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'v'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)])</span>
        <span class="s1">a = a.view(dt)</span>
        <span class="s1">test = sort(a)</span>
        <span class="s1">test = sort(a</span><span class="s4">, </span><span class="s1">endwith=</span><span class="s4">False</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_argsort(self):</span>
        <span class="s0"># Test argsort</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(np.argsort(a)</span><span class="s4">, </span><span class="s1">argsort(a))</span>

    <span class="s4">def </span><span class="s1">test_squeeze(self):</span>
        <span class="s0"># Check squeeze</span>
        <span class="s1">data = masked_array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">assert_equal(data.squeeze()</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">data = masked_array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">assert_equal(data.squeeze()</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(data.squeeze()._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

        <span class="s0"># normal ndarrays return a view</span>
        <span class="s1">arr = np.array([[</span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">arr_sq = arr.squeeze()</span>
        <span class="s1">assert_equal(arr_sq</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">arr_sq[...] = </span><span class="s5">2</span>
        <span class="s1">assert_equal(arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>

        <span class="s0"># so maskedarrays should too</span>
        <span class="s1">m_arr = masked_array([[</span><span class="s5">1</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">m_arr_sq = m_arr.squeeze()</span>
        <span class="s1">assert_(m_arr_sq </span><span class="s4">is not </span><span class="s1">np.ma.masked)</span>
        <span class="s1">assert_equal(m_arr_sq.mask</span><span class="s4">, True</span><span class="s1">)</span>
        <span class="s1">m_arr_sq[...] = </span><span class="s5">2</span>
        <span class="s1">assert_equal(m_arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_swapaxes(self):</span>
        <span class="s0"># Tests swapaxes on MaskedArrays.</span>
        <span class="s1">x = np.array([</span><span class="s5">8.375</span><span class="s4">, </span><span class="s5">7.545</span><span class="s4">, </span><span class="s5">8.828</span><span class="s4">, </span><span class="s5">8.5</span><span class="s4">, </span><span class="s5">1.757</span><span class="s4">, </span><span class="s5">5.928</span><span class="s4">,</span>
                      <span class="s5">8.43</span><span class="s4">, </span><span class="s5">7.78</span><span class="s4">, </span><span class="s5">9.865</span><span class="s4">, </span><span class="s5">5.878</span><span class="s4">, </span><span class="s5">8.979</span><span class="s4">, </span><span class="s5">4.732</span><span class="s4">,</span>
                      <span class="s5">3.012</span><span class="s4">, </span><span class="s5">6.022</span><span class="s4">, </span><span class="s5">5.095</span><span class="s4">, </span><span class="s5">3.116</span><span class="s4">, </span><span class="s5">5.238</span><span class="s4">, </span><span class="s5">3.957</span><span class="s4">,</span>
                      <span class="s5">6.04</span><span class="s4">, </span><span class="s5">9.63</span><span class="s4">, </span><span class="s5">7.712</span><span class="s4">, </span><span class="s5">3.382</span><span class="s4">, </span><span class="s5">4.489</span><span class="s4">, </span><span class="s5">6.479</span><span class="s4">,</span>
                      <span class="s5">7.189</span><span class="s4">, </span><span class="s5">9.645</span><span class="s4">, </span><span class="s5">5.395</span><span class="s4">, </span><span class="s5">4.961</span><span class="s4">, </span><span class="s5">9.894</span><span class="s4">, </span><span class="s5">2.893</span><span class="s4">,</span>
                      <span class="s5">7.357</span><span class="s4">, </span><span class="s5">9.828</span><span class="s4">, </span><span class="s5">6.272</span><span class="s4">, </span><span class="s5">3.758</span><span class="s4">, </span><span class="s5">6.693</span><span class="s4">, </span><span class="s5">0.993</span><span class="s1">])</span>
        <span class="s1">m = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">mX = array(x</span><span class="s4">, </span><span class="s1">mask=m).reshape(</span><span class="s5">6</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)</span>
        <span class="s1">mXX = mX.reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>

        <span class="s1">mXswapped = mX.swapaxes(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(mXswapped[-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mX[:</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">])</span>

        <span class="s1">mXXswapped = mXX.swapaxes(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(mXXswapped.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_take(self):</span>
        <span class="s0"># Tests take</span>
        <span class="s1">x = masked_array([</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s4">, </span><span class="s5">40</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(x.take([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span><span class="s4">, </span><span class="s1">masked_array([</span><span class="s5">10</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">40</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]))</span>
        <span class="s1">assert_equal(x.take([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span><span class="s4">, </span><span class="s1">x[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">assert_equal(x.take([[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span><span class="s4">,</span>
                     <span class="s1">masked_array([[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]]))</span>

        <span class="s0"># assert_equal crashes when passed np.ma.mask</span>
        <span class="s1">assert_(x[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>
        <span class="s1">assert_(x.take(</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>

        <span class="s1">x = array([[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">40</span><span class="s4">, </span><span class="s5">50</span><span class="s4">, </span><span class="s5">60</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">]])</span>
        <span class="s1">assert_equal(x.take([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span><span class="s4">,</span>
                     <span class="s1">array([[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">40</span><span class="s4">, </span><span class="s5">60</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]]))</span>
        <span class="s1">assert_equal(take(x</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span><span class="s4">,</span>
                     <span class="s1">array([[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">40</span><span class="s4">, </span><span class="s5">60</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]]))</span>

    <span class="s4">def </span><span class="s1">test_take_masked_indices(self):</span>
        <span class="s0"># Test take w/ masked indices</span>
        <span class="s1">a = np.array((</span><span class="s5">40</span><span class="s4">, </span><span class="s5">18</span><span class="s4">, </span><span class="s5">37</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s5">22</span><span class="s1">))</span>
        <span class="s1">indices = np.arange(</span><span class="s5">3</span><span class="s1">)[</span><span class="s4">None,</span><span class="s1">:] + np.arange(</span><span class="s5">5</span><span class="s1">)[:</span><span class="s4">, None</span><span class="s1">]</span>
        <span class="s1">mindices = array(indices</span><span class="s4">, </span><span class="s1">mask=(indices &gt;= len(a)))</span>
        <span class="s0"># No mask</span>
        <span class="s1">test = take(a</span><span class="s4">, </span><span class="s1">mindices</span><span class="s4">, </span><span class="s1">mode=</span><span class="s3">'clip'</span><span class="s1">)</span>
        <span class="s1">ctrl = array([[</span><span class="s5">40</span><span class="s4">, </span><span class="s5">18</span><span class="s4">, </span><span class="s5">37</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">18</span><span class="s4">, </span><span class="s5">37</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">37</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s5">22</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">9</span><span class="s4">, </span><span class="s5">22</span><span class="s4">, </span><span class="s5">22</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">22</span><span class="s4">, </span><span class="s5">22</span><span class="s4">, </span><span class="s5">22</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s0"># Masked indices</span>
        <span class="s1">test = take(a</span><span class="s4">, </span><span class="s1">mindices)</span>
        <span class="s1">ctrl = array([[</span><span class="s5">40</span><span class="s4">, </span><span class="s5">18</span><span class="s4">, </span><span class="s5">37</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">18</span><span class="s4">, </span><span class="s5">37</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">37</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s5">22</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">9</span><span class="s4">, </span><span class="s5">22</span><span class="s4">, </span><span class="s5">40</span><span class="s1">]</span><span class="s4">,</span>
                      <span class="s1">[</span><span class="s5">22</span><span class="s4">, </span><span class="s5">40</span><span class="s4">, </span><span class="s5">40</span><span class="s1">]])</span>
        <span class="s1">ctrl[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">] = ctrl[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">] = ctrl[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">ctrl.mask)</span>
        <span class="s0"># Masked input + masked indices</span>
        <span class="s1">a = array((</span><span class="s5">40</span><span class="s4">, </span><span class="s5">18</span><span class="s4">, </span><span class="s5">37</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s5">22</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">test = take(a</span><span class="s4">, </span><span class="s1">mindices)</span>
        <span class="s1">ctrl[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">] = ctrl[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">ctrl.mask)</span>

    <span class="s4">def </span><span class="s1">test_tolist(self):</span>
        <span class="s0"># Tests to list</span>
        <span class="s0"># ... on 1D</span>
        <span class="s1">x = array(np.arange(</span><span class="s5">12</span><span class="s1">))</span>
        <span class="s1">x[[</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2</span><span class="s1">]] = masked</span>
        <span class="s1">xlist = x.tolist()</span>
        <span class="s1">assert_(xlist[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is None</span><span class="s1">)</span>
        <span class="s1">assert_(xlist[-</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is None</span><span class="s1">)</span>
        <span class="s0"># ... on 2D</span>
        <span class="s1">x.shape = (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">xlist = x.tolist()</span>
        <span class="s1">ctrl = [[</span><span class="s5">0</span><span class="s4">, None, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">7</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, None, </span><span class="s5">11</span><span class="s1">]]</span>
        <span class="s1">assert_equal(xlist[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, None, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(xlist[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">7</span><span class="s1">])</span>
        <span class="s1">assert_equal(xlist[</span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, None, </span><span class="s5">11</span><span class="s1">])</span>
        <span class="s1">assert_equal(xlist</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s0"># ... on structured array w/ masked records</span>
        <span class="s1">x = array(list(zip([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">,</span>
                           <span class="s1">[</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s1">]</span><span class="s4">,</span>
                           <span class="s1">[</span><span class="s3">'one'</span><span class="s4">, </span><span class="s3">'two'</span><span class="s4">, </span><span class="s3">'thr'</span><span class="s1">]))</span><span class="s4">,</span>
                  <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)])</span>
        <span class="s1">x[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(x.tolist()</span><span class="s4">,</span>
                     <span class="s1">[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s6">b'one'</span><span class="s1">)</span><span class="s4">,</span>
                      <span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s6">b'two'</span><span class="s1">)</span><span class="s4">,</span>
                      <span class="s1">(</span><span class="s4">None, None, None</span><span class="s1">)])</span>
        <span class="s0"># ... on structured array w/ masked fields</span>
        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
                  <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s1">test = a.tolist()</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, None</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]])</span>
        <span class="s0"># ... on mvoid</span>
        <span class="s1">a = a[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">test = a.tolist()</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, None</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_tolist_specialcase(self):</span>
        <span class="s0"># Test mvoid.tolist: make sure we return a standard Python object</span>
        <span class="s1">a = array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s0"># w/o mask: each entry is a np.void whose elements are standard Python</span>
        <span class="s4">for </span><span class="s1">entry </span><span class="s4">in </span><span class="s1">a:</span>
            <span class="s4">for </span><span class="s1">item </span><span class="s4">in </span><span class="s1">entry.tolist():</span>
                <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(item</span><span class="s4">, </span><span class="s1">np.generic))</span>
        <span class="s0"># w/ mask: each entry is a ma.void whose elements should be</span>
        <span class="s0"># standard Python</span>
        <span class="s1">a.mask[</span><span class="s5">0</span><span class="s1">] = (</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s4">for </span><span class="s1">entry </span><span class="s4">in </span><span class="s1">a:</span>
            <span class="s4">for </span><span class="s1">item </span><span class="s4">in </span><span class="s1">entry.tolist():</span>
                <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(item</span><span class="s4">, </span><span class="s1">np.generic))</span>

    <span class="s4">def </span><span class="s1">test_toflex(self):</span>
        <span class="s0"># Test the conversion to records</span>
        <span class="s1">data = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">record = data.toflex()</span>
        <span class="s1">assert_equal(record[</span><span class="s3">'_data'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._data)</span>
        <span class="s1">assert_equal(record[</span><span class="s3">'_mask'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._mask)</span>

        <span class="s1">data[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]] = masked</span>
        <span class="s1">record = data.toflex()</span>
        <span class="s1">assert_equal(record[</span><span class="s3">'_data'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._data)</span>
        <span class="s1">assert_equal(record[</span><span class="s3">'_mask'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._mask)</span>

        <span class="s1">ndtype = [(</span><span class="s3">'i'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s4">, </span><span class="s3">'|S3'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'f'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">data = array([(i</span><span class="s4">, </span><span class="s1">s</span><span class="s4">, </span><span class="s1">f) </span><span class="s4">for </span><span class="s1">(i</span><span class="s4">, </span><span class="s1">s</span><span class="s4">, </span><span class="s1">f) </span><span class="s4">in </span><span class="s1">zip(np.arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">,</span>
                                                     <span class="s3">'ABCDEFGHIJKLM'</span><span class="s4">,</span>
                                                     <span class="s1">np.random.rand(</span><span class="s5">10</span><span class="s1">))]</span><span class="s4">,</span>
                     <span class="s1">dtype=ndtype)</span>
        <span class="s1">data[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]] = masked</span>
        <span class="s1">record = data.toflex()</span>
        <span class="s1">assert_equal(record[</span><span class="s3">'_data'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._data)</span>
        <span class="s1">assert_equal(record[</span><span class="s3">'_mask'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._mask)</span>

        <span class="s1">ndtype = np.dtype(</span><span class="s3">&quot;int, (2,3)float, float&quot;</span><span class="s1">)</span>
        <span class="s1">data = array([(i</span><span class="s4">, </span><span class="s1">f</span><span class="s4">, </span><span class="s1">ff) </span><span class="s4">for </span><span class="s1">(i</span><span class="s4">, </span><span class="s1">f</span><span class="s4">, </span><span class="s1">ff) </span><span class="s4">in </span><span class="s1">zip(np.arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">,</span>
                                                       <span class="s1">np.random.rand(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">,</span>
                                                       <span class="s1">np.random.rand(</span><span class="s5">10</span><span class="s1">))]</span><span class="s4">,</span>
                     <span class="s1">dtype=ndtype)</span>
        <span class="s1">data[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]] = masked</span>
        <span class="s1">record = data.toflex()</span>
        <span class="s1">assert_equal_records(record[</span><span class="s3">'_data'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._data)</span>
        <span class="s1">assert_equal_records(record[</span><span class="s3">'_mask'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">data._mask)</span>

    <span class="s4">def </span><span class="s1">test_fromflex(self):</span>
        <span class="s0"># Test the reconstruction of a masked_array from a record</span>
        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">test = fromflex(a.toflex())</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">a.mask)</span>

        <span class="s1">a = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">test = fromflex(a.toflex())</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">a.mask)</span>

        <span class="s1">a = array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">mask=[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">,</span>
                  <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">test = fromflex(a.toflex())</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(test.data</span><span class="s4">, </span><span class="s1">a.data)</span>

    <span class="s4">def </span><span class="s1">test_arraymethod(self):</span>
        <span class="s0"># Test a _arraymethod w/ n argument</span>
        <span class="s1">marray = masked_array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">control = masked_array([[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">5</span><span class="s1">]]</span><span class="s4">,</span>
                               <span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(marray.T</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(marray.transpose()</span><span class="s4">, </span><span class="s1">control)</span>

        <span class="s1">assert_equal(MaskedArray.cumsum(marray.T</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">control.cumsum(</span><span class="s5">0</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_arraymethod_0d(self):</span>
        <span class="s0"># gh-9430</span>
        <span class="s1">x = np.ma.array(</span><span class="s5">42</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(x.T.mask</span><span class="s4">, </span><span class="s1">x.mask)</span>
        <span class="s1">assert_equal(x.T.data</span><span class="s4">, </span><span class="s1">x.data)</span>

    <span class="s4">def </span><span class="s1">test_transpose_view(self):</span>
        <span class="s1">x = np.ma.array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]])</span>
        <span class="s1">x[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">] = np.ma.masked</span>
        <span class="s1">xt = x.T</span>

        <span class="s1">xt[</span><span class="s5">1</span><span class="s4">,</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">10</span>
        <span class="s1">xt[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">] = np.ma.masked</span>

        <span class="s1">assert_equal(x.data</span><span class="s4">, </span><span class="s1">xt.T.data)</span>
        <span class="s1">assert_equal(x.mask</span><span class="s4">, </span><span class="s1">xt.T.mask)</span>

    <span class="s4">def </span><span class="s1">test_diagonal_view(self):</span>
        <span class="s1">x = np.ma.zeros((</span><span class="s5">3</span><span class="s4">,</span><span class="s5">3</span><span class="s1">))</span>
        <span class="s1">x[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">10</span>
        <span class="s1">x[</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s1">] = np.ma.masked</span>
        <span class="s1">x[</span><span class="s5">2</span><span class="s4">,</span><span class="s5">2</span><span class="s1">] = </span><span class="s5">20</span>
        <span class="s1">xd = x.diagonal()</span>
        <span class="s1">x[</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">15</span>
        <span class="s1">assert_equal(xd.mask</span><span class="s4">, </span><span class="s1">x.diagonal().mask)</span>
        <span class="s1">assert_equal(xd.data</span><span class="s4">, </span><span class="s1">x.diagonal().data)</span>


<span class="s4">class </span><span class="s1">TestMaskedArrayMathMethods:</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s0"># Base data definition.</span>
        <span class="s1">x = np.array([</span><span class="s5">8.375</span><span class="s4">, </span><span class="s5">7.545</span><span class="s4">, </span><span class="s5">8.828</span><span class="s4">, </span><span class="s5">8.5</span><span class="s4">, </span><span class="s5">1.757</span><span class="s4">, </span><span class="s5">5.928</span><span class="s4">,</span>
                      <span class="s5">8.43</span><span class="s4">, </span><span class="s5">7.78</span><span class="s4">, </span><span class="s5">9.865</span><span class="s4">, </span><span class="s5">5.878</span><span class="s4">, </span><span class="s5">8.979</span><span class="s4">, </span><span class="s5">4.732</span><span class="s4">,</span>
                      <span class="s5">3.012</span><span class="s4">, </span><span class="s5">6.022</span><span class="s4">, </span><span class="s5">5.095</span><span class="s4">, </span><span class="s5">3.116</span><span class="s4">, </span><span class="s5">5.238</span><span class="s4">, </span><span class="s5">3.957</span><span class="s4">,</span>
                      <span class="s5">6.04</span><span class="s4">, </span><span class="s5">9.63</span><span class="s4">, </span><span class="s5">7.712</span><span class="s4">, </span><span class="s5">3.382</span><span class="s4">, </span><span class="s5">4.489</span><span class="s4">, </span><span class="s5">6.479</span><span class="s4">,</span>
                      <span class="s5">7.189</span><span class="s4">, </span><span class="s5">9.645</span><span class="s4">, </span><span class="s5">5.395</span><span class="s4">, </span><span class="s5">4.961</span><span class="s4">, </span><span class="s5">9.894</span><span class="s4">, </span><span class="s5">2.893</span><span class="s4">,</span>
                      <span class="s5">7.357</span><span class="s4">, </span><span class="s5">9.828</span><span class="s4">, </span><span class="s5">6.272</span><span class="s4">, </span><span class="s5">3.758</span><span class="s4">, </span><span class="s5">6.693</span><span class="s4">, </span><span class="s5">0.993</span><span class="s1">])</span>
        <span class="s1">X = x.reshape(</span><span class="s5">6</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)</span>
        <span class="s1">XX = x.reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>

        <span class="s1">m = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                     <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">mx = array(data=x</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">mX = array(data=X</span><span class="s4">, </span><span class="s1">mask=m.reshape(X.shape))</span>
        <span class="s1">mXX = array(data=XX</span><span class="s4">, </span><span class="s1">mask=m.reshape(XX.shape))</span>

        <span class="s1">m2 = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">m2x = array(data=x</span><span class="s4">, </span><span class="s1">mask=m2)</span>
        <span class="s1">m2X = array(data=X</span><span class="s4">, </span><span class="s1">mask=m2.reshape(X.shape))</span>
        <span class="s1">m2XX = array(data=XX</span><span class="s4">, </span><span class="s1">mask=m2.reshape(XX.shape))</span>
        <span class="s1">self.d = (x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX)</span>

    <span class="s4">def </span><span class="s1">test_cumsumprod(self):</span>
        <span class="s0"># Tests cumsum &amp; cumprod on MaskedArrays.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX) = self.d</span>
        <span class="s1">mXcp = mX.cumsum(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(mXcp._data</span><span class="s4">, </span><span class="s1">mX.filled(</span><span class="s5">0</span><span class="s1">).cumsum(</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">mXcp = mX.cumsum(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(mXcp._data</span><span class="s4">, </span><span class="s1">mX.filled(</span><span class="s5">0</span><span class="s1">).cumsum(</span><span class="s5">1</span><span class="s1">))</span>

        <span class="s1">mXcp = mX.cumprod(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(mXcp._data</span><span class="s4">, </span><span class="s1">mX.filled(</span><span class="s5">1</span><span class="s1">).cumprod(</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">mXcp = mX.cumprod(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(mXcp._data</span><span class="s4">, </span><span class="s1">mX.filled(</span><span class="s5">1</span><span class="s1">).cumprod(</span><span class="s5">1</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_cumsumprod_with_output(self):</span>
        <span class="s0"># Tests cumsum/cumprod w/ output</span>
        <span class="s1">xm = array(np.random.uniform(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">12</span><span class="s1">)).reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">xm[:</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] = xm[</span><span class="s5">0</span><span class="s1">] = xm[-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = masked</span>

        <span class="s4">for </span><span class="s1">funcname </span><span class="s4">in </span><span class="s1">(</span><span class="s3">'cumsum'</span><span class="s4">, </span><span class="s3">'cumprod'</span><span class="s1">):</span>
            <span class="s1">npfunc = getattr(np</span><span class="s4">, </span><span class="s1">funcname)</span>
            <span class="s1">xmmeth = getattr(xm</span><span class="s4">, </span><span class="s1">funcname)</span>

            <span class="s0"># A ndarray as explicit input</span>
            <span class="s1">output = np.empty((</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=float)</span>
            <span class="s1">output.fill(-</span><span class="s5">9999</span><span class="s1">)</span>
            <span class="s1">result = npfunc(xm</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=output)</span>
            <span class="s0"># ... the result should be the given output</span>
            <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">output)</span>
            <span class="s1">assert_equal(result</span><span class="s4">, </span><span class="s1">xmmeth(axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=output))</span>

            <span class="s1">output = empty((</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=int)</span>
            <span class="s1">result = xmmeth(axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">out=output)</span>
            <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">output)</span>

    <span class="s4">def </span><span class="s1">test_ptp(self):</span>
        <span class="s0"># Tests ptp on MaskedArrays.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX) = self.d</span>
        <span class="s1">(n</span><span class="s4">, </span><span class="s1">m) = X.shape</span>
        <span class="s1">assert_equal(mx.ptp()</span><span class="s4">, </span><span class="s1">mx.compressed().ptp())</span>
        <span class="s1">rows = np.zeros(n</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s1">cols = np.zeros(m</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s4">for </span><span class="s1">k </span><span class="s4">in </span><span class="s1">range(m):</span>
            <span class="s1">cols[k] = mX[:</span><span class="s4">, </span><span class="s1">k].compressed().ptp()</span>
        <span class="s4">for </span><span class="s1">k </span><span class="s4">in </span><span class="s1">range(n):</span>
            <span class="s1">rows[k] = mX[k].compressed().ptp()</span>
        <span class="s1">assert_equal(mX.ptp(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">cols)</span>
        <span class="s1">assert_equal(mX.ptp(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">rows)</span>

    <span class="s4">def </span><span class="s1">test_add_object(self):</span>
        <span class="s1">x = masked_array([</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">y = x + </span><span class="s3">'x'</span>
        <span class="s1">assert_equal(y[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s3">'bx'</span><span class="s1">)</span>
        <span class="s1">assert_(y.mask[</span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_sum_object(self):</span>
        <span class="s0"># Test sum on object dtype</span>
        <span class="s1">a = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">assert_equal(a.sum()</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">a = masked_array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">assert_equal(a.sum(axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">5</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">9</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_prod_object(self):</span>
        <span class="s0"># Test prod on object dtype</span>
        <span class="s1">a = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">assert_equal(a.prod()</span><span class="s4">, </span><span class="s5">2 </span><span class="s1">* </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">a = masked_array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">assert_equal(a.prod(axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">18</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_meananom_object(self):</span>
        <span class="s0"># Test mean/anom on object dtype</span>
        <span class="s1">a = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=object)</span>
        <span class="s1">assert_equal(a.mean()</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.anom()</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_anom_shape(self):</span>
        <span class="s1">a = masked_array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.anom().shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">a.mask = </span><span class="s4">True</span>
        <span class="s1">assert_equal(a.anom().shape</span><span class="s4">, </span><span class="s1">a.shape)</span>
        <span class="s1">assert_(np.ma.is_masked(a.anom()))</span>

    <span class="s4">def </span><span class="s1">test_anom(self):</span>
        <span class="s1">a = masked_array(np.arange(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">7</span><span class="s1">).reshape(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(a.anom()</span><span class="s4">,</span>
                            <span class="s1">[[-</span><span class="s5">2.5</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.5</span><span class="s4">, </span><span class="s1">-</span><span class="s5">0.5</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">1.5</span><span class="s4">, </span><span class="s5">2.5</span><span class="s1">]])</span>
        <span class="s1">assert_almost_equal(a.anom(axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">[[-</span><span class="s5">1.5</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.5</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.5</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.5</span><span class="s4">, </span><span class="s5">1.5</span><span class="s4">, </span><span class="s5">1.5</span><span class="s1">]])</span>
        <span class="s1">assert_almost_equal(a.anom(axis=</span><span class="s5">1</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">[[-</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">1.</span><span class="s1">]])</span>
        <span class="s1">a.mask = [[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]]</span>
        <span class="s1">mval = -</span><span class="s5">99</span>
        <span class="s1">assert_almost_equal(a.anom().filled(mval)</span><span class="s4">,</span>
                            <span class="s1">[[-</span><span class="s5">2.25</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.25</span><span class="s4">, </span><span class="s1">mval]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0.75</span><span class="s4">, </span><span class="s1">mval</span><span class="s4">, </span><span class="s5">2.75</span><span class="s1">]])</span>
        <span class="s1">assert_almost_equal(a.anom(axis=</span><span class="s5">0</span><span class="s1">).filled(mval)</span><span class="s4">,</span>
                            <span class="s1">[[-</span><span class="s5">1.5</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s1">mval]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.5</span><span class="s4">, </span><span class="s1">mval</span><span class="s4">, </span><span class="s5">0.0</span><span class="s1">]])</span>
        <span class="s1">assert_almost_equal(a.anom(axis=</span><span class="s5">1</span><span class="s1">).filled(mval)</span><span class="s4">,</span>
                            <span class="s1">[[-</span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">, </span><span class="s1">mval]</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">1.0</span><span class="s4">, </span><span class="s1">mval</span><span class="s4">, </span><span class="s5">1.0</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_trace(self):</span>
        <span class="s0"># Tests trace on MaskedArrays.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX) = self.d</span>
        <span class="s1">mXdiag = mX.diagonal()</span>
        <span class="s1">assert_equal(mX.trace()</span><span class="s4">, </span><span class="s1">mX.diagonal().compressed().sum())</span>
        <span class="s1">assert_almost_equal(mX.trace()</span><span class="s4">,</span>
                            <span class="s1">X.trace() - sum(mXdiag.mask * X.diagonal()</span><span class="s4">,</span>
                                            <span class="s1">axis=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.trace(mX)</span><span class="s4">, </span><span class="s1">mX.trace())</span>

        <span class="s0"># gh-5560</span>
        <span class="s1">arr = np.arange(</span><span class="s5">2</span><span class="s1">*</span><span class="s5">4</span><span class="s1">*</span><span class="s5">4</span><span class="s1">).reshape(</span><span class="s5">2</span><span class="s4">,</span><span class="s5">4</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">m_arr = np.ma.masked_array(arr</span><span class="s4">, False</span><span class="s1">)</span>
        <span class="s1">assert_equal(arr.trace(axis1=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">axis2=</span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">m_arr.trace(axis1=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">axis2=</span><span class="s5">2</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_dot(self):</span>
        <span class="s0"># Tests dot on MaskedArrays.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX) = self.d</span>
        <span class="s1">fx = mx.filled(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">r = mx.dot(mx)</span>
        <span class="s1">assert_almost_equal(r.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">fx.dot(fx))</span>
        <span class="s1">assert_(r.mask </span><span class="s4">is </span><span class="s1">nomask)</span>

        <span class="s1">fX = mX.filled(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">r = mX.dot(mX)</span>
        <span class="s1">assert_almost_equal(r.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">fX.dot(fX))</span>
        <span class="s1">assert_(r.mask[</span><span class="s5">1</span><span class="s4">,</span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">r1 = empty_like(r)</span>
        <span class="s1">mX.dot(mX</span><span class="s4">, </span><span class="s1">out=r1)</span>
        <span class="s1">assert_almost_equal(r</span><span class="s4">, </span><span class="s1">r1)</span>

        <span class="s1">mYY = mXX.swapaxes(-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">fXX</span><span class="s4">, </span><span class="s1">fYY = mXX.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mYY.filled(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">r = mXX.dot(mYY)</span>
        <span class="s1">assert_almost_equal(r.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">fXX.dot(fYY))</span>
        <span class="s1">r1 = empty_like(r)</span>
        <span class="s1">mXX.dot(mYY</span><span class="s4">, </span><span class="s1">out=r1)</span>
        <span class="s1">assert_almost_equal(r</span><span class="s4">, </span><span class="s1">r1)</span>

    <span class="s4">def </span><span class="s1">test_dot_shape_mismatch(self):</span>
        <span class="s0"># regression test</span>
        <span class="s1">x = masked_array([[</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s1">]</span><span class="s4">,</span><span class="s1">[</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span><span class="s1">[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">y = masked_array([[</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s1">]</span><span class="s4">,</span><span class="s1">[</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span><span class="s1">[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">z = masked_array([[</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span><span class="s1">[</span><span class="s5">3</span><span class="s4">,</span><span class="s5">3</span><span class="s1">]])</span>
        <span class="s1">x.dot(y</span><span class="s4">, </span><span class="s1">out=z)</span>
        <span class="s1">assert_almost_equal(z.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">15</span><span class="s4">, </span><span class="s5">16</span><span class="s1">]])</span>
        <span class="s1">assert_almost_equal(z.mask</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

    <span class="s4">def </span><span class="s1">test_varmean_nomask(self):</span>
        <span class="s0"># gh-5769</span>
        <span class="s1">foo = array([</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">)</span>
        <span class="s1">bar = array([</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">)</span>
        <span class="s1">assert_equal(type(foo.mean())</span><span class="s4">, </span><span class="s1">np.float64)</span>
        <span class="s1">assert_equal(type(foo.var())</span><span class="s4">, </span><span class="s1">np.float64)</span>
        <span class="s4">assert</span><span class="s1">((foo.mean() == bar.mean()) </span><span class="s4">is </span><span class="s1">np.bool_(</span><span class="s4">True</span><span class="s1">))</span>

        <span class="s0"># check array type is preserved and out works</span>
        <span class="s1">foo = array(np.arange(</span><span class="s5">16</span><span class="s1">).reshape((</span><span class="s5">4</span><span class="s4">,</span><span class="s5">4</span><span class="s1">))</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">)</span>
        <span class="s1">bar = empty(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'f4'</span><span class="s1">)</span>
        <span class="s1">assert_equal(type(foo.mean(axis=</span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">MaskedArray)</span>
        <span class="s1">assert_equal(type(foo.var(axis=</span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">MaskedArray)</span>
        <span class="s1">assert_(foo.mean(axis=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">out=bar) </span><span class="s4">is </span><span class="s1">bar)</span>
        <span class="s1">assert_(foo.var(axis=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">out=bar) </span><span class="s4">is </span><span class="s1">bar)</span>

    <span class="s4">def </span><span class="s1">test_varstd(self):</span>
        <span class="s0"># Tests var &amp; std on MaskedArrays.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX) = self.d</span>
        <span class="s1">assert_almost_equal(mX.var(axis=</span><span class="s4">None</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mX.compressed().var())</span>
        <span class="s1">assert_almost_equal(mX.std(axis=</span><span class="s4">None</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mX.compressed().std())</span>
        <span class="s1">assert_almost_equal(mX.std(axis=</span><span class="s4">None, </span><span class="s1">ddof=</span><span class="s5">1</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">mX.compressed().std(ddof=</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(mX.var(axis=</span><span class="s4">None, </span><span class="s1">ddof=</span><span class="s5">1</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">mX.compressed().var(ddof=</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_equal(mXX.var(axis=</span><span class="s5">3</span><span class="s1">).shape</span><span class="s4">, </span><span class="s1">XX.var(axis=</span><span class="s5">3</span><span class="s1">).shape)</span>
        <span class="s1">assert_equal(mX.var().shape</span><span class="s4">, </span><span class="s1">X.var().shape)</span>
        <span class="s1">(mXvar0</span><span class="s4">, </span><span class="s1">mXvar1) = (mX.var(axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mX.var(axis=</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(mX.var(axis=</span><span class="s4">None, </span><span class="s1">ddof=</span><span class="s5">2</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">mX.compressed().var(ddof=</span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(mX.std(axis=</span><span class="s4">None, </span><span class="s1">ddof=</span><span class="s5">2</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">mX.compressed().std(ddof=</span><span class="s5">2</span><span class="s1">))</span>
        <span class="s4">for </span><span class="s1">k </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">6</span><span class="s1">):</span>
            <span class="s1">assert_almost_equal(mXvar1[k]</span><span class="s4">, </span><span class="s1">mX[k].compressed().var())</span>
            <span class="s1">assert_almost_equal(mXvar0[k]</span><span class="s4">, </span><span class="s1">mX[:</span><span class="s4">, </span><span class="s1">k].compressed().var())</span>
            <span class="s1">assert_almost_equal(np.sqrt(mXvar0[k])</span><span class="s4">,</span>
                                <span class="s1">mX[:</span><span class="s4">, </span><span class="s1">k].compressed().std())</span>

    <span class="s1">@suppress_copy_mask_on_assignment</span>
    <span class="s4">def </span><span class="s1">test_varstd_specialcases(self):</span>
        <span class="s0"># Test a special case for var</span>
        <span class="s1">nout = np.array(-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">mout = array(-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype=float)</span>

        <span class="s1">x = array(arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s4">for </span><span class="s1">methodname </span><span class="s4">in </span><span class="s1">(</span><span class="s3">'var'</span><span class="s4">, </span><span class="s3">'std'</span><span class="s1">):</span>
            <span class="s1">method = getattr(x</span><span class="s4">, </span><span class="s1">methodname)</span>
            <span class="s1">assert_(method() </span><span class="s4">is </span><span class="s1">masked)</span>
            <span class="s1">assert_(method(</span><span class="s5">0</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
            <span class="s1">assert_(method(-</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
            <span class="s0"># Using a masked array as explicit output</span>
            <span class="s1">method(out=mout)</span>
            <span class="s1">assert_(mout </span><span class="s4">is not </span><span class="s1">masked)</span>
            <span class="s1">assert_equal(mout.mask</span><span class="s4">, True</span><span class="s1">)</span>
            <span class="s0"># Using a ndarray as explicit output</span>
            <span class="s1">method(out=nout)</span>
            <span class="s1">assert_(np.isnan(nout))</span>

        <span class="s1">x = array(arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">x[-</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">9</span>
        <span class="s4">for </span><span class="s1">methodname </span><span class="s4">in </span><span class="s1">(</span><span class="s3">'var'</span><span class="s4">, </span><span class="s3">'std'</span><span class="s1">):</span>
            <span class="s1">method = getattr(x</span><span class="s4">, </span><span class="s1">methodname)</span>
            <span class="s1">assert_(method(ddof=</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
            <span class="s1">assert_(method(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">ddof=</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
            <span class="s1">assert_(method(-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">ddof=</span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">masked)</span>
            <span class="s0"># Using a masked array as explicit output</span>
            <span class="s1">method(out=mout</span><span class="s4">, </span><span class="s1">ddof=</span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">assert_(mout </span><span class="s4">is not </span><span class="s1">masked)</span>
            <span class="s1">assert_equal(mout.mask</span><span class="s4">, True</span><span class="s1">)</span>
            <span class="s0"># Using a ndarray as explicit output</span>
            <span class="s1">method(out=nout</span><span class="s4">, </span><span class="s1">ddof=</span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">assert_(np.isnan(nout))</span>

    <span class="s4">def </span><span class="s1">test_varstd_ddof(self):</span>
        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]]</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">test = a.std(axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">ddof=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">test = a.std(axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">ddof=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">test = a.std(axis=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">ddof=</span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.filled(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_diag(self):</span>
        <span class="s0"># Test diag</span>
        <span class="s1">x = arange(</span><span class="s5">9</span><span class="s1">).reshape((</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">))</span>
        <span class="s1">x[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">out = np.diag(x)</span>
        <span class="s1">assert_equal(out</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">8</span><span class="s1">])</span>
        <span class="s1">out = diag(x)</span>
        <span class="s1">assert_equal(out</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">8</span><span class="s1">])</span>
        <span class="s1">assert_equal(out.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">out = diag(out)</span>
        <span class="s1">control = array([[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">8</span><span class="s1">]]</span><span class="s4">,</span>
                        <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">assert_equal(out</span><span class="s4">, </span><span class="s1">control)</span>

    <span class="s4">def </span><span class="s1">test_axis_methods_nomask(self):</span>
        <span class="s0"># Test the combination nomask &amp; methods w/ axis</span>
        <span class="s1">a = array([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]])</span>

        <span class="s1">assert_equal(a.sum(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">5</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">9</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.sum(-</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6</span><span class="s4">, </span><span class="s5">15</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.sum(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6</span><span class="s4">, </span><span class="s5">15</span><span class="s1">])</span>

        <span class="s1">assert_equal(a.prod(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">18</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.prod(-</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6</span><span class="s4">, </span><span class="s5">120</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.prod(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">6</span><span class="s4">, </span><span class="s5">120</span><span class="s1">])</span>

        <span class="s1">assert_equal(a.min(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.min(-</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.min(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>

        <span class="s1">assert_equal(a.max(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.max(-</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">6</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.max(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">6</span><span class="s1">])</span>


<span class="s4">class </span><span class="s1">TestMaskedArrayMathMethodsComplex:</span>
    <span class="s0"># Test class for miscellaneous MaskedArrays methods.</span>
    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s0"># Base data definition.</span>
        <span class="s1">x = np.array([</span><span class="s5">8.375j</span><span class="s4">, </span><span class="s5">7.545j</span><span class="s4">, </span><span class="s5">8.828j</span><span class="s4">, </span><span class="s5">8.5j</span><span class="s4">, </span><span class="s5">1.757j</span><span class="s4">, </span><span class="s5">5.928</span><span class="s4">,</span>
                      <span class="s5">8.43</span><span class="s4">, </span><span class="s5">7.78</span><span class="s4">, </span><span class="s5">9.865</span><span class="s4">, </span><span class="s5">5.878</span><span class="s4">, </span><span class="s5">8.979</span><span class="s4">, </span><span class="s5">4.732</span><span class="s4">,</span>
                      <span class="s5">3.012</span><span class="s4">, </span><span class="s5">6.022</span><span class="s4">, </span><span class="s5">5.095</span><span class="s4">, </span><span class="s5">3.116</span><span class="s4">, </span><span class="s5">5.238</span><span class="s4">, </span><span class="s5">3.957</span><span class="s4">,</span>
                      <span class="s5">6.04</span><span class="s4">, </span><span class="s5">9.63</span><span class="s4">, </span><span class="s5">7.712</span><span class="s4">, </span><span class="s5">3.382</span><span class="s4">, </span><span class="s5">4.489</span><span class="s4">, </span><span class="s5">6.479j</span><span class="s4">,</span>
                      <span class="s5">7.189j</span><span class="s4">, </span><span class="s5">9.645</span><span class="s4">, </span><span class="s5">5.395</span><span class="s4">, </span><span class="s5">4.961</span><span class="s4">, </span><span class="s5">9.894</span><span class="s4">, </span><span class="s5">2.893</span><span class="s4">,</span>
                      <span class="s5">7.357</span><span class="s4">, </span><span class="s5">9.828</span><span class="s4">, </span><span class="s5">6.272</span><span class="s4">, </span><span class="s5">3.758</span><span class="s4">, </span><span class="s5">6.693</span><span class="s4">, </span><span class="s5">0.993j</span><span class="s1">])</span>
        <span class="s1">X = x.reshape(</span><span class="s5">6</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)</span>
        <span class="s1">XX = x.reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>

        <span class="s1">m = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                     <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                     <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                     <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">mx = array(data=x</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s1">mX = array(data=X</span><span class="s4">, </span><span class="s1">mask=m.reshape(X.shape))</span>
        <span class="s1">mXX = array(data=XX</span><span class="s4">, </span><span class="s1">mask=m.reshape(XX.shape))</span>

        <span class="s1">m2 = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">,</span>
                      <span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span>
                      <span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">m2x = array(data=x</span><span class="s4">, </span><span class="s1">mask=m2)</span>
        <span class="s1">m2X = array(data=X</span><span class="s4">, </span><span class="s1">mask=m2.reshape(X.shape))</span>
        <span class="s1">m2XX = array(data=XX</span><span class="s4">, </span><span class="s1">mask=m2.reshape(XX.shape))</span>
        <span class="s1">self.d = (x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX)</span>

    <span class="s4">def </span><span class="s1">test_varstd(self):</span>
        <span class="s0"># Tests var &amp; std on MaskedArrays.</span>
        <span class="s1">(x</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">XX</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mX</span><span class="s4">, </span><span class="s1">mXX</span><span class="s4">, </span><span class="s1">m2x</span><span class="s4">, </span><span class="s1">m2X</span><span class="s4">, </span><span class="s1">m2XX) = self.d</span>
        <span class="s1">assert_almost_equal(mX.var(axis=</span><span class="s4">None</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mX.compressed().var())</span>
        <span class="s1">assert_almost_equal(mX.std(axis=</span><span class="s4">None</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mX.compressed().std())</span>
        <span class="s1">assert_equal(mXX.var(axis=</span><span class="s5">3</span><span class="s1">).shape</span><span class="s4">, </span><span class="s1">XX.var(axis=</span><span class="s5">3</span><span class="s1">).shape)</span>
        <span class="s1">assert_equal(mX.var().shape</span><span class="s4">, </span><span class="s1">X.var().shape)</span>
        <span class="s1">(mXvar0</span><span class="s4">, </span><span class="s1">mXvar1) = (mX.var(axis=</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">mX.var(axis=</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(mX.var(axis=</span><span class="s4">None, </span><span class="s1">ddof=</span><span class="s5">2</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">mX.compressed().var(ddof=</span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(mX.std(axis=</span><span class="s4">None, </span><span class="s1">ddof=</span><span class="s5">2</span><span class="s1">)</span><span class="s4">,</span>
                            <span class="s1">mX.compressed().std(ddof=</span><span class="s5">2</span><span class="s1">))</span>
        <span class="s4">for </span><span class="s1">k </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">6</span><span class="s1">):</span>
            <span class="s1">assert_almost_equal(mXvar1[k]</span><span class="s4">, </span><span class="s1">mX[k].compressed().var())</span>
            <span class="s1">assert_almost_equal(mXvar0[k]</span><span class="s4">, </span><span class="s1">mX[:</span><span class="s4">, </span><span class="s1">k].compressed().var())</span>
            <span class="s1">assert_almost_equal(np.sqrt(mXvar0[k])</span><span class="s4">,</span>
                                <span class="s1">mX[:</span><span class="s4">, </span><span class="s1">k].compressed().std())</span>


<span class="s4">class </span><span class="s1">TestMaskedArrayFunctions:</span>
    <span class="s0"># Test class for miscellaneous functions.</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s1">x = np.array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2.</span><span class="s4">, </span><span class="s1">pi/</span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s5">5.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">m1 = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">m2 = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">xm = masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1)</span>
        <span class="s1">ym = masked_array(y</span><span class="s4">, </span><span class="s1">mask=m2)</span>
        <span class="s1">xm.set_fill_value(</span><span class="s5">1e+20</span><span class="s1">)</span>
        <span class="s1">self.info = (xm</span><span class="s4">, </span><span class="s1">ym)</span>

    <span class="s4">def </span><span class="s1">test_masked_where_bool(self):</span>
        <span class="s1">x = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span>
        <span class="s1">y = masked_where(</span><span class="s4">False, </span><span class="s1">x)</span>
        <span class="s1">assert_equal(y</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(y[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_masked_equal_wlist(self):</span>
        <span class="s1">x = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span>
        <span class="s1">mx = masked_equal(x</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(mx</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">assert_equal(mx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">mx = masked_not_equal(x</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(mx</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">assert_equal(mx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_masked_equal_fill_value(self):</span>
        <span class="s1">x = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span>
        <span class="s1">mx = masked_equal(x</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(mx._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(mx.fill_value</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_masked_where_condition(self):</span>
        <span class="s0"># Tests masking functions.</span>
        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">])</span>
        <span class="s1">x[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">assert_equal(masked_where(greater(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">x)</span><span class="s4">, </span><span class="s1">masked_greater(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(masked_where(greater_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">x)</span><span class="s4">,</span>
                     <span class="s1">masked_greater_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(masked_where(less(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">x)</span><span class="s4">, </span><span class="s1">masked_less(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(masked_where(less_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">x)</span><span class="s4">,</span>
                     <span class="s1">masked_less_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(masked_where(not_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">x)</span><span class="s4">, </span><span class="s1">masked_not_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(masked_where(equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">x)</span><span class="s4">, </span><span class="s1">masked_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(masked_where(not_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">x)</span><span class="s4">, </span><span class="s1">masked_not_equal(x</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(masked_where([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">99</span><span class="s4">, </span><span class="s5">99</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_masked_where_oddities(self):</span>
        <span class="s0"># Tests some generic features.</span>
        <span class="s1">atest = ones((</span><span class="s5">10</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">btest = zeros(atest.shape</span><span class="s4">, </span><span class="s1">MaskType)</span>
        <span class="s1">ctest = masked_where(btest</span><span class="s4">, </span><span class="s1">atest)</span>
        <span class="s1">assert_equal(atest</span><span class="s4">, </span><span class="s1">ctest)</span>

    <span class="s4">def </span><span class="s1">test_masked_where_shape_constraint(self):</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s4">with </span><span class="s1">assert_raises(IndexError):</span>
            <span class="s1">masked_equal(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">test = masked_equal(a</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_masked_where_structured(self):</span>
        <span class="s0"># test that masked_where on a structured array sets a structured</span>
        <span class="s0"># mask (see issue #2972)</span>
        <span class="s1">a = np.zeros(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">&quot;A&quot;</span><span class="s4">, </span><span class="s3">&quot;&lt;f2&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s4">, </span><span class="s3">&quot;&lt;f4&quot;</span><span class="s1">)])</span>
        <span class="s1">am = np.ma.masked_where(a[</span><span class="s3">&quot;A&quot;</span><span class="s1">] &lt; </span><span class="s5">5</span><span class="s4">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(am.mask.dtype.names</span><span class="s4">, </span><span class="s1">am.dtype.names)</span>
        <span class="s1">assert_equal(am[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s4">,</span>
                    <span class="s1">np.ma.masked_array(np.zeros(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">np.ones(</span><span class="s5">10</span><span class="s1">)))</span>

    <span class="s4">def </span><span class="s1">test_masked_where_mismatch(self):</span>
        <span class="s0"># gh-4520</span>
        <span class="s1">x = np.arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">y = np.arange(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">assert_raises(IndexError</span><span class="s4">, </span><span class="s1">np.ma.masked_where</span><span class="s4">, </span><span class="s1">y &gt; </span><span class="s5">6</span><span class="s4">, </span><span class="s1">x)</span>

    <span class="s4">def </span><span class="s1">test_masked_otherfunctions(self):</span>
        <span class="s1">assert_equal(masked_inside(list(range(</span><span class="s5">5</span><span class="s1">))</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">199</span><span class="s4">, </span><span class="s5">199</span><span class="s4">, </span><span class="s5">199</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">assert_equal(masked_outside(list(range(</span><span class="s5">5</span><span class="s1">))</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">199</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">199</span><span class="s1">])</span>
        <span class="s1">assert_equal(masked_inside(array(list(range(</span><span class="s5">5</span><span class="s1">))</span><span class="s4">,</span>
                                         <span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">).mask</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(masked_outside(array(list(range(</span><span class="s5">5</span><span class="s1">))</span><span class="s4">,</span>
                                          <span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s1">).mask</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(masked_equal(array(list(range(</span><span class="s5">5</span><span class="s1">))</span><span class="s4">,</span>
                                        <span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).mask</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(masked_not_equal(array([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                                            <span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).mask</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_round(self):</span>
        <span class="s1">a = array([</span><span class="s5">1.23456</span><span class="s4">, </span><span class="s5">2.34567</span><span class="s4">, </span><span class="s5">3.45678</span><span class="s4">, </span><span class="s5">4.56789</span><span class="s4">, </span><span class="s5">5.67890</span><span class="s1">]</span><span class="s4">,</span>
                  <span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.round()</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s5">6.</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.round(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.2</span><span class="s4">, </span><span class="s5">2.3</span><span class="s4">, </span><span class="s5">3.5</span><span class="s4">, </span><span class="s5">4.6</span><span class="s4">, </span><span class="s5">5.7</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.round(</span><span class="s5">3</span><span class="s1">)</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.235</span><span class="s4">, </span><span class="s5">2.346</span><span class="s4">, </span><span class="s5">3.457</span><span class="s4">, </span><span class="s5">4.568</span><span class="s4">, </span><span class="s5">5.679</span><span class="s1">])</span>
        <span class="s1">b = empty_like(a)</span>
        <span class="s1">a.round(out=b)</span>
        <span class="s1">assert_equal(b</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s5">6.</span><span class="s1">])</span>

        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">])</span>
        <span class="s1">c = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">x[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">-x)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">c[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">-x)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_(z[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_round_with_output(self):</span>
        <span class="s0"># Testing round with an explicit output</span>

        <span class="s1">xm = array(np.random.uniform(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">12</span><span class="s1">)).reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">xm[:</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] = xm[</span><span class="s5">0</span><span class="s1">] = xm[-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = masked</span>

        <span class="s0"># A ndarray as explicit input</span>
        <span class="s1">output = np.empty((</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">output.fill(-</span><span class="s5">9999</span><span class="s1">)</span>
        <span class="s1">result = np.round(xm</span><span class="s4">, </span><span class="s1">decimals=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">out=output)</span>
        <span class="s0"># ... the result should be the given output</span>
        <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">output)</span>
        <span class="s1">assert_equal(result</span><span class="s4">, </span><span class="s1">xm.round(decimals=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">out=output))</span>

        <span class="s1">output = empty((</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">result = xm.round(decimals=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">out=output)</span>
        <span class="s1">assert_(result </span><span class="s4">is </span><span class="s1">output)</span>

    <span class="s4">def </span><span class="s1">test_round_with_scalar(self):</span>
        <span class="s0"># Testing round with scalar/zero dimension input</span>
        <span class="s0"># GH issue 2244</span>
        <span class="s1">a = array(</span><span class="s5">1.1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.round()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s1">a = array(</span><span class="s5">1.1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">True</span><span class="s1">])</span>
        <span class="s1">assert_(a.round() </span><span class="s4">is </span><span class="s1">masked)</span>

        <span class="s1">a = array(</span><span class="s5">1.1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False</span><span class="s1">])</span>
        <span class="s1">output = np.empty(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype=float)</span>
        <span class="s1">output.fill(-</span><span class="s5">9999</span><span class="s1">)</span>
        <span class="s1">a.round(out=output)</span>
        <span class="s1">assert_equal(output</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s1">a = array(</span><span class="s5">1.1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False</span><span class="s1">])</span>
        <span class="s1">output = array(-</span><span class="s5">9999.</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">True</span><span class="s1">])</span>
        <span class="s1">a.round(out=output)</span>
        <span class="s1">assert_equal(output[()]</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s1">a = array(</span><span class="s5">1.1</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">True</span><span class="s1">])</span>
        <span class="s1">output = array(-</span><span class="s5">9999.</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s4">False</span><span class="s1">])</span>
        <span class="s1">a.round(out=output)</span>
        <span class="s1">assert_(output[()] </span><span class="s4">is </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_identity(self):</span>
        <span class="s1">a = identity(</span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">assert_(isinstance(a</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(a</span><span class="s4">, </span><span class="s1">np.identity(</span><span class="s5">5</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_power(self):</span>
        <span class="s1">x = -</span><span class="s5">1.1</span>
        <span class="s1">assert_almost_equal(power(x</span><span class="s4">, </span><span class="s5">2.</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1.21</span><span class="s1">)</span>
        <span class="s1">assert_(power(x</span><span class="s4">, </span><span class="s1">masked) </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">x = array([-</span><span class="s5">1.1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">0.</span><span class="s1">])</span>
        <span class="s1">b = array([</span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">y = power(x</span><span class="s4">, </span><span class="s1">b)</span>
        <span class="s1">assert_almost_equal(y</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1.21</span><span class="s4">, </span><span class="s5">1.04880884817</span><span class="s4">, </span><span class="s5">1.21</span><span class="s4">, </span><span class="s5">0.</span><span class="s1">])</span>
        <span class="s1">assert_equal(y._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">b.mask = nomask</span>
        <span class="s1">y = power(x</span><span class="s4">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(y._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">z = x ** b</span>
        <span class="s1">assert_equal(z._mask</span><span class="s4">, </span><span class="s1">y._mask)</span>
        <span class="s1">assert_almost_equal(z</span><span class="s4">, </span><span class="s1">y)</span>
        <span class="s1">assert_almost_equal(z._data</span><span class="s4">, </span><span class="s1">y._data)</span>
        <span class="s1">x **= b</span>
        <span class="s1">assert_equal(x._mask</span><span class="s4">, </span><span class="s1">y._mask)</span>
        <span class="s1">assert_almost_equal(x</span><span class="s4">, </span><span class="s1">y)</span>
        <span class="s1">assert_almost_equal(x._data</span><span class="s4">, </span><span class="s1">y._data)</span>

    <span class="s4">def </span><span class="s1">test_power_with_broadcasting(self):</span>
        <span class="s0"># Test power w/ broadcasting</span>
        <span class="s1">a2 = np.array([[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s5">6.</span><span class="s1">]])</span>
        <span class="s1">a2m = array(a2</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s1">b1 = np.array([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">b2 = np.array([b1</span><span class="s4">, </span><span class="s1">b1])</span>
        <span class="s1">b2m = array(b2</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>

        <span class="s1">ctrl = array([[</span><span class="s5">1 </span><span class="s1">** </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2 </span><span class="s1">** </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3 </span><span class="s1">** </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">4 </span><span class="s1">** </span><span class="s5">2</span><span class="s4">, </span><span class="s5">5 </span><span class="s1">** </span><span class="s5">4</span><span class="s4">, </span><span class="s5">6 </span><span class="s1">** </span><span class="s5">3</span><span class="s1">]]</span><span class="s4">,</span>
                     <span class="s1">mask=[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]])</span>
        <span class="s0"># No broadcasting, base &amp; exp w/ mask</span>
        <span class="s1">test = a2m ** b2m</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">ctrl.mask)</span>
        <span class="s0"># No broadcasting, base w/ mask, exp w/o mask</span>
        <span class="s1">test = a2m ** b2</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">a2m.mask)</span>
        <span class="s0"># No broadcasting, base w/o mask, exp w/ mask</span>
        <span class="s1">test = a2 ** b2m</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">b2m.mask)</span>

        <span class="s1">ctrl = array([[</span><span class="s5">2 </span><span class="s1">** </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4 </span><span class="s1">** </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3 </span><span class="s1">** </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">2 </span><span class="s1">** </span><span class="s5">2</span><span class="s4">, </span><span class="s5">4 </span><span class="s1">** </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3 </span><span class="s1">** </span><span class="s5">3</span><span class="s1">]]</span><span class="s4">,</span>
                     <span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">test = b1 ** b2m</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">ctrl.mask)</span>
        <span class="s1">test = b2m ** b1</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">ctrl)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">ctrl.mask)</span>

    <span class="s4">def </span><span class="s1">test_where(self):</span>
        <span class="s0"># Test the where function</span>
        <span class="s1">x = np.array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">2.</span><span class="s4">, </span><span class="s1">pi/</span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s5">5.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">m1 = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">m2 = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">xm = masked_array(x</span><span class="s4">, </span><span class="s1">mask=m1)</span>
        <span class="s1">ym = masked_array(y</span><span class="s4">, </span><span class="s1">mask=m2)</span>
        <span class="s1">xm.set_fill_value(</span><span class="s5">1e+20</span><span class="s1">)</span>

        <span class="s1">d = where(xm &gt; </span><span class="s5">2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s1">)</span>
        <span class="s1">assert_equal(d</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">,</span>
                         <span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">assert_equal(d._mask</span><span class="s4">, </span><span class="s1">xm._mask)</span>
        <span class="s1">d = where(xm &gt; </span><span class="s5">2</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s1">ym)</span>
        <span class="s1">assert_equal(d</span><span class="s4">, </span><span class="s1">[</span><span class="s5">5.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">,</span>
                         <span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">10.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s1">])</span>
        <span class="s1">assert_equal(d._mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">d = where(xm &gt; </span><span class="s5">2</span><span class="s4">, </span><span class="s1">xm</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(d</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">,</span>
                         <span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s5">10.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">])</span>
        <span class="s1">tmp = xm._mask.copy()</span>
        <span class="s1">tmp[(xm &lt;= </span><span class="s5">2</span><span class="s1">).filled(</span><span class="s4">True</span><span class="s1">)] = </span><span class="s4">True</span>
        <span class="s1">assert_equal(d._mask</span><span class="s4">, </span><span class="s1">tmp)</span>

        <span class="s1">ixm = xm.astype(int)</span>
        <span class="s1">d = where(ixm &gt; </span><span class="s5">2</span><span class="s4">, </span><span class="s1">ixm</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(d</span><span class="s4">, </span><span class="s1">[-</span><span class="s5">9</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s1">-</span><span class="s5">9</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(d.dtype</span><span class="s4">, </span><span class="s1">ixm.dtype)</span>

    <span class="s4">def </span><span class="s1">test_where_object(self):</span>
        <span class="s1">a = np.array(</span><span class="s4">None</span><span class="s1">)</span>
        <span class="s1">b = masked_array(</span><span class="s4">None</span><span class="s1">)</span>
        <span class="s1">r = b.copy()</span>
        <span class="s1">assert_equal(np.ma.where(</span><span class="s4">True, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">a)</span><span class="s4">, </span><span class="s1">r)</span>
        <span class="s1">assert_equal(np.ma.where(</span><span class="s4">True, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">b)</span><span class="s4">, </span><span class="s1">r)</span>

    <span class="s4">def </span><span class="s1">test_where_with_masked_choice(self):</span>
        <span class="s1">x = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">x[</span><span class="s5">3</span><span class="s1">] = masked</span>
        <span class="s1">c = x &gt;= </span><span class="s5">8</span>
        <span class="s0"># Set False to masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">assert_(z.dtype </span><span class="s4">is </span><span class="s1">x.dtype)</span>
        <span class="s1">assert_(z[</span><span class="s5">3</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">4</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">7</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">8</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">9</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">z)</span>
        <span class="s0"># Set True to masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">masked</span><span class="s4">, </span><span class="s1">x)</span>
        <span class="s1">assert_(z.dtype </span><span class="s4">is </span><span class="s1">x.dtype)</span>
        <span class="s1">assert_(z[</span><span class="s5">3</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">4</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">7</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">8</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">9</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>

    <span class="s4">def </span><span class="s1">test_where_with_masked_condition(self):</span>
        <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s4">, </span><span class="s5">4.</span><span class="s4">, </span><span class="s5">5.</span><span class="s1">])</span>
        <span class="s1">c = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">x[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">-x)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">c[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">-x)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">0.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">4.</span><span class="s4">, </span><span class="s1">-</span><span class="s5">5</span><span class="s1">])</span>
        <span class="s1">assert_(z[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is not </span><span class="s1">masked)</span>
        <span class="s1">assert_(z[</span><span class="s5">2</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>

        <span class="s1">x = arange(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)</span>
        <span class="s1">x[-</span><span class="s5">1</span><span class="s1">] = masked</span>
        <span class="s1">y = arange(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">6</span><span class="s1">) * </span><span class="s5">10</span>
        <span class="s1">y[</span><span class="s5">2</span><span class="s1">] = masked</span>
        <span class="s1">c = array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">cm = c.filled(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y)</span>
        <span class="s1">zm = where(cm</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">zm)</span>
        <span class="s1">assert_(getmask(zm) </span><span class="s4">is </span><span class="s1">nomask)</span>
        <span class="s1">assert_equal(zm</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">40</span><span class="s4">, </span><span class="s5">50</span><span class="s1">])</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s1">masked</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">99</span><span class="s4">, </span><span class="s5">99</span><span class="s4">, </span><span class="s5">99</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">z = where(c</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">assert_equal(z</span><span class="s4">, </span><span class="s1">[</span><span class="s5">99</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">99</span><span class="s4">, </span><span class="s5">99</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_where_type(self):</span>
        <span class="s0"># Test the type conservation with where</span>
        <span class="s1">x = np.arange(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">y = np.arange(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=np.float32) * </span><span class="s5">2.2</span>
        <span class="s1">test = where(x &gt; </span><span class="s5">1.5</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">x).dtype</span>
        <span class="s1">control = np.find_common_type([np.int32</span><span class="s4">, </span><span class="s1">np.float32]</span><span class="s4">, </span><span class="s1">[])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

    <span class="s4">def </span><span class="s1">test_where_broadcast(self):</span>
        <span class="s0"># Issue 8599</span>
        <span class="s1">x = np.arange(</span><span class="s5">9</span><span class="s1">).reshape(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">y = np.zeros(</span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">core = np.where([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y)</span>
        <span class="s1">ma = where([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y)</span>

        <span class="s1">assert_equal(core</span><span class="s4">, </span><span class="s1">ma)</span>
        <span class="s1">assert_equal(core.dtype</span><span class="s4">, </span><span class="s1">ma.dtype)</span>

    <span class="s4">def </span><span class="s1">test_where_structured(self):</span>
        <span class="s0"># Issue 8600</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s1">x = np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">y = np.array((</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">core = np.where([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y)</span>
        <span class="s1">ma = np.where([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y)</span>

        <span class="s1">assert_equal(core</span><span class="s4">, </span><span class="s1">ma)</span>
        <span class="s1">assert_equal(core.dtype</span><span class="s4">, </span><span class="s1">ma.dtype)</span>

    <span class="s4">def </span><span class="s1">test_where_structured_masked(self):</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s1">x = np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=dt)</span>

        <span class="s1">ma = where([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">masked)</span>
        <span class="s1">expected = masked_where([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">x)</span>

        <span class="s1">assert_equal(ma.dtype</span><span class="s4">, </span><span class="s1">expected.dtype)</span>
        <span class="s1">assert_equal(ma</span><span class="s4">, </span><span class="s1">expected)</span>
        <span class="s1">assert_equal(ma.mask</span><span class="s4">, </span><span class="s1">expected.mask)</span>

    <span class="s4">def </span><span class="s1">test_choose(self):</span>
        <span class="s0"># Test choose</span>
        <span class="s1">choices = [[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">11</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">13</span><span class="s1">]</span><span class="s4">,</span>
                   <span class="s1">[</span><span class="s5">20</span><span class="s4">, </span><span class="s5">21</span><span class="s4">, </span><span class="s5">22</span><span class="s4">, </span><span class="s5">23</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">30</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">32</span><span class="s4">, </span><span class="s5">33</span><span class="s1">]]</span>
        <span class="s1">chosen = choose([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">choices)</span>
        <span class="s1">assert_equal(chosen</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">20</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]))</span>
        <span class="s1">chosen = choose([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">, </span><span class="s1">mode=</span><span class="s3">'clip'</span><span class="s1">)</span>
        <span class="s1">assert_equal(chosen</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">20</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]))</span>
        <span class="s1">chosen = choose([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">, </span><span class="s1">mode=</span><span class="s3">'wrap'</span><span class="s1">)</span>
        <span class="s1">assert_equal(chosen</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">20</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]))</span>
        <span class="s0"># Check with some masked indices</span>
        <span class="s1">indices_ = array([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">chosen = choose(indices_</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">, </span><span class="s1">mode=</span><span class="s3">'wrap'</span><span class="s1">)</span>
        <span class="s1">assert_equal(chosen</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">99</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">99</span><span class="s1">]))</span>
        <span class="s1">assert_equal(chosen.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Check with some masked choices</span>
        <span class="s1">choices = array(choices</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                                       <span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">indices_ = [</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">chosen = choose(indices_</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">, </span><span class="s1">mode=</span><span class="s3">'wrap'</span><span class="s1">)</span>
        <span class="s1">assert_equal(chosen</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">20</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]))</span>
        <span class="s1">assert_equal(chosen.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_choose_with_out(self):</span>
        <span class="s0"># Test choose with an explicit out keyword</span>
        <span class="s1">choices = [[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">10</span><span class="s4">, </span><span class="s5">11</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">13</span><span class="s1">]</span><span class="s4">,</span>
                   <span class="s1">[</span><span class="s5">20</span><span class="s4">, </span><span class="s5">21</span><span class="s4">, </span><span class="s5">22</span><span class="s4">, </span><span class="s5">23</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">30</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">32</span><span class="s4">, </span><span class="s5">33</span><span class="s1">]]</span>
        <span class="s1">store = empty(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=int)</span>
        <span class="s1">chosen = choose([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">, </span><span class="s1">out=store)</span>
        <span class="s1">assert_equal(store</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">20</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]))</span>
        <span class="s1">assert_(store </span><span class="s4">is </span><span class="s1">chosen)</span>
        <span class="s0"># Check with some masked indices + out</span>
        <span class="s1">store = empty(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=int)</span>
        <span class="s1">indices_ = array([</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">chosen = choose(indices_</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">, </span><span class="s1">mode=</span><span class="s3">'wrap'</span><span class="s4">, </span><span class="s1">out=store)</span>
        <span class="s1">assert_equal(store</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">99</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">99</span><span class="s1">]))</span>
        <span class="s1">assert_equal(store.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># Check with some masked choices + out ina ndarray !</span>
        <span class="s1">choices = array(choices</span><span class="s4">, </span><span class="s1">mask=[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                                       <span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]])</span>
        <span class="s1">indices_ = [</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">store = empty(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dtype=int).view(ndarray)</span>
        <span class="s1">chosen = choose(indices_</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">, </span><span class="s1">mode=</span><span class="s3">'wrap'</span><span class="s4">, </span><span class="s1">out=store)</span>
        <span class="s1">assert_equal(store</span><span class="s4">, </span><span class="s1">array([</span><span class="s5">999999</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">999999</span><span class="s1">]))</span>

    <span class="s4">def </span><span class="s1">test_reshape(self):</span>
        <span class="s1">a = arange(</span><span class="s5">10</span><span class="s1">)</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">] = masked</span>
        <span class="s0"># Try the default</span>
        <span class="s1">b = a.reshape((</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(b.flags[</span><span class="s3">'C'</span><span class="s1">])</span>
        <span class="s0"># Try w/ arguments as list instead of tuple</span>
        <span class="s1">b = a.reshape(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(b.flags[</span><span class="s3">'C'</span><span class="s1">])</span>
        <span class="s0"># Try w/ order</span>
        <span class="s1">b = a.reshape((</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(b.flags[</span><span class="s3">'F'</span><span class="s1">])</span>
        <span class="s0"># Try w/ order</span>
        <span class="s1">b = a.reshape(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">assert_equal(b.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">5</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(b.flags[</span><span class="s3">'F'</span><span class="s1">])</span>

        <span class="s1">c = np.reshape(a</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_(isinstance(c</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(c.shape</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_(c[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">masked)</span>
        <span class="s1">assert_(c.flags[</span><span class="s3">'C'</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_make_mask_descr(self):</span>
        <span class="s0"># Flexible</span>
        <span class="s1">ntype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">test = make_mask_descr(ntype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)])</span>
        <span class="s1">assert_(test </span><span class="s4">is </span><span class="s1">make_mask_descr(test))</span>

        <span class="s0"># Standard w/ shape</span>
        <span class="s1">ntype = (float</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">test = make_mask_descr(ntype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">(bool</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(test </span><span class="s4">is </span><span class="s1">make_mask_descr(test))</span>

        <span class="s0"># Standard standard</span>
        <span class="s1">ntype = float</span>
        <span class="s1">test = make_mask_descr(ntype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">np.dtype(bool))</span>
        <span class="s1">assert_(test </span><span class="s4">is </span><span class="s1">make_mask_descr(test))</span>

        <span class="s0"># Nested</span>
        <span class="s1">ntype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'ba'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'bb'</span><span class="s4">, </span><span class="s1">float)])]</span>
        <span class="s1">test = make_mask_descr(ntype)</span>
        <span class="s1">control = np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b1'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'ba'</span><span class="s4">, </span><span class="s3">'b1'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'bb'</span><span class="s4">, </span><span class="s3">'b1'</span><span class="s1">)])])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">assert_(test </span><span class="s4">is </span><span class="s1">make_mask_descr(test))</span>

        <span class="s0"># Named+ shape</span>
        <span class="s1">ntype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">(float</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]</span>
        <span class="s1">test = make_mask_descr(ntype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">(bool</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))]))</span>
        <span class="s1">assert_(test </span><span class="s4">is </span><span class="s1">make_mask_descr(test))</span>

        <span class="s0"># 2 names</span>
        <span class="s1">ntype = [((</span><span class="s3">'A'</span><span class="s4">, </span><span class="s3">'a'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">test = make_mask_descr(ntype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">np.dtype([((</span><span class="s3">'A'</span><span class="s4">, </span><span class="s3">'a'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">bool)]))</span>
        <span class="s1">assert_(test </span><span class="s4">is </span><span class="s1">make_mask_descr(test))</span>

        <span class="s0"># nested boolean types should preserve identity</span>
        <span class="s1">base_type = np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)])</span>
        <span class="s1">base_mtype = make_mask_descr(base_type)</span>
        <span class="s1">sub_type = np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">base_mtype)])</span>
        <span class="s1">test = make_mask_descr(sub_type)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)])]))</span>
        <span class="s1">assert_(test.fields[</span><span class="s3">'b'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">base_mtype)</span>

    <span class="s4">def </span><span class="s1">test_make_mask(self):</span>
        <span class="s0"># Test make_mask</span>
        <span class="s0"># w/ a list as an input</span>
        <span class="s1">mask = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">test = make_mask(mask)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">MaskType)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># w/ a ndarray as an input</span>
        <span class="s1">mask = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">test = make_mask(mask)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">MaskType)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># w/ a flexible-type ndarray as an input - use default</span>
        <span class="s1">mdtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)]</span>
        <span class="s1">mask = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mdtype)</span>
        <span class="s1">test = make_mask(mask)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">MaskType)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s0"># w/ a flexible-type ndarray as an input - use input dtype</span>
        <span class="s1">mdtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)]</span>
        <span class="s1">mask = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mdtype)</span>
        <span class="s1">test = make_mask(mask</span><span class="s4">, </span><span class="s1">dtype=mask.dtype)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">mdtype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">mask)</span>
        <span class="s0"># w/ a flexible-type ndarray as an input - use input dtype</span>
        <span class="s1">mdtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">bdtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)]</span>
        <span class="s1">mask = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mdtype)</span>
        <span class="s1">test = make_mask(mask</span><span class="s4">, </span><span class="s1">dtype=mask.dtype)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s4">, </span><span class="s1">bdtype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=bdtype))</span>
        <span class="s0"># Ensure this also works for void</span>
        <span class="s1">mask = np.array((</span><span class="s4">False, True</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'?,?'</span><span class="s1">)[()]</span>
        <span class="s1">assert_(isinstance(mask</span><span class="s4">, </span><span class="s1">np.void))</span>
        <span class="s1">test = make_mask(mask</span><span class="s4">, </span><span class="s1">dtype=mask.dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">mask)</span>
        <span class="s1">assert_(test </span><span class="s4">is not </span><span class="s1">mask)</span>
        <span class="s1">mask = np.array((</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=</span><span class="s3">'i4,i4'</span><span class="s1">)[()]</span>
        <span class="s1">test2 = make_mask(mask</span><span class="s4">, </span><span class="s1">dtype=mask.dtype)</span>
        <span class="s1">assert_equal(test2</span><span class="s4">, </span><span class="s1">test)</span>
        <span class="s0"># test that nomask is returned when m is nomask.</span>
        <span class="s1">bools = [</span><span class="s4">True, False</span><span class="s1">]</span>
        <span class="s1">dtypes = [MaskType</span><span class="s4">, </span><span class="s1">float]</span>
        <span class="s1">msgformat = </span><span class="s3">'copy=%s, shrink=%s, dtype=%s'</span>
        <span class="s4">for </span><span class="s1">cpy</span><span class="s4">, </span><span class="s1">shr</span><span class="s4">, </span><span class="s1">dt </span><span class="s4">in </span><span class="s1">itertools.product(bools</span><span class="s4">, </span><span class="s1">bools</span><span class="s4">, </span><span class="s1">dtypes):</span>
            <span class="s1">res = make_mask(nomask</span><span class="s4">, </span><span class="s1">copy=cpy</span><span class="s4">, </span><span class="s1">shrink=shr</span><span class="s4">, </span><span class="s1">dtype=dt)</span>
            <span class="s1">assert_(res </span><span class="s4">is </span><span class="s1">nomask</span><span class="s4">, </span><span class="s1">msgformat % (cpy</span><span class="s4">, </span><span class="s1">shr</span><span class="s4">, </span><span class="s1">dt))</span>

    <span class="s4">def </span><span class="s1">test_mask_or(self):</span>
        <span class="s0"># Initialize</span>
        <span class="s1">mtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)]</span>
        <span class="s1">mask = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mtype)</span>
        <span class="s0"># Test using nomask as input</span>
        <span class="s1">test = mask_or(mask</span><span class="s4">, </span><span class="s1">nomask)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">mask)</span>
        <span class="s1">test = mask_or(nomask</span><span class="s4">, </span><span class="s1">mask)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">mask)</span>
        <span class="s0"># Using False as input</span>
        <span class="s1">test = mask_or(mask</span><span class="s4">, False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">mask)</span>
        <span class="s0"># Using another array w / the same dtype</span>
        <span class="s1">other = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mtype)</span>
        <span class="s1">test = mask_or(mask</span><span class="s4">, </span><span class="s1">other)</span>
        <span class="s1">control = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mtype)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s0"># Using another array w / a different dtype</span>
        <span class="s1">othertype = [(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">bool)]</span>
        <span class="s1">other = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=othertype)</span>
        <span class="s4">try</span><span class="s1">:</span>
            <span class="s1">test = mask_or(mask</span><span class="s4">, </span><span class="s1">other)</span>
        <span class="s4">except </span><span class="s1">ValueError:</span>
            <span class="s4">pass</span>
        <span class="s0"># Using nested arrays</span>
        <span class="s1">dtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'ba'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'bb'</span><span class="s4">, </span><span class="s1">bool)])]</span>
        <span class="s1">amask = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">bmask = np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">cntrl = np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))]</span><span class="s4">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">assert_equal(mask_or(amask</span><span class="s4">, </span><span class="s1">bmask)</span><span class="s4">, </span><span class="s1">cntrl)</span>

    <span class="s4">def </span><span class="s1">test_flatten_mask(self):</span>
        <span class="s0"># Tests flatten mask</span>
        <span class="s0"># Standard dtype</span>
        <span class="s1">mask = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">assert_equal(flatten_mask(mask)</span><span class="s4">, </span><span class="s1">mask)</span>
        <span class="s0"># Flexible dtype</span>
        <span class="s1">mask = np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)])</span>
        <span class="s1">test = flatten_mask(mask)</span>
        <span class="s1">control = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

        <span class="s1">mdtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'ba'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'bb'</span><span class="s4">, </span><span class="s1">bool)])]</span>
        <span class="s1">data = [(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))]</span>
        <span class="s1">mask = np.array(data</span><span class="s4">, </span><span class="s1">dtype=mdtype)</span>
        <span class="s1">test = flatten_mask(mask)</span>
        <span class="s1">control = np.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

    <span class="s4">def </span><span class="s1">test_on_ndarray(self):</span>
        <span class="s0"># Test functions on ndarrays</span>
        <span class="s1">a = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
        <span class="s1">m = array(a</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">test = anom(a)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">m.anom())</span>
        <span class="s1">test = reshape(a</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">m.reshape(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_compress(self):</span>
        <span class="s0"># Test compress function on ndarray and masked array</span>
        <span class="s0"># Address Github #2495.</span>
        <span class="s1">arr = np.arange(</span><span class="s5">8</span><span class="s1">)</span>
        <span class="s1">arr.shape = </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span>
        <span class="s1">cond = np.array([</span><span class="s4">True, False, True, True</span><span class="s1">])</span>
        <span class="s1">control = arr[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]]</span>
        <span class="s1">test = np.ma.compress(cond</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">marr = np.ma.array(arr)</span>
        <span class="s1">test = np.ma.compress(cond</span><span class="s4">, </span><span class="s1">marr</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">control)</span>

    <span class="s4">def </span><span class="s1">test_compressed(self):</span>
        <span class="s0"># Test ma.compressed function.</span>
        <span class="s0"># Address gh-4026</span>
        <span class="s1">a = np.ma.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">test = np.ma.compressed(a)</span>
        <span class="s1">assert_(type(test) </span><span class="s4">is </span><span class="s1">np.ndarray)</span>

        <span class="s0"># Test case when input data is ndarray subclass</span>
        <span class="s4">class </span><span class="s1">A(np.ndarray):</span>
            <span class="s4">pass</span>

        <span class="s1">a = np.ma.array(A(shape=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">test = np.ma.compressed(a)</span>
        <span class="s1">assert_(type(test) </span><span class="s4">is </span><span class="s1">A)</span>

        <span class="s0"># Test that compress flattens</span>
        <span class="s1">test = np.ma.compressed([[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span><span class="s1">[</span><span class="s5">2</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test.ndim</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">test = np.ma.compressed([[[[[</span><span class="s5">1</span><span class="s1">]]]]])</span>
        <span class="s1">assert_equal(test.ndim</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s0"># Test case when input is MaskedArray subclass</span>
        <span class="s4">class </span><span class="s1">M(MaskedArray):</span>
            <span class="s4">pass</span>

        <span class="s1">test = np.ma.compressed(M([[[]]</span><span class="s4">, </span><span class="s1">[[]]]))</span>
        <span class="s1">assert_equal(test.ndim</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s0"># with .compressed() overridden</span>
        <span class="s4">class </span><span class="s1">M(MaskedArray):</span>
            <span class="s4">def </span><span class="s1">compressed(self):</span>
                <span class="s4">return </span><span class="s5">42</span>

        <span class="s1">test = np.ma.compressed(M([[[]]</span><span class="s4">, </span><span class="s1">[[]]]))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s5">42</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_convolve(self):</span>
        <span class="s1">a = masked_equal(np.arange(</span><span class="s5">5</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">b = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">test = np.ma.convolve(a</span><span class="s4">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">masked_equal([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">))</span>

        <span class="s1">test = np.ma.convolve(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">propagate_mask=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">masked_equal([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">))</span>

        <span class="s1">test = np.ma.convolve([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">masked_equal([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">))</span>

        <span class="s1">a = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">b = masked_equal([</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">test = np.ma.convolve(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">propagate_mask=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">masked_equal([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">test = np.ma.convolve(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">propagate_mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">masked_equal([-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">))</span>


<span class="s4">class </span><span class="s1">TestMaskedFields:</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s1">ilist = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">]</span>
        <span class="s1">flist = [</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s5">4.4</span><span class="s4">, </span><span class="s5">5.5</span><span class="s1">]</span>
        <span class="s1">slist = [</span><span class="s3">'one'</span><span class="s4">, </span><span class="s3">'two'</span><span class="s4">, </span><span class="s3">'three'</span><span class="s4">, </span><span class="s3">'four'</span><span class="s4">, </span><span class="s3">'five'</span><span class="s1">]</span>
        <span class="s1">ddtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)]</span>
        <span class="s1">mdtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s4">, </span><span class="s1">bool)]</span>
        <span class="s1">mask = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">base = array(list(zip(ilist</span><span class="s4">, </span><span class="s1">flist</span><span class="s4">, </span><span class="s1">slist))</span><span class="s4">, </span><span class="s1">mask=mask</span><span class="s4">, </span><span class="s1">dtype=ddtype)</span>
        <span class="s1">self.data = dict(base=base</span><span class="s4">, </span><span class="s1">mask=mask</span><span class="s4">, </span><span class="s1">ddtype=ddtype</span><span class="s4">, </span><span class="s1">mdtype=mdtype)</span>

    <span class="s4">def </span><span class="s1">test_set_records_masks(self):</span>
        <span class="s1">base = self.data[</span><span class="s3">'base'</span><span class="s1">]</span>
        <span class="s1">mdtype = self.data[</span><span class="s3">'mdtype'</span><span class="s1">]</span>
        <span class="s0"># Set w/ nomask or masked</span>
        <span class="s1">base.mask = nomask</span>
        <span class="s1">assert_equal_records(base._mask</span><span class="s4">, </span><span class="s1">np.zeros(base.shape</span><span class="s4">, </span><span class="s1">dtype=mdtype))</span>
        <span class="s1">base.mask = masked</span>
        <span class="s1">assert_equal_records(base._mask</span><span class="s4">, </span><span class="s1">np.ones(base.shape</span><span class="s4">, </span><span class="s1">dtype=mdtype))</span>
        <span class="s0"># Set w/ simple boolean</span>
        <span class="s1">base.mask = </span><span class="s4">False</span>
        <span class="s1">assert_equal_records(base._mask</span><span class="s4">, </span><span class="s1">np.zeros(base.shape</span><span class="s4">, </span><span class="s1">dtype=mdtype))</span>
        <span class="s1">base.mask = </span><span class="s4">True</span>
        <span class="s1">assert_equal_records(base._mask</span><span class="s4">, </span><span class="s1">np.ones(base.shape</span><span class="s4">, </span><span class="s1">dtype=mdtype))</span>
        <span class="s0"># Set w/ list</span>
        <span class="s1">base.mask = [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">assert_equal_records(base._mask</span><span class="s4">,</span>
                             <span class="s1">np.array([(x</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">x) </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]]</span><span class="s4">,</span>
                                      <span class="s1">dtype=mdtype))</span>

    <span class="s4">def </span><span class="s1">test_set_record_element(self):</span>
        <span class="s0"># Check setting an element of a record)</span>
        <span class="s1">base = self.data[</span><span class="s3">'base'</span><span class="s1">]</span>
        <span class="s1">(base_a</span><span class="s4">, </span><span class="s1">base_b</span><span class="s4">, </span><span class="s1">base_c) = (base[</span><span class="s3">'a'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">base[</span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">base[</span><span class="s3">'c'</span><span class="s1">])</span>
        <span class="s1">base[</span><span class="s5">0</span><span class="s1">] = (pi</span><span class="s4">, </span><span class="s1">pi</span><span class="s4">, </span><span class="s3">'pi'</span><span class="s1">)</span>

        <span class="s1">assert_equal(base_a.dtype</span><span class="s4">, </span><span class="s1">int)</span>
        <span class="s1">assert_equal(base_a._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>

        <span class="s1">assert_equal(base_b.dtype</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s1">assert_equal(base_b._data</span><span class="s4">, </span><span class="s1">[pi</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s5">4.4</span><span class="s4">, </span><span class="s5">5.5</span><span class="s1">])</span>

        <span class="s1">assert_equal(base_c.dtype</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)</span>
        <span class="s1">assert_equal(base_c._data</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s6">b'pi'</span><span class="s4">, </span><span class="s6">b'two'</span><span class="s4">, </span><span class="s6">b'three'</span><span class="s4">, </span><span class="s6">b'four'</span><span class="s4">, </span><span class="s6">b'five'</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_set_record_slice(self):</span>
        <span class="s1">base = self.data[</span><span class="s3">'base'</span><span class="s1">]</span>
        <span class="s1">(base_a</span><span class="s4">, </span><span class="s1">base_b</span><span class="s4">, </span><span class="s1">base_c) = (base[</span><span class="s3">'a'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">base[</span><span class="s3">'b'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">base[</span><span class="s3">'c'</span><span class="s1">])</span>
        <span class="s1">base[:</span><span class="s5">3</span><span class="s1">] = (pi</span><span class="s4">, </span><span class="s1">pi</span><span class="s4">, </span><span class="s3">'pi'</span><span class="s1">)</span>

        <span class="s1">assert_equal(base_a.dtype</span><span class="s4">, </span><span class="s1">int)</span>
        <span class="s1">assert_equal(base_a._data</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s1">])</span>

        <span class="s1">assert_equal(base_b.dtype</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s1">assert_equal(base_b._data</span><span class="s4">, </span><span class="s1">[pi</span><span class="s4">, </span><span class="s1">pi</span><span class="s4">, </span><span class="s1">pi</span><span class="s4">, </span><span class="s5">4.4</span><span class="s4">, </span><span class="s5">5.5</span><span class="s1">])</span>

        <span class="s1">assert_equal(base_c.dtype</span><span class="s4">, </span><span class="s3">'|S8'</span><span class="s1">)</span>
        <span class="s1">assert_equal(base_c._data</span><span class="s4">,</span>
                     <span class="s1">[</span><span class="s6">b'pi'</span><span class="s4">, </span><span class="s6">b'pi'</span><span class="s4">, </span><span class="s6">b'pi'</span><span class="s4">, </span><span class="s6">b'four'</span><span class="s4">, </span><span class="s6">b'five'</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_mask_element(self):</span>
        <span class="s2">&quot;Check record access&quot;</span>
        <span class="s1">base = self.data[</span><span class="s3">'base'</span><span class="s1">]</span>
        <span class="s1">base[</span><span class="s5">0</span><span class="s1">] = masked</span>

        <span class="s4">for </span><span class="s1">n </span><span class="s4">in </span><span class="s1">(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'b'</span><span class="s4">, </span><span class="s3">'c'</span><span class="s1">):</span>
            <span class="s1">assert_equal(base[n].mask</span><span class="s4">, </span><span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">assert_equal(base[n]._data</span><span class="s4">, </span><span class="s1">base._data[n])</span>

    <span class="s4">def </span><span class="s1">test_getmaskarray(self):</span>
        <span class="s0"># Test getmaskarray on flexible dtype</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">int)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">test = empty(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">assert_equal(getmaskarray(test)</span><span class="s4">,</span>
                     <span class="s1">np.array([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s4">,</span>
                              <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'|b1'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s3">'|b1'</span><span class="s1">)]))</span>
        <span class="s1">test[:] = masked</span>
        <span class="s1">assert_equal(getmaskarray(test)</span><span class="s4">,</span>
                     <span class="s1">np.array([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">,</span>
                              <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s3">'|b1'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s3">'|b1'</span><span class="s1">)]))</span>

    <span class="s4">def </span><span class="s1">test_view(self):</span>
        <span class="s0"># Test view w/ flexible dtype</span>
        <span class="s1">iterator = list(zip(np.arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">np.random.rand(</span><span class="s5">10</span><span class="s1">)))</span>
        <span class="s1">data = np.array(iterator)</span>
        <span class="s1">a = array(iterator</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">a.mask[</span><span class="s5">0</span><span class="s1">] = (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">controlmask = np.array([</span><span class="s5">1</span><span class="s1">] + </span><span class="s5">19 </span><span class="s1">* [</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s0"># Transform globally to simple dtype</span>
        <span class="s1">test = a.view(float)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">data.ravel())</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">controlmask)</span>
        <span class="s0"># Transform globally to dty</span>
        <span class="s1">test = a.view((float</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">controlmask.reshape(-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">test_getitem(self):</span>
        <span class="s1">ndtype = [(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)]</span>
        <span class="s1">a = array(list(zip(np.random.rand(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">np.arange(</span><span class="s5">10</span><span class="s1">)))</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">a.mask = np.array(list(zip([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                                   <span class="s1">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">]))</span><span class="s4">,</span>
                          <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)])</span>

        <span class="s4">def </span><span class="s1">_test_index(i):</span>
            <span class="s1">assert_equal(type(a[i])</span><span class="s4">, </span><span class="s1">mvoid)</span>
            <span class="s1">assert_equal_records(a[i]._data</span><span class="s4">, </span><span class="s1">a._data[i])</span>
            <span class="s1">assert_equal_records(a[i]._mask</span><span class="s4">, </span><span class="s1">a._mask[i])</span>

            <span class="s1">assert_equal(type(a[i</span><span class="s4">, </span><span class="s1">...])</span><span class="s4">, </span><span class="s1">MaskedArray)</span>
            <span class="s1">assert_equal_records(a[i</span><span class="s4">,</span><span class="s1">...]._data</span><span class="s4">, </span><span class="s1">a._data[i</span><span class="s4">,</span><span class="s1">...])</span>
            <span class="s1">assert_equal_records(a[i</span><span class="s4">,</span><span class="s1">...]._mask</span><span class="s4">, </span><span class="s1">a._mask[i</span><span class="s4">,</span><span class="s1">...])</span>

        <span class="s1">_test_index(</span><span class="s5">1</span><span class="s1">)   </span><span class="s0"># No mask</span>
        <span class="s1">_test_index(</span><span class="s5">0</span><span class="s1">)   </span><span class="s0"># One element masked</span>
        <span class="s1">_test_index(-</span><span class="s5">2</span><span class="s1">)  </span><span class="s0"># All element masked</span>

    <span class="s4">def </span><span class="s1">test_setitem(self):</span>
        <span class="s0"># Issue 4866: check that one can set individual items in [record][col]</span>
        <span class="s0"># and [col][record] order</span>
        <span class="s1">ndtype = np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">int)])</span>
        <span class="s1">ma = np.ma.MaskedArray([(</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">ma[</span><span class="s3">'a'</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">3.0</span>
        <span class="s1">assert_equal(ma[</span><span class="s3">'a'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.array([</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">3.0</span><span class="s1">]))</span>
        <span class="s1">ma[</span><span class="s5">1</span><span class="s1">][</span><span class="s3">'a'</span><span class="s1">] = </span><span class="s5">4.0</span>
        <span class="s1">assert_equal(ma[</span><span class="s3">'a'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">np.array([</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">4.0</span><span class="s1">]))</span>
        <span class="s0"># Issue 2403</span>
        <span class="s1">mdtype = np.dtype([(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">bool)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">bool)])</span>
        <span class="s0"># soft mask</span>
        <span class="s1">control = np.array([(</span><span class="s4">False, True</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s4">True, True</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mdtype)</span>
        <span class="s1">a = np.ma.masked_all((</span><span class="s5">2</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">a[</span><span class="s3">'a'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">2</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">a = np.ma.masked_all((</span><span class="s5">2</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">][</span><span class="s3">'a'</span><span class="s1">] = </span><span class="s5">2</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s0"># hard mask</span>
        <span class="s1">control = np.array([(</span><span class="s4">True, True</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s4">True, True</span><span class="s1">)]</span><span class="s4">, </span><span class="s1">dtype=mdtype)</span>
        <span class="s1">a = np.ma.masked_all((</span><span class="s5">2</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">a.harden_mask()</span>
        <span class="s1">a[</span><span class="s3">'a'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">2</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">control)</span>
        <span class="s1">a = np.ma.masked_all((</span><span class="s5">2</span><span class="s4">,</span><span class="s1">)</span><span class="s4">, </span><span class="s1">dtype=ndtype)</span>
        <span class="s1">a.harden_mask()</span>
        <span class="s1">a[</span><span class="s5">0</span><span class="s1">][</span><span class="s3">'a'</span><span class="s1">] = </span><span class="s5">2</span>
        <span class="s1">assert_equal(a.mask</span><span class="s4">, </span><span class="s1">control)</span>

    <span class="s4">def </span><span class="s1">test_setitem_scalar(self):</span>
        <span class="s0"># 8510</span>
        <span class="s1">mask_0d = np.ma.masked_array(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">mask=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">arr = np.ma.arange(</span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">arr[</span><span class="s5">0</span><span class="s1">] = mask_0d</span>
        <span class="s1">assert_array_equal(arr.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False, False</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_element_len(self):</span>
        <span class="s0"># check that len() works for mvoid (Github issue #576)</span>
        <span class="s4">for </span><span class="s1">rec </span><span class="s4">in </span><span class="s1">self.data[</span><span class="s3">'base'</span><span class="s1">]:</span>
            <span class="s1">assert_equal(len(rec)</span><span class="s4">, </span><span class="s1">len(self.data[</span><span class="s3">'ddtype'</span><span class="s1">]))</span>


<span class="s4">class </span><span class="s1">TestMaskedObjectArray:</span>

    <span class="s4">def </span><span class="s1">test_getitem(self):</span>
        <span class="s1">arr = np.ma.array([</span><span class="s4">None, None</span><span class="s1">])</span>
        <span class="s4">for </span><span class="s1">dt </span><span class="s4">in </span><span class="s1">[float</span><span class="s4">, </span><span class="s1">object]:</span>
            <span class="s1">a0 = np.eye(</span><span class="s5">2</span><span class="s1">).astype(dt)</span>
            <span class="s1">a1 = np.eye(</span><span class="s5">3</span><span class="s1">).astype(dt)</span>
            <span class="s1">arr[</span><span class="s5">0</span><span class="s1">] = a0</span>
            <span class="s1">arr[</span><span class="s5">1</span><span class="s1">] = a1</span>

            <span class="s1">assert_(arr[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">a0)</span>
            <span class="s1">assert_(arr[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is </span><span class="s1">a1)</span>
            <span class="s1">assert_(isinstance(arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...]</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
            <span class="s1">assert_(isinstance(arr[</span><span class="s5">1</span><span class="s4">,</span><span class="s1">...]</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
            <span class="s1">assert_(arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...][()] </span><span class="s4">is </span><span class="s1">a0)</span>
            <span class="s1">assert_(arr[</span><span class="s5">1</span><span class="s4">,</span><span class="s1">...][()] </span><span class="s4">is </span><span class="s1">a1)</span>

            <span class="s1">arr[</span><span class="s5">0</span><span class="s1">] = np.ma.masked</span>

            <span class="s1">assert_(arr[</span><span class="s5">1</span><span class="s1">] </span><span class="s4">is </span><span class="s1">a1)</span>
            <span class="s1">assert_(isinstance(arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...]</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
            <span class="s1">assert_(isinstance(arr[</span><span class="s5">1</span><span class="s4">,</span><span class="s1">...]</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
            <span class="s1">assert_equal(arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...].mask</span><span class="s4">, True</span><span class="s1">)</span>
            <span class="s1">assert_(arr[</span><span class="s5">1</span><span class="s4">,</span><span class="s1">...][()] </span><span class="s4">is </span><span class="s1">a1)</span>

            <span class="s0"># gh-5962 - object arrays of arrays do something special</span>
            <span class="s1">assert_equal(arr[</span><span class="s5">0</span><span class="s1">].data</span><span class="s4">, </span><span class="s1">a0)</span>
            <span class="s1">assert_equal(arr[</span><span class="s5">0</span><span class="s1">].mask</span><span class="s4">, True</span><span class="s1">)</span>
            <span class="s1">assert_equal(arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...][()].data</span><span class="s4">, </span><span class="s1">a0)</span>
            <span class="s1">assert_equal(arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...][()].mask</span><span class="s4">, True</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_nested_ma(self):</span>

        <span class="s1">arr = np.ma.array([</span><span class="s4">None, None</span><span class="s1">])</span>
        <span class="s0"># set the first object to be an unmasked masked constant. A little fiddly</span>
        <span class="s1">arr[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...] = np.array([np.ma.masked]</span><span class="s4">, </span><span class="s1">object)[</span><span class="s5">0</span><span class="s4">,</span><span class="s1">...]</span>

        <span class="s0"># check the above line did what we were aiming for</span>
        <span class="s1">assert_(arr.data[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>

        <span class="s0"># test that getitem returned the value by identity</span>
        <span class="s1">assert_(arr[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>

        <span class="s0"># now mask the masked value!</span>
        <span class="s1">arr[</span><span class="s5">0</span><span class="s1">] = np.ma.masked</span>
        <span class="s1">assert_(arr[</span><span class="s5">0</span><span class="s1">] </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>


<span class="s4">class </span><span class="s1">TestMaskedView:</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s1">iterator = list(zip(np.arange(</span><span class="s5">10</span><span class="s1">)</span><span class="s4">, </span><span class="s1">np.random.rand(</span><span class="s5">10</span><span class="s1">)))</span>
        <span class="s1">data = np.array(iterator)</span>
        <span class="s1">a = array(iterator</span><span class="s4">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">a.mask[</span><span class="s5">0</span><span class="s1">] = (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">controlmask = np.array([</span><span class="s5">1</span><span class="s1">] + </span><span class="s5">19 </span><span class="s1">* [</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">self.data = (data</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">controlmask)</span>

    <span class="s4">def </span><span class="s1">test_view_to_nothing(self):</span>
        <span class="s1">(data</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">controlmask) = self.data</span>
        <span class="s1">test = a.view()</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test._data</span><span class="s4">, </span><span class="s1">a._data)</span>
        <span class="s1">assert_equal(test._mask</span><span class="s4">, </span><span class="s1">a._mask)</span>

    <span class="s4">def </span><span class="s1">test_view_to_type(self):</span>
        <span class="s1">(data</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">controlmask) = self.data</span>
        <span class="s1">test = a.view(np.ndarray)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">a._data)</span>
        <span class="s1">assert_equal_records(test</span><span class="s4">, </span><span class="s1">data.view(a.dtype).squeeze())</span>

    <span class="s4">def </span><span class="s1">test_view_to_simple_dtype(self):</span>
        <span class="s1">(data</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">controlmask) = self.data</span>
        <span class="s0"># View globally</span>
        <span class="s1">test = a.view(float)</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">data.ravel())</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">controlmask)</span>

    <span class="s4">def </span><span class="s1">test_view_to_flexible_dtype(self):</span>
        <span class="s1">(data</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">controlmask) = self.data</span>

        <span class="s1">test = a.view([(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test.mask.dtype.names</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s3">'B'</span><span class="s1">))</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'A'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[</span><span class="s3">'a'</span><span class="s1">])</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'B'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[</span><span class="s3">'b'</span><span class="s1">])</span>

        <span class="s1">test = a[</span><span class="s5">0</span><span class="s1">].view([(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test.mask.dtype.names</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s3">'B'</span><span class="s1">))</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'A'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[</span><span class="s3">'a'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'B'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[</span><span class="s3">'b'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">test = a[-</span><span class="s5">1</span><span class="s1">].view([(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s1">float)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s4">, </span><span class="s1">float)])</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test.dtype.names</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'A'</span><span class="s4">, </span><span class="s3">'B'</span><span class="s1">))</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'A'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[</span><span class="s3">'a'</span><span class="s1">][-</span><span class="s5">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'B'</span><span class="s1">]</span><span class="s4">, </span><span class="s1">a[</span><span class="s3">'b'</span><span class="s1">][-</span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_view_to_subdtype(self):</span>
        <span class="s1">(data</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">controlmask) = self.data</span>
        <span class="s0"># View globally</span>
        <span class="s1">test = a.view((float</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">controlmask.reshape(-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s0"># View on 1 masked element</span>
        <span class="s1">test = a[</span><span class="s5">0</span><span class="s1">].view((float</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">data[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(test.mask</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">))</span>
        <span class="s0"># View on 1 unmasked element</span>
        <span class="s1">test = a[-</span><span class="s5">1</span><span class="s1">].view((float</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">data[-</span><span class="s5">1</span><span class="s1">])</span>

    <span class="s4">def </span><span class="s1">test_view_to_dtype_and_type(self):</span>
        <span class="s1">(data</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">controlmask) = self.data</span>

        <span class="s1">test = a.view((float</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">np.recarray)</span>
        <span class="s1">assert_equal(test</span><span class="s4">, </span><span class="s1">data)</span>
        <span class="s1">assert_(isinstance(test</span><span class="s4">, </span><span class="s1">np.recarray))</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(test</span><span class="s4">, </span><span class="s1">MaskedArray))</span>


<span class="s4">class </span><span class="s1">TestOptionalArgs:</span>
    <span class="s4">def </span><span class="s1">test_ndarrayfuncs(self):</span>
        <span class="s0"># test axis arg behaves the same as ndarray (including multiple axes)</span>

        <span class="s1">d = np.arange(</span><span class="s5">24.0</span><span class="s1">).reshape((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">))</span>
        <span class="s1">m = np.zeros(</span><span class="s5">24</span><span class="s4">, </span><span class="s1">dtype=bool).reshape((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">))</span>
        <span class="s0"># mask out last element of last dimension</span>
        <span class="s1">m[:</span><span class="s4">,</span><span class="s1">:</span><span class="s4">,</span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = </span><span class="s4">True</span>
        <span class="s1">a = np.ma.array(d</span><span class="s4">, </span><span class="s1">mask=m)</span>

        <span class="s4">def </span><span class="s1">testaxis(f</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">d):</span>
            <span class="s1">numpy_f = numpy.__getattribute__(f)</span>
            <span class="s1">ma_f = np.ma.__getattribute__(f)</span>

            <span class="s0"># test axis arg</span>
            <span class="s1">assert_equal(ma_f(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">numpy_f(d[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">))</span>
            <span class="s1">assert_equal(ma_f(a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">))[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                         <span class="s1">numpy_f(d[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">)))</span>

        <span class="s4">def </span><span class="s1">testkeepdims(f</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">d):</span>
            <span class="s1">numpy_f = numpy.__getattribute__(f)</span>
            <span class="s1">ma_f = np.ma.__getattribute__(f)</span>

            <span class="s0"># test keepdims arg</span>
            <span class="s1">assert_equal(ma_f(a</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">).shape</span><span class="s4">,</span>
                         <span class="s1">numpy_f(d</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">).shape)</span>
            <span class="s1">assert_equal(ma_f(a</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">False</span><span class="s1">).shape</span><span class="s4">,</span>
                         <span class="s1">numpy_f(d</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">False</span><span class="s1">).shape)</span>

            <span class="s0"># test both at once</span>
            <span class="s1">assert_equal(ma_f(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                         <span class="s1">numpy_f(d[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">))</span>
            <span class="s1">assert_equal(ma_f(a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">,</span>
                         <span class="s1">numpy_f(d[...</span><span class="s4">,</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">))</span>

        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">[</span><span class="s3">'sum'</span><span class="s4">, </span><span class="s3">'prod'</span><span class="s4">, </span><span class="s3">'mean'</span><span class="s4">, </span><span class="s3">'var'</span><span class="s4">, </span><span class="s3">'std'</span><span class="s1">]:</span>
            <span class="s1">testaxis(f</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">d)</span>
            <span class="s1">testkeepdims(f</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">d)</span>

        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">[</span><span class="s3">'min'</span><span class="s4">, </span><span class="s3">'max'</span><span class="s1">]:</span>
            <span class="s1">testaxis(f</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">d)</span>

        <span class="s1">d = (np.arange(</span><span class="s5">24</span><span class="s1">).reshape((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">))%</span><span class="s5">2 </span><span class="s1">== </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">a = np.ma.array(d</span><span class="s4">, </span><span class="s1">mask=m)</span>
        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">[</span><span class="s3">'all'</span><span class="s4">, </span><span class="s3">'any'</span><span class="s1">]:</span>
            <span class="s1">testaxis(f</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">d)</span>
            <span class="s1">testkeepdims(f</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">d)</span>

    <span class="s4">def </span><span class="s1">test_count(self):</span>
        <span class="s0"># test np.ma.count specially</span>

        <span class="s1">d = np.arange(</span><span class="s5">24.0</span><span class="s1">).reshape((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">))</span>
        <span class="s1">m = np.zeros(</span><span class="s5">24</span><span class="s4">, </span><span class="s1">dtype=bool).reshape((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">4</span><span class="s1">))</span>
        <span class="s1">m[:</span><span class="s4">,</span><span class="s5">0</span><span class="s4">,</span><span class="s1">:] = </span><span class="s4">True</span>
        <span class="s1">a = np.ma.array(d</span><span class="s4">, </span><span class="s1">mask=m)</span>

        <span class="s1">assert_equal(count(a)</span><span class="s4">, </span><span class="s5">16</span><span class="s1">)</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">*ones((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s5">4</span><span class="s1">*ones((</span><span class="s5">4</span><span class="s4">,</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s5">16</span><span class="s1">*ones((</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">*ones((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">1</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s5">4</span><span class="s1">*ones((</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=-</span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">*ones((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_raises(np.AxisError</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">3</span><span class="s1">)</span>

        <span class="s0"># check the 'nomask' path</span>
        <span class="s1">a = np.ma.array(d</span><span class="s4">, </span><span class="s1">mask=nomask)</span>

        <span class="s1">assert_equal(count(a)</span><span class="s4">, </span><span class="s5">24</span><span class="s1">)</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s5">3</span><span class="s1">*ones((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s5">6</span><span class="s1">*ones((</span><span class="s5">4</span><span class="s4">,</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s5">24</span><span class="s1">*ones((</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s1">)))</span>
        <span class="s1">assert_equal(np.ndim(count(a</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">))</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s5">3</span><span class="s1">*ones((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">1</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">keepdims=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s5">6</span><span class="s1">*ones((</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_equal(count(a</span><span class="s4">, </span><span class="s1">axis=-</span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s5">3</span><span class="s1">*ones((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">4</span><span class="s1">)))</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">axis=(</span><span class="s5">1</span><span class="s4">,</span><span class="s5">1</span><span class="s1">))</span>
        <span class="s1">assert_raises(np.AxisError</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">3</span><span class="s1">)</span>

        <span class="s0"># check the 'masked' singleton</span>
        <span class="s1">assert_equal(count(np.ma.masked)</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>

        <span class="s0"># check 0-d arrays do not allow axis &gt; 0</span>
        <span class="s1">assert_raises(np.AxisError</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">np.ma.array(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>


<span class="s4">class </span><span class="s1">TestMaskedConstant:</span>
    <span class="s4">def </span><span class="s1">_do_add_test(self</span><span class="s4">, </span><span class="s1">add):</span>
        <span class="s0"># sanity check</span>
        <span class="s1">assert_(add(np.ma.masked</span><span class="s4">, </span><span class="s5">1</span><span class="s1">) </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>

        <span class="s0"># now try with a vector</span>
        <span class="s1">vector = np.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">result = add(np.ma.masked</span><span class="s4">, </span><span class="s1">vector)</span>

        <span class="s0"># lots of things could go wrong here</span>
        <span class="s1">assert_(result </span><span class="s4">is not </span><span class="s1">np.ma.masked)</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(result</span><span class="s4">, </span><span class="s1">np.ma.core.MaskedConstant))</span>
        <span class="s1">assert_equal(result.shape</span><span class="s4">, </span><span class="s1">vector.shape)</span>
        <span class="s1">assert_equal(np.ma.getmask(result)</span><span class="s4">, </span><span class="s1">np.ones(vector.shape</span><span class="s4">, </span><span class="s1">dtype=bool))</span>

    <span class="s4">def </span><span class="s1">test_ufunc(self):</span>
        <span class="s1">self._do_add_test(np.add)</span>

    <span class="s4">def </span><span class="s1">test_operator(self):</span>
        <span class="s1">self._do_add_test(</span><span class="s4">lambda </span><span class="s1">a</span><span class="s4">, </span><span class="s1">b: a + b)</span>

    <span class="s4">def </span><span class="s1">test_ctor(self):</span>
        <span class="s1">m = np.ma.array(np.ma.masked)</span>

        <span class="s0"># most importantly, we do not want to create a new MaskedConstant</span>
        <span class="s0"># instance</span>
        <span class="s1">assert_(</span><span class="s4">not </span><span class="s1">isinstance(m</span><span class="s4">, </span><span class="s1">np.ma.core.MaskedConstant))</span>
        <span class="s1">assert_(m </span><span class="s4">is not </span><span class="s1">np.ma.masked)</span>

    <span class="s4">def </span><span class="s1">test_repr(self):</span>
        <span class="s0"># copies should not exist, but if they do, it should be obvious that</span>
        <span class="s0"># something is wrong</span>
        <span class="s1">assert_equal(repr(np.ma.masked)</span><span class="s4">, </span><span class="s3">'masked'</span><span class="s1">)</span>

        <span class="s0"># create a new instance in a weird way</span>
        <span class="s1">masked2 = np.ma.MaskedArray.__new__(np.ma.core.MaskedConstant)</span>
        <span class="s1">assert_not_equal(repr(masked2)</span><span class="s4">, </span><span class="s3">'masked'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_pickle(self):</span>
        <span class="s4">from </span><span class="s1">io </span><span class="s4">import </span><span class="s1">BytesIO</span>

        <span class="s4">for </span><span class="s1">proto </span><span class="s4">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">pickle.HIGHEST_PROTOCOL + </span><span class="s5">1</span><span class="s1">):</span>
            <span class="s4">with </span><span class="s1">BytesIO() </span><span class="s4">as </span><span class="s1">f:</span>
                <span class="s1">pickle.dump(np.ma.masked</span><span class="s4">, </span><span class="s1">f</span><span class="s4">, </span><span class="s1">protocol=proto)</span>
                <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
                <span class="s1">res = pickle.load(f)</span>
            <span class="s1">assert_(res </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>

    <span class="s4">def </span><span class="s1">test_copy(self):</span>
        <span class="s0"># gh-9328</span>
        <span class="s0"># copy is a no-op, like it is with np.True_</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">np.ma.masked.copy() </span><span class="s4">is </span><span class="s1">np.ma.masked</span><span class="s4">,</span>
            <span class="s1">np.True_.copy() </span><span class="s4">is </span><span class="s1">np.True_)</span>

    <span class="s4">def </span><span class="s1">test__copy(self):</span>
        <span class="s4">import </span><span class="s1">copy</span>
        <span class="s1">assert_(</span>
            <span class="s1">copy.copy(np.ma.masked) </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>

    <span class="s4">def </span><span class="s1">test_deepcopy(self):</span>
        <span class="s4">import </span><span class="s1">copy</span>
        <span class="s1">assert_(</span>
            <span class="s1">copy.deepcopy(np.ma.masked) </span><span class="s4">is </span><span class="s1">np.ma.masked)</span>

    <span class="s4">def </span><span class="s1">test_immutable(self):</span>
        <span class="s1">orig = np.ma.masked</span>
        <span class="s1">assert_raises(np.ma.core.MaskError</span><span class="s4">, </span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">orig</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">,</span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">orig.data</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">orig.mask</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, False</span><span class="s1">)</span>

        <span class="s1">view = np.ma.masked.view(np.ma.MaskedArray)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">view</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">view.data</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">view.mask</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, False</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_coercion_int(self):</span>
        <span class="s1">a_i = np.zeros(()</span><span class="s4">, </span><span class="s1">int)</span>
        <span class="s1">assert_raises(MaskError</span><span class="s4">, </span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">a_i</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, </span><span class="s1">np.ma.masked)</span>
        <span class="s1">assert_raises(MaskError</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">np.ma.masked)</span>

    <span class="s4">def </span><span class="s1">test_coercion_float(self):</span>
        <span class="s1">a_f = np.zeros(()</span><span class="s4">, </span><span class="s1">float)</span>
        <span class="s1">assert_warns(UserWarning</span><span class="s4">, </span><span class="s1">operator.setitem</span><span class="s4">, </span><span class="s1">a_f</span><span class="s4">, </span><span class="s1">()</span><span class="s4">, </span><span class="s1">np.ma.masked)</span>
        <span class="s1">assert_(np.isnan(a_f[()]))</span>

    <span class="s1">@pytest.mark.xfail(reason=</span><span class="s3">&quot;See gh-9750&quot;</span><span class="s1">)</span>
    <span class="s4">def </span><span class="s1">test_coercion_unicode(self):</span>
        <span class="s1">a_u = np.zeros(()</span><span class="s4">, </span><span class="s3">'U10'</span><span class="s1">)</span>
        <span class="s1">a_u[()] = np.ma.masked</span>
        <span class="s1">assert_equal(a_u[()]</span><span class="s4">, </span><span class="s3">u'--'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.xfail(reason=</span><span class="s3">&quot;See gh-9750&quot;</span><span class="s1">)</span>
    <span class="s4">def </span><span class="s1">test_coercion_bytes(self):</span>
        <span class="s1">a_b = np.zeros(()</span><span class="s4">, </span><span class="s3">'S10'</span><span class="s1">)</span>
        <span class="s1">a_b[()] = np.ma.masked</span>
        <span class="s1">assert_equal(a_b[()]</span><span class="s4">, </span><span class="s6">b'--'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_subclass(self):</span>
        <span class="s0"># https://github.com/astropy/astropy/issues/6645</span>
        <span class="s4">class </span><span class="s1">Sub(type(np.ma.masked)): </span><span class="s4">pass</span>

        <span class="s1">a = Sub()</span>
        <span class="s1">assert_(a </span><span class="s4">is </span><span class="s1">Sub())</span>
        <span class="s1">assert_(a </span><span class="s4">is not </span><span class="s1">np.ma.masked)</span>
        <span class="s1">assert_not_equal(repr(a)</span><span class="s4">, </span><span class="s3">'masked'</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">test_attributes_readonly(self):</span>
        <span class="s1">assert_raises(AttributeError</span><span class="s4">, </span><span class="s1">setattr</span><span class="s4">, </span><span class="s1">np.ma.masked</span><span class="s4">, </span><span class="s3">'shape'</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1</span><span class="s4">,</span><span class="s1">))</span>
        <span class="s1">assert_raises(AttributeError</span><span class="s4">, </span><span class="s1">setattr</span><span class="s4">, </span><span class="s1">np.ma.masked</span><span class="s4">, </span><span class="s3">'dtype'</span><span class="s4">, </span><span class="s1">np.int64)</span>


<span class="s4">class </span><span class="s1">TestMaskedWhereAliases:</span>

    <span class="s0"># TODO: Test masked_object, masked_equal, ...</span>

    <span class="s4">def </span><span class="s1">test_masked_values(self):</span>
        <span class="s1">res = masked_values(np.array([-</span><span class="s5">32768.0</span><span class="s1">])</span><span class="s4">, </span><span class="s1">np.int16(-</span><span class="s5">32768</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True</span><span class="s1">])</span>

        <span class="s1">res = masked_values(np.inf</span><span class="s4">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(res.mask</span><span class="s4">, True</span><span class="s1">)</span>

        <span class="s1">res = np.ma.masked_values(np.inf</span><span class="s4">, </span><span class="s1">-np.inf)</span>
        <span class="s1">assert_equal(res.mask</span><span class="s4">, False</span><span class="s1">)</span>

        <span class="s1">res = np.ma.masked_values([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s1">shrink=</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">assert_(res.mask </span><span class="s4">is </span><span class="s1">np.ma.nomask)</span>

        <span class="s1">res = np.ma.masked_values([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s1">shrink=</span><span class="s4">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False</span><span class="s1">] * </span><span class="s5">4</span><span class="s1">)</span>


<span class="s4">def </span><span class="s1">test_masked_array():</span>
    <span class="s1">a = np.ma.array([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">assert_equal(np.argwhere(a)</span><span class="s4">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">3</span><span class="s1">]])</span>

<span class="s4">def </span><span class="s1">test_masked_array_no_copy():</span>
    <span class="s0"># check nomask array is updated in place</span>
    <span class="s1">a = np.ma.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">])</span>
    <span class="s1">_ = np.ma.masked_where(a == </span><span class="s5">3</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">False</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">False, False, True, False</span><span class="s1">])</span>
    <span class="s0"># check masked array is updated in place</span>
    <span class="s1">a = np.ma.array([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">_ = np.ma.masked_where(a == </span><span class="s5">3</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">False</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(a.mask</span><span class="s4">, </span><span class="s1">[</span><span class="s4">True, False, True, False</span><span class="s1">])</span>

<span class="s4">def </span><span class="s1">test_append_masked_array():</span>
    <span class="s1">a = np.ma.masked_equal([</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">value=</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">b = np.ma.masked_equal([</span><span class="s5">4</span><span class="s4">,</span><span class="s5">3</span><span class="s4">,</span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">value=</span><span class="s5">2</span><span class="s1">)</span>

    <span class="s1">result = np.ma.append(a</span><span class="s4">, </span><span class="s1">b)</span>
    <span class="s1">expected_data = [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">]</span>
    <span class="s1">expected_mask = [</span><span class="s4">False, True, False, False, False, True</span><span class="s1">]</span>
    <span class="s1">assert_array_equal(result.data</span><span class="s4">, </span><span class="s1">expected_data)</span>
    <span class="s1">assert_array_equal(result.mask</span><span class="s4">, </span><span class="s1">expected_mask)</span>

    <span class="s1">a = np.ma.masked_all((</span><span class="s5">2</span><span class="s4">,</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">b = np.ma.ones((</span><span class="s5">3</span><span class="s4">,</span><span class="s5">1</span><span class="s1">))</span>

    <span class="s1">result = np.ma.append(a</span><span class="s4">, </span><span class="s1">b)</span>
    <span class="s1">expected_data = [</span><span class="s5">1</span><span class="s1">] * </span><span class="s5">3</span>
    <span class="s1">expected_mask = [</span><span class="s4">True</span><span class="s1">] * </span><span class="s5">4 </span><span class="s1">+ [</span><span class="s4">False</span><span class="s1">] * </span><span class="s5">3</span>
    <span class="s1">assert_array_equal(result.data[-</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">expected_data)</span>
    <span class="s1">assert_array_equal(result.mask</span><span class="s4">, </span><span class="s1">expected_mask)</span>

    <span class="s1">result = np.ma.append(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">axis=</span><span class="s4">None</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(result.data[-</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">expected_data)</span>
    <span class="s1">assert_array_equal(result.mask</span><span class="s4">, </span><span class="s1">expected_mask)</span>


<span class="s4">def </span><span class="s1">test_append_masked_array_along_axis():</span>
    <span class="s1">a = np.ma.masked_equal([</span><span class="s5">1</span><span class="s4">,</span><span class="s5">2</span><span class="s4">,</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">value=</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">b = np.ma.masked_values([[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]</span><span class="s4">, </span><span class="s1">[</span><span class="s5">7</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">9</span><span class="s1">]]</span><span class="s4">, </span><span class="s5">7</span><span class="s1">)</span>

    <span class="s0"># When `axis` is specified, `values` must have the correct shape.</span>
    <span class="s1">assert_raises(ValueError</span><span class="s4">, </span><span class="s1">np.ma.append</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">result = np.ma.append(a[np.newaxis</span><span class="s4">,</span><span class="s1">:]</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">axis=</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">expected = np.ma.arange(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">expected[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">6</span><span class="s1">]] = np.ma.masked</span>
    <span class="s1">expected = expected.reshape((</span><span class="s5">3</span><span class="s4">,</span><span class="s5">3</span><span class="s1">))</span>
    <span class="s1">assert_array_equal(result.data</span><span class="s4">, </span><span class="s1">expected.data)</span>
    <span class="s1">assert_array_equal(result.mask</span><span class="s4">, </span><span class="s1">expected.mask)</span>

<span class="s4">def </span><span class="s1">test_default_fill_value_complex():</span>
    <span class="s0"># regression test for Python 3, where 'unicode' was not defined</span>
    <span class="s1">assert_(default_fill_value(</span><span class="s5">1 </span><span class="s1">+ </span><span class="s5">1j</span><span class="s1">) == </span><span class="s5">1.e20 </span><span class="s1">+ </span><span class="s5">0.0j</span><span class="s1">)</span>


<span class="s4">def </span><span class="s1">test_ufunc_with_output():</span>
    <span class="s0"># check that giving an output argument always returns that output.</span>
    <span class="s0"># Regression test for gh-8416.</span>
    <span class="s1">x = array([</span><span class="s5">1.</span><span class="s4">, </span><span class="s5">2.</span><span class="s4">, </span><span class="s5">3.</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">y = np.add(x</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">, </span><span class="s1">out=x)</span>
    <span class="s1">assert_(y </span><span class="s4">is </span><span class="s1">x)</span>


<span class="s4">def </span><span class="s1">test_ufunc_with_out_varied():</span>
    <span class="s2">&quot;&quot;&quot; Test that masked arrays are immune to gh-10459 &quot;&quot;&quot;</span>
    <span class="s0"># the mask of the output should not affect the result, however it is passed</span>
    <span class="s1">a        = array([ </span><span class="s5">1</span><span class="s4">,  </span><span class="s5">2</span><span class="s4">,  </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">b        = array([</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">out      = array([ </span><span class="s5">0</span><span class="s4">,  </span><span class="s5">0</span><span class="s4">,  </span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">expected = array([</span><span class="s5">11</span><span class="s4">, </span><span class="s5">22</span><span class="s4">, </span><span class="s5">33</span><span class="s1">]</span><span class="s4">, </span><span class="s1">mask=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">])</span>

    <span class="s1">out_pos = out.copy()</span>
    <span class="s1">res_pos = np.add(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">out_pos)</span>

    <span class="s1">out_kw = out.copy()</span>
    <span class="s1">res_kw = np.add(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">out=out_kw)</span>

    <span class="s1">out_tup = out.copy()</span>
    <span class="s1">res_tup = np.add(a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">out=(out_tup</span><span class="s4">,</span><span class="s1">))</span>

    <span class="s1">assert_equal(res_kw.mask</span><span class="s4">,  </span><span class="s1">expected.mask)</span>
    <span class="s1">assert_equal(res_kw.data</span><span class="s4">,  </span><span class="s1">expected.data)</span>
    <span class="s1">assert_equal(res_tup.mask</span><span class="s4">, </span><span class="s1">expected.mask)</span>
    <span class="s1">assert_equal(res_tup.data</span><span class="s4">, </span><span class="s1">expected.data)</span>
    <span class="s1">assert_equal(res_pos.mask</span><span class="s4">, </span><span class="s1">expected.mask)</span>
    <span class="s1">assert_equal(res_pos.data</span><span class="s4">, </span><span class="s1">expected.data)</span>


<span class="s4">def </span><span class="s1">test_astype_mask_ordering():</span>
    <span class="s1">descr = [(</span><span class="s3">'v'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'x'</span><span class="s4">, </span><span class="s1">[(</span><span class="s3">'y'</span><span class="s4">, </span><span class="s1">float)])]</span>
    <span class="s1">x = array([</span>
        <span class="s1">[([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(</span><span class="s5">1.0</span><span class="s4">,</span><span class="s1">))</span><span class="s4">,  </span><span class="s1">([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(</span><span class="s5">2.0</span><span class="s4">,</span><span class="s1">))]</span><span class="s4">,</span>
        <span class="s1">[([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(</span><span class="s5">3.0</span><span class="s4">,</span><span class="s1">))</span><span class="s4">,  </span><span class="s1">([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(</span><span class="s5">4.0</span><span class="s4">,</span><span class="s1">))]]</span><span class="s4">, </span><span class="s1">dtype=descr)</span>
    <span class="s1">x[</span><span class="s5">0</span><span class="s1">][</span><span class="s3">'v'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] = np.ma.masked</span>

    <span class="s1">x_a = x.astype(descr)</span>
    <span class="s4">assert </span><span class="s1">x_a.dtype.names == np.dtype(descr).names</span>
    <span class="s4">assert </span><span class="s1">x_a.mask.dtype.names == np.dtype(descr).names</span>
    <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">x_a)</span>

    <span class="s1">assert_(x </span><span class="s4">is </span><span class="s1">x.astype(x.dtype</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">False</span><span class="s1">))</span>
    <span class="s1">assert_equal(type(x.astype(x.dtype</span><span class="s4">, </span><span class="s1">subok=</span><span class="s4">False</span><span class="s1">))</span><span class="s4">, </span><span class="s1">np.ndarray)</span>

    <span class="s1">x_f = x.astype(x.dtype</span><span class="s4">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
    <span class="s1">assert_(x_f.flags.f_contiguous)</span>
    <span class="s1">assert_(x_f.mask.flags.f_contiguous)</span>

    <span class="s0"># Also test the same indirectly, via np.array</span>
    <span class="s1">x_a2 = np.array(x</span><span class="s4">, </span><span class="s1">dtype=descr</span><span class="s4">, </span><span class="s1">subok=</span><span class="s4">True</span><span class="s1">)</span>
    <span class="s4">assert </span><span class="s1">x_a2.dtype.names == np.dtype(descr).names</span>
    <span class="s4">assert </span><span class="s1">x_a2.mask.dtype.names == np.dtype(descr).names</span>
    <span class="s1">assert_equal(x</span><span class="s4">, </span><span class="s1">x_a2)</span>

    <span class="s1">assert_(x </span><span class="s4">is </span><span class="s1">np.array(x</span><span class="s4">, </span><span class="s1">dtype=descr</span><span class="s4">, </span><span class="s1">copy=</span><span class="s4">False, </span><span class="s1">subok=</span><span class="s4">True</span><span class="s1">))</span>

    <span class="s1">x_f2 = np.array(x</span><span class="s4">, </span><span class="s1">dtype=x.dtype</span><span class="s4">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s4">, </span><span class="s1">subok=</span><span class="s4">True</span><span class="s1">)</span>
    <span class="s1">assert_(x_f2.flags.f_contiguous)</span>
    <span class="s1">assert_(x_f2.mask.flags.f_contiguous)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt1'</span><span class="s4">, </span><span class="s1">num_dts</span><span class="s4">, </span><span class="s1">ids=num_ids)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'dt2'</span><span class="s4">, </span><span class="s1">num_dts</span><span class="s4">, </span><span class="s1">ids=num_ids)</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s3">'ignore::numpy.ComplexWarning'</span><span class="s1">)</span>
<span class="s4">def </span><span class="s1">test_astype_basic(dt1</span><span class="s4">, </span><span class="s1">dt2):</span>
    <span class="s0"># See gh-12070</span>
    <span class="s1">src = np.ma.array(ones(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">dt1)</span><span class="s4">, </span><span class="s1">fill_value=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">dst = src.astype(dt2)</span>

    <span class="s1">assert_(src.fill_value == </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_(src.dtype == dt1)</span>
    <span class="s1">assert_(src.fill_value.dtype == dt1)</span>

    <span class="s1">assert_(dst.fill_value == </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_(dst.dtype == dt2)</span>
    <span class="s1">assert_(dst.fill_value.dtype == dt2)</span>

    <span class="s1">assert_equal(src</span><span class="s4">, </span><span class="s1">dst)</span>


<span class="s4">def </span><span class="s1">test_fieldless_void():</span>
    <span class="s1">dt = np.dtype([])  </span><span class="s0"># a void dtype with no fields</span>
    <span class="s1">x = np.empty(</span><span class="s5">4</span><span class="s4">, </span><span class="s1">dt)</span>

    <span class="s0"># these arrays contain no values, so there's little to test - but this</span>
    <span class="s0"># shouldn't crash</span>
    <span class="s1">mx = np.ma.array(x)</span>
    <span class="s1">assert_equal(mx.dtype</span><span class="s4">, </span><span class="s1">x.dtype)</span>
    <span class="s1">assert_equal(mx.shape</span><span class="s4">, </span><span class="s1">x.shape)</span>

    <span class="s1">mx = np.ma.array(x</span><span class="s4">, </span><span class="s1">mask=x)</span>
    <span class="s1">assert_equal(mx.dtype</span><span class="s4">, </span><span class="s1">x.dtype)</span>
    <span class="s1">assert_equal(mx.shape</span><span class="s4">, </span><span class="s1">x.shape)</span>


<span class="s4">def </span><span class="s1">test_mask_shape_assignment_does_not_break_masked():</span>
    <span class="s1">a = np.ma.masked</span>
    <span class="s1">b = np.ma.array(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">mask=a.mask)</span>
    <span class="s1">b.shape = (</span><span class="s5">1</span><span class="s4">,</span><span class="s1">)</span>
    <span class="s1">assert_equal(a.mask.shape</span><span class="s4">, </span><span class="s1">())</span>

<span class="s1">@pytest.mark.skipif(sys.flags.optimize &gt; </span><span class="s5">1</span><span class="s4">,</span>
                    <span class="s1">reason=</span><span class="s3">&quot;no docstrings present to inspect when PYTHONOPTIMIZE/Py_OptimizeFlag &gt; 1&quot;</span><span class="s1">)</span>
<span class="s4">def </span><span class="s1">test_doc_note():</span>
    <span class="s4">def </span><span class="s1">method(self):</span>
        <span class="s2">&quot;&quot;&quot;This docstring 
 
        Has multiple lines 
 
        And notes 
 
        Notes 
        ----- 
        original note 
        &quot;&quot;&quot;</span>
        <span class="s4">pass</span>

    <span class="s1">expected_doc = </span><span class="s3">&quot;&quot;&quot;This docstring 
 
Has multiple lines 
 
And notes 
 
Notes 
----- 
note 
 
original note&quot;&quot;&quot;</span>

    <span class="s1">assert_equal(np.ma.core.doc_note(method.__doc__</span><span class="s4">, </span><span class="s3">&quot;note&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">expected_doc)</span>
</pre>
</body>
</html>