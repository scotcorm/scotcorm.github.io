<html>
<head>
<title>_county_choropleth.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_county_choropleth.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">from </span><span class="s1">math </span><span class="s0">import </span><span class="s1">log</span><span class="s0">, </span><span class="s1">floor</span>
<span class="s0">from </span><span class="s1">numbers </span><span class="s0">import </span><span class="s1">Number</span>

<span class="s0">from </span><span class="s1">plotly </span><span class="s0">import </span><span class="s1">optional_imports</span>
<span class="s0">import </span><span class="s1">plotly.colors </span><span class="s0">as </span><span class="s1">clrs</span>
<span class="s0">from </span><span class="s1">plotly.figure_factory </span><span class="s0">import </span><span class="s1">utils</span>
<span class="s0">from </span><span class="s1">plotly.exceptions </span><span class="s0">import </span><span class="s1">PlotlyError</span>
<span class="s0">import </span><span class="s1">plotly.graph_objs </span><span class="s0">as </span><span class="s1">go</span>

<span class="s1">pd.options.mode.chained_assignment = </span><span class="s0">None</span>

<span class="s1">shapely = optional_imports.get_module(</span><span class="s2">&quot;shapely&quot;</span><span class="s1">)</span>
<span class="s1">shapefile = optional_imports.get_module(</span><span class="s2">&quot;shapefile&quot;</span><span class="s1">)</span>
<span class="s1">gp = optional_imports.get_module(</span><span class="s2">&quot;geopandas&quot;</span><span class="s1">)</span>
<span class="s1">_plotly_geo = optional_imports.get_module(</span><span class="s2">&quot;_plotly_geo&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">_create_us_counties_df(st_to_state_name_dict</span><span class="s0">, </span><span class="s1">state_to_st_dict):</span>

    <span class="s3"># URLS</span>
    <span class="s1">abs_dir_path = os.path.realpath(_plotly_geo.__file__)</span>

    <span class="s1">abs_plotly_geo_path = os.path.dirname(abs_dir_path)</span>

    <span class="s1">abs_package_data_dir_path = os.path.join(abs_plotly_geo_path</span><span class="s0">, </span><span class="s2">&quot;package_data&quot;</span><span class="s1">)</span>

    <span class="s1">shape_pre2010 = </span><span class="s2">&quot;gz_2010_us_050_00_500k.shp&quot;</span>
    <span class="s1">shape_pre2010 = os.path.join(abs_package_data_dir_path</span><span class="s0">, </span><span class="s1">shape_pre2010)</span>

    <span class="s1">df_shape_pre2010 = gp.read_file(shape_pre2010)</span>
    <span class="s1">df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] = df_shape_pre2010[</span><span class="s2">&quot;STATE&quot;</span><span class="s1">] + df_shape_pre2010[</span><span class="s2">&quot;COUNTY&quot;</span><span class="s1">]</span>
    <span class="s1">df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] = pd.to_numeric(df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">])</span>

    <span class="s1">states_path = </span><span class="s2">&quot;cb_2016_us_state_500k.shp&quot;</span>
    <span class="s1">states_path = os.path.join(abs_package_data_dir_path</span><span class="s0">, </span><span class="s1">states_path)</span>

    <span class="s1">df_state = gp.read_file(states_path)</span>
    <span class="s1">df_state = df_state[[</span><span class="s2">&quot;STATEFP&quot;</span><span class="s0">, </span><span class="s2">&quot;NAME&quot;</span><span class="s0">, </span><span class="s2">&quot;geometry&quot;</span><span class="s1">]]</span>
    <span class="s1">df_state = df_state.rename(columns={</span><span class="s2">&quot;NAME&quot;</span><span class="s1">: </span><span class="s2">&quot;STATE_NAME&quot;</span><span class="s1">})</span>

    <span class="s1">filenames = [</span>
        <span class="s2">&quot;cb_2016_us_county_500k.dbf&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;cb_2016_us_county_500k.shp&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;cb_2016_us_county_500k.shx&quot;</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(len(filenames)):</span>
        <span class="s1">filenames[j] = os.path.join(abs_package_data_dir_path</span><span class="s0">, </span><span class="s1">filenames[j])</span>

    <span class="s1">dbf = io.open(filenames[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">)</span>
    <span class="s1">shp = io.open(filenames[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">)</span>
    <span class="s1">shx = io.open(filenames[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">)</span>

    <span class="s1">r = shapefile.Reader(shp=shp</span><span class="s0">, </span><span class="s1">shx=shx</span><span class="s0">, </span><span class="s1">dbf=dbf)</span>

    <span class="s1">attributes</span><span class="s0">, </span><span class="s1">geometry = []</span><span class="s0">, </span><span class="s1">[]</span>
    <span class="s1">field_names = [field[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">r.fields[</span><span class="s4">1</span><span class="s1">:]]</span>
    <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">r.shapeRecords():</span>
        <span class="s1">geometry.append(shapely.geometry.shape(row.shape.__geo_interface__))</span>
        <span class="s1">attributes.append(dict(zip(field_names</span><span class="s0">, </span><span class="s1">row.record)))</span>

    <span class="s1">gdf = gp.GeoDataFrame(data=attributes</span><span class="s0">, </span><span class="s1">geometry=geometry)</span>

    <span class="s1">gdf[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] = gdf[</span><span class="s2">&quot;STATEFP&quot;</span><span class="s1">] + gdf[</span><span class="s2">&quot;COUNTYFP&quot;</span><span class="s1">]</span>
    <span class="s1">gdf[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] = pd.to_numeric(gdf[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">])</span>

    <span class="s3"># add missing counties</span>
    <span class="s1">f = </span><span class="s4">46113</span>
    <span class="s1">singlerow = pd.DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">st_to_state_name_dict[</span><span class="s2">&quot;SD&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;SD&quot;</span><span class="s0">,</span>
                <span class="s1">df_shape_pre2010[df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;geometry&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">df_shape_pre2010[df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;46&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;Shannon&quot;</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;State&quot;</span><span class="s0">, </span><span class="s2">&quot;ST&quot;</span><span class="s0">, </span><span class="s2">&quot;geometry&quot;</span><span class="s0">, </span><span class="s2">&quot;FIPS&quot;</span><span class="s0">, </span><span class="s2">&quot;STATEFP&quot;</span><span class="s0">, </span><span class="s2">&quot;NAME&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[max(gdf.index) + </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">gdf = gdf.append(singlerow</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">f = </span><span class="s4">51515</span>
    <span class="s1">singlerow = pd.DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">st_to_state_name_dict[</span><span class="s2">&quot;VA&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;VA&quot;</span><span class="s0">,</span>
                <span class="s1">df_shape_pre2010[df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;geometry&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">df_shape_pre2010[df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;51&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;Bedford City&quot;</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;State&quot;</span><span class="s0">, </span><span class="s2">&quot;ST&quot;</span><span class="s0">, </span><span class="s2">&quot;geometry&quot;</span><span class="s0">, </span><span class="s2">&quot;FIPS&quot;</span><span class="s0">, </span><span class="s2">&quot;STATEFP&quot;</span><span class="s0">, </span><span class="s2">&quot;NAME&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[max(gdf.index) + </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">gdf = gdf.append(singlerow</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">f = </span><span class="s4">2270</span>
    <span class="s1">singlerow = pd.DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">st_to_state_name_dict[</span><span class="s2">&quot;AK&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;AK&quot;</span><span class="s0">,</span>
                <span class="s1">df_shape_pre2010[df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;geometry&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">df_shape_pre2010[df_shape_pre2010[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;02&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;Wade Hampton&quot;</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;State&quot;</span><span class="s0">, </span><span class="s2">&quot;ST&quot;</span><span class="s0">, </span><span class="s2">&quot;geometry&quot;</span><span class="s0">, </span><span class="s2">&quot;FIPS&quot;</span><span class="s0">, </span><span class="s2">&quot;STATEFP&quot;</span><span class="s0">, </span><span class="s2">&quot;NAME&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[max(gdf.index) + </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">gdf = gdf.append(singlerow</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">row_2198 = gdf[gdf[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == </span><span class="s4">2198</span><span class="s1">]</span>
    <span class="s1">row_2198.index = [max(gdf.index) + </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">row_2198.loc[row_2198.index[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] = </span><span class="s4">2201</span>
    <span class="s1">row_2198.loc[row_2198.index[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;STATEFP&quot;</span><span class="s1">] = </span><span class="s2">&quot;02&quot;</span>
    <span class="s1">gdf = gdf.append(row_2198</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">row_2105 = gdf[gdf[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == </span><span class="s4">2105</span><span class="s1">]</span>
    <span class="s1">row_2105.index = [max(gdf.index) + </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">row_2105.loc[row_2105.index[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] = </span><span class="s4">2232</span>
    <span class="s1">row_2105.loc[row_2105.index[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;STATEFP&quot;</span><span class="s1">] = </span><span class="s2">&quot;02&quot;</span>
    <span class="s1">gdf = gdf.append(row_2105</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">gdf = gdf.rename(columns={</span><span class="s2">&quot;NAME&quot;</span><span class="s1">: </span><span class="s2">&quot;COUNTY_NAME&quot;</span><span class="s1">})</span>

    <span class="s1">gdf_reduced = gdf[[</span><span class="s2">&quot;FIPS&quot;</span><span class="s0">, </span><span class="s2">&quot;STATEFP&quot;</span><span class="s0">, </span><span class="s2">&quot;COUNTY_NAME&quot;</span><span class="s0">, </span><span class="s2">&quot;geometry&quot;</span><span class="s1">]]</span>
    <span class="s1">gdf_statefp = gdf_reduced.merge(df_state[[</span><span class="s2">&quot;STATEFP&quot;</span><span class="s0">, </span><span class="s2">&quot;STATE_NAME&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">on=</span><span class="s2">&quot;STATEFP&quot;</span><span class="s1">)</span>

    <span class="s1">ST = []</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">gdf_statefp[</span><span class="s2">&quot;STATE_NAME&quot;</span><span class="s1">]:</span>
        <span class="s1">ST.append(state_to_st_dict[n])</span>

    <span class="s1">gdf_statefp[</span><span class="s2">&quot;ST&quot;</span><span class="s1">] = ST</span>
    <span class="s0">return </span><span class="s1">gdf_statefp</span><span class="s0">, </span><span class="s1">df_state</span>


<span class="s1">st_to_state_name_dict = {</span>
    <span class="s2">&quot;AK&quot;</span><span class="s1">: </span><span class="s2">&quot;Alaska&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;AL&quot;</span><span class="s1">: </span><span class="s2">&quot;Alabama&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;AR&quot;</span><span class="s1">: </span><span class="s2">&quot;Arkansas&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;AZ&quot;</span><span class="s1">: </span><span class="s2">&quot;Arizona&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;CA&quot;</span><span class="s1">: </span><span class="s2">&quot;California&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;CO&quot;</span><span class="s1">: </span><span class="s2">&quot;Colorado&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;CT&quot;</span><span class="s1">: </span><span class="s2">&quot;Connecticut&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;DC&quot;</span><span class="s1">: </span><span class="s2">&quot;District of Columbia&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;DE&quot;</span><span class="s1">: </span><span class="s2">&quot;Delaware&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;FL&quot;</span><span class="s1">: </span><span class="s2">&quot;Florida&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;GA&quot;</span><span class="s1">: </span><span class="s2">&quot;Georgia&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;HI&quot;</span><span class="s1">: </span><span class="s2">&quot;Hawaii&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;IA&quot;</span><span class="s1">: </span><span class="s2">&quot;Iowa&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;ID&quot;</span><span class="s1">: </span><span class="s2">&quot;Idaho&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;IL&quot;</span><span class="s1">: </span><span class="s2">&quot;Illinois&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;IN&quot;</span><span class="s1">: </span><span class="s2">&quot;Indiana&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;KS&quot;</span><span class="s1">: </span><span class="s2">&quot;Kansas&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;KY&quot;</span><span class="s1">: </span><span class="s2">&quot;Kentucky&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;LA&quot;</span><span class="s1">: </span><span class="s2">&quot;Louisiana&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;MA&quot;</span><span class="s1">: </span><span class="s2">&quot;Massachusetts&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;MD&quot;</span><span class="s1">: </span><span class="s2">&quot;Maryland&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;ME&quot;</span><span class="s1">: </span><span class="s2">&quot;Maine&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;MI&quot;</span><span class="s1">: </span><span class="s2">&quot;Michigan&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;MN&quot;</span><span class="s1">: </span><span class="s2">&quot;Minnesota&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;MO&quot;</span><span class="s1">: </span><span class="s2">&quot;Missouri&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;MS&quot;</span><span class="s1">: </span><span class="s2">&quot;Mississippi&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;MT&quot;</span><span class="s1">: </span><span class="s2">&quot;Montana&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;NC&quot;</span><span class="s1">: </span><span class="s2">&quot;North Carolina&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;ND&quot;</span><span class="s1">: </span><span class="s2">&quot;North Dakota&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;NE&quot;</span><span class="s1">: </span><span class="s2">&quot;Nebraska&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;NH&quot;</span><span class="s1">: </span><span class="s2">&quot;New Hampshire&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;NJ&quot;</span><span class="s1">: </span><span class="s2">&quot;New Jersey&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;NM&quot;</span><span class="s1">: </span><span class="s2">&quot;New Mexico&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;NV&quot;</span><span class="s1">: </span><span class="s2">&quot;Nevada&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;NY&quot;</span><span class="s1">: </span><span class="s2">&quot;New York&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;OH&quot;</span><span class="s1">: </span><span class="s2">&quot;Ohio&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;OK&quot;</span><span class="s1">: </span><span class="s2">&quot;Oklahoma&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;OR&quot;</span><span class="s1">: </span><span class="s2">&quot;Oregon&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;PA&quot;</span><span class="s1">: </span><span class="s2">&quot;Pennsylvania&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;RI&quot;</span><span class="s1">: </span><span class="s2">&quot;Rhode Island&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;SC&quot;</span><span class="s1">: </span><span class="s2">&quot;South Carolina&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;SD&quot;</span><span class="s1">: </span><span class="s2">&quot;South Dakota&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;TN&quot;</span><span class="s1">: </span><span class="s2">&quot;Tennessee&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;TX&quot;</span><span class="s1">: </span><span class="s2">&quot;Texas&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;UT&quot;</span><span class="s1">: </span><span class="s2">&quot;Utah&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;VA&quot;</span><span class="s1">: </span><span class="s2">&quot;Virginia&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;VT&quot;</span><span class="s1">: </span><span class="s2">&quot;Vermont&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;WA&quot;</span><span class="s1">: </span><span class="s2">&quot;Washington&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;WI&quot;</span><span class="s1">: </span><span class="s2">&quot;Wisconsin&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;WV&quot;</span><span class="s1">: </span><span class="s2">&quot;West Virginia&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;WY&quot;</span><span class="s1">: </span><span class="s2">&quot;Wyoming&quot;</span><span class="s0">,</span>
<span class="s1">}</span>

<span class="s1">state_to_st_dict = {</span>
    <span class="s2">&quot;Alabama&quot;</span><span class="s1">: </span><span class="s2">&quot;AL&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Alaska&quot;</span><span class="s1">: </span><span class="s2">&quot;AK&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;American Samoa&quot;</span><span class="s1">: </span><span class="s2">&quot;AS&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Arizona&quot;</span><span class="s1">: </span><span class="s2">&quot;AZ&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Arkansas&quot;</span><span class="s1">: </span><span class="s2">&quot;AR&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;California&quot;</span><span class="s1">: </span><span class="s2">&quot;CA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Colorado&quot;</span><span class="s1">: </span><span class="s2">&quot;CO&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Commonwealth of the Northern Mariana Islands&quot;</span><span class="s1">: </span><span class="s2">&quot;MP&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Connecticut&quot;</span><span class="s1">: </span><span class="s2">&quot;CT&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Delaware&quot;</span><span class="s1">: </span><span class="s2">&quot;DE&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;District of Columbia&quot;</span><span class="s1">: </span><span class="s2">&quot;DC&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Florida&quot;</span><span class="s1">: </span><span class="s2">&quot;FL&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Georgia&quot;</span><span class="s1">: </span><span class="s2">&quot;GA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Guam&quot;</span><span class="s1">: </span><span class="s2">&quot;GU&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Hawaii&quot;</span><span class="s1">: </span><span class="s2">&quot;HI&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Idaho&quot;</span><span class="s1">: </span><span class="s2">&quot;ID&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Illinois&quot;</span><span class="s1">: </span><span class="s2">&quot;IL&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Indiana&quot;</span><span class="s1">: </span><span class="s2">&quot;IN&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Iowa&quot;</span><span class="s1">: </span><span class="s2">&quot;IA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Kansas&quot;</span><span class="s1">: </span><span class="s2">&quot;KS&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Kentucky&quot;</span><span class="s1">: </span><span class="s2">&quot;KY&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Louisiana&quot;</span><span class="s1">: </span><span class="s2">&quot;LA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Maine&quot;</span><span class="s1">: </span><span class="s2">&quot;ME&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Maryland&quot;</span><span class="s1">: </span><span class="s2">&quot;MD&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Massachusetts&quot;</span><span class="s1">: </span><span class="s2">&quot;MA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Michigan&quot;</span><span class="s1">: </span><span class="s2">&quot;MI&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Minnesota&quot;</span><span class="s1">: </span><span class="s2">&quot;MN&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Mississippi&quot;</span><span class="s1">: </span><span class="s2">&quot;MS&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Missouri&quot;</span><span class="s1">: </span><span class="s2">&quot;MO&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Montana&quot;</span><span class="s1">: </span><span class="s2">&quot;MT&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Nebraska&quot;</span><span class="s1">: </span><span class="s2">&quot;NE&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Nevada&quot;</span><span class="s1">: </span><span class="s2">&quot;NV&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;New Hampshire&quot;</span><span class="s1">: </span><span class="s2">&quot;NH&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;New Jersey&quot;</span><span class="s1">: </span><span class="s2">&quot;NJ&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;New Mexico&quot;</span><span class="s1">: </span><span class="s2">&quot;NM&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;New York&quot;</span><span class="s1">: </span><span class="s2">&quot;NY&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;North Carolina&quot;</span><span class="s1">: </span><span class="s2">&quot;NC&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;North Dakota&quot;</span><span class="s1">: </span><span class="s2">&quot;ND&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Ohio&quot;</span><span class="s1">: </span><span class="s2">&quot;OH&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Oklahoma&quot;</span><span class="s1">: </span><span class="s2">&quot;OK&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Oregon&quot;</span><span class="s1">: </span><span class="s2">&quot;OR&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Pennsylvania&quot;</span><span class="s1">: </span><span class="s2">&quot;PA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Puerto Rico&quot;</span><span class="s1">: </span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Rhode Island&quot;</span><span class="s1">: </span><span class="s2">&quot;RI&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;South Carolina&quot;</span><span class="s1">: </span><span class="s2">&quot;SC&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;South Dakota&quot;</span><span class="s1">: </span><span class="s2">&quot;SD&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Tennessee&quot;</span><span class="s1">: </span><span class="s2">&quot;TN&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Texas&quot;</span><span class="s1">: </span><span class="s2">&quot;TX&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;United States Virgin Islands&quot;</span><span class="s1">: </span><span class="s2">&quot;VI&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Utah&quot;</span><span class="s1">: </span><span class="s2">&quot;UT&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Vermont&quot;</span><span class="s1">: </span><span class="s2">&quot;VT&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Virginia&quot;</span><span class="s1">: </span><span class="s2">&quot;VA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Washington&quot;</span><span class="s1">: </span><span class="s2">&quot;WA&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;West Virginia&quot;</span><span class="s1">: </span><span class="s2">&quot;WV&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Wisconsin&quot;</span><span class="s1">: </span><span class="s2">&quot;WI&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;Wyoming&quot;</span><span class="s1">: </span><span class="s2">&quot;WY&quot;</span><span class="s0">,</span>
<span class="s1">}</span>

<span class="s1">USA_XRANGE = [-</span><span class="s4">125.0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">65.0</span><span class="s1">]</span>
<span class="s1">USA_YRANGE = [</span><span class="s4">25.0</span><span class="s0">, </span><span class="s4">49.0</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">_human_format(number):</span>
    <span class="s1">units = [</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s2">&quot;K&quot;</span><span class="s0">, </span><span class="s2">&quot;M&quot;</span><span class="s0">, </span><span class="s2">&quot;G&quot;</span><span class="s0">, </span><span class="s2">&quot;T&quot;</span><span class="s0">, </span><span class="s2">&quot;P&quot;</span><span class="s1">]</span>
    <span class="s1">k = </span><span class="s4">1000.0</span>
    <span class="s1">magnitude = int(floor(log(number</span><span class="s0">, </span><span class="s1">k)))</span>
    <span class="s0">return </span><span class="s2">&quot;%.2f%s&quot; </span><span class="s1">% (number / k ** magnitude</span><span class="s0">, </span><span class="s1">units[magnitude])</span>


<span class="s0">def </span><span class="s1">_intervals_as_labels(array_of_intervals</span><span class="s0">, </span><span class="s1">round_legend_values</span><span class="s0">, </span><span class="s1">exponent_format):</span>
    <span class="s5">&quot;&quot;&quot; 
    Transform an number interval to a clean string for legend 
 
    Example: [-inf, 30] to '&lt; 30' 
    &quot;&quot;&quot;</span>
    <span class="s1">infs = [float(</span><span class="s2">&quot;-inf&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;inf&quot;</span><span class="s1">)]</span>
    <span class="s1">string_intervals = []</span>
    <span class="s0">for </span><span class="s1">interval </span><span class="s0">in </span><span class="s1">array_of_intervals:</span>
        <span class="s3"># round to 2nd decimal place</span>
        <span class="s0">if </span><span class="s1">round_legend_values:</span>
            <span class="s1">rnd_interval = [</span>
                <span class="s1">(int(interval[i]) </span><span class="s0">if </span><span class="s1">interval[i] </span><span class="s0">not in </span><span class="s1">infs </span><span class="s0">else </span><span class="s1">interval[i])</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">rnd_interval = [round(interval[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">round(interval[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)]</span>

        <span class="s1">num0 = rnd_interval[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">num1 = rnd_interval[</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">exponent_format:</span>
            <span class="s0">if </span><span class="s1">num0 </span><span class="s0">not in </span><span class="s1">infs:</span>
                <span class="s1">num0 = _human_format(num0)</span>
            <span class="s0">if </span><span class="s1">num1 </span><span class="s0">not in </span><span class="s1">infs:</span>
                <span class="s1">num1 = _human_format(num1)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">num0 </span><span class="s0">not in </span><span class="s1">infs:</span>
                <span class="s1">num0 = </span><span class="s2">&quot;{:,}&quot;</span><span class="s1">.format(num0)</span>
            <span class="s0">if </span><span class="s1">num1 </span><span class="s0">not in </span><span class="s1">infs:</span>
                <span class="s1">num1 = </span><span class="s2">&quot;{:,}&quot;</span><span class="s1">.format(num1)</span>

        <span class="s0">if </span><span class="s1">num0 == float(</span><span class="s2">&quot;-inf&quot;</span><span class="s1">):</span>
            <span class="s1">as_str = </span><span class="s2">&quot;&lt; {}&quot;</span><span class="s1">.format(num1)</span>
        <span class="s0">elif </span><span class="s1">num1 == float(</span><span class="s2">&quot;inf&quot;</span><span class="s1">):</span>
            <span class="s1">as_str = </span><span class="s2">&quot;&gt; {}&quot;</span><span class="s1">.format(num0)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">as_str = </span><span class="s2">&quot;{} - {}&quot;</span><span class="s1">.format(num0</span><span class="s0">, </span><span class="s1">num1)</span>
        <span class="s1">string_intervals.append(as_str)</span>
    <span class="s0">return </span><span class="s1">string_intervals</span>


<span class="s0">def </span><span class="s1">_calculations(</span>
    <span class="s1">df</span><span class="s0">,</span>
    <span class="s1">fips</span><span class="s0">,</span>
    <span class="s1">values</span><span class="s0">,</span>
    <span class="s1">index</span><span class="s0">,</span>
    <span class="s1">f</span><span class="s0">,</span>
    <span class="s1">simplify_county</span><span class="s0">,</span>
    <span class="s1">level</span><span class="s0">,</span>
    <span class="s1">x_centroids</span><span class="s0">,</span>
    <span class="s1">y_centroids</span><span class="s0">,</span>
    <span class="s1">centroid_text</span><span class="s0">,</span>
    <span class="s1">x_traces</span><span class="s0">,</span>
    <span class="s1">y_traces</span><span class="s0">,</span>
    <span class="s1">fips_polygon_map</span><span class="s0">,</span>
<span class="s1">):</span>
    <span class="s3"># 0-pad FIPS code to ensure exactly 5 digits</span>
    <span class="s1">padded_f = str(f).zfill(</span><span class="s4">5</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">fips_polygon_map[f].type == </span><span class="s2">&quot;Polygon&quot;</span><span class="s1">:</span>
        <span class="s1">x = fips_polygon_map[f].simplify(simplify_county).exterior.xy[</span><span class="s4">0</span><span class="s1">].tolist()</span>
        <span class="s1">y = fips_polygon_map[f].simplify(simplify_county).exterior.xy[</span><span class="s4">1</span><span class="s1">].tolist()</span>

        <span class="s1">x_c</span><span class="s0">, </span><span class="s1">y_c = fips_polygon_map[f].centroid.xy</span>
        <span class="s1">county_name_str = str(df[df[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;COUNTY_NAME&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">state_name_str = str(df[df[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;STATE_NAME&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">])</span>

        <span class="s1">t_c = (</span>
            <span class="s2">&quot;County: &quot;</span>
            <span class="s1">+ county_name_str</span>
            <span class="s1">+ </span><span class="s2">&quot;&lt;br&gt;&quot;</span>
            <span class="s1">+ </span><span class="s2">&quot;State: &quot;</span>
            <span class="s1">+ state_name_str</span>
            <span class="s1">+ </span><span class="s2">&quot;&lt;br&gt;&quot;</span>
            <span class="s1">+ </span><span class="s2">&quot;FIPS: &quot;</span>
            <span class="s1">+ padded_f</span>
            <span class="s1">+ </span><span class="s2">&quot;&lt;br&gt;Value: &quot;</span>
            <span class="s1">+ str(values[index])</span>
        <span class="s1">)</span>

        <span class="s1">x_centroids.append(x_c[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">y_centroids.append(y_c[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">centroid_text.append(t_c)</span>

        <span class="s1">x_traces[level] = x_traces[level] + x + [np.nan]</span>
        <span class="s1">y_traces[level] = y_traces[level] + y + [np.nan]</span>
    <span class="s0">elif </span><span class="s1">fips_polygon_map[f].type == </span><span class="s2">&quot;MultiPolygon&quot;</span><span class="s1">:</span>
        <span class="s1">x = [</span>
            <span class="s1">poly.simplify(simplify_county).exterior.xy[</span><span class="s4">0</span><span class="s1">].tolist()</span>
            <span class="s0">for </span><span class="s1">poly </span><span class="s0">in </span><span class="s1">fips_polygon_map[f]</span>
        <span class="s1">]</span>
        <span class="s1">y = [</span>
            <span class="s1">poly.simplify(simplify_county).exterior.xy[</span><span class="s4">1</span><span class="s1">].tolist()</span>
            <span class="s0">for </span><span class="s1">poly </span><span class="s0">in </span><span class="s1">fips_polygon_map[f]</span>
        <span class="s1">]</span>

        <span class="s1">x_c = [poly.centroid.xy[</span><span class="s4">0</span><span class="s1">].tolist() </span><span class="s0">for </span><span class="s1">poly </span><span class="s0">in </span><span class="s1">fips_polygon_map[f]]</span>
        <span class="s1">y_c = [poly.centroid.xy[</span><span class="s4">1</span><span class="s1">].tolist() </span><span class="s0">for </span><span class="s1">poly </span><span class="s0">in </span><span class="s1">fips_polygon_map[f]]</span>

        <span class="s1">county_name_str = str(df[df[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;COUNTY_NAME&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">state_name_str = str(df[df[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">] == f][</span><span class="s2">&quot;STATE_NAME&quot;</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">text = (</span>
            <span class="s2">&quot;County: &quot;</span>
            <span class="s1">+ county_name_str</span>
            <span class="s1">+ </span><span class="s2">&quot;&lt;br&gt;&quot;</span>
            <span class="s1">+ </span><span class="s2">&quot;State: &quot;</span>
            <span class="s1">+ state_name_str</span>
            <span class="s1">+ </span><span class="s2">&quot;&lt;br&gt;&quot;</span>
            <span class="s1">+ </span><span class="s2">&quot;FIPS: &quot;</span>
            <span class="s1">+ padded_f</span>
            <span class="s1">+ </span><span class="s2">&quot;&lt;br&gt;Value: &quot;</span>
            <span class="s1">+ str(values[index])</span>
        <span class="s1">)</span>
        <span class="s1">t_c = [text </span><span class="s0">for </span><span class="s1">poly </span><span class="s0">in </span><span class="s1">fips_polygon_map[f]]</span>
        <span class="s1">x_centroids = x_c + x_centroids</span>
        <span class="s1">y_centroids = y_c + y_centroids</span>
        <span class="s1">centroid_text = t_c + centroid_text</span>
        <span class="s0">for </span><span class="s1">x_y_idx </span><span class="s0">in </span><span class="s1">range(len(x)):</span>
            <span class="s1">x_traces[level] = x_traces[level] + x[x_y_idx] + [np.nan]</span>
            <span class="s1">y_traces[level] = y_traces[level] + y[x_y_idx] + [np.nan]</span>

    <span class="s0">return </span><span class="s1">x_traces</span><span class="s0">, </span><span class="s1">y_traces</span><span class="s0">, </span><span class="s1">x_centroids</span><span class="s0">, </span><span class="s1">y_centroids</span><span class="s0">, </span><span class="s1">centroid_text</span>


<span class="s0">def </span><span class="s1">create_choropleth(</span>
    <span class="s1">fips</span><span class="s0">,</span>
    <span class="s1">values</span><span class="s0">,</span>
    <span class="s1">scope=[</span><span class="s2">&quot;usa&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">binning_endpoints=</span><span class="s0">None,</span>
    <span class="s1">colorscale=</span><span class="s0">None,</span>
    <span class="s1">order=</span><span class="s0">None,</span>
    <span class="s1">simplify_county=</span><span class="s4">0.02</span><span class="s0">,</span>
    <span class="s1">simplify_state=</span><span class="s4">0.02</span><span class="s0">,</span>
    <span class="s1">asp=</span><span class="s0">None,</span>
    <span class="s1">show_hover=</span><span class="s0">True,</span>
    <span class="s1">show_state_data=</span><span class="s0">True,</span>
    <span class="s1">state_outline=</span><span class="s0">None,</span>
    <span class="s1">county_outline=</span><span class="s0">None,</span>
    <span class="s1">centroid_marker=</span><span class="s0">None,</span>
    <span class="s1">round_legend_values=</span><span class="s0">False,</span>
    <span class="s1">exponent_format=</span><span class="s0">False,</span>
    <span class="s1">legend_title=</span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
    <span class="s1">**layout_options</span>
<span class="s1">):</span>
    <span class="s5">&quot;&quot;&quot; 
    **deprecated**, use instead 
    :func:`plotly.express.choropleth` with custom GeoJSON. 
 
    This function also requires `shapely`, `geopandas` and `plotly-geo` to be installed. 
 
    Returns figure for county choropleth. Uses data from package_data. 
 
    :param (list) fips: list of FIPS values which correspond to the con 
        catination of state and county ids. An example is '01001'. 
    :param (list) values: list of numbers/strings which correspond to the 
        fips list. These are the values that will determine how the counties 
        are colored. 
    :param (list) scope: list of states and/or states abbreviations. Fits 
        all states in the camera tightly. Selecting ['usa'] is the equivalent 
        of appending all 50 states into your scope list. Selecting only 'usa' 
        does not include 'Alaska', 'Puerto Rico', 'American Samoa', 
        'Commonwealth of the Northern Mariana Islands', 'Guam', 
        'United States Virgin Islands'. These must be added manually to the 
        list. 
        Default = ['usa'] 
    :param (list) binning_endpoints: ascending numbers which implicitly define 
        real number intervals which are used as bins. The colorscale used must 
        have the same number of colors as the number of bins and this will 
        result in a categorical colormap. 
    :param (list) colorscale: a list of colors with length equal to the 
        number of categories of colors. The length must match either all 
        unique numbers in the 'values' list or if endpoints is being used, the 
        number of categories created by the endpoints.\n 
        For example, if binning_endpoints = [4, 6, 8], then there are 4 bins: 
        [-inf, 4), [4, 6), [6, 8), [8, inf) 
    :param (list) order: a list of the unique categories (numbers/bins) in any 
        desired order. This is helpful if you want to order string values to 
        a chosen colorscale. 
    :param (float) simplify_county: determines the simplification factor 
        for the counties. The larger the number, the fewer vertices and edges 
        each polygon has. See 
        http://toblerity.org/shapely/manual.html#object.simplify for more 
        information. 
        Default = 0.02 
    :param (float) simplify_state: simplifies the state outline polygon. 
        See http://toblerity.org/shapely/manual.html#object.simplify for more 
        information. 
        Default = 0.02 
    :param (float) asp: the width-to-height aspect ratio for the camera. 
        Default = 2.5 
    :param (bool) show_hover: show county hover and centroid info 
    :param (bool) show_state_data: reveals state boundary lines 
    :param (dict) state_outline: dict of attributes of the state outline 
        including width and color. See 
        https://plot.ly/python/reference/#scatter-marker-line for all valid 
        params 
    :param (dict) county_outline: dict of attributes of the county outline 
        including width and color. See 
        https://plot.ly/python/reference/#scatter-marker-line for all valid 
        params 
    :param (dict) centroid_marker: dict of attributes of the centroid marker. 
        The centroid markers are invisible by default and appear visible on 
        selection. See https://plot.ly/python/reference/#scatter-marker for 
        all valid params 
    :param (bool) round_legend_values: automatically round the numbers that 
        appear in the legend to the nearest integer. 
        Default = False 
    :param (bool) exponent_format: if set to True, puts numbers in the K, M, 
        B number format. For example 4000.0 becomes 4.0K 
        Default = False 
    :param (str) legend_title: title that appears above the legend 
    :param **layout_options: a **kwargs argument for all layout parameters 
 
 
    Example 1: Florida:: 
 
        import plotly.plotly as py 
        import plotly.figure_factory as ff 
 
        import numpy as np 
        import pandas as pd 
 
        df_sample = pd.read_csv( 
            'https://raw.githubusercontent.com/plotly/datasets/master/minoritymajority.csv' 
        ) 
        df_sample_r = df_sample[df_sample['STNAME'] == 'Florida'] 
 
        values = df_sample_r['TOT_POP'].tolist() 
        fips = df_sample_r['FIPS'].tolist() 
 
        binning_endpoints = list(np.mgrid[min(values):max(values):4j]) 
        colorscale = [&quot;#030512&quot;,&quot;#1d1d3b&quot;,&quot;#323268&quot;,&quot;#3d4b94&quot;,&quot;#3e6ab0&quot;, 
                    &quot;#4989bc&quot;,&quot;#60a7c7&quot;,&quot;#85c5d3&quot;,&quot;#b7e0e4&quot;,&quot;#eafcfd&quot;] 
        fig = ff.create_choropleth( 
            fips=fips, values=values, scope=['Florida'], show_state_data=True, 
            colorscale=colorscale, binning_endpoints=binning_endpoints, 
            round_legend_values=True, plot_bgcolor='rgb(229,229,229)', 
            paper_bgcolor='rgb(229,229,229)', legend_title='Florida Population', 
            county_outline={'color': 'rgb(255,255,255)', 'width': 0.5}, 
            exponent_format=True, 
        ) 
 
    Example 2: New England:: 
 
        import plotly.figure_factory as ff 
 
        import pandas as pd 
 
        NE_states = ['Connecticut', 'Maine', 'Massachusetts', 
                    'New Hampshire', 'Rhode Island'] 
        df_sample = pd.read_csv( 
            'https://raw.githubusercontent.com/plotly/datasets/master/minoritymajority.csv' 
        ) 
        df_sample_r = df_sample[df_sample['STNAME'].isin(NE_states)] 
        colorscale = ['rgb(68.0, 1.0, 84.0)', 
        'rgb(66.0, 64.0, 134.0)', 
        'rgb(38.0, 130.0, 142.0)', 
        'rgb(63.0, 188.0, 115.0)', 
        'rgb(216.0, 226.0, 25.0)'] 
 
        values = df_sample_r['TOT_POP'].tolist() 
        fips = df_sample_r['FIPS'].tolist() 
        fig = ff.create_choropleth( 
            fips=fips, values=values, scope=NE_states, show_state_data=True 
        ) 
        fig.show() 
 
    Example 3: California and Surrounding States:: 
 
        import plotly.figure_factory as ff 
 
        import pandas as pd 
 
        df_sample = pd.read_csv( 
            'https://raw.githubusercontent.com/plotly/datasets/master/minoritymajority.csv' 
        ) 
        df_sample_r = df_sample[df_sample['STNAME'] == 'California'] 
 
        values = df_sample_r['TOT_POP'].tolist() 
        fips = df_sample_r['FIPS'].tolist() 
 
        colorscale = [ 
            'rgb(193, 193, 193)', 
            'rgb(239,239,239)', 
            'rgb(195, 196, 222)', 
            'rgb(144,148,194)', 
            'rgb(101,104,168)', 
            'rgb(65, 53, 132)' 
        ] 
 
        fig = ff.create_choropleth( 
            fips=fips, values=values, colorscale=colorscale, 
            scope=['CA', 'AZ', 'Nevada', 'Oregon', ' Idaho'], 
            binning_endpoints=[14348, 63983, 134827, 426762, 2081313], 
            county_outline={'color': 'rgb(255,255,255)', 'width': 0.5}, 
            legend_title='California Counties', 
            title='California and Nearby States' 
        ) 
        fig.show() 
 
    Example 4: USA:: 
 
        import plotly.figure_factory as ff 
 
        import numpy as np 
        import pandas as pd 
 
        df_sample = pd.read_csv( 
            'https://raw.githubusercontent.com/plotly/datasets/master/laucnty16.csv' 
        ) 
        df_sample['State FIPS Code'] = df_sample['State FIPS Code'].apply( 
            lambda x: str(x).zfill(2) 
        ) 
        df_sample['County FIPS Code'] = df_sample['County FIPS Code'].apply( 
            lambda x: str(x).zfill(3) 
        ) 
        df_sample['FIPS'] = ( 
            df_sample['State FIPS Code'] + df_sample['County FIPS Code'] 
        ) 
 
        binning_endpoints = list(np.linspace(1, 12, len(colorscale) - 1)) 
        colorscale = [&quot;#f7fbff&quot;, &quot;#ebf3fb&quot;, &quot;#deebf7&quot;, &quot;#d2e3f3&quot;, &quot;#c6dbef&quot;, 
                    &quot;#b3d2e9&quot;, &quot;#9ecae1&quot;, &quot;#85bcdb&quot;, &quot;#6baed6&quot;, &quot;#57a0ce&quot;, 
                    &quot;#4292c6&quot;, &quot;#3082be&quot;, &quot;#2171b5&quot;, &quot;#1361a9&quot;, &quot;#08519c&quot;, 
                    &quot;#0b4083&quot;,&quot;#08306b&quot;] 
        fips = df_sample['FIPS'] 
        values = df_sample['Unemployment Rate (%)'] 
        fig = ff.create_choropleth( 
            fips=fips, values=values, scope=['usa'], 
            binning_endpoints=binning_endpoints, colorscale=colorscale, 
            show_hover=True, centroid_marker={'opacity': 0}, 
            asp=2.9, title='USA by Unemployment %', 
            legend_title='Unemployment %' 
        ) 
        fig.show() 
    &quot;&quot;&quot;</span>
    <span class="s3"># ensure optional modules imported</span>
    <span class="s0">if not </span><span class="s1">_plotly_geo:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s2">&quot;&quot;&quot; 
The create_choropleth figure factory requires the plotly-geo package. 
Install using pip with: 
 
$ pip install plotly-geo 
 
Or, install using conda with 
 
$ conda install -c plotly plotly-geo 
&quot;&quot;&quot;</span>
        <span class="s1">)</span>

    <span class="s0">if not </span><span class="s1">gp </span><span class="s0">or not </span><span class="s1">shapefile </span><span class="s0">or not </span><span class="s1">shapely:</span>
        <span class="s0">raise </span><span class="s1">ImportError(</span>
            <span class="s2">&quot;geopandas, pyshp and shapely must be installed for this figure &quot;</span>
            <span class="s2">&quot;factory.</span><span class="s0">\n\n</span><span class="s2">Run the following commands to install the correct &quot;</span>
            <span class="s2">&quot;versions of the following modules:</span><span class="s0">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;```</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;$ pip install geopandas==0.3.0</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;$ pip install pyshp==1.2.10</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;$ pip install shapely==1.6.3</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;```</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;If you are using Windows, follow this post to properly &quot;</span>
            <span class="s2">&quot;install geopandas and dependencies:&quot;</span>
            <span class="s2">&quot;http://geoffboeing.com/2014/09/using-geopandas-windows/</span><span class="s0">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;If you are using Anaconda, do not use PIP to install the &quot;</span>
            <span class="s2">&quot;packages above. Instead use conda to install them:</span><span class="s0">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;```</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;$ conda install plotly</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;$ conda install geopandas</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;```&quot;</span>
        <span class="s1">)</span>

    <span class="s1">df</span><span class="s0">, </span><span class="s1">df_state = _create_us_counties_df(st_to_state_name_dict</span><span class="s0">, </span><span class="s1">state_to_st_dict)</span>

    <span class="s1">fips_polygon_map = dict(zip(df[</span><span class="s2">&quot;FIPS&quot;</span><span class="s1">].tolist()</span><span class="s0">, </span><span class="s1">df[</span><span class="s2">&quot;geometry&quot;</span><span class="s1">].tolist()))</span>

    <span class="s0">if not </span><span class="s1">state_outline:</span>
        <span class="s1">state_outline = {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;rgb(240, 240, 240)&quot;</span><span class="s0">, </span><span class="s2">&quot;width&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">}</span>
    <span class="s0">if not </span><span class="s1">county_outline:</span>
        <span class="s1">county_outline = {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;rgb(0, 0, 0)&quot;</span><span class="s0">, </span><span class="s2">&quot;width&quot;</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}</span>
    <span class="s0">if not </span><span class="s1">centroid_marker:</span>
        <span class="s1">centroid_marker = {</span><span class="s2">&quot;size&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s0">, </span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;white&quot;</span><span class="s0">, </span><span class="s2">&quot;opacity&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">}</span>

    <span class="s3"># ensure centroid markers appear on selection</span>
    <span class="s0">if </span><span class="s2">&quot;opacity&quot; </span><span class="s0">not in </span><span class="s1">centroid_marker:</span>
        <span class="s1">centroid_marker.update({</span><span class="s2">&quot;opacity&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">})</span>

    <span class="s0">if </span><span class="s1">len(fips) != len(values):</span>
        <span class="s0">raise </span><span class="s1">PlotlyError(</span><span class="s2">&quot;fips and values must be the same length&quot;</span><span class="s1">)</span>

    <span class="s3"># make fips, values into lists</span>
    <span class="s0">if </span><span class="s1">isinstance(fips</span><span class="s0">, </span><span class="s1">pd.core.series.Series):</span>
        <span class="s1">fips = fips.tolist()</span>
    <span class="s0">if </span><span class="s1">isinstance(values</span><span class="s0">, </span><span class="s1">pd.core.series.Series):</span>
        <span class="s1">values = values.tolist()</span>

    <span class="s3"># make fips numeric</span>
    <span class="s1">fips = map(</span><span class="s0">lambda </span><span class="s1">x: int(x)</span><span class="s0">, </span><span class="s1">fips)</span>

    <span class="s0">if </span><span class="s1">binning_endpoints:</span>
        <span class="s1">intervals = utils.endpts_to_intervals(binning_endpoints)</span>
        <span class="s1">LEVELS = _intervals_as_labels(intervals</span><span class="s0">, </span><span class="s1">round_legend_values</span><span class="s0">, </span><span class="s1">exponent_format)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">if not </span><span class="s1">order:</span>
            <span class="s1">LEVELS = sorted(list(set(values)))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s3"># check if order is permutation</span>
            <span class="s3"># of unique color col values</span>
            <span class="s1">same_sets = sorted(list(set(values))) == set(order)</span>
            <span class="s1">no_duplicates = </span><span class="s0">not </span><span class="s1">any(order.count(x) &gt; </span><span class="s4">1 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">order)</span>
            <span class="s0">if </span><span class="s1">same_sets </span><span class="s0">and </span><span class="s1">no_duplicates:</span>
                <span class="s1">LEVELS = order</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">raise </span><span class="s1">PlotlyError(</span>
                    <span class="s2">&quot;if you are using a custom order of unique values from &quot;</span>
                    <span class="s2">&quot;your color column, you must: have all the unique values &quot;</span>
                    <span class="s2">&quot;in your order and have no duplicate items&quot;</span>
                <span class="s1">)</span>

    <span class="s0">if not </span><span class="s1">colorscale:</span>
        <span class="s1">colorscale = []</span>
        <span class="s1">viridis_colors = clrs.colorscale_to_colors(clrs.PLOTLY_SCALES[</span><span class="s2">&quot;Viridis&quot;</span><span class="s1">])</span>
        <span class="s1">viridis_colors = clrs.color_parser(viridis_colors</span><span class="s0">, </span><span class="s1">clrs.hex_to_rgb)</span>
        <span class="s1">viridis_colors = clrs.color_parser(viridis_colors</span><span class="s0">, </span><span class="s1">clrs.label_rgb)</span>
        <span class="s1">viri_len = len(viridis_colors) + </span><span class="s4">1</span>
        <span class="s1">viri_intervals = utils.endpts_to_intervals(list(np.linspace(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">viri_len)))[</span>
            <span class="s4">1</span><span class="s1">:-</span><span class="s4">1</span>
        <span class="s1">]</span>

        <span class="s0">for </span><span class="s1">L </span><span class="s0">in </span><span class="s1">np.linspace(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">len(LEVELS)):</span>
            <span class="s0">for </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">inter </span><span class="s0">in </span><span class="s1">enumerate(viri_intervals):</span>
                <span class="s0">if </span><span class="s1">L == </span><span class="s4">0</span><span class="s1">:</span>
                    <span class="s0">break</span>
                <span class="s0">elif </span><span class="s1">inter[</span><span class="s4">0</span><span class="s1">] &lt; L &lt;= inter[</span><span class="s4">1</span><span class="s1">]:</span>
                    <span class="s0">break</span>

            <span class="s1">intermed = (L - viri_intervals[idx][</span><span class="s4">0</span><span class="s1">]) / (</span>
                <span class="s1">viri_intervals[idx][</span><span class="s4">1</span><span class="s1">] - viri_intervals[idx][</span><span class="s4">0</span><span class="s1">]</span>
            <span class="s1">)</span>

            <span class="s1">float_color = clrs.find_intermediate_color(</span>
                <span class="s1">viridis_colors[idx]</span><span class="s0">, </span><span class="s1">viridis_colors[idx]</span><span class="s0">, </span><span class="s1">intermed</span><span class="s0">, </span><span class="s1">colortype=</span><span class="s2">&quot;rgb&quot;</span>
            <span class="s1">)</span>

            <span class="s3"># make R,G,B into int values</span>
            <span class="s1">float_color = clrs.unlabel_rgb(float_color)</span>
            <span class="s1">float_color = clrs.unconvert_from_RGB_255(float_color)</span>
            <span class="s1">int_rgb = clrs.convert_to_RGB_255(float_color)</span>
            <span class="s1">int_rgb = clrs.label_rgb(int_rgb)</span>

            <span class="s1">colorscale.append(int_rgb)</span>

    <span class="s0">if </span><span class="s1">len(colorscale) &lt; len(LEVELS):</span>
        <span class="s0">raise </span><span class="s1">PlotlyError(</span>
            <span class="s2">&quot;You have {} LEVELS. Your number of colors in 'colorscale' must &quot;</span>
            <span class="s2">&quot;be at least the number of LEVELS: {}. If you are &quot;</span>
            <span class="s2">&quot;using 'binning_endpoints' then 'colorscale' must have at &quot;</span>
            <span class="s2">&quot;least len(binning_endpoints) + 2 colors&quot;</span><span class="s1">.format(</span>
                <span class="s1">len(LEVELS)</span><span class="s0">, </span><span class="s1">min(LEVELS</span><span class="s0">, </span><span class="s1">LEVELS[:</span><span class="s4">20</span><span class="s1">])</span>
            <span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s1">color_lookup = dict(zip(LEVELS</span><span class="s0">, </span><span class="s1">colorscale))</span>
    <span class="s1">x_traces = dict(zip(LEVELS</span><span class="s0">, </span><span class="s1">[[] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(LEVELS))]))</span>
    <span class="s1">y_traces = dict(zip(LEVELS</span><span class="s0">, </span><span class="s1">[[] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(LEVELS))]))</span>

    <span class="s3"># scope</span>
    <span class="s0">if </span><span class="s1">isinstance(scope</span><span class="s0">, </span><span class="s1">str):</span>
        <span class="s0">raise </span><span class="s1">PlotlyError(</span><span class="s2">&quot;'scope' must be a list/tuple/sequence&quot;</span><span class="s1">)</span>

    <span class="s1">scope_names = []</span>
    <span class="s1">extra_states = [</span>
        <span class="s2">&quot;Alaska&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;Commonwealth of the Northern Mariana Islands&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;Puerto Rico&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;Guam&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;United States Virgin Islands&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;American Samoa&quot;</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">for </span><span class="s1">state </span><span class="s0">in </span><span class="s1">scope:</span>
        <span class="s0">if </span><span class="s1">state.lower() == </span><span class="s2">&quot;usa&quot;</span><span class="s1">:</span>
            <span class="s1">scope_names = df[</span><span class="s2">&quot;STATE_NAME&quot;</span><span class="s1">].unique()</span>
            <span class="s1">scope_names = list(scope_names)</span>
            <span class="s0">for </span><span class="s1">ex_st </span><span class="s0">in </span><span class="s1">extra_states:</span>
                <span class="s0">try</span><span class="s1">:</span>
                    <span class="s1">scope_names.remove(ex_st)</span>
                <span class="s0">except </span><span class="s1">ValueError:</span>
                    <span class="s0">pass</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">state </span><span class="s0">in </span><span class="s1">st_to_state_name_dict.keys():</span>
                <span class="s1">state = st_to_state_name_dict[state]</span>
            <span class="s1">scope_names.append(state)</span>
    <span class="s1">df_state = df_state[df_state[</span><span class="s2">&quot;STATE_NAME&quot;</span><span class="s1">].isin(scope_names)]</span>

    <span class="s1">plot_data = []</span>
    <span class="s1">x_centroids = []</span>
    <span class="s1">y_centroids = []</span>
    <span class="s1">centroid_text = []</span>
    <span class="s1">fips_not_in_shapefile = []</span>
    <span class="s0">if not </span><span class="s1">binning_endpoints:</span>
        <span class="s0">for </span><span class="s1">index</span><span class="s0">, </span><span class="s1">f </span><span class="s0">in </span><span class="s1">enumerate(fips):</span>
            <span class="s1">level = values[index]</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">fips_polygon_map[f].type</span>

                <span class="s1">(</span>
                    <span class="s1">x_traces</span><span class="s0">,</span>
                    <span class="s1">y_traces</span><span class="s0">,</span>
                    <span class="s1">x_centroids</span><span class="s0">,</span>
                    <span class="s1">y_centroids</span><span class="s0">,</span>
                    <span class="s1">centroid_text</span><span class="s0">,</span>
                <span class="s1">) = _calculations(</span>
                    <span class="s1">df</span><span class="s0">,</span>
                    <span class="s1">fips</span><span class="s0">,</span>
                    <span class="s1">values</span><span class="s0">,</span>
                    <span class="s1">index</span><span class="s0">,</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">simplify_county</span><span class="s0">,</span>
                    <span class="s1">level</span><span class="s0">,</span>
                    <span class="s1">x_centroids</span><span class="s0">,</span>
                    <span class="s1">y_centroids</span><span class="s0">,</span>
                    <span class="s1">centroid_text</span><span class="s0">,</span>
                    <span class="s1">x_traces</span><span class="s0">,</span>
                    <span class="s1">y_traces</span><span class="s0">,</span>
                    <span class="s1">fips_polygon_map</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s0">except </span><span class="s1">KeyError:</span>
                <span class="s1">fips_not_in_shapefile.append(f)</span>

    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">for </span><span class="s1">index</span><span class="s0">, </span><span class="s1">f </span><span class="s0">in </span><span class="s1">enumerate(fips):</span>
            <span class="s0">for </span><span class="s1">j</span><span class="s0">, </span><span class="s1">inter </span><span class="s0">in </span><span class="s1">enumerate(intervals):</span>
                <span class="s0">if </span><span class="s1">inter[</span><span class="s4">0</span><span class="s1">] &lt; values[index] &lt;= inter[</span><span class="s4">1</span><span class="s1">]:</span>
                    <span class="s0">break</span>
            <span class="s1">level = LEVELS[j]</span>

            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">fips_polygon_map[f].type</span>

                <span class="s1">(</span>
                    <span class="s1">x_traces</span><span class="s0">,</span>
                    <span class="s1">y_traces</span><span class="s0">,</span>
                    <span class="s1">x_centroids</span><span class="s0">,</span>
                    <span class="s1">y_centroids</span><span class="s0">,</span>
                    <span class="s1">centroid_text</span><span class="s0">,</span>
                <span class="s1">) = _calculations(</span>
                    <span class="s1">df</span><span class="s0">,</span>
                    <span class="s1">fips</span><span class="s0">,</span>
                    <span class="s1">values</span><span class="s0">,</span>
                    <span class="s1">index</span><span class="s0">,</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">simplify_county</span><span class="s0">,</span>
                    <span class="s1">level</span><span class="s0">,</span>
                    <span class="s1">x_centroids</span><span class="s0">,</span>
                    <span class="s1">y_centroids</span><span class="s0">,</span>
                    <span class="s1">centroid_text</span><span class="s0">,</span>
                    <span class="s1">x_traces</span><span class="s0">,</span>
                    <span class="s1">y_traces</span><span class="s0">,</span>
                    <span class="s1">fips_polygon_map</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s0">except </span><span class="s1">KeyError:</span>
                <span class="s1">fips_not_in_shapefile.append(f)</span>

    <span class="s0">if </span><span class="s1">len(fips_not_in_shapefile) &gt; </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s1">msg = (</span>
            <span class="s2">&quot;Unrecognized FIPS Values</span><span class="s0">\n\n</span><span class="s2">Whoops! It looks like you are &quot;</span>
            <span class="s2">&quot;trying to pass at least one FIPS value that is not in &quot;</span>
            <span class="s2">&quot;our shapefile of FIPS and data for the counties. Your &quot;</span>
            <span class="s2">&quot;choropleth will still show up but these counties cannot &quot;</span>
            <span class="s2">&quot;be shown.</span><span class="s0">\n</span><span class="s2">Unrecognized FIPS are: {}&quot;</span><span class="s1">.format(fips_not_in_shapefile)</span>
        <span class="s1">)</span>
        <span class="s1">warnings.warn(msg)</span>

    <span class="s1">x_states = []</span>
    <span class="s1">y_states = []</span>
    <span class="s0">for </span><span class="s1">index</span><span class="s0">, </span><span class="s1">row </span><span class="s0">in </span><span class="s1">df_state.iterrows():</span>
        <span class="s0">if </span><span class="s1">df_state[</span><span class="s2">&quot;geometry&quot;</span><span class="s1">][index].type == </span><span class="s2">&quot;Polygon&quot;</span><span class="s1">:</span>
            <span class="s1">x = row.geometry.simplify(simplify_state).exterior.xy[</span><span class="s4">0</span><span class="s1">].tolist()</span>
            <span class="s1">y = row.geometry.simplify(simplify_state).exterior.xy[</span><span class="s4">1</span><span class="s1">].tolist()</span>
            <span class="s1">x_states = x_states + x</span>
            <span class="s1">y_states = y_states + y</span>
        <span class="s0">elif </span><span class="s1">df_state[</span><span class="s2">&quot;geometry&quot;</span><span class="s1">][index].type == </span><span class="s2">&quot;MultiPolygon&quot;</span><span class="s1">:</span>
            <span class="s1">x = [</span>
                <span class="s1">poly.simplify(simplify_state).exterior.xy[</span><span class="s4">0</span><span class="s1">].tolist()</span>
                <span class="s0">for </span><span class="s1">poly </span><span class="s0">in </span><span class="s1">df_state[</span><span class="s2">&quot;geometry&quot;</span><span class="s1">][index]</span>
            <span class="s1">]</span>
            <span class="s1">y = [</span>
                <span class="s1">poly.simplify(simplify_state).exterior.xy[</span><span class="s4">1</span><span class="s1">].tolist()</span>
                <span class="s0">for </span><span class="s1">poly </span><span class="s0">in </span><span class="s1">df_state[</span><span class="s2">&quot;geometry&quot;</span><span class="s1">][index]</span>
            <span class="s1">]</span>
            <span class="s0">for </span><span class="s1">segment </span><span class="s0">in </span><span class="s1">range(len(x)):</span>
                <span class="s1">x_states = x_states + x[segment]</span>
                <span class="s1">y_states = y_states + y[segment]</span>
                <span class="s1">x_states.append(np.nan)</span>
                <span class="s1">y_states.append(np.nan)</span>
        <span class="s1">x_states.append(np.nan)</span>
        <span class="s1">y_states.append(np.nan)</span>

    <span class="s0">for </span><span class="s1">lev </span><span class="s0">in </span><span class="s1">LEVELS:</span>
        <span class="s1">county_data = dict(</span>
            <span class="s1">type=</span><span class="s2">&quot;scatter&quot;</span><span class="s0">,</span>
            <span class="s1">mode=</span><span class="s2">&quot;lines&quot;</span><span class="s0">,</span>
            <span class="s1">x=x_traces[lev]</span><span class="s0">,</span>
            <span class="s1">y=y_traces[lev]</span><span class="s0">,</span>
            <span class="s1">line=county_outline</span><span class="s0">,</span>
            <span class="s1">fill=</span><span class="s2">&quot;toself&quot;</span><span class="s0">,</span>
            <span class="s1">fillcolor=color_lookup[lev]</span><span class="s0">,</span>
            <span class="s1">name=lev</span><span class="s0">,</span>
            <span class="s1">hoverinfo=</span><span class="s2">&quot;none&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">plot_data.append(county_data)</span>

    <span class="s0">if </span><span class="s1">show_hover:</span>
        <span class="s1">hover_points = dict(</span>
            <span class="s1">type=</span><span class="s2">&quot;scatter&quot;</span><span class="s0">,</span>
            <span class="s1">showlegend=</span><span class="s0">False,</span>
            <span class="s1">legendgroup=</span><span class="s2">&quot;centroids&quot;</span><span class="s0">,</span>
            <span class="s1">x=x_centroids</span><span class="s0">,</span>
            <span class="s1">y=y_centroids</span><span class="s0">,</span>
            <span class="s1">text=centroid_text</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s2">&quot;US Counties&quot;</span><span class="s0">,</span>
            <span class="s1">mode=</span><span class="s2">&quot;markers&quot;</span><span class="s0">,</span>
            <span class="s1">marker={</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;white&quot;</span><span class="s0">, </span><span class="s2">&quot;opacity&quot;</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">hoverinfo=</span><span class="s2">&quot;text&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">centroids_on_select = dict(</span>
            <span class="s1">selected=dict(marker=centroid_marker)</span><span class="s0">,</span>
            <span class="s1">unselected=dict(marker=dict(opacity=</span><span class="s4">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">hover_points.update(centroids_on_select)</span>
        <span class="s1">plot_data.append(hover_points)</span>

    <span class="s0">if </span><span class="s1">show_state_data:</span>
        <span class="s1">state_data = dict(</span>
            <span class="s1">type=</span><span class="s2">&quot;scatter&quot;</span><span class="s0">,</span>
            <span class="s1">legendgroup=</span><span class="s2">&quot;States&quot;</span><span class="s0">,</span>
            <span class="s1">line=state_outline</span><span class="s0">,</span>
            <span class="s1">x=x_states</span><span class="s0">,</span>
            <span class="s1">y=y_states</span><span class="s0">,</span>
            <span class="s1">hoverinfo=</span><span class="s2">&quot;text&quot;</span><span class="s0">,</span>
            <span class="s1">showlegend=</span><span class="s0">False,</span>
            <span class="s1">mode=</span><span class="s2">&quot;lines&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">plot_data.append(state_data)</span>

    <span class="s1">DEFAULT_LAYOUT = dict(</span>
        <span class="s1">hovermode=</span><span class="s2">&quot;closest&quot;</span><span class="s0">,</span>
        <span class="s1">xaxis=dict(</span>
            <span class="s1">autorange=</span><span class="s0">False,</span>
            <span class="s1">range=USA_XRANGE</span><span class="s0">,</span>
            <span class="s1">showgrid=</span><span class="s0">False,</span>
            <span class="s1">zeroline=</span><span class="s0">False,</span>
            <span class="s1">fixedrange=</span><span class="s0">True,</span>
            <span class="s1">showticklabels=</span><span class="s0">False,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">yaxis=dict(</span>
            <span class="s1">autorange=</span><span class="s0">False,</span>
            <span class="s1">range=USA_YRANGE</span><span class="s0">,</span>
            <span class="s1">showgrid=</span><span class="s0">False,</span>
            <span class="s1">zeroline=</span><span class="s0">False,</span>
            <span class="s1">fixedrange=</span><span class="s0">True,</span>
            <span class="s1">showticklabels=</span><span class="s0">False,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">margin=dict(t=</span><span class="s4">40</span><span class="s0">, </span><span class="s1">b=</span><span class="s4">20</span><span class="s0">, </span><span class="s1">r=</span><span class="s4">20</span><span class="s0">, </span><span class="s1">l=</span><span class="s4">20</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">width=</span><span class="s4">900</span><span class="s0">,</span>
        <span class="s1">height=</span><span class="s4">450</span><span class="s0">,</span>
        <span class="s1">dragmode=</span><span class="s2">&quot;select&quot;</span><span class="s0">,</span>
        <span class="s1">legend=dict(traceorder=</span><span class="s2">&quot;reversed&quot;</span><span class="s0">, </span><span class="s1">xanchor=</span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">yanchor=</span><span class="s2">&quot;top&quot;</span><span class="s0">, </span><span class="s1">x=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">y=</span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">annotations=[]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">fig = dict(data=plot_data</span><span class="s0">, </span><span class="s1">layout=DEFAULT_LAYOUT)</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">].update(layout_options)</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;annotations&quot;</span><span class="s1">].append(</span>
        <span class="s1">dict(</span>
            <span class="s1">x=</span><span class="s4">1</span><span class="s0">,</span>
            <span class="s1">y=</span><span class="s4">1.05</span><span class="s0">,</span>
            <span class="s1">xref=</span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
            <span class="s1">yref=</span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
            <span class="s1">xanchor=</span><span class="s2">&quot;right&quot;</span><span class="s0">,</span>
            <span class="s1">showarrow=</span><span class="s0">False,</span>
            <span class="s1">text=</span><span class="s2">&quot;&lt;b&gt;&quot; </span><span class="s1">+ legend_title + </span><span class="s2">&quot;&lt;/b&gt;&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">len(scope) == </span><span class="s4">1 </span><span class="s0">and </span><span class="s1">scope[</span><span class="s4">0</span><span class="s1">].lower() == </span><span class="s2">&quot;usa&quot;</span><span class="s1">:</span>
        <span class="s1">xaxis_range_low = -</span><span class="s4">125.0</span>
        <span class="s1">xaxis_range_high = -</span><span class="s4">55.0</span>
        <span class="s1">yaxis_range_low = </span><span class="s4">25.0</span>
        <span class="s1">yaxis_range_high = </span><span class="s4">49.0</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">xaxis_range_low = float(</span><span class="s2">&quot;inf&quot;</span><span class="s1">)</span>
        <span class="s1">xaxis_range_high = float(</span><span class="s2">&quot;-inf&quot;</span><span class="s1">)</span>
        <span class="s1">yaxis_range_low = float(</span><span class="s2">&quot;inf&quot;</span><span class="s1">)</span>
        <span class="s1">yaxis_range_high = float(</span><span class="s2">&quot;-inf&quot;</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">trace </span><span class="s0">in </span><span class="s1">fig[</span><span class="s2">&quot;data&quot;</span><span class="s1">]:</span>
            <span class="s0">if </span><span class="s1">all(isinstance(n</span><span class="s0">, </span><span class="s1">Number) </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">]):</span>
                <span class="s1">calc_x_min = min(trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] </span><span class="s0">or </span><span class="s1">[float(</span><span class="s2">&quot;inf&quot;</span><span class="s1">)])</span>
                <span class="s1">calc_x_max = max(trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] </span><span class="s0">or </span><span class="s1">[float(</span><span class="s2">&quot;-inf&quot;</span><span class="s1">)])</span>
                <span class="s0">if </span><span class="s1">calc_x_min &lt; xaxis_range_low:</span>
                    <span class="s1">xaxis_range_low = calc_x_min</span>
                <span class="s0">if </span><span class="s1">calc_x_max &gt; xaxis_range_high:</span>
                    <span class="s1">xaxis_range_high = calc_x_max</span>
            <span class="s0">if </span><span class="s1">all(isinstance(n</span><span class="s0">, </span><span class="s1">Number) </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">]):</span>
                <span class="s1">calc_y_min = min(trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] </span><span class="s0">or </span><span class="s1">[float(</span><span class="s2">&quot;inf&quot;</span><span class="s1">)])</span>
                <span class="s1">calc_y_max = max(trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] </span><span class="s0">or </span><span class="s1">[float(</span><span class="s2">&quot;-inf&quot;</span><span class="s1">)])</span>
                <span class="s0">if </span><span class="s1">calc_y_min &lt; yaxis_range_low:</span>
                    <span class="s1">yaxis_range_low = calc_y_min</span>
                <span class="s0">if </span><span class="s1">calc_y_max &gt; yaxis_range_high:</span>
                    <span class="s1">yaxis_range_high = calc_y_max</span>

    <span class="s3"># camera zoom</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;xaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">] = [xaxis_range_low</span><span class="s0">, </span><span class="s1">xaxis_range_high]</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;yaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">] = [yaxis_range_low</span><span class="s0">, </span><span class="s1">yaxis_range_high]</span>

    <span class="s3"># aspect ratio</span>
    <span class="s0">if </span><span class="s1">asp </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">usa_x_range = USA_XRANGE[</span><span class="s4">1</span><span class="s1">] - USA_XRANGE[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">usa_y_range = USA_YRANGE[</span><span class="s4">1</span><span class="s1">] - USA_YRANGE[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">asp = usa_x_range / usa_y_range</span>

    <span class="s3"># based on your figure</span>
    <span class="s1">width = float(</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;xaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] - fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;xaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">height = float(</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;yaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] - fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;yaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">center = (</span>
        <span class="s1">sum(fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;xaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">]) / </span><span class="s4">2.0</span><span class="s0">,</span>
        <span class="s1">sum(fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;yaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">]) / </span><span class="s4">2.0</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">height / width &gt; (</span><span class="s4">1 </span><span class="s1">/ asp):</span>
        <span class="s1">new_width = asp * height</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;xaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] = center[</span><span class="s4">0</span><span class="s1">] - new_width * </span><span class="s4">0.5</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;xaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = center[</span><span class="s4">0</span><span class="s1">] + new_width * </span><span class="s4">0.5</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">new_height = (</span><span class="s4">1 </span><span class="s1">/ asp) * width</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;yaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] = center[</span><span class="s4">1</span><span class="s1">] - new_height * </span><span class="s4">0.5</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;yaxis&quot;</span><span class="s1">][</span><span class="s2">&quot;range&quot;</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = center[</span><span class="s4">1</span><span class="s1">] + new_height * </span><span class="s4">0.5</span>

    <span class="s0">return </span><span class="s1">go.Figure(fig)</span>
</pre>
</body>
</html>