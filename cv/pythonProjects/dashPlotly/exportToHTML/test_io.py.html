<html>
<head>
<title>test_io.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_io.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">gc</span>
<span class="s0">import </span><span class="s1">gzip</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">tempfile </span><span class="s0">import </span><span class="s1">NamedTemporaryFile</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span><span class="s0">, </span><span class="s1">StringIO</span>
<span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">locale</span>
<span class="s0">from </span><span class="s1">multiprocessing </span><span class="s0">import </span><span class="s1">Process</span><span class="s0">, </span><span class="s1">Value</span>
<span class="s0">from </span><span class="s1">ctypes </span><span class="s0">import </span><span class="s1">c_bool</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">numpy.ma </span><span class="s0">as </span><span class="s1">ma</span>
<span class="s0">from </span><span class="s1">numpy.lib._iotools </span><span class="s0">import </span><span class="s1">ConverterError</span><span class="s0">, </span><span class="s1">ConversionWarning</span>
<span class="s0">from </span><span class="s1">numpy.compat </span><span class="s0">import </span><span class="s1">asbytes</span>
<span class="s0">from </span><span class="s1">numpy.ma.testutils </span><span class="s0">import </span><span class="s1">assert_equal</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assert_warns</span><span class="s0">, </span><span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_raises_regex</span><span class="s0">, </span><span class="s1">assert_raises</span><span class="s0">,</span>
    <span class="s1">assert_allclose</span><span class="s0">, </span><span class="s1">assert_array_equal</span><span class="s0">, </span><span class="s1">temppath</span><span class="s0">, </span><span class="s1">tempdir</span><span class="s0">, </span><span class="s1">IS_PYPY</span><span class="s0">,</span>
    <span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">suppress_warnings</span><span class="s0">, </span><span class="s1">assert_no_gc_cycles</span><span class="s0">, </span><span class="s1">assert_no_warnings</span><span class="s0">,</span>
    <span class="s1">break_cycles</span>
    <span class="s1">)</span>
<span class="s0">from </span><span class="s1">numpy.testing._private.utils </span><span class="s0">import </span><span class="s1">requires_memory</span>


<span class="s0">class </span><span class="s1">TextIO(BytesIO):</span>
    <span class="s2">&quot;&quot;&quot;Helper IO class. 
 
    Writes encode strings to bytes if needed, reads return bytes. 
    This makes it easier to emulate files opened in binary mode 
    without needing to explicitly convert strings to bytes in 
    setting up the test data. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">s=</span><span class="s3">&quot;&quot;</span><span class="s1">):</span>
        <span class="s1">BytesIO.__init__(self</span><span class="s0">, </span><span class="s1">asbytes(s))</span>

    <span class="s0">def </span><span class="s1">write(self</span><span class="s0">, </span><span class="s1">s):</span>
        <span class="s1">BytesIO.write(self</span><span class="s0">, </span><span class="s1">asbytes(s))</span>

    <span class="s0">def </span><span class="s1">writelines(self</span><span class="s0">, </span><span class="s1">lines):</span>
        <span class="s1">BytesIO.writelines(self</span><span class="s0">, </span><span class="s1">[asbytes(s) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">lines])</span>


<span class="s1">IS_64BIT = sys.maxsize &gt; </span><span class="s4">2</span><span class="s1">**</span><span class="s4">32</span>
<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">import </span><span class="s1">bz2</span>
    <span class="s1">HAS_BZ2 = </span><span class="s0">True</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s1">HAS_BZ2 = </span><span class="s0">False</span>
<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">import </span><span class="s1">lzma</span>
    <span class="s1">HAS_LZMA = </span><span class="s0">True</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s1">HAS_LZMA = </span><span class="s0">False</span>


<span class="s0">def </span><span class="s1">strptime(s</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s0">None</span><span class="s1">):</span>
    <span class="s2">&quot;&quot;&quot; 
    This function is available in the datetime module only from Python &gt;= 
    2.5. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">type(s) == bytes:</span>
        <span class="s1">s = s.decode(</span><span class="s3">&quot;latin1&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">datetime(*time.strptime(s</span><span class="s0">, </span><span class="s1">fmt)[:</span><span class="s4">3</span><span class="s1">])</span>


<span class="s0">class </span><span class="s1">RoundtripTest:</span>
    <span class="s0">def </span><span class="s1">roundtrip(self</span><span class="s0">, </span><span class="s1">save_func</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s2">&quot;&quot;&quot; 
        save_func : callable 
            Function used to save arrays to file. 
        file_on_disk : bool 
            If true, store the file on disk, instead of in a 
            string buffer. 
        save_kwds : dict 
            Parameters passed to `save_func`. 
        load_kwds : dict 
            Parameters passed to `numpy.load`. 
        args : tuple of arrays 
            Arrays stored to file. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">save_kwds = kwargs.get(</span><span class="s3">'save_kwds'</span><span class="s0">, </span><span class="s1">{})</span>
        <span class="s1">load_kwds = kwargs.get(</span><span class="s3">'load_kwds'</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;allow_pickle&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">})</span>
        <span class="s1">file_on_disk = kwargs.get(</span><span class="s3">'file_on_disk'</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s0">if </span><span class="s1">file_on_disk:</span>
            <span class="s1">target_file = NamedTemporaryFile(delete=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">load_file = target_file.name</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">target_file = BytesIO()</span>
            <span class="s1">load_file = target_file</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">arr = args</span>

            <span class="s1">save_func(target_file</span><span class="s0">, </span><span class="s1">*arr</span><span class="s0">, </span><span class="s1">**save_kwds)</span>
            <span class="s1">target_file.flush()</span>
            <span class="s1">target_file.seek(</span><span class="s4">0</span><span class="s1">)</span>

            <span class="s0">if </span><span class="s1">sys.platform == </span><span class="s3">'win32' </span><span class="s0">and not </span><span class="s1">isinstance(target_file</span><span class="s0">, </span><span class="s1">BytesIO):</span>
                <span class="s1">target_file.close()</span>

            <span class="s1">arr_reloaded = np.load(load_file</span><span class="s0">, </span><span class="s1">**load_kwds)</span>

            <span class="s1">self.arr = arr</span>
            <span class="s1">self.arr_reloaded = arr_reloaded</span>
        <span class="s0">finally</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">isinstance(target_file</span><span class="s0">, </span><span class="s1">BytesIO):</span>
                <span class="s1">target_file.close()</span>
                <span class="s5"># holds an open file descriptor so it can't be deleted on win</span>
                <span class="s0">if </span><span class="s3">'arr_reloaded' </span><span class="s0">in </span><span class="s1">locals():</span>
                    <span class="s0">if not </span><span class="s1">isinstance(arr_reloaded</span><span class="s0">, </span><span class="s1">np.lib.npyio.NpzFile):</span>
                        <span class="s1">os.remove(target_file.name)</span>

    <span class="s0">def </span><span class="s1">check_roundtrips(self</span><span class="s0">, </span><span class="s1">a):</span>
        <span class="s1">self.roundtrip(a)</span>
        <span class="s1">self.roundtrip(a</span><span class="s0">, </span><span class="s1">file_on_disk=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">self.roundtrip(np.asfortranarray(a))</span>
        <span class="s1">self.roundtrip(np.asfortranarray(a)</span><span class="s0">, </span><span class="s1">file_on_disk=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">a.shape[</span><span class="s4">0</span><span class="s1">] &gt; </span><span class="s4">1</span><span class="s1">:</span>
            <span class="s5"># neither C nor Fortran contiguous for 2D arrays or more</span>
            <span class="s1">self.roundtrip(np.asfortranarray(a)[</span><span class="s4">1</span><span class="s1">:])</span>
            <span class="s1">self.roundtrip(np.asfortranarray(a)[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">file_on_disk=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_array(self):</span>
        <span class="s1">a = np.array([]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">self.check_roundtrips(a)</span>

        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">self.check_roundtrips(a)</span>

        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">self.check_roundtrips(a)</span>

        <span class="s1">a = np.array([[</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">5j</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">6j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">7j</span><span class="s0">, </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">8j</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.csingle)</span>
        <span class="s1">self.check_roundtrips(a)</span>

        <span class="s1">a = np.array([[</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">5j</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">6j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">7j</span><span class="s0">, </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">8j</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.cdouble)</span>
        <span class="s1">self.check_roundtrips(a)</span>

    <span class="s0">def </span><span class="s1">test_array_object(self):</span>
        <span class="s1">a = np.array([]</span><span class="s0">, </span><span class="s1">object)</span>
        <span class="s1">self.check_roundtrips(a)</span>

        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">object)</span>
        <span class="s1">self.check_roundtrips(a)</span>

    <span class="s0">def </span><span class="s1">test_1D(self):</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">self.roundtrip(a)</span>

    <span class="s1">@pytest.mark.skipif(sys.platform == </span><span class="s3">'win32'</span><span class="s0">, </span><span class="s1">reason=</span><span class="s3">&quot;Fails on Win32&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_mmap(self):</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">7.3</span><span class="s1">]])</span>
        <span class="s1">self.roundtrip(a</span><span class="s0">, </span><span class="s1">file_on_disk=</span><span class="s0">True, </span><span class="s1">load_kwds={</span><span class="s3">'mmap_mode'</span><span class="s1">: </span><span class="s3">'r'</span><span class="s1">})</span>

        <span class="s1">a = np.asfortranarray([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">7.3</span><span class="s1">]])</span>
        <span class="s1">self.roundtrip(a</span><span class="s0">, </span><span class="s1">file_on_disk=</span><span class="s0">True, </span><span class="s1">load_kwds={</span><span class="s3">'mmap_mode'</span><span class="s1">: </span><span class="s3">'r'</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_record(self):</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)])</span>
        <span class="s1">self.check_roundtrips(a)</span>

    <span class="s1">@pytest.mark.slow</span>
    <span class="s0">def </span><span class="s1">test_format_2_0(self):</span>
        <span class="s1">dt = [((</span><span class="s3">&quot;%d&quot; </span><span class="s1">% i) * </span><span class="s4">100</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">500</span><span class="s1">)]</span>
        <span class="s1">a = np.ones(</span><span class="s4">1000</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">):</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">UserWarning)</span>
            <span class="s1">self.check_roundtrips(a)</span>


<span class="s0">class </span><span class="s1">TestSaveLoad(RoundtripTest):</span>
    <span class="s0">def </span><span class="s1">roundtrip(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">RoundtripTest.roundtrip(self</span><span class="s0">, </span><span class="s1">np.save</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(self.arr[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">self.arr_reloaded)</span>
        <span class="s1">assert_equal(self.arr[</span><span class="s4">0</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">self.arr_reloaded.dtype)</span>
        <span class="s1">assert_equal(self.arr[</span><span class="s4">0</span><span class="s1">].flags.fnc</span><span class="s0">, </span><span class="s1">self.arr_reloaded.flags.fnc)</span>


<span class="s0">class </span><span class="s1">TestSavezLoad(RoundtripTest):</span>
    <span class="s0">def </span><span class="s1">roundtrip(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">RoundtripTest.roundtrip(self</span><span class="s0">, </span><span class="s1">np.savez</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s0">for </span><span class="s1">n</span><span class="s0">, </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">enumerate(self.arr):</span>
                <span class="s1">reloaded = self.arr_reloaded[</span><span class="s3">'arr_%d' </span><span class="s1">% n]</span>
                <span class="s1">assert_equal(arr</span><span class="s0">, </span><span class="s1">reloaded)</span>
                <span class="s1">assert_equal(arr.dtype</span><span class="s0">, </span><span class="s1">reloaded.dtype)</span>
                <span class="s1">assert_equal(arr.flags.fnc</span><span class="s0">, </span><span class="s1">reloaded.flags.fnc)</span>
        <span class="s0">finally</span><span class="s1">:</span>
            <span class="s5"># delete tempfile, must be done here on windows</span>
            <span class="s0">if </span><span class="s1">self.arr_reloaded.fid:</span>
                <span class="s1">self.arr_reloaded.fid.close()</span>
                <span class="s1">os.remove(self.arr_reloaded.fid.name)</span>

    <span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">IS_64BIT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s3">&quot;Needs 64bit platform&quot;</span><span class="s1">)</span>
    <span class="s1">@pytest.mark.slow</span>
    <span class="s0">def </span><span class="s1">test_big_arrays(self):</span>
        <span class="s1">L = (</span><span class="s4">1 </span><span class="s1">&lt;&lt; </span><span class="s4">31</span><span class="s1">) + </span><span class="s4">100000</span>
        <span class="s1">a = np.empty(L</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
        <span class="s0">with </span><span class="s1">temppath(prefix=</span><span class="s3">&quot;numpy_test_big_arrays_&quot;</span><span class="s0">, </span><span class="s1">suffix=</span><span class="s3">&quot;.npz&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
            <span class="s1">np.savez(tmp</span><span class="s0">, </span><span class="s1">a=a)</span>
            <span class="s0">del </span><span class="s1">a</span>
            <span class="s1">npfile = np.load(tmp)</span>
            <span class="s1">a = npfile[</span><span class="s3">'a'</span><span class="s1">]  </span><span class="s5"># Should succeed</span>
            <span class="s1">npfile.close()</span>
            <span class="s0">del </span><span class="s1">a  </span><span class="s5"># Avoid pyflakes unused variable warning.</span>

    <span class="s0">def </span><span class="s1">test_multiple_arrays(self):</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">b = np.array([[</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2j</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3 </span><span class="s1">- </span><span class="s4">6j</span><span class="s0">, </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">12j</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">complex)</span>
        <span class="s1">self.roundtrip(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">test_named_arrays(self):</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">b = np.array([[</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2j</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3 </span><span class="s1">- </span><span class="s4">6j</span><span class="s0">, </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">12j</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">complex)</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savez(c</span><span class="s0">, </span><span class="s1">file_a=a</span><span class="s0">, </span><span class="s1">file_b=b)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">l = np.load(c)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">l[</span><span class="s3">'file_a'</span><span class="s1">])</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">l[</span><span class="s3">'file_b'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_BagObj(self):</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">b = np.array([[</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2j</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3 </span><span class="s1">- </span><span class="s4">6j</span><span class="s0">, </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">12j</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">complex)</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savez(c</span><span class="s0">, </span><span class="s1">file_a=a</span><span class="s0">, </span><span class="s1">file_b=b)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">l = np.load(c)</span>
        <span class="s1">assert_equal(sorted(dir(l.f))</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'file_a'</span><span class="s0">,</span><span class="s3">'file_b'</span><span class="s1">])</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">l.f.file_a)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">l.f.file_b)</span>

    <span class="s0">def </span><span class="s1">test_savez_filename_clashes(self):</span>
        <span class="s5"># Test that issue #852 is fixed</span>
        <span class="s5"># and savez functions in multithreaded environment</span>

        <span class="s0">def </span><span class="s1">writer(error_list):</span>
            <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npz'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
                <span class="s1">arr = np.random.randn(</span><span class="s4">500</span><span class="s0">, </span><span class="s4">500</span><span class="s1">)</span>
                <span class="s0">try</span><span class="s1">:</span>
                    <span class="s1">np.savez(tmp</span><span class="s0">, </span><span class="s1">arr=arr)</span>
                <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">err:</span>
                    <span class="s1">error_list.append(err)</span>

        <span class="s1">errors = []</span>
        <span class="s1">threads = [threading.Thread(target=writer</span><span class="s0">, </span><span class="s1">args=(errors</span><span class="s0">,</span><span class="s1">))</span>
                   <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)]</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">threads:</span>
            <span class="s1">t.start()</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">threads:</span>
            <span class="s1">t.join()</span>

        <span class="s0">if </span><span class="s1">errors:</span>
            <span class="s0">raise </span><span class="s1">AssertionError(errors)</span>

    <span class="s0">def </span><span class="s1">test_not_closing_opened_fid(self):</span>
        <span class="s5"># Test that issue #2178 is fixed:</span>
        <span class="s5"># verify could seek on 'loaded' file</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npz'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
            <span class="s0">with </span><span class="s1">open(tmp</span><span class="s0">, </span><span class="s3">'wb'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
                <span class="s1">np.savez(fp</span><span class="s0">, </span><span class="s1">data=</span><span class="s3">'LOVELY LOAD'</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">open(tmp</span><span class="s0">, </span><span class="s3">'rb'</span><span class="s0">, </span><span class="s4">10000</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
                <span class="s1">fp.seek(</span><span class="s4">0</span><span class="s1">)</span>
                <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">fp.closed)</span>
                <span class="s1">np.load(fp)[</span><span class="s3">'data'</span><span class="s1">]</span>
                <span class="s5"># fp must not get closed by .load</span>
                <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">fp.closed)</span>
                <span class="s1">fp.seek(</span><span class="s4">0</span><span class="s1">)</span>
                <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">fp.closed)</span>

    <span class="s1">@pytest.mark.slow_pypy</span>
    <span class="s0">def </span><span class="s1">test_closing_fid(self):</span>
        <span class="s5"># Test that issue #1517 (too many opened files) remains closed</span>
        <span class="s5"># It might be a &quot;weak&quot; test since failed to get triggered on</span>
        <span class="s5"># e.g. Debian sid of 2012 Jul 05 but was reported to</span>
        <span class="s5"># trigger the failure on Ubuntu 10.04:</span>
        <span class="s5"># http://projects.scipy.org/numpy/ticket/1517#comment:2</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npz'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
            <span class="s1">np.savez(tmp</span><span class="s0">, </span><span class="s1">data=</span><span class="s3">'LOVELY LOAD'</span><span class="s1">)</span>
            <span class="s5"># We need to check if the garbage collector can properly close</span>
            <span class="s5"># numpy npz file returned by np.load when their reference count</span>
            <span class="s5"># goes to zero.  Python 3 running in debug mode raises a</span>
            <span class="s5"># ResourceWarning when file closing is left to the garbage</span>
            <span class="s5"># collector, so we catch the warnings.</span>
            <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
                <span class="s1">sup.filter(ResourceWarning)  </span><span class="s5"># TODO: specify exact message</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1025</span><span class="s1">):</span>
                    <span class="s0">try</span><span class="s1">:</span>
                        <span class="s1">np.load(tmp)[</span><span class="s3">&quot;data&quot;</span><span class="s1">]</span>
                    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e:</span>
                        <span class="s1">msg = </span><span class="s3">&quot;Failed to load data from a file: %s&quot; </span><span class="s1">% e</span>
                        <span class="s0">raise </span><span class="s1">AssertionError(msg)</span>
                    <span class="s0">finally</span><span class="s1">:</span>
                        <span class="s0">if </span><span class="s1">IS_PYPY:</span>
                            <span class="s1">gc.collect()</span>

    <span class="s0">def </span><span class="s1">test_closing_zipfile_after_load(self):</span>
        <span class="s5"># Check that zipfile owns file and can close it.  This needs to</span>
        <span class="s5"># pass a file name to load for the test. On windows failure will</span>
        <span class="s5"># cause a second error will be raised when the attempt to remove</span>
        <span class="s5"># the open file is made.</span>
        <span class="s1">prefix = </span><span class="s3">'numpy_test_closing_zipfile_after_load_'</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npz'</span><span class="s0">, </span><span class="s1">prefix=prefix) </span><span class="s0">as </span><span class="s1">tmp:</span>
            <span class="s1">np.savez(tmp</span><span class="s0">, </span><span class="s1">lab=</span><span class="s3">'place holder'</span><span class="s1">)</span>
            <span class="s1">data = np.load(tmp)</span>
            <span class="s1">fp = data.zip.fp</span>
            <span class="s1">data.close()</span>
            <span class="s1">assert_(fp.closed)</span>


<span class="s0">class </span><span class="s1">TestSaveTxt:</span>
    <span class="s0">def </span><span class="s1">test_array(self):</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">fmt = </span><span class="s3">&quot;%.18e&quot;</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=fmt)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.readlines()</span><span class="s0">,</span>
                     <span class="s1">[asbytes((fmt + </span><span class="s3">' ' </span><span class="s1">+ fmt + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">) % (</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">,</span>
                      <span class="s1">asbytes((fmt + </span><span class="s3">' ' </span><span class="s1">+ fmt + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">) % (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))])</span>

        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%d'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.readlines()</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'1 2</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'3 4</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_1D(self):</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%d'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">lines = c.readlines()</span>
        <span class="s1">assert_equal(lines</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'1</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'2</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'3</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'4</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_0D_3D(self):</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.savetxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">np.array(</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.savetxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">np.array([[[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]]))</span>

    <span class="s0">def </span><span class="s1">test_structured(self):</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)])</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%d'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.readlines()</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'1 2</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'3 4</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_structured_padded(self):</span>
        <span class="s5"># gh-13297</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[</span>
            <span class="s1">(</span><span class="s3">'foo'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'bar'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'baz'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span>
        <span class="s1">])</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a[[</span><span class="s3">'foo'</span><span class="s0">, </span><span class="s3">'baz'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%d'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.readlines()</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'1 3</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'4 6</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_multifield_view(self):</span>
        <span class="s1">a = np.ones(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'z'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s1">)])</span>
        <span class="s1">v = a[[</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'z'</span><span class="s1">]]</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npy'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">np.save(path</span><span class="s0">, </span><span class="s1">v)</span>
            <span class="s1">data = np.load(path)</span>
            <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">v)</span>

    <span class="s0">def </span><span class="s1">test_delimiter(self):</span>
        <span class="s1">a = np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]])</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%d'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.readlines()</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'1,2</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'3,4</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_format(self):</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)])</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s5"># Sequence of formats</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=[</span><span class="s3">'%02d'</span><span class="s0">, </span><span class="s3">'%3.1f'</span><span class="s1">])</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.readlines()</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'01 2.0</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'03 4.0</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

        <span class="s5"># A single multiformat string</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%02d : %3.1f'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">lines = c.readlines()</span>
        <span class="s1">assert_equal(lines</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'01 : 2.0</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'03 : 4.0</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

        <span class="s5"># Specify delimiter, should be overridden</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%02d : %3.1f'</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">lines = c.readlines()</span>
        <span class="s1">assert_equal(lines</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b'01 : 2.0</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">, </span><span class="s6">b'03 : 4.0</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

        <span class="s5"># Bad fmt, should raise a ValueError</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.savetxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s4">99</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_header_footer(self):</span>
        <span class="s5"># Test the functionality of the header and footer keyword argument.</span>

        <span class="s1">c = BytesIO()</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">test_header_footer = </span><span class="s3">'Test header / footer'</span>
        <span class="s5"># Test the header keyword argument</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%1d'</span><span class="s0">, </span><span class="s1">header=test_header_footer)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.read()</span><span class="s0">,</span>
                     <span class="s1">asbytes(</span><span class="s3">'# ' </span><span class="s1">+ test_header_footer + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">1 2</span><span class="s0">\n</span><span class="s3">3 4</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">))</span>
        <span class="s5"># Test the footer keyword argument</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%1d'</span><span class="s0">, </span><span class="s1">footer=test_header_footer)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.read()</span><span class="s0">,</span>
                     <span class="s1">asbytes(</span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4</span><span class="s0">\n</span><span class="s3"># ' </span><span class="s1">+ test_header_footer + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">))</span>
        <span class="s5"># Test the commentstr keyword argument used on the header</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">commentstr = </span><span class="s3">'% '</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%1d'</span><span class="s0">,</span>
                   <span class="s1">header=test_header_footer</span><span class="s0">, </span><span class="s1">comments=commentstr)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.read()</span><span class="s0">,</span>
                     <span class="s1">asbytes(commentstr + test_header_footer + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">' </span><span class="s1">+ </span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">))</span>
        <span class="s5"># Test the commentstr keyword argument used on the footer</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">commentstr = </span><span class="s3">'% '</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%1d'</span><span class="s0">,</span>
                   <span class="s1">footer=test_header_footer</span><span class="s0">, </span><span class="s1">comments=commentstr)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(c.read()</span><span class="s0">,</span>
                     <span class="s1">asbytes(</span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4</span><span class="s0">\n</span><span class="s3">' </span><span class="s1">+ commentstr + test_header_footer + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_file_roundtrip(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">name:</span>
            <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)])</span>
            <span class="s1">np.savetxt(name</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">b = np.loadtxt(name)</span>
            <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">test_complex_arrays(self):</span>
        <span class="s1">ncols = </span><span class="s4">2</span>
        <span class="s1">nrows = </span><span class="s4">2</span>
        <span class="s1">a = np.zeros((ncols</span><span class="s0">, </span><span class="s1">nrows)</span><span class="s0">, </span><span class="s1">dtype=np.complex128)</span>
        <span class="s1">re = np.pi</span>
        <span class="s1">im = np.e</span>
        <span class="s1">a[:] = re + </span><span class="s4">1.0j </span><span class="s1">* im</span>

        <span class="s5"># One format only</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">' %+.3e'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">lines = c.readlines()</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">lines</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s6">b' ( +3.142e+00+ +2.718e+00j)  ( +3.142e+00+ +2.718e+00j)</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">,</span>
             <span class="s6">b' ( +3.142e+00+ +2.718e+00j)  ( +3.142e+00+ +2.718e+00j)</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

        <span class="s5"># One format for each real and imaginary part</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'  %+.3e' </span><span class="s1">* </span><span class="s4">2 </span><span class="s1">* ncols)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">lines = c.readlines()</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">lines</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s6">b'  +3.142e+00  +2.718e+00  +3.142e+00  +2.718e+00</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">,</span>
             <span class="s6">b'  +3.142e+00  +2.718e+00  +3.142e+00  +2.718e+00</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

        <span class="s5"># One format for each complex number</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=[</span><span class="s3">'(%.3e%+.3ej)'</span><span class="s1">] * ncols)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">lines = c.readlines()</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">lines</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s6">b'(3.142e+00+2.718e+00j) (3.142e+00+2.718e+00j)</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">,</span>
             <span class="s6">b'(3.142e+00+2.718e+00j) (3.142e+00+2.718e+00j)</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_complex_negative_exponent(self):</span>
        <span class="s5"># Previous to 1.15, some formats generated x+-yj, gh 7895</span>
        <span class="s1">ncols = </span><span class="s4">2</span>
        <span class="s1">nrows = </span><span class="s4">2</span>
        <span class="s1">a = np.zeros((ncols</span><span class="s0">, </span><span class="s1">nrows)</span><span class="s0">, </span><span class="s1">dtype=np.complex128)</span>
        <span class="s1">re = np.pi</span>
        <span class="s1">im = np.e</span>
        <span class="s1">a[:] = re - </span><span class="s4">1.0j </span><span class="s1">* im</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%.3e'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">lines = c.readlines()</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">lines</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s6">b' (3.142e+00-2.718e+00j)  (3.142e+00-2.718e+00j)</span><span class="s0">\n</span><span class="s6">'</span><span class="s0">,</span>
             <span class="s6">b' (3.142e+00-2.718e+00j)  (3.142e+00-2.718e+00j)</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">])</span>


    <span class="s0">def </span><span class="s1">test_custom_writer(self):</span>

        <span class="s0">class </span><span class="s1">CustomWriter(list):</span>
            <span class="s0">def </span><span class="s1">write(self</span><span class="s0">, </span><span class="s1">text):</span>
                <span class="s1">self.extend(text.split(</span><span class="s6">b'</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">))</span>

        <span class="s1">w = CustomWriter()</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)])</span>
        <span class="s1">np.savetxt(w</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">b = np.loadtxt(w)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">test_unicode(self):</span>
        <span class="s1">utf8 = </span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span><span class="s1">.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">a = np.array([utf8]</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
        <span class="s0">with </span><span class="s1">tempdir() </span><span class="s0">as </span><span class="s1">tmpdir:</span>
            <span class="s5"># set encoding as on windows it may not be unicode even on py3</span>
            <span class="s1">np.savetxt(os.path.join(tmpdir</span><span class="s0">, </span><span class="s3">'test.csv'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=[</span><span class="s3">'%s'</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unicode_roundtrip(self):</span>
        <span class="s1">utf8 = </span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span><span class="s1">.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">a = np.array([utf8]</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
        <span class="s5"># our gz wrapper support encoding</span>
        <span class="s1">suffixes = [</span><span class="s3">''</span><span class="s0">, </span><span class="s3">'.gz'</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">HAS_BZ2:</span>
            <span class="s1">suffixes.append(</span><span class="s3">'.bz2'</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">HAS_LZMA:</span>
            <span class="s1">suffixes.extend([</span><span class="s3">'.xz'</span><span class="s0">, </span><span class="s3">'.lzma'</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">tempdir() </span><span class="s0">as </span><span class="s1">tmpdir:</span>
            <span class="s0">for </span><span class="s1">suffix </span><span class="s0">in </span><span class="s1">suffixes:</span>
                <span class="s1">np.savetxt(os.path.join(tmpdir</span><span class="s0">, </span><span class="s3">'test.csv' </span><span class="s1">+ suffix)</span><span class="s0">, </span><span class="s1">a</span><span class="s0">,</span>
                           <span class="s1">fmt=[</span><span class="s3">'%s'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-16-LE'</span><span class="s1">)</span>
                <span class="s1">b = np.loadtxt(os.path.join(tmpdir</span><span class="s0">, </span><span class="s3">'test.csv' </span><span class="s1">+ suffix)</span><span class="s0">,</span>
                               <span class="s1">encoding=</span><span class="s3">'UTF-16-LE'</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
                <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">test_unicode_bytestream(self):</span>
        <span class="s1">utf8 = </span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span><span class="s1">.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">a = np.array([utf8]</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
        <span class="s1">s = BytesIO()</span>
        <span class="s1">np.savetxt(s</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=[</span><span class="s3">'%s'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.read().decode(</span><span class="s3">'UTF-8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">utf8 + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unicode_stringstream(self):</span>
        <span class="s1">utf8 = </span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span><span class="s1">.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">a = np.array([utf8]</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
        <span class="s1">s = StringIO()</span>
        <span class="s1">np.savetxt(s</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=[</span><span class="s3">'%s'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.read()</span><span class="s0">, </span><span class="s1">utf8 + </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;fmt&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">u&quot;%f&quot;</span><span class="s0">, </span><span class="s6">b&quot;%f&quot;</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;iotype&quot;</span><span class="s0">, </span><span class="s1">[StringIO</span><span class="s0">, </span><span class="s1">BytesIO])</span>
    <span class="s0">def </span><span class="s1">test_unicode_and_bytes_fmt(self</span><span class="s0">, </span><span class="s1">fmt</span><span class="s0">, </span><span class="s1">iotype):</span>
        <span class="s5"># string type of fmt should not matter, see also gh-4053</span>
        <span class="s1">a = np.array([</span><span class="s4">1.</span><span class="s1">])</span>
        <span class="s1">s = iotype()</span>
        <span class="s1">np.savetxt(s</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=fmt)</span>
        <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">iotype </span><span class="s0">is </span><span class="s1">StringIO:</span>
            <span class="s1">assert_equal(s.read()</span><span class="s0">, </span><span class="s3">u&quot;%f</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s1">% </span><span class="s4">1.</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_equal(s.read()</span><span class="s0">, </span><span class="s6">b&quot;%f</span><span class="s0">\n</span><span class="s6">&quot; </span><span class="s1">% </span><span class="s4">1.</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.skipif(sys.platform==</span><span class="s3">'win32'</span><span class="s0">, </span><span class="s1">reason=</span><span class="s3">&quot;files&gt;4GB may not work&quot;</span><span class="s1">)</span>
    <span class="s1">@pytest.mark.slow</span>
    <span class="s1">@requires_memory(free_bytes=</span><span class="s4">7e9</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_large_zip(self):</span>
        <span class="s0">def </span><span class="s1">check_large_zip(memoryerror_raised):</span>
            <span class="s1">memoryerror_raised.value = </span><span class="s0">False</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s5"># The test takes at least 6GB of memory, writes a file larger</span>
                <span class="s5"># than 4GB. This tests the ``allowZip64`` kwarg to ``zipfile``</span>
                <span class="s1">test_data = np.asarray([np.random.rand(</span>
                                        <span class="s1">np.random.randint(</span><span class="s4">50</span><span class="s0">,</span><span class="s4">100</span><span class="s1">)</span><span class="s0">,</span><span class="s4">4</span><span class="s1">)</span>
                                        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">800000</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
                <span class="s0">with </span><span class="s1">tempdir() </span><span class="s0">as </span><span class="s1">tmpdir:</span>
                    <span class="s1">np.savez(os.path.join(tmpdir</span><span class="s0">, </span><span class="s3">'test.npz'</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">test_data=test_data)</span>
            <span class="s0">except </span><span class="s1">MemoryError:</span>
                <span class="s1">memoryerror_raised.value = </span><span class="s0">True</span>
                <span class="s0">raise</span>
        <span class="s5"># run in a subprocess to ensure memory is released on PyPy, see gh-15775</span>
        <span class="s5"># Use an object in shared memory to re-raise the MemoryError exception</span>
        <span class="s5"># in our process if needed, see gh-16889</span>
        <span class="s1">memoryerror_raised = Value(c_bool)</span>
        <span class="s1">p = Process(target=check_large_zip</span><span class="s0">, </span><span class="s1">args=(memoryerror_raised</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">p.start()</span>
        <span class="s1">p.join()</span>
        <span class="s0">if </span><span class="s1">memoryerror_raised.value:</span>
            <span class="s0">raise </span><span class="s1">MemoryError(</span><span class="s3">&quot;Child process raised a MemoryError exception&quot;</span><span class="s1">)</span>
        <span class="s5"># -9 indicates a SIGKILL, probably an OOM.</span>
        <span class="s0">if </span><span class="s1">p.exitcode == -</span><span class="s4">9</span><span class="s1">:</span>
            <span class="s1">pytest.xfail(</span><span class="s3">&quot;subprocess got a SIGKILL, apparently free memory was not sufficient&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">p.exitcode == </span><span class="s4">0</span>

<span class="s0">class </span><span class="s1">LoadTxtBase:</span>
    <span class="s0">def </span><span class="s1">check_compressed(self</span><span class="s0">, </span><span class="s1">fopen</span><span class="s0">, </span><span class="s1">suffixes):</span>
        <span class="s5"># Test that we can load data from a compressed file</span>
        <span class="s1">wanted = np.arange(</span><span class="s4">6</span><span class="s1">).reshape((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">linesep = (</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s0">, </span><span class="s3">'</span><span class="s0">\r\n</span><span class="s3">'</span><span class="s0">, </span><span class="s3">'</span><span class="s0">\r</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">sep </span><span class="s0">in </span><span class="s1">linesep:</span>
            <span class="s1">data = </span><span class="s3">'0 1 2' </span><span class="s1">+ sep + </span><span class="s3">'3 4 5'</span>
            <span class="s0">for </span><span class="s1">suffix </span><span class="s0">in </span><span class="s1">suffixes:</span>
                <span class="s0">with </span><span class="s1">temppath(suffix=suffix) </span><span class="s0">as </span><span class="s1">name:</span>
                    <span class="s0">with </span><span class="s1">fopen(name</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">'wt'</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-32-LE'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                        <span class="s1">f.write(data)</span>
                    <span class="s1">res = self.loadfunc(name</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-32-LE'</span><span class="s1">)</span>
                    <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">wanted)</span>
                    <span class="s0">with </span><span class="s1">fopen(name</span><span class="s0">, </span><span class="s3">&quot;rt&quot;</span><span class="s0">,  </span><span class="s1">encoding=</span><span class="s3">'UTF-32-LE'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                        <span class="s1">res = self.loadfunc(f)</span>
                    <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">wanted)</span>

    <span class="s0">def </span><span class="s1">test_compressed_gzip(self):</span>
        <span class="s1">self.check_compressed(gzip.open</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'.gz'</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_BZ2</span><span class="s0">, </span><span class="s1">reason=</span><span class="s3">&quot;Needs bz2&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_compressed_bz2(self):</span>
        <span class="s1">self.check_compressed(bz2.open</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'.bz2'</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_LZMA</span><span class="s0">, </span><span class="s1">reason=</span><span class="s3">&quot;Needs lzma&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_compressed_lzma(self):</span>
        <span class="s1">self.check_compressed(lzma.open</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'.xz'</span><span class="s0">, </span><span class="s3">'.lzma'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_encoding(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s3">'0.</span><span class="s0">\n</span><span class="s3">1.</span><span class="s0">\n</span><span class="s3">2.'</span><span class="s1">.encode(</span><span class="s3">&quot;UTF-16&quot;</span><span class="s1">))</span>
            <span class="s1">x = self.loadfunc(path</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;UTF-16&quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_stringload(self):</span>
        <span class="s5"># umlaute</span>
        <span class="s1">nonascii = </span><span class="s6">b'</span><span class="s0">\xc3\xb6\xc3\xbc\xc3\xb6</span><span class="s6">'</span><span class="s1">.decode(</span><span class="s3">&quot;UTF-8&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(nonascii.encode(</span><span class="s3">&quot;UTF-16&quot;</span><span class="s1">))</span>
            <span class="s1">x = self.loadfunc(path</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;UTF-16&quot;</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">nonascii)</span>

    <span class="s0">def </span><span class="s1">test_binary_decode(self):</span>
        <span class="s1">utf16 = </span><span class="s6">b'</span><span class="s0">\xff\xfe</span><span class="s6">h</span><span class="s0">\x04 \x00</span><span class="s6">i</span><span class="s0">\x04 \x00</span><span class="s6">j</span><span class="s0">\x04</span><span class="s6">'</span>
        <span class="s1">v = self.loadfunc(BytesIO(utf16)</span><span class="s0">, </span><span class="s1">dtype=np.unicode_</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-16'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(v</span><span class="s0">, </span><span class="s1">np.array(utf16.decode(</span><span class="s3">'UTF-16'</span><span class="s1">).split()))</span>

    <span class="s0">def </span><span class="s1">test_converters_decode(self):</span>
        <span class="s5"># test converters that decode strings</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = self.loadfunc(c</span><span class="s0">, </span><span class="s1">dtype=np.unicode_</span><span class="s0">,</span>
                          <span class="s1">converters={</span><span class="s4">0</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">x: x.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)})</span>
        <span class="s1">a = np.array([</span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span><span class="s1">.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)])</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_converters_nodecode(self):</span>
        <span class="s5"># test native string converters enabled by setting an encoding</span>
        <span class="s1">utf8 = </span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span><span class="s1">.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">io.open(path</span><span class="s0">, </span><span class="s3">'wt'</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(utf8)</span>
            <span class="s1">x = self.loadfunc(path</span><span class="s0">, </span><span class="s1">dtype=np.unicode_</span><span class="s0">,</span>
                              <span class="s1">converters={</span><span class="s4">0</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">x: x + </span><span class="s3">'t'</span><span class="s1">}</span><span class="s0">,</span>
                              <span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
            <span class="s1">a = np.array([utf8 + </span><span class="s3">'t'</span><span class="s1">])</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s0">class </span><span class="s1">TestLoadTxt(LoadTxtBase):</span>
    <span class="s1">loadfunc = staticmethod(np.loadtxt)</span>

    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s5"># lower chunksize for testing</span>
        <span class="s1">self.orig_chunk = np.lib.npyio._loadtxt_chunksize</span>
        <span class="s1">np.lib.npyio._loadtxt_chunksize = </span><span class="s4">1</span>
    <span class="s0">def </span><span class="s1">teardown(self):</span>
        <span class="s1">np.lib.npyio._loadtxt_chunksize = self.orig_chunk</span>

    <span class="s0">def </span><span class="s1">test_record(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">np.int32)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">np.int32)])</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)])</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s1">d = TextIO()</span>
        <span class="s1">d.write(</span><span class="s3">'M 64.0 75.0</span><span class="s0">\n</span><span class="s3">F 25.0 60.0'</span><span class="s1">)</span>
        <span class="s1">d.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">mydescriptor = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'gender'</span><span class="s0">, </span><span class="s3">'age'</span><span class="s0">, </span><span class="s3">'weight'</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'S1'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s1">)}</span>
        <span class="s1">b = np.array([(</span><span class="s3">'M'</span><span class="s0">, </span><span class="s4">64.0</span><span class="s0">, </span><span class="s4">75.0</span><span class="s1">)</span><span class="s0">,</span>
                      <span class="s1">(</span><span class="s3">'F'</span><span class="s0">, </span><span class="s4">25.0</span><span class="s0">, </span><span class="s4">60.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=mydescriptor)</span>
        <span class="s1">y = np.loadtxt(d</span><span class="s0">, </span><span class="s1">dtype=mydescriptor)</span>
        <span class="s1">assert_array_equal(y</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">test_array(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4'</span><span class="s1">)</span>

        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=float)</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_1D(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1</span><span class="s0">\n</span><span class="s3">2</span><span class="s0">\n</span><span class="s3">3</span><span class="s0">\n</span><span class="s3">4</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1,2,3,4</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_missing(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1,2,3,,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">converters={</span><span class="s4">3</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s </span><span class="s0">or </span><span class="s1">- </span><span class="s4">999</span><span class="s1">)})</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_converters_with_usecols(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1,2,3,,5</span><span class="s0">\n</span><span class="s3">6,7,8,9,10</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">converters={</span><span class="s4">3</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s </span><span class="s0">or </span><span class="s1">- </span><span class="s4">999</span><span class="s1">)}</span><span class="s0">,</span>
                       <span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">a = np.array([[</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_comments_unicode(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'# comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">comments=</span><span class="s3">u'#'</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_comments_byte(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'# comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">comments=</span><span class="s6">b'#'</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_comments_multiple(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'# comment</span><span class="s0">\n</span><span class="s3">1,2,3</span><span class="s0">\n</span><span class="s3">@ comment2</span><span class="s0">\n</span><span class="s3">4,5,6 // comment3'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">comments=[</span><span class="s3">'#'</span><span class="s0">, </span><span class="s3">'@'</span><span class="s0">, </span><span class="s3">'//'</span><span class="s1">])</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_comments_multi_chars(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'/* comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">comments=</span><span class="s3">'/*'</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s5"># Check that '/*' is not transformed to ['/', '*']</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'*/ comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.loadtxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                      <span class="s1">comments=</span><span class="s3">'/*'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_skiprows(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">skiprows=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'# comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">skiprows=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_usecols(self):</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>

        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">:])</span>

        <span class="s5"># Testing with arrays instead of tuples.</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]))</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">:])</span>

        <span class="s5"># Testing with an integer instead of a sequence</span>
        <span class="s0">for </span><span class="s1">int_type </span><span class="s0">in </span><span class="s1">[int</span><span class="s0">, </span><span class="s1">np.int8</span><span class="s0">, </span><span class="s1">np.int16</span><span class="s0">,</span>
                         <span class="s1">np.int32</span><span class="s0">, </span><span class="s1">np.int64</span><span class="s0">, </span><span class="s1">np.uint8</span><span class="s0">, </span><span class="s1">np.uint16</span><span class="s0">,</span>
                         <span class="s1">np.uint32</span><span class="s0">, </span><span class="s1">np.uint64]:</span>
            <span class="s1">to_read = int_type(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=to_read)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>

        <span class="s5"># Testing with some crazy custom integer type</span>
        <span class="s0">class </span><span class="s1">CrazyInt:</span>
            <span class="s0">def </span><span class="s1">__index__(self):</span>
                <span class="s0">return </span><span class="s4">1</span>

        <span class="s1">crazy_int = CrazyInt()</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=crazy_int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>

        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=(crazy_int</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>

        <span class="s5"># Checking with dtypes defined converters.</span>
        <span class="s1">data = </span><span class="s3">'''JOE 70.1 25.3 
                BOB 60.5 27.9 
                '''</span>
        <span class="s1">c = TextIO(data)</span>
        <span class="s1">names = [</span><span class="s3">'stid'</span><span class="s0">, </span><span class="s3">'temp'</span><span class="s1">]</span>
        <span class="s1">dtypes = [</span><span class="s3">'S4'</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s1">]</span>
        <span class="s1">arr = np.loadtxt(c</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=list(zip(names</span><span class="s0">, </span><span class="s1">dtypes)))</span>
        <span class="s1">assert_equal(arr[</span><span class="s3">'stid'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b&quot;JOE&quot;</span><span class="s0">, </span><span class="s6">b&quot;BOB&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(arr[</span><span class="s3">'temp'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">25.3</span><span class="s0">, </span><span class="s4">27.9</span><span class="s1">])</span>

        <span class="s5"># Testing non-ints in usecols</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">bogus_idx = </span><span class="s4">1.5</span>
        <span class="s1">assert_raises_regex(</span>
            <span class="s1">TypeError</span><span class="s0">,</span>
            <span class="s3">'^usecols must be.*%s' </span><span class="s1">% type(bogus_idx)</span><span class="s0">,</span>
            <span class="s1">np.loadtxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">usecols=bogus_idx</span>
            <span class="s1">)</span>

        <span class="s1">assert_raises_regex(</span>
            <span class="s1">TypeError</span><span class="s0">,</span>
            <span class="s3">'^usecols must be.*%s' </span><span class="s1">% type(bogus_idx)</span><span class="s0">,</span>
            <span class="s1">np.loadtxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">bogus_idx</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_fancy_dtype(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1,2,3.0</span><span class="s0">\n</span><span class="s3">4,5,6.0</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s0">, </span><span class="s1">float)])])</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=dt</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6.0</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_shaped_dtype(self):</span>
        <span class="s1">c = TextIO(</span><span class="s3">&quot;aaaa  1.0  8.0  1 2 3 4 5 6&quot;</span><span class="s1">)</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'name'</span><span class="s0">, </span><span class="s3">'S4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">,</span>
                       <span class="s1">(</span><span class="s3">'block'</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))])</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">a = np.array([(</span><span class="s3">'aaaa'</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">8.0</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])]</span><span class="s0">,</span>
                     <span class="s1">dtype=dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_3d_shaped_dtype(self):</span>
        <span class="s1">c = TextIO(</span><span class="s3">&quot;aaaa  1.0  8.0  1 2 3 4 5 6 7 8 9 10 11 12&quot;</span><span class="s1">)</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'name'</span><span class="s0">, </span><span class="s3">'S4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">,</span>
                       <span class="s1">(</span><span class="s3">'block'</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))])</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">a = np.array([(</span><span class="s3">'aaaa'</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">8.0</span><span class="s0">,</span>
                       <span class="s1">[[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">]]])]</span><span class="s0">,</span>
                     <span class="s1">dtype=dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_str_dtype(self):</span>
        <span class="s5"># see gh-8033</span>
        <span class="s1">c = [</span><span class="s3">&quot;str1&quot;</span><span class="s0">, </span><span class="s3">&quot;str2&quot;</span><span class="s1">]</span>

        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">(str</span><span class="s0">, </span><span class="s1">np.bytes_):</span>
            <span class="s1">a = np.array([</span><span class="s3">&quot;str1&quot;</span><span class="s0">, </span><span class="s3">&quot;str2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
            <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_empty_file(self):</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(message=</span><span class="s3">&quot;loadtxt: Empty input file:&quot;</span><span class="s1">)</span>
            <span class="s1">c = TextIO()</span>
            <span class="s1">x = np.loadtxt(c)</span>
            <span class="s1">assert_equal(x.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s1">assert_equal(x.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s1">assert_(x.dtype == np.int64)</span>

    <span class="s0">def </span><span class="s1">test_unused_converter(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.writelines([</span><span class="s3">'1 21</span><span class="s0">\n</span><span class="s3">'</span><span class="s0">, </span><span class="s3">'3 42</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">])</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">data = np.loadtxt(c</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
                          <span class="s1">converters={</span><span class="s4">0</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)})</span>
        <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">[</span><span class="s4">21</span><span class="s0">, </span><span class="s4">42</span><span class="s1">])</span>

        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">data = np.loadtxt(c</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
                          <span class="s1">converters={</span><span class="s4">1</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)})</span>
        <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">[</span><span class="s4">33</span><span class="s0">, </span><span class="s4">66</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_dtype_with_object(self):</span>
        <span class="s5"># Test using an explicit dtype with an object</span>
        <span class="s1">data = </span><span class="s3">&quot;&quot;&quot; 1; 2001-01-01 
                   2; 2002-01-31 &quot;&quot;&quot;</span>
        <span class="s1">ndtype = [(</span><span class="s3">'idx'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'code'</span><span class="s0">, </span><span class="s1">object)]</span>
        <span class="s1">func = </span><span class="s0">lambda </span><span class="s1">s: strptime(s.strip()</span><span class="s0">, </span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s1">)</span>
        <span class="s1">converters = {</span><span class="s4">1</span><span class="s1">: func}</span>
        <span class="s1">test = np.loadtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;;&quot;</span><span class="s0">, </span><span class="s1">dtype=ndtype</span><span class="s0">,</span>
                          <span class="s1">converters=converters)</span>
        <span class="s1">control = np.array(</span>
            <span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2001</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2002</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">31</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">dtype=ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_uint64_type(self):</span>
        <span class="s1">tgt = (</span><span class="s4">9223372043271415339</span><span class="s0">, </span><span class="s4">9223372043271415853</span><span class="s1">)</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">&quot;%s %s&quot; </span><span class="s1">% tgt)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">res = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=np.uint64)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">tgt)</span>

    <span class="s0">def </span><span class="s1">test_int64_type(self):</span>
        <span class="s1">tgt = (-</span><span class="s4">9223372036854775807</span><span class="s0">, </span><span class="s4">9223372036854775807</span><span class="s1">)</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">&quot;%s %s&quot; </span><span class="s1">% tgt)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">res = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">tgt)</span>

    <span class="s0">def </span><span class="s1">test_from_float_hex(self):</span>
        <span class="s5"># IEEE doubles and floats only, otherwise the float32</span>
        <span class="s5"># conversion may fail.</span>
        <span class="s1">tgt = np.logspace(-</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">5</span><span class="s1">).astype(np.float32)</span>
        <span class="s1">tgt = np.hstack((tgt</span><span class="s0">, </span><span class="s1">-tgt)).astype(float)</span>
        <span class="s1">inp = </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">.join(map(float.hex</span><span class="s0">, </span><span class="s1">tgt))</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(inp)</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">[float</span><span class="s0">, </span><span class="s1">np.float32]:</span>
            <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">res = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">tgt</span><span class="s0">, </span><span class="s1">err_msg=</span><span class="s3">&quot;%s&quot; </span><span class="s1">% dt)</span>

    <span class="s0">def </span><span class="s1">test_default_float_converter_no_default_hex_conversion(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Ensure that fromhex is only used for values with the correct prefix and 
        is not called by default. Regression test related to gh-19598. 
        &quot;&quot;&quot;</span>
        <span class="s1">c = TextIO(</span><span class="s3">&quot;a b c&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;could not convert string to float&quot;</span>
        <span class="s1">):</span>
            <span class="s1">np.loadtxt(c)</span>

    <span class="s0">def </span><span class="s1">test_default_float_converter_exception(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Ensure that the exception message raised during failed floating point 
        conversion is correct. Regression test related to gh-19598. 
        &quot;&quot;&quot;</span>
        <span class="s1">c = TextIO(</span><span class="s3">&quot;qrs tuv&quot;</span><span class="s1">)  </span><span class="s5"># Invalid values for default float converter</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;could not convert string to float&quot;</span>
        <span class="s1">):</span>
            <span class="s1">np.loadtxt(c)</span>

    <span class="s0">def </span><span class="s1">test_from_complex(self):</span>
        <span class="s1">tgt = (complex(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">complex(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">&quot;%s %s&quot; </span><span class="s1">% tgt)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">res = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=complex)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">tgt)</span>

    <span class="s0">def </span><span class="s1">test_complex_misformatted(self):</span>
        <span class="s5"># test for backward compatibility</span>
        <span class="s5"># some complex formats used to generate x+-yj</span>
        <span class="s1">a = np.zeros((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.complex128)</span>
        <span class="s1">re = np.pi</span>
        <span class="s1">im = np.e</span>
        <span class="s1">a[:] = re - </span><span class="s4">1.0j </span><span class="s1">* im</span>
        <span class="s1">c = BytesIO()</span>
        <span class="s1">np.savetxt(c</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'%.16e'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">txt = c.read()</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s5"># misformat the sign on the imaginary part, gh 7895</span>
        <span class="s1">txt_bad = txt.replace(</span><span class="s6">b'e+00-'</span><span class="s0">, </span><span class="s6">b'e00+-'</span><span class="s1">)</span>
        <span class="s1">assert_(txt_bad != txt)</span>
        <span class="s1">c.write(txt_bad)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">res = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=complex)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_universal_newline(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">name:</span>
            <span class="s0">with </span><span class="s1">open(name</span><span class="s0">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s3">'1 21</span><span class="s0">\r</span><span class="s3">3 42</span><span class="s0">\r</span><span class="s3">'</span><span class="s1">)</span>
            <span class="s1">data = np.loadtxt(name)</span>
        <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">21</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">42</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_empty_field_after_tab(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1 </span><span class="s0">\t</span><span class="s3">2 </span><span class="s0">\t</span><span class="s3">3</span><span class="s0">\t</span><span class="s3">start </span><span class="s0">\n</span><span class="s3">4</span><span class="s0">\t</span><span class="s3">5</span><span class="s0">\t</span><span class="s3">6</span><span class="s0">\t  \n</span><span class="s3">7</span><span class="s0">\t</span><span class="s3">8</span><span class="s0">\t</span><span class="s3">9.5</span><span class="s0">\t</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">dt = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'z'</span><span class="s0">, </span><span class="s3">'comment'</span><span class="s1">)</span><span class="s0">,</span>
              <span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'&lt;i4'</span><span class="s0">, </span><span class="s3">'&lt;i4'</span><span class="s0">, </span><span class="s3">'&lt;f4'</span><span class="s0">, </span><span class="s3">'|S8'</span><span class="s1">)}</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=dt</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">'</span><span class="s0">\t</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s6">b'start '</span><span class="s0">, </span><span class="s6">b'  '</span><span class="s0">, </span><span class="s6">b''</span><span class="s1">])</span>
        <span class="s1">assert_array_equal(x[</span><span class="s3">'comment'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_unpack_structured(self):</span>
        <span class="s1">txt = TextIO(</span><span class="s3">&quot;M 21 72</span><span class="s0">\n</span><span class="s3">F 35 58&quot;</span><span class="s1">)</span>
        <span class="s1">dt = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">)</span><span class="s0">, </span><span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'|S1'</span><span class="s0">, </span><span class="s3">'&lt;i4'</span><span class="s0">, </span><span class="s3">'&lt;f4'</span><span class="s1">)}</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c = np.loadtxt(txt</span><span class="s0">, </span><span class="s1">dtype=dt</span><span class="s0">, </span><span class="s1">unpack=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_(a.dtype.str == </span><span class="s3">'|S1'</span><span class="s1">)</span>
        <span class="s1">assert_(b.dtype.str == </span><span class="s3">'&lt;i4'</span><span class="s1">)</span>
        <span class="s1">assert_(c.dtype.str == </span><span class="s3">'&lt;f4'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s6">b'M'</span><span class="s0">, </span><span class="s6">b'F'</span><span class="s1">]))</span>
        <span class="s1">assert_array_equal(b</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">21</span><span class="s0">, </span><span class="s4">35</span><span class="s1">]))</span>
        <span class="s1">assert_array_equal(c</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">72.</span><span class="s0">,  </span><span class="s4">58.</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_ndmin_keyword(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1,2,3</span><span class="s0">\n</span><span class="s3">4,5,6'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.loadtxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.loadtxt</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">1.5</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s1">d = TextIO()</span>
        <span class="s1">d.write(</span><span class="s3">'0,1,2'</span><span class="s1">)</span>
        <span class="s1">d.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(d</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">assert_(x.shape == (</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">d.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(d</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">assert_(x.shape == (</span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">d.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(d</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_(x.shape == (</span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>

        <span class="s1">e = TextIO()</span>
        <span class="s1">e.write(</span><span class="s3">'0</span><span class="s0">\n</span><span class="s3">1</span><span class="s0">\n</span><span class="s3">2'</span><span class="s1">)</span>
        <span class="s1">e.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(e</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">assert_(x.shape == (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">e.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(e</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">assert_(x.shape == (</span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">e.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(e</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_(x.shape == (</span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>

        <span class="s5"># Test ndmin kw with empty file.</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(message=</span><span class="s3">&quot;loadtxt: Empty input file:&quot;</span><span class="s1">)</span>
            <span class="s1">f = TextIO()</span>
            <span class="s1">assert_(np.loadtxt(f</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">2</span><span class="s1">).shape == (</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s1">assert_(np.loadtxt(f</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s4">1</span><span class="s1">).shape == (</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_generator_source(self):</span>
        <span class="s0">def </span><span class="s1">count():</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">10</span><span class="s1">):</span>
                <span class="s0">yield </span><span class="s3">&quot;%d&quot; </span><span class="s1">% i</span>

        <span class="s1">res = np.loadtxt(count())</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">10</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_bad_line(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1 2 3</span><span class="s0">\n</span><span class="s3">4 5 6</span><span class="s0">\n</span><span class="s3">2 3'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>

        <span class="s5"># Check for exception and that exception contains line number</span>
        <span class="s1">assert_raises_regex(ValueError</span><span class="s0">, </span><span class="s3">&quot;3&quot;</span><span class="s0">, </span><span class="s1">np.loadtxt</span><span class="s0">, </span><span class="s1">c)</span>

    <span class="s0">def </span><span class="s1">test_none_as_string(self):</span>
        <span class="s5"># gh-5155, None should work as string when format demands it</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'100,foo,200</span><span class="s0">\n</span><span class="s3">300,None,400'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">np.loadtxt(c</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">dtype=dt</span><span class="s0">, </span><span class="s1">comments=</span><span class="s0">None</span><span class="s1">)  </span><span class="s5"># Should succeed</span>

    <span class="s1">@pytest.mark.skipif(locale.getpreferredencoding() == </span><span class="s3">'ANSI_X3.4-1968'</span><span class="s0">,</span>
                        <span class="s1">reason=</span><span class="s3">&quot;Wrong preferred encoding&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_binary_load(self):</span>
        <span class="s1">butf8 = </span><span class="s6">b&quot;5,6,7,</span><span class="s0">\xc3\x95</span><span class="s6">scarscar</span><span class="s0">\n\r</span><span class="s6">15,2,3,hello</span><span class="s0">\n\r</span><span class="s6">&quot;</span><span class="s1">\</span>
                <span class="s6">b&quot;20,2,3,</span><span class="s0">\xc3\x95</span><span class="s6">scar</span><span class="s0">\n\r</span><span class="s6">&quot;</span>
        <span class="s1">sutf8 = butf8.decode(</span><span class="s3">&quot;UTF-8&quot;</span><span class="s1">).replace(</span><span class="s3">&quot;</span><span class="s0">\r</span><span class="s3">&quot;</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">).splitlines()</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(butf8)</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">x = np.loadtxt(f</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;UTF-8&quot;</span><span class="s0">, </span><span class="s1">dtype=np.unicode_)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">sutf8)</span>
            <span class="s5"># test broken latin1 conversion people now rely on</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">x = np.loadtxt(f</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;UTF-8&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;S&quot;</span><span class="s1">)</span>
            <span class="s1">x = [</span><span class="s6">b'5,6,7,</span><span class="s0">\xc3\x95</span><span class="s6">scarscar'</span><span class="s0">, </span><span class="s6">b'15,2,3,hello'</span><span class="s0">, </span><span class="s6">b'20,2,3,</span><span class="s0">\xc3\x95</span><span class="s6">scar'</span><span class="s1">]</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">np.array(x</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;S&quot;</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_max_rows(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1,2,3,5</span><span class="s0">\n</span><span class="s3">4,5,7,8</span><span class="s0">\n</span><span class="s3">2,1,4,5'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">max_rows=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_max_rows_with_skiprows(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'comments</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">4,5,7,8</span><span class="s0">\n</span><span class="s3">2,1,4,5'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">skiprows=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">4,5,7,8</span><span class="s0">\n</span><span class="s3">2,1,4,5'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">skiprows=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_max_rows_with_read_continuation(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1,2,3,5</span><span class="s0">\n</span><span class="s3">4,5,7,8</span><span class="s0">\n</span><span class="s3">2,1,4,5'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">max_rows=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s5"># test continuation</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s1">a = np.array([</span><span class="s4">2</span><span class="s0">,</span><span class="s4">1</span><span class="s0">,</span><span class="s4">4</span><span class="s0">,</span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_max_rows_larger(self):</span>
        <span class="s5">#test max_rows &gt; num rows</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">4,5,7,8</span><span class="s0">\n</span><span class="s3">2,1,4,5'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">x = np.loadtxt(c</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                       <span class="s1">skiprows=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">6</span><span class="s1">)</span>
        <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s0">class </span><span class="s1">Testfromregex:</span>
    <span class="s0">def </span><span class="s1">test_record(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1.312 foo</span><span class="s0">\n</span><span class="s3">1.534 bar</span><span class="s0">\n</span><span class="s3">4.444 qux'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>

        <span class="s1">dt = [(</span><span class="s3">'num'</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'val'</span><span class="s0">, </span><span class="s3">'S3'</span><span class="s1">)]</span>
        <span class="s1">x = np.fromregex(c</span><span class="s0">, </span><span class="s3">r&quot;([0-9.]+)\s+(...)&quot;</span><span class="s0">, </span><span class="s1">dt)</span>
        <span class="s1">a = np.array([(</span><span class="s4">1.312</span><span class="s0">, </span><span class="s3">'foo'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1.534</span><span class="s0">, </span><span class="s3">'bar'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4.444</span><span class="s0">, </span><span class="s3">'qux'</span><span class="s1">)]</span><span class="s0">,</span>
                     <span class="s1">dtype=dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_record_2(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1312 foo</span><span class="s0">\n</span><span class="s3">1534 bar</span><span class="s0">\n</span><span class="s3">4444 qux'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>

        <span class="s1">dt = [(</span><span class="s3">'num'</span><span class="s0">, </span><span class="s1">np.int32)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'val'</span><span class="s0">, </span><span class="s3">'S3'</span><span class="s1">)]</span>
        <span class="s1">x = np.fromregex(c</span><span class="s0">, </span><span class="s3">r&quot;(\d+)\s+(...)&quot;</span><span class="s0">, </span><span class="s1">dt)</span>
        <span class="s1">a = np.array([(</span><span class="s4">1312</span><span class="s0">, </span><span class="s3">'foo'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1534</span><span class="s0">, </span><span class="s3">'bar'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4444</span><span class="s0">, </span><span class="s3">'qux'</span><span class="s1">)]</span><span class="s0">,</span>
                     <span class="s1">dtype=dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_record_3(self):</span>
        <span class="s1">c = TextIO()</span>
        <span class="s1">c.write(</span><span class="s3">'1312 foo</span><span class="s0">\n</span><span class="s3">1534 bar</span><span class="s0">\n</span><span class="s3">4444 qux'</span><span class="s1">)</span>
        <span class="s1">c.seek(</span><span class="s4">0</span><span class="s1">)</span>

        <span class="s1">dt = [(</span><span class="s3">'num'</span><span class="s0">, </span><span class="s1">np.float64)]</span>
        <span class="s1">x = np.fromregex(c</span><span class="s0">, </span><span class="s3">r&quot;(\d+)\s+...&quot;</span><span class="s0">, </span><span class="s1">dt)</span>
        <span class="s1">a = np.array([(</span><span class="s4">1312</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1534</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4444</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;path_type&quot;</span><span class="s0">, </span><span class="s1">[str</span><span class="s0">, </span><span class="s1">Path])</span>
    <span class="s0">def </span><span class="s1">test_record_unicode(self</span><span class="s0">, </span><span class="s1">path_type):</span>
        <span class="s1">utf8 = </span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">str_path:</span>
            <span class="s1">path = path_type(str_path)</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">'wb'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s6">b'1.312 foo' </span><span class="s1">+ utf8 + </span><span class="s6">b' </span><span class="s0">\n</span><span class="s6">1.534 bar</span><span class="s0">\n</span><span class="s6">4.444 qux'</span><span class="s1">)</span>

            <span class="s1">dt = [(</span><span class="s3">'num'</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'val'</span><span class="s0">, </span><span class="s3">'U4'</span><span class="s1">)]</span>
            <span class="s1">x = np.fromregex(path</span><span class="s0">, </span><span class="s3">r&quot;(?u)([0-9.]+)\s+(\w+)&quot;</span><span class="s0">, </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
            <span class="s1">a = np.array([(</span><span class="s4">1.312</span><span class="s0">, </span><span class="s3">'foo' </span><span class="s1">+ utf8.decode(</span><span class="s3">'UTF-8'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1.534</span><span class="s0">, </span><span class="s3">'bar'</span><span class="s1">)</span><span class="s0">,</span>
                           <span class="s1">(</span><span class="s4">4.444</span><span class="s0">, </span><span class="s3">'qux'</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

            <span class="s1">regexp = re.compile(</span><span class="s3">r&quot;([0-9.]+)\s+(\w+)&quot;</span><span class="s0">, </span><span class="s1">re.UNICODE)</span>
            <span class="s1">x = np.fromregex(path</span><span class="s0">, </span><span class="s1">regexp</span><span class="s0">, </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_compiled_bytes(self):</span>
        <span class="s1">regexp = re.compile(</span><span class="s6">b'(</span><span class="s0">\\</span><span class="s6">d)'</span><span class="s1">)</span>
        <span class="s1">c = BytesIO(</span><span class="s6">b'123'</span><span class="s1">)</span>
        <span class="s1">dt = [(</span><span class="s3">'num'</span><span class="s0">, </span><span class="s1">np.float64)]</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">x = np.fromregex(c</span><span class="s0">, </span><span class="s1">regexp</span><span class="s0">, </span><span class="s1">dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_bad_dtype_not_structured(self):</span>
        <span class="s1">regexp = re.compile(</span><span class="s6">b'(</span><span class="s0">\\</span><span class="s6">d)'</span><span class="s1">)</span>
        <span class="s1">c = BytesIO(</span><span class="s6">b'123'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">'structured datatype'</span><span class="s1">):</span>
            <span class="s1">np.fromregex(c</span><span class="s0">, </span><span class="s1">regexp</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>


<span class="s5">#####--------------------------------------------------------------------------</span>


<span class="s0">class </span><span class="s1">TestFromTxt(LoadTxtBase):</span>
    <span class="s1">loadfunc = staticmethod(np.genfromtxt)</span>

    <span class="s0">def </span><span class="s1">test_record(self):</span>
        <span class="s5"># Test w/ explicit dtype</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">np.int32)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">np.int32)])</span>
        <span class="s1">control = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'M 64.0 75.0</span><span class="s0">\n</span><span class="s3">F 25.0 60.0'</span><span class="s1">)</span>
        <span class="s1">descriptor = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'gender'</span><span class="s0">, </span><span class="s3">'age'</span><span class="s0">, </span><span class="s3">'weight'</span><span class="s1">)</span><span class="s0">,</span>
                      <span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'S1'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s1">)}</span>
        <span class="s1">control = np.array([(</span><span class="s3">'M'</span><span class="s0">, </span><span class="s4">64.0</span><span class="s0">, </span><span class="s4">75.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'F'</span><span class="s0">, </span><span class="s4">25.0</span><span class="s0">, </span><span class="s4">60.0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=descriptor)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=descriptor)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_array(self):</span>
        <span class="s5"># Test outputting a standard ndarray</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4'</span><span class="s1">)</span>
        <span class="s1">control = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">assert_array_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">data.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">control = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=float)</span>
        <span class="s1">test = np.loadtxt(data</span><span class="s0">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_array_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_1D(self):</span>
        <span class="s5"># Test squeezing to 1D</span>
        <span class="s1">control = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1</span><span class="s0">\n</span><span class="s3">2</span><span class="s0">\n</span><span class="s3">3</span><span class="s0">\n</span><span class="s3">4</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">assert_array_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1,2,3,4</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_comments(self):</span>
        <span class="s5"># Test the stripping of comments</span>
        <span class="s1">control = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s5"># Comment on its own line</span>
        <span class="s1">data = TextIO(</span><span class="s3">'# comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">comments=</span><span class="s3">'#'</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5"># Comment at the end of a line</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1,2,3,5# comment</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">comments=</span><span class="s3">'#'</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_skiprows(self):</span>
        <span class="s5"># Test row skipping</span>
        <span class="s1">control = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">kwargs = dict(dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">skip_header=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'# comment</span><span class="s0">\n</span><span class="s3">1,2,3,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.loadtxt(data</span><span class="s0">, </span><span class="s1">skiprows=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_skip_footer(self):</span>
        <span class="s1">data = [</span><span class="s3">&quot;# %i&quot; </span><span class="s1">% i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span>
        <span class="s1">data.append(</span><span class="s3">&quot;A, B, C&quot;</span><span class="s1">)</span>
        <span class="s1">data.extend([</span><span class="s3">&quot;%i,%3.1f,%03s&quot; </span><span class="s1">% (i</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">51</span><span class="s1">)])</span>
        <span class="s1">data[-</span><span class="s4">1</span><span class="s1">] = </span><span class="s3">&quot;99,99&quot;</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">skip_header=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">skip_footer=</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(TextIO(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">.join(data))</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s3">&quot;%f&quot; </span><span class="s1">% i</span><span class="s0">, </span><span class="s3">&quot;%f&quot; </span><span class="s1">% i</span><span class="s0">, </span><span class="s3">&quot;%f&quot; </span><span class="s1">% i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">41</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">&quot;ABC&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_skip_footer_with_invalid(self):</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(ConversionWarning)</span>
            <span class="s1">basestr = </span><span class="s3">'1 1</span><span class="s0">\n</span><span class="s3">2 2</span><span class="s0">\n</span><span class="s3">3 3</span><span class="s0">\n</span><span class="s3">4 4</span><span class="s0">\n</span><span class="s3">5  </span><span class="s0">\n</span><span class="s3">6  </span><span class="s0">\n</span><span class="s3">7  </span><span class="s0">\n</span><span class="s3">'</span>
            <span class="s5"># Footer too small to get rid of all invalid values</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.genfromtxt</span><span class="s0">,</span>
                          <span class="s1">TextIO(basestr)</span><span class="s0">, </span><span class="s1">skip_footer=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s5">#        except ValueError:</span>
    <span class="s5">#            pass</span>
            <span class="s1">a = np.genfromtxt(</span>
                <span class="s1">TextIO(basestr)</span><span class="s0">, </span><span class="s1">skip_footer=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">invalid_raise=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]]))</span>
            <span class="s5">#</span>
            <span class="s1">a = np.genfromtxt(TextIO(basestr)</span><span class="s0">, </span><span class="s1">skip_footer=</span><span class="s4">3</span><span class="s1">)</span>
            <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]]))</span>
            <span class="s5">#</span>
            <span class="s1">basestr = </span><span class="s3">'1 1</span><span class="s0">\n</span><span class="s3">2  </span><span class="s0">\n</span><span class="s3">3 3</span><span class="s0">\n</span><span class="s3">4 4</span><span class="s0">\n</span><span class="s3">5  </span><span class="s0">\n</span><span class="s3">6 6</span><span class="s0">\n</span><span class="s3">7 7</span><span class="s0">\n</span><span class="s3">'</span>
            <span class="s1">a = np.genfromtxt(</span>
                <span class="s1">TextIO(basestr)</span><span class="s0">, </span><span class="s1">skip_footer=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">invalid_raise=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6.</span><span class="s0">, </span><span class="s4">6.</span><span class="s1">]]))</span>
            <span class="s1">a = np.genfromtxt(</span>
                <span class="s1">TextIO(basestr)</span><span class="s0">, </span><span class="s1">skip_footer=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">invalid_raise=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]]))</span>

    <span class="s0">def </span><span class="s1">test_header(self):</span>
        <span class="s5"># Test retrieving a header</span>
        <span class="s1">data = TextIO(</span><span class="s3">'gender age weight</span><span class="s0">\n</span><span class="s3">M 64.0 75.0</span><span class="s0">\n</span><span class="s3">F 25.0 60.0'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">control = {</span><span class="s3">'gender'</span><span class="s1">: np.array([</span><span class="s6">b'M'</span><span class="s0">, </span><span class="s6">b'F'</span><span class="s1">])</span><span class="s0">,</span>
                   <span class="s3">'age'</span><span class="s1">: np.array([</span><span class="s4">64.0</span><span class="s0">, </span><span class="s4">25.0</span><span class="s1">])</span><span class="s0">,</span>
                   <span class="s3">'weight'</span><span class="s1">: np.array([</span><span class="s4">75.0</span><span class="s0">, </span><span class="s4">60.0</span><span class="s1">])}</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'gender'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">control[</span><span class="s3">'gender'</span><span class="s1">])</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'age'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">control[</span><span class="s3">'age'</span><span class="s1">])</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'weight'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">control[</span><span class="s3">'weight'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_auto_dtype(self):</span>
        <span class="s5"># Test the automatic definition of the output dtype</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A 64 75.0 3+4j True</span><span class="s0">\n</span><span class="s3">BCD 25 60.0 5+6j False'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">control = [np.array([</span><span class="s6">b'A'</span><span class="s0">, </span><span class="s6">b'BCD'</span><span class="s1">])</span><span class="s0">,</span>
                   <span class="s1">np.array([</span><span class="s4">64</span><span class="s0">, </span><span class="s4">25</span><span class="s1">])</span><span class="s0">,</span>
                   <span class="s1">np.array([</span><span class="s4">75.0</span><span class="s0">, </span><span class="s4">60.0</span><span class="s1">])</span><span class="s0">,</span>
                   <span class="s1">np.array([</span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">4j</span><span class="s0">, </span><span class="s4">5 </span><span class="s1">+ </span><span class="s4">6j</span><span class="s1">])</span><span class="s0">,</span>
                   <span class="s1">np.array([</span><span class="s0">True, False</span><span class="s1">])</span><span class="s0">, </span><span class="s1">]</span>
        <span class="s1">assert_equal(test.dtype.names</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'f1'</span><span class="s0">, </span><span class="s3">'f2'</span><span class="s0">, </span><span class="s3">'f3'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s1">])</span>
        <span class="s0">for </span><span class="s1">(i</span><span class="s0">, </span><span class="s1">ctrl) </span><span class="s0">in </span><span class="s1">enumerate(control):</span>
            <span class="s1">assert_equal(test[</span><span class="s3">'f%i' </span><span class="s1">% i]</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_auto_dtype_uniform(self):</span>
        <span class="s5"># Tests whether the output dtype can be uniformized</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1 2 3 4</span><span class="s0">\n</span><span class="s3">5 6 7 8</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">control = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_fancy_dtype(self):</span>
        <span class="s5"># Check that a nested dtype isn't MIA</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1,2,3.0</span><span class="s0">\n</span><span class="s3">4,5,6.0</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">fancydtype = np.dtype([(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s0">, </span><span class="s1">float)])])</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=fancydtype</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6.0</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">dtype=fancydtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_names_overwrite(self):</span>
        <span class="s5"># Test overwriting the names of the dtype</span>
        <span class="s1">descriptor = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'g'</span><span class="s0">, </span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'w'</span><span class="s1">)</span><span class="s0">,</span>
                      <span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'S1'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s1">)}</span>
        <span class="s1">data = TextIO(</span><span class="s6">b'M 64.0 75.0</span><span class="s0">\n</span><span class="s6">F 25.0 60.0'</span><span class="s1">)</span>
        <span class="s1">names = (</span><span class="s3">'gender'</span><span class="s0">, </span><span class="s3">'age'</span><span class="s0">, </span><span class="s3">'weight'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=descriptor</span><span class="s0">, </span><span class="s1">names=names)</span>
        <span class="s1">descriptor[</span><span class="s3">'names'</span><span class="s1">] = names</span>
        <span class="s1">control = np.array([(</span><span class="s3">'M'</span><span class="s0">, </span><span class="s4">64.0</span><span class="s0">, </span><span class="s4">75.0</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">'F'</span><span class="s0">, </span><span class="s4">25.0</span><span class="s0">, </span><span class="s4">60.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=descriptor)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_commented_header(self):</span>
        <span class="s5"># Check that names can be retrieved even if the line is commented out.</span>
        <span class="s1">data = TextIO(</span><span class="s3">&quot;&quot;&quot; 
#gender age weight 
M   21  72.100000 
F   35  58.330000 
M   33  21.99 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s5"># The # is part of the first name and should be deleted automatically.</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s3">'M'</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">72.1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'F'</span><span class="s0">, </span><span class="s4">35</span><span class="s0">, </span><span class="s4">58.33</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'M'</span><span class="s0">, </span><span class="s4">33</span><span class="s0">, </span><span class="s4">21.99</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">'gender'</span><span class="s0">, </span><span class="s3">'|S1'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'age'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'weight'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5"># Ditto, but we should get rid of the first element</span>
        <span class="s1">data = TextIO(</span><span class="s6">b&quot;&quot;&quot; 
# gender age weight 
M   21  72.100000 
F   35  58.330000 
M   33  21.99 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_names_and_comments_none(self):</span>
        <span class="s5"># Tests case when names is true but comments is None (gh-10780)</span>
        <span class="s1">data = TextIO(</span><span class="s3">'col1 col2</span><span class="s0">\n </span><span class="s3">1 2</span><span class="s0">\n </span><span class="s3">3 4'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=(int</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">comments=</span><span class="s0">None, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'col1'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'col2'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_file_is_closed_on_error(self):</span>
        <span class="s5"># gh-13200</span>
        <span class="s0">with </span><span class="s1">tempdir() </span><span class="s0">as </span><span class="s1">tmpdir:</span>
            <span class="s1">fpath = os.path.join(tmpdir</span><span class="s0">, </span><span class="s3">&quot;test.csv&quot;</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">open(fpath</span><span class="s0">, </span><span class="s3">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s3">u'</span><span class="s0">\N{GREEK PI SYMBOL}</span><span class="s3">'</span><span class="s1">.encode(</span><span class="s3">'utf8'</span><span class="s1">))</span>

            <span class="s5"># ResourceWarnings are emitted from a destructor, so won't be</span>
            <span class="s5"># detected by regular propagation to errors.</span>
            <span class="s0">with </span><span class="s1">assert_no_warnings():</span>
                <span class="s0">with </span><span class="s1">pytest.raises(UnicodeDecodeError):</span>
                    <span class="s1">np.genfromtxt(fpath</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_autonames_and_usecols(self):</span>
        <span class="s5"># Tests names and usecols</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A B C D</span><span class="s0">\n </span><span class="s3">aaaa 121 45 9.1'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s0">, </span><span class="s3">'D'</span><span class="s1">)</span><span class="s0">,</span>
                                <span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">control = np.array((</span><span class="s3">'aaaa'</span><span class="s0">, </span><span class="s4">45</span><span class="s0">, </span><span class="s4">9.1</span><span class="s1">)</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'|S4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'C'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'D'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_converters_with_usecols(self):</span>
        <span class="s5"># Test the combination user-defined converters and usecol</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1,2,3,,5</span><span class="s0">\n</span><span class="s3">6,7,8,9,10</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                            <span class="s1">converters={</span><span class="s4">3</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s </span><span class="s0">or </span><span class="s1">- </span><span class="s4">999</span><span class="s1">)}</span><span class="s0">,</span>
                            <span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">control = np.array([[</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_converters_with_usecols_and_names(self):</span>
        <span class="s5"># Tests names and usecols</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A B C D</span><span class="s0">\n </span><span class="s3">aaaa 121 45 9.1'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s0">, </span><span class="s3">'D'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True,</span>
                                <span class="s1">dtype=</span><span class="s0">None,</span>
                                <span class="s1">converters={</span><span class="s3">'C'</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: </span><span class="s4">2 </span><span class="s1">* int(s)})</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">control = np.array((</span><span class="s3">'aaaa'</span><span class="s0">, </span><span class="s4">90</span><span class="s0">, </span><span class="s4">9.1</span><span class="s1">)</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'|S4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'C'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'D'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_converters_cornercases(self):</span>
        <span class="s5"># Test the conversion to datetime.</span>
        <span class="s1">converter = {</span>
            <span class="s3">'date'</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: strptime(s</span><span class="s0">, </span><span class="s3">'%Y-%m-%d %H:%M:%SZ'</span><span class="s1">)}</span>
        <span class="s1">data = TextIO(</span><span class="s3">'2009-02-03 12:00:00Z, 72214.0'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None,</span>
                            <span class="s1">names=[</span><span class="s3">'date'</span><span class="s0">, </span><span class="s3">'stid'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">converters=converter)</span>
        <span class="s1">control = np.array((datetime(</span><span class="s4">2009</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s4">72214.</span><span class="s1">)</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'date'</span><span class="s0">, </span><span class="s1">np.object_)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'stid'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_converters_cornercases2(self):</span>
        <span class="s5"># Test the conversion to datetime64.</span>
        <span class="s1">converter = {</span>
            <span class="s3">'date'</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: np.datetime64(strptime(s</span><span class="s0">, </span><span class="s3">'%Y-%m-%d %H:%M:%SZ'</span><span class="s1">))}</span>
        <span class="s1">data = TextIO(</span><span class="s3">'2009-02-03 12:00:00Z, 72214.0'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None,</span>
                            <span class="s1">names=[</span><span class="s3">'date'</span><span class="s0">, </span><span class="s3">'stid'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">converters=converter)</span>
        <span class="s1">control = np.array((datetime(</span><span class="s4">2009</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s4">72214.</span><span class="s1">)</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'date'</span><span class="s0">, </span><span class="s3">'datetime64[us]'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'stid'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_unused_converter(self):</span>
        <span class="s5"># Test whether unused converters are forgotten</span>
        <span class="s1">data = TextIO(</span><span class="s3">&quot;1 21</span><span class="s0">\n  </span><span class="s3">3 42</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">converters={</span><span class="s4">0</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)})</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">[</span><span class="s4">21</span><span class="s0">, </span><span class="s4">42</span><span class="s1">])</span>
        <span class="s5">#</span>
        <span class="s1">data.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">converters={</span><span class="s4">1</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)})</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">[</span><span class="s4">33</span><span class="s0">, </span><span class="s4">66</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_invalid_converter(self):</span>
        <span class="s1">strip_rand = </span><span class="s0">lambda </span><span class="s1">x: float((</span><span class="s6">b'r' </span><span class="s0">in </span><span class="s1">x.lower() </span><span class="s0">and </span><span class="s1">x.split()[-</span><span class="s4">1</span><span class="s1">]) </span><span class="s0">or</span>
                                     <span class="s1">(</span><span class="s6">b'r' </span><span class="s0">not in </span><span class="s1">x.lower() </span><span class="s0">and </span><span class="s1">x.strip() </span><span class="s0">or </span><span class="s4">0.0</span><span class="s1">))</span>
        <span class="s1">strip_per = </span><span class="s0">lambda </span><span class="s1">x: float((</span><span class="s6">b'%' </span><span class="s0">in </span><span class="s1">x.lower() </span><span class="s0">and </span><span class="s1">x.split()[</span><span class="s4">0</span><span class="s1">]) </span><span class="s0">or</span>
                                    <span class="s1">(</span><span class="s6">b'%' </span><span class="s0">not in </span><span class="s1">x.lower() </span><span class="s0">and </span><span class="s1">x.strip() </span><span class="s0">or </span><span class="s4">0.0</span><span class="s1">))</span>
        <span class="s1">s = TextIO(</span><span class="s3">&quot;D01N01,10/1/2003 ,1 %,R 75,400,600</span><span class="s0">\r\n</span><span class="s3">&quot;</span>
                   <span class="s3">&quot;L24U05,12/5/2003, 2 %,1,300, 150.5</span><span class="s0">\r\n</span><span class="s3">&quot;</span>
                   <span class="s3">&quot;D02N03,10/10/2004,R 1,,7,145.55&quot;</span><span class="s1">)</span>
        <span class="s1">kwargs = dict(</span>
            <span class="s1">converters={</span><span class="s4">2</span><span class="s1">: strip_per</span><span class="s0">, </span><span class="s4">3</span><span class="s1">: strip_rand}</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">,</span>
            <span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">assert_raises(ConverterError</span><span class="s0">, </span><span class="s1">np.genfromtxt</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">def </span><span class="s1">test_tricky_converter_bug1666(self):</span>
        <span class="s5"># Test some corner cases</span>
        <span class="s1">s = TextIO(</span><span class="s3">'q1,2</span><span class="s0">\n</span><span class="s3">q3,4'</span><span class="s1">)</span>
        <span class="s1">cnv = </span><span class="s0">lambda </span><span class="s1">s: float(s[</span><span class="s4">1</span><span class="s1">:])</span>
        <span class="s1">test = np.genfromtxt(s</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">converters={</span><span class="s4">0</span><span class="s1">: cnv})</span>
        <span class="s1">control = np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_dtype_with_converters(self):</span>
        <span class="s1">dstr = </span><span class="s3">&quot;2009; 23; 46&quot;</span>
        <span class="s1">test = np.genfromtxt(TextIO(dstr</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">delimiter=</span><span class="s3">&quot;;&quot;</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">converters={</span><span class="s4">0</span><span class="s1">: bytes})</span>
        <span class="s1">control = np.array([(</span><span class="s3">'2009'</span><span class="s0">, </span><span class="s4">23.</span><span class="s0">, </span><span class="s4">46</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'|S4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f1'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f2'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">test = np.genfromtxt(TextIO(dstr</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">delimiter=</span><span class="s3">&quot;;&quot;</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">converters={</span><span class="s4">0</span><span class="s1">: float})</span>
        <span class="s1">control = np.array([</span><span class="s4">2009.</span><span class="s0">, </span><span class="s4">23.</span><span class="s0">, </span><span class="s4">46</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_dtype_with_converters_and_usecols(self):</span>
        <span class="s1">dstr = </span><span class="s3">&quot;1,5,-1,1:1</span><span class="s0">\n</span><span class="s3">2,8,-1,1:n</span><span class="s0">\n</span><span class="s3">3,3,-2,m:n</span><span class="s0">\n</span><span class="s3">&quot;</span>
        <span class="s1">dmap = {</span><span class="s3">'1:1'</span><span class="s1">:</span><span class="s4">0</span><span class="s0">, </span><span class="s3">'1:n'</span><span class="s1">:</span><span class="s4">1</span><span class="s0">, </span><span class="s3">'m:1'</span><span class="s1">:</span><span class="s4">2</span><span class="s0">, </span><span class="s3">'m:n'</span><span class="s1">:</span><span class="s4">3</span><span class="s1">}</span>
        <span class="s1">dtyp = [(</span><span class="s3">'e1'</span><span class="s0">,</span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s3">'e2'</span><span class="s0">,</span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s3">'e3'</span><span class="s0">,</span><span class="s3">'i2'</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s3">'n'</span><span class="s0">, </span><span class="s3">'i1'</span><span class="s1">)]</span>
        <span class="s1">conv = {</span><span class="s4">0</span><span class="s1">: int</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: int</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: int</span><span class="s0">, </span><span class="s4">3</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">r: dmap[r.decode()]}</span>
        <span class="s1">test = np.recfromcsv(TextIO(dstr</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtyp</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                             <span class="s1">names=</span><span class="s0">None, </span><span class="s1">converters=conv)</span>
        <span class="s1">control = np.rec.array([(</span><span class="s4">1</span><span class="s0">,</span><span class="s4">5</span><span class="s0">,</span><span class="s1">-</span><span class="s4">1</span><span class="s0">,</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s4">8</span><span class="s0">,</span><span class="s1">-</span><span class="s4">1</span><span class="s0">,</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">,</span><span class="s4">3</span><span class="s0">,</span><span class="s1">-</span><span class="s4">2</span><span class="s0">,</span><span class="s4">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=dtyp)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">dtyp = [(</span><span class="s3">'e1'</span><span class="s0">,</span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s3">'e2'</span><span class="s0">,</span><span class="s3">'i4'</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s3">'n'</span><span class="s0">, </span><span class="s3">'i1'</span><span class="s1">)]</span>
        <span class="s1">test = np.recfromcsv(TextIO(dstr</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtyp</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                             <span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">,</span><span class="s4">1</span><span class="s0">,</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">None, </span><span class="s1">converters=conv)</span>
        <span class="s1">control = np.rec.array([(</span><span class="s4">1</span><span class="s0">,</span><span class="s4">5</span><span class="s0">,</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s4">8</span><span class="s0">,</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">,</span><span class="s4">3</span><span class="s0">,</span><span class="s4">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=dtyp)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_dtype_with_object(self):</span>
        <span class="s5"># Test using an explicit dtype with an object</span>
        <span class="s1">data = </span><span class="s3">&quot;&quot;&quot; 1; 2001-01-01 
                   2; 2002-01-31 &quot;&quot;&quot;</span>
        <span class="s1">ndtype = [(</span><span class="s3">'idx'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'code'</span><span class="s0">, </span><span class="s1">object)]</span>
        <span class="s1">func = </span><span class="s0">lambda </span><span class="s1">s: strptime(s.strip()</span><span class="s0">, </span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s1">)</span>
        <span class="s1">converters = {</span><span class="s4">1</span><span class="s1">: func}</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;;&quot;</span><span class="s0">, </span><span class="s1">dtype=ndtype</span><span class="s0">,</span>
                             <span class="s1">converters=converters)</span>
        <span class="s1">control = np.array(</span>
            <span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2001</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s4">2002</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">31</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">dtype=ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s1">ndtype = [(</span><span class="s3">'nest'</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">'idx'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'code'</span><span class="s0">, </span><span class="s1">object)])]</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex(NotImplementedError</span><span class="s0">,</span>
                                 <span class="s3">'Nested fields.* not supported.*'</span><span class="s1">):</span>
            <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;;&quot;</span><span class="s0">,</span>
                                 <span class="s1">dtype=ndtype</span><span class="s0">, </span><span class="s1">converters=converters)</span>

        <span class="s5"># nested but empty fields also aren't supported</span>
        <span class="s1">ndtype = [(</span><span class="s3">'idx'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'code'</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'nest'</span><span class="s0">, </span><span class="s1">[])]</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex(NotImplementedError</span><span class="s0">,</span>
                                 <span class="s3">'Nested fields.* not supported.*'</span><span class="s1">):</span>
            <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;;&quot;</span><span class="s0">,</span>
                                 <span class="s1">dtype=ndtype</span><span class="s0">, </span><span class="s1">converters=converters)</span>

    <span class="s0">def </span><span class="s1">test_dtype_with_object_no_converter(self):</span>
        <span class="s5"># Object without a converter uses bytes:</span>
        <span class="s1">parsed = np.genfromtxt(TextIO(</span><span class="s3">&quot;1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s0">assert </span><span class="s1">parsed[()] == </span><span class="s6">b&quot;1&quot;</span>
        <span class="s1">parsed = np.genfromtxt(TextIO(</span><span class="s3">&quot;string&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s0">assert </span><span class="s1">parsed[()] == </span><span class="s6">b&quot;string&quot;</span>

    <span class="s0">def </span><span class="s1">test_userconverters_with_explicit_dtype(self):</span>
        <span class="s5"># Test user_converters w/ explicit (standard) dtype</span>
        <span class="s1">data = TextIO(</span><span class="s3">'skip,skip,2001-01-01,1.0,skip'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">None, </span><span class="s1">dtype=float</span><span class="s0">,</span>
                             <span class="s1">usecols=(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">converters={</span><span class="s4">2</span><span class="s1">: bytes})</span>
        <span class="s1">control = np.array([(</span><span class="s3">'2001-01-01'</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">''</span><span class="s0">, </span><span class="s3">'|S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">''</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_utf8_userconverters_with_explicit_dtype(self):</span>
        <span class="s1">utf8 = </span><span class="s6">b'</span><span class="s0">\xcf\x96</span><span class="s6">'</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">'wb'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s6">b'skip,skip,2001-01-01' </span><span class="s1">+ utf8 + </span><span class="s6">b',1.0,skip'</span><span class="s1">)</span>
            <span class="s1">test = np.genfromtxt(path</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">None, </span><span class="s1">dtype=float</span><span class="s0">,</span>
                                 <span class="s1">usecols=(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">converters={</span><span class="s4">2</span><span class="s1">: np.compat.unicode}</span><span class="s0">,</span>
                                 <span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">'2001-01-01' </span><span class="s1">+ utf8.decode(</span><span class="s3">'UTF-8'</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">''</span><span class="s0">, </span><span class="s3">'|U11'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">''</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_spacedelimiter(self):</span>
        <span class="s5"># Test space delimiter</span>
        <span class="s1">data = TextIO(</span><span class="s3">&quot;1  2  3  4   5</span><span class="s0">\n</span><span class="s3">6  7  8  9  10&quot;</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data)</span>
        <span class="s1">control = np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.</span><span class="s0">, </span><span class="s4">3.</span><span class="s0">, </span><span class="s4">4.</span><span class="s0">, </span><span class="s4">5.</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s1">[</span><span class="s4">6.</span><span class="s0">, </span><span class="s4">7.</span><span class="s0">, </span><span class="s4">8.</span><span class="s0">, </span><span class="s4">9.</span><span class="s0">, </span><span class="s4">10.</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_integer_delimiter(self):</span>
        <span class="s5"># Test using an integer for delimiter</span>
        <span class="s1">data = </span><span class="s3">&quot;  1  2  3</span><span class="s0">\n  </span><span class="s3">4  5 67</span><span class="s0">\n</span><span class="s3">890123  4&quot;</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">control = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">67</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">890</span><span class="s0">, </span><span class="s4">123</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_missing(self):</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1,2,3,,5</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                            <span class="s1">converters={</span><span class="s4">3</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">s: int(s </span><span class="s0">or </span><span class="s1">- </span><span class="s4">999</span><span class="s1">)})</span>
        <span class="s1">control = np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_missing_with_tabs(self):</span>
        <span class="s5"># Test w/ a delimiter tab</span>
        <span class="s1">txt = </span><span class="s3">&quot;1</span><span class="s0">\t</span><span class="s3">2</span><span class="s0">\t</span><span class="s3">3</span><span class="s0">\n\t</span><span class="s3">2</span><span class="s0">\t\n</span><span class="s3">1</span><span class="s0">\t\t</span><span class="s3">3&quot;</span>
        <span class="s1">test = np.genfromtxt(TextIO(txt)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;</span><span class="s0">\t</span><span class="s3">&quot;</span><span class="s0">,</span>
                             <span class="s1">usemask=</span><span class="s0">True,</span><span class="s1">)</span>
        <span class="s1">ctrl_d = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">ctrl_m = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">assert_equal(test.data</span><span class="s0">, </span><span class="s1">ctrl_d)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">ctrl_m)</span>

    <span class="s0">def </span><span class="s1">test_usecols(self):</span>
        <span class="s5"># Test the selection of columns</span>
        <span class="s5"># Select 1 column</span>
        <span class="s1">control = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">data = TextIO()</span>
        <span class="s1">np.savetxt(data</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">data.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s5">#</span>
        <span class="s1">control = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s1">data = TextIO()</span>
        <span class="s1">np.savetxt(data</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">data.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">:])</span>
        <span class="s5"># Testing with arrays instead of tuples.</span>
        <span class="s1">data.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">usecols=np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">:])</span>

    <span class="s0">def </span><span class="s1">test_usecols_as_css(self):</span>
        <span class="s5"># Test giving usecols with a comma-separated string</span>
        <span class="s1">data = </span><span class="s3">&quot;1 2 3</span><span class="s0">\n</span><span class="s3">4 5 6&quot;</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">names=</span><span class="s3">&quot;a, b, c&quot;</span><span class="s0">, </span><span class="s1">usecols=</span><span class="s3">&quot;a, c&quot;</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">&quot;ac&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_usecols_with_structured_dtype(self):</span>
        <span class="s5"># Test usecols with an explicit structured dtype</span>
        <span class="s1">data = TextIO(</span><span class="s3">&quot;JOE 70.1 25.3</span><span class="s0">\n</span><span class="s3">BOB 60.5 27.9&quot;</span><span class="s1">)</span>
        <span class="s1">names = [</span><span class="s3">'stid'</span><span class="s0">, </span><span class="s3">'temp'</span><span class="s1">]</span>
        <span class="s1">dtypes = [</span><span class="s3">'S4'</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s1">]</span>
        <span class="s1">test = np.genfromtxt(</span>
            <span class="s1">data</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=list(zip(names</span><span class="s0">, </span><span class="s1">dtypes)))</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'stid'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s6">b&quot;JOE&quot;</span><span class="s0">, </span><span class="s6">b&quot;BOB&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'temp'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">25.3</span><span class="s0">, </span><span class="s4">27.9</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_usecols_with_integer(self):</span>
        <span class="s5"># Test usecols with an integer</span>
        <span class="s1">test = np.genfromtxt(TextIO(</span><span class="s6">b&quot;1 2 3</span><span class="s0">\n</span><span class="s6">4 5 6&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">usecols=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_usecols_with_named_columns(self):</span>
        <span class="s5"># Test usecols with named columns</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'c'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">data = </span><span class="s3">&quot;1 2 3</span><span class="s0">\n</span><span class="s3">4 5 6&quot;</span>
        <span class="s1">kwargs = dict(names=</span><span class="s3">&quot;a, b, c&quot;</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">usecols=(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_empty_file(self):</span>
        <span class="s5"># Test that an empty file raises the proper warning.</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(message=</span><span class="s3">&quot;genfromtxt: Empty input file:&quot;</span><span class="s1">)</span>
            <span class="s1">data = TextIO()</span>
            <span class="s1">test = np.genfromtxt(data)</span>
            <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">np.array([]))</span>

            <span class="s5"># when skip_header &gt; 0</span>
            <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">skip_header=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">np.array([]))</span>

    <span class="s0">def </span><span class="s1">test_fancy_dtype_alt(self):</span>
        <span class="s5"># Check that a nested dtype isn't MIA</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1,2,3.0</span><span class="s0">\n</span><span class="s3">4,5,6.0</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">fancydtype = np.dtype([(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'s'</span><span class="s0">, </span><span class="s1">float)])])</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=fancydtype</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6.0</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">dtype=fancydtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_shaped_dtype(self):</span>
        <span class="s1">c = TextIO(</span><span class="s3">&quot;aaaa  1.0  8.0  1 2 3 4 5 6&quot;</span><span class="s1">)</span>
        <span class="s1">dt = np.dtype([(</span><span class="s3">'name'</span><span class="s0">, </span><span class="s3">'S4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">,</span>
                       <span class="s1">(</span><span class="s3">'block'</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))])</span>
        <span class="s1">x = np.genfromtxt(c</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">a = np.array([(</span><span class="s3">'aaaa'</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">8.0</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])]</span><span class="s0">,</span>
                     <span class="s1">dtype=dt)</span>
        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_withmissing(self):</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,N/A'</span><span class="s1">)</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">missing_values=</span><span class="s3">&quot;N/A&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">usemask=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s0">False, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, True</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>
        <span class="s5">#</span>
        <span class="s1">data.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s0">False, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, True</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

    <span class="s0">def </span><span class="s1">test_user_missing_values(self):</span>
        <span class="s1">data = </span><span class="s3">&quot;A, B, C</span><span class="s0">\n</span><span class="s3">0, 0., 0j</span><span class="s0">\n</span><span class="s3">1, N/A, 1j</span><span class="s0">\n</span><span class="s3">-9, 2.2, N/A</span><span class="s0">\n</span><span class="s3">3, -99, 3j&quot;</span>
        <span class="s1">basekwargs = dict(dtype=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True,</span><span class="s1">)</span>
        <span class="s1">mdtype = [(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'C'</span><span class="s0">, </span><span class="s1">complex)]</span>
        <span class="s5">#</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">missing_values=</span><span class="s3">&quot;N/A&quot;</span><span class="s0">,</span>
                            <span class="s1">**basekwargs)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s0">, </span><span class="s4">1j</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s4">9</span><span class="s0">, </span><span class="s4">2.2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">-</span><span class="s4">99</span><span class="s0">, </span><span class="s4">3j</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=mdtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">basekwargs[</span><span class="s3">'dtype'</span><span class="s1">] = mdtype</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                            <span class="s1">missing_values={</span><span class="s4">0</span><span class="s1">: -</span><span class="s4">9</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: -</span><span class="s4">99</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: -</span><span class="s4">999j</span><span class="s1">}</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True, </span><span class="s1">**basekwargs)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s0">, </span><span class="s4">1j</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s4">9</span><span class="s0">, </span><span class="s4">2.2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">-</span><span class="s4">99</span><span class="s0">, </span><span class="s4">3j</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=mdtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                            <span class="s1">missing_values={</span><span class="s4">0</span><span class="s1">: -</span><span class="s4">9</span><span class="s0">, </span><span class="s3">'B'</span><span class="s1">: -</span><span class="s4">99</span><span class="s0">, </span><span class="s3">'C'</span><span class="s1">: -</span><span class="s4">999j</span><span class="s1">}</span><span class="s0">,</span>
                            <span class="s1">usemask=</span><span class="s0">True,</span>
                            <span class="s1">**basekwargs)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s0">, </span><span class="s4">1j</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s4">9</span><span class="s0">, </span><span class="s4">2.2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">-</span><span class="s4">99</span><span class="s0">, </span><span class="s4">3j</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=mdtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_user_filling_values(self):</span>
        <span class="s5"># Test with missing and filling values</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">data = </span><span class="s3">&quot;N/A, 2, 3</span><span class="s0">\n</span><span class="s3">4, ,???&quot;</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">,</span>
                      <span class="s1">dtype=int</span><span class="s0">,</span>
                      <span class="s1">names=</span><span class="s3">&quot;a,b,c&quot;</span><span class="s0">,</span>
                      <span class="s1">missing_values={</span><span class="s4">0</span><span class="s1">: </span><span class="s3">&quot;N/A&quot;</span><span class="s0">, </span><span class="s3">'b'</span><span class="s1">: </span><span class="s3">&quot; &quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: </span><span class="s3">&quot;???&quot;</span><span class="s1">}</span><span class="s0">,</span>
                      <span class="s1">filling_values={</span><span class="s4">0</span><span class="s1">: </span><span class="s4">0</span><span class="s0">, </span><span class="s3">'b'</span><span class="s1">: </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: -</span><span class="s4">999</span><span class="s1">})</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">&quot;abc&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5">#</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">&quot;ac&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

        <span class="s1">data2 = </span><span class="s3">&quot;1,2,*,4</span><span class="s0">\n</span><span class="s3">5,*,7,8</span><span class="s0">\n</span><span class="s3">&quot;</span>
        <span class="s1">test = np.genfromtxt(TextIO(data2)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">,</span>
                             <span class="s1">missing_values=</span><span class="s3">&quot;*&quot;</span><span class="s0">, </span><span class="s1">filling_values=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s1">test = np.genfromtxt(TextIO(data2)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">,</span>
                             <span class="s1">missing_values=</span><span class="s3">&quot;*&quot;</span><span class="s0">, </span><span class="s1">filling_values=-</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_withmissing_float(self):</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1.5</span><span class="s0">\n</span><span class="s3">2,-999.00'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                            <span class="s1">missing_values=</span><span class="s3">'-999.0'</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">usemask=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s0">False, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, True</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

    <span class="s0">def </span><span class="s1">test_with_masked_column_uniform(self):</span>
        <span class="s5"># Test masked column</span>
        <span class="s1">data = TextIO(</span><span class="s3">'1 2 3</span><span class="s0">\n</span><span class="s3">4 5 6</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None,</span>
                             <span class="s1">missing_values=</span><span class="s3">'2,5'</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = ma.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">mask=[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_with_masked_column_various(self):</span>
        <span class="s5"># Test masked column</span>
        <span class="s1">data = TextIO(</span><span class="s3">'True 2 3</span><span class="s0">\n</span><span class="s3">False 5 6</span><span class="s0">\n</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None,</span>
                             <span class="s1">missing_values=</span><span class="s3">'2,5'</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s1">bool)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f1'</span><span class="s0">, </span><span class="s1">bool)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f2'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_invalid_raise(self):</span>
        <span class="s5"># Test invalid raise</span>
        <span class="s1">data = [</span><span class="s3">&quot;1, 1, 1, 1, 1&quot;</span><span class="s1">] * </span><span class="s4">50</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">5</span><span class="s1">):</span>
            <span class="s1">data[</span><span class="s4">10 </span><span class="s1">* i] = </span><span class="s3">&quot;2, 2, 2, 2 2&quot;</span>
        <span class="s1">data.insert(</span><span class="s4">0</span><span class="s0">, </span><span class="s3">&quot;a, b, c, d, e&quot;</span><span class="s1">)</span>
        <span class="s1">mdata = TextIO(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">.join(data))</span>

        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">def </span><span class="s1">f():</span>
            <span class="s0">return </span><span class="s1">np.genfromtxt(mdata</span><span class="s0">, </span><span class="s1">invalid_raise=</span><span class="s0">False, </span><span class="s1">**kwargs)</span>
        <span class="s1">mtest = assert_warns(ConversionWarning</span><span class="s0">, </span><span class="s1">f)</span>
        <span class="s1">assert_equal(len(mtest)</span><span class="s0">, </span><span class="s4">45</span><span class="s1">)</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">45</span><span class="s0">, </span><span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">'abcde'</span><span class="s1">]))</span>
        <span class="s5">#</span>
        <span class="s1">mdata.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.genfromtxt</span><span class="s0">, </span><span class="s1">mdata</span><span class="s0">,</span>
                      <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_invalid_raise_with_usecols(self):</span>
        <span class="s5"># Test invalid_raise with usecols</span>
        <span class="s1">data = [</span><span class="s3">&quot;1, 1, 1, 1, 1&quot;</span><span class="s1">] * </span><span class="s4">50</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">5</span><span class="s1">):</span>
            <span class="s1">data[</span><span class="s4">10 </span><span class="s1">* i] = </span><span class="s3">&quot;2, 2, 2, 2 2&quot;</span>
        <span class="s1">data.insert(</span><span class="s4">0</span><span class="s0">, </span><span class="s3">&quot;a, b, c, d, e&quot;</span><span class="s1">)</span>
        <span class="s1">mdata = TextIO(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">.join(data))</span>

        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">names=</span><span class="s0">True,</span>
                      <span class="s1">invalid_raise=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">def </span><span class="s1">f():</span>
            <span class="s0">return </span><span class="s1">np.genfromtxt(mdata</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">mtest = assert_warns(ConversionWarning</span><span class="s0">, </span><span class="s1">f)</span>
        <span class="s1">assert_equal(len(mtest)</span><span class="s0">, </span><span class="s4">45</span><span class="s1">)</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">45</span><span class="s0">, </span><span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">'ae'</span><span class="s1">]))</span>
        <span class="s5">#</span>
        <span class="s1">mdata.seek(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">mtest = np.genfromtxt(mdata</span><span class="s0">, </span><span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(len(mtest)</span><span class="s0">, </span><span class="s4">50</span><span class="s1">)</span>
        <span class="s1">control = np.ones(</span><span class="s4">50</span><span class="s0">, </span><span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">'ab'</span><span class="s1">])</span>
        <span class="s1">control[[</span><span class="s4">10 </span><span class="s1">* _ </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">5</span><span class="s1">)]] = (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_inconsistent_dtype(self):</span>
        <span class="s5"># Test inconsistent dtype</span>
        <span class="s1">data = [</span><span class="s3">&quot;1, 1, 1, 1, -1.1&quot;</span><span class="s1">] * </span><span class="s4">50</span>
        <span class="s1">mdata = TextIO(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">.join(data))</span>

        <span class="s1">converters = {</span><span class="s4">4</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">x: </span><span class="s3">&quot;(%s)&quot; </span><span class="s1">% x.decode()}</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">converters=converters</span><span class="s0">,</span>
                      <span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">'abcde'</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.genfromtxt</span><span class="s0">, </span><span class="s1">mdata</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">def </span><span class="s1">test_default_field_format(self):</span>
        <span class="s5"># Test default format</span>
        <span class="s1">data = </span><span class="s3">&quot;0, 1, 2.3</span><span class="s0">\n</span><span class="s3">4, 5, 6.7&quot;</span>
        <span class="s1">mtest = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">defaultfmt=</span><span class="s3">&quot;f%02i&quot;</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2.3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6.7</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">&quot;f00&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;f01&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;f02&quot;</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_single_dtype_wo_names(self):</span>
        <span class="s5"># Test single dtype w/o names</span>
        <span class="s1">data = </span><span class="s3">&quot;0, 1, 2.3</span><span class="s0">\n</span><span class="s3">4, 5, 6.7&quot;</span>
        <span class="s1">mtest = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">defaultfmt=</span><span class="s3">&quot;f%02i&quot;</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([[</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">5.</span><span class="s0">, </span><span class="s4">6.7</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=float)</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_single_dtype_w_explicit_names(self):</span>
        <span class="s5"># Test single dtype w explicit names</span>
        <span class="s1">data = </span><span class="s3">&quot;0, 1, 2.3</span><span class="s0">\n</span><span class="s3">4, 5, 6.7&quot;</span>
        <span class="s1">mtest = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">names=</span><span class="s3">&quot;a, b, c&quot;</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">5.</span><span class="s0">, </span><span class="s4">6.7</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">&quot;abc&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_single_dtype_w_implicit_names(self):</span>
        <span class="s5"># Test single dtype w implicit names</span>
        <span class="s1">data = </span><span class="s3">&quot;a, b, c</span><span class="s0">\n</span><span class="s3">0, 1, 2.3</span><span class="s0">\n</span><span class="s3">4, 5, 6.7&quot;</span>
        <span class="s1">mtest = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">5.</span><span class="s0">, </span><span class="s4">6.7</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s3">&quot;abc&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_easy_structured_dtype(self):</span>
        <span class="s5"># Test easy structured dtype</span>
        <span class="s1">data = </span><span class="s3">&quot;0, 1, 2.3</span><span class="s0">\n</span><span class="s3">4, 5, 6.7&quot;</span>
        <span class="s1">mtest = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">,</span>
                             <span class="s1">dtype=(int</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">defaultfmt=</span><span class="s3">&quot;f_%02i&quot;</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">2.3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5.</span><span class="s0">, </span><span class="s4">6.7</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">&quot;f_00&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;f_01&quot;</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;f_02&quot;</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_autostrip(self):</span>
        <span class="s5"># Test autostrip</span>
        <span class="s1">data = </span><span class="s3">&quot;01/01/2003  , 1.3,   abcde&quot;</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">mtest = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s3">'01/01/2003  '</span><span class="s0">, </span><span class="s4">1.3</span><span class="s0">, </span><span class="s3">'   abcde'</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'|S12'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f1'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f2'</span><span class="s0">, </span><span class="s3">'|S8'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">mtest = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">autostrip=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s3">'01/01/2003'</span><span class="s0">, </span><span class="s4">1.3</span><span class="s0">, </span><span class="s3">'abcde'</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'|S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f1'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f2'</span><span class="s0">, </span><span class="s3">'|S5'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(mtest</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_replace_space(self):</span>
        <span class="s5"># Test the 'replace_space' option</span>
        <span class="s1">txt = </span><span class="s3">&quot;A.A, B (B), C:C</span><span class="s0">\n</span><span class="s3">1, 2, 3.14&quot;</span>
        <span class="s5"># Test default: replace ' ' by '_' and delete non-alphanum chars</span>
        <span class="s1">test = np.genfromtxt(TextIO(txt)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">ctrl_dtype = [(</span><span class="s3">&quot;AA&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B_B&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;CC&quot;</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">ctrl = np.array((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3.14</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=ctrl_dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5"># Test: no replace, no delete</span>
        <span class="s1">test = np.genfromtxt(TextIO(txt)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None,</span>
                             <span class="s1">replace_space=</span><span class="s3">''</span><span class="s0">, </span><span class="s1">deletechars=</span><span class="s3">''</span><span class="s1">)</span>
        <span class="s1">ctrl_dtype = [(</span><span class="s3">&quot;A.A&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B (B)&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;C:C&quot;</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">ctrl = np.array((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3.14</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=ctrl_dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5"># Test: no delete (spaces are replaced by _)</span>
        <span class="s1">test = np.genfromtxt(TextIO(txt)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None,</span>
                             <span class="s1">deletechars=</span><span class="s3">''</span><span class="s1">)</span>
        <span class="s1">ctrl_dtype = [(</span><span class="s3">&quot;A.A&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B_(B)&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;C:C&quot;</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">ctrl = np.array((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3.14</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=ctrl_dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_replace_space_known_dtype(self):</span>
        <span class="s5"># Test the 'replace_space' (and related) options when dtype != None</span>
        <span class="s1">txt = </span><span class="s3">&quot;A.A, B (B), C:C</span><span class="s0">\n</span><span class="s3">1, 2, 3&quot;</span>
        <span class="s5"># Test default: replace ' ' by '_' and delete non-alphanum chars</span>
        <span class="s1">test = np.genfromtxt(TextIO(txt)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=int)</span>
        <span class="s1">ctrl_dtype = [(</span><span class="s3">&quot;AA&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B_B&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;CC&quot;</span><span class="s0">, </span><span class="s1">int)]</span>
        <span class="s1">ctrl = np.array((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=ctrl_dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5"># Test: no replace, no delete</span>
        <span class="s1">test = np.genfromtxt(TextIO(txt)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=int</span><span class="s0">,</span>
                             <span class="s1">replace_space=</span><span class="s3">''</span><span class="s0">, </span><span class="s1">deletechars=</span><span class="s3">''</span><span class="s1">)</span>
        <span class="s1">ctrl_dtype = [(</span><span class="s3">&quot;A.A&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B (B)&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;C:C&quot;</span><span class="s0">, </span><span class="s1">int)]</span>
        <span class="s1">ctrl = np.array((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=ctrl_dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5"># Test: no delete (spaces are replaced by _)</span>
        <span class="s1">test = np.genfromtxt(TextIO(txt)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=int</span><span class="s0">,</span>
                             <span class="s1">deletechars=</span><span class="s3">''</span><span class="s1">)</span>
        <span class="s1">ctrl_dtype = [(</span><span class="s3">&quot;A.A&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B_(B)&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;C:C&quot;</span><span class="s0">, </span><span class="s1">int)]</span>
        <span class="s1">ctrl = np.array((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=ctrl_dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_incomplete_names(self):</span>
        <span class="s5"># Test w/ incomplete names</span>
        <span class="s1">data = </span><span class="s3">&quot;A,,C</span><span class="s0">\n</span><span class="s3">0,1,2</span><span class="s0">\n</span><span class="s3">3,4,5&quot;</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s5"># w/ dtype=None</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s1">)])</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5"># w/ default dtype</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(_</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s1">)])</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">def </span><span class="s1">test_names_auto_completion(self):</span>
        <span class="s5"># Make sure that names are properly completed</span>
        <span class="s1">data = </span><span class="s3">&quot;1 2 3</span><span class="s0">\n </span><span class="s3">4 5 6&quot;</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">dtype=(int</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">names=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'f1'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_names_with_usecols_bug1636(self):</span>
        <span class="s5"># Make sure we pick up the right names w/ usecols</span>
        <span class="s1">data = </span><span class="s3">&quot;A,B,C,D,E</span><span class="s0">\n</span><span class="s3">0,1,2,3,4</span><span class="s0">\n</span><span class="s3">0,1,2,3,4</span><span class="s0">\n</span><span class="s3">0,1,2,3,4&quot;</span>
        <span class="s1">ctrl_names = (</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">dtype=(int</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">,</span>
                             <span class="s1">usecols=(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.dtype.names</span><span class="s0">, </span><span class="s1">ctrl_names)</span>
        <span class="s5">#</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">dtype=(int</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">,</span>
                             <span class="s1">usecols=(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.dtype.names</span><span class="s0">, </span><span class="s1">ctrl_names)</span>
        <span class="s5">#</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">,</span>
                             <span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">,</span>
                             <span class="s1">usecols=(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.dtype.names</span><span class="s0">, </span><span class="s1">ctrl_names)</span>

    <span class="s0">def </span><span class="s1">test_fixed_width_names(self):</span>
        <span class="s5"># Test fix-width w/ names</span>
        <span class="s1">data = </span><span class="s3">&quot;    A    B   C</span><span class="s0">\n    </span><span class="s3">0    1 2.3</span><span class="s0">\n   </span><span class="s3">45   67   9.&quot;</span>
        <span class="s1">kwargs = dict(delimiter=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2.3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">45</span><span class="s0">, </span><span class="s4">67</span><span class="s0">, </span><span class="s4">9.</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'C'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>
        <span class="s5">#</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2.3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">45</span><span class="s0">, </span><span class="s4">67</span><span class="s0">, </span><span class="s4">9.</span><span class="s1">)]</span><span class="s0">,</span>
                        <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'C'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_filling_values(self):</span>
        <span class="s5"># Test missing values</span>
        <span class="s1">data = </span><span class="s6">b&quot;1, 2, 3</span><span class="s0">\n</span><span class="s6">1, , 5</span><span class="s0">\n</span><span class="s6">0, 6, </span><span class="s0">\n</span><span class="s6">&quot;</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">filling_values=-</span><span class="s4">999</span><span class="s1">)</span>
        <span class="s1">ctrl = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s1">-</span><span class="s4">999</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">ctrl)</span>

    <span class="s0">def </span><span class="s1">test_comments_is_none(self):</span>
        <span class="s5"># Github issue 329 (None was previously being converted to 'None').</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(TextIO(</span><span class="s3">&quot;test1,testNonetherestofthedata&quot;</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s6">b'testNonetherestofthedata'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(TextIO(</span><span class="s3">&quot;test1, testNonetherestofthedata&quot;</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s6">b' testNonetherestofthedata'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_latin1(self):</span>
        <span class="s1">latin1 = </span><span class="s6">b'</span><span class="s0">\xf6\xfc\xf6</span><span class="s6">'</span>
        <span class="s1">norm = </span><span class="s6">b&quot;norm1,norm2,norm3</span><span class="s0">\n</span><span class="s6">&quot;</span>
        <span class="s1">enc = </span><span class="s6">b&quot;test1,testNonethe&quot; </span><span class="s1">+ latin1 + </span><span class="s6">b&quot;,test3</span><span class="s0">\n</span><span class="s6">&quot;</span>
        <span class="s1">s = norm + enc + norm</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(TextIO(s)</span><span class="s0">,</span>
                                 <span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s6">b&quot;test1&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s6">b&quot;testNonethe&quot; </span><span class="s1">+ latin1)</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s6">b&quot;test3&quot;</span><span class="s1">)</span>
        <span class="s1">test = np.genfromtxt(TextIO(s)</span><span class="s0">,</span>
                             <span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">,</span>
                             <span class="s1">encoding=</span><span class="s3">'latin1'</span><span class="s1">)</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">u&quot;test1&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">u&quot;testNonethe&quot; </span><span class="s1">+ latin1.decode(</span><span class="s3">'latin1'</span><span class="s1">))</span>
        <span class="s1">assert_equal(test[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">u&quot;test3&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(TextIO(</span><span class="s6">b&quot;0,testNonethe&quot; </span><span class="s1">+ latin1)</span><span class="s0">,</span>
                                 <span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'f0'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'f1'</span><span class="s1">]</span><span class="s0">, </span><span class="s6">b&quot;testNonethe&quot; </span><span class="s1">+ latin1)</span>

    <span class="s0">def </span><span class="s1">test_binary_decode_autodtype(self):</span>
        <span class="s1">utf16 = </span><span class="s6">b'</span><span class="s0">\xff\xfe</span><span class="s6">h</span><span class="s0">\x04 \x00</span><span class="s6">i</span><span class="s0">\x04 \x00</span><span class="s6">j</span><span class="s0">\x04</span><span class="s6">'</span>
        <span class="s1">v = self.loadfunc(BytesIO(utf16)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">encoding=</span><span class="s3">'UTF-16'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(v</span><span class="s0">, </span><span class="s1">np.array(utf16.decode(</span><span class="s3">'UTF-16'</span><span class="s1">).split()))</span>

    <span class="s0">def </span><span class="s1">test_utf8_byte_encoding(self):</span>
        <span class="s1">utf8 = </span><span class="s6">b&quot;</span><span class="s0">\xcf\x96</span><span class="s6">&quot;</span>
        <span class="s1">norm = </span><span class="s6">b&quot;norm1,norm2,norm3</span><span class="s0">\n</span><span class="s6">&quot;</span>
        <span class="s1">enc = </span><span class="s6">b&quot;test1,testNonethe&quot; </span><span class="s1">+ utf8 + </span><span class="s6">b&quot;,test3</span><span class="s0">\n</span><span class="s6">&quot;</span>
        <span class="s1">s = norm + enc + norm</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">, </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">test = np.genfromtxt(TextIO(s)</span><span class="s0">,</span>
                                 <span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
            <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
        <span class="s1">ctl = np.array([</span>
                 <span class="s1">[</span><span class="s6">b'norm1'</span><span class="s0">, </span><span class="s6">b'norm2'</span><span class="s0">, </span><span class="s6">b'norm3'</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s6">b'test1'</span><span class="s0">, </span><span class="s6">b'testNonethe' </span><span class="s1">+ utf8</span><span class="s0">, </span><span class="s6">b'test3'</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s6">b'norm1'</span><span class="s0">, </span><span class="s6">b'norm2'</span><span class="s0">, </span><span class="s6">b'norm3'</span><span class="s1">]])</span>
        <span class="s1">assert_array_equal(test</span><span class="s0">, </span><span class="s1">ctl)</span>

    <span class="s0">def </span><span class="s1">test_utf8_file(self):</span>
        <span class="s1">utf8 = </span><span class="s6">b&quot;</span><span class="s0">\xcf\x96</span><span class="s6">&quot;</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write((</span><span class="s6">b&quot;test1,testNonethe&quot; </span><span class="s1">+ utf8 + </span><span class="s6">b&quot;,test3</span><span class="s0">\n</span><span class="s6">&quot;</span><span class="s1">) * </span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">test = np.genfromtxt(path</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None,</span>
                                 <span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;UTF-8&quot;</span><span class="s1">)</span>
            <span class="s1">ctl = np.array([</span>
                     <span class="s1">[</span><span class="s3">&quot;test1&quot;</span><span class="s0">, </span><span class="s3">&quot;testNonethe&quot; </span><span class="s1">+ utf8.decode(</span><span class="s3">&quot;UTF-8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;test3&quot;</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s3">&quot;test1&quot;</span><span class="s0">, </span><span class="s3">&quot;testNonethe&quot; </span><span class="s1">+ utf8.decode(</span><span class="s3">&quot;UTF-8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;test3&quot;</span><span class="s1">]]</span><span class="s0">,</span>
                     <span class="s1">dtype=np.unicode_)</span>
            <span class="s1">assert_array_equal(test</span><span class="s0">, </span><span class="s1">ctl)</span>

            <span class="s5"># test a mixed dtype</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s3">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s6">b&quot;0,testNonethe&quot; </span><span class="s1">+ utf8)</span>
            <span class="s1">test = np.genfromtxt(path</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None,</span>
                                 <span class="s1">delimiter=</span><span class="s3">','</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;UTF-8&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(test[</span><span class="s3">'f0'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_equal(test[</span><span class="s3">'f1'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;testNonethe&quot; </span><span class="s1">+ utf8.decode(</span><span class="s3">&quot;UTF-8&quot;</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_utf8_file_nodtype_unicode(self):</span>
        <span class="s5"># bytes encoding with non-latin1 -&gt; unicode upcast</span>
        <span class="s1">utf8 = </span><span class="s3">u'</span><span class="s0">\u03d6</span><span class="s3">'</span>
        <span class="s1">latin1 = </span><span class="s3">u'</span><span class="s0">\xf6\xfc\xf6</span><span class="s3">'</span>

        <span class="s5"># skip test if cannot encode utf8 test string with preferred</span>
        <span class="s5"># encoding. The preferred encoding is assumed to be the default</span>
        <span class="s5"># encoding of io.open. Will need to change this for PyTest, maybe</span>
        <span class="s5"># using pytest.mark.xfail(raises=***).</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">encoding = locale.getpreferredencoding()</span>
            <span class="s1">utf8.encode(encoding)</span>
        <span class="s0">except </span><span class="s1">(UnicodeError</span><span class="s0">, </span><span class="s1">ImportError):</span>
            <span class="s1">pytest.skip(</span><span class="s3">'Skipping test_utf8_file_nodtype_unicode, '</span>
                        <span class="s3">'unable to encode utf8 in preferred encoding'</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">io.open(path</span><span class="s0">, </span><span class="s3">&quot;wt&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s3">u&quot;norm1,norm2,norm3</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">)</span>
                <span class="s1">f.write(</span><span class="s3">u&quot;norm1,&quot; </span><span class="s1">+ latin1 + </span><span class="s3">u&quot;,norm3</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">)</span>
                <span class="s1">f.write(</span><span class="s3">u&quot;test1,testNonethe&quot; </span><span class="s1">+ utf8 + </span><span class="s3">u&quot;,test3</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
                <span class="s1">warnings.filterwarnings(</span><span class="s3">'always'</span><span class="s0">, </span><span class="s3">''</span><span class="s0">,</span>
                                        <span class="s1">np.VisibleDeprecationWarning)</span>
                <span class="s1">test = np.genfromtxt(path</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">comments=</span><span class="s0">None,</span>
                                     <span class="s1">delimiter=</span><span class="s3">','</span><span class="s1">)</span>
                <span class="s5"># Check for warning when encoding not specified.</span>
                <span class="s1">assert_(w[</span><span class="s4">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">np.VisibleDeprecationWarning)</span>
            <span class="s1">ctl = np.array([</span>
                     <span class="s1">[</span><span class="s3">&quot;norm1&quot;</span><span class="s0">, </span><span class="s3">&quot;norm2&quot;</span><span class="s0">, </span><span class="s3">&quot;norm3&quot;</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s3">&quot;norm1&quot;</span><span class="s0">, </span><span class="s1">latin1</span><span class="s0">, </span><span class="s3">&quot;norm3&quot;</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s3">&quot;test1&quot;</span><span class="s0">, </span><span class="s3">&quot;testNonethe&quot; </span><span class="s1">+ utf8</span><span class="s0">, </span><span class="s3">&quot;test3&quot;</span><span class="s1">]]</span><span class="s0">,</span>
                     <span class="s1">dtype=np.unicode_)</span>
            <span class="s1">assert_array_equal(test</span><span class="s0">, </span><span class="s1">ctl)</span>

    <span class="s0">def </span><span class="s1">test_recfromtxt(self):</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,3'</span><span class="s1">)</span>
        <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">missing_values=</span><span class="s3">&quot;N/A&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">test = np.recfromtxt(data</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">control = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_(isinstance(test</span><span class="s0">, </span><span class="s1">np.recarray))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,N/A'</span><span class="s1">)</span>
        <span class="s1">test = np.recfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">usemask=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s0">False, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, True</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>
        <span class="s1">assert_equal(test.A</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_recfromcsv(self):</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,3'</span><span class="s1">)</span>
        <span class="s1">kwargs = dict(missing_values=</span><span class="s3">&quot;N/A&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">case_sensitive=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">test = np.recfromcsv(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">**kwargs)</span>
        <span class="s1">control = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_(isinstance(test</span><span class="s0">, </span><span class="s1">np.recarray))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,N/A'</span><span class="s1">)</span>
        <span class="s1">test = np.recfromcsv(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">usemask=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s0">False, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, True</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>
        <span class="s1">assert_equal(test.A</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,3'</span><span class="s1">)</span>
        <span class="s1">test = np.recfromcsv(data</span><span class="s0">, </span><span class="s1">missing_values=</span><span class="s3">'N/A'</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_(isinstance(test</span><span class="s0">, </span><span class="s1">np.recarray))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5">#</span>
        <span class="s1">data = TextIO(</span><span class="s3">'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,3'</span><span class="s1">)</span>
        <span class="s1">dtype = [(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'b'</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">test = np.recfromcsv(data</span><span class="s0">, </span><span class="s1">missing_values=</span><span class="s3">'N/A'</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">control = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=dtype)</span>
        <span class="s1">assert_(isinstance(test</span><span class="s0">, </span><span class="s1">np.recarray))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s5">#gh-10394</span>
        <span class="s1">data = TextIO(</span><span class="s3">'color</span><span class="s0">\n</span><span class="s3">&quot;red&quot;</span><span class="s0">\n</span><span class="s3">&quot;blue&quot;'</span><span class="s1">)</span>
        <span class="s1">test = np.recfromcsv(data</span><span class="s0">, </span><span class="s1">converters={</span><span class="s4">0</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">x: x.strip(</span><span class="s6">b'</span><span class="s0">\&quot;</span><span class="s6">'</span><span class="s1">)})</span>
        <span class="s1">control = np.array([(</span><span class="s3">'red'</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'blue'</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s3">'color'</span><span class="s0">, </span><span class="s1">(bytes</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))])</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s0">, </span><span class="s1">control.dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_max_rows(self):</span>
        <span class="s5"># Test the `max_rows` keyword argument.</span>
        <span class="s1">data = </span><span class="s3">'1 2</span><span class="s0">\n</span><span class="s3">3 4</span><span class="s0">\n</span><span class="s3">5 6</span><span class="s0">\n</span><span class="s3">7 8</span><span class="s0">\n</span><span class="s3">9 10</span><span class="s0">\n</span><span class="s3">'</span>
        <span class="s1">txt = TextIO(data)</span>
        <span class="s1">a1 = np.genfromtxt(txt</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">a2 = np.genfromtxt(txt)</span>
        <span class="s1">assert_equal(a1</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]])</span>
        <span class="s1">assert_equal(a2</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]])</span>

        <span class="s5"># max_rows must be at least 1.</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.genfromtxt</span><span class="s0">, </span><span class="s1">TextIO(data)</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">0</span><span class="s1">)</span>

        <span class="s5"># An input with several invalid rows.</span>
        <span class="s1">data = </span><span class="s3">'1 1</span><span class="s0">\n</span><span class="s3">2 2</span><span class="s0">\n</span><span class="s3">0 </span><span class="s0">\n</span><span class="s3">3 3</span><span class="s0">\n</span><span class="s3">4 4</span><span class="s0">\n</span><span class="s3">5  </span><span class="s0">\n</span><span class="s3">6  </span><span class="s0">\n</span><span class="s3">7  </span><span class="s0">\n</span><span class="s3">'</span>

        <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">control = np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">]])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s5"># Test keywords conflict</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.genfromtxt</span><span class="s0">, </span><span class="s1">TextIO(data)</span><span class="s0">, </span><span class="s1">skip_footer=</span><span class="s4">1</span><span class="s0">,</span>
                      <span class="s1">max_rows=</span><span class="s4">4</span><span class="s1">)</span>

        <span class="s5"># Test with invalid value</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.genfromtxt</span><span class="s0">, </span><span class="s1">TextIO(data)</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">4</span><span class="s1">)</span>

        <span class="s5"># Test with invalid not raise</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(ConversionWarning)</span>

            <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">4</span><span class="s0">, </span><span class="s1">invalid_raise=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">control = np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]])</span>
            <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

            <span class="s1">test = np.genfromtxt(TextIO(data)</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">invalid_raise=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">control = np.array([[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2.</span><span class="s0">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3.</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]])</span>
            <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s5"># Structured array with field names.</span>
        <span class="s1">data = </span><span class="s3">'a b</span><span class="s0">\n</span><span class="s3">#c d</span><span class="s0">\n</span><span class="s3">1 1</span><span class="s0">\n</span><span class="s3">2 2</span><span class="s0">\n</span><span class="s3">#0 </span><span class="s0">\n</span><span class="s3">3 3</span><span class="s0">\n</span><span class="s3">4 4</span><span class="s0">\n</span><span class="s3">5  5</span><span class="s0">\n</span><span class="s3">'</span>

        <span class="s5"># Test with header, names and comments</span>
        <span class="s1">txt = TextIO(data)</span>
        <span class="s1">test = np.genfromtxt(txt</span><span class="s0">, </span><span class="s1">skip_header=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">)]</span><span class="s0">,</span>
                      <span class="s1">dtype=[(</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'&lt;f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'d'</span><span class="s0">, </span><span class="s3">'&lt;f8'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s5"># To continue reading the same &quot;file&quot;, don't use skip_header or</span>
        <span class="s5"># names, and use the previously determined dtype.</span>
        <span class="s1">test = np.genfromtxt(txt</span><span class="s0">, </span><span class="s1">max_rows=</span><span class="s0">None, </span><span class="s1">dtype=test.dtype)</span>
        <span class="s1">control = np.array([(</span><span class="s4">4.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5.0</span><span class="s0">, </span><span class="s4">5.0</span><span class="s1">)]</span><span class="s0">,</span>
                      <span class="s1">dtype=[(</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'&lt;f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'d'</span><span class="s0">, </span><span class="s3">'&lt;f8'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_gft_using_filename(self):</span>
        <span class="s5"># Test that we can load data from a filename as well as a file</span>
        <span class="s5"># object</span>
        <span class="s1">tgt = np.arange(</span><span class="s4">6</span><span class="s1">).reshape((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">linesep = (</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s0">, </span><span class="s3">'</span><span class="s0">\r\n</span><span class="s3">'</span><span class="s0">, </span><span class="s3">'</span><span class="s0">\r</span><span class="s3">'</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">sep </span><span class="s0">in </span><span class="s1">linesep:</span>
            <span class="s1">data = </span><span class="s3">'0 1 2' </span><span class="s1">+ sep + </span><span class="s3">'3 4 5'</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">name:</span>
                <span class="s0">with </span><span class="s1">open(name</span><span class="s0">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(data)</span>
                <span class="s1">res = np.genfromtxt(name)</span>
            <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">tgt)</span>

    <span class="s0">def </span><span class="s1">test_gft_from_gzip(self):</span>
        <span class="s5"># Test that we can load data from a gzipped file</span>
        <span class="s1">wanted = np.arange(</span><span class="s4">6</span><span class="s1">).reshape((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">linesep = (</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s0">, </span><span class="s3">'</span><span class="s0">\r\n</span><span class="s3">'</span><span class="s0">, </span><span class="s3">'</span><span class="s0">\r</span><span class="s3">'</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">sep </span><span class="s0">in </span><span class="s1">linesep:</span>
            <span class="s1">data = </span><span class="s3">'0 1 2' </span><span class="s1">+ sep + </span><span class="s3">'3 4 5'</span>
            <span class="s1">s = BytesIO()</span>
            <span class="s0">with </span><span class="s1">gzip.GzipFile(fileobj=s</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">'w'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">g:</span>
                <span class="s1">g.write(asbytes(data))</span>

            <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.gz2'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">name:</span>
                <span class="s0">with </span><span class="s1">open(name</span><span class="s0">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(data)</span>
                <span class="s1">assert_array_equal(np.genfromtxt(name)</span><span class="s0">, </span><span class="s1">wanted)</span>

    <span class="s0">def </span><span class="s1">test_gft_using_generator(self):</span>
        <span class="s5"># gft doesn't work with unicode.</span>
        <span class="s0">def </span><span class="s1">count():</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">10</span><span class="s1">):</span>
                <span class="s0">yield </span><span class="s1">asbytes(</span><span class="s3">&quot;%d&quot; </span><span class="s1">% i)</span>

        <span class="s1">res = np.genfromtxt(count())</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">10</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_auto_dtype_largeint(self):</span>
        <span class="s5"># Regression test for numpy/numpy#5635 whereby large integers could</span>
        <span class="s5"># cause OverflowErrors.</span>

        <span class="s5"># Test the automatic definition of the output dtype</span>
        <span class="s5">#</span>
        <span class="s5"># 2**66 = 73786976294838206464 =&gt; should convert to float</span>
        <span class="s5"># 2**34 = 17179869184 =&gt; should convert to int64</span>
        <span class="s5"># 2**10 = 1024 =&gt; should convert to int (int32 on 32-bit systems,</span>
        <span class="s5">#                 int64 on 64-bit systems)</span>

        <span class="s1">data = TextIO(</span><span class="s3">'73786976294838206464 17179869184 1024'</span><span class="s1">)</span>

        <span class="s1">test = np.genfromtxt(data</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>

        <span class="s1">assert_equal(test.dtype.names</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'f1'</span><span class="s0">, </span><span class="s3">'f2'</span><span class="s1">])</span>

        <span class="s1">assert_(test.dtype[</span><span class="s3">'f0'</span><span class="s1">] == float)</span>
        <span class="s1">assert_(test.dtype[</span><span class="s3">'f1'</span><span class="s1">] == np.int64)</span>
        <span class="s1">assert_(test.dtype[</span><span class="s3">'f2'</span><span class="s1">] == np.int_)</span>

        <span class="s1">assert_allclose(test[</span><span class="s3">'f0'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">73786976294838206464.</span><span class="s1">)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'f1'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">17179869184</span><span class="s1">)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">'f2'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1024</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_unpack_structured(self):</span>
        <span class="s5"># Regression test for gh-4341</span>
        <span class="s5"># Unpacking should work on structured arrays</span>
        <span class="s1">txt = TextIO(</span><span class="s3">&quot;M 21 72</span><span class="s0">\n</span><span class="s3">F 35 58&quot;</span><span class="s1">)</span>
        <span class="s1">dt = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">)</span><span class="s0">, </span><span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'S1'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s1">)}</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c = np.genfromtxt(txt</span><span class="s0">, </span><span class="s1">dtype=dt</span><span class="s0">, </span><span class="s1">unpack=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(a.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">'S1'</span><span class="s1">))</span>
        <span class="s1">assert_equal(b.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">'i4'</span><span class="s1">))</span>
        <span class="s1">assert_equal(c.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">'f4'</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s6">b'M'</span><span class="s0">, </span><span class="s6">b'F'</span><span class="s1">]))</span>
        <span class="s1">assert_array_equal(b</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">21</span><span class="s0">, </span><span class="s4">35</span><span class="s1">]))</span>
        <span class="s1">assert_array_equal(c</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">72.</span><span class="s0">,  </span><span class="s4">58.</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_unpack_auto_dtype(self):</span>
        <span class="s5"># Regression test for gh-4341</span>
        <span class="s5"># Unpacking should work when dtype=None</span>
        <span class="s1">txt = TextIO(</span><span class="s3">&quot;M 21 72.</span><span class="s0">\n</span><span class="s3">F 35 58.&quot;</span><span class="s1">)</span>
        <span class="s1">expected = (np.array([</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s3">&quot;F&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">21</span><span class="s0">, </span><span class="s4">35</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">72.</span><span class="s0">, </span><span class="s4">58.</span><span class="s1">]))</span>
        <span class="s1">test = np.genfromtxt(txt</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">unpack=</span><span class="s0">True, </span><span class="s1">encoding=</span><span class="s3">&quot;utf-8&quot;</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">result </span><span class="s0">in </span><span class="s1">zip(expected</span><span class="s0">, </span><span class="s1">test):</span>
            <span class="s1">assert_array_equal(arr</span><span class="s0">, </span><span class="s1">result)</span>
            <span class="s1">assert_equal(arr.dtype</span><span class="s0">, </span><span class="s1">result.dtype)</span>

    <span class="s0">def </span><span class="s1">test_unpack_single_name(self):</span>
        <span class="s5"># Regression test for gh-4341</span>
        <span class="s5"># Unpacking should work when structured dtype has only one field</span>
        <span class="s1">txt = TextIO(</span><span class="s3">&quot;21</span><span class="s0">\n</span><span class="s3">35&quot;</span><span class="s1">)</span>
        <span class="s1">dt = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'a'</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'i4'</span><span class="s0">,</span><span class="s1">)}</span>
        <span class="s1">expected = np.array([</span><span class="s4">21</span><span class="s0">, </span><span class="s4">35</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">test = np.genfromtxt(txt</span><span class="s0">, </span><span class="s1">dtype=dt</span><span class="s0">, </span><span class="s1">unpack=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(expected</span><span class="s0">, </span><span class="s1">test)</span>
        <span class="s1">assert_equal(expected.dtype</span><span class="s0">, </span><span class="s1">test.dtype)</span>

    <span class="s0">def </span><span class="s1">test_squeeze_scalar(self):</span>
        <span class="s5"># Regression test for gh-4341</span>
        <span class="s5"># Unpacking a scalar should give zero-dim output,</span>
        <span class="s5"># even if dtype is structured</span>
        <span class="s1">txt = TextIO(</span><span class="s3">&quot;1&quot;</span><span class="s1">)</span>
        <span class="s1">dt = {</span><span class="s3">'names'</span><span class="s1">: (</span><span class="s3">'a'</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">'formats'</span><span class="s1">: (</span><span class="s3">'i4'</span><span class="s0">,</span><span class="s1">)}</span>
        <span class="s1">expected = np.array((</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">test = np.genfromtxt(txt</span><span class="s0">, </span><span class="s1">dtype=dt</span><span class="s0">, </span><span class="s1">unpack=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(expected</span><span class="s0">, </span><span class="s1">test)</span>
        <span class="s1">assert_equal(()</span><span class="s0">, </span><span class="s1">test.shape)</span>
        <span class="s1">assert_equal(expected.dtype</span><span class="s0">, </span><span class="s1">test.dtype)</span>


<span class="s0">class </span><span class="s1">TestPathUsage:</span>
    <span class="s5"># Test that pathlib.Path can be used</span>
    <span class="s0">def </span><span class="s1">test_loadtxt(self):</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.txt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">a = np.array([[</span><span class="s4">1.1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]])</span>
            <span class="s1">np.savetxt(path</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">x = np.loadtxt(path)</span>
            <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_save_load(self):</span>
        <span class="s5"># Test that pathlib.Path instances can be used with save.</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npy'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
            <span class="s1">np.save(path</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">data = np.load(path)</span>
            <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_save_load_memmap(self):</span>
        <span class="s5"># Test that pathlib.Path instances can be loaded mem-mapped.</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npy'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
            <span class="s1">np.save(path</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">data = np.load(path</span><span class="s0">, </span><span class="s1">mmap_mode=</span><span class="s3">'r'</span><span class="s1">)</span>
            <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s5"># close the mem-mapped file</span>
            <span class="s0">del </span><span class="s1">data</span>
            <span class="s0">if </span><span class="s1">IS_PYPY:</span>
                <span class="s1">break_cycles()</span>
                <span class="s1">break_cycles()</span>

    <span class="s0">def </span><span class="s1">test_save_load_memmap_readwrite(self):</span>
        <span class="s5"># Test that pathlib.Path instances can be written mem-mapped.</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npy'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">a = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">int)</span>
            <span class="s1">np.save(path</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">b = np.load(path</span><span class="s0">, </span><span class="s1">mmap_mode=</span><span class="s3">'r+'</span><span class="s1">)</span>
            <span class="s1">a[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] = </span><span class="s4">5</span>
            <span class="s1">b[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] = </span><span class="s4">5</span>
            <span class="s0">del </span><span class="s1">b  </span><span class="s5"># closes the file</span>
            <span class="s0">if </span><span class="s1">IS_PYPY:</span>
                <span class="s1">break_cycles()</span>
                <span class="s1">break_cycles()</span>
            <span class="s1">data = np.load(path)</span>
            <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_savez_load(self):</span>
        <span class="s5"># Test that pathlib.Path instances can be used with savez.</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npz'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">np.savez(path</span><span class="s0">, </span><span class="s1">lab=</span><span class="s3">'place holder'</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">np.load(path) </span><span class="s0">as </span><span class="s1">data:</span>
                <span class="s1">assert_array_equal(data[</span><span class="s3">'lab'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">'place holder'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_savez_compressed_load(self):</span>
        <span class="s5"># Test that pathlib.Path instances can be used with savez.</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.npz'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">np.savez_compressed(path</span><span class="s0">, </span><span class="s1">lab=</span><span class="s3">'place holder'</span><span class="s1">)</span>
            <span class="s1">data = np.load(path)</span>
            <span class="s1">assert_array_equal(data[</span><span class="s3">'lab'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">'place holder'</span><span class="s1">)</span>
            <span class="s1">data.close()</span>

    <span class="s0">def </span><span class="s1">test_genfromtxt(self):</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.txt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s1">a = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)])</span>
            <span class="s1">np.savetxt(path</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">data = np.genfromtxt(path)</span>
            <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">data)</span>

    <span class="s0">def </span><span class="s1">test_recfromtxt(self):</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.txt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s0">with </span><span class="s1">path.open(</span><span class="s3">'w'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s3">u'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,3'</span><span class="s1">)</span>

            <span class="s1">kwargs = dict(delimiter=</span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">missing_values=</span><span class="s3">&quot;N/A&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">test = np.recfromtxt(path</span><span class="s0">, </span><span class="s1">**kwargs)</span>
            <span class="s1">control = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                               <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)])</span>
            <span class="s1">assert_(isinstance(test</span><span class="s0">, </span><span class="s1">np.recarray))</span>
            <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_recfromcsv(self):</span>
        <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.txt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">path = Path(path)</span>
            <span class="s0">with </span><span class="s1">path.open(</span><span class="s3">'w'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s3">u'A,B</span><span class="s0">\n</span><span class="s3">0,1</span><span class="s0">\n</span><span class="s3">2,3'</span><span class="s1">)</span>

            <span class="s1">kwargs = dict(missing_values=</span><span class="s3">&quot;N/A&quot;</span><span class="s0">, </span><span class="s1">names=</span><span class="s0">True, </span><span class="s1">case_sensitive=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">test = np.recfromcsv(path</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None, </span><span class="s1">**kwargs)</span>
            <span class="s1">control = np.array([(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s0">,</span>
                               <span class="s1">dtype=[(</span><span class="s3">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'B'</span><span class="s0">, </span><span class="s1">int)])</span>
            <span class="s1">assert_(isinstance(test</span><span class="s0">, </span><span class="s1">np.recarray))</span>
            <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>


<span class="s0">def </span><span class="s1">test_gzip_load():</span>
    <span class="s1">a = np.random.random((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>

    <span class="s1">s = BytesIO()</span>
    <span class="s1">f = gzip.GzipFile(fileobj=s</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;w&quot;</span><span class="s1">)</span>

    <span class="s1">np.save(f</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">f.close()</span>
    <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">f = gzip.GzipFile(fileobj=s</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(np.load(f)</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s5"># These next two classes encode the minimal API needed to save()/load() arrays.</span>
<span class="s5"># The `test_ducktyping` ensures they work correctly</span>
<span class="s0">class </span><span class="s1">JustWriter:</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">base):</span>
        <span class="s1">self.base = base</span>

    <span class="s0">def </span><span class="s1">write(self</span><span class="s0">, </span><span class="s1">s):</span>
        <span class="s0">return </span><span class="s1">self.base.write(s)</span>

    <span class="s0">def </span><span class="s1">flush(self):</span>
        <span class="s0">return </span><span class="s1">self.base.flush()</span>

<span class="s0">class </span><span class="s1">JustReader:</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">base):</span>
        <span class="s1">self.base = base</span>

    <span class="s0">def </span><span class="s1">read(self</span><span class="s0">, </span><span class="s1">n):</span>
        <span class="s0">return </span><span class="s1">self.base.read(n)</span>

    <span class="s0">def </span><span class="s1">seek(self</span><span class="s0">, </span><span class="s1">off</span><span class="s0">, </span><span class="s1">whence=</span><span class="s4">0</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">self.base.seek(off</span><span class="s0">, </span><span class="s1">whence)</span>


<span class="s0">def </span><span class="s1">test_ducktyping():</span>
    <span class="s1">a = np.random.random((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>

    <span class="s1">s = BytesIO()</span>
    <span class="s1">f = JustWriter(s)</span>

    <span class="s1">np.save(f</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">f.flush()</span>
    <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">f = JustReader(s)</span>
    <span class="s1">assert_array_equal(np.load(f)</span><span class="s0">, </span><span class="s1">a)</span>



<span class="s0">def </span><span class="s1">test_gzip_loadtxt():</span>
    <span class="s5"># Thanks to another windows brokenness, we can't use</span>
    <span class="s5"># NamedTemporaryFile: a file created from this function cannot be</span>
    <span class="s5"># reopened by another open call. So we first put the gzipped string</span>
    <span class="s5"># of the test reference array, write it to a securely opened file,</span>
    <span class="s5"># which is then read from by the loadtxt function</span>
    <span class="s1">s = BytesIO()</span>
    <span class="s1">g = gzip.GzipFile(fileobj=s</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">'w'</span><span class="s1">)</span>
    <span class="s1">g.write(</span><span class="s6">b'1 2 3</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">)</span>
    <span class="s1">g.close()</span>

    <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">temppath(suffix=</span><span class="s3">'.gz'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">name:</span>
        <span class="s0">with </span><span class="s1">open(name</span><span class="s0">, </span><span class="s3">'wb'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">f.write(s.read())</span>
        <span class="s1">res = np.loadtxt(name)</span>
    <span class="s1">s.close()</span>

    <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_gzip_loadtxt_from_string():</span>
    <span class="s1">s = BytesIO()</span>
    <span class="s1">f = gzip.GzipFile(fileobj=s</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;w&quot;</span><span class="s1">)</span>
    <span class="s1">f.write(</span><span class="s6">b'1 2 3</span><span class="s0">\n</span><span class="s6">'</span><span class="s1">)</span>
    <span class="s1">f.close()</span>
    <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">f = gzip.GzipFile(fileobj=s</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(np.loadtxt(f)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_npzfile_dict():</span>
    <span class="s1">s = BytesIO()</span>
    <span class="s1">x = np.zeros((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">y = np.zeros((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>

    <span class="s1">np.savez(s</span><span class="s0">, </span><span class="s1">x=x</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s1">s.seek(</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">z = np.load(s)</span>

    <span class="s1">assert_(</span><span class="s3">'x' </span><span class="s0">in </span><span class="s1">z)</span>
    <span class="s1">assert_(</span><span class="s3">'y' </span><span class="s0">in </span><span class="s1">z)</span>
    <span class="s1">assert_(</span><span class="s3">'x' </span><span class="s0">in </span><span class="s1">z.keys())</span>
    <span class="s1">assert_(</span><span class="s3">'y' </span><span class="s0">in </span><span class="s1">z.keys())</span>

    <span class="s0">for </span><span class="s1">f</span><span class="s0">, </span><span class="s1">a </span><span class="s0">in </span><span class="s1">z.items():</span>
        <span class="s1">assert_(f </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'y'</span><span class="s1">])</span>
        <span class="s1">assert_equal(a.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>

    <span class="s1">assert_(len(z.items()) == </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">z:</span>
        <span class="s1">assert_(f </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'y'</span><span class="s1">])</span>

    <span class="s1">assert_(</span><span class="s3">'x' </span><span class="s0">in </span><span class="s1">z.keys())</span>


<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s0">, </span><span class="s1">reason=</span><span class="s3">&quot;Python lacks refcounts&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_load_refcount():</span>
    <span class="s5"># Check that objects returned by np.load are directly freed based on</span>
    <span class="s5"># their refcount, rather than needing the gc to collect them.</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s1">np.savez(f</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
    <span class="s1">f.seek(</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">assert_no_gc_cycles():</span>
        <span class="s1">np.load(f)</span>

    <span class="s1">f.seek(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">dt = [(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">'u1'</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">'u1'</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)]</span>
    <span class="s0">with </span><span class="s1">assert_no_gc_cycles():</span>
        <span class="s1">x = np.loadtxt(TextIO(</span><span class="s3">&quot;0 1 2 3&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
        <span class="s1">assert_equal(x</span><span class="s0">, </span><span class="s1">np.array([((</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">dtype=dt))</span>
</pre>
</body>
</html>