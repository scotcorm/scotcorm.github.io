<html>
<head>
<title>test_other.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_other.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
test all other .agg behavior 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">datetime </span><span class="s2">as </span><span class="s1">dt</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">partial</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">MultiIndex</span><span class="s2">,</span>
    <span class="s1">PeriodIndex</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
    <span class="s1">period_range</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">import </span><span class="s1">pandas._testing </span><span class="s2">as </span><span class="s1">tm</span>
<span class="s2">from </span><span class="s1">pandas.core.base </span><span class="s2">import </span><span class="s1">SpecificationError</span>

<span class="s2">from </span><span class="s1">pandas.io.formats.printing </span><span class="s2">import </span><span class="s1">pprint_thing</span>


<span class="s2">def </span><span class="s1">test_agg_api():</span>
    <span class="s3"># GH 6337</span>
    <span class="s3"># https://stackoverflow.com/questions/21706030/pandas-groupby-agg-function-column-dtype-error</span>
    <span class="s3"># different api for agg when passed custom function with mixed frame</span>

    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;data1&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">5</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">&quot;data2&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">5</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">&quot;key1&quot;</span><span class="s1">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;key2&quot;</span><span class="s1">: [</span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;key1&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">peak_to_peak(arr):</span>
        <span class="s2">return </span><span class="s1">arr.max() - arr.min()</span>

    <span class="s2">with </span><span class="s1">tm.assert_produces_warning(</span>
        <span class="s1">FutureWarning</span><span class="s2">,</span>
        <span class="s1">match=</span><span class="s4">r&quot;\['key2'\] did not aggregate successfully&quot;</span><span class="s2">,</span>
    <span class="s1">):</span>
        <span class="s1">expected = grouped.agg([peak_to_peak])</span>
    <span class="s1">expected.columns = [</span><span class="s4">&quot;data1&quot;</span><span class="s2">, </span><span class="s4">&quot;data2&quot;</span><span class="s1">]</span>

    <span class="s2">with </span><span class="s1">tm.assert_produces_warning(</span>
        <span class="s1">FutureWarning</span><span class="s2">,</span>
        <span class="s1">match=</span><span class="s4">r&quot;\['key2'\] did not aggregate successfully&quot;</span><span class="s2">,</span>
    <span class="s1">):</span>
        <span class="s1">result = grouped.agg(peak_to_peak)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_datetimes_mixed():</span>
    <span class="s1">data = [[</span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s5">1.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s4">&quot;2012-01-02&quot;</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3</span><span class="s2">, None, </span><span class="s5">3.0</span><span class="s1">]]</span>

    <span class="s1">df1 = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;key&quot;</span><span class="s1">: [x[</span><span class="s5">0</span><span class="s1">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">data]</span><span class="s2">,</span>
            <span class="s4">&quot;date&quot;</span><span class="s1">: [x[</span><span class="s5">1</span><span class="s1">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">data]</span><span class="s2">,</span>
            <span class="s4">&quot;value&quot;</span><span class="s1">: [x[</span><span class="s5">2</span><span class="s1">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">data]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">data = [</span>
        <span class="s1">[</span>
            <span class="s1">row[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">(dt.datetime.strptime(row[</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;%Y-%m-%d&quot;</span><span class="s1">).date() </span><span class="s2">if </span><span class="s1">row[</span><span class="s5">1</span><span class="s1">] </span><span class="s2">else None</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">row[</span><span class="s5">2</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">]</span>
        <span class="s2">for </span><span class="s1">row </span><span class="s2">in </span><span class="s1">data</span>
    <span class="s1">]</span>

    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;key&quot;</span><span class="s1">: [x[</span><span class="s5">0</span><span class="s1">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">data]</span><span class="s2">,</span>
            <span class="s4">&quot;date&quot;</span><span class="s1">: [x[</span><span class="s5">1</span><span class="s1">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">data]</span><span class="s2">,</span>
            <span class="s4">&quot;value&quot;</span><span class="s1">: [x[</span><span class="s5">2</span><span class="s1">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">data]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">df1[</span><span class="s4">&quot;weights&quot;</span><span class="s1">] = df1[</span><span class="s4">&quot;value&quot;</span><span class="s1">] / df1[</span><span class="s4">&quot;value&quot;</span><span class="s1">].sum()</span>
    <span class="s1">gb1 = df1.groupby(</span><span class="s4">&quot;date&quot;</span><span class="s1">).aggregate(np.sum)</span>

    <span class="s1">df2[</span><span class="s4">&quot;weights&quot;</span><span class="s1">] = df1[</span><span class="s4">&quot;value&quot;</span><span class="s1">] / df1[</span><span class="s4">&quot;value&quot;</span><span class="s1">].sum()</span>
    <span class="s1">gb2 = df2.groupby(</span><span class="s4">&quot;date&quot;</span><span class="s1">).aggregate(np.sum)</span>

    <span class="s2">assert </span><span class="s1">len(gb1) == len(gb2)</span>


<span class="s2">def </span><span class="s1">test_agg_period_index():</span>
    <span class="s1">prng = period_range(</span><span class="s4">&quot;2012-1-1&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">&quot;M&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">df = DataFrame(np.random.randn(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=prng)</span>
    <span class="s1">rs = df.groupby(level=</span><span class="s5">0</span><span class="s1">).sum()</span>
    <span class="s2">assert </span><span class="s1">isinstance(rs.index</span><span class="s2">, </span><span class="s1">PeriodIndex)</span>

    <span class="s3"># GH 3579</span>
    <span class="s1">index = period_range(start=</span><span class="s4">&quot;1999-01&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">5</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">&quot;M&quot;</span><span class="s1">)</span>
    <span class="s1">s1 = Series(np.random.rand(len(index))</span><span class="s2">, </span><span class="s1">index=index)</span>
    <span class="s1">s2 = Series(np.random.rand(len(index))</span><span class="s2">, </span><span class="s1">index=index)</span>
    <span class="s1">df = DataFrame.from_dict({</span><span class="s4">&quot;s1&quot;</span><span class="s1">: s1</span><span class="s2">, </span><span class="s4">&quot;s2&quot;</span><span class="s1">: s2})</span>
    <span class="s1">grouped = df.groupby(df.index.month)</span>
    <span class="s1">list(grouped)</span>


<span class="s2">def </span><span class="s1">test_agg_dict_parameter_cast_result_dtypes():</span>
    <span class="s3"># GH 12821</span>

    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;class&quot;</span><span class="s1">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;time&quot;</span><span class="s1">: date_range(</span><span class="s4">&quot;1/1/2011&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">8</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">&quot;H&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">df.loc[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;time&quot;</span><span class="s1">] = </span><span class="s2">None</span>

    <span class="s3"># test for `first` function</span>
    <span class="s1">exp = df.loc[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]].set_index(</span><span class="s4">&quot;class&quot;</span><span class="s1">)</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;class&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(grouped.first()</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">tm.assert_frame_equal(grouped.agg(</span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">tm.assert_frame_equal(grouped.agg({</span><span class="s4">&quot;time&quot;</span><span class="s1">: </span><span class="s4">&quot;first&quot;</span><span class="s1">})</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">tm.assert_series_equal(grouped.time.first()</span><span class="s2">, </span><span class="s1">exp[</span><span class="s4">&quot;time&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(grouped.time.agg(</span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">exp[</span><span class="s4">&quot;time&quot;</span><span class="s1">])</span>

    <span class="s3"># test for `last` function</span>
    <span class="s1">exp = df.loc[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">7</span><span class="s1">]].set_index(</span><span class="s4">&quot;class&quot;</span><span class="s1">)</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;class&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(grouped.last()</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">tm.assert_frame_equal(grouped.agg(</span><span class="s4">&quot;last&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">tm.assert_frame_equal(grouped.agg({</span><span class="s4">&quot;time&quot;</span><span class="s1">: </span><span class="s4">&quot;last&quot;</span><span class="s1">})</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">tm.assert_series_equal(grouped.time.last()</span><span class="s2">, </span><span class="s1">exp[</span><span class="s4">&quot;time&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(grouped.time.agg(</span><span class="s4">&quot;last&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">exp[</span><span class="s4">&quot;time&quot;</span><span class="s1">])</span>

    <span class="s3"># count</span>
    <span class="s1">exp = Series([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=Index(list(</span><span class="s4">&quot;ABCD&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;class&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;time&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(grouped.time.agg(len)</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">tm.assert_series_equal(grouped.time.size()</span><span class="s2">, </span><span class="s1">exp)</span>

    <span class="s1">exp = Series([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=Index(list(</span><span class="s4">&quot;ABCD&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;class&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;time&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(grouped.time.count()</span><span class="s2">, </span><span class="s1">exp)</span>


<span class="s2">def </span><span class="s1">test_agg_cast_results_dtypes():</span>
    <span class="s3"># similar to GH12821</span>
    <span class="s3"># xref #11444</span>
    <span class="s1">u = [dt.datetime(</span><span class="s5">2015</span><span class="s2">, </span><span class="s1">x + </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">12</span><span class="s1">)]</span>
    <span class="s1">v = list(</span><span class="s4">&quot;aaabbbbbbccd&quot;</span><span class="s1">)</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;X&quot;</span><span class="s1">: v</span><span class="s2">, </span><span class="s4">&quot;Y&quot;</span><span class="s1">: u})</span>

    <span class="s1">result = df.groupby(</span><span class="s4">&quot;X&quot;</span><span class="s1">)[</span><span class="s4">&quot;Y&quot;</span><span class="s1">].agg(len)</span>
    <span class="s1">expected = df.groupby(</span><span class="s4">&quot;X&quot;</span><span class="s1">)[</span><span class="s4">&quot;Y&quot;</span><span class="s1">].count()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_aggregate_float64_no_int64():</span>
    <span class="s3"># see gh-11199</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]})</span>

    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">])</span>
    <span class="s1">expected.index.name = </span><span class="s4">&quot;b&quot;</span>

    <span class="s1">result = df.groupby(</span><span class="s4">&quot;b&quot;</span><span class="s1">)[[</span><span class="s4">&quot;a&quot;</span><span class="s1">]].mean()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">expected = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">])</span>
    <span class="s1">expected.index.name = </span><span class="s4">&quot;b&quot;</span>

    <span class="s1">result = df.groupby(</span><span class="s4">&quot;b&quot;</span><span class="s1">)[[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]].mean()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_aggregate_api_consistency():</span>
    <span class="s3"># GH 9052</span>
    <span class="s3"># make sure that the aggregates via dict</span>
    <span class="s3"># are consistent</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;C&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">8</span><span class="s1">) + </span><span class="s5">1.0</span><span class="s2">,</span>
            <span class="s4">&quot;D&quot;</span><span class="s1">: np.arange(</span><span class="s5">8</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">grouped = df.groupby([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">c_mean = grouped[</span><span class="s4">&quot;C&quot;</span><span class="s1">].mean()</span>
    <span class="s1">c_sum = grouped[</span><span class="s4">&quot;C&quot;</span><span class="s1">].sum()</span>
    <span class="s1">d_mean = grouped[</span><span class="s4">&quot;D&quot;</span><span class="s1">].mean()</span>
    <span class="s1">d_sum = grouped[</span><span class="s4">&quot;D&quot;</span><span class="s1">].sum()</span>

    <span class="s1">result = grouped[</span><span class="s4">&quot;D&quot;</span><span class="s1">].agg([</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s1">])</span>
    <span class="s1">expected = pd.concat([d_sum</span><span class="s2">, </span><span class="s1">d_mean]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">expected.columns = [</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_like=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s1">result = grouped.agg([np.sum</span><span class="s2">, </span><span class="s1">np.mean])</span>
    <span class="s1">expected = pd.concat([c_sum</span><span class="s2">, </span><span class="s1">c_mean</span><span class="s2">, </span><span class="s1">d_sum</span><span class="s2">, </span><span class="s1">d_mean]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">expected.columns = MultiIndex.from_product([[</span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s1">]])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_like=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s1">result = grouped[[</span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">]].agg([np.sum</span><span class="s2">, </span><span class="s1">np.mean])</span>
    <span class="s1">expected = pd.concat([d_sum</span><span class="s2">, </span><span class="s1">d_mean</span><span class="s2">, </span><span class="s1">c_sum</span><span class="s2">, </span><span class="s1">c_mean]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">expected.columns = MultiIndex.from_product([[</span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s1">]])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_like=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s1">result = grouped.agg({</span><span class="s4">&quot;C&quot;</span><span class="s1">: </span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s1">: </span><span class="s4">&quot;sum&quot;</span><span class="s1">})</span>
    <span class="s1">expected = pd.concat([d_sum</span><span class="s2">, </span><span class="s1">c_mean]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_like=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s1">result = grouped.agg({</span><span class="s4">&quot;C&quot;</span><span class="s1">: [</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s1">: [</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s1">]})</span>
    <span class="s1">expected = pd.concat([c_mean</span><span class="s2">, </span><span class="s1">c_sum</span><span class="s2">, </span><span class="s1">d_mean</span><span class="s2">, </span><span class="s1">d_sum]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">expected.columns = MultiIndex.from_product([[</span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s1">]])</span>

    <span class="s1">msg = </span><span class="s4">r&quot;Column\(s\) \['r', 'r2'\] do not exist&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">grouped[[</span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">]].agg({</span><span class="s4">&quot;r&quot;</span><span class="s1">: np.sum</span><span class="s2">, </span><span class="s4">&quot;r2&quot;</span><span class="s1">: np.mean})</span>


<span class="s2">def </span><span class="s1">test_agg_dict_renaming_deprecation():</span>
    <span class="s3"># 15931</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: range(</span><span class="s5">5</span><span class="s1">)</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: range(</span><span class="s5">5</span><span class="s1">)})</span>

    <span class="s1">msg = </span><span class="s4">r&quot;nested renamer is not supported&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s1">).agg(</span>
            <span class="s1">{</span><span class="s4">&quot;B&quot;</span><span class="s1">: {</span><span class="s4">&quot;foo&quot;</span><span class="s1">: [</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;max&quot;</span><span class="s1">]}</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: {</span><span class="s4">&quot;bar&quot;</span><span class="s1">: [</span><span class="s4">&quot;count&quot;</span><span class="s2">, </span><span class="s4">&quot;min&quot;</span><span class="s1">]}}</span>
        <span class="s1">)</span>

    <span class="s1">msg = </span><span class="s4">r&quot;Column\(s\) \['ma'\] do not exist&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s1">)[[</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">]].agg({</span><span class="s4">&quot;ma&quot;</span><span class="s1">: </span><span class="s4">&quot;max&quot;</span><span class="s1">})</span>

    <span class="s1">msg = </span><span class="s4">r&quot;nested renamer is not supported&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s1">).B.agg({</span><span class="s4">&quot;foo&quot;</span><span class="s1">: </span><span class="s4">&quot;count&quot;</span><span class="s1">})</span>


<span class="s2">def </span><span class="s1">test_agg_compat():</span>
    <span class="s3"># GH 12334</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;C&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">8</span><span class="s1">) + </span><span class="s5">1.0</span><span class="s2">,</span>
            <span class="s4">&quot;D&quot;</span><span class="s1">: np.arange(</span><span class="s5">8</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">g = df.groupby([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">])</span>

    <span class="s1">msg = </span><span class="s4">r&quot;nested renamer is not supported&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">g[</span><span class="s4">&quot;D&quot;</span><span class="s1">].agg({</span><span class="s4">&quot;C&quot;</span><span class="s1">: [</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;std&quot;</span><span class="s1">]})</span>

    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">g[</span><span class="s4">&quot;D&quot;</span><span class="s1">].agg({</span><span class="s4">&quot;C&quot;</span><span class="s1">: </span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s1">: </span><span class="s4">&quot;std&quot;</span><span class="s1">})</span>


<span class="s2">def </span><span class="s1">test_agg_nested_dicts():</span>
    <span class="s3"># API change for disallowing these types of nested dicts</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;C&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">8</span><span class="s1">) + </span><span class="s5">1.0</span><span class="s2">,</span>
            <span class="s4">&quot;D&quot;</span><span class="s1">: np.arange(</span><span class="s5">8</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">g = df.groupby([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">])</span>

    <span class="s1">msg = </span><span class="s4">r&quot;nested renamer is not supported&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">g.aggregate({</span><span class="s4">&quot;r1&quot;</span><span class="s1">: {</span><span class="s4">&quot;C&quot;</span><span class="s1">: [</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s1">]}</span><span class="s2">, </span><span class="s4">&quot;r2&quot;</span><span class="s1">: {</span><span class="s4">&quot;D&quot;</span><span class="s1">: [</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s1">]}})</span>

    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">g.agg({</span><span class="s4">&quot;C&quot;</span><span class="s1">: {</span><span class="s4">&quot;ra&quot;</span><span class="s1">: [</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;std&quot;</span><span class="s1">]}</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s1">: {</span><span class="s4">&quot;rb&quot;</span><span class="s1">: [</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;std&quot;</span><span class="s1">]}})</span>

    <span class="s3"># same name as the original column</span>
    <span class="s3"># GH9052</span>
    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">g[</span><span class="s4">&quot;D&quot;</span><span class="s1">].agg({</span><span class="s4">&quot;result1&quot;</span><span class="s1">: np.sum</span><span class="s2">, </span><span class="s4">&quot;result2&quot;</span><span class="s1">: np.mean})</span>

    <span class="s2">with </span><span class="s1">pytest.raises(SpecificationError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">g[</span><span class="s4">&quot;D&quot;</span><span class="s1">].agg({</span><span class="s4">&quot;D&quot;</span><span class="s1">: np.sum</span><span class="s2">, </span><span class="s4">&quot;result2&quot;</span><span class="s1">: np.mean})</span>


<span class="s2">def </span><span class="s1">test_agg_item_by_item_raise_typeerror():</span>
    <span class="s1">df = DataFrame(np.random.randint(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">size=(</span><span class="s5">20</span><span class="s2">, </span><span class="s5">10</span><span class="s1">)))</span>

    <span class="s2">def </span><span class="s1">raiseException(df):</span>
        <span class="s1">pprint_thing(</span><span class="s4">&quot;----------------------------------------&quot;</span><span class="s1">)</span>
        <span class="s1">pprint_thing(df.to_string())</span>
        <span class="s2">raise </span><span class="s1">TypeError(</span><span class="s4">&quot;test&quot;</span><span class="s1">)</span>

    <span class="s2">with </span><span class="s1">pytest.raises(TypeError</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;test&quot;</span><span class="s1">):</span>
        <span class="s2">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;Dropping invalid&quot;</span><span class="s1">):</span>
            <span class="s1">df.groupby(</span><span class="s5">0</span><span class="s1">).agg(raiseException)</span>


<span class="s2">def </span><span class="s1">test_series_agg_multikey():</span>
    <span class="s1">ts = tm.makeTimeSeries()</span>
    <span class="s1">grouped = ts.groupby([</span><span class="s2">lambda </span><span class="s1">x: x.year</span><span class="s2">, lambda </span><span class="s1">x: x.month])</span>

    <span class="s1">result = grouped.agg(np.sum)</span>
    <span class="s1">expected = grouped.sum()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_series_agg_multi_pure_python():</span>
    <span class="s1">data = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;A&quot;</span><span class="s1">: [</span>
                <span class="s4">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;foo&quot;</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;B&quot;</span><span class="s1">: [</span>
                <span class="s4">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;one&quot;</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;C&quot;</span><span class="s1">: [</span>
                <span class="s4">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;shiny&quot;</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;D&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">11</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">&quot;E&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">11</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">&quot;F&quot;</span><span class="s1">: np.random.randn(</span><span class="s5">11</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">bad(x):</span>
        <span class="s2">assert </span><span class="s1">len(x.values.base) &gt; </span><span class="s5">0</span>
        <span class="s2">return </span><span class="s4">&quot;foo&quot;</span>

    <span class="s1">result = data.groupby([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">]).agg(bad)</span>
    <span class="s1">expected = data.groupby([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">]).agg(</span><span class="s2">lambda </span><span class="s1">x: </span><span class="s4">&quot;foo&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_consistency():</span>
    <span class="s3"># agg with ([]) and () not consistent</span>
    <span class="s3"># GH 6715</span>
    <span class="s2">def </span><span class="s1">P1(a):</span>
        <span class="s2">return </span><span class="s1">np.percentile(a.dropna()</span><span class="s2">, </span><span class="s1">q=</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;col1&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;col2&quot;</span><span class="s1">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">26</span><span class="s2">, </span><span class="s5">31</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;date&quot;</span><span class="s1">: [</span>
                <span class="s1">dt.date(</span><span class="s5">2013</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">dt.date(</span><span class="s5">2013</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">dt.date(</span><span class="s5">2013</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">11</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">dt.date(</span><span class="s5">2013</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">11</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">g = df.groupby(</span><span class="s4">&quot;date&quot;</span><span class="s1">)</span>

    <span class="s1">expected = g.agg([P1])</span>
    <span class="s1">expected.columns = expected.columns.levels[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">result = g.agg(P1)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_callables():</span>
    <span class="s3"># GH 7929</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;foo&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s1">: [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]}).astype(np.int64)</span>

    <span class="s2">class </span><span class="s1">fn_class:</span>
        <span class="s2">def </span><span class="s1">__call__(self</span><span class="s2">, </span><span class="s1">x):</span>
            <span class="s2">return </span><span class="s1">sum(x)</span>

    <span class="s1">equiv_callables = [</span>
        <span class="s1">sum</span><span class="s2">,</span>
        <span class="s1">np.sum</span><span class="s2">,</span>
        <span class="s2">lambda </span><span class="s1">x: sum(x)</span><span class="s2">,</span>
        <span class="s2">lambda </span><span class="s1">x: x.sum()</span><span class="s2">,</span>
        <span class="s1">partial(sum)</span><span class="s2">,</span>
        <span class="s1">fn_class()</span><span class="s2">,</span>
    <span class="s1">]</span>

    <span class="s1">expected = df.groupby(</span><span class="s4">&quot;foo&quot;</span><span class="s1">).agg(sum)</span>
    <span class="s2">for </span><span class="s1">ecall </span><span class="s2">in </span><span class="s1">equiv_callables:</span>
        <span class="s1">result = df.groupby(</span><span class="s4">&quot;foo&quot;</span><span class="s1">).agg(ecall)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_over_numpy_arrays():</span>
    <span class="s3"># GH 3788</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">30</span><span class="s1">])]</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s5">40</span><span class="s2">, </span><span class="s5">50</span><span class="s2">, </span><span class="s5">60</span><span class="s1">])]</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s5">20</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s5">40</span><span class="s1">])]</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">columns=[</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;arraydata&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">gb = df.groupby(</span><span class="s4">&quot;category&quot;</span><span class="s1">)</span>

    <span class="s1">expected_data = [[np.array([</span><span class="s5">50</span><span class="s2">, </span><span class="s5">70</span><span class="s2">, </span><span class="s5">90</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">[np.array([</span><span class="s5">20</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s5">40</span><span class="s1">])]]</span>
    <span class="s1">expected_index = Index([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;category&quot;</span><span class="s1">)</span>
    <span class="s1">expected_column = [</span><span class="s4">&quot;arraydata&quot;</span><span class="s1">]</span>
    <span class="s1">expected = DataFrame(expected_data</span><span class="s2">, </span><span class="s1">index=expected_index</span><span class="s2">, </span><span class="s1">columns=expected_column)</span>

    <span class="s1">alt = gb.sum(numeric_only=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(alt</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">result = gb.agg(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">numeric_only=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s3"># FIXME: the original version of this test called `gb.agg(sum)`</span>
    <span class="s3">#  and that raises TypeError if `numeric_only=False` is passed</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;as_period&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_agg_tzaware_non_datetime_result(as_period):</span>
    <span class="s3"># discussed in GH#29589, fixed in GH#29641, operating on tzaware values</span>
    <span class="s3">#  with function that is not dtype-preserving</span>
    <span class="s1">dti = date_range(</span><span class="s4">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">tz=</span><span class="s4">&quot;UTC&quot;</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">as_period:</span>
        <span class="s1">dti = dti.tz_localize(</span><span class="s2">None</span><span class="s1">).to_period(</span><span class="s4">&quot;D&quot;</span><span class="s1">)</span>

    <span class="s1">df = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: dti})</span>
    <span class="s1">gb = df.groupby(</span><span class="s4">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s3"># Case that _does_ preserve the dtype</span>
    <span class="s1">result = gb[</span><span class="s4">&quot;b&quot;</span><span class="s1">].agg(</span><span class="s2">lambda </span><span class="s1">x: x.iloc[</span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">expected = Series(dti[::</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s1">expected.index.name = </span><span class="s4">&quot;a&quot;</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s3"># Cases that do _not_ preserve the dtype</span>
    <span class="s1">result = gb[</span><span class="s4">&quot;b&quot;</span><span class="s1">].agg(</span><span class="s2">lambda </span><span class="s1">x: x.iloc[</span><span class="s5">0</span><span class="s1">].year)</span>
    <span class="s1">expected = Series([</span><span class="s5">2012</span><span class="s2">, </span><span class="s5">2012</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s1">expected.index.name = </span><span class="s4">&quot;a&quot;</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">result = gb[</span><span class="s4">&quot;b&quot;</span><span class="s1">].agg(</span><span class="s2">lambda </span><span class="s1">x: x.iloc[-</span><span class="s5">1</span><span class="s1">] - x.iloc[</span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">expected = Series([pd.Timedelta(days=</span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Timedelta(days=</span><span class="s5">1</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s1">expected.index.name = </span><span class="s4">&quot;a&quot;</span>
    <span class="s2">if </span><span class="s1">as_period:</span>
        <span class="s1">expected = Series([pd.offsets.Day(</span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.offsets.Day(</span><span class="s5">1</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;b&quot;</span><span class="s1">)</span>
        <span class="s1">expected.index.name = </span><span class="s4">&quot;a&quot;</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_timezone_round_trip():</span>
    <span class="s3"># GH 15426</span>
    <span class="s1">ts = pd.Timestamp(</span><span class="s4">&quot;2016-01-01 12:00:00&quot;</span><span class="s2">, </span><span class="s1">tz=</span><span class="s4">&quot;US/Pacific&quot;</span><span class="s1">)</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: [ts + dt.timedelta(minutes=nn) </span><span class="s2">for </span><span class="s1">nn </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">10</span><span class="s1">)]})</span>

    <span class="s1">result1 = df.groupby(</span><span class="s4">&quot;a&quot;</span><span class="s1">)[</span><span class="s4">&quot;b&quot;</span><span class="s1">].agg(np.min).iloc[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">result2 = df.groupby(</span><span class="s4">&quot;a&quot;</span><span class="s1">)[</span><span class="s4">&quot;b&quot;</span><span class="s1">].agg(</span><span class="s2">lambda </span><span class="s1">x: np.min(x)).iloc[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">result3 = df.groupby(</span><span class="s4">&quot;a&quot;</span><span class="s1">)[</span><span class="s4">&quot;b&quot;</span><span class="s1">].min().iloc[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s2">assert </span><span class="s1">result1 == ts</span>
    <span class="s2">assert </span><span class="s1">result2 == ts</span>
    <span class="s2">assert </span><span class="s1">result3 == ts</span>

    <span class="s1">dates = [</span>
        <span class="s1">pd.Timestamp(</span><span class="s4">f&quot;2016-01-0</span><span class="s2">{</span><span class="s1">i</span><span class="s2">:</span><span class="s4">d</span><span class="s2">} </span><span class="s4">12:00:00&quot;</span><span class="s2">, </span><span class="s1">tz=</span><span class="s4">&quot;US/Pacific&quot;</span><span class="s1">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">]</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">] * </span><span class="s5">2</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: dates})</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s1">)</span>

    <span class="s1">ts = df[</span><span class="s4">&quot;B&quot;</span><span class="s1">].iloc[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">ts == grouped.nth(</span><span class="s5">0</span><span class="s1">)[</span><span class="s4">&quot;B&quot;</span><span class="s1">].iloc[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">ts == grouped.head(</span><span class="s5">1</span><span class="s1">)[</span><span class="s4">&quot;B&quot;</span><span class="s1">].iloc[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">ts == grouped.first()[</span><span class="s4">&quot;B&quot;</span><span class="s1">].iloc[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s3"># GH#27110 applying iloc should return a DataFrame</span>
    <span class="s2">assert </span><span class="s1">ts == grouped.apply(</span><span class="s2">lambda </span><span class="s1">x: x.iloc[</span><span class="s5">0</span><span class="s1">]).iloc[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span>

    <span class="s1">ts = df[</span><span class="s4">&quot;B&quot;</span><span class="s1">].iloc[</span><span class="s5">2</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">ts == grouped.last()[</span><span class="s4">&quot;B&quot;</span><span class="s1">].iloc[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s3"># GH#27110 applying iloc should return a DataFrame</span>
    <span class="s2">assert </span><span class="s1">ts == grouped.apply(</span><span class="s2">lambda </span><span class="s1">x: x.iloc[-</span><span class="s5">1</span><span class="s1">]).iloc[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span>


<span class="s2">def </span><span class="s1">test_sum_uint64_overflow():</span>
    <span class="s3"># see gh-14758</span>
    <span class="s3"># Convert to uint64 and don't overflow</span>
    <span class="s1">df = DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">dtype=object)</span>
    <span class="s1">df = df + </span><span class="s5">9223372036854775807</span>

    <span class="s1">index = Index(</span>
        <span class="s1">[</span><span class="s5">9223372036854775808</span><span class="s2">, </span><span class="s5">9223372036854775810</span><span class="s2">, </span><span class="s5">9223372036854775812</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.uint64</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s5">1</span><span class="s1">: [</span><span class="s5">9223372036854775809</span><span class="s2">, </span><span class="s5">9223372036854775811</span><span class="s2">, </span><span class="s5">9223372036854775813</span><span class="s1">]}</span><span class="s2">,</span>
        <span class="s1">index=index</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">expected.index.name = </span><span class="s5">0</span>
    <span class="s1">result = df.groupby(</span><span class="s5">0</span><span class="s1">).sum(numeric_only=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s3"># out column is non-numeric, so with numeric_only=True it is dropped</span>
    <span class="s1">result2 = df.groupby(</span><span class="s5">0</span><span class="s1">).sum(numeric_only=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">expected2 = expected[[]]</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s2">, </span><span class="s1">expected2)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;structure, expected&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(tuple</span><span class="s2">, </span><span class="s1">DataFrame({</span><span class="s4">&quot;C&quot;</span><span class="s1">: {(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">): (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">): (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)}}))</span><span class="s2">,</span>
        <span class="s1">(list</span><span class="s2">, </span><span class="s1">DataFrame({</span><span class="s4">&quot;C&quot;</span><span class="s1">: {(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">): [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">): [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]}}))</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s2">lambda </span><span class="s1">x: tuple(x)</span><span class="s2">,</span>
            <span class="s1">DataFrame({</span><span class="s4">&quot;C&quot;</span><span class="s1">: {(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">): (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">): (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)}})</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s2">lambda </span><span class="s1">x: list(x)</span><span class="s2">,</span>
            <span class="s1">DataFrame({</span><span class="s4">&quot;C&quot;</span><span class="s1">: {(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">): [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">): [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]}})</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_agg_structs_dataframe(structure</span><span class="s2">, </span><span class="s1">expected):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]}</span>
    <span class="s1">)</span>

    <span class="s1">result = df.groupby([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">]).aggregate(structure)</span>
    <span class="s1">expected.index.names = [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;structure, expected&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(tuple</span><span class="s2">, </span><span class="s1">Series([(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;C&quot;</span><span class="s1">))</span><span class="s2">,</span>
        <span class="s1">(list</span><span class="s2">, </span><span class="s1">Series([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;C&quot;</span><span class="s1">))</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s2">lambda </span><span class="s1">x: tuple(x)</span><span class="s2">, </span><span class="s1">Series([(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;C&quot;</span><span class="s1">))</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s2">lambda </span><span class="s1">x: list(x)</span><span class="s2">, </span><span class="s1">Series([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;C&quot;</span><span class="s1">))</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_agg_structs_series(structure</span><span class="s2">, </span><span class="s1">expected):</span>
    <span class="s3"># Issue #18079</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;A&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]}</span>
    <span class="s1">)</span>

    <span class="s1">result = df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s1">)[</span><span class="s4">&quot;C&quot;</span><span class="s1">].aggregate(structure)</span>
    <span class="s1">expected.index.name = </span><span class="s4">&quot;A&quot;</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_category_nansum(observed):</span>
    <span class="s1">categories = [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;A&quot;</span><span class="s1">: pd.Categorical([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">categories=categories)</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]}</span>
    <span class="s1">)</span>
    <span class="s1">result = df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">observed=observed).B.agg(np.nansum)</span>
    <span class="s1">expected = Series(</span>
        <span class="s1">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">index=pd.CategoricalIndex([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">categories=categories</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;A&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">name=</span><span class="s4">&quot;B&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">if </span><span class="s1">observed:</span>
        <span class="s1">expected = expected[expected != </span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_list_like_func():</span>
    <span class="s3"># GH 18473</span>
    <span class="s1">df = DataFrame({</span><span class="s4">&quot;A&quot;</span><span class="s1">: [str(x) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">)]</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [str(x) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">)]})</span>
    <span class="s1">grouped = df.groupby(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">as_index=</span><span class="s2">False, </span><span class="s1">sort=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">result = grouped.agg({</span><span class="s4">&quot;B&quot;</span><span class="s1">: </span><span class="s2">lambda </span><span class="s1">x: list(x)})</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;A&quot;</span><span class="s1">: [str(x) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">)]</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">: [[str(x)] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">)]}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_agg_lambda_with_timezone():</span>
    <span class="s3"># GH 23683</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;tag&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;date&quot;</span><span class="s1">: [</span>
                <span class="s1">pd.Timestamp(</span><span class="s4">&quot;2018-01-01&quot;</span><span class="s2">, </span><span class="s1">tz=</span><span class="s4">&quot;UTC&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">pd.Timestamp(</span><span class="s4">&quot;2018-01-02&quot;</span><span class="s2">, </span><span class="s1">tz=</span><span class="s4">&quot;UTC&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">result = df.groupby(</span><span class="s4">&quot;tag&quot;</span><span class="s1">).agg({</span><span class="s4">&quot;date&quot;</span><span class="s1">: </span><span class="s2">lambda </span><span class="s1">e: e.head(</span><span class="s5">1</span><span class="s1">)})</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[pd.Timestamp(</span><span class="s4">&quot;2018-01-01&quot;</span><span class="s2">, </span><span class="s1">tz=</span><span class="s4">&quot;UTC&quot;</span><span class="s1">)]</span><span class="s2">,</span>
        <span class="s1">index=Index([</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;tag&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">columns=[</span><span class="s4">&quot;date&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;err_cls&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">NotImplementedError</span><span class="s2">,</span>
        <span class="s1">RuntimeError</span><span class="s2">,</span>
        <span class="s1">KeyError</span><span class="s2">,</span>
        <span class="s1">IndexError</span><span class="s2">,</span>
        <span class="s1">OSError</span><span class="s2">,</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">ArithmeticError</span><span class="s2">,</span>
        <span class="s1">AttributeError</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_groupby_agg_err_catching(err_cls):</span>
    <span class="s3"># make sure we suppress anything other than TypeError or AssertionError</span>
    <span class="s3">#  in _python_agg_general</span>

    <span class="s3"># Use a non-standard EA to make sure we don't go down ndarray paths</span>
    <span class="s2">from </span><span class="s1">pandas.tests.extension.decimal.array </span><span class="s2">import </span><span class="s1">(</span>
        <span class="s1">DecimalArray</span><span class="s2">,</span>
        <span class="s1">make_data</span><span class="s2">,</span>
        <span class="s1">to_decimal</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">data = make_data()[:</span><span class="s5">5</span><span class="s1">]</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s4">&quot;id1&quot;</span><span class="s1">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s1">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;decimals&quot;</span><span class="s1">: DecimalArray(data)}</span>
    <span class="s1">)</span>

    <span class="s1">expected = Series(to_decimal([data[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">data[</span><span class="s5">3</span><span class="s1">]]))</span>

    <span class="s2">def </span><span class="s1">weird_func(x):</span>
        <span class="s3"># weird function that raise something other than TypeError or IndexError</span>
        <span class="s3">#  in _python_agg_general</span>
        <span class="s2">if </span><span class="s1">len(x) == </span><span class="s5">0</span><span class="s1">:</span>
            <span class="s2">raise </span><span class="s1">err_cls</span>
        <span class="s2">return </span><span class="s1">x.iloc[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">result = df[</span><span class="s4">&quot;decimals&quot;</span><span class="s1">].groupby(df[</span><span class="s4">&quot;id1&quot;</span><span class="s1">]).agg(weird_func)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_names=</span><span class="s2">False</span><span class="s1">)</span>
</pre>
</body>
</html>