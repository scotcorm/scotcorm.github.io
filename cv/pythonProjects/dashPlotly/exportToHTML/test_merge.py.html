<html>
<head>
<title>test_merge.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_merge.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">date</span><span class="s0">,</span>
    <span class="s1">datetime</span><span class="s0">,</span>
    <span class="s1">timedelta</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">random</span>
<span class="s0">import </span><span class="s1">re</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.core.dtypes.common </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">is_categorical_dtype</span><span class="s0">,</span>
    <span class="s1">is_object_dtype</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">pandas.core.dtypes.dtypes </span><span class="s0">import </span><span class="s1">CategoricalDtype</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Categorical</span><span class="s0">,</span>
    <span class="s1">CategoricalIndex</span><span class="s0">,</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">DatetimeIndex</span><span class="s0">,</span>
    <span class="s1">IntervalIndex</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">PeriodIndex</span><span class="s0">,</span>
    <span class="s1">RangeIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">TimedeltaIndex</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.api.types </span><span class="s0">import </span><span class="s1">CategoricalDtype </span><span class="s0">as </span><span class="s1">CDT</span>
<span class="s0">from </span><span class="s1">pandas.core.api </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Float64Index</span><span class="s0">,</span>
    <span class="s1">Int64Index</span><span class="s0">,</span>
    <span class="s1">UInt64Index</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">pandas.core.reshape.concat </span><span class="s0">import </span><span class="s1">concat</span>
<span class="s0">from </span><span class="s1">pandas.core.reshape.merge </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">MergeError</span><span class="s0">,</span>
    <span class="s1">merge</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s1">N = </span><span class="s2">50</span>
<span class="s1">NGROUPS = </span><span class="s2">8</span>


<span class="s0">def </span><span class="s1">get_test_data(ngroups=NGROUPS</span><span class="s0">, </span><span class="s1">n=N):</span>
    <span class="s1">unique_groups = list(range(ngroups))</span>
    <span class="s1">arr = np.asarray(np.tile(unique_groups</span><span class="s0">, </span><span class="s1">n // ngroups))</span>

    <span class="s0">if </span><span class="s1">len(arr) &lt; n:</span>
        <span class="s1">arr = np.asarray(list(arr) + unique_groups[: n - len(arr)])</span>

    <span class="s1">random.shuffle(arr)</span>
    <span class="s0">return </span><span class="s1">arr</span>


<span class="s0">def </span><span class="s1">get_series():</span>
    <span class="s0">return </span><span class="s1">[</span>
        <span class="s1">Series([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Series([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Series([</span><span class="s2">1.23</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">Series([</span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">Series([</span><span class="s0">True</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">Series([pd.Timestamp(</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">Series([pd.Timestamp(</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">]</span>


<span class="s0">def </span><span class="s1">get_series_na():</span>
    <span class="s0">return </span><span class="s1">[</span>
        <span class="s1">Series([np.nan]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Series([np.nan]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;float&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Series([np.nan]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Series([pd.NaT])</span><span class="s0">,</span>
    <span class="s1">]</span>


<span class="s1">@pytest.fixture(params=get_series()</span><span class="s0">, </span><span class="s1">ids=</span><span class="s0">lambda </span><span class="s1">x: x.dtype.name)</span>
<span class="s0">def </span><span class="s1">series_of_dtype(request):</span>
    <span class="s4">&quot;&quot;&quot; 
    A parametrized fixture returning a variety of Series of different 
    dtypes 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s1">@pytest.fixture(params=get_series()</span><span class="s0">, </span><span class="s1">ids=</span><span class="s0">lambda </span><span class="s1">x: x.dtype.name)</span>
<span class="s0">def </span><span class="s1">series_of_dtype2(request):</span>
    <span class="s4">&quot;&quot;&quot; 
    A duplicate of the series_of_dtype fixture, so that it can be used 
    twice by a single function 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s1">@pytest.fixture(params=get_series_na()</span><span class="s0">, </span><span class="s1">ids=</span><span class="s0">lambda </span><span class="s1">x: x.dtype.name)</span>
<span class="s0">def </span><span class="s1">series_of_dtype_all_na(request):</span>
    <span class="s4">&quot;&quot;&quot; 
    A parametrized fixture returning a variety of Series with all NA 
    values 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">dfs_for_indicator():</span>
    <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col_conflict&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col_left&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]})</span>
    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;col_conflict&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;col_right&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">return </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">df2</span>


<span class="s0">class </span><span class="s1">TestMerge:</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s5"># aggregate multiple columns</span>
        <span class="s1">self.df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key1&quot;</span><span class="s1">: get_test_data()</span><span class="s0">,</span>
                <span class="s3">&quot;key2&quot;</span><span class="s1">: get_test_data()</span><span class="s0">,</span>
                <span class="s3">&quot;data1&quot;</span><span class="s1">: np.random.randn(N)</span><span class="s0">,</span>
                <span class="s3">&quot;data2&quot;</span><span class="s1">: np.random.randn(N)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s5"># exclude a couple keys for fun</span>
        <span class="s1">self.df = self.df[self.df[</span><span class="s3">&quot;key2&quot;</span><span class="s1">] &gt; </span><span class="s2">1</span><span class="s1">]</span>

        <span class="s1">self.df2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key1&quot;</span><span class="s1">: get_test_data(n=N // </span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;key2&quot;</span><span class="s1">: get_test_data(ngroups=NGROUPS // </span><span class="s2">2</span><span class="s0">, </span><span class="s1">n=N // </span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: np.random.randn(N // </span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">self.left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">7</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">self.right = DataFrame({</span><span class="s3">&quot;v2&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">4</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_merge_inner_join_empty(self):</span>
        <span class="s5"># GH 15328</span>
        <span class="s1">df_empty = DataFrame()</span>
        <span class="s1">df_a = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">result = merge(df_empty</span><span class="s0">, </span><span class="s1">df_a</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: []}</span><span class="s0">, </span><span class="s1">index=[]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_common(self):</span>
        <span class="s1">joined = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2)</span>
        <span class="s1">exp = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_merge_non_string_columns(self):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/17962</span>
        <span class="s5"># Checks that method runs for non string column names</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s2">0</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">right = left.astype(float)</span>
        <span class="s1">expected = left</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s0">def </span><span class="s1">test_merge_index_as_on_arg(self):</span>
        <span class="s5"># GH14355</span>

        <span class="s1">left = self.df.set_index(</span><span class="s3">&quot;key1&quot;</span><span class="s1">)</span>
        <span class="s1">right = self.df2.set_index(</span><span class="s3">&quot;key1&quot;</span><span class="s1">)</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key1&quot;</span><span class="s1">)</span>
        <span class="s1">expected = merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key1&quot;</span><span class="s1">).set_index(</span><span class="s3">&quot;key1&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_index_singlekey_right_vs_left(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">7</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;v2&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">4</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>

        <span class="s1">merged1 = merge(</span>
            <span class="s1">left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">merged2 = merge(</span>
            <span class="s1">right</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(merged1</span><span class="s0">, </span><span class="s1">merged2.loc[:</span><span class="s0">, </span><span class="s1">merged1.columns])</span>

        <span class="s1">merged1 = merge(</span>
            <span class="s1">left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">merged2 = merge(</span>
            <span class="s1">right</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(merged1</span><span class="s0">, </span><span class="s1">merged2.loc[:</span><span class="s0">, </span><span class="s1">merged1.columns])</span>

    <span class="s0">def </span><span class="s1">test_merge_index_singlekey_inner(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">7</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;v2&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">4</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>

        <span class="s5"># inner join</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">expected = left.join(right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">).loc[result.index]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = merge(right</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">expected = left.join(right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">).loc[result.index]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.loc[:</span><span class="s0">, </span><span class="s1">result.columns])</span>

    <span class="s0">def </span><span class="s1">test_merge_misspecified(self):</span>
        <span class="s1">msg = </span><span class="s3">&quot;Must pass right_on or right_index=True&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(pd.errors.MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(self.left</span><span class="s0">, </span><span class="s1">self.right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">&quot;Must pass left_on or left_index=True&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(pd.errors.MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(self.left</span><span class="s0">, </span><span class="s1">self.right</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">msg = (</span>
            <span class="s3">'Can only pass argument &quot;on&quot; OR &quot;left_on&quot; and &quot;right_on&quot;, not '</span>
            <span class="s3">&quot;a combination of both&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(pd.errors.MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(self.left</span><span class="s0">, </span><span class="s1">self.left</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>

        <span class="s1">msg = </span><span class="s3">r&quot;len\(right_on\) must equal len\(left_on\)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(self.df</span><span class="s0">, </span><span class="s1">self.df2</span><span class="s0">, </span><span class="s1">left_on=[</span><span class="s3">&quot;key1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">right_on=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_index_and_on_parameters_confusion(self):</span>
        <span class="s1">msg = </span><span class="s3">&quot;right_index parameter must be of type bool, not &lt;class 'list'&gt;&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(</span>
                <span class="s1">self.df</span><span class="s0">,</span>
                <span class="s1">self.df2</span><span class="s0">,</span>
                <span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">,</span>
                <span class="s1">left_index=</span><span class="s0">False,</span>
                <span class="s1">right_index=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s1">msg = </span><span class="s3">&quot;left_index parameter must be of type bool, not &lt;class 'list'&gt;&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(</span>
                <span class="s1">self.df</span><span class="s0">,</span>
                <span class="s1">self.df2</span><span class="s0">,</span>
                <span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">,</span>
                <span class="s1">left_index=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">right_index=</span><span class="s0">False,</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(</span>
                <span class="s1">self.df</span><span class="s0">,</span>
                <span class="s1">self.df2</span><span class="s0">,</span>
                <span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">,</span>
                <span class="s1">left_index=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">right_index=[</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;key2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_merge_overlap(self):</span>
        <span class="s1">merged = merge(self.left</span><span class="s0">, </span><span class="s1">self.left</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">exp_len = (self.left[</span><span class="s3">&quot;key&quot;</span><span class="s1">].value_counts() ** </span><span class="s2">2</span><span class="s1">).sum()</span>
        <span class="s0">assert </span><span class="s1">len(merged) == exp_len</span>
        <span class="s0">assert </span><span class="s3">&quot;v1_x&quot; </span><span class="s0">in </span><span class="s1">merged</span>
        <span class="s0">assert </span><span class="s3">&quot;v1_y&quot; </span><span class="s0">in </span><span class="s1">merged</span>

    <span class="s0">def </span><span class="s1">test_merge_different_column_key_names(self):</span>
        <span class="s1">left = DataFrame({</span><span class="s3">&quot;lkey&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]})</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;rkey&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;qux&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]})</span>

        <span class="s1">merged = left.merge(</span>
            <span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;lkey&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;rkey&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span>
        <span class="s1">)</span>

        <span class="s1">exp = Series([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;lkey&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;lkey&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">exp = Series([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;qux&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;rkey&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;rkey&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">exp = Series([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;value_x&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;value_x&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">exp = Series([</span><span class="s2">6</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;value_y&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;value_y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_merge_copy(self):</span>
        <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;bar&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s2">10</span><span class="s1">))</span>

        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">copy=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">merged[</span><span class="s3">&quot;a&quot;</span><span class="s1">] = </span><span class="s2">6</span>
        <span class="s0">assert </span><span class="s1">(left[</span><span class="s3">&quot;a&quot;</span><span class="s1">] == </span><span class="s2">0</span><span class="s1">).all()</span>

        <span class="s1">merged[</span><span class="s3">&quot;d&quot;</span><span class="s1">] = </span><span class="s3">&quot;peekaboo&quot;</span>
        <span class="s0">assert </span><span class="s1">(right[</span><span class="s3">&quot;d&quot;</span><span class="s1">] == </span><span class="s3">&quot;bar&quot;</span><span class="s1">).all()</span>

    <span class="s0">def </span><span class="s1">test_merge_nocopy(self</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
        <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;bar&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s2">10</span><span class="s1">))</span>

        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">np.shares_memory(merged[</span><span class="s3">&quot;a&quot;</span><span class="s1">]._values</span><span class="s0">, </span><span class="s1">left[</span><span class="s3">&quot;a&quot;</span><span class="s1">]._values)</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(merged[</span><span class="s3">&quot;d&quot;</span><span class="s1">]._values</span><span class="s0">, </span><span class="s1">right[</span><span class="s3">&quot;d&quot;</span><span class="s1">]._values)</span>

    <span class="s0">def </span><span class="s1">test_intelligently_handle_join_key(self):</span>
        <span class="s5"># #733, be a bit more 1337 about not returning unconsolidated DataFrame</span>

        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: list(range(</span><span class="s2">5</span><span class="s1">))}</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;value&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;rvalue&quot;</span><span class="s1">: list(range(</span><span class="s2">6</span><span class="s1">))})</span>

        <span class="s1">joined = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
                <span class="s3">&quot;rvalue&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;value&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;rvalue&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(joined</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_join_key_dtype_cast(self):</span>
        <span class="s5"># #8596</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">20</span><span class="s1">]})</span>
        <span class="s1">df = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df[</span><span class="s3">&quot;key&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;int64&quot;</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s0">True</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s0">False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s1">]})</span>
        <span class="s1">df = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>

        <span class="s5"># GH13169</span>
        <span class="s5"># GH#40073</span>
        <span class="s0">assert </span><span class="s1">df[</span><span class="s3">&quot;key&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;bool&quot;</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;val&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;val&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s1">]})</span>
        <span class="s1">lkey = np.array([</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">rkey = np.array([</span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">df = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">left_on=lkey</span><span class="s0">, </span><span class="s1">right_on=rkey</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df[</span><span class="s3">&quot;key_0&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;int64&quot;</span>

    <span class="s0">def </span><span class="s1">test_handle_join_key_pass_array(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: np.arange(</span><span class="s2">5</span><span class="s1">)}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;value&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;rvalue&quot;</span><span class="s1">: np.arange(</span><span class="s2">6</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">key = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>

        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">right_on=key</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">merged2 = merge(right</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">left_on=key</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>

        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;key&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">merged2[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">merged[</span><span class="s3">&quot;key&quot;</span><span class="s1">].notna().all()</span>
        <span class="s0">assert </span><span class="s1">merged2[</span><span class="s3">&quot;key&quot;</span><span class="s1">].notna().all()</span>

        <span class="s1">left = DataFrame({</span><span class="s3">&quot;value&quot;</span><span class="s1">: np.arange(</span><span class="s2">5</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;value&quot;</span><span class="s1">])</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;rvalue&quot;</span><span class="s1">: np.arange(</span><span class="s2">6</span><span class="s1">)})</span>
        <span class="s1">lkey = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>
        <span class="s1">rkey = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>

        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=lkey</span><span class="s0">, </span><span class="s1">right_on=rkey</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(</span>
            <span class="s1">merged[</span><span class="s3">&quot;key_0&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;key_0&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s1">left = DataFrame({</span><span class="s3">&quot;value&quot;</span><span class="s1">: np.arange(</span><span class="s2">3</span><span class="s1">)})</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;rvalue&quot;</span><span class="s1">: np.arange(</span><span class="s2">6</span><span class="s1">)})</span>

        <span class="s1">key = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_on=key</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged[</span><span class="s3">&quot;key_0&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Series(key</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;key_0&quot;</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_no_overlap_more_informative_error(self):</span>
        <span class="s1">dt = datetime.now()</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt])</span>

        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt</span><span class="s0">, </span><span class="s1">dt])</span>

        <span class="s1">msg = (</span>
            <span class="s3">&quot;No common columns to perform merge on. &quot;</span>
            <span class="s3">f&quot;Merge options: left_on=</span><span class="s0">{None}</span><span class="s3">, right_on=</span><span class="s0">{None}</span><span class="s3">, &quot;</span>
            <span class="s3">f&quot;left_index=</span><span class="s0">{False}</span><span class="s3">, right_index=</span><span class="s0">{False}</span><span class="s3">&quot;</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df1</span><span class="s0">, </span><span class="s1">df2)</span>

    <span class="s0">def </span><span class="s1">test_merge_non_unique_indexes(self):</span>

        <span class="s1">dt = datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">dt2 = datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">dt3 = datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">dt4 = datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt])</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt</span><span class="s0">, </span><span class="s1">dt])</span>
        <span class="s1">_check_merge(df1</span><span class="s0">, </span><span class="s1">df2)</span>

        <span class="s5"># Not monotonic</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt2</span><span class="s0">, </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">dt4])</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s3">&quot;h&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt3</span><span class="s0">, </span><span class="s1">dt3</span><span class="s0">, </span><span class="s1">dt2</span><span class="s0">, </span><span class="s1">dt2</span><span class="s0">, </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">dt]</span>
        <span class="s1">)</span>
        <span class="s1">_check_merge(df1</span><span class="s0">, </span><span class="s1">df2)</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt</span><span class="s0">, </span><span class="s1">dt])</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt</span><span class="s0">, </span><span class="s1">dt])</span>
        <span class="s1">_check_merge(df1</span><span class="s0">, </span><span class="s1">df2)</span>

    <span class="s0">def </span><span class="s1">test_merge_non_unique_index_many_to_many(self):</span>
        <span class="s1">dt = datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">dt2 = datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">dt3 = datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt2</span><span class="s0">, </span><span class="s1">dt2</span><span class="s0">, </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">dt])</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s3">&quot; h&quot;</span><span class="s0">, </span><span class="s3">&quot;i&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[dt2</span><span class="s0">, </span><span class="s1">dt2</span><span class="s0">, </span><span class="s1">dt3</span><span class="s0">, </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">dt]</span>
        <span class="s1">)</span>
        <span class="s1">_check_merge(df1</span><span class="s0">, </span><span class="s1">df2)</span>

    <span class="s0">def </span><span class="s1">test_left_merge_empty_dataframe(self):</span>
        <span class="s1">left = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s1">]})</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: []})</span>

        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">left)</span>

        <span class="s1">result = merge(right</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">left)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;kwarg&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">{</span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;x&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;x&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_left_empty_right_empty(self</span><span class="s0">, </span><span class="s1">join_type</span><span class="s0">, </span><span class="s1">kwarg):</span>
        <span class="s5"># GH 10824</span>
        <span class="s1">left = DataFrame(columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">right = DataFrame(columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">])</span>

        <span class="s1">exp_in = DataFrame(</span>
            <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=pd.Index([]</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
            <span class="s1">dtype=object</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=join_type</span><span class="s0">, </span><span class="s1">**kwarg)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp_in)</span>

    <span class="s0">def </span><span class="s1">test_merge_left_empty_right_notempty(self):</span>
        <span class="s5"># GH 10824</span>
        <span class="s1">left = DataFrame(columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">right = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">])</span>

        <span class="s1">exp_out = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: np.array([np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: np.array([np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: np.array([np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
                <span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;z&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">exp_in = exp_out[</span><span class="s2">0</span><span class="s1">:</span><span class="s2">0</span><span class="s1">]  </span><span class="s5"># make empty DataFrame keeping dtype</span>
        <span class="s5"># result will have object dtype</span>
        <span class="s1">exp_in.index = exp_in.index.astype(object)</span>

        <span class="s0">def </span><span class="s1">check1(exp</span><span class="s0">, </span><span class="s1">kwarg):</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s0">def </span><span class="s1">check2(exp</span><span class="s0">, </span><span class="s1">kwarg):</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s0">for </span><span class="s1">kwarg </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">{</span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;x&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">]:</span>
            <span class="s1">check1(exp_in</span><span class="s0">, </span><span class="s1">kwarg)</span>
            <span class="s1">check2(exp_out</span><span class="s0">, </span><span class="s1">kwarg)</span>

        <span class="s1">kwarg = {</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span>
        <span class="s1">check1(exp_in</span><span class="s0">, </span><span class="s1">kwarg)</span>
        <span class="s1">exp_out[</span><span class="s3">&quot;a&quot;</span><span class="s1">] = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">check2(exp_out</span><span class="s0">, </span><span class="s1">kwarg)</span>

        <span class="s1">kwarg = {</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;x&quot;</span><span class="s1">}</span>
        <span class="s1">check1(exp_in</span><span class="s0">, </span><span class="s1">kwarg)</span>
        <span class="s1">exp_out[</span><span class="s3">&quot;a&quot;</span><span class="s1">] = np.array([np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s1">check2(exp_out</span><span class="s0">, </span><span class="s1">kwarg)</span>

    <span class="s0">def </span><span class="s1">test_merge_left_notempty_right_empty(self):</span>
        <span class="s5"># GH 10824</span>
        <span class="s1">left = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">right = DataFrame(columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">])</span>

        <span class="s1">exp_out = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;x&quot;</span><span class="s1">: np.array([np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
                <span class="s3">&quot;y&quot;</span><span class="s1">: np.array([np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
                <span class="s3">&quot;z&quot;</span><span class="s1">: np.array([np.nan] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">exp_in = exp_out[</span><span class="s2">0</span><span class="s1">:</span><span class="s2">0</span><span class="s1">]  </span><span class="s5"># make empty DataFrame keeping dtype</span>
        <span class="s5"># result will have object dtype</span>
        <span class="s1">exp_in.index = exp_in.index.astype(object)</span>

        <span class="s0">def </span><span class="s1">check1(exp</span><span class="s0">, </span><span class="s1">kwarg):</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s0">def </span><span class="s1">check2(exp</span><span class="s0">, </span><span class="s1">kwarg):</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>
            <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">**kwarg)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

            <span class="s5"># TODO: should the next loop be un-indented? doing so breaks this test</span>
            <span class="s0">for </span><span class="s1">kwarg </span><span class="s0">in </span><span class="s1">[</span>
                <span class="s1">{</span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s1">{</span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True, </span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;x&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s1">{</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s1">{</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;x&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">]:</span>
                <span class="s1">check1(exp_in</span><span class="s0">, </span><span class="s1">kwarg)</span>
                <span class="s1">check2(exp_out</span><span class="s0">, </span><span class="s1">kwarg)</span>

    <span class="s0">def </span><span class="s1">test_merge_empty_frame(self</span><span class="s0">, </span><span class="s1">series_of_dtype</span><span class="s0">, </span><span class="s1">series_of_dtype2):</span>
        <span class="s5"># GH 25183</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: series_of_dtype</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: series_of_dtype2}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df_empty = df[:</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: Series(dtype=df.dtypes[</span><span class="s3">&quot;value&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: Series(dtype=df.dtypes[</span><span class="s3">&quot;key&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: Series(dtype=df.dtypes[</span><span class="s3">&quot;value&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;value_x&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;value_y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">actual = df_empty.merge(df</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_all_na_column(self</span><span class="s0">, </span><span class="s1">series_of_dtype</span><span class="s0">, </span><span class="s1">series_of_dtype_all_na):</span>
        <span class="s5"># GH 25183</span>
        <span class="s1">df_left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: series_of_dtype</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: series_of_dtype_all_na}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df_right = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: series_of_dtype</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: series_of_dtype_all_na}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: series_of_dtype</span><span class="s0">,</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: series_of_dtype_all_na</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: series_of_dtype_all_na</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;value_x&quot;</span><span class="s0">, </span><span class="s3">&quot;value_y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">actual = df_left.merge(df_right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_nosort(self):</span>
        <span class="s5"># GH#2098</span>

        <span class="s1">d = {</span>
            <span class="s3">&quot;var1&quot;</span><span class="s1">: np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s1">size=</span><span class="s2">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;var2&quot;</span><span class="s1">: np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s1">size=</span><span class="s2">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;var3&quot;</span><span class="s1">: [</span>
                <span class="s1">datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">12</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2011</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2010</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">12</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2011</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2008</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2010</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">datetime(</span><span class="s2">2012</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">df = DataFrame.from_dict(d)</span>
        <span class="s1">var3 = df.var3.unique()</span>
        <span class="s1">var3.sort()</span>
        <span class="s1">new = DataFrame.from_dict({</span><span class="s3">&quot;var3&quot;</span><span class="s1">: var3</span><span class="s0">, </span><span class="s3">&quot;var8&quot;</span><span class="s1">: np.random.random(</span><span class="s2">7</span><span class="s1">)})</span>

        <span class="s1">result = df.merge(new</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;var3&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">exp = merge(df</span><span class="s0">, </span><span class="s1">new</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;var3&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s0">assert </span><span class="s1">(df.var3.unique() == result.var3.unique()).all()</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s1">(</span><span class="s3">&quot;sort&quot;</span><span class="s0">, </span><span class="s3">&quot;values&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">False, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s0">True, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;how&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_merge_same_order_left_right(self</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">how):</span>
        <span class="s5"># GH#35382</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]})</span>

        <span class="s1">result = df.merge(df</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">how=how</span><span class="s0">, </span><span class="s1">sort=sort)</span>
        <span class="s1">expected = DataFrame(values</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_nan_right(self):</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;i1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;i2&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;i1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;i3&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s1">]})</span>
        <span class="s1">result = df1.join(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;i1&quot;</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_&quot;</span><span class="s1">)</span>
        <span class="s1">expected = (</span>
            <span class="s1">DataFrame(</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;i1&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">,</span>
                    <span class="s3">&quot;i2&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">,</span>
                    <span class="s3">&quot;i1_&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: np.nan}</span><span class="s0">,</span>
                    <span class="s3">&quot;i3&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: np.nan}</span><span class="s0">,</span>
                    <span class="s0">None</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">0</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s1">}</span>
            <span class="s1">)</span>
            <span class="s1">.set_index(</span><span class="s0">None</span><span class="s1">)</span>
            <span class="s1">.reset_index()[[</span><span class="s3">&quot;i1&quot;</span><span class="s0">, </span><span class="s3">&quot;i2&quot;</span><span class="s0">, </span><span class="s3">&quot;i1_&quot;</span><span class="s0">, </span><span class="s3">&quot;i3&quot;</span><span class="s1">]]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_merge_nan_right2(self):</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;i1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;i2&quot;</span><span class="s1">: [</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">1.5</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;i1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;i3&quot;</span><span class="s1">: [</span><span class="s2">0.7</span><span class="s1">]})</span>
        <span class="s1">result = df1.join(df2</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;_&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;i1&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;i1&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;i1_&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: np.nan}</span><span class="s0">,</span>
                <span class="s3">&quot;i2&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">1.5</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;i3&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">0.69999999999999996</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: np.nan}</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)[[</span><span class="s3">&quot;i1&quot;</span><span class="s0">, </span><span class="s3">&quot;i2&quot;</span><span class="s0">, </span><span class="s3">&quot;i1_&quot;</span><span class="s0">, </span><span class="s3">&quot;i3&quot;</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_type(self):</span>
        <span class="s0">class </span><span class="s1">NotADataFrame(DataFrame):</span>
            <span class="s1">@property</span>
            <span class="s0">def </span><span class="s1">_constructor(self):</span>
                <span class="s0">return </span><span class="s1">NotADataFrame</span>

        <span class="s1">nad = NotADataFrame(self.df)</span>
        <span class="s1">result = nad.merge(self.df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key1&quot;</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">NotADataFrame)</span>

    <span class="s0">def </span><span class="s1">test_join_append_timedeltas(self):</span>
        <span class="s5"># timedelta64 issues with join/merge</span>
        <span class="s5"># GH 5695</span>

        <span class="s1">d = DataFrame.from_dict(</span>
            <span class="s1">{</span><span class="s3">&quot;d&quot;</span><span class="s1">: [datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">56</span><span class="s1">)]</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s1">: [timedelta(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">22500</span><span class="s1">)]}</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(columns=list(</span><span class="s3">&quot;dt&quot;</span><span class="s1">))</span>
        <span class="s1">df = concat([df</span><span class="s0">, </span><span class="s1">d]</span><span class="s0">, </span><span class="s1">ignore_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = concat([df</span><span class="s0">, </span><span class="s1">d]</span><span class="s0">, </span><span class="s1">ignore_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;d&quot;</span><span class="s1">: [datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">56</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">56</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s3">&quot;t&quot;</span><span class="s1">: [timedelta(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">22500</span><span class="s1">)</span><span class="s0">, </span><span class="s1">timedelta(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">22500</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">dtype=object</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_join_append_timedeltas2(self):</span>
        <span class="s5"># timedelta64 issues with join/merge</span>
        <span class="s5"># GH 5695</span>
        <span class="s1">td = np.timedelta64(</span><span class="s2">300000000</span><span class="s1">)</span>
        <span class="s1">lhs = DataFrame(Series([td</span><span class="s0">, </span><span class="s1">td]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]))</span>
        <span class="s1">rhs = DataFrame(Series([td]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s1">]))</span>

        <span class="s1">result = lhs.join(rhs</span><span class="s0">, </span><span class="s1">rsuffix=</span><span class="s3">&quot;r&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;0&quot;</span><span class="s1">: Series([td</span><span class="s0">, </span><span class="s1">td]</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s3">&quot;AB&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s3">&quot;0r&quot;</span><span class="s1">: Series([td</span><span class="s0">, </span><span class="s1">pd.NaT]</span><span class="s0">, </span><span class="s1">index=list(</span><span class="s3">&quot;AB&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_other_datetime_unit(self):</span>
        <span class="s5"># GH 13389</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;entity_id&quot;</span><span class="s1">: [</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s1">]})</span>
        <span class="s1">s = Series([</span><span class="s0">None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;days&quot;</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s3">&quot;datetime64[D]&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;datetime64[h]&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;datetime64[m]&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;datetime64[s]&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;datetime64[ms]&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;datetime64[us]&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;datetime64[ns]&quot;</span><span class="s0">,</span>
        <span class="s1">]:</span>

            <span class="s1">df2 = s.astype(dtype).to_frame(</span><span class="s3">&quot;days&quot;</span><span class="s1">)</span>
            <span class="s5"># coerces to datetime64[ns], thus should not be affected</span>
            <span class="s0">assert </span><span class="s1">df2[</span><span class="s3">&quot;days&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;datetime64[ns]&quot;</span>

            <span class="s1">result = df1.merge(df2</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;entity_id&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

            <span class="s1">exp = DataFrame(</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;entity_id&quot;</span><span class="s1">: [</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s3">&quot;days&quot;</span><span class="s1">: np.array([</span><span class="s3">&quot;nat&quot;</span><span class="s0">, </span><span class="s3">&quot;nat&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">columns=[</span><span class="s3">&quot;entity_id&quot;</span><span class="s0">, </span><span class="s3">&quot;days&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;unit&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;s&quot;</span><span class="s0">, </span><span class="s3">&quot;ms&quot;</span><span class="s0">, </span><span class="s3">&quot;us&quot;</span><span class="s0">, </span><span class="s3">&quot;ns&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_other_timedelta_unit(self</span><span class="s0">, </span><span class="s1">unit):</span>
        <span class="s5"># GH 13389</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;entity_id&quot;</span><span class="s1">: [</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s1">]})</span>
        <span class="s1">s = Series([</span><span class="s0">None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;days&quot;</span><span class="s1">)</span>

        <span class="s1">dtype = </span><span class="s3">f&quot;m8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span>
        <span class="s1">df2 = s.astype(dtype).to_frame(</span><span class="s3">&quot;days&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df2[</span><span class="s3">&quot;days&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;m8[ns]&quot;</span>

        <span class="s1">result = df1.merge(df2</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;entity_id&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">exp = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;entity_id&quot;</span><span class="s1">: [</span><span class="s2">101</span><span class="s0">, </span><span class="s2">102</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;days&quot;</span><span class="s1">: np.array([</span><span class="s3">&quot;nat&quot;</span><span class="s0">, </span><span class="s3">&quot;nat&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;entity_id&quot;</span><span class="s0">, </span><span class="s3">&quot;days&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_overlapping_columns_error_message(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">: [</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">: [</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]})</span>

        <span class="s1">df.columns = [</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span>
        <span class="s1">df2.columns = [</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;v2&quot;</span><span class="s1">: [</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;v3&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;v4&quot;</span><span class="s1">: [</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected.columns = [</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(merge(df</span><span class="s0">, </span><span class="s1">df2)</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># #2649, #10639</span>
        <span class="s1">df2.columns = [</span><span class="s3">&quot;key1&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span>
        <span class="s1">msg = </span><span class="s3">r&quot;Data columns not unique: Index\(\['foo'\], dtype='object'\)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df</span><span class="s0">, </span><span class="s1">df2)</span>

    <span class="s0">def </span><span class="s1">test_merge_on_datetime64tz(self):</span>

        <span class="s5"># GH11405</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: pd.date_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: pd.date_range(</span><span class="s3">&quot;20151011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: pd.date_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">4</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_datetime64tz_values(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: pd.date_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: pd.date_range(</span><span class="s3">&quot;20151011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: list(pd.date_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">))</span>
                <span class="s1">+ [pd.NaT]</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: [pd.NaT]</span>
                <span class="s1">+ list(pd.date_range(</span><span class="s3">&quot;20151011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">result[</span><span class="s3">&quot;value_x&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;datetime64[ns, US/Eastern]&quot;</span>
        <span class="s0">assert </span><span class="s1">result[</span><span class="s3">&quot;value_y&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;datetime64[ns, US/Eastern]&quot;</span>

    <span class="s0">def </span><span class="s1">test_merge_on_datetime64tz_empty(self):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/25014</span>
        <span class="s1">dtz = pd.DatetimeTZDtype(tz=</span><span class="s3">&quot;UTC&quot;</span><span class="s1">)</span>
        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s1">: [pd.Timestamp(</span><span class="s3">&quot;2018&quot;</span><span class="s0">, </span><span class="s1">tz=dtz.tz)]</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;date2&quot;</span><span class="s1">: [pd.Timestamp(</span><span class="s3">&quot;2019&quot;</span><span class="s0">, </span><span class="s1">tz=dtz.tz)]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s0">, </span><span class="s3">&quot;date2&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">left = right[:</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">result = left.merge(right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;date&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: Series(dtype=float)</span><span class="s0">,</span>
                <span class="s3">&quot;date2_x&quot;</span><span class="s1">: Series(dtype=dtz)</span><span class="s0">,</span>
                <span class="s3">&quot;date&quot;</span><span class="s1">: Series(dtype=dtz)</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: Series(dtype=float)</span><span class="s0">,</span>
                <span class="s3">&quot;date2_y&quot;</span><span class="s1">: Series(dtype=dtz)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;value_x&quot;</span><span class="s0">, </span><span class="s3">&quot;date2_x&quot;</span><span class="s0">, </span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;value_y&quot;</span><span class="s0">, </span><span class="s3">&quot;date2_y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_datetime64tz_with_dst_transition(self):</span>
        <span class="s5"># GH 18885</span>
        <span class="s1">df1 = DataFrame(</span>
            <span class="s1">pd.date_range(</span><span class="s3">&quot;2017-10-29 01:00&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">4</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;H&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Europe/Madrid&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;date&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df1[</span><span class="s3">&quot;value&quot;</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s1">: pd.to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s3">&quot;2017-10-29 03:00:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2017-10-29 04:00:00&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;2017-10-29 05:00:00&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df2[</span><span class="s3">&quot;date&quot;</span><span class="s1">] = df2[</span><span class="s3">&quot;date&quot;</span><span class="s1">].dt.tz_localize(</span><span class="s3">&quot;UTC&quot;</span><span class="s1">).dt.tz_convert(</span><span class="s3">&quot;Europe/Madrid&quot;</span><span class="s1">)</span>
        <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;date&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s1">: pd.date_range(</span>
                    <span class="s3">&quot;2017-10-29 01:00&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">7</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;H&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Europe/Madrid&quot;</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">] * </span><span class="s2">4 </span><span class="s1">+ [np.nan] * </span><span class="s2">3</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: [np.nan] * </span><span class="s2">4 </span><span class="s1">+ [</span><span class="s2">2</span><span class="s1">] * </span><span class="s2">3</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_non_unique_period_index(self):</span>
        <span class="s5"># GH #16871</span>
        <span class="s1">index = pd.period_range(</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">16</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(list(range(len(index)))</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;pnum&quot;</span><span class="s1">])</span>
        <span class="s1">df2 = concat([df</span><span class="s0">, </span><span class="s1">df])</span>
        <span class="s1">result = df.merge(df2</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.tile(np.arange(</span><span class="s2">16</span><span class="s0">, </span><span class="s1">dtype=np.int64).repeat(</span><span class="s2">2</span><span class="s1">).reshape(-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;pnum_x&quot;</span><span class="s0">, </span><span class="s3">&quot;pnum_y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=df2.sort_index().index</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_on_periods(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: pd.period_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: pd.period_range(</span><span class="s3">&quot;20151011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">3</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: pd.period_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">4</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_period_values(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: pd.period_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: pd.period_range(</span><span class="s3">&quot;20151011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)}</span>
        <span class="s1">)</span>

        <span class="s1">exp_x = pd.period_range(</span><span class="s3">&quot;20151010&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span>
        <span class="s1">exp_y = pd.period_range(</span><span class="s3">&quot;20151011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s1">: list(exp_x) + [pd.NaT]</span><span class="s0">,</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s1">: [pd.NaT] + list(exp_y)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">result[</span><span class="s3">&quot;value_x&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;Period[D]&quot;</span>
        <span class="s0">assert </span><span class="s1">result[</span><span class="s3">&quot;value_y&quot;</span><span class="s1">].dtype == </span><span class="s3">&quot;Period[D]&quot;</span>

    <span class="s0">def </span><span class="s1">test_indicator(self</span><span class="s0">, </span><span class="s1">dfs_for_indicator):</span>
        <span class="s5"># PR #10054. xref #7412 and closes #8790.</span>
        <span class="s1">df1</span><span class="s0">, </span><span class="s1">df2 = dfs_for_indicator</span>
        <span class="s1">df1_copy = df1.copy()</span>

        <span class="s1">df2_copy = df2.copy()</span>

        <span class="s1">df_result = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;col_conflict_x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s3">&quot;col_left&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s3">&quot;col_conflict_y&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;col_right&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df_result[</span><span class="s3">&quot;_merge&quot;</span><span class="s1">] = Categorical(</span>
            <span class="s1">[</span>
                <span class="s3">&quot;left_only&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;both&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;right_only&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;right_only&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;right_only&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;right_only&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">categories=[</span><span class="s3">&quot;left_only&quot;</span><span class="s0">, </span><span class="s3">&quot;right_only&quot;</span><span class="s0">, </span><span class="s3">&quot;both&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">df_result = df_result[</span>
            <span class="s1">[</span>
                <span class="s3">&quot;col1&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;col_conflict_x&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;col_left&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;col_conflict_y&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;col_right&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;_merge&quot;</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">]</span>

        <span class="s1">test = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(test</span><span class="s0">, </span><span class="s1">df_result)</span>
        <span class="s1">test = df1.merge(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(test</span><span class="s0">, </span><span class="s1">df_result)</span>

        <span class="s5"># No side effects</span>
        <span class="s1">tm.assert_frame_equal(df1</span><span class="s0">, </span><span class="s1">df1_copy)</span>
        <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">df2_copy)</span>

        <span class="s5"># Check with custom name</span>
        <span class="s1">df_result_custom_name = df_result</span>
        <span class="s1">df_result_custom_name = df_result_custom_name.rename(</span>
            <span class="s1">columns={</span><span class="s3">&quot;_merge&quot;</span><span class="s1">: </span><span class="s3">&quot;custom_name&quot;</span><span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">test_custom_name = merge(</span>
            <span class="s1">df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s3">&quot;custom_name&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(test_custom_name</span><span class="s0">, </span><span class="s1">df_result_custom_name)</span>
        <span class="s1">test_custom_name = df1.merge(</span>
            <span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s3">&quot;custom_name&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(test_custom_name</span><span class="s0">, </span><span class="s1">df_result_custom_name)</span>

    <span class="s0">def </span><span class="s1">test_merge_indicator_arg_validation(self</span><span class="s0">, </span><span class="s1">dfs_for_indicator):</span>
        <span class="s5"># Check only accepts strings and booleans</span>
        <span class="s1">df1</span><span class="s0">, </span><span class="s1">df2 = dfs_for_indicator</span>

        <span class="s1">msg = </span><span class="s3">&quot;indicator option can only accept boolean or string arguments&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df1.merge(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s2">5</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_merge_indicator_result_integrity(self</span><span class="s0">, </span><span class="s1">dfs_for_indicator):</span>
        <span class="s5"># Check result integrity</span>
        <span class="s1">df1</span><span class="s0">, </span><span class="s1">df2 = dfs_for_indicator</span>

        <span class="s1">test2 = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(test2._merge != </span><span class="s3">&quot;right_only&quot;</span><span class="s1">).all()</span>
        <span class="s1">test2 = df1.merge(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(test2._merge != </span><span class="s3">&quot;right_only&quot;</span><span class="s1">).all()</span>

        <span class="s1">test3 = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(test3._merge != </span><span class="s3">&quot;left_only&quot;</span><span class="s1">).all()</span>
        <span class="s1">test3 = df1.merge(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(test3._merge != </span><span class="s3">&quot;left_only&quot;</span><span class="s1">).all()</span>

        <span class="s1">test4 = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(test4._merge == </span><span class="s3">&quot;both&quot;</span><span class="s1">).all()</span>
        <span class="s1">test4 = df1.merge(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(test4._merge == </span><span class="s3">&quot;both&quot;</span><span class="s1">).all()</span>

    <span class="s0">def </span><span class="s1">test_merge_indicator_invalid(self</span><span class="s0">, </span><span class="s1">dfs_for_indicator):</span>
        <span class="s5"># Check if working name in df</span>
        <span class="s1">df1</span><span class="s0">, </span><span class="s1">_ = dfs_for_indicator</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">[</span><span class="s3">&quot;_right_indicator&quot;</span><span class="s0">, </span><span class="s3">&quot;_left_indicator&quot;</span><span class="s0">, </span><span class="s3">&quot;_merge&quot;</span><span class="s1">]:</span>
            <span class="s1">df_badcolumn = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">i: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]})</span>

            <span class="s1">msg = (</span>
                <span class="s3">&quot;Cannot use `indicator=True` option when data contains a &quot;</span>
                <span class="s3">f&quot;column named </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">|&quot;</span>
                <span class="s3">&quot;Cannot use name of an existing column for indicator column&quot;</span>
            <span class="s1">)</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">merge(df1</span><span class="s0">, </span><span class="s1">df_badcolumn</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">df1.merge(df_badcolumn</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s5"># Check for name conflict with custom name</span>
        <span class="s1">df_badcolumn = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;custom_column_name&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]})</span>

        <span class="s1">msg = </span><span class="s3">&quot;Cannot use name of an existing column for indicator column&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(</span>
                <span class="s1">df1</span><span class="s0">,</span>
                <span class="s1">df_badcolumn</span><span class="s0">,</span>
                <span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">,</span>
                <span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">,</span>
                <span class="s1">indicator=</span><span class="s3">&quot;custom_column_name&quot;</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df1.merge(</span>
                <span class="s1">df_badcolumn</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s3">&quot;custom_column_name&quot;</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_merge_indicator_multiple_columns(self):</span>
        <span class="s5"># Merge on multiple columns</span>
        <span class="s1">df3 = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]})</span>

        <span class="s1">df4 = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]})</span>

        <span class="s1">hand_coded_result = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">hand_coded_result[</span><span class="s3">&quot;_merge&quot;</span><span class="s1">] = Categorical(</span>
            <span class="s1">[</span><span class="s3">&quot;left_only&quot;</span><span class="s0">, </span><span class="s3">&quot;both&quot;</span><span class="s0">, </span><span class="s3">&quot;right_only&quot;</span><span class="s0">, </span><span class="s3">&quot;right_only&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">categories=[</span><span class="s3">&quot;left_only&quot;</span><span class="s0">, </span><span class="s3">&quot;right_only&quot;</span><span class="s0">, </span><span class="s3">&quot;both&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">test5 = merge(df3</span><span class="s0">, </span><span class="s1">df4</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(test5</span><span class="s0">, </span><span class="s1">hand_coded_result)</span>
        <span class="s1">test5 = df3.merge(df4</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">indicator=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(test5</span><span class="s0">, </span><span class="s1">hand_coded_result)</span>

    <span class="s0">def </span><span class="s1">test_validation(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;weasel&quot;</span><span class="s0">, </span><span class="s3">&quot;horse&quot;</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;meow&quot;</span><span class="s0">, </span><span class="s3">&quot;bark&quot;</span><span class="s0">, </span><span class="s3">&quot;um... weasel noise?&quot;</span><span class="s0">, </span><span class="s3">&quot;nay&quot;</span><span class="s0">, </span><span class="s3">&quot;chirp&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s5"># Make sure no side effects.</span>
        <span class="s1">left_copy = left.copy()</span>
        <span class="s1">right_copy = right.copy()</span>

        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">validate=</span><span class="s3">&quot;1:1&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">left_copy)</span>
        <span class="s1">tm.assert_frame_equal(right</span><span class="s0">, </span><span class="s1">right_copy)</span>

        <span class="s5"># make sure merge still correct</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a_x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;weasel&quot;</span><span class="s0">, </span><span class="s3">&quot;horse&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;a_y&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;meow&quot;</span><span class="s0">, </span><span class="s3">&quot;bark&quot;</span><span class="s0">, </span><span class="s3">&quot;um... weasel noise?&quot;</span><span class="s0">, </span><span class="s3">&quot;nay&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;a_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a_y&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = merge(</span>
            <span class="s1">left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">validate=</span><span class="s3">&quot;one_to_one&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected_2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;weasel&quot;</span><span class="s0">, </span><span class="s3">&quot;horse&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;meow&quot;</span><span class="s0">, </span><span class="s3">&quot;bark&quot;</span><span class="s0">, </span><span class="s3">&quot;um... weasel noise?&quot;</span><span class="s0">, </span><span class="s3">&quot;nay&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;1:1&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(left</span><span class="s0">, </span><span class="s1">left_copy)</span>
        <span class="s1">tm.assert_frame_equal(right</span><span class="s0">, </span><span class="s1">right_copy)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected_2)</span>

        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;one_to_one&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected_2)</span>

        <span class="s5"># One index, one column</span>
        <span class="s1">expected_3 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;weasel&quot;</span><span class="s0">, </span><span class="s3">&quot;horse&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;meow&quot;</span><span class="s0">, </span><span class="s3">&quot;bark&quot;</span><span class="s0">, </span><span class="s3">&quot;um... weasel noise?&quot;</span><span class="s0">, </span><span class="s3">&quot;nay&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">left_index_reset = left.set_index(</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">result = merge(</span>
            <span class="s1">left_index_reset</span><span class="s0">,</span>
            <span class="s1">right</span><span class="s0">,</span>
            <span class="s1">left_index=</span><span class="s0">True,</span>
            <span class="s1">right_on=</span><span class="s3">&quot;a&quot;</span><span class="s0">,</span>
            <span class="s1">validate=</span><span class="s3">&quot;one_to_one&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected_3)</span>

        <span class="s5"># Dups on right</span>
        <span class="s1">right_w_dups = concat([right</span><span class="s0">, </span><span class="s1">DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;e&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;moo&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">4</span><span class="s1">])])</span>
        <span class="s1">merge(</span>
            <span class="s1">left</span><span class="s0">,</span>
            <span class="s1">right_w_dups</span><span class="s0">,</span>
            <span class="s1">left_index=</span><span class="s0">True,</span>
            <span class="s1">right_index=</span><span class="s0">True,</span>
            <span class="s1">validate=</span><span class="s3">&quot;one_to_many&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">msg = </span><span class="s3">&quot;Merge keys are not unique in right dataset; not a one-to-one merge&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(</span>
                <span class="s1">left</span><span class="s0">,</span>
                <span class="s1">right_w_dups</span><span class="s0">,</span>
                <span class="s1">left_index=</span><span class="s0">True,</span>
                <span class="s1">right_index=</span><span class="s0">True,</span>
                <span class="s1">validate=</span><span class="s3">&quot;one_to_one&quot;</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(left</span><span class="s0">, </span><span class="s1">right_w_dups</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;one_to_one&quot;</span><span class="s1">)</span>

        <span class="s5"># Dups on left</span>
        <span class="s1">left_w_dups = concat(</span>
            <span class="s1">[left</span><span class="s0">, </span><span class="s1">DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;cow&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">3</span><span class="s1">])]</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">merge(</span>
            <span class="s1">left_w_dups</span><span class="s0">,</span>
            <span class="s1">right</span><span class="s0">,</span>
            <span class="s1">left_index=</span><span class="s0">True,</span>
            <span class="s1">right_index=</span><span class="s0">True,</span>
            <span class="s1">validate=</span><span class="s3">&quot;many_to_one&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">msg = </span><span class="s3">&quot;Merge keys are not unique in left dataset; not a one-to-one merge&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(</span>
                <span class="s1">left_w_dups</span><span class="s0">,</span>
                <span class="s1">right</span><span class="s0">,</span>
                <span class="s1">left_index=</span><span class="s0">True,</span>
                <span class="s1">right_index=</span><span class="s0">True,</span>
                <span class="s1">validate=</span><span class="s3">&quot;one_to_one&quot;</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(left_w_dups</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;one_to_one&quot;</span><span class="s1">)</span>

        <span class="s5"># Dups on both</span>
        <span class="s1">merge(left_w_dups</span><span class="s0">, </span><span class="s1">right_w_dups</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;many_to_many&quot;</span><span class="s1">)</span>

        <span class="s1">msg = </span><span class="s3">&quot;Merge keys are not unique in right dataset; not a many-to-one merge&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(</span>
                <span class="s1">left_w_dups</span><span class="s0">,</span>
                <span class="s1">right_w_dups</span><span class="s0">,</span>
                <span class="s1">left_index=</span><span class="s0">True,</span>
                <span class="s1">right_index=</span><span class="s0">True,</span>
                <span class="s1">validate=</span><span class="s3">&quot;many_to_one&quot;</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s1">msg = </span><span class="s3">&quot;Merge keys are not unique in left dataset; not a one-to-many merge&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(left_w_dups</span><span class="s0">, </span><span class="s1">right_w_dups</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;one_to_many&quot;</span><span class="s1">)</span>

        <span class="s5"># Check invalid arguments</span>
        <span class="s1">msg = </span><span class="s3">&quot;Not a valid argument for validate&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;jibberish&quot;</span><span class="s1">)</span>

        <span class="s5"># Two column merge, dups in both, but jointly no dups.</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;weasel&quot;</span><span class="s0">, </span><span class="s3">&quot;horse&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">&quot;meow&quot;</span><span class="s0">, </span><span class="s3">&quot;bark&quot;</span><span class="s0">, </span><span class="s3">&quot;um... weasel noise?&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">expected_multi = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;weasel&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">&quot;meow&quot;</span><span class="s0">, </span><span class="s3">&quot;bark&quot;</span><span class="s0">, </span><span class="s3">&quot;um... weasel noise?&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">msg = (</span>
            <span class="s3">&quot;Merge keys are not unique in either left or right dataset; &quot;</span>
            <span class="s3">&quot;not a one-to-one merge&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;1:1&quot;</span><span class="s1">)</span>

        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">validate=</span><span class="s3">&quot;1:1&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected_multi)</span>

    <span class="s0">def </span><span class="s1">test_merge_two_empty_df_no_division_error(self):</span>
        <span class="s5"># GH17776, PR #17846</span>
        <span class="s1">a = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: []})</span>
        <span class="s0">with </span><span class="s1">np.errstate(divide=</span><span class="s3">&quot;raise&quot;</span><span class="s1">):</span>
            <span class="s1">merge(a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">on=(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;how&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s3">&quot;outer&quot;</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;index,expected_index&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s1">CategoricalIndex([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">CategoricalIndex([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, None, None, None</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">DatetimeIndex([</span><span class="s3">&quot;2001-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2002-02-02&quot;</span><span class="s0">, </span><span class="s3">&quot;2003-03-03&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">DatetimeIndex(</span>
                    <span class="s1">[</span><span class="s3">&quot;2001-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2002-02-02&quot;</span><span class="s0">, </span><span class="s3">&quot;2003-03-03&quot;</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">pd.NaT]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(Float64Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">Float64Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, None, None, None</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">(Int64Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">Float64Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, None, None, None</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">IntervalIndex.from_tuples([(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">IntervalIndex.from_tuples(</span>
                    <span class="s1">[(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">PeriodIndex([</span><span class="s3">&quot;2001-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2001-01-02&quot;</span><span class="s0">, </span><span class="s3">&quot;2001-01-03&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">PeriodIndex(</span>
                    <span class="s1">[</span><span class="s3">&quot;2001-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2001-01-02&quot;</span><span class="s0">, </span><span class="s3">&quot;2001-01-03&quot;</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">pd.NaT]</span><span class="s0">,</span>
                    <span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">TimedeltaIndex([</span><span class="s3">&quot;1d&quot;</span><span class="s0">, </span><span class="s3">&quot;2d&quot;</span><span class="s0">, </span><span class="s3">&quot;3d&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">TimedeltaIndex([</span><span class="s3">&quot;1d&quot;</span><span class="s0">, </span><span class="s3">&quot;2d&quot;</span><span class="s0">, </span><span class="s3">&quot;3d&quot;</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">pd.NaT</span><span class="s0">, </span><span class="s1">pd.NaT])</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_on_index_with_more_values(self</span><span class="s0">, </span><span class="s1">how</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">expected_index):</span>
        <span class="s5"># GH 24212</span>
        <span class="s5"># pd.merge gets [0, 1, 2, -1, -1, -1] as left_indexer, ensure that</span>
        <span class="s5"># -1 is interpreted as a missing value instead of the last element</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]})</span>
        <span class="s1">result = df1.merge(df2</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=how)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.set_index(expected_index</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_right_index_right(self):</span>
        <span class="s5"># Note: the expected output here is probably incorrect.</span>
        <span class="s5"># See https://github.com/pandas-dev/pandas/issues/17257 for more.</span>
        <span class="s5"># We include this as a regression test for GH-24897.</span>
        <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]})</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result = left.merge(right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;how&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_merge_preserves_row_order(self</span><span class="s0">, </span><span class="s1">how):</span>
        <span class="s5"># GH 27453</span>
        <span class="s1">left_df = DataFrame({</span><span class="s3">&quot;animal&quot;</span><span class="s1">: [</span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;pig&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;max_speed&quot;</span><span class="s1">: [</span><span class="s2">40</span><span class="s0">, </span><span class="s2">11</span><span class="s1">]})</span>
        <span class="s1">right_df = DataFrame({</span><span class="s3">&quot;animal&quot;</span><span class="s1">: [</span><span class="s3">&quot;quetzal&quot;</span><span class="s0">, </span><span class="s3">&quot;pig&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;max_speed&quot;</span><span class="s1">: [</span><span class="s2">80</span><span class="s0">, </span><span class="s2">11</span><span class="s1">]})</span>
        <span class="s1">result = left_df.merge(right_df</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;animal&quot;</span><span class="s0">, </span><span class="s3">&quot;max_speed&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">how=how)</span>
        <span class="s0">if </span><span class="s1">how == </span><span class="s3">&quot;right&quot;</span><span class="s1">:</span>
            <span class="s1">expected = DataFrame({</span><span class="s3">&quot;animal&quot;</span><span class="s1">: [</span><span class="s3">&quot;quetzal&quot;</span><span class="s0">, </span><span class="s3">&quot;pig&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;max_speed&quot;</span><span class="s1">: [</span><span class="s2">80</span><span class="s0">, </span><span class="s2">11</span><span class="s1">]})</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">expected = DataFrame({</span><span class="s3">&quot;animal&quot;</span><span class="s1">: [</span><span class="s3">&quot;dog&quot;</span><span class="s0">, </span><span class="s3">&quot;pig&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;max_speed&quot;</span><span class="s1">: [</span><span class="s2">40</span><span class="s0">, </span><span class="s2">11</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_take_missing_values_from_index_of_other_dtype(self):</span>
        <span class="s5"># GH 24212</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=list(</span><span class="s3">&quot;abc&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=CategoricalIndex([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]))</span>
        <span class="s1">result = left.merge(right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;key&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = expected.reindex(columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_readonly(self):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/27943</span>
        <span class="s1">data1 = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s2">20</span><span class="s1">).reshape((</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">)) + </span><span class="s2">1</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">data2 = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s2">20</span><span class="s1">).reshape((</span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)) + </span><span class="s2">1</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s5"># make each underlying block array / column array read-only</span>
        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">data1._mgr.arrays:</span>
            <span class="s1">arr.flags.writeable = </span><span class="s0">False</span>

        <span class="s1">data1.merge(data2)  </span><span class="s5"># no error</span>


<span class="s0">def </span><span class="s1">_check_merge(x</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">for </span><span class="s1">how </span><span class="s0">in </span><span class="s1">[</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;outer&quot;</span><span class="s1">]:</span>
        <span class="s1">result = x.join(y</span><span class="s0">, </span><span class="s1">how=how)</span>

        <span class="s1">expected = merge(x.reset_index()</span><span class="s0">, </span><span class="s1">y.reset_index()</span><span class="s0">, </span><span class="s1">how=how</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = expected.set_index(</span><span class="s3">&quot;index&quot;</span><span class="s1">)</span>

        <span class="s5"># TODO check_names on merge?</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestMergeDtypes:</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;right_vals&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Series([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]).astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)]</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_different(self</span><span class="s0">, </span><span class="s1">right_vals):</span>

        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]).astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;D&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;E&quot;</span><span class="s1">: Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;uint64&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;F&quot;</span><span class="s1">: Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int32&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: right_vals})</span>

        <span class="s5"># GH 9780</span>
        <span class="s5"># We allow merging on object and categorical cols and cast</span>
        <span class="s5"># categorical cols to object</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">is_object_dtype(result.A.dtype)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s1">[np.int64</span><span class="s0">, </span><span class="s1">np.int32</span><span class="s0">, </span><span class="s1">np.int16</span><span class="s0">, </span><span class="s1">np.int8</span><span class="s0">, </span><span class="s1">np.uint8])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;d2&quot;</span><span class="s0">, </span><span class="s1">[np.int64</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">np.float32</span><span class="s0">, </span><span class="s1">np.float16])</span>
    <span class="s0">def </span><span class="s1">test_join_multi_dtypes(self</span><span class="s0">, </span><span class="s1">d1</span><span class="s0">, </span><span class="s1">d2):</span>

        <span class="s1">dtype1 = np.dtype(d1)</span>
        <span class="s1">dtype2 = np.dtype(d2)</span>

        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;k1&quot;</span><span class="s1">: np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">] * </span><span class="s2">8</span><span class="s0">, </span><span class="s1">dtype=dtype1)</span><span class="s0">,</span>
                <span class="s3">&quot;k2&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">] * </span><span class="s2">12</span><span class="s0">,</span>
                <span class="s3">&quot;v&quot;</span><span class="s1">: np.array(np.arange(</span><span class="s2">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">index = MultiIndex.from_tuples([(</span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">)])</span>
        <span class="s1">right = DataFrame({</span><span class="s3">&quot;v2&quot;</span><span class="s1">: np.array([</span><span class="s2">5</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype2)}</span><span class="s0">, </span><span class="s1">index=index)</span>

        <span class="s1">result = left.join(right</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;k1&quot;</span><span class="s0">, </span><span class="s3">&quot;k2&quot;</span><span class="s1">])</span>

        <span class="s1">expected = left.copy()</span>

        <span class="s0">if </span><span class="s1">dtype2.kind == </span><span class="s3">&quot;i&quot;</span><span class="s1">:</span>
            <span class="s1">dtype2 = np.dtype(</span><span class="s3">&quot;float64&quot;</span><span class="s1">)</span>
        <span class="s1">expected[</span><span class="s3">&quot;v2&quot;</span><span class="s1">] = np.array(np.nan</span><span class="s0">, </span><span class="s1">dtype=dtype2)</span>
        <span class="s1">expected.loc[(expected.k1 == </span><span class="s2">2</span><span class="s1">) &amp; (expected.k2 == </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">] = </span><span class="s2">5</span>
        <span class="s1">expected.loc[(expected.k1 == </span><span class="s2">1</span><span class="s1">) &amp; (expected.k2 == </span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">] = </span><span class="s2">7</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = left.join(right</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;k1&quot;</span><span class="s0">, </span><span class="s3">&quot;k2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected.sort_values([</span><span class="s3">&quot;k1&quot;</span><span class="s0">, </span><span class="s3">&quot;k2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;mergesort&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;int_vals, float_vals, exp_vals&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]})</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_on_ints_floats(self</span><span class="s0">, </span><span class="s1">int_vals</span><span class="s0">, </span><span class="s1">float_vals</span><span class="s0">, </span><span class="s1">exp_vals):</span>
        <span class="s5"># GH 16572</span>
        <span class="s5"># Check that float column is not cast to object if</span>
        <span class="s5"># merging on float and int columns</span>
        <span class="s1">A = DataFrame({</span><span class="s3">&quot;X&quot;</span><span class="s1">: int_vals})</span>
        <span class="s1">B = DataFrame({</span><span class="s3">&quot;Y&quot;</span><span class="s1">: float_vals})</span>
        <span class="s1">expected = DataFrame(exp_vals)</span>

        <span class="s1">result = A.merge(B</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;Y&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = B.merge(A</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected[[</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_merge_key_dtype_cast(self):</span>
        <span class="s5"># GH 17044</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">])</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">: [</span><span class="s2">200</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">])</span>
        <span class="s1">result = df1.merge(df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">200.0</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s3">&quot;v1&quot;</span><span class="s0">, </span><span class="s3">&quot;v2&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_on_ints_floats_warning(self):</span>
        <span class="s5"># GH 16572</span>
        <span class="s5"># merge will produce a warning when merging on int and</span>
        <span class="s5"># float columns where the float values are not exactly</span>
        <span class="s5"># equal to their int representation</span>
        <span class="s1">A = DataFrame({</span><span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
        <span class="s1">B = DataFrame({</span><span class="s3">&quot;Y&quot;</span><span class="s1">: [</span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]})</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">: [</span><span class="s2">3.0</span><span class="s1">]})</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(UserWarning):</span>
            <span class="s1">result = A.merge(B</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;Y&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(UserWarning):</span>
            <span class="s1">result = B.merge(A</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected[[</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s1">]])</span>

        <span class="s5"># test no warning if float has NaNs</span>
        <span class="s1">B = DataFrame({</span><span class="s3">&quot;Y&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]})</span>

        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(</span><span class="s0">None</span><span class="s1">):</span>
            <span class="s1">result = B.merge(A</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected[[</span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_merge_incompat_infer_boolean_object(self):</span>
        <span class="s5"># GH21119: bool + object bool merge OK</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: Series([</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s0">True, False</span><span class="s1">]})</span>

        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s0">True, False</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">result = merge(df2</span><span class="s0">, </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_incompat_infer_boolean_object_with_missing(self):</span>
        <span class="s5"># GH21119: bool + object bool merge OK</span>
        <span class="s5"># with missing value</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: Series([</span><span class="s0">True, False, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">dtype=object)})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s0">True, False</span><span class="s1">]})</span>

        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s0">True, False</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=object)</span>
        <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">result = merge(df2</span><span class="s0">, </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;df1_vals, df2_vals&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s5"># merge on category coerces to object</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]).astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]).astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s5"># no not infer</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Series([</span><span class="s0">False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object))</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Series([</span><span class="s0">False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=bool))</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_incompat_dtypes_are_ok(self</span><span class="s0">, </span><span class="s1">df1_vals</span><span class="s0">, </span><span class="s1">df2_vals):</span>
        <span class="s5"># these are explicitly allowed incompat merges, that pass thru</span>
        <span class="s5"># the result type is dependent on if the values on the rhs are</span>
        <span class="s5"># inferred, otherwise these will be coerced to object</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: df1_vals})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: df2_vals})</span>

        <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">is_object_dtype(result.A.dtype)</span>
        <span class="s1">result = merge(df2</span><span class="s0">, </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">is_object_dtype(result.A.dtype)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;df1_vals, df2_vals&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s5"># do not infer to numeric</span>
            <span class="s1">(Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;uint64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int32&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">pd.date_range(</span><span class="s3">&quot;1/1/2011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;2011-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2011-01-02&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(pd.date_range(</span><span class="s3">&quot;1/1/2011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(pd.date_range(</span><span class="s3">&quot;1/1/2011&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">pd.date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">pd.date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_incompat_dtypes_error(self</span><span class="s0">, </span><span class="s1">df1_vals</span><span class="s0">, </span><span class="s1">df2_vals):</span>
        <span class="s5"># GH 9780, GH 15800</span>
        <span class="s5"># Raise a ValueError when a user tries to merge on</span>
        <span class="s5"># dtypes that are incompatible (e.g., obj and int/float)</span>

        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: df1_vals})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: df2_vals})</span>

        <span class="s1">msg = (</span>
            <span class="s3">f&quot;You are trying to merge on </span><span class="s0">{</span><span class="s1">df1[</span><span class="s3">'A'</span><span class="s1">].dtype</span><span class="s0">} </span><span class="s3">and &quot;</span>
            <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">df2[</span><span class="s3">'A'</span><span class="s1">].dtype</span><span class="s0">} </span><span class="s3">columns. If you wish to proceed &quot;</span>
            <span class="s3">&quot;you should use pd.concat&quot;</span>
        <span class="s1">)</span>
        <span class="s1">msg = re.escape(msg)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;A&quot;</span><span class="s1">])</span>

        <span class="s5"># Check that error still raised when swapping order of dataframes</span>
        <span class="s1">msg = (</span>
            <span class="s3">f&quot;You are trying to merge on </span><span class="s0">{</span><span class="s1">df2[</span><span class="s3">'A'</span><span class="s1">].dtype</span><span class="s0">} </span><span class="s3">and &quot;</span>
            <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">df1[</span><span class="s3">'A'</span><span class="s1">].dtype</span><span class="s0">} </span><span class="s3">columns. If you wish to proceed &quot;</span>
            <span class="s3">&quot;you should use pd.concat&quot;</span>
        <span class="s1">)</span>
        <span class="s1">msg = re.escape(msg)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">merge(df2</span><span class="s0">, </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;A&quot;</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;expected_data, how&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([]</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_EA_dtype(self</span><span class="s0">, </span><span class="s1">any_numeric_ea_dtype</span><span class="s0">, </span><span class="s1">how</span><span class="s0">, </span><span class="s1">expected_data):</span>
        <span class="s5"># GH#40073</span>
        <span class="s1">d1 = DataFrame([(</span><span class="s2">1</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;id&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=any_numeric_ea_dtype)</span>
        <span class="s1">d2 = DataFrame([(</span><span class="s2">2</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;id&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=any_numeric_ea_dtype)</span>
        <span class="s1">result = merge(d1</span><span class="s0">, </span><span class="s1">d2</span><span class="s0">, </span><span class="s1">how=how)</span>
        <span class="s1">expected = DataFrame(expected_data</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;id&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=any_numeric_ea_dtype)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;expected_data, how&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([]</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_string_dtype(self</span><span class="s0">, </span><span class="s1">how</span><span class="s0">, </span><span class="s1">expected_data</span><span class="s0">, </span><span class="s1">any_string_dtype):</span>
        <span class="s5"># GH#40073</span>
        <span class="s1">d1 = DataFrame([(</span><span class="s3">&quot;a&quot;</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;id&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=any_string_dtype)</span>
        <span class="s1">d2 = DataFrame([(</span><span class="s3">&quot;b&quot;</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;id&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=any_string_dtype)</span>
        <span class="s1">result = merge(d1</span><span class="s0">, </span><span class="s1">d2</span><span class="s0">, </span><span class="s1">how=how)</span>
        <span class="s1">expected = DataFrame(expected_data</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;id&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=any_string_dtype)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;how, expected_data&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s0">True, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s0">True, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s0">True, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s0">False, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_bool_dtype(self</span><span class="s0">, </span><span class="s1">how</span><span class="s0">, </span><span class="s1">expected_data):</span>
        <span class="s5"># GH#40073</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]})</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s0">False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]})</span>
        <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=how)</span>
        <span class="s1">expected = DataFrame(expected_data</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_ea_with_string(self</span><span class="s0">, </span><span class="s1">join_type</span><span class="s0">, </span><span class="s1">string_dtype):</span>
        <span class="s5"># GH 43734 Avoid the use of `assign` with multi-index</span>
        <span class="s1">df1 = DataFrame(</span>
            <span class="s1">data={</span>
                <span class="s1">(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-a&quot;</span><span class="s1">): [</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;3&quot;</span><span class="s0">, </span><span class="s3">&quot;4&quot;</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-b&quot;</span><span class="s1">): [</span><span class="s3">&quot;4&quot;</span><span class="s0">, </span><span class="s3">&quot;5&quot;</span><span class="s0">, </span><span class="s3">&quot;6&quot;</span><span class="s0">, </span><span class="s3">&quot;7&quot;</span><span class="s0">, </span><span class="s3">&quot;8&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">dtype=pd.StringDtype()</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df1_copy = df1.copy()</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">data={</span>
                <span class="s1">(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-a&quot;</span><span class="s1">): [</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;3&quot;</span><span class="s0">, </span><span class="s1">pd.NA</span><span class="s0">, </span><span class="s3">&quot;5&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-c&quot;</span><span class="s1">): [</span><span class="s3">&quot;7&quot;</span><span class="s0">, </span><span class="s3">&quot;8&quot;</span><span class="s0">, </span><span class="s3">&quot;9&quot;</span><span class="s0">, </span><span class="s1">pd.NA</span><span class="s0">, </span><span class="s3">&quot;11&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">dtype=string_dtype</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df2_copy = df2.copy()</span>
        <span class="s1">merged = merge(left=df1</span><span class="s0">, </span><span class="s1">right=df2</span><span class="s0">, </span><span class="s1">on=[(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-a&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">how=join_type)</span>

        <span class="s5"># No change in df1 and df2</span>
        <span class="s1">tm.assert_frame_equal(df1</span><span class="s0">, </span><span class="s1">df1_copy)</span>
        <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">df2_copy)</span>

        <span class="s5"># Check the expected types for the merged data frame</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.StringDtype()</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_tuples(</span>
                <span class="s1">[(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;lvl0&quot;</span><span class="s0">, </span><span class="s3">&quot;lvl1-c&quot;</span><span class="s1">)]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(merged.dtypes</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">left():</span>
    <span class="s1">np.random.seed(</span><span class="s2">1234</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;X&quot;</span><span class="s1">: Series(np.random.choice([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=(</span><span class="s2">10</span><span class="s0">,</span><span class="s1">))).astype(</span>
                <span class="s1">CDT([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">])</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;Y&quot;</span><span class="s1">: np.random.choice([</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;three&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=(</span><span class="s2">10</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">right():</span>
    <span class="s1">np.random.seed(</span><span class="s2">1234</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;X&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]).astype(CDT([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]))</span><span class="s0">, </span><span class="s3">&quot;Z&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span>
    <span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestMergeCategorical:</span>
    <span class="s0">def </span><span class="s1">test_identical(self</span><span class="s0">, </span><span class="s1">left):</span>
        <span class="s5"># merging on the same, should preserve dtypes</span>
        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
        <span class="s1">result = merged.dtypes.sort_index()</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[CategoricalDtype(categories=[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y_x&quot;</span><span class="s0">, </span><span class="s3">&quot;Y_y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_basic(self</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">right):</span>
        <span class="s5"># we have matching Categorical dtypes in X</span>
        <span class="s5"># so should preserve the merged column</span>
        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
        <span class="s1">result = merged.dtypes.sort_index()</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[</span>
                <span class="s1">CategoricalDtype(categories=[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">np.dtype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;Z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_merge_categorical(self):</span>
        <span class="s5"># GH 9426</span>

        <span class="s1">right = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s3">&quot;e&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;null&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;null&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;null&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s3">&quot;null&quot;</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s3">&quot;null&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s3">&quot;f&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s3">&quot;g&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>

        <span class="s5"># object-object</span>
        <span class="s1">expected = df.copy()</span>

        <span class="s5"># object-cat</span>
        <span class="s5"># note that we propagate the category</span>
        <span class="s5"># because we don't have any matching rows</span>
        <span class="s1">cright = right.copy()</span>
        <span class="s1">cright[</span><span class="s3">&quot;d&quot;</span><span class="s1">] = cright[</span><span class="s3">&quot;d&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">cright</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">expected[</span><span class="s3">&quot;d&quot;</span><span class="s1">] = expected[</span><span class="s3">&quot;d&quot;</span><span class="s1">].astype(CategoricalDtype([</span><span class="s3">&quot;null&quot;</span><span class="s1">]))</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># cat-object</span>
        <span class="s1">cleft = left.copy()</span>
        <span class="s1">cleft[</span><span class="s3">&quot;b&quot;</span><span class="s1">] = cleft[</span><span class="s3">&quot;b&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">result = merge(cleft</span><span class="s0">, </span><span class="s1">cright</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># cat-cat</span>
        <span class="s1">cright = right.copy()</span>
        <span class="s1">cright[</span><span class="s3">&quot;d&quot;</span><span class="s1">] = cright[</span><span class="s3">&quot;d&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">cleft = left.copy()</span>
        <span class="s1">cleft[</span><span class="s3">&quot;b&quot;</span><span class="s1">] = cleft[</span><span class="s3">&quot;b&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">result = merge(cleft</span><span class="s0">, </span><span class="s1">cright</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">tests_merge_categorical_unordered_equal(self):</span>
        <span class="s5"># GH-19551</span>
        <span class="s1">df1 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Foo&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;Left&quot;</span><span class="s1">: [</span><span class="s3">&quot;A0&quot;</span><span class="s0">, </span><span class="s3">&quot;B0&quot;</span><span class="s0">, </span><span class="s3">&quot;C0&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Foo&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;Right&quot;</span><span class="s1">: [</span><span class="s3">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">&quot;B1&quot;</span><span class="s0">, </span><span class="s3">&quot;A1&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;Foo&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Foo&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s3">&quot;Left&quot;</span><span class="s1">: [</span><span class="s3">&quot;A0&quot;</span><span class="s0">, </span><span class="s3">&quot;B0&quot;</span><span class="s0">, </span><span class="s3">&quot;C0&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Right&quot;</span><span class="s1">: [</span><span class="s3">&quot;A1&quot;</span><span class="s0">, </span><span class="s3">&quot;B1&quot;</span><span class="s0">, </span><span class="s3">&quot;C1&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;ordered&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_multiindex_merge_with_unordered_categoricalindex(self</span><span class="s0">, </span><span class="s1">ordered):</span>
        <span class="s5"># GH 36973</span>
        <span class="s1">pcat = CategoricalDtype(categories=[</span><span class="s3">&quot;P2&quot;</span><span class="s0">, </span><span class="s3">&quot;P1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=ordered)</span>
        <span class="s1">df1 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;P2&quot;</span><span class="s0">, </span><span class="s3">&quot;P1&quot;</span><span class="s0">, </span><span class="s3">&quot;P2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=pcat)</span><span class="s0">,</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">).set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;p&quot;</span><span class="s1">])</span>
        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;P2&quot;</span><span class="s0">, </span><span class="s3">&quot;P2&quot;</span><span class="s0">, </span><span class="s3">&quot;P1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=pcat)</span><span class="s0">,</span>
                <span class="s3">&quot;d1&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">).set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;p&quot;</span><span class="s1">])</span>
        <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;P2&quot;</span><span class="s0">, </span><span class="s3">&quot;P1&quot;</span><span class="s0">, </span><span class="s3">&quot;P2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=pcat)</span><span class="s0">,</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;d1&quot;</span><span class="s1">: [</span><span class="s2">11.0</span><span class="s0">, </span><span class="s2">12.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">).set_index([</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;p&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_other_columns(self</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">right):</span>
        <span class="s5"># non-merge columns should preserve if possible</span>
        <span class="s1">right = right.assign(Z=right.Z.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">))</span>

        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
        <span class="s1">result = merged.dtypes.sort_index()</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[</span>
                <span class="s1">CategoricalDtype(categories=[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">CategoricalDtype(categories=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;Z&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># categories are preserved</span>
        <span class="s0">assert </span><span class="s1">left.X.values._categories_match_up_to_permutation(merged.X.values)</span>
        <span class="s0">assert </span><span class="s1">right.Z.values._categories_match_up_to_permutation(merged.Z.values)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;change&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: x.astype(CDT([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bah&quot;</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: x.astype(CDT(ordered=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_dtype_on_merged_different(self</span><span class="s0">, </span><span class="s1">change</span><span class="s0">, </span><span class="s1">join_type</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">right):</span>
        <span class="s5"># our merging columns, X now has 2 different dtypes</span>
        <span class="s5"># so we must be object as a result</span>

        <span class="s1">X = change(right.X.astype(</span><span class="s3">&quot;object&quot;</span><span class="s1">))</span>
        <span class="s1">right = right.assign(X=X)</span>
        <span class="s0">assert </span><span class="s1">is_categorical_dtype(left.X.values.dtype)</span>
        <span class="s5"># assert not left.X.values._categories_match_up_to_permutation(right.X.values)</span>

        <span class="s1">merged = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s1">how=join_type)</span>

        <span class="s1">result = merged.dtypes.sort_index()</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">&quot;O&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;Z&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_self_join_multiple_categories(self):</span>
        <span class="s5"># GH 16767</span>
        <span class="s5"># non-duplicates should work with multiple categories</span>
        <span class="s1">m = </span><span class="s2">5</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s3">&quot;j&quot;</span><span class="s1">] * m</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;t&quot;</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">] * </span><span class="s2">2 </span><span class="s1">* m</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span>
                    <span class="s1">letter</span>
                    <span class="s0">for </span><span class="s1">each </span><span class="s0">in </span><span class="s1">[</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s3">&quot;n&quot;</span><span class="s0">, </span><span class="s3">&quot;u&quot;</span><span class="s0">, </span><span class="s3">&quot;p&quot;</span><span class="s0">, </span><span class="s3">&quot;o&quot;</span><span class="s1">]</span>
                    <span class="s0">for </span><span class="s1">letter </span><span class="s0">in </span><span class="s1">[each] * </span><span class="s2">2 </span><span class="s1">* m</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s1">: [</span>
                    <span class="s1">letter</span>
                    <span class="s0">for </span><span class="s1">each </span><span class="s0">in </span><span class="s1">[</span>
                        <span class="s3">&quot;aa&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;bb&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;cc&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;dd&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;ee&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;ff&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;gg&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;hh&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;ii&quot;</span><span class="s0">,</span>
                        <span class="s3">&quot;jj&quot;</span><span class="s0">,</span>
                    <span class="s1">]</span>
                    <span class="s0">for </span><span class="s1">letter </span><span class="s0">in </span><span class="s1">[each] * m</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s5"># change them all to categorical variables</span>
        <span class="s1">df = df.apply(</span><span class="s0">lambda </span><span class="s1">x: x.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">))</span>

        <span class="s5"># self-join should equal ourselves</span>
        <span class="s1">result = merge(df</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">on=list(df.columns))</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s0">def </span><span class="s1">test_dtype_on_categorical_dates(self):</span>
        <span class="s5"># GH 16900</span>
        <span class="s5"># dates should not be coerced to ints</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[date(</span><span class="s2">2001</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s2">1.1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[date(</span><span class="s2">2001</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s2">1.3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;num2&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;date&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;date&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>

        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">[[date(</span><span class="s2">2001</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s2">1.3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[date(</span><span class="s2">2001</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s2">1.4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;num4&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df2[</span><span class="s3">&quot;date&quot;</span><span class="s1">] = df2[</span><span class="s3">&quot;date&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>

        <span class="s1">expected_outer = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[pd.Timestamp(</span><span class="s3">&quot;2001-01-01&quot;</span><span class="s1">).date()</span><span class="s0">, </span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[pd.Timestamp(</span><span class="s3">&quot;2001-01-02&quot;</span><span class="s1">).date()</span><span class="s0">, </span><span class="s2">1.3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[pd.Timestamp(</span><span class="s3">&quot;2001-01-03&quot;</span><span class="s1">).date()</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1.4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;num2&quot;</span><span class="s0">, </span><span class="s3">&quot;num4&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result_outer = merge(df</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;date&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result_outer</span><span class="s0">, </span><span class="s1">expected_outer)</span>

        <span class="s1">expected_inner = DataFrame(</span>
            <span class="s1">[[pd.Timestamp(</span><span class="s3">&quot;2001-01-01&quot;</span><span class="s1">).date()</span><span class="s0">, </span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.3</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;date&quot;</span><span class="s0">, </span><span class="s3">&quot;num2&quot;</span><span class="s0">, </span><span class="s3">&quot;num4&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">result_inner = merge(df</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;date&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result_inner</span><span class="s0">, </span><span class="s1">expected_inner)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;ordered&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;category_column,categories,expected_categories&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s0">False, True, True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">&quot;False&quot;</span><span class="s0">, </span><span class="s3">&quot;True&quot;</span><span class="s0">, </span><span class="s3">&quot;True&quot;</span><span class="s0">, </span><span class="s3">&quot;False&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;True&quot;</span><span class="s0">, </span><span class="s3">&quot;False&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;True&quot;</span><span class="s0">, </span><span class="s3">&quot;False&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merging_with_bool_or_int_cateorical_column(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">category_column</span><span class="s0">, </span><span class="s1">categories</span><span class="s0">, </span><span class="s1">expected_categories</span><span class="s0">, </span><span class="s1">ordered</span>
    <span class="s1">):</span>
        <span class="s5"># GH 17187</span>
        <span class="s5"># merging with a boolean/int categorical column</span>
        <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;cat&quot;</span><span class="s1">: category_column})</span>
        <span class="s1">df1[</span><span class="s3">&quot;cat&quot;</span><span class="s1">] = df1[</span><span class="s3">&quot;cat&quot;</span><span class="s1">].astype(CDT(categories</span><span class="s0">, </span><span class="s1">ordered=ordered))</span>
        <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;num&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]})</span>
        <span class="s1">result = df1.merge(df2)</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;cat&quot;</span><span class="s1">: expected_categories</span><span class="s0">, </span><span class="s3">&quot;num&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]})</span>
        <span class="s1">expected[</span><span class="s3">&quot;cat&quot;</span><span class="s1">] = expected[</span><span class="s3">&quot;cat&quot;</span><span class="s1">].astype(CDT(categories</span><span class="s0">, </span><span class="s1">ordered=ordered))</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s0">def </span><span class="s1">test_merge_on_int_array(self):</span>
        <span class="s5"># GH 23020</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s1">result = merge(df</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B_x&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;B_y&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">left_df():</span>
    <span class="s0">return </span><span class="s1">DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">right_df():</span>
    <span class="s0">return </span><span class="s1">DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">300</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>


<span class="s0">class </span><span class="s1">TestMergeOnIndexes:</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;how, sort, expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s3">&quot;inner&quot;</span><span class="s0">, False, </span><span class="s1">DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">200</span><span class="s0">, </span><span class="s2">100</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;inner&quot;</span><span class="s0">, True, </span><span class="s1">DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]))</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s3">&quot;left&quot;</span><span class="s0">,</span>
                <span class="s0">False,</span>
                <span class="s1">DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">200</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s1">np.nan]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s3">&quot;left&quot;</span><span class="s0">,</span>
                <span class="s0">True,</span>
                <span class="s1">DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s3">&quot;right&quot;</span><span class="s0">,</span>
                <span class="s0">False,</span>
                <span class="s1">DataFrame(</span>
                    <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">300</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s3">&quot;right&quot;</span><span class="s0">,</span>
                <span class="s0">True,</span>
                <span class="s1">DataFrame(</span>
                    <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s3">&quot;outer&quot;</span><span class="s0">,</span>
                <span class="s0">False,</span>
                <span class="s1">DataFrame(</span>
                    <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]}</span><span class="s0">,</span>
                    <span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s3">&quot;outer&quot;</span><span class="s0">,</span>
                <span class="s0">True,</span>
                <span class="s1">DataFrame(</span>
                    <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]}</span><span class="s0">,</span>
                    <span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_merge_on_indexes(self</span><span class="s0">, </span><span class="s1">left_df</span><span class="s0">, </span><span class="s1">right_df</span><span class="s0">, </span><span class="s1">how</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">expected):</span>
        <span class="s1">result = merge(</span>
            <span class="s1">left_df</span><span class="s0">, </span><span class="s1">right_df</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">how=how</span><span class="s0">, </span><span class="s1">sort=sort</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;index&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">CategoricalIndex([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;index_col&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Float64Index([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;index_col&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">Int64Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;index_col&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">UInt64Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;index_col&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">RangeIndex(start=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">stop=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;index_col&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">DatetimeIndex([</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2018-01-02&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;index_col&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">ids=</span><span class="s0">lambda </span><span class="s1">x: type(x).__name__</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_index_types(index):</span>
    <span class="s5"># gh-20777</span>
    <span class="s5"># assert key access is consistent across index types</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;left_data&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;right_data&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>

    <span class="s1">result = left.merge(right</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;index_col&quot;</span><span class="s1">])</span>

    <span class="s1">expected = DataFrame({</span><span class="s3">&quot;left_data&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;right_data&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;on,left_on,right_on,left_index,right_index,nm&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">]</span><span class="s0">, None, None, False, False, </span><span class="s3">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, None, None, True, True, </span><span class="s3">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, </span><span class="s1">[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">]</span><span class="s0">, None, False, True, </span><span class="s3">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, None, </span><span class="s1">[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">]</span><span class="s0">, True, False, </span><span class="s3">&quot;B&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">]</span><span class="s0">, None, None, False, False, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, None, None, True, True, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, </span><span class="s1">[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">]</span><span class="s0">, None, False, True, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, None, </span><span class="s1">[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">]</span><span class="s0">, True, False, None</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_series(on</span><span class="s0">, </span><span class="s1">left_on</span><span class="s0">, </span><span class="s1">right_on</span><span class="s0">, </span><span class="s1">left_index</span><span class="s0">, </span><span class="s1">right_index</span><span class="s0">, </span><span class="s1">nm):</span>
    <span class="s5"># GH 21220</span>
    <span class="s1">a = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_product([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">b = Series(</span>
        <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_product([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">name=nm</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_product([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">if </span><span class="s1">nm </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">result = merge(</span>
            <span class="s1">a</span><span class="s0">,</span>
            <span class="s1">b</span><span class="s0">,</span>
            <span class="s1">on=on</span><span class="s0">,</span>
            <span class="s1">left_on=left_on</span><span class="s0">,</span>
            <span class="s1">right_on=right_on</span><span class="s0">,</span>
            <span class="s1">left_index=left_index</span><span class="s0">,</span>
            <span class="s1">right_index=right_index</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">msg = </span><span class="s3">&quot;Cannot merge a Series without a name&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">result = merge(</span>
                <span class="s1">a</span><span class="s0">,</span>
                <span class="s1">b</span><span class="s0">,</span>
                <span class="s1">on=on</span><span class="s0">,</span>
                <span class="s1">left_on=left_on</span><span class="s0">,</span>
                <span class="s1">right_on=right_on</span><span class="s0">,</span>
                <span class="s1">left_index=left_index</span><span class="s0">,</span>
                <span class="s1">right_index=right_index</span><span class="s0">,</span>
            <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;col1, col2, kwargs, expected_cols&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s3">&quot;_dup&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0&quot;</span><span class="s0">, </span><span class="s3">&quot;0_dup&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s0">None, </span><span class="s3">&quot;_dup&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;0_dup&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s3">&quot;_x&quot;</span><span class="s0">, </span><span class="s3">&quot;_y&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0_x&quot;</span><span class="s0">, </span><span class="s3">&quot;0_y&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: [</span><span class="s3">&quot;_x&quot;</span><span class="s0">, </span><span class="s3">&quot;_y&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0_x&quot;</span><span class="s0">, </span><span class="s3">&quot;0_y&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s0">None, </span><span class="s3">&quot;_y&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s3">&quot;_x&quot;</span><span class="s0">, None</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0.0_x&quot;</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s0">None, </span><span class="s3">&quot;_y&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b_y&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s3">&quot;_x&quot;</span><span class="s0">, None</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a_x&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s3">&quot;_x&quot;</span><span class="s0">, None</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s0">None, </span><span class="s3">&quot;_x&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a_x&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;suffixes&quot;</span><span class="s1">: (</span><span class="s3">&quot;_a&quot;</span><span class="s0">, None</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0_a&quot;</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">{}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a_x&quot;</span><span class="s0">, </span><span class="s3">&quot;a_y&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">{}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;0_x&quot;</span><span class="s0">, </span><span class="s3">&quot;0_y&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_suffix(col1</span><span class="s0">, </span><span class="s1">col2</span><span class="s0">, </span><span class="s1">kwargs</span><span class="s0">, </span><span class="s1">expected_cols):</span>
    <span class="s5"># issue: 24782</span>
    <span class="s1">a = DataFrame({col1: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
    <span class="s1">b = DataFrame({col2: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]})</span>

    <span class="s1">expected = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=expected_cols)</span>

    <span class="s1">result = a.merge(b</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = merge(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;how,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s3">&quot;right&quot;</span><span class="s0">,</span>
            <span class="s1">DataFrame(</span>
                <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B1&quot;</span><span class="s1">: [</span><span class="s2">60</span><span class="s0">, </span><span class="s2">70</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s3">&quot;B2&quot;</span><span class="s1">: [</span><span class="s2">600</span><span class="s0">, </span><span class="s2">700</span><span class="s0">, </span><span class="s2">800</span><span class="s1">]}</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s3">&quot;outer&quot;</span><span class="s0">,</span>
            <span class="s1">DataFrame(</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s3">&quot;B1&quot;</span><span class="s1">: [</span><span class="s2">60</span><span class="s0">, </span><span class="s2">70</span><span class="s0">, </span><span class="s2">80</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                    <span class="s3">&quot;B2&quot;</span><span class="s1">: [</span><span class="s2">600</span><span class="s0">, </span><span class="s2">700</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">800</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">}</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_duplicate_suffix(how</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">left_df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">60</span><span class="s0">, </span><span class="s2">70</span><span class="s0">, </span><span class="s2">80</span><span class="s1">]})</span>
    <span class="s1">right_df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">600</span><span class="s0">, </span><span class="s2">700</span><span class="s0">, </span><span class="s2">800</span><span class="s1">]})</span>
    <span class="s1">result = merge(left_df</span><span class="s0">, </span><span class="s1">right_df</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">how=how</span><span class="s0">, </span><span class="s1">suffixes=(</span><span class="s3">&quot;_x&quot;</span><span class="s0">, </span><span class="s3">&quot;_x&quot;</span><span class="s1">))</span>
    <span class="s1">expected.columns = [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B_x&quot;</span><span class="s0">, </span><span class="s3">&quot;B_x&quot;</span><span class="s1">]</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;col1, col2, suffixes&quot;</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;&quot;</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s3">&quot;&quot;</span><span class="s1">))]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_suffix_error(col1</span><span class="s0">, </span><span class="s1">col2</span><span class="s0">, </span><span class="s1">suffixes):</span>
    <span class="s5"># issue: 24782</span>
    <span class="s1">a = DataFrame({col1: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
    <span class="s1">b = DataFrame({col2: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]})</span>

    <span class="s5"># TODO: might reconsider current raise behaviour, see issue 24782</span>
    <span class="s1">msg = </span><span class="s3">&quot;columns overlap but no suffix specified&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">merge(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">suffixes=suffixes)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;suffixes&quot;</span><span class="s0">, </span><span class="s1">[{</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;left&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s1">}])</span>
<span class="s0">def </span><span class="s1">test_merge_suffix_warns(suffixes):</span>
    <span class="s1">a = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
    <span class="s1">b = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]})</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
        <span class="s1">merge(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">suffixes={</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">})</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;col1, col2, suffixes, msg&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">r&quot;too many values to unpack \(expected 2\)&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">tuple(</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">r&quot;not enough values to unpack \(expected 2, got 1\)&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_suffix_length_error(col1</span><span class="s0">, </span><span class="s1">col2</span><span class="s0">, </span><span class="s1">suffixes</span><span class="s0">, </span><span class="s1">msg):</span>
    <span class="s1">a = DataFrame({col1: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
    <span class="s1">b = DataFrame({col2: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]})</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">merge(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True, </span><span class="s1">suffixes=suffixes)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;cat_dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;reverse&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_merge_equal_cat_dtypes(cat_dtype</span><span class="s0">, </span><span class="s1">reverse):</span>
    <span class="s5"># see gh-22501</span>
    <span class="s1">cat_dtypes = {</span>
        <span class="s3">&quot;one&quot;</span><span class="s1">: CategoricalDtype(categories=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;two&quot;</span><span class="s1">: CategoricalDtype(categories=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">df1 = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;foo&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]).astype(cat_dtypes[</span><span class="s3">&quot;one&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span>
    <span class="s1">).set_index(</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s1">data_foo = [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
    <span class="s1">data_right = [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span>

    <span class="s0">if </span><span class="s1">reverse:</span>
        <span class="s1">data_foo.reverse()</span>
        <span class="s1">data_right.reverse()</span>

    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;foo&quot;</span><span class="s1">: Series(data_foo).astype(cat_dtypes[cat_dtype])</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">: data_right}</span>
    <span class="s1">).set_index(</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s1">result = df1.merge(df2</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;left&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;right&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;foo&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]).astype(cat_dtypes[</span><span class="s3">&quot;one&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">).set_index(</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_equal_cat_dtypes2():</span>
    <span class="s5"># see gh-22501</span>
    <span class="s1">cat_dtype = CategoricalDtype(categories=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s5"># Test Data</span>
    <span class="s1">df1 = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;foo&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]).astype(cat_dtype)</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span>
    <span class="s1">).set_index(</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;foo&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]).astype(cat_dtype)</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]}</span>
    <span class="s1">).set_index(</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s1">result = df1.merge(df2</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;left&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]).astype(cat_dtype)}</span>
    <span class="s1">).set_index(</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_on_cat_and_ext_array():</span>
    <span class="s5"># GH 28668</span>
    <span class="s1">right = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: Series([pd.Interval(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Interval(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;interval&quot;</span><span class="s1">)}</span>
    <span class="s1">)</span>
    <span class="s1">left = right.copy()</span>
    <span class="s1">left[</span><span class="s3">&quot;a&quot;</span><span class="s1">] = left[</span><span class="s3">&quot;a&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>

    <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = right.copy()</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_multiindex_columns():</span>
    <span class="s5"># Issue #28518</span>
    <span class="s5"># Verify that merging two dataframes give the expected labels</span>
    <span class="s5"># The original cause of this issue come from a bug lexsort_depth and is tested in</span>
    <span class="s5"># test_lexsort_depth</span>

    <span class="s1">letters = [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span>
    <span class="s1">numbers = [</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;3&quot;</span><span class="s1">]</span>
    <span class="s1">index = MultiIndex.from_product((letters</span><span class="s0">, </span><span class="s1">numbers)</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">])</span>

    <span class="s1">frame_x = DataFrame(columns=index)</span>
    <span class="s1">frame_x[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = </span><span class="s3">&quot;&quot;</span>
    <span class="s1">frame_y = DataFrame(columns=index)</span>
    <span class="s1">frame_y[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = </span><span class="s3">&quot;&quot;</span>

    <span class="s1">l_suf = </span><span class="s3">&quot;_x&quot;</span>
    <span class="s1">r_suf = </span><span class="s3">&quot;_y&quot;</span>
    <span class="s1">result = frame_x.merge(frame_y</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">suffixes=((l_suf</span><span class="s0">, </span><span class="s1">r_suf)))</span>

    <span class="s5"># Constructing the expected results</span>
    <span class="s1">expected_labels = [letter + l_suf </span><span class="s0">for </span><span class="s1">letter </span><span class="s0">in </span><span class="s1">letters] + [</span>
        <span class="s1">letter + r_suf </span><span class="s0">for </span><span class="s1">letter </span><span class="s0">in </span><span class="s1">letters</span>
    <span class="s1">]</span>
    <span class="s1">expected_index = MultiIndex.from_product(</span>
        <span class="s1">[expected_labels</span><span class="s0">, </span><span class="s1">numbers]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;outer&quot;</span><span class="s0">, </span><span class="s3">&quot;inner&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(columns=expected_index)</span>
    <span class="s1">expected[</span><span class="s3">&quot;id&quot;</span><span class="s1">] = </span><span class="s3">&quot;&quot;</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_datetime_upcast_dtype():</span>
    <span class="s5"># https://github.com/pandas-dev/pandas/issues/31208</span>
    <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;4&quot;</span><span class="s1">]})</span>
    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;3&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: pd.to_datetime([</span><span class="s3">&quot;2000&quot;</span><span class="s0">, </span><span class="s3">&quot;2001&quot;</span><span class="s0">, </span><span class="s3">&quot;2002&quot;</span><span class="s1">])}</span>
    <span class="s1">)</span>
    <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;y&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;4&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;z&quot;</span><span class="s1">: pd.to_datetime([</span><span class="s3">&quot;2000&quot;</span><span class="s0">, </span><span class="s3">&quot;2001&quot;</span><span class="s0">, </span><span class="s3">&quot;NaT&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;n_categories&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">128</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_categorical_non_unique_monotonic(n_categories):</span>
    <span class="s5"># GH 28189</span>
    <span class="s5"># With n_categories as 5, we test the int8 case is hit in libjoin,</span>
    <span class="s5"># with n_categories as 128 we test the int16 case.</span>
    <span class="s1">left_index = CategoricalIndex([</span><span class="s2">0</span><span class="s1">] + list(range(n_categories)))</span>
    <span class="s1">df1 = DataFrame(range(n_categories + </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=left_index)</span>
    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">[[</span><span class="s2">6</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;value&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=CategoricalIndex([</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=np.arange(n_categories))</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[i</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">] </span><span class="s0">if </span><span class="s1">i &lt; </span><span class="s2">2 </span><span class="s0">else </span><span class="s1">[i</span><span class="s0">, </span><span class="s1">np.nan] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(n_categories + </span><span class="s2">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;value_x&quot;</span><span class="s0">, </span><span class="s3">&quot;value_y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=left_index</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_merge_join_categorical_multiindex():</span>
    <span class="s5"># From issue 16627</span>
    <span class="s1">a = {</span>
        <span class="s3">&quot;Cat1&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s3">&quot;Int1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">a = DataFrame(a)</span>

    <span class="s1">b = {</span>
        <span class="s3">&quot;Cat&quot;</span><span class="s1">: Categorical([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s3">&quot;Int&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s3">&quot;Factor&quot;</span><span class="s1">: [</span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">1.4</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">1.6</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">b = DataFrame(b).set_index([</span><span class="s3">&quot;Cat&quot;</span><span class="s0">, </span><span class="s3">&quot;Int&quot;</span><span class="s1">])[</span><span class="s3">&quot;Factor&quot;</span><span class="s1">]</span>

    <span class="s1">expected = merge(</span>
        <span class="s1">a</span><span class="s0">,</span>
        <span class="s1">b.reset_index()</span><span class="s0">,</span>
        <span class="s1">left_on=[</span><span class="s3">&quot;Cat1&quot;</span><span class="s0">, </span><span class="s3">&quot;Int1&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">right_on=[</span><span class="s3">&quot;Cat&quot;</span><span class="s0">, </span><span class="s3">&quot;Int&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = expected.drop([</span><span class="s3">&quot;Cat&quot;</span><span class="s0">, </span><span class="s3">&quot;Int&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">result = a.join(b</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;Cat1&quot;</span><span class="s0">, </span><span class="s3">&quot;Int1&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s5"># Same test, but with ordered categorical</span>
    <span class="s1">a = {</span>
        <span class="s3">&quot;Cat1&quot;</span><span class="s1">: Categorical(</span>
            <span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;Int1&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">a = DataFrame(a)</span>

    <span class="s1">b = {</span>
        <span class="s3">&quot;Cat&quot;</span><span class="s1">: Categorical(</span>
            <span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;Int&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s3">&quot;Factor&quot;</span><span class="s1">: [</span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.2</span><span class="s0">, </span><span class="s2">1.3</span><span class="s0">, </span><span class="s2">1.4</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">1.6</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">b = DataFrame(b).set_index([</span><span class="s3">&quot;Cat&quot;</span><span class="s0">, </span><span class="s3">&quot;Int&quot;</span><span class="s1">])[</span><span class="s3">&quot;Factor&quot;</span><span class="s1">]</span>

    <span class="s1">expected = merge(</span>
        <span class="s1">a</span><span class="s0">,</span>
        <span class="s1">b.reset_index()</span><span class="s0">,</span>
        <span class="s1">left_on=[</span><span class="s3">&quot;Cat1&quot;</span><span class="s0">, </span><span class="s3">&quot;Int1&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">right_on=[</span><span class="s3">&quot;Cat&quot;</span><span class="s0">, </span><span class="s3">&quot;Int&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">how=</span><span class="s3">&quot;left&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = expected.drop([</span><span class="s3">&quot;Cat&quot;</span><span class="s0">, </span><span class="s3">&quot;Int&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">result = a.join(b</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;Cat1&quot;</span><span class="s0">, </span><span class="s3">&quot;Int1&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;merge&quot;</span><span class="s0">, </span><span class="s3">&quot;merge_asof&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s3">&quot;kwargs&quot;</span><span class="s0">, </span><span class="s3">&quot;err_msg&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">({</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;left_on&quot;</span><span class="s0">, </span><span class="s3">&quot;left_index&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">({</span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;right_on&quot;</span><span class="s0">, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_join_cols_error_reporting_duplicates(func</span><span class="s0">, </span><span class="s1">kwargs</span><span class="s0">, </span><span class="s1">err_msg):</span>
    <span class="s5"># GH: 16228</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]})</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]})</span>
    <span class="s1">msg = </span><span class="s3">rf'Can only pass argument &quot;</span><span class="s0">{</span><span class="s1">err_msg[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">}</span><span class="s3">&quot; OR &quot;</span><span class="s0">{</span><span class="s1">err_msg[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">}</span><span class="s3">&quot; not both\.'</span>
    <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">getattr(pd</span><span class="s0">, </span><span class="s1">func)(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;merge&quot;</span><span class="s0">, </span><span class="s3">&quot;merge_asof&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s3">&quot;kwargs&quot;</span><span class="s0">, </span><span class="s3">&quot;err_msg&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">({</span><span class="s3">&quot;left_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;right_on&quot;</span><span class="s0">, </span><span class="s3">&quot;right_index&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">({</span><span class="s3">&quot;right_on&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;left_on&quot;</span><span class="s0">, </span><span class="s3">&quot;left_index&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_join_cols_error_reporting_missing(func</span><span class="s0">, </span><span class="s1">kwargs</span><span class="s0">, </span><span class="s1">err_msg):</span>
    <span class="s5"># GH: 16228</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]})</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]})</span>
    <span class="s1">msg = </span><span class="s3">rf'Must pass &quot;</span><span class="s0">{</span><span class="s1">err_msg[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">}</span><span class="s3">&quot; OR &quot;</span><span class="s0">{</span><span class="s1">err_msg[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">}</span><span class="s3">&quot;\.'</span>
    <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">getattr(pd</span><span class="s0">, </span><span class="s1">func)(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;merge&quot;</span><span class="s0">, </span><span class="s3">&quot;merge_asof&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">{</span><span class="s3">&quot;right_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s3">&quot;left_index&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_merge_join_cols_error_reporting_on_and_index(func</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s5"># GH: 16228</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]})</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]})</span>
    <span class="s1">msg = (</span>
        <span class="s3">r'Can only pass argument &quot;on&quot; OR &quot;left_index&quot; '</span>
        <span class="s3">r'and &quot;right_index&quot;, not a combination of both\.'</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">getattr(pd</span><span class="s0">, </span><span class="s1">func)(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">def </span><span class="s1">test_merge_right_left_index():</span>
    <span class="s5"># GH#38616</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]})</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]})</span>
    <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;right&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_on=</span><span class="s3">&quot;x&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;x_x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;z_x&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;x_y&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;z_y&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_result_empty_index_and_on():</span>
    <span class="s5"># GH#33814</span>
    <span class="s1">df1 = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s1">]}).set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">df2 = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]}).set_index([</span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: []}</span><span class="s0">, </span><span class="s1">dtype=np.int64).set_index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">result = merge(df1</span><span class="s0">, </span><span class="s1">df2</span><span class="s0">, </span><span class="s1">left_on=[</span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = merge(df2</span><span class="s0">, </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_on=[</span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_suffixes_produce_dup_columns_warns():</span>
    <span class="s5"># GH#22818</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b_y&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
        <span class="s1">merge(right</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">suffixes=(</span><span class="s3">&quot;_y&quot;</span><span class="s0">, </span><span class="s3">&quot;_x&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_duplicate_columns_with_suffix_no_warning():</span>
    <span class="s5"># GH#22818</span>
    <span class="s5"># Do not raise warning when duplicates are caused by duplicates in origin</span>
    <span class="s1">left = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>
    <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b_y&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_duplicate_columns_with_suffix_causing_another_duplicate():</span>
    <span class="s5"># GH#22818</span>
    <span class="s5"># This should raise warning because suffixes cause another collision</span>
    <span class="s1">left = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s1">])</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
        <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b_x&quot;</span><span class="s0">, </span><span class="s3">&quot;b_y&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_string_float_column_result():</span>
    <span class="s5"># GH 13353</span>
    <span class="s1">df1 = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=pd.Index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">114.0</span><span class="s1">]))</span>
    <span class="s1">df2 = DataFrame([[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])</span>
    <span class="s1">result = merge(df2</span><span class="s0">, </span><span class="s1">df1</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;inner&quot;</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True, </span><span class="s1">right_index=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=pd.Index([</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">114.0</span><span class="s1">])</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_mergeerror_on_left_index_mismatched_dtypes():</span>
    <span class="s5"># GH 22449</span>
    <span class="s1">df_1 = DataFrame(data=[</span><span class="s3">&quot;X&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">22</span><span class="s1">])</span>
    <span class="s1">df_2 = DataFrame(data=[</span><span class="s3">&quot;X&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">999</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(MergeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;Can only pass argument&quot;</span><span class="s1">):</span>
        <span class="s1">merge(df_1</span><span class="s0">, </span><span class="s1">df_2</span><span class="s0">, </span><span class="s1">on=[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">left_index=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">&quot;Int64&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_merge_outer_with_NaN(dtype):</span>
    <span class="s5"># GH#43550</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;key&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;key&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s3">&quot;col2&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">dtype=dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s5"># switch left and right</span>
    <span class="s1">result = merge(right</span><span class="s0">, </span><span class="s1">left</span><span class="s0">, </span><span class="s1">on=</span><span class="s3">&quot;key&quot;</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;outer&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;key&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s3">&quot;col1&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">dtype=dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_merge_different_index_names():</span>
    <span class="s5"># GH#45094</span>
    <span class="s1">left = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=pd.Index([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">right = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=pd.Index([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;d&quot;</span><span class="s1">))</span>
    <span class="s1">result = merge(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">left_on=</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">right_on=</span><span class="s3">&quot;d&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s3">&quot;a_x&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;a_y&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>