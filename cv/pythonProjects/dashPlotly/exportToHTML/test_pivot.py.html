<html>
<head>
<title>test_pivot.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pivot.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">date</span><span class="s0">,</span>
    <span class="s1">datetime</span><span class="s0">,</span>
    <span class="s1">timedelta</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.errors </span><span class="s0">import </span><span class="s1">PerformanceWarning</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Categorical</span><span class="s0">,</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Grouper</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">concat</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.api.types </span><span class="s0">import </span><span class="s1">CategoricalDtype </span><span class="s0">as </span><span class="s1">CDT</span>
<span class="s0">from </span><span class="s1">pandas.core.reshape </span><span class="s0">import </span><span class="s1">reshape </span><span class="s0">as </span><span class="s1">reshape_lib</span>
<span class="s0">from </span><span class="s1">pandas.core.reshape.pivot </span><span class="s0">import </span><span class="s1">pivot_table</span>


<span class="s1">@pytest.fixture(params=[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">dropna(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s1">@pytest.fixture(params=[([</span><span class="s2">0</span><span class="s1">] * </span><span class="s2">4</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">] * </span><span class="s2">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(range(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">))])</span>
<span class="s0">def </span><span class="s1">interval_values(request</span><span class="s0">, </span><span class="s1">closed):</span>
    <span class="s1">left</span><span class="s0">, </span><span class="s1">right = request.param</span>
    <span class="s0">return </span><span class="s1">Categorical(pd.IntervalIndex.from_arrays(left</span><span class="s0">, </span><span class="s1">right</span><span class="s0">, </span><span class="s1">closed))</span>


<span class="s0">class </span><span class="s1">TestPivotTable:</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s1">self.data = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;D&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">11</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;E&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">11</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;F&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">11</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table(self</span><span class="s0">, </span><span class="s1">observed):</span>
        <span class="s1">index = [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span>
        <span class="s1">columns = </span><span class="s3">&quot;C&quot;</span>
        <span class="s1">table = pivot_table(</span>
            <span class="s1">self.data</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">observed=observed</span>
        <span class="s1">)</span>

        <span class="s1">table2 = self.data.pivot_table(</span>
            <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">observed=observed</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">table2)</span>

        <span class="s4"># this works</span>
        <span class="s1">pivot_table(self.data</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">observed=observed)</span>

        <span class="s0">if </span><span class="s1">len(index) &gt; </span><span class="s2">1</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">table.index.names == tuple(index)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">table.index.name == index[</span><span class="s2">0</span><span class="s1">]</span>

        <span class="s0">if </span><span class="s1">len(columns) &gt; </span><span class="s2">1</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">table.columns.names == columns</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">table.columns.name == columns[</span><span class="s2">0</span><span class="s1">]</span>

        <span class="s1">expected = self.data.groupby(index + [columns])[</span><span class="s3">&quot;D&quot;</span><span class="s1">].agg(np.mean).unstack()</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_categorical_observed_equal(self</span><span class="s0">, </span><span class="s1">observed):</span>
        <span class="s4"># issue #24923</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;col1&quot;</span><span class="s1">: list(</span><span class="s3">&quot;abcde&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: list(</span><span class="s3">&quot;fghij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;col3&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]}</span>
        <span class="s1">)</span>

        <span class="s1">expected = df.pivot_table(</span>
            <span class="s1">index=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;col3&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;col2&quot;</span><span class="s0">, </span><span class="s1">aggfunc=np.sum</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span>
        <span class="s1">)</span>

        <span class="s1">expected.index = expected.index.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">expected.columns = expected.columns.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>

        <span class="s1">df.col1 = df.col1.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">df.col2 = df.col2.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>

        <span class="s1">result = df.pivot_table(</span>
            <span class="s1">index=</span><span class="s3">&quot;col1&quot;</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;col3&quot;</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;col2&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
            <span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">,</span>
            <span class="s1">observed=observed</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_nocols(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;rows&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;cols&quot;</span><span class="s1">: [</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">rs = df.pivot_table(columns=</span><span class="s3">&quot;cols&quot;</span><span class="s0">, </span><span class="s1">aggfunc=np.sum)</span>
        <span class="s1">xp = df.pivot_table(index=</span><span class="s3">&quot;cols&quot;</span><span class="s0">, </span><span class="s1">aggfunc=np.sum).T</span>
        <span class="s1">tm.assert_frame_equal(rs</span><span class="s0">, </span><span class="s1">xp)</span>

        <span class="s1">rs = df.pivot_table(columns=</span><span class="s3">&quot;cols&quot;</span><span class="s0">, </span><span class="s1">aggfunc={</span><span class="s3">&quot;values&quot;</span><span class="s1">: </span><span class="s3">&quot;mean&quot;</span><span class="s1">})</span>
        <span class="s1">xp = df.pivot_table(index=</span><span class="s3">&quot;cols&quot;</span><span class="s0">, </span><span class="s1">aggfunc={</span><span class="s3">&quot;values&quot;</span><span class="s1">: </span><span class="s3">&quot;mean&quot;</span><span class="s1">}).T</span>
        <span class="s1">tm.assert_frame_equal(rs</span><span class="s0">, </span><span class="s1">xp)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_dropna(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;amount&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">60000</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">100000</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">50000</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">30000</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;customer&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s3">&quot;C&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;month&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">201307</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">201309</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">201308</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">201310</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;product&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s3">&quot;d&quot;</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;quantity&quot;</span><span class="s1">: {</span><span class="s2">0</span><span class="s1">: </span><span class="s2">2000000</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">500000</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">1000000</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">1000000</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">pv_col = df.pivot_table(</span>
            <span class="s3">&quot;quantity&quot;</span><span class="s0">, </span><span class="s3">&quot;month&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;customer&quot;</span><span class="s0">, </span><span class="s3">&quot;product&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">pv_ind = df.pivot_table(</span>
            <span class="s3">&quot;quantity&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;customer&quot;</span><span class="s0">, </span><span class="s3">&quot;product&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;month&quot;</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span>
        <span class="s1">)</span>

        <span class="s1">m = MultiIndex.from_tuples(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s3">&quot;customer&quot;</span><span class="s0">, </span><span class="s3">&quot;product&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_index_equal(pv_col.columns</span><span class="s0">, </span><span class="s1">m)</span>
        <span class="s1">tm.assert_index_equal(pv_ind.index</span><span class="s0">, </span><span class="s1">m)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_categorical(self):</span>

        <span class="s1">cat1 = Categorical(</span>
            <span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">cat2 = Categorical(</span>
            <span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: cat1</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: cat2</span><span class="s0">, </span><span class="s3">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]})</span>
        <span class="s1">result = pivot_table(df</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;values&quot;</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">exp_index = MultiIndex.from_arrays([cat1</span><span class="s0">, </span><span class="s1">cat2]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=exp_index)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_dropna_categoricals(self</span><span class="s0">, </span><span class="s1">dropna):</span>
        <span class="s4"># GH 15193</span>
        <span class="s1">categories = [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: range(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">9</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df[</span><span class="s3">&quot;A&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;A&quot;</span><span class="s1">].astype(CDT(categories</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">))</span>
        <span class="s1">result = df.pivot_table(index=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>
        <span class="s1">expected_columns = Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">expected_columns = expected_columns.astype(CDT(categories</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">))</span>
        <span class="s1">expected_index = Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=expected_index</span><span class="s0">,</span>
            <span class="s1">columns=expected_columns</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">if not </span><span class="s1">dropna:</span>
            <span class="s4"># add back the non observed to compare</span>
            <span class="s1">expected = expected.reindex(columns=Categorical(categories)).astype(</span><span class="s3">&quot;float&quot;</span><span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_with_non_observable_dropna(self</span><span class="s0">, </span><span class="s1">dropna):</span>
        <span class="s4"># gh-21133</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: Categorical(</span>
                    <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">categories=[</span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">ordered=</span><span class="s0">True,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = df.pivot_table(index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=Index(</span>
                <span class="s1">Categorical.from_codes(</span>
                    <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># gh-21378</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: Categorical(</span>
                    <span class="s1">[</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">categories=[</span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">ordered=</span><span class="s0">True,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: range(</span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = df.pivot_table(index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=Index(</span>
                <span class="s1">Categorical.from_codes(</span>
                    <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">if not </span><span class="s1">dropna:</span>
            <span class="s1">expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = expected[</span><span class="s3">&quot;B&quot;</span><span class="s1">].astype(float)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_with_interval_index(self</span><span class="s0">, </span><span class="s1">interval_values</span><span class="s0">, </span><span class="s1">dropna):</span>
        <span class="s4"># GH 25814</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: interval_values</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s1">result = df.pivot_table(index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>
        <span class="s1">expected = DataFrame({</span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=Index(interval_values.unique()</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
        <span class="s0">if not </span><span class="s1">dropna:</span>
            <span class="s1">expected = expected.astype(float)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_with_interval_index_margins(self):</span>
        <span class="s4"># GH 25815</span>
        <span class="s1">ordered_cat = pd.IntervalIndex.from_arrays([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: np.arange(</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">dtype=np.intp)</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: Categorical(ordered_cat</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">).sort_values(</span>
                    <span class="s1">ascending=</span><span class="s0">False</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">pivot_tab = pivot_table(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">aggfunc=</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span>
        <span class="s1">)</span>

        <span class="s1">result = pivot_tab[</span><span class="s3">&quot;All&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=Index([pd.Interval(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Interval(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s3">&quot;All&quot;</span><span class="s0">,</span>
            <span class="s1">dtype=np.intp</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pass_array(self):</span>
        <span class="s1">result = self.data.pivot_table(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=self.data.A</span><span class="s0">, </span><span class="s1">columns=self.data.C)</span>
        <span class="s1">expected = self.data.pivot_table(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pass_function(self):</span>
        <span class="s1">result = self.data.pivot_table(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">lambda </span><span class="s1">x: x // </span><span class="s2">5</span><span class="s0">, </span><span class="s1">columns=self.data.C)</span>
        <span class="s1">expected = self.data.pivot_table(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=self.data.index // </span><span class="s2">5</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_multiple(self):</span>
        <span class="s1">index = [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span>
        <span class="s1">columns = </span><span class="s3">&quot;C&quot;</span>
        <span class="s1">table = pivot_table(self.data</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=columns)</span>
        <span class="s1">expected = self.data.groupby(index + [columns]).agg(np.mean).unstack()</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_dtypes(self):</span>

        <span class="s4"># can convert dtypes</span>
        <span class="s1">f = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;bat&quot;</span><span class="s0">, </span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;bat&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;v&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">f.dtypes[</span><span class="s3">&quot;v&quot;</span><span class="s1">] == </span><span class="s3">&quot;int64&quot;</span>

        <span class="s1">z = pivot_table(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;v&quot;</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;i&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">aggfunc=np.sum</span>
        <span class="s1">)</span>
        <span class="s1">result = z.dtypes</span>
        <span class="s1">expected = Series([np.dtype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)] * </span><span class="s2">2</span><span class="s0">, </span><span class="s1">index=Index(list(</span><span class="s3">&quot;ab&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;i&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># cannot convert dtypes</span>
        <span class="s1">f = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;bat&quot;</span><span class="s0">, </span><span class="s3">&quot;cat&quot;</span><span class="s0">, </span><span class="s3">&quot;bat&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;v&quot;</span><span class="s1">: [</span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">3.5</span><span class="s0">, </span><span class="s2">4.5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">f.dtypes[</span><span class="s3">&quot;v&quot;</span><span class="s1">] == </span><span class="s3">&quot;float64&quot;</span>

        <span class="s1">z = pivot_table(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;v&quot;</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;i&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">aggfunc=np.mean</span>
        <span class="s1">)</span>
        <span class="s1">result = z.dtypes</span>
        <span class="s1">expected = Series([np.dtype(</span><span class="s3">&quot;float64&quot;</span><span class="s1">)] * </span><span class="s2">2</span><span class="s0">, </span><span class="s1">index=Index(list(</span><span class="s3">&quot;ab&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;i&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;columns,values&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s3">&quot;bool1&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;float1&quot;</span><span class="s0">, </span><span class="s3">&quot;float2&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;bool1&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;float1&quot;</span><span class="s0">, </span><span class="s3">&quot;float2&quot;</span><span class="s0">, </span><span class="s3">&quot;bool1&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;bool2&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;float1&quot;</span><span class="s0">, </span><span class="s3">&quot;float2&quot;</span><span class="s0">, </span><span class="s3">&quot;bool1&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_pivot_preserve_dtypes(self</span><span class="s0">, </span><span class="s1">columns</span><span class="s0">, </span><span class="s1">values):</span>
        <span class="s4"># GH 7142 regression test</span>
        <span class="s1">v = np.arange(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;float1&quot;</span><span class="s1">: v</span><span class="s0">, </span><span class="s3">&quot;float2&quot;</span><span class="s1">: v + </span><span class="s2">2.0</span><span class="s0">, </span><span class="s3">&quot;bool1&quot;</span><span class="s1">: v &lt;= </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;bool2&quot;</span><span class="s1">: v &lt;= </span><span class="s2">3</span><span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df_res = df.reset_index().pivot_table(</span>
            <span class="s1">index=</span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">values=values</span>
        <span class="s1">)</span>

        <span class="s1">result = dict(df_res.dtypes)</span>
        <span class="s1">expected = {col: np.dtype(</span><span class="s3">&quot;float64&quot;</span><span class="s1">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">df_res}</span>
        <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s0">def </span><span class="s1">test_pivot_no_values(self):</span>
        <span class="s4"># GH 14380</span>
        <span class="s1">idx = pd.DatetimeIndex(</span>
            <span class="s1">[</span><span class="s3">&quot;2011-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2011-02-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2011-01-02&quot;</span><span class="s0">, </span><span class="s3">&quot;2011-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2011-01-02&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=idx)</span>
        <span class="s1">res = df.pivot_table(index=df.index.month</span><span class="s0">, </span><span class="s1">columns=df.index.day)</span>

        <span class="s1">exp_columns = MultiIndex.from_tuples([(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)])</span>
        <span class="s1">exp = DataFrame([[</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2.0</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=exp_columns)</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;dt&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;2011-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=idx</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">res = df.pivot_table(index=df.index.month</span><span class="s0">, </span><span class="s1">columns=Grouper(key=</span><span class="s3">&quot;dt&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s1">))</span>
        <span class="s1">exp_columns = MultiIndex.from_tuples([(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">pd.Timestamp(</span><span class="s3">&quot;2011-01-31&quot;</span><span class="s1">))])</span>
        <span class="s1">exp_columns.names = [</span><span class="s0">None, </span><span class="s3">&quot;dt&quot;</span><span class="s1">]</span>
        <span class="s1">exp = DataFrame([</span><span class="s2">3.25</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=exp_columns)</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res = df.pivot_table(</span>
            <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=Grouper(key=</span><span class="s3">&quot;dt&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">exp = DataFrame(</span>
            <span class="s1">[</span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=pd.DatetimeIndex([</span><span class="s3">&quot;2011-12-31&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=exp_columns</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_pivot_multi_values(self):</span>
        <span class="s1">result = pivot_table(</span>
            <span class="s1">self.data</span><span class="s0">, </span><span class="s1">values=[</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span>
        <span class="s1">)</span>
        <span class="s1">expected = pivot_table(</span>
            <span class="s1">self.data.drop([</span><span class="s3">&quot;F&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_multi_functions(self):</span>
        <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">func: pivot_table(</span>
            <span class="s1">self.data</span><span class="s0">, </span><span class="s1">values=[</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">aggfunc=func</span>
        <span class="s1">)</span>
        <span class="s1">result = f([np.mean</span><span class="s0">, </span><span class="s1">np.std])</span>
        <span class="s1">means = f(np.mean)</span>
        <span class="s1">stds = f(np.std)</span>
        <span class="s1">expected = concat([means</span><span class="s0">, </span><span class="s1">stds]</span><span class="s0">, </span><span class="s1">keys=[</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;std&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># margins not supported??</span>
        <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">func: pivot_table(</span>
            <span class="s1">self.data</span><span class="s0">,</span>
            <span class="s1">values=[</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=func</span><span class="s0">,</span>
            <span class="s1">margins=</span><span class="s0">True,</span>
        <span class="s1">)</span>
        <span class="s1">result = f([np.mean</span><span class="s0">, </span><span class="s1">np.std])</span>
        <span class="s1">means = f(np.mean)</span>
        <span class="s1">stds = f(np.std)</span>
        <span class="s1">expected = concat([means</span><span class="s0">, </span><span class="s1">stds]</span><span class="s0">, </span><span class="s1">keys=[</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;std&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_pivot_index_with_nan(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s4"># GH 3588</span>
        <span class="s1">nan = np.nan</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;R1&quot;</span><span class="s0">, </span><span class="s3">&quot;R2&quot;</span><span class="s0">, </span><span class="s1">nan</span><span class="s0">, </span><span class="s3">&quot;R4&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">&quot;C2&quot;</span><span class="s0">, </span><span class="s3">&quot;C3&quot;</span><span class="s0">, </span><span class="s3">&quot;C4&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">result = df.pivot(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">result = pd.pivot(df</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[nan</span><span class="s0">, </span><span class="s1">nan</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s1">nan]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">10</span><span class="s0">, </span><span class="s1">nan</span><span class="s0">, </span><span class="s1">nan</span><span class="s0">, </span><span class="s1">nan]</span><span class="s0">,</span>
                <span class="s1">[nan</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s1">nan</span><span class="s0">, </span><span class="s1">nan]</span><span class="s0">,</span>
                <span class="s1">[nan</span><span class="s0">, </span><span class="s1">nan</span><span class="s0">, </span><span class="s1">nan</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=Index([nan</span><span class="s0">, </span><span class="s3">&quot;R1&quot;</span><span class="s0">, </span><span class="s3">&quot;R2&quot;</span><span class="s0">, </span><span class="s3">&quot;R4&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s3">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">&quot;C2&quot;</span><span class="s0">, </span><span class="s3">&quot;C3&quot;</span><span class="s0">, </span><span class="s3">&quot;C4&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(df.pivot(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected.T)</span>

        <span class="s4"># GH9491</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: date_range(</span><span class="s3">&quot;2014-02-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">6</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s2">100 </span><span class="s1">+ np.arange(</span><span class="s2">6</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;b&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;a&quot;</span><span class="s1">] - pd.Timestamp(</span><span class="s3">&quot;2014-02-02&quot;</span><span class="s1">)</span>
        <span class="s1">df.loc[</span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">] = df.loc[</span><span class="s2">3</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">] = nan</span>
        <span class="s1">df.loc[</span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">] = df.loc[</span><span class="s2">4</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">] = nan</span>

        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">pv = df.pivot(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">pv = pd.pivot(df</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">pv.notna().values.sum() == len(df)</span>

        <span class="s0">for </span><span class="s1">_</span><span class="s0">, </span><span class="s1">row </span><span class="s0">in </span><span class="s1">df.iterrows():</span>
            <span class="s0">assert </span><span class="s1">pv.loc[row[</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">row[</span><span class="s3">&quot;b&quot;</span><span class="s1">]] == row[</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>

        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">result = df.pivot(</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">result = pd.pivot(df</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">pv.T)</span>

    <span class="s1">@pytest.mark.filterwarnings(</span><span class="s3">&quot;ignore:Timestamp.freq is deprecated:FutureWarning&quot;</span><span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_pivot_with_tz(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s4"># GH 5878</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;dt1&quot;</span><span class="s1">: [</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;dt2&quot;</span><span class="s1">: [</span>
                    <span class="s1">datetime(</span><span class="s2">2014</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2014</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2014</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2014</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;data1&quot;</span><span class="s1">: np.arange(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;data2&quot;</span><span class="s1">: np.arange(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">d: pd.Timestamp(d</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">d: pd.Timestamp(d</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Asia/Tokyo&quot;</span><span class="s1">))</span>

        <span class="s1">exp_col1 = Index([</span><span class="s3">&quot;data1&quot;</span><span class="s0">, </span><span class="s3">&quot;data1&quot;</span><span class="s0">, </span><span class="s3">&quot;data2&quot;</span><span class="s0">, </span><span class="s3">&quot;data2&quot;</span><span class="s1">])</span>
        <span class="s1">exp_col2 = pd.DatetimeIndex(</span>
            <span class="s1">[</span><span class="s3">&quot;2014/01/01 09:00&quot;</span><span class="s0">, </span><span class="s3">&quot;2014/01/02 09:00&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;dt2&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Asia/Tokyo&quot;</span>
        <span class="s1">)</span>
        <span class="s1">exp_col = MultiIndex.from_arrays([exp_col1</span><span class="s0">, </span><span class="s1">exp_col2])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=pd.DatetimeIndex(</span>
                <span class="s1">[</span><span class="s3">&quot;2013/01/01 09:00&quot;</span><span class="s0">, </span><span class="s3">&quot;2013/01/02 09:00&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;dt1&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=exp_col</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">pv = df.pivot(index=</span><span class="s3">&quot;dt1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;dt2&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">pv = pd.pivot(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;dt1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;dt2&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(pv</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=pd.DatetimeIndex(</span>
                <span class="s1">[</span><span class="s3">&quot;2013/01/01 09:00&quot;</span><span class="s0">, </span><span class="s3">&quot;2013/01/02 09:00&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;dt1&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=pd.DatetimeIndex(</span>
                <span class="s1">[</span><span class="s3">&quot;2014/01/01 09:00&quot;</span><span class="s0">, </span><span class="s3">&quot;2014/01/02 09:00&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;dt2&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Asia/Tokyo&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">pv = df.pivot(index=</span><span class="s3">&quot;dt1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;dt2&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;data1&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">pv = pd.pivot(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;dt1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;dt2&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;data1&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(pv</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_tz_in_values(self):</span>
        <span class="s4"># GH 14948</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;uid&quot;</span><span class="s1">: </span><span class="s3">&quot;aa&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;ts&quot;</span><span class="s1">: pd.Timestamp(</span><span class="s3">&quot;2016-08-12 13:00:00-0700&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;uid&quot;</span><span class="s1">: </span><span class="s3">&quot;aa&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;ts&quot;</span><span class="s1">: pd.Timestamp(</span><span class="s3">&quot;2016-08-12 08:00:00-0700&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;uid&quot;</span><span class="s1">: </span><span class="s3">&quot;aa&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;ts&quot;</span><span class="s1">: pd.Timestamp(</span><span class="s3">&quot;2016-08-12 14:00:00-0700&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;uid&quot;</span><span class="s1">: </span><span class="s3">&quot;aa&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;ts&quot;</span><span class="s1">: pd.Timestamp(</span><span class="s3">&quot;2016-08-25 11:00:00-0700&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;uid&quot;</span><span class="s1">: </span><span class="s3">&quot;aa&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;ts&quot;</span><span class="s1">: pd.Timestamp(</span><span class="s3">&quot;2016-08-25 13:00:00-0700&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s1">df = df.set_index(</span><span class="s3">&quot;ts&quot;</span><span class="s1">).reset_index()</span>
        <span class="s1">mins = df.ts.map(</span><span class="s0">lambda </span><span class="s1">x: x.replace(hour=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">minute=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">second=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">microsecond=</span><span class="s2">0</span><span class="s1">))</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df.set_index(</span><span class="s3">&quot;ts&quot;</span><span class="s1">).reset_index()</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;ts&quot;</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;uid&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[mins]</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.min</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[</span>
                <span class="s1">[</span>
                    <span class="s1">pd.Timestamp(</span><span class="s3">&quot;2016-08-12 08:00:00-0700&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Timestamp(</span><span class="s3">&quot;2016-08-25 11:00:00-0700&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s3">&quot;aa&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;uid&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=pd.DatetimeIndex(</span>
                <span class="s1">[</span>
                    <span class="s1">pd.Timestamp(</span><span class="s3">&quot;2016-08-12 00:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Timestamp(</span><span class="s3">&quot;2016-08-25 00:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">name=</span><span class="s3">&quot;ts&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_pivot_periods(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;p1&quot;</span><span class="s1">: [</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-01-02&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-01-02&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;p2&quot;</span><span class="s1">: [</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s3">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s3">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s3">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2013-02&quot;</span><span class="s0">, </span><span class="s3">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;data1&quot;</span><span class="s1">: np.arange(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;data2&quot;</span><span class="s1">: np.arange(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">exp_col1 = Index([</span><span class="s3">&quot;data1&quot;</span><span class="s0">, </span><span class="s3">&quot;data1&quot;</span><span class="s0">, </span><span class="s3">&quot;data2&quot;</span><span class="s0">, </span><span class="s3">&quot;data2&quot;</span><span class="s1">])</span>
        <span class="s1">exp_col2 = pd.PeriodIndex([</span><span class="s3">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2013-02&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;p2&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s1">)</span>
        <span class="s1">exp_col = MultiIndex.from_arrays([exp_col1</span><span class="s0">, </span><span class="s1">exp_col2])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=pd.PeriodIndex([</span><span class="s3">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2013-01-02&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;p1&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=exp_col</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">pv = df.pivot(index=</span><span class="s3">&quot;p1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;p2&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">pv = pd.pivot(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;p1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;p2&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(pv</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=pd.PeriodIndex([</span><span class="s3">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2013-01-02&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;p1&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=pd.PeriodIndex([</span><span class="s3">&quot;2013-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2013-02&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;p2&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">pv = df.pivot(index=</span><span class="s3">&quot;p1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;p2&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;data1&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">pv = pd.pivot(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;p1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;p2&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;data1&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(pv</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_periods_with_margins(self):</span>
        <span class="s4"># GH 28323</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2019Q1&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2019Q2&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2019Q1&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">pd.Period(</span><span class="s3">&quot;2019Q2&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s2">1.0</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">data=</span><span class="s2">1.0</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=Index([pd.Period(</span><span class="s3">&quot;2019Q1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.Period(</span><span class="s3">&quot;2019Q2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = df.pivot_table(index=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;values&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;zoo&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;zoo&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">Series([</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;zoo&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">Index([</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;zoo&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_pivot_with_list_like_values(self</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s4"># issue #17160</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;baz&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;zoo&quot;</span><span class="s1">: [</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">result = df.pivot(index=</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s1">values=values)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">result = pd.pivot(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s1">values=values)</span>

        <span class="s1">data = [[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s1">]]</span>
        <span class="s1">index = Index(data=[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>
        <span class="s1">columns = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;zoo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(data=data</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;values&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">Series([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">Index([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_pivot_with_list_like_values_nans(self</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s4"># issue #17160</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;baz&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;zoo&quot;</span><span class="s1">: [</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">result = df.pivot(index=</span><span class="s3">&quot;zoo&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">values=values)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">result = pd.pivot(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;zoo&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">values=values)</span>

        <span class="s1">data = [</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">index = Index(data=[</span><span class="s3">&quot;q&quot;</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;zoo&quot;</span><span class="s1">)</span>
        <span class="s1">columns = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(data=data</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_columns_none_raise_error(self):</span>
        <span class="s4"># GH 30924</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col3&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
        <span class="s1">msg = </span><span class="s3">r&quot;pivot\(\) missing 1 required argument: 'columns'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.pivot(index=</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;col3&quot;</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.xfail(</span>
        <span class="s1">reason=</span><span class="s3">&quot;MultiIndexed unstack with tuple names fails with KeyError GH#19966&quot;</span>
    <span class="s1">)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_pivot_with_multiindex(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s4"># issue #17160</span>
        <span class="s1">index = Index(data=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>
        <span class="s1">data = [</span>
            <span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">columns = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(data=data</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">method:</span>
            <span class="s1">result = df.pivot(</span>
                <span class="s1">index=(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;first&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">columns=(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">values=(</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;first&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">result = pd.pivot(</span>
                <span class="s1">df</span><span class="s0">,</span>
                <span class="s1">index=(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;first&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">columns=(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">values=(</span><span class="s3">&quot;baz&quot;</span><span class="s0">, </span><span class="s3">&quot;first&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s1">data = {</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: Series([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: Series([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s3">&quot;C&quot;</span><span class="s1">: Series([</span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">expected = DataFrame(data)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_pivot_with_tuple_of_values(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s4"># issue #17160</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;baz&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;zoo&quot;</span><span class="s1">: [</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">r&quot;^\('bar', 'baz'\)$&quot;</span><span class="s1">):</span>
            <span class="s4"># tuple is seen as a single column name</span>
            <span class="s0">if </span><span class="s1">method:</span>
                <span class="s1">df.pivot(index=</span><span class="s3">&quot;zoo&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">values=(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">))</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">pd.pivot(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;zoo&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">values=(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;baz&quot;</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_margins(self):</span>
        <span class="s0">def </span><span class="s1">_check_output(</span>
            <span class="s1">result</span><span class="s0">, </span><span class="s1">values_col</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">margins_col=</span><span class="s3">&quot;All&quot;</span>
        <span class="s1">):</span>
            <span class="s1">col_margins = result.loc[result.index[:-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">margins_col]</span>
            <span class="s1">expected_col_margins = self.data.groupby(index)[values_col].mean()</span>
            <span class="s1">tm.assert_series_equal(col_margins</span><span class="s0">, </span><span class="s1">expected_col_margins</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">col_margins.name == margins_col</span>

            <span class="s1">result = result.sort_index()</span>
            <span class="s1">index_margins = result.loc[(margins_col</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">)].iloc[:-</span><span class="s2">1</span><span class="s1">]</span>

            <span class="s1">expected_ix_margins = self.data.groupby(columns)[values_col].mean()</span>
            <span class="s1">tm.assert_series_equal(</span>
                <span class="s1">index_margins</span><span class="s0">, </span><span class="s1">expected_ix_margins</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
            <span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">index_margins.name == (margins_col</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">)</span>

            <span class="s1">grand_total_margins = result.loc[(margins_col</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">margins_col]</span>
            <span class="s1">expected_total_margins = self.data[values_col].mean()</span>
            <span class="s0">assert </span><span class="s1">grand_total_margins == expected_total_margins</span>

        <span class="s4"># column specified</span>
        <span class="s1">result = self.data.pivot_table(</span>
            <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True, </span><span class="s1">aggfunc=np.mean</span>
        <span class="s1">)</span>
        <span class="s1">_check_output(result</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">)</span>

        <span class="s4"># Set a different margins_name (not 'All')</span>
        <span class="s1">result = self.data.pivot_table(</span>
            <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">,</span>
            <span class="s1">margins=</span><span class="s0">True,</span>
            <span class="s1">aggfunc=np.mean</span><span class="s0">,</span>
            <span class="s1">margins_name=</span><span class="s3">&quot;Totals&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">_check_output(result</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">margins_col=</span><span class="s3">&quot;Totals&quot;</span><span class="s1">)</span>

        <span class="s4"># no column specified</span>
        <span class="s1">table = self.data.pivot_table(</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True, </span><span class="s1">aggfunc=np.mean</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">value_col </span><span class="s0">in </span><span class="s1">table.columns.levels[</span><span class="s2">0</span><span class="s1">]:</span>
            <span class="s1">_check_output(table[value_col]</span><span class="s0">, </span><span class="s1">value_col)</span>

        <span class="s4"># no col</span>

        <span class="s4"># to help with a buglet</span>
        <span class="s1">self.data.columns = [k * </span><span class="s2">2 </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">self.data.columns]</span>
        <span class="s1">table = self.data.pivot_table(index=[</span><span class="s3">&quot;AA&quot;</span><span class="s0">, </span><span class="s3">&quot;BB&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True, </span><span class="s1">aggfunc=np.mean)</span>
        <span class="s0">for </span><span class="s1">value_col </span><span class="s0">in </span><span class="s1">table.columns:</span>
            <span class="s1">totals = table.loc[(</span><span class="s3">&quot;All&quot;</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">value_col]</span>
            <span class="s0">assert </span><span class="s1">totals == self.data[value_col].mean()</span>

        <span class="s1">table = self.data.pivot_table(index=[</span><span class="s3">&quot;AA&quot;</span><span class="s0">, </span><span class="s3">&quot;BB&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True, </span><span class="s1">aggfunc=</span><span class="s3">&quot;mean&quot;</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">[</span><span class="s3">&quot;DD&quot;</span><span class="s0">, </span><span class="s3">&quot;EE&quot;</span><span class="s0">, </span><span class="s3">&quot;FF&quot;</span><span class="s1">]:</span>
            <span class="s1">totals = table.loc[(</span><span class="s3">&quot;All&quot;</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">item]</span>
            <span class="s0">assert </span><span class="s1">totals == self.data[item].mean()</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;columns, aggfunc, values, expected_columns&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s3">&quot;A&quot;</span><span class="s0">,</span>
                <span class="s1">np.mean</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">5.5</span><span class="s0">, </span><span class="s2">5.5</span><span class="s0">, </span><span class="s2">2.2</span><span class="s0">, </span><span class="s2">2.2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">8.0</span><span class="s0">, </span><span class="s2">8.0</span><span class="s0">, </span><span class="s2">4.4</span><span class="s0">, </span><span class="s2">4.4</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">Index([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;sum&quot;</span><span class="s0">,</span>
                <span class="s1">[[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">22</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">14</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">32</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">22</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s1">MultiIndex.from_tuples(</span>
                    <span class="s1">[</span>
                        <span class="s1">(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">names=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_margin_with_only_columns_defined(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">columns</span><span class="s0">, </span><span class="s1">aggfunc</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">expected_columns</span>
    <span class="s1">):</span>
        <span class="s4"># GH 31016</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;D&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;E&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = df.pivot_table(columns=columns</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True, </span><span class="s1">aggfunc=aggfunc)</span>
        <span class="s1">expected = DataFrame(values</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">columns=expected_columns)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_margins_dtype(self):</span>
        <span class="s4"># GH 17013</span>

        <span class="s1">df = self.data.copy()</span>
        <span class="s1">df[[</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;F&quot;</span><span class="s1">]] = np.arange(len(df) * </span><span class="s2">3</span><span class="s1">).reshape(len(df)</span><span class="s0">, </span><span class="s2">3</span><span class="s1">).astype(</span><span class="s3">&quot;i8&quot;</span><span class="s1">)</span>

        <span class="s1">mi_val = list(product([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">])) + [(</span><span class="s3">&quot;All&quot;</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">)]</span>
        <span class="s1">mi = MultiIndex.from_tuples(mi_val</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">))</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;dull&quot;</span><span class="s1">: [</span><span class="s2">12</span><span class="s0">, </span><span class="s2">21</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">45</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;shiny&quot;</span><span class="s1">: [</span><span class="s2">33</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">36</span><span class="s0">, </span><span class="s2">51</span><span class="s0">, </span><span class="s2">120</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=mi</span>
        <span class="s1">).rename_axis(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">expected[</span><span class="s3">&quot;All&quot;</span><span class="s1">] = expected[</span><span class="s3">&quot;dull&quot;</span><span class="s1">] + expected[</span><span class="s3">&quot;shiny&quot;</span><span class="s1">]</span>

        <span class="s1">result = df.pivot_table(</span>
            <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">,</span>
            <span class="s1">margins=</span><span class="s0">True,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
            <span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s0">def </span><span class="s1">test_margins_dtype_len(self):</span>
        <span class="s1">mi_val = list(product([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">])) + [(</span><span class="s3">&quot;All&quot;</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">)]</span>
        <span class="s1">mi = MultiIndex.from_tuples(mi_val</span><span class="s0">, </span><span class="s1">names=(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">))</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;dull&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;shiny&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=mi</span>
        <span class="s1">).rename_axis(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">expected[</span><span class="s3">&quot;All&quot;</span><span class="s1">] = expected[</span><span class="s3">&quot;dull&quot;</span><span class="s1">] + expected[</span><span class="s3">&quot;shiny&quot;</span><span class="s1">]</span>

        <span class="s1">result = self.data.pivot_table(</span>
            <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">,</span>
            <span class="s1">margins=</span><span class="s0">True,</span>
            <span class="s1">aggfunc=len</span><span class="s0">,</span>
            <span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;cols&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)])</span>
    <span class="s0">def </span><span class="s1">test_pivot_table_multiindex_only(self</span><span class="s0">, </span><span class="s1">cols):</span>
        <span class="s4"># GH 17038</span>
        <span class="s1">df2 = DataFrame({cols[</span><span class="s2">0</span><span class="s1">]: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">cols[</span><span class="s2">1</span><span class="s1">]: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;v&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]})</span>

        <span class="s1">result = df2.pivot_table(values=</span><span class="s3">&quot;v&quot;</span><span class="s0">, </span><span class="s1">columns=cols)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_tuples([(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=cols)</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s3">&quot;v&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_retains_tz(self):</span>
        <span class="s1">dti = date_range(</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s2">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Europe/Amsterdam&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: dti})</span>
        <span class="s1">result = df.pivot_table(index=[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s4"># check tz retention</span>
        <span class="s0">assert </span><span class="s1">result.index.levels[</span><span class="s2">1</span><span class="s1">].equals(dti)</span>

    <span class="s0">def </span><span class="s1">test_pivot_integer_columns(self):</span>
        <span class="s4"># caused by upstream bug in unstack</span>

        <span class="s1">d = date.min</span>
        <span class="s1">data = list(</span>
            <span class="s1">product(</span>
                <span class="s1">[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s3">&quot;x1&quot;</span><span class="s0">, </span><span class="s3">&quot;x2&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[d + timedelta(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">20</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">df = DataFrame(data)</span>
        <span class="s1">table = df.pivot_table(values=</span><span class="s2">4</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">2</span><span class="s1">])</span>

        <span class="s1">df2 = df.rename(columns=str)</span>
        <span class="s1">table2 = df2.pivot_table(values=</span><span class="s3">&quot;4&quot;</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;0&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;3&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;2&quot;</span><span class="s1">])</span>

        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">table2</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pivot_no_level_overlap(self):</span>
        <span class="s4"># GH #1181</span>

        <span class="s1">data = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: ([</span><span class="s3">&quot;foo&quot;</span><span class="s1">] * </span><span class="s2">4 </span><span class="s1">+ [</span><span class="s3">&quot;bar&quot;</span><span class="s1">] * </span><span class="s2">4</span><span class="s1">) * </span><span class="s2">2</span><span class="s0">,</span>
                <span class="s3">&quot;value&quot;</span><span class="s1">: np.random.randn(</span><span class="s2">16</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">table = data.pivot_table(</span><span class="s3">&quot;value&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>

        <span class="s1">grouped = data.groupby([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])[</span><span class="s3">&quot;value&quot;</span><span class="s1">].mean()</span>
        <span class="s1">expected = grouped.unstack(</span><span class="s3">&quot;b&quot;</span><span class="s1">).unstack(</span><span class="s3">&quot;c&quot;</span><span class="s1">).dropna(axis=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">how=</span><span class="s3">&quot;all&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_columns_lexsorted(self):</span>

        <span class="s1">n = </span><span class="s2">10000</span>

        <span class="s1">dtype = np.dtype(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s3">&quot;Index&quot;</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;Symbol&quot;</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;Year&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;Month&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;Day&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;Price&quot;</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s1">products = np.array(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s3">&quot;SP500&quot;</span><span class="s0">, </span><span class="s3">&quot;ADBE&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;SP500&quot;</span><span class="s0">, </span><span class="s3">&quot;NVDA&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;SP500&quot;</span><span class="s0">, </span><span class="s3">&quot;ORCL&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;NDQ100&quot;</span><span class="s0">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;NDQ100&quot;</span><span class="s0">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;NDQ100&quot;</span><span class="s0">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;FTSE&quot;</span><span class="s0">, </span><span class="s3">&quot;DGE.L&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;FTSE&quot;</span><span class="s0">, </span><span class="s3">&quot;TSCO.L&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;FTSE&quot;</span><span class="s0">, </span><span class="s3">&quot;GSK.L&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">dtype=[(</span><span class="s3">&quot;Index&quot;</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;Symbol&quot;</span><span class="s0">, </span><span class="s1">object)]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">items = np.empty(n</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">iproduct = np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">len(products)</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">items[</span><span class="s3">&quot;Index&quot;</span><span class="s1">] = products[</span><span class="s3">&quot;Index&quot;</span><span class="s1">][iproduct]</span>
        <span class="s1">items[</span><span class="s3">&quot;Symbol&quot;</span><span class="s1">] = products[</span><span class="s3">&quot;Symbol&quot;</span><span class="s1">][iproduct]</span>
        <span class="s1">dr = date_range(date(</span><span class="s2">2000</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">date(</span><span class="s2">2010</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">31</span><span class="s1">))</span>
        <span class="s1">dates = dr[np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">len(dr)</span><span class="s0">, </span><span class="s1">n)]</span>
        <span class="s1">items[</span><span class="s3">&quot;Year&quot;</span><span class="s1">] = dates.year</span>
        <span class="s1">items[</span><span class="s3">&quot;Month&quot;</span><span class="s1">] = dates.month</span>
        <span class="s1">items[</span><span class="s3">&quot;Day&quot;</span><span class="s1">] = dates.day</span>
        <span class="s1">items[</span><span class="s3">&quot;Price&quot;</span><span class="s1">] = np.random.lognormal(</span><span class="s2">4.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s1">n)</span>

        <span class="s1">df = DataFrame(items)</span>

        <span class="s1">pivoted = df.pivot_table(</span>
            <span class="s3">&quot;Price&quot;</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;Month&quot;</span><span class="s0">, </span><span class="s3">&quot;Day&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;Index&quot;</span><span class="s0">, </span><span class="s3">&quot;Symbol&quot;</span><span class="s0">, </span><span class="s3">&quot;Year&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">aggfunc=</span><span class="s3">&quot;mean&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">pivoted.columns.is_monotonic</span>

    <span class="s0">def </span><span class="s1">test_pivot_complex_aggfunc(self):</span>
        <span class="s1">f = {</span><span class="s3">&quot;D&quot;</span><span class="s1">: [</span><span class="s3">&quot;std&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">: [</span><span class="s3">&quot;sum&quot;</span><span class="s1">]}</span>
        <span class="s1">expected = self.data.groupby([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]).agg(f).unstack(</span><span class="s3">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">result = self.data.pivot_table(index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">aggfunc=f)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_margins_no_values_no_cols(self):</span>
        <span class="s4"># Regression test on pivot table: no values or cols passed.</span>
        <span class="s1">result = self.data[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]].pivot_table(</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">aggfunc=len</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">result_list = result.tolist()</span>
        <span class="s0">assert </span><span class="s1">sum(result_list[:-</span><span class="s2">1</span><span class="s1">]) == result_list[-</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_margins_no_values_two_rows(self):</span>
        <span class="s4"># Regression test on pivot table: no values passed but rows are a</span>
        <span class="s4"># multi-index</span>
        <span class="s1">result = self.data[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]].pivot_table(</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s1">aggfunc=len</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.All.tolist() == [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">11.0</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_margins_no_values_one_row_one_col(self):</span>
        <span class="s4"># Regression test on pivot table: no values passed but row and col</span>
        <span class="s4"># defined</span>
        <span class="s1">result = self.data[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]].pivot_table(</span>
            <span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">aggfunc=len</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.All.tolist() == [</span><span class="s2">4.0</span><span class="s0">, </span><span class="s2">7.0</span><span class="s0">, </span><span class="s2">11.0</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_margins_no_values_two_row_two_cols(self):</span>
        <span class="s4"># Regression test on pivot table: no values passed but rows and cols</span>
        <span class="s4"># are multi-indexed</span>
        <span class="s1">self.data[</span><span class="s3">&quot;D&quot;</span><span class="s1">] = [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s3">&quot;j&quot;</span><span class="s0">, </span><span class="s3">&quot;k&quot;</span><span class="s1">]</span>
        <span class="s1">result = self.data[[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]].pivot_table(</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">aggfunc=len</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.All.tolist() == [</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">11.0</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;margin_name&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s2">666</span><span class="s0">, None, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]])</span>
    <span class="s0">def </span><span class="s1">test_pivot_table_with_margins_set_margin_name(self</span><span class="s0">, </span><span class="s1">margin_name):</span>
        <span class="s4"># see gh-3335</span>
        <span class="s1">msg = (</span>
            <span class="s3">f'Conflicting name &quot;</span><span class="s0">{</span><span class="s1">margin_name</span><span class="s0">}</span><span class="s3">&quot; in margins|'</span>
            <span class="s3">&quot;margins_name argument must be a string&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s4"># multi-index index</span>
            <span class="s1">pivot_table(</span>
                <span class="s1">self.data</span><span class="s0">,</span>
                <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">,</span>
                <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">margins=</span><span class="s0">True,</span>
                <span class="s1">margins_name=margin_name</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s4"># multi-index column</span>
            <span class="s1">pivot_table(</span>
                <span class="s1">self.data</span><span class="s0">,</span>
                <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">,</span>
                <span class="s1">index=[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">margins=</span><span class="s0">True,</span>
                <span class="s1">margins_name=margin_name</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s4"># non-multi-index index/column</span>
            <span class="s1">pivot_table(</span>
                <span class="s1">self.data</span><span class="s0">,</span>
                <span class="s1">values=</span><span class="s3">&quot;D&quot;</span><span class="s0">,</span>
                <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">columns=[</span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">margins=</span><span class="s0">True,</span>
                <span class="s1">margins_name=margin_name</span><span class="s0">,</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pivot_timegrouper(self</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Branch&quot;</span><span class="s1">: </span><span class="s3">&quot;A A A A A A A B&quot;</span><span class="s1">.split()</span><span class="s0">,</span>
                <span class="s3">&quot;Buyer&quot;</span><span class="s1">: </span><span class="s3">&quot;Carl Mark Carl Carl Joe Joe Joe Carl&quot;</span><span class="s1">.split()</span><span class="s0">,</span>
                <span class="s3">&quot;Quantity&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Date&quot;</span><span class="s1">: [</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">).set_index(</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array([</span><span class="s2">10</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">).reshape(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=pd.DatetimeIndex([datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;Carl Joe Mark&quot;</span><span class="s1">.split()</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.index.name = </span><span class="s3">&quot;Date&quot;</span>
        <span class="s1">expected.columns.name = </span><span class="s3">&quot;Buyer&quot;</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.T)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s1">np.nan]).reshape(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=pd.DatetimeIndex(</span>
                <span class="s1">[datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;6MS&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;Carl Joe Mark&quot;</span><span class="s1">.split()</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.index.name = </span><span class="s3">&quot;Date&quot;</span>
        <span class="s1">expected.columns.name = </span><span class="s3">&quot;Buyer&quot;</span>
        <span class="s0">if </span><span class="s1">using_array_manager:</span>
            <span class="s4"># INFO(ArrayManager) column without NaNs can preserve int dtype</span>
            <span class="s1">expected[</span><span class="s3">&quot;Carl&quot;</span><span class="s1">] = expected[</span><span class="s3">&quot;Carl&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.T)</span>

        <span class="s4"># passing the name</span>
        <span class="s1">df = df.reset_index()</span>
        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.T)</span>

        <span class="s1">msg = </span><span class="s3">&quot;'The grouper name foo is not found'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">pivot_table(</span>
                <span class="s1">df</span><span class="s0">,</span>
                <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">columns=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
                <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
                <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">pivot_table(</span>
                <span class="s1">df</span><span class="s0">,</span>
                <span class="s1">index=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
                <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
                <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s4"># passing the level</span>
        <span class="s1">df = df.set_index(</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span>
        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">level=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
            <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">level=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.T)</span>

        <span class="s1">msg = </span><span class="s3">&quot;The level foo is not valid&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">pivot_table(</span>
                <span class="s1">df</span><span class="s0">,</span>
                <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">level=</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">columns=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
                <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
                <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">pivot_table(</span>
                <span class="s1">df</span><span class="s0">,</span>
                <span class="s1">index=</span><span class="s3">&quot;Buyer&quot;</span><span class="s0">,</span>
                <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;6MS&quot;</span><span class="s0">, </span><span class="s1">level=</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
                <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s4"># double grouper</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Branch&quot;</span><span class="s1">: </span><span class="s3">&quot;A A A A A A A B&quot;</span><span class="s1">.split()</span><span class="s0">,</span>
                <span class="s3">&quot;Buyer&quot;</span><span class="s1">: </span><span class="s3">&quot;Carl Mark Carl Carl Joe Joe Joe Carl&quot;</span><span class="s1">.split()</span><span class="s0">,</span>
                <span class="s3">&quot;Quantity&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Date&quot;</span><span class="s1">: [</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;PayDay&quot;</span><span class="s1">: [</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">5</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">30</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;PayDay&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s2">3</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s2">6</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s2">1</span><span class="s0">,</span>
                    <span class="s2">9</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s2">9</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                    <span class="s2">3</span><span class="s0">,</span>
                    <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">]</span>
            <span class="s1">).reshape(</span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=pd.DatetimeIndex(</span>
                <span class="s1">[</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">30</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">30</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=pd.DatetimeIndex(</span>
                <span class="s1">[</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">30</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">30</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.index.name = </span><span class="s3">&quot;Date&quot;</span>
        <span class="s1">expected.columns.name = </span><span class="s3">&quot;PayDay&quot;</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;PayDay&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.T)</span>

        <span class="s1">tuples = [</span>
            <span class="s1">(datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">30</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">31</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">30</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">30</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">31</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">30</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">31</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">31</span><span class="s1">)</span><span class="s0">, </span><span class="s1">datetime(</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">30</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">idx = MultiIndex.from_tuples(tuples</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;Date&quot;</span><span class="s0">, </span><span class="s3">&quot;PayDay&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span>
            <span class="s1">).reshape(</span><span class="s2">6</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=idx</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected.columns.name = </span><span class="s3">&quot;Branch&quot;</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=[Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;PayDay&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;Branch&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;Branch&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;Date&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Grouper(freq=</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;PayDay&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;Quantity&quot;</span><span class="s0">,</span>
            <span class="s1">aggfunc=np.sum</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected.T)</span>

    <span class="s0">def </span><span class="s1">test_pivot_datetime_tz(self):</span>
        <span class="s1">dates1 = [</span>
            <span class="s3">&quot;2011-07-19 07:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 08:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 09:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 07:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 08:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 09:00:00&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">dates2 = [</span>
            <span class="s3">&quot;2013-01-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-01-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-01-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-02-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-02-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-02-01 15:00:00&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;label&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;dt1&quot;</span><span class="s1">: dates1</span><span class="s0">,</span>
                <span class="s3">&quot;dt2&quot;</span><span class="s1">: dates2</span><span class="s0">,</span>
                <span class="s3">&quot;value1&quot;</span><span class="s1">: np.arange(</span><span class="s2">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value2&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">] * </span><span class="s2">3</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">d: pd.Timestamp(d</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">d: pd.Timestamp(d</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Asia/Tokyo&quot;</span><span class="s1">))</span>

        <span class="s1">exp_idx = pd.DatetimeIndex(</span>
            <span class="s1">[</span><span class="s3">&quot;2011-07-19 07:00:00&quot;</span><span class="s0">, </span><span class="s3">&quot;2011-07-19 08:00:00&quot;</span><span class="s0">, </span><span class="s3">&quot;2011-07-19 09:00:00&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">tz=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s3">&quot;dt1&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">exp_col1 = Index([</span><span class="s3">&quot;value1&quot;</span><span class="s0">, </span><span class="s3">&quot;value1&quot;</span><span class="s1">])</span>
        <span class="s1">exp_col2 = Index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;label&quot;</span><span class="s1">)</span>
        <span class="s1">exp_col = MultiIndex.from_arrays([exp_col1</span><span class="s0">, </span><span class="s1">exp_col2])</span>
        <span class="s1">expected = DataFrame([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=exp_idx</span><span class="s0">, </span><span class="s1">columns=exp_col)</span>
        <span class="s1">result = pivot_table(df</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;label&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">values=[</span><span class="s3">&quot;value1&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">exp_col1 = Index([</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">])</span>
        <span class="s1">exp_col2 = Index([</span><span class="s3">&quot;value1&quot;</span><span class="s0">, </span><span class="s3">&quot;value1&quot;</span><span class="s0">, </span><span class="s3">&quot;value2&quot;</span><span class="s0">, </span><span class="s3">&quot;value2&quot;</span><span class="s1">] * </span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">exp_col3 = pd.DatetimeIndex(</span>
            <span class="s1">[</span><span class="s3">&quot;2013-01-01 15:00:00&quot;</span><span class="s0">, </span><span class="s3">&quot;2013-02-01 15:00:00&quot;</span><span class="s1">] * </span><span class="s2">4</span><span class="s0">,</span>
            <span class="s1">tz=</span><span class="s3">&quot;Asia/Tokyo&quot;</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s3">&quot;dt2&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">exp_col = MultiIndex.from_arrays([exp_col1</span><span class="s0">, </span><span class="s1">exp_col2</span><span class="s0">, </span><span class="s1">exp_col3])</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=exp_idx</span><span class="s0">,</span>
            <span class="s1">columns=exp_col</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">values=[</span><span class="s3">&quot;value1&quot;</span><span class="s0">, </span><span class="s3">&quot;value2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">aggfunc=[np.sum</span><span class="s0">, </span><span class="s1">np.mean]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_dtaccessor(self):</span>
        <span class="s4"># GH 8103</span>
        <span class="s1">dates1 = [</span>
            <span class="s3">&quot;2011-07-19 07:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 08:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 09:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 07:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 08:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2011-07-19 09:00:00&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">dates2 = [</span>
            <span class="s3">&quot;2013-01-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-01-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-01-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-02-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-02-01 15:00:00&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2013-02-01 15:00:00&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;label&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;dt1&quot;</span><span class="s1">: dates1</span><span class="s0">,</span>
                <span class="s3">&quot;dt2&quot;</span><span class="s1">: dates2</span><span class="s0">,</span>
                <span class="s3">&quot;value1&quot;</span><span class="s1">: np.arange(</span><span class="s2">6</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;value2&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">] * </span><span class="s2">3</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">d: pd.Timestamp(d))</span>
        <span class="s1">df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">].apply(</span><span class="s0">lambda </span><span class="s1">d: pd.Timestamp(d))</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;label&quot;</span><span class="s0">, </span><span class="s1">columns=df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">].dt.hour</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;value1&quot;</span>
        <span class="s1">)</span>

        <span class="s1">exp_idx = Index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;label&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">7</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">8</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s2">9</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=exp_idx</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;dt1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">index=df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">].dt.month</span><span class="s0">, </span><span class="s1">columns=df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">].dt.hour</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;value1&quot;</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s2">7</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">8</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s2">9</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;dt2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;dt1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">].dt.year.values</span><span class="s0">,</span>
            <span class="s1">columns=[df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">].dt.hour</span><span class="s0">, </span><span class="s1">df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">].dt.month]</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;value1&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">exp_col = MultiIndex.from_arrays(</span>
            <span class="s1">[[</span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">] * </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;dt1&quot;</span><span class="s0">, </span><span class="s3">&quot;dt2&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">2013</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=exp_col</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">index=np.array([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">columns=[df[</span><span class="s3">&quot;dt1&quot;</span><span class="s1">].dt.hour</span><span class="s0">, </span><span class="s1">df[</span><span class="s3">&quot;dt2&quot;</span><span class="s1">].dt.month]</span><span class="s0">,</span>
            <span class="s1">values=</span><span class="s3">&quot;value1&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">columns=exp_col</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_daily(self):</span>
        <span class="s1">rng = date_range(</span><span class="s3">&quot;1/1/2000&quot;</span><span class="s0">, </span><span class="s3">&quot;12/31/2004&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span>
        <span class="s1">ts = Series(np.random.randn(len(rng))</span><span class="s0">, </span><span class="s1">index=rng)</span>

        <span class="s1">annual = pivot_table(</span>
            <span class="s1">DataFrame(ts)</span><span class="s0">, </span><span class="s1">index=ts.index.year</span><span class="s0">, </span><span class="s1">columns=ts.index.dayofyear</span>
        <span class="s1">)</span>
        <span class="s1">annual.columns = annual.columns.droplevel(</span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">doy = np.asarray(ts.index.dayofyear)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">367</span><span class="s1">):</span>
            <span class="s1">subset = ts[doy == i]</span>
            <span class="s1">subset.index = subset.index.year</span>

            <span class="s1">result = annual[i].dropna()</span>
            <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">subset</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">result.name == i</span>

    <span class="s0">def </span><span class="s1">test_monthly(self):</span>
        <span class="s1">rng = date_range(</span><span class="s3">&quot;1/1/2000&quot;</span><span class="s0">, </span><span class="s3">&quot;12/31/2004&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;M&quot;</span><span class="s1">)</span>
        <span class="s1">ts = Series(np.random.randn(len(rng))</span><span class="s0">, </span><span class="s1">index=rng)</span>

        <span class="s1">annual = pivot_table(DataFrame(ts)</span><span class="s0">, </span><span class="s1">index=ts.index.year</span><span class="s0">, </span><span class="s1">columns=ts.index.month)</span>
        <span class="s1">annual.columns = annual.columns.droplevel(</span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">month = ts.index.month</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">13</span><span class="s1">):</span>
            <span class="s1">subset = ts[month == i]</span>
            <span class="s1">subset.index = subset.index.year</span>
            <span class="s1">result = annual[i].dropna()</span>
            <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">subset</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">result.name == i</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_with_iterator_values(self):</span>
        <span class="s4"># GH 12017</span>
        <span class="s1">aggs = {</span><span class="s3">&quot;D&quot;</span><span class="s1">: </span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">: </span><span class="s3">&quot;mean&quot;</span><span class="s1">}</span>

        <span class="s1">pivot_values_list = pivot_table(</span>
            <span class="s1">self.data</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">values=list(aggs.keys())</span><span class="s0">, </span><span class="s1">aggfunc=aggs</span>
        <span class="s1">)</span>

        <span class="s1">pivot_values_keys = pivot_table(</span>
            <span class="s1">self.data</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">values=aggs.keys()</span><span class="s0">, </span><span class="s1">aggfunc=aggs</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(pivot_values_keys</span><span class="s0">, </span><span class="s1">pivot_values_list)</span>

        <span class="s1">agg_values_gen = (value </span><span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s1">aggs.keys())</span>
        <span class="s1">pivot_values_gen = pivot_table(</span>
            <span class="s1">self.data</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">values=agg_values_gen</span><span class="s0">, </span><span class="s1">aggfunc=aggs</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(pivot_values_gen</span><span class="s0">, </span><span class="s1">pivot_values_list)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_margins_name_with_aggfunc_list(self):</span>
        <span class="s4"># GH 13354</span>
        <span class="s1">margins_name = </span><span class="s3">&quot;Weekly&quot;</span>
        <span class="s1">costs = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;item&quot;</span><span class="s1">: [</span><span class="s3">&quot;bacon&quot;</span><span class="s0">, </span><span class="s3">&quot;cheese&quot;</span><span class="s0">, </span><span class="s3">&quot;bacon&quot;</span><span class="s0">, </span><span class="s3">&quot;cheese&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;cost&quot;</span><span class="s1">: [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">4.5</span><span class="s0">, </span><span class="s2">3.2</span><span class="s0">, </span><span class="s2">3.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;day&quot;</span><span class="s1">: [</span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s3">&quot;M&quot;</span><span class="s0">, </span><span class="s3">&quot;T&quot;</span><span class="s0">, </span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">table = costs.pivot_table(</span>
            <span class="s1">index=</span><span class="s3">&quot;item&quot;</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;day&quot;</span><span class="s0">,</span>
            <span class="s1">margins=</span><span class="s0">True,</span>
            <span class="s1">margins_name=margins_name</span><span class="s0">,</span>
            <span class="s1">aggfunc=[np.mean</span><span class="s0">, </span><span class="s1">max]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">ix = Index([</span><span class="s3">&quot;bacon&quot;</span><span class="s0">, </span><span class="s3">&quot;cheese&quot;</span><span class="s0">, </span><span class="s1">margins_name]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;item&quot;</span><span class="s1">)</span>
        <span class="s1">tups = [</span>
            <span class="s1">(</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;cost&quot;</span><span class="s0">, </span><span class="s3">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;cost&quot;</span><span class="s0">, </span><span class="s3">&quot;T&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;cost&quot;</span><span class="s0">, </span><span class="s1">margins_name)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s3">&quot;cost&quot;</span><span class="s0">, </span><span class="s3">&quot;M&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s3">&quot;cost&quot;</span><span class="s0">, </span><span class="s3">&quot;T&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s3">&quot;cost&quot;</span><span class="s0">, </span><span class="s1">margins_name)</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">cols = MultiIndex.from_tuples(tups</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, None, </span><span class="s3">&quot;day&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame(table.values</span><span class="s0">, </span><span class="s1">index=ix</span><span class="s0">, </span><span class="s1">columns=cols)</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_categorical_margins(self</span><span class="s0">, </span><span class="s1">observed</span><span class="s0">, </span><span class="s1">request):</span>
        <span class="s0">if </span><span class="s1">observed:</span>
            <span class="s1">request.node.add_marker(</span>
                <span class="s1">pytest.mark.xfail(</span>
                    <span class="s1">reason=</span><span class="s3">&quot;GH#17035 (np.mean of ints is casted back to ints)&quot;</span>
                <span class="s1">)</span>
            <span class="s1">)</span>
        <span class="s4"># GH 10989</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">) // </span><span class="s2">4</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">) % </span><span class="s2">2</span><span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame([[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">5.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">3.5</span><span class="s1">]])</span>
        <span class="s1">expected.index = Index([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;y&quot;</span><span class="s1">)</span>
        <span class="s1">expected.columns = Index([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;z&quot;</span><span class="s1">)</span>

        <span class="s1">table = df.pivot_table(</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s1">dropna=observed</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_categorical_margins_category(self</span><span class="s0">, </span><span class="s1">observed</span><span class="s0">, </span><span class="s1">request):</span>
        <span class="s0">if </span><span class="s1">observed:</span>
            <span class="s1">request.node.add_marker(</span>
                <span class="s1">pytest.mark.xfail(</span>
                    <span class="s1">reason=</span><span class="s3">&quot;GH#17035 (np.mean of ints is casted back to ints)&quot;</span>
                <span class="s1">)</span>
            <span class="s1">)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">) // </span><span class="s2">4</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: np.arange(</span><span class="s2">8</span><span class="s1">) % </span><span class="s2">2</span><span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame([[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">5.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">3.5</span><span class="s1">]])</span>
        <span class="s1">expected.index = Index([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;y&quot;</span><span class="s1">)</span>
        <span class="s1">expected.columns = Index([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;z&quot;</span><span class="s1">)</span>

        <span class="s1">df.y = df.y.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">df.z = df.z.astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">table = df.pivot_table(</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s1">dropna=observed</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_margins_casted_to_float(self</span><span class="s0">, </span><span class="s1">observed):</span>
        <span class="s4"># GH 24893</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;D&quot;</span><span class="s1">: [</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = pivot_table(df</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">6.5</span><span class="s0">, </span><span class="s2">4.5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">3.5</span><span class="s1">]}</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_with_categorical(self</span><span class="s0">, </span><span class="s1">observed</span><span class="s0">, </span><span class="s1">ordered):</span>
        <span class="s4"># gh-21370</span>
        <span class="s1">idx = [np.nan</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s0">, </span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">col = [np.nan</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;In&quot;</span><span class="s1">: Categorical(idx</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=ordered)</span><span class="s0">,</span>
                <span class="s3">&quot;Col&quot;</span><span class="s1">: Categorical(col</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=ordered)</span><span class="s0">,</span>
                <span class="s3">&quot;Val&quot;</span><span class="s1">: range(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">6</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s4"># case with index/columns/value</span>
        <span class="s1">result = df.pivot_table(</span>
            <span class="s1">index=</span><span class="s3">&quot;In&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;Col&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;Val&quot;</span><span class="s0">, </span><span class="s1">observed=observed</span>
        <span class="s1">)</span>

        <span class="s1">expected_cols = pd.CategoricalIndex([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=ordered</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;Col&quot;</span><span class="s1">)</span>

        <span class="s1">expected = DataFrame(data=[[</span><span class="s2">2.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=expected_cols)</span>
        <span class="s1">expected.index = Index(</span>
            <span class="s1">Categorical([</span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;low&quot;</span><span class="s0">, </span><span class="s3">&quot;high&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=ordered)</span><span class="s0">,</span>
            <span class="s1">name=</span><span class="s3">&quot;In&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># case with columns/value</span>
        <span class="s1">result = df.pivot_table(columns=</span><span class="s3">&quot;Col&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;Val&quot;</span><span class="s0">, </span><span class="s1">observed=observed)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">data=[[</span><span class="s2">3.5</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=expected_cols</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">&quot;Val&quot;</span><span class="s1">])</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_categorical_aggfunc(self</span><span class="s0">, </span><span class="s1">observed):</span>
        <span class="s4"># GH 9534</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;C1&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;C2&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;V&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s3">&quot;C1&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;C1&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">result = df.pivot_table(</span>
            <span class="s3">&quot;V&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;C1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;C2&quot;</span><span class="s0">, </span><span class="s1">dropna=observed</span><span class="s0">, </span><span class="s1">aggfunc=</span><span class="s3">&quot;count&quot;</span>
        <span class="s1">)</span>

        <span class="s1">expected_index = pd.CategoricalIndex(</span>
            <span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False, </span><span class="s1">name=</span><span class="s3">&quot;C1&quot;</span>
        <span class="s1">)</span>
        <span class="s1">expected_columns = Index([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;C2&quot;</span><span class="s1">)</span>
        <span class="s1">expected_data = np.array([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">expected_data</span><span class="s0">, </span><span class="s1">index=expected_index</span><span class="s0">, </span><span class="s1">columns=expected_columns</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_categorical_pivot_index_ordering(self</span><span class="s0">, </span><span class="s1">observed):</span>
        <span class="s4"># GH 8731</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;Sales&quot;</span><span class="s1">: [</span><span class="s2">100</span><span class="s0">, </span><span class="s2">120</span><span class="s0">, </span><span class="s2">220</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Month&quot;</span><span class="s1">: [</span><span class="s3">&quot;January&quot;</span><span class="s0">, </span><span class="s3">&quot;January&quot;</span><span class="s0">, </span><span class="s3">&quot;January&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;Year&quot;</span><span class="s1">: [</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">2014</span><span class="s0">, </span><span class="s2">2013</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">months = [</span>
            <span class="s3">&quot;January&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;February&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;March&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;April&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;May&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;June&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;July&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;August&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;September&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;October&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;November&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;December&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
        <span class="s1">df[</span><span class="s3">&quot;Month&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;Month&quot;</span><span class="s1">].astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">).cat.set_categories(months)</span>
        <span class="s1">result = df.pivot_table(</span>
            <span class="s1">values=</span><span class="s3">&quot;Sales&quot;</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s3">&quot;Month&quot;</span><span class="s0">,</span>
            <span class="s1">columns=</span><span class="s3">&quot;Year&quot;</span><span class="s0">,</span>
            <span class="s1">observed=observed</span><span class="s0">,</span>
            <span class="s1">aggfunc=</span><span class="s3">&quot;sum&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected_columns = Index([</span><span class="s2">2013</span><span class="s0">, </span><span class="s2">2014</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;Year&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">expected_index = pd.CategoricalIndex(</span>
            <span class="s1">months</span><span class="s0">, </span><span class="s1">categories=months</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False, </span><span class="s1">name=</span><span class="s3">&quot;Month&quot;</span>
        <span class="s1">)</span>
        <span class="s1">expected_data = [[</span><span class="s2">320</span><span class="s0">, </span><span class="s2">120</span><span class="s1">]] + [[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]] * </span><span class="s2">11</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">expected_data</span><span class="s0">, </span><span class="s1">index=expected_index</span><span class="s0">, </span><span class="s1">columns=expected_columns</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">observed:</span>
            <span class="s1">expected = expected.loc[[</span><span class="s3">&quot;January&quot;</span><span class="s1">]]</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_not_series(self):</span>
        <span class="s4"># GH 4386</span>
        <span class="s4"># pivot_table always returns a DataFrame</span>
        <span class="s4"># when values is not list like and columns is None</span>
        <span class="s4"># and aggfunc is not instance of list</span>
        <span class="s1">df = DataFrame({</span><span class="s3">&quot;col1&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">: [</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;col3&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]})</span>

        <span class="s1">result = df.pivot_table(</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;col3&quot;</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">aggfunc=np.sum)</span>
        <span class="s1">m = MultiIndex.from_arrays([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;col3&quot;</span><span class="s0">, </span><span class="s3">&quot;col2&quot;</span><span class="s1">])</span>
        <span class="s1">expected = DataFrame([</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=m</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;col1&quot;</span><span class="s1">])</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.pivot_table(</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;col3&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;col2&quot;</span><span class="s0">, </span><span class="s1">aggfunc=np.sum)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.NaN</span><span class="s0">, </span><span class="s1">np.NaN]</span><span class="s0">, </span><span class="s1">[np.NaN</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.NaN]</span><span class="s0">, </span><span class="s1">[np.NaN</span><span class="s0">, </span><span class="s1">np.NaN</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">index=Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;col3&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;col2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.pivot_table(</span><span class="s3">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;col3&quot;</span><span class="s0">, </span><span class="s1">aggfunc=[np.sum])</span>
        <span class="s1">m = MultiIndex.from_arrays([[</span><span class="s3">&quot;sum&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;col1&quot;</span><span class="s1">]])</span>
        <span class="s1">expected = DataFrame([</span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;col3&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=m)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_margins_name_unicode(self):</span>
        <span class="s4"># issue #13292</span>
        <span class="s1">greek = </span><span class="s3">&quot;</span><span class="s0">\u0394\u03bf\u03ba\u03b9\u03bc\u03ae</span><span class="s3">&quot;</span>
        <span class="s1">frame = DataFrame({</span><span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]})</span>
        <span class="s1">table = pivot_table(</span>
            <span class="s1">frame</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">aggfunc=len</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True, </span><span class="s1">margins_name=greek</span>
        <span class="s1">)</span>
        <span class="s1">index = Index([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">greek]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;object&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(index=index)</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_string_as_func(self):</span>
        <span class="s4"># GH #18713</span>
        <span class="s4"># for correctness purposes</span>
        <span class="s1">data = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: range(</span><span class="s2">11</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = pivot_table(data</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">aggfunc=</span><span class="s3">&quot;sum&quot;</span><span class="s1">)</span>
        <span class="s1">mi = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">codes=[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s1">): {</span><span class="s3">&quot;bar&quot;</span><span class="s1">: </span><span class="s2">15</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">: </span><span class="s2">13</span><span class="s1">}</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">): {</span><span class="s3">&quot;bar&quot;</span><span class="s1">: </span><span class="s2">7</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">: </span><span class="s2">20</span><span class="s1">}}</span><span class="s0">,</span>
            <span class="s1">columns=mi</span><span class="s0">,</span>
        <span class="s1">).rename_axis(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pivot_table(data</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">aggfunc=[</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">])</span>
        <span class="s1">mi = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">codes=[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, None, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s1">(</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s1">): {</span><span class="s3">&quot;bar&quot;</span><span class="s1">: </span><span class="s2">5.0</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">: </span><span class="s2">3.25</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">): {</span><span class="s3">&quot;bar&quot;</span><span class="s1">: </span><span class="s2">7.0</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">: </span><span class="s2">6.666666666666667</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s1">): {</span><span class="s3">&quot;bar&quot;</span><span class="s1">: </span><span class="s2">15</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">: </span><span class="s2">13</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">): {</span><span class="s3">&quot;bar&quot;</span><span class="s1">: </span><span class="s2">7</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">: </span><span class="s2">20</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">columns=mi</span><span class="s0">,</span>
        <span class="s1">).rename_axis(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;f, f_numpy&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">np.sum)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">np.mean)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;std&quot;</span><span class="s0">, </span><span class="s1">np.std)</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.sum</span><span class="s0">, </span><span class="s1">np.mean])</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;std&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.sum</span><span class="s0">, </span><span class="s1">np.std])</span><span class="s0">,</span>
            <span class="s1">([</span><span class="s3">&quot;std&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.std</span><span class="s0">, </span><span class="s1">np.mean])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_pivot_string_func_vs_func(self</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f_numpy):</span>
        <span class="s4"># GH #18713</span>
        <span class="s4"># for consistency purposes</span>
        <span class="s1">result = pivot_table(self.data</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">aggfunc=f)</span>
        <span class="s1">expected = pivot_table(self.data</span><span class="s0">, </span><span class="s1">index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s1">aggfunc=f_numpy)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.slow</span>
    <span class="s0">def </span><span class="s1">test_pivot_number_of_levels_larger_than_int32(self</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
        <span class="s4"># GH 20601</span>
        <span class="s4"># GH 26314: Change ValueError to PerformanceWarning</span>
        <span class="s0">class </span><span class="s1">MockUnstacker(reshape_lib._Unstacker):</span>
            <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
                <span class="s4"># __init__ will raise the warning</span>
                <span class="s1">super().__init__(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
                <span class="s0">raise </span><span class="s1">Exception(</span><span class="s3">&quot;Don't compute final result.&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">monkeypatch.context() </span><span class="s0">as </span><span class="s1">m:</span>
            <span class="s1">m.setattr(reshape_lib</span><span class="s0">, </span><span class="s3">&quot;_Unstacker&quot;</span><span class="s0">, </span><span class="s1">MockUnstacker)</span>
            <span class="s1">df = DataFrame(</span>
                <span class="s1">{</span><span class="s3">&quot;ind1&quot;</span><span class="s1">: np.arange(</span><span class="s2">2 </span><span class="s1">** </span><span class="s2">16</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;ind2&quot;</span><span class="s1">: np.arange(</span><span class="s2">2 </span><span class="s1">** </span><span class="s2">16</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;count&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s1">}</span>
            <span class="s1">)</span>

            <span class="s1">msg = </span><span class="s3">&quot;The following operation may generate&quot;</span>
            <span class="s0">with </span><span class="s1">tm.assert_produces_warning(PerformanceWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s0">with </span><span class="s1">pytest.raises(Exception</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;Don't compute final result.&quot;</span><span class="s1">):</span>
                    <span class="s1">df.pivot_table(</span>
                        <span class="s1">index=</span><span class="s3">&quot;ind1&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;ind2&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;count&quot;</span><span class="s0">, </span><span class="s1">aggfunc=</span><span class="s3">&quot;count&quot;</span>
                    <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_aggfunc_dropna(self</span><span class="s0">, </span><span class="s1">dropna):</span>
        <span class="s4"># GH 22159</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;fruit&quot;</span><span class="s1">: [</span><span class="s3">&quot;apple&quot;</span><span class="s0">, </span><span class="s3">&quot;peach&quot;</span><span class="s0">, </span><span class="s3">&quot;apple&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;size&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;taste&quot;</span><span class="s1">: [</span><span class="s2">7</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s0">def </span><span class="s1">ret_one(x):</span>
            <span class="s0">return </span><span class="s2">1</span>

        <span class="s0">def </span><span class="s1">ret_sum(x):</span>
            <span class="s0">return </span><span class="s1">sum(x)</span>

        <span class="s0">def </span><span class="s1">ret_none(x):</span>
            <span class="s0">return </span><span class="s1">np.nan</span>

        <span class="s1">result = pivot_table(</span>
            <span class="s1">df</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;fruit&quot;</span><span class="s0">, </span><span class="s1">aggfunc=[ret_sum</span><span class="s0">, </span><span class="s1">ret_none</span><span class="s0">, </span><span class="s1">ret_one]</span><span class="s0">, </span><span class="s1">dropna=dropna</span>
        <span class="s1">)</span>

        <span class="s1">data = [[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">13</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span>
        <span class="s1">col = MultiIndex.from_product(</span>
            <span class="s1">[[</span><span class="s3">&quot;ret_sum&quot;</span><span class="s0">, </span><span class="s3">&quot;ret_none&quot;</span><span class="s0">, </span><span class="s3">&quot;ret_one&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;apple&quot;</span><span class="s0">, </span><span class="s3">&quot;peach&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s0">None, </span><span class="s3">&quot;fruit&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(data</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;size&quot;</span><span class="s0">, </span><span class="s3">&quot;taste&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=col)</span>

        <span class="s0">if </span><span class="s1">dropna:</span>
            <span class="s1">expected = expected.dropna(axis=</span><span class="s3">&quot;columns&quot;</span><span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_aggfunc_scalar_dropna(self</span><span class="s0">, </span><span class="s1">dropna):</span>
        <span class="s4"># GH 22159</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]}</span>
        <span class="s1">)</span>

        <span class="s1">result = pivot_table(df</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">aggfunc=np.mean</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>

        <span class="s1">data = [[</span><span class="s2">2.5</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan]]</span>
        <span class="s1">col = Index([</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(data</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=col)</span>

        <span class="s0">if </span><span class="s1">dropna:</span>
            <span class="s1">expected = expected.dropna(axis=</span><span class="s3">&quot;columns&quot;</span><span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_empty_aggfunc(self):</span>
        <span class="s4"># GH 9186 &amp; GH 13483</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">&quot;p&quot;</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s0">, </span><span class="s3">&quot;p&quot;</span><span class="s0">, </span><span class="s3">&quot;q&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;D&quot;</span><span class="s1">: [</span><span class="s0">None, None, None, None, None</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = df.pivot_table(index=</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">aggfunc=np.size)</span>
        <span class="s1">expected = DataFrame(index=Index([]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
        <span class="s1">expected.columns.name = </span><span class="s3">&quot;D&quot;</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_no_column_raises(self):</span>
        <span class="s4"># GH 10326</span>
        <span class="s0">def </span><span class="s1">agg(arr):</span>
            <span class="s0">return </span><span class="s1">np.mean(arr)</span>

        <span class="s1">foo = DataFrame({</span><span class="s3">&quot;X&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;Z&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">30</span><span class="s0">, </span><span class="s2">40</span><span class="s1">]})</span>
        <span class="s0">with </span><span class="s1">pytest.raises(KeyError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;notpresent&quot;</span><span class="s1">):</span>
            <span class="s1">foo.pivot_table(</span><span class="s3">&quot;notpresent&quot;</span><span class="s0">, </span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s0">, </span><span class="s1">aggfunc=agg)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_multiindex_columns_doctest_case(self):</span>
        <span class="s4"># The relevant characteristic is that the call</span>
        <span class="s4">#  to maybe_downcast_to_dtype(agged[v], data[v].dtype) in</span>
        <span class="s4">#  __internal_pivot_table has `agged[v]` a DataFrame instead of Series,</span>
        <span class="s4">#  In this case this is because agged.columns is a MultiIndex and 'v'</span>
        <span class="s4">#  is only indexing on its first level.</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;C&quot;</span><span class="s1">: [</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;small&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;large&quot;</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;D&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;E&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">table = pivot_table(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">values=[</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">aggfunc={</span><span class="s3">&quot;D&quot;</span><span class="s1">: np.mean</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s1">: [min</span><span class="s0">, </span><span class="s1">max</span><span class="s0">, </span><span class="s1">np.mean]}</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">cols = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s1">)]</span>
        <span class="s1">)</span>
        <span class="s1">index = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;large&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;small&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;large&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;small&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">vals = np.array(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">5.5</span><span class="s0">, </span><span class="s2">9.0</span><span class="s0">, </span><span class="s2">7.5</span><span class="s0">, </span><span class="s2">6.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">5.5</span><span class="s0">, </span><span class="s2">9.0</span><span class="s0">, </span><span class="s2">8.5</span><span class="s0">, </span><span class="s2">8.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">4.5</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">2.33333333</span><span class="s0">, </span><span class="s2">6.0</span><span class="s0">, </span><span class="s2">4.33333333</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(vals</span><span class="s0">, </span><span class="s1">columns=cols</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">expected[(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s1">)] = expected[(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s1">)].astype(np.int64)</span>
        <span class="s1">expected[(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s1">)] = expected[(</span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s1">)].astype(np.int64)</span>
        <span class="s1">tm.assert_frame_equal(table</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_sort_false(self):</span>
        <span class="s4"># GH#39143</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;col&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;num&quot;</span><span class="s1">: [</span><span class="s2">23</span><span class="s0">, </span><span class="s2">21</span><span class="s0">, </span><span class="s2">34</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">&quot;2018&quot;</span><span class="s0">, </span><span class="s3">&quot;2018&quot;</span><span class="s0">, </span><span class="s3">&quot;2019&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = df.pivot_table(</span>
            <span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;year&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;num&quot;</span><span class="s0">, </span><span class="s1">aggfunc=</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s2">23</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">21</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">34</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=Index([</span><span class="s3">&quot;2018&quot;</span><span class="s0">, </span><span class="s3">&quot;2019&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;year&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_arrays(</span>
                <span class="s1">[[</span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;col&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_table_with_margins_and_numeric_columns(self):</span>
        <span class="s4"># GH 26568</span>
        <span class="s1">df = DataFrame([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]])</span>
        <span class="s1">df.columns = [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">30</span><span class="s1">]</span>

        <span class="s1">result = df.pivot_table(</span>
            <span class="s1">index=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">columns=</span><span class="s2">20</span><span class="s0">, </span><span class="s1">values=</span><span class="s2">30</span><span class="s0">, </span><span class="s1">aggfunc=</span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">margins=</span><span class="s0">True</span>
        <span class="s1">)</span>

        <span class="s1">expected = DataFrame([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]])</span>
        <span class="s1">expected.columns = [</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span>
        <span class="s1">expected.index = [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;All&quot;</span><span class="s1">]</span>
        <span class="s1">expected.columns.name = </span><span class="s2">20</span>
        <span class="s1">expected.index.name = </span><span class="s2">10</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">class </span><span class="s1">TestPivot:</span>
    <span class="s0">def </span><span class="s1">test_pivot(self):</span>
        <span class="s1">data = {</span>
            <span class="s3">&quot;index&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;columns&quot;</span><span class="s1">: [</span><span class="s3">&quot;One&quot;</span><span class="s0">, </span><span class="s3">&quot;One&quot;</span><span class="s0">, </span><span class="s3">&quot;One&quot;</span><span class="s0">, </span><span class="s3">&quot;Two&quot;</span><span class="s0">, </span><span class="s3">&quot;Two&quot;</span><span class="s0">, </span><span class="s3">&quot;Two&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>

        <span class="s1">frame = DataFrame(data)</span>
        <span class="s1">pivoted = frame.pivot(index=</span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;columns&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;values&quot;</span><span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;One&quot;</span><span class="s1">: {</span><span class="s3">&quot;A&quot;</span><span class="s1">: </span><span class="s2">1.0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s2">2.0</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: </span><span class="s2">3.0</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;Two&quot;</span><span class="s1">: {</span><span class="s3">&quot;A&quot;</span><span class="s1">: </span><span class="s2">1.0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s2">2.0</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: </span><span class="s2">3.0</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected.index.name</span><span class="s0">, </span><span class="s1">expected.columns.name = </span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s3">&quot;columns&quot;</span>
        <span class="s1">tm.assert_frame_equal(pivoted</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># name tracking</span>
        <span class="s0">assert </span><span class="s1">pivoted.index.name == </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">assert </span><span class="s1">pivoted.columns.name == </span><span class="s3">&quot;columns&quot;</span>

        <span class="s4"># don't specify values</span>
        <span class="s1">pivoted = frame.pivot(index=</span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s1">columns=</span><span class="s3">&quot;columns&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">pivoted.index.name == </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">assert </span><span class="s1">pivoted.columns.names == (</span><span class="s0">None, </span><span class="s3">&quot;columns&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pivot_duplicates(self):</span>
        <span class="s1">data = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;duplicate entries&quot;</span><span class="s1">):</span>
            <span class="s1">data.pivot(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pivot_empty(self):</span>
        <span class="s1">df = DataFrame(columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">result = df.pivot(</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pivot_integer_bug(self):</span>
        <span class="s1">df = DataFrame(data=[(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;1&quot;</span><span class="s0">, </span><span class="s3">&quot;A1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;2&quot;</span><span class="s0">, </span><span class="s3">&quot;B2&quot;</span><span class="s1">)])</span>

        <span class="s1">result = df.pivot(index=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">columns=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">values=</span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">repr(result)</span>
        <span class="s1">tm.assert_index_equal(result.columns</span><span class="s0">, </span><span class="s1">Index([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_pivot_index_none(self):</span>
        <span class="s4"># GH#3962</span>
        <span class="s1">data = {</span>
            <span class="s3">&quot;index&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;columns&quot;</span><span class="s1">: [</span><span class="s3">&quot;One&quot;</span><span class="s0">, </span><span class="s3">&quot;One&quot;</span><span class="s0">, </span><span class="s3">&quot;One&quot;</span><span class="s0">, </span><span class="s3">&quot;Two&quot;</span><span class="s0">, </span><span class="s3">&quot;Two&quot;</span><span class="s0">, </span><span class="s3">&quot;Two&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>

        <span class="s1">frame = DataFrame(data).set_index(</span><span class="s3">&quot;index&quot;</span><span class="s1">)</span>
        <span class="s1">result = frame.pivot(columns=</span><span class="s3">&quot;columns&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;values&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;One&quot;</span><span class="s1">: {</span><span class="s3">&quot;A&quot;</span><span class="s1">: </span><span class="s2">1.0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s2">2.0</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: </span><span class="s2">3.0</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s3">&quot;Two&quot;</span><span class="s1">: {</span><span class="s3">&quot;A&quot;</span><span class="s1">: </span><span class="s2">1.0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: </span><span class="s2">2.0</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">: </span><span class="s2">3.0</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected.index.name</span><span class="s0">, </span><span class="s1">expected.columns.name = </span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s3">&quot;columns&quot;</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># omit values</span>
        <span class="s1">result = frame.pivot(columns=</span><span class="s3">&quot;columns&quot;</span><span class="s1">)</span>

        <span class="s1">expected.columns = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s3">&quot;values&quot;</span><span class="s0">, </span><span class="s3">&quot;One&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;values&quot;</span><span class="s0">, </span><span class="s3">&quot;Two&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s0">None, </span><span class="s3">&quot;columns&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">expected.index.name = </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.index.name == </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">assert </span><span class="s1">result.columns.names == (</span><span class="s0">None, </span><span class="s3">&quot;columns&quot;</span><span class="s1">)</span>
        <span class="s1">expected.columns = expected.columns.droplevel(</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">result = frame.pivot(columns=</span><span class="s3">&quot;columns&quot;</span><span class="s0">, </span><span class="s1">values=</span><span class="s3">&quot;values&quot;</span><span class="s1">)</span>

        <span class="s1">expected.columns.name = </span><span class="s3">&quot;columns&quot;</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_pivot_index_list_values_none_immutable_args(self):</span>
        <span class="s4"># GH37635</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;lev1&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;lev2&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;lev3&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;lev4&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;values&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">index = [</span><span class="s3">&quot;lev1&quot;</span><span class="s0">, </span><span class="s3">&quot;lev2&quot;</span><span class="s1">]</span>
        <span class="s1">columns = [</span><span class="s3">&quot;lev3&quot;</span><span class="s1">]</span>
        <span class="s1">result = df.pivot(index=index</span><span class="s0">, </span><span class="s1">columns=columns</span><span class="s0">, </span><span class="s1">values=</span><span class="s0">None</span><span class="s1">)</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">6.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">5.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=MultiIndex.from_arrays(</span>
                <span class="s1">[(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;lev1&quot;</span><span class="s0">, </span><span class="s3">&quot;lev2&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=MultiIndex.from_arrays(</span>
                <span class="s1">[(</span><span class="s3">&quot;lev4&quot;</span><span class="s0">, </span><span class="s3">&quot;lev4&quot;</span><span class="s0">, </span><span class="s3">&quot;values&quot;</span><span class="s0">, </span><span class="s3">&quot;values&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">names=[</span><span class="s0">None, </span><span class="s3">&quot;lev3&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s0">assert </span><span class="s1">index == [</span><span class="s3">&quot;lev1&quot;</span><span class="s0">, </span><span class="s3">&quot;lev2&quot;</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">columns == [</span><span class="s3">&quot;lev3&quot;</span><span class="s1">]</span>
</pre>
</body>
</html>