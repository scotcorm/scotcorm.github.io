<html>
<head>
<title>test_grouping.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_grouping.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; test where we are determining what we are grouping, or getting groups &quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">CategoricalIndex</span><span class="s2">,</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">MultiIndex</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">Timestamp</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">import </span><span class="s1">pandas._testing </span><span class="s2">as </span><span class="s1">tm</span>
<span class="s2">from </span><span class="s1">pandas.core.api </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">Float64Index</span><span class="s2">,</span>
    <span class="s1">Int64Index</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">pandas.core.groupby.grouper </span><span class="s2">import </span><span class="s1">Grouping</span>

<span class="s3"># selection</span>
<span class="s3"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestSelection:</span>
    <span class="s2">def </span><span class="s1">test_select_bad_cols(self):</span>
        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">g = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;</span><span class="s2">\&quot;</span><span class="s5">Columns not found: 'C'</span><span class="s2">\&quot;</span><span class="s5">&quot;</span><span class="s1">):</span>
            <span class="s1">g[[</span><span class="s5">&quot;C&quot;</span><span class="s1">]]</span>

        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;^[^A]+$&quot;</span><span class="s1">):</span>
            <span class="s3"># A should not be referenced as a bad column...</span>
            <span class="s3"># will have to rethink regex if you change message!</span>
            <span class="s1">g[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]]</span>

    <span class="s2">def </span><span class="s1">test_groupby_duplicated_column_errormsg(self):</span>
        <span class="s3"># GH7511</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">columns=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">data=[range(</span><span class="s4">4</span><span class="s1">)</span><span class="s2">, </span><span class="s1">range(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s1">)</span><span class="s2">, </span><span class="s1">range(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)]</span>
        <span class="s1">)</span>

        <span class="s1">msg = </span><span class="s5">&quot;Grouper for 'A' not 1-dimensional&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">])</span>

        <span class="s1">grouped = df.groupby(</span><span class="s5">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">c = grouped.count()</span>
        <span class="s2">assert </span><span class="s1">c.columns.nlevels == </span><span class="s4">1</span>
        <span class="s2">assert </span><span class="s1">c.columns.size == </span><span class="s4">3</span>

    <span class="s2">def </span><span class="s1">test_column_select_via_attr(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s1">result = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">).C.sum()</span>
        <span class="s1">expected = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)[</span><span class="s5">&quot;C&quot;</span><span class="s1">].sum()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">df[</span><span class="s5">&quot;mean&quot;</span><span class="s1">] = </span><span class="s4">1.5</span>
        <span class="s1">result = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">).mean()</span>
        <span class="s1">expected = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">).agg(np.mean)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_getitem_list_of_columns(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;B&quot;</span><span class="s1">: [</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;three&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;three&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;C&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s5">&quot;D&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s5">&quot;E&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)[[</span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;D&quot;</span><span class="s1">]].mean()</span>
        <span class="s1">result2 = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)[df.columns[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">4</span><span class="s1">]].mean()</span>

        <span class="s1">expected = df.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;D&quot;</span><span class="s1">]].groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">).mean()</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(result2</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_getitem_numeric_column_names(self):</span>
        <span class="s3"># GH #13731</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s4">0</span><span class="s1">: list(</span><span class="s5">&quot;abcd&quot;</span><span class="s1">) * </span><span class="s4">2</span><span class="s2">,</span>
                <span class="s4">2</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s4">4</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s4">6</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">result = df.groupby(</span><span class="s4">0</span><span class="s1">)[df.columns[</span><span class="s4">1</span><span class="s1">:</span><span class="s4">3</span><span class="s1">]].mean()</span>
        <span class="s1">result2 = df.groupby(</span><span class="s4">0</span><span class="s1">)[[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]].mean()</span>

        <span class="s1">expected = df.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]].groupby(</span><span class="s4">0</span><span class="s1">).mean()</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_frame_equal(result2</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># per GH 23566 this should raise a FutureWarning</span>
        <span class="s2">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
            <span class="s1">df.groupby(</span><span class="s4">0</span><span class="s1">)[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s1">].mean()</span>

    <span class="s2">def </span><span class="s1">test_getitem_single_list_of_columns(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s3"># per GH 23566 this should raise a FutureWarning</span>
        <span class="s2">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
            <span class="s1">df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)[</span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;D&quot;</span><span class="s1">].mean()</span>

    <span class="s2">def </span><span class="s1">test_getitem_single_column(self):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;B&quot;</span><span class="s1">: [</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;three&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;three&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;C&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s5">&quot;D&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s5">&quot;E&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">8</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">result = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)[</span><span class="s5">&quot;C&quot;</span><span class="s1">].mean()</span>

        <span class="s1">as_frame = df.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]].groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">).mean()</span>
        <span class="s1">as_series = as_frame.iloc[:</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">expected = as_series</span>

        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_indices_grouped_by_tuple_with_lambda(self):</span>
        <span class="s3"># GH 36158</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;Tuples&quot;</span><span class="s1">: ((x</span><span class="s2">, </span><span class="s1">y) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">] </span><span class="s2">for </span><span class="s1">y </span><span class="s2">in </span><span class="s1">np.random.randint(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s1">))}</span>
        <span class="s1">)</span>

        <span class="s1">gb = df.groupby(</span><span class="s5">&quot;Tuples&quot;</span><span class="s1">)</span>
        <span class="s1">gb_lambda = df.groupby(</span><span class="s2">lambda </span><span class="s1">x: df.iloc[x</span><span class="s2">, </span><span class="s4">0</span><span class="s1">])</span>

        <span class="s1">expected = gb.indices</span>
        <span class="s1">result = gb_lambda.indices</span>

        <span class="s1">tm.assert_dict_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s3"># grouping</span>
<span class="s3"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestGrouping:</span>
    <span class="s2">def </span><span class="s1">test_grouper_index_types(self):</span>
        <span class="s3"># related GH5375</span>
        <span class="s3"># groupby misbehaving when using a Floatlike index</span>
        <span class="s1">df = DataFrame(np.arange(</span><span class="s4">10</span><span class="s1">).reshape(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;AB&quot;</span><span class="s1">))</span>
        <span class="s2">for </span><span class="s1">index </span><span class="s2">in </span><span class="s1">[</span>
            <span class="s1">tm.makeFloatIndex</span><span class="s2">,</span>
            <span class="s1">tm.makeStringIndex</span><span class="s2">,</span>
            <span class="s1">tm.makeUnicodeIndex</span><span class="s2">,</span>
            <span class="s1">tm.makeIntIndex</span><span class="s2">,</span>
            <span class="s1">tm.makeDateIndex</span><span class="s2">,</span>
            <span class="s1">tm.makePeriodIndex</span><span class="s2">,</span>
        <span class="s1">]:</span>

            <span class="s1">df.index = index(len(df))</span>
            <span class="s1">df.groupby(list(</span><span class="s5">&quot;abcde&quot;</span><span class="s1">)).apply(</span><span class="s2">lambda </span><span class="s1">x: x)</span>

            <span class="s1">df.index = list(reversed(df.index.tolist()))</span>
            <span class="s1">df.groupby(list(</span><span class="s5">&quot;abcde&quot;</span><span class="s1">)).apply(</span><span class="s2">lambda </span><span class="s1">x: x)</span>

    <span class="s2">def </span><span class="s1">test_grouper_multilevel_freq(self):</span>

        <span class="s3"># GH 7885</span>
        <span class="s3"># with level and freq specified in a pd.Grouper</span>
        <span class="s2">from </span><span class="s1">datetime </span><span class="s2">import </span><span class="s1">(</span>
            <span class="s1">date</span><span class="s2">,</span>
            <span class="s1">timedelta</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s1">d0 = date.today() - timedelta(days=</span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">dates = date_range(d0</span><span class="s2">, </span><span class="s1">date.today())</span>
        <span class="s1">date_index = MultiIndex.from_product([dates</span><span class="s2">, </span><span class="s1">dates]</span><span class="s2">, </span><span class="s1">names=[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame(np.random.randint(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">225</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=date_index)</span>

        <span class="s3"># Check string level</span>
        <span class="s1">expected = (</span>
            <span class="s1">df.reset_index()</span>
            <span class="s1">.groupby([pd.Grouper(key=</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;W&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Grouper(key=</span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;W&quot;</span><span class="s1">)])</span>
            <span class="s1">.sum()</span>
        <span class="s1">)</span>
        <span class="s3"># reset index changes columns dtype to object</span>
        <span class="s1">expected.columns = Index([</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;int64&quot;</span><span class="s1">)</span>

        <span class="s1">result = df.groupby(</span>
            <span class="s1">[pd.Grouper(level=</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;W&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Grouper(level=</span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;W&quot;</span><span class="s1">)]</span>
        <span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Check integer level</span>
        <span class="s1">result = df.groupby(</span>
            <span class="s1">[pd.Grouper(level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;W&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Grouper(level=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;W&quot;</span><span class="s1">)]</span>
        <span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_grouper_creation_bug(self):</span>

        <span class="s3"># GH 8795</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]})</span>
        <span class="s1">g = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)</span>
        <span class="s1">expected = g.sum()</span>

        <span class="s1">g = df.groupby(pd.Grouper(key=</span><span class="s5">&quot;A&quot;</span><span class="s1">))</span>
        <span class="s1">result = g.sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">g = df.groupby(pd.Grouper(key=</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">result = g.sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">result = g.apply(</span><span class="s2">lambda </span><span class="s1">x: x.sum())</span>
        <span class="s1">expected[</span><span class="s5">&quot;A&quot;</span><span class="s1">] = [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">expected = expected.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># GH14334</span>
        <span class="s3"># pd.Grouper(key=...) may be passed in a list</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]}</span>
        <span class="s1">)</span>
        <span class="s3"># Group by single column</span>
        <span class="s1">expected = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">).sum()</span>
        <span class="s1">g = df.groupby([pd.Grouper(key=</span><span class="s5">&quot;A&quot;</span><span class="s1">)])</span>
        <span class="s1">result = g.sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Group by two columns</span>
        <span class="s3"># using a combination of strings and Grouper objects</span>
        <span class="s1">expected = df.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]).sum()</span>

        <span class="s3"># Group with two Grouper objects</span>
        <span class="s1">g = df.groupby([pd.Grouper(key=</span><span class="s5">&quot;A&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Grouper(key=</span><span class="s5">&quot;B&quot;</span><span class="s1">)])</span>
        <span class="s1">result = g.sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Group with a string and a Grouper object</span>
        <span class="s1">g = df.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s1">pd.Grouper(key=</span><span class="s5">&quot;B&quot;</span><span class="s1">)])</span>
        <span class="s1">result = g.sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Group with a Grouper object and a string</span>
        <span class="s1">g = df.groupby([pd.Grouper(key=</span><span class="s5">&quot;A&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">result = g.sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># GH8866</span>
        <span class="s1">s = Series(</span>
            <span class="s1">np.arange(</span><span class="s4">8</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;int64&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">index=MultiIndex.from_product(</span>
                <span class="s1">[list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">date_range(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">2</span><span class="s1">)]</span><span class="s2">,</span>
                <span class="s1">names=[</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;three&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">result = s.groupby(pd.Grouper(level=</span><span class="s5">&quot;three&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;M&quot;</span><span class="s1">)).sum()</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[</span><span class="s4">28</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">index=pd.DatetimeIndex([Timestamp(</span><span class="s5">&quot;2013-01-31&quot;</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;M&quot;</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;three&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># just specifying a level breaks</span>
        <span class="s1">result = s.groupby(pd.Grouper(level=</span><span class="s5">&quot;one&quot;</span><span class="s1">)).sum()</span>
        <span class="s1">expected = s.groupby(level=</span><span class="s5">&quot;one&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_grouper_column_and_index(self):</span>
        <span class="s3"># GH 14327</span>

        <span class="s3"># Grouping a multi-index frame by a column and an index level should</span>
        <span class="s3"># be equivalent to resetting the index and grouping by two columns</span>
        <span class="s1">idx = MultiIndex.from_tuples(</span>
            <span class="s1">[(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)]</span>
        <span class="s1">)</span>
        <span class="s1">idx.names = [</span><span class="s5">&quot;outer&quot;</span><span class="s2">, </span><span class="s5">&quot;inner&quot;</span><span class="s1">]</span>
        <span class="s1">df_multi = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;A&quot;</span><span class="s1">: np.arange(</span><span class="s4">6</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">: [</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s1">]}</span><span class="s2">,</span>
            <span class="s1">index=idx</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df_multi.groupby([</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s1">pd.Grouper(level=</span><span class="s5">&quot;inner&quot;</span><span class="s1">)]).mean()</span>
        <span class="s1">expected = df_multi.reset_index().groupby([</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;inner&quot;</span><span class="s1">]).mean()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Test the reverse grouping order</span>
        <span class="s1">result = df_multi.groupby([pd.Grouper(level=</span><span class="s5">&quot;inner&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]).mean()</span>
        <span class="s1">expected = df_multi.reset_index().groupby([</span><span class="s5">&quot;inner&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]).mean()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Grouping a single-index frame by a column and the index should</span>
        <span class="s3"># be equivalent to resetting the index and grouping by two columns</span>
        <span class="s1">df_single = df_multi.reset_index(</span><span class="s5">&quot;outer&quot;</span><span class="s1">)</span>
        <span class="s1">result = df_single.groupby([</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s1">pd.Grouper(level=</span><span class="s5">&quot;inner&quot;</span><span class="s1">)]).mean()</span>
        <span class="s1">expected = df_single.reset_index().groupby([</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;inner&quot;</span><span class="s1">]).mean()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Test the reverse grouping order</span>
        <span class="s1">result = df_single.groupby([pd.Grouper(level=</span><span class="s5">&quot;inner&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]).mean()</span>
        <span class="s1">expected = df_single.reset_index().groupby([</span><span class="s5">&quot;inner&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]).mean()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_levels_and_columns(self):</span>
        <span class="s3"># GH9344, GH9049</span>
        <span class="s1">idx_names = [</span><span class="s5">&quot;x&quot;</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s1">]</span>
        <span class="s1">idx = MultiIndex.from_tuples([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">names=idx_names)</span>
        <span class="s1">df = DataFrame(np.arange(</span><span class="s4">12</span><span class="s1">).reshape(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=idx)</span>

        <span class="s1">by_levels = df.groupby(level=idx_names).mean()</span>
        <span class="s3"># reset_index changes columns dtype to object</span>
        <span class="s1">by_columns = df.reset_index().groupby(idx_names).mean()</span>

        <span class="s3"># without casting, by_columns.columns is object-dtype</span>
        <span class="s1">by_columns.columns = by_columns.columns.astype(np.int64)</span>
        <span class="s1">tm.assert_frame_equal(by_levels</span><span class="s2">, </span><span class="s1">by_columns)</span>

    <span class="s2">def </span><span class="s1">test_groupby_categorical_index_and_columns(self</span><span class="s2">, </span><span class="s1">observed):</span>
        <span class="s3"># GH18432, adapted for GH25871</span>
        <span class="s1">columns = [</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]</span>
        <span class="s1">categories = [</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">data = np.array(</span>
            <span class="s1">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">int</span>
        <span class="s1">)</span>
        <span class="s1">cat_columns = CategoricalIndex(columns</span><span class="s2">, </span><span class="s1">categories=categories</span><span class="s2">, </span><span class="s1">ordered=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(data=data</span><span class="s2">, </span><span class="s1">columns=cat_columns)</span>
        <span class="s1">result = df.groupby(axis=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">observed=observed).sum()</span>
        <span class="s1">expected_data = np.array([[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">int)</span>
        <span class="s1">expected_columns = CategoricalIndex(</span>
            <span class="s1">categories</span><span class="s2">, </span><span class="s1">categories=categories</span><span class="s2">, </span><span class="s1">ordered=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(data=expected_data</span><span class="s2">, </span><span class="s1">columns=expected_columns)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># test transposed version</span>
        <span class="s1">df = DataFrame(data.T</span><span class="s2">, </span><span class="s1">index=cat_columns)</span>
        <span class="s1">result = df.groupby(axis=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">observed=observed).sum()</span>
        <span class="s1">expected = DataFrame(data=expected_data.T</span><span class="s2">, </span><span class="s1">index=expected_columns)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_grouper_getting_correct_binner(self):</span>

        <span class="s3"># GH 10063</span>
        <span class="s3"># using a non-time-based grouper and a time-based grouper</span>
        <span class="s3"># and specifying levels</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;A&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">index=MultiIndex.from_product(</span>
                <span class="s1">[list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">date_range(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">80</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">names=[</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s1">]</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">result = df.groupby(</span>
            <span class="s1">[pd.Grouper(level=</span><span class="s5">&quot;one&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Grouper(level=</span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;M&quot;</span><span class="s1">)]</span>
        <span class="s1">).sum()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">31</span><span class="s2">, </span><span class="s4">28</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">28</span><span class="s2">, </span><span class="s4">21</span><span class="s1">]}</span><span class="s2">,</span>
            <span class="s1">index=MultiIndex.from_product(</span>
                <span class="s1">[list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">date_range(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;M&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)]</span><span class="s2">,</span>
                <span class="s1">names=[</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_grouper_iter(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s2">assert </span><span class="s1">sorted(df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">).grouper) == [</span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">test_empty_groups(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s3"># see gh-1048</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;No group keys passed!&quot;</span><span class="s1">):</span>
            <span class="s1">df.groupby([])</span>

    <span class="s2">def </span><span class="s1">test_groupby_grouper(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s1">grouped = df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)</span>

        <span class="s1">result = df.groupby(grouped.grouper).mean()</span>
        <span class="s1">expected = grouped.mean()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_dict_mapping(self):</span>
        <span class="s3"># GH #679</span>
        <span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">Series</span>

        <span class="s1">s = Series({</span><span class="s5">&quot;T1&quot;</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span>
        <span class="s1">result = s.groupby({</span><span class="s5">&quot;T1&quot;</span><span class="s1">: </span><span class="s5">&quot;T2&quot;</span><span class="s1">}).agg(sum)</span>
        <span class="s1">expected = s.groupby([</span><span class="s5">&quot;T2&quot;</span><span class="s1">]).agg(sum)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">s = Series([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=list(</span><span class="s5">&quot;abcd&quot;</span><span class="s1">))</span>
        <span class="s1">mapping = {</span><span class="s5">&quot;a&quot;</span><span class="s1">: </span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: </span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">}</span>

        <span class="s1">result = s.groupby(mapping).mean()</span>
        <span class="s1">result2 = s.groupby(mapping).agg(np.mean)</span>
        <span class="s1">expected = s.groupby([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]).mean()</span>
        <span class="s1">expected2 = s.groupby([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]).mean()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">result2)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected2)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s5">&quot;index&quot;</span><span class="s2">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">[Timestamp(</span><span class="s4">2021</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">28 </span><span class="s1">+ i) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s4">4</span><span class="s1">)]</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">def </span><span class="s1">test_groupby_series_named_with_tuple(self</span><span class="s2">, </span><span class="s1">frame_or_series</span><span class="s2">, </span><span class="s1">index):</span>
        <span class="s3"># GH 42731</span>
        <span class="s1">obj = frame_or_series([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">groups = Series([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=index</span><span class="s2">, </span><span class="s1">name=(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s1">result = obj.groupby(groups).last()</span>
        <span class="s1">expected = frame_or_series([</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">expected.index.name = (</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_grouper_f_sanity_checked(self):</span>
        <span class="s1">dates = date_range(</span><span class="s5">&quot;01-Jan-2013&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">12</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;MS&quot;</span><span class="s1">)</span>
        <span class="s1">ts = Series(np.random.randn(</span><span class="s4">12</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=dates)</span>

        <span class="s3"># GH3035</span>
        <span class="s3"># index.map is used to apply grouper to the index</span>
        <span class="s3"># if it fails on the elements, map tries it on the entire index as</span>
        <span class="s3"># a sequence. That can yield invalid results that cause trouble</span>
        <span class="s3"># down the line.</span>
        <span class="s3"># the surprise comes from using key[0:6] rather than str(key)[0:6]</span>
        <span class="s3"># when the elements are Timestamp.</span>
        <span class="s3"># the result is Index[0:6], very confusing.</span>

        <span class="s1">msg = </span><span class="s5">r&quot;Grouper result violates len\(labels\) == len\(data\)&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(AssertionError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">ts.groupby(</span><span class="s2">lambda </span><span class="s1">key: key[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">6</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">test_grouping_error_on_multidim_input(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s1">msg = </span><span class="s5">&quot;Grouper for '&lt;class 'pandas.core.frame.DataFrame'&gt;' not 1-dimensional&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">Grouping(df.index</span><span class="s2">, </span><span class="s1">df[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">]])</span>

    <span class="s2">def </span><span class="s1">test_multiindex_passthru(self):</span>

        <span class="s3"># GH 7997</span>
        <span class="s3"># regression from 0.14.1</span>
        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s1">]])</span>
        <span class="s1">df.columns = MultiIndex.from_tuples([(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">result = df.groupby(axis=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">level=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]).first()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">df)</span>

    <span class="s2">def </span><span class="s1">test_multiindex_negative_level(self</span><span class="s2">, </span><span class="s1">mframe):</span>
        <span class="s3"># GH 13901</span>
        <span class="s1">result = mframe.groupby(level=-</span><span class="s4">1</span><span class="s1">).sum()</span>
        <span class="s1">expected = mframe.groupby(level=</span><span class="s5">&quot;second&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">result = mframe.groupby(level=-</span><span class="s4">2</span><span class="s1">).sum()</span>
        <span class="s1">expected = mframe.groupby(level=</span><span class="s5">&quot;first&quot;</span><span class="s1">).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">result = mframe.groupby(level=[-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]).sum()</span>
        <span class="s1">expected = mframe</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">result = mframe.groupby(level=[-</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;first&quot;</span><span class="s1">]).sum()</span>
        <span class="s1">expected = mframe.groupby(level=[</span><span class="s5">&quot;second&quot;</span><span class="s2">, </span><span class="s5">&quot;first&quot;</span><span class="s1">]).sum()</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_multifunc_select_col_integer_cols(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s1">df.columns = np.arange(len(df.columns))</span>

        <span class="s3"># it works!</span>
        <span class="s1">df.groupby(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">as_index=</span><span class="s2">False</span><span class="s1">)[</span><span class="s4">2</span><span class="s1">].agg({</span><span class="s5">&quot;Q&quot;</span><span class="s1">: np.mean})</span>

    <span class="s2">def </span><span class="s1">test_multiindex_columns_empty_level(self):</span>
        <span class="s1">lst = [[</span><span class="s5">&quot;count&quot;</span><span class="s2">, </span><span class="s5">&quot;values&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;to filter&quot;</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s1">]]</span>
        <span class="s1">midx = MultiIndex.from_tuples(lst)</span>

        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=midx)</span>

        <span class="s1">grouped = df.groupby(</span><span class="s5">&quot;to filter&quot;</span><span class="s1">).groups</span>
        <span class="s2">assert </span><span class="s1">grouped[</span><span class="s5">&quot;A&quot;</span><span class="s1">] == [</span><span class="s4">0</span><span class="s1">]</span>

        <span class="s1">grouped = df.groupby([(</span><span class="s5">&quot;to filter&quot;</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s1">)]).groups</span>
        <span class="s2">assert </span><span class="s1">grouped[</span><span class="s5">&quot;A&quot;</span><span class="s1">] == [</span><span class="s4">0</span><span class="s1">]</span>

        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=midx)</span>

        <span class="s1">expected = df.groupby(</span><span class="s5">&quot;to filter&quot;</span><span class="s1">).groups</span>
        <span class="s1">result = df.groupby([(</span><span class="s5">&quot;to filter&quot;</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s1">)]).groups</span>
        <span class="s2">assert </span><span class="s1">result == expected</span>

        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=midx)</span>

        <span class="s1">expected = df.groupby(</span><span class="s5">&quot;to filter&quot;</span><span class="s1">).groups</span>
        <span class="s1">result = df.groupby([(</span><span class="s5">&quot;to filter&quot;</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s1">)]).groups</span>
        <span class="s1">tm.assert_dict_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_multiindex_tuple(self):</span>
        <span class="s3"># GH 17979</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
            <span class="s1">columns=MultiIndex.from_arrays([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]])</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = df.groupby([(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)]).groups</span>
        <span class="s1">result = df.groupby((</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)).groups</span>
        <span class="s1">tm.assert_dict_equal(expected</span><span class="s2">, </span><span class="s1">result)</span>

        <span class="s1">df2 = DataFrame(</span>
            <span class="s1">df.values</span><span class="s2">,</span>
            <span class="s1">columns=MultiIndex.from_arrays(</span>
                <span class="s1">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;e&quot;</span><span class="s2">, </span><span class="s5">&quot;e&quot;</span><span class="s1">]]</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">expected = df2.groupby([(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s1">)]).groups</span>
        <span class="s1">result = df.groupby((</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)).groups</span>
        <span class="s1">tm.assert_dict_equal(expected</span><span class="s2">, </span><span class="s1">result)</span>

        <span class="s1">df3 = DataFrame(df.values</span><span class="s2">, </span><span class="s1">columns=[(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;e&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">])</span>
        <span class="s1">expected = df3.groupby([(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s1">)]).groups</span>
        <span class="s1">result = df.groupby((</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)).groups</span>
        <span class="s1">tm.assert_dict_equal(expected</span><span class="s2">, </span><span class="s1">result)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;sort&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
    <span class="s2">def </span><span class="s1">test_groupby_level(self</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">, </span><span class="s1">mframe</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s3"># GH 17537</span>
        <span class="s1">frame = mframe</span>
        <span class="s1">deleveled = frame.reset_index()</span>

        <span class="s1">result0 = frame.groupby(level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">result1 = frame.groupby(level=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>

        <span class="s1">expected0 = frame.groupby(deleveled[</span><span class="s5">&quot;first&quot;</span><span class="s1">].values</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">expected1 = frame.groupby(deleveled[</span><span class="s5">&quot;second&quot;</span><span class="s1">].values</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>

        <span class="s1">expected0.index.name = </span><span class="s5">&quot;first&quot;</span>
        <span class="s1">expected1.index.name = </span><span class="s5">&quot;second&quot;</span>

        <span class="s2">assert </span><span class="s1">result0.index.name == </span><span class="s5">&quot;first&quot;</span>
        <span class="s2">assert </span><span class="s1">result1.index.name == </span><span class="s5">&quot;second&quot;</span>

        <span class="s1">tm.assert_frame_equal(result0</span><span class="s2">, </span><span class="s1">expected0)</span>
        <span class="s1">tm.assert_frame_equal(result1</span><span class="s2">, </span><span class="s1">expected1)</span>
        <span class="s2">assert </span><span class="s1">result0.index.name == frame.index.names[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s2">assert </span><span class="s1">result1.index.name == frame.index.names[</span><span class="s4">1</span><span class="s1">]</span>

        <span class="s3"># groupby level name</span>
        <span class="s1">result0 = frame.groupby(level=</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">result1 = frame.groupby(level=</span><span class="s5">&quot;second&quot;</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">tm.assert_frame_equal(result0</span><span class="s2">, </span><span class="s1">expected0)</span>
        <span class="s1">tm.assert_frame_equal(result1</span><span class="s2">, </span><span class="s1">expected1)</span>

        <span class="s3"># axis=1</span>

        <span class="s1">result0 = frame.T.groupby(level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">result1 = frame.T.groupby(level=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">tm.assert_frame_equal(result0</span><span class="s2">, </span><span class="s1">expected0.T)</span>
        <span class="s1">tm.assert_frame_equal(result1</span><span class="s2">, </span><span class="s1">expected1.T)</span>

        <span class="s3"># raise exception for non-MultiIndex</span>
        <span class="s1">msg = </span><span class="s5">&quot;level &gt; 0 or level &lt; -1 only valid with MultiIndex&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.groupby(level=</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_level_index_names(self</span><span class="s2">, </span><span class="s1">axis):</span>
        <span class="s3"># GH4014 this used to raise ValueError since 'exp'&gt;1 (in py2)</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;exp&quot;</span><span class="s1">: [</span><span class="s5">&quot;A&quot;</span><span class="s1">] * </span><span class="s4">3 </span><span class="s1">+ [</span><span class="s5">&quot;B&quot;</span><span class="s1">] * </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;var1&quot;</span><span class="s1">: range(</span><span class="s4">6</span><span class="s1">)}).set_index(</span>
            <span class="s5">&quot;exp&quot;</span>
        <span class="s1">)</span>
        <span class="s2">if </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">(</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;columns&quot;</span><span class="s1">):</span>
            <span class="s1">df = df.T</span>
        <span class="s1">df.groupby(level=</span><span class="s5">&quot;exp&quot;</span><span class="s2">, </span><span class="s1">axis=axis)</span>
        <span class="s1">msg = </span><span class="s5">f&quot;level name foo is not the name of the </span><span class="s2">{</span><span class="s1">df._get_axis_name(axis)</span><span class="s2">}</span><span class="s5">&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.groupby(level=</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s1">axis=axis)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;sort&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
    <span class="s2">def </span><span class="s1">test_groupby_level_with_nas(self</span><span class="s2">, </span><span class="s1">sort):</span>
        <span class="s3"># GH 17537</span>
        <span class="s1">index = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
            <span class="s1">codes=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s3"># factorizing doesn't confuse things</span>
        <span class="s1">s = Series(np.arange(</span><span class="s4">8.0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">result = s.groupby(level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">expected = Series([</span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">22.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">index = MultiIndex(</span>
            <span class="s1">levels=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
            <span class="s1">codes=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s3"># factorizing doesn't confuse things</span>
        <span class="s1">s = Series(np.arange(</span><span class="s4">8.0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">result = s.groupby(level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">sort=sort).sum()</span>
        <span class="s1">expected = Series([</span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">18.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_args(self</span><span class="s2">, </span><span class="s1">mframe):</span>
        <span class="s3"># PR8618 and issue 8015</span>
        <span class="s1">frame = mframe</span>

        <span class="s1">msg = </span><span class="s5">&quot;You have to supply one of 'by' and 'level'&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(TypeError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">frame.groupby()</span>

        <span class="s1">msg = </span><span class="s5">&quot;You have to supply one of 'by' and 'level'&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(TypeError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">frame.groupby(by=</span><span class="s2">None, </span><span class="s1">level=</span><span class="s2">None</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s5">&quot;sort,labels&quot;</span><span class="s2">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s2">True, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s2">False, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">def </span><span class="s1">test_level_preserve_order(self</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">, </span><span class="s1">mframe):</span>
        <span class="s3"># GH 17537</span>
        <span class="s1">grouped = mframe.groupby(level=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">sort=sort)</span>
        <span class="s1">exp_labels = np.array(labels</span><span class="s2">, </span><span class="s1">np.intp)</span>
        <span class="s1">tm.assert_almost_equal(grouped.grouper.codes[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">exp_labels)</span>

    <span class="s2">def </span><span class="s1">test_grouping_labels(self</span><span class="s2">, </span><span class="s1">mframe):</span>
        <span class="s1">grouped = mframe.groupby(mframe.index.get_level_values(</span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">exp_labels = np.array([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.intp)</span>
        <span class="s1">tm.assert_almost_equal(grouped.grouper.codes[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">exp_labels)</span>

    <span class="s2">def </span><span class="s1">test_list_grouper_with_nat(self):</span>
        <span class="s3"># GH 14715</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;date&quot;</span><span class="s1">: date_range(</span><span class="s5">&quot;1/1/2011&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">365</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;D&quot;</span><span class="s1">)})</span>
        <span class="s1">df.iloc[-</span><span class="s4">1</span><span class="s1">] = pd.NaT</span>
        <span class="s1">grouper = pd.Grouper(key=</span><span class="s5">&quot;date&quot;</span><span class="s2">, </span><span class="s1">freq=</span><span class="s5">&quot;AS&quot;</span><span class="s1">)</span>

        <span class="s3"># Grouper in a list grouping</span>
        <span class="s1">result = df.groupby([grouper])</span>
        <span class="s1">expected = {Timestamp(</span><span class="s5">&quot;2011-01-01&quot;</span><span class="s1">): Index(list(range(</span><span class="s4">364</span><span class="s1">)))}</span>
        <span class="s1">tm.assert_dict_equal(result.groups</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># Test case without a list</span>
        <span class="s1">result = df.groupby(grouper)</span>
        <span class="s1">expected = {Timestamp(</span><span class="s5">&quot;2011-01-01&quot;</span><span class="s1">): </span><span class="s4">365</span><span class="s1">}</span>
        <span class="s1">tm.assert_dict_equal(result.groups</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s5">&quot;func,expected&quot;</span><span class="s2">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s5">&quot;transform&quot;</span><span class="s2">,</span>
                <span class="s1">Series(name=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype=np.float64</span><span class="s2">, </span><span class="s1">index=Index([]))</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s5">&quot;agg&quot;</span><span class="s2">,</span>
                <span class="s1">Series(name=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype=np.float64</span><span class="s2">, </span><span class="s1">index=Float64Index([]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">1</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s5">&quot;apply&quot;</span><span class="s2">,</span>
                <span class="s1">Series(name=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype=np.float64</span><span class="s2">, </span><span class="s1">index=Float64Index([]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">1</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">def </span><span class="s1">test_evaluate_with_empty_groups(self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">expected):</span>
        <span class="s3"># 26208</span>
        <span class="s3"># test transform'ing empty groups</span>
        <span class="s3"># (not testing other agg fns, because they return</span>
        <span class="s3"># different index objects.</span>
        <span class="s1">df = DataFrame({</span><span class="s4">1</span><span class="s1">: []</span><span class="s2">, </span><span class="s4">2</span><span class="s1">: []})</span>
        <span class="s1">g = df.groupby(</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">result = getattr(g[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">func)(</span><span class="s2">lambda </span><span class="s1">x: x)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_empty(self):</span>
        <span class="s3"># https://github.com/pandas-dev/pandas/issues/27190</span>
        <span class="s1">s = Series([]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;name&quot;</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;float64&quot;</span><span class="s1">)</span>
        <span class="s1">gr = s.groupby([])</span>

        <span class="s1">result = gr.mean()</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">s)</span>

        <span class="s3"># check group properties</span>
        <span class="s2">assert </span><span class="s1">len(gr.grouper.groupings) == </span><span class="s4">1</span>
        <span class="s1">tm.assert_numpy_array_equal(</span>
            <span class="s1">gr.grouper.group_info[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([]</span><span class="s2">, </span><span class="s1">dtype=np.dtype(np.intp))</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_numpy_array_equal(</span>
            <span class="s1">gr.grouper.group_info[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([]</span><span class="s2">, </span><span class="s1">dtype=np.dtype(np.intp))</span>
        <span class="s1">)</span>

        <span class="s2">assert </span><span class="s1">gr.grouper.group_info[</span><span class="s4">2</span><span class="s1">] == </span><span class="s4">0</span>

        <span class="s3"># check name</span>
        <span class="s2">assert </span><span class="s1">s.groupby(s).grouper.names == [</span><span class="s5">&quot;name&quot;</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">test_groupby_level_index_value_all_na(self):</span>
        <span class="s3"># issue 20519</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[</span><span class="s5">&quot;x&quot;</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s4">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s2">None, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s4">20</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]</span>
        <span class="s1">).set_index([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">result = df.groupby(level=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]).sum()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">data=[]</span><span class="s2">,</span>
            <span class="s1">index=MultiIndex(</span>
                <span class="s1">levels=[Index([</span><span class="s5">&quot;x&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;object&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">Index([]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;float64&quot;</span><span class="s1">)]</span><span class="s2">,</span>
                <span class="s1">codes=[[]</span><span class="s2">, </span><span class="s1">[]]</span><span class="s2">,</span>
                <span class="s1">names=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;C&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">dtype=</span><span class="s5">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_multiindex_level_empty(self):</span>
        <span class="s3"># https://github.com/pandas-dev/pandas/issues/31670</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">123</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">123</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">2.0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;id&quot;</span><span class="s2">, </span><span class="s5">&quot;category&quot;</span><span class="s2">, </span><span class="s5">&quot;value&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df = df.set_index([</span><span class="s5">&quot;id&quot;</span><span class="s2">, </span><span class="s5">&quot;category&quot;</span><span class="s1">])</span>
        <span class="s1">empty = df[df.value &lt; </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">result = empty.groupby(</span><span class="s5">&quot;id&quot;</span><span class="s1">).sum()</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">dtype=</span><span class="s5">&quot;float64&quot;</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;value&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=Int64Index([]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;id&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s3"># get_group</span>
<span class="s3"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestGetGroup:</span>
    <span class="s2">def </span><span class="s1">test_get_group(self):</span>
        <span class="s3"># GH 5267</span>
        <span class="s3"># be datelike friendly</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;DATE&quot;</span><span class="s1">: pd.to_datetime(</span>
                    <span class="s1">[</span>
                        <span class="s5">&quot;10-Oct-2013&quot;</span><span class="s2">,</span>
                        <span class="s5">&quot;10-Oct-2013&quot;</span><span class="s2">,</span>
                        <span class="s5">&quot;10-Oct-2013&quot;</span><span class="s2">,</span>
                        <span class="s5">&quot;11-Oct-2013&quot;</span><span class="s2">,</span>
                        <span class="s5">&quot;11-Oct-2013&quot;</span><span class="s2">,</span>
                        <span class="s5">&quot;11-Oct-2013&quot;</span><span class="s2">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s2">,</span>
                <span class="s5">&quot;label&quot;</span><span class="s1">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;VAL&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">g = df.groupby(</span><span class="s5">&quot;DATE&quot;</span><span class="s1">)</span>
        <span class="s1">key = list(g.groups)[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">result1 = g.get_group(key)</span>
        <span class="s1">result2 = g.get_group(Timestamp(key).to_pydatetime())</span>
        <span class="s1">result3 = g.get_group(str(Timestamp(key)))</span>
        <span class="s1">tm.assert_frame_equal(result1</span><span class="s2">, </span><span class="s1">result2)</span>
        <span class="s1">tm.assert_frame_equal(result1</span><span class="s2">, </span><span class="s1">result3)</span>

        <span class="s1">g = df.groupby([</span><span class="s5">&quot;DATE&quot;</span><span class="s2">, </span><span class="s5">&quot;label&quot;</span><span class="s1">])</span>

        <span class="s1">key = list(g.groups)[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">result1 = g.get_group(key)</span>
        <span class="s1">result2 = g.get_group((Timestamp(key[</span><span class="s4">0</span><span class="s1">]).to_pydatetime()</span><span class="s2">, </span><span class="s1">key[</span><span class="s4">1</span><span class="s1">]))</span>
        <span class="s1">result3 = g.get_group((str(Timestamp(key[</span><span class="s4">0</span><span class="s1">]))</span><span class="s2">, </span><span class="s1">key[</span><span class="s4">1</span><span class="s1">]))</span>
        <span class="s1">tm.assert_frame_equal(result1</span><span class="s2">, </span><span class="s1">result2)</span>
        <span class="s1">tm.assert_frame_equal(result1</span><span class="s2">, </span><span class="s1">result3)</span>

        <span class="s3"># must pass a same-length tuple with multiple keys</span>
        <span class="s1">msg = </span><span class="s5">&quot;must supply a tuple to get_group with multiple grouping keys&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">g.get_group(</span><span class="s5">&quot;foo&quot;</span><span class="s1">)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">g.get_group(</span><span class="s5">&quot;foo&quot;</span><span class="s1">)</span>
        <span class="s1">msg = </span><span class="s5">&quot;must supply a same-length tuple to get_group with multiple grouping keys&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">g.get_group((</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s1">))</span>

    <span class="s2">def </span><span class="s1">test_get_group_empty_bins(self</span><span class="s2">, </span><span class="s1">observed):</span>

        <span class="s1">d = DataFrame([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">6</span><span class="s1">])</span>
        <span class="s1">bins = [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">15</span><span class="s1">]</span>
        <span class="s1">g = d.groupby(pd.cut(d[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">bins)</span><span class="s2">, </span><span class="s1">observed=observed)</span>

        <span class="s3"># TODO: should prob allow a str of Interval work as well</span>
        <span class="s3"># IOW '(0, 5]'</span>
        <span class="s1">result = g.get_group(pd.Interval(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">expected = DataFrame([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">msg = </span><span class="s5">r&quot;Interval\(10, 15, closed='right'\)&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">g.get_group(pd.Interval(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">15</span><span class="s1">))</span>

    <span class="s2">def </span><span class="s1">test_get_group_grouped_by_tuple(self):</span>
        <span class="s3"># GH 8121</span>
        <span class="s1">df = DataFrame([[(</span><span class="s4">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)]]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">&quot;ids&quot;</span><span class="s1">]).T</span>
        <span class="s1">gr = df.groupby(</span><span class="s5">&quot;ids&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame({</span><span class="s5">&quot;ids&quot;</span><span class="s1">: [(</span><span class="s4">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">1</span><span class="s2">,</span><span class="s1">)]}</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">result = gr.get_group((</span><span class="s4">1</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">dt = pd.to_datetime([</span><span class="s5">&quot;2010-01-01&quot;</span><span class="s2">, </span><span class="s5">&quot;2010-01-02&quot;</span><span class="s2">, </span><span class="s5">&quot;2010-01-01&quot;</span><span class="s2">, </span><span class="s5">&quot;2010-01-02&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;ids&quot;</span><span class="s1">: [(x</span><span class="s2">,</span><span class="s1">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">dt]})</span>
        <span class="s1">gr = df.groupby(</span><span class="s5">&quot;ids&quot;</span><span class="s1">)</span>
        <span class="s1">result = gr.get_group((</span><span class="s5">&quot;2010-01-01&quot;</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">expected = DataFrame({</span><span class="s5">&quot;ids&quot;</span><span class="s1">: [(dt[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(dt[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">,</span><span class="s1">)]}</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_get_group_grouped_by_tuple_with_lambda(self):</span>
        <span class="s3"># GH 36158</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;Tuples&quot;</span><span class="s1">: ((x</span><span class="s2">, </span><span class="s1">y) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">] </span><span class="s2">for </span><span class="s1">y </span><span class="s2">in </span><span class="s1">np.random.randint(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s1">))}</span>
        <span class="s1">)</span>

        <span class="s1">gb = df.groupby(</span><span class="s5">&quot;Tuples&quot;</span><span class="s1">)</span>
        <span class="s1">gb_lambda = df.groupby(</span><span class="s2">lambda </span><span class="s1">x: df.iloc[x</span><span class="s2">, </span><span class="s4">0</span><span class="s1">])</span>

        <span class="s1">expected = gb.get_group(list(gb.groups.keys())[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">result = gb_lambda.get_group(list(gb_lambda.groups.keys())[</span><span class="s4">0</span><span class="s1">])</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_groupby_with_empty(self):</span>
        <span class="s1">index = pd.DatetimeIndex(())</span>
        <span class="s1">data = ()</span>
        <span class="s1">series = Series(data</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">dtype=object)</span>
        <span class="s1">grouper = pd.Grouper(freq=</span><span class="s5">&quot;D&quot;</span><span class="s1">)</span>
        <span class="s1">grouped = series.groupby(grouper)</span>
        <span class="s2">assert </span><span class="s1">next(iter(grouped)</span><span class="s2">, None</span><span class="s1">) </span><span class="s2">is None</span>

    <span class="s2">def </span><span class="s1">test_groupby_with_single_column(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;a&quot;</span><span class="s1">: list(</span><span class="s5">&quot;abssbab&quot;</span><span class="s1">)})</span>
        <span class="s1">tm.assert_frame_equal(df.groupby(</span><span class="s5">&quot;a&quot;</span><span class="s1">).get_group(</span><span class="s5">&quot;a&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]])</span>
        <span class="s3"># GH 13530</span>
        <span class="s1">exp = DataFrame(index=Index([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;s&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(df.groupby(</span><span class="s5">&quot;a&quot;</span><span class="s1">).count()</span><span class="s2">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(df.groupby(</span><span class="s5">&quot;a&quot;</span><span class="s1">).sum()</span><span class="s2">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(df.groupby(</span><span class="s5">&quot;a&quot;</span><span class="s1">).nth(</span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">exp)</span>

    <span class="s2">def </span><span class="s1">test_gb_key_len_equal_axis_len(self):</span>
        <span class="s3"># GH16843</span>
        <span class="s3"># test ensures that index and column keys are recognized correctly</span>
        <span class="s3"># when number of keys equals axis length of groupby</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">[[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s5">&quot;second&quot;</span><span class="s2">, </span><span class="s5">&quot;third&quot;</span><span class="s2">, </span><span class="s5">&quot;one&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">df = df.set_index([</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s5">&quot;second&quot;</span><span class="s1">])</span>
        <span class="s1">df = df.groupby([</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s5">&quot;second&quot;</span><span class="s2">, </span><span class="s5">&quot;third&quot;</span><span class="s1">]).size()</span>
        <span class="s2">assert </span><span class="s1">df.loc[(</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">)] == </span><span class="s4">2</span>
        <span class="s2">assert </span><span class="s1">df.loc[(</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">)] == </span><span class="s4">1</span>


<span class="s3"># groups &amp; iteration</span>
<span class="s3"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestIteration:</span>
    <span class="s2">def </span><span class="s1">test_groups(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s1">grouped = df.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s1">])</span>
        <span class="s1">groups = grouped.groups</span>
        <span class="s2">assert </span><span class="s1">groups </span><span class="s2">is </span><span class="s1">grouped.groups  </span><span class="s3"># caching works</span>

        <span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">grouped.groups.items():</span>
            <span class="s2">assert </span><span class="s1">(df.loc[v][</span><span class="s5">&quot;A&quot;</span><span class="s1">] == k).all()</span>

        <span class="s1">grouped = df.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">])</span>
        <span class="s1">groups = grouped.groups</span>
        <span class="s2">assert </span><span class="s1">groups </span><span class="s2">is </span><span class="s1">grouped.groups  </span><span class="s3"># caching works</span>

        <span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">grouped.groups.items():</span>
            <span class="s2">assert </span><span class="s1">(df.loc[v][</span><span class="s5">&quot;A&quot;</span><span class="s1">] == k[</span><span class="s4">0</span><span class="s1">]).all()</span>
            <span class="s2">assert </span><span class="s1">(df.loc[v][</span><span class="s5">&quot;B&quot;</span><span class="s1">] == k[</span><span class="s4">1</span><span class="s1">]).all()</span>

    <span class="s2">def </span><span class="s1">test_grouping_is_iterable(self</span><span class="s2">, </span><span class="s1">tsframe):</span>
        <span class="s3"># this code path isn't used anywhere else</span>
        <span class="s3"># not sure it's useful</span>
        <span class="s1">grouped = tsframe.groupby([</span><span class="s2">lambda </span><span class="s1">x: x.weekday()</span><span class="s2">, lambda </span><span class="s1">x: x.year])</span>

        <span class="s3"># test it works</span>
        <span class="s2">for </span><span class="s1">g </span><span class="s2">in </span><span class="s1">grouped.grouper.groupings[</span><span class="s4">0</span><span class="s1">]:</span>
            <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_multi_iter(self):</span>
        <span class="s1">s = Series(np.arange(</span><span class="s4">6</span><span class="s1">))</span>
        <span class="s1">k1 = np.array([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">k2 = np.array([</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s1">])</span>

        <span class="s1">grouped = s.groupby([k1</span><span class="s2">, </span><span class="s1">k2])</span>

        <span class="s1">iterated = list(grouped)</span>
        <span class="s1">expected = [</span>
            <span class="s1">(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s1">s[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s1">s[[</span><span class="s4">1</span><span class="s1">]])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s1">s[[</span><span class="s4">4</span><span class="s1">]])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s1">s[[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]])</span><span class="s2">,</span>
        <span class="s1">]</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">((one</span><span class="s2">, </span><span class="s1">two)</span><span class="s2">, </span><span class="s1">three) </span><span class="s2">in </span><span class="s1">enumerate(iterated):</span>
            <span class="s1">e1</span><span class="s2">, </span><span class="s1">e2</span><span class="s2">, </span><span class="s1">e3 = expected[i]</span>
            <span class="s2">assert </span><span class="s1">e1 == one</span>
            <span class="s2">assert </span><span class="s1">e2 == two</span>
            <span class="s1">tm.assert_series_equal(three</span><span class="s2">, </span><span class="s1">e3)</span>

    <span class="s2">def </span><span class="s1">test_multi_iter_frame(self</span><span class="s2">, </span><span class="s1">three_group):</span>
        <span class="s1">k1 = np.array([</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">k2 = np.array([</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;v1&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">6</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;v2&quot;</span><span class="s1">: np.random.randn(</span><span class="s4">6</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;k1&quot;</span><span class="s1">: k1</span><span class="s2">, </span><span class="s5">&quot;k2&quot;</span><span class="s1">: k2}</span><span class="s2">,</span>
            <span class="s1">index=[</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;three&quot;</span><span class="s2">, </span><span class="s5">&quot;four&quot;</span><span class="s2">, </span><span class="s5">&quot;five&quot;</span><span class="s2">, </span><span class="s5">&quot;six&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s1">grouped = df.groupby([</span><span class="s5">&quot;k1&quot;</span><span class="s2">, </span><span class="s5">&quot;k2&quot;</span><span class="s1">])</span>

        <span class="s3"># things get sorted!</span>
        <span class="s1">iterated = list(grouped)</span>
        <span class="s1">idx = df.index</span>
        <span class="s1">expected = [</span>
            <span class="s1">(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s1">df.loc[idx[[</span><span class="s4">4</span><span class="s1">]]])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s1">df.loc[idx[[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]]])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s1">df.loc[idx[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]]])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s1">df.loc[idx[[</span><span class="s4">1</span><span class="s1">]]])</span><span class="s2">,</span>
        <span class="s1">]</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">((one</span><span class="s2">, </span><span class="s1">two)</span><span class="s2">, </span><span class="s1">three) </span><span class="s2">in </span><span class="s1">enumerate(iterated):</span>
            <span class="s1">e1</span><span class="s2">, </span><span class="s1">e2</span><span class="s2">, </span><span class="s1">e3 = expected[i]</span>
            <span class="s2">assert </span><span class="s1">e1 == one</span>
            <span class="s2">assert </span><span class="s1">e2 == two</span>
            <span class="s1">tm.assert_frame_equal(three</span><span class="s2">, </span><span class="s1">e3)</span>

        <span class="s3"># don't iterate through groups with no data</span>
        <span class="s1">df[</span><span class="s5">&quot;k1&quot;</span><span class="s1">] = np.array([</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">df[</span><span class="s5">&quot;k2&quot;</span><span class="s1">] = np.array([</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s1">])</span>
        <span class="s1">grouped = df.groupby([</span><span class="s5">&quot;k1&quot;</span><span class="s2">, </span><span class="s5">&quot;k2&quot;</span><span class="s1">])</span>
        <span class="s1">groups = {key: gp </span><span class="s2">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">gp </span><span class="s2">in </span><span class="s1">grouped}</span>
        <span class="s2">assert </span><span class="s1">len(groups) == </span><span class="s4">2</span>

        <span class="s3"># axis = 1</span>
        <span class="s1">three_levels = three_group.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]).mean()</span>
        <span class="s1">grouped = three_levels.T.groupby(axis=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">level=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s2">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">group </span><span class="s2">in </span><span class="s1">grouped:</span>
            <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_dictify(self</span><span class="s2">, </span><span class="s1">df):</span>
        <span class="s1">dict(iter(df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)))</span>
        <span class="s1">dict(iter(df.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">])))</span>
        <span class="s1">dict(iter(df[</span><span class="s5">&quot;C&quot;</span><span class="s1">].groupby(df[</span><span class="s5">&quot;A&quot;</span><span class="s1">])))</span>
        <span class="s1">dict(iter(df[</span><span class="s5">&quot;C&quot;</span><span class="s1">].groupby([df[</span><span class="s5">&quot;A&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">df[</span><span class="s5">&quot;B&quot;</span><span class="s1">]])))</span>
        <span class="s1">dict(iter(df.groupby(</span><span class="s5">&quot;A&quot;</span><span class="s1">)[</span><span class="s5">&quot;C&quot;</span><span class="s1">]))</span>
        <span class="s1">dict(iter(df.groupby([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">])[</span><span class="s5">&quot;C&quot;</span><span class="s1">]))</span>

    <span class="s2">def </span><span class="s1">test_groupby_with_small_elem(self):</span>
        <span class="s3"># GH 8542</span>
        <span class="s3"># length=2</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;event&quot;</span><span class="s1">: [</span><span class="s5">&quot;start&quot;</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;change&quot;</span><span class="s1">: [</span><span class="s4">1234</span><span class="s2">, </span><span class="s4">5678</span><span class="s1">]}</span><span class="s2">,</span>
            <span class="s1">index=pd.DatetimeIndex([</span><span class="s5">&quot;2014-09-10&quot;</span><span class="s2">, </span><span class="s5">&quot;2013-10-10&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">grouped = df.groupby([pd.Grouper(freq=</span><span class="s5">&quot;M&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;event&quot;</span><span class="s1">])</span>
        <span class="s2">assert </span><span class="s1">len(grouped.groups) == </span><span class="s4">2</span>
        <span class="s2">assert </span><span class="s1">grouped.ngroups == </span><span class="s4">2</span>
        <span class="s2">assert </span><span class="s1">(Timestamp(</span><span class="s5">&quot;2014-09-30&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">) </span><span class="s2">in </span><span class="s1">grouped.groups</span>
        <span class="s2">assert </span><span class="s1">(Timestamp(</span><span class="s5">&quot;2013-10-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">) </span><span class="s2">in </span><span class="s1">grouped.groups</span>

        <span class="s1">res = grouped.get_group((Timestamp(</span><span class="s5">&quot;2014-09-30&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">:])</span>
        <span class="s1">res = grouped.get_group((Timestamp(</span><span class="s5">&quot;2013-10-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">:])</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;event&quot;</span><span class="s1">: [</span><span class="s5">&quot;start&quot;</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;change&quot;</span><span class="s1">: [</span><span class="s4">1234</span><span class="s2">, </span><span class="s4">5678</span><span class="s2">, </span><span class="s4">9123</span><span class="s1">]}</span><span class="s2">,</span>
            <span class="s1">index=pd.DatetimeIndex([</span><span class="s5">&quot;2014-09-10&quot;</span><span class="s2">, </span><span class="s5">&quot;2013-10-10&quot;</span><span class="s2">, </span><span class="s5">&quot;2014-09-15&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">grouped = df.groupby([pd.Grouper(freq=</span><span class="s5">&quot;M&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;event&quot;</span><span class="s1">])</span>
        <span class="s2">assert </span><span class="s1">len(grouped.groups) == </span><span class="s4">2</span>
        <span class="s2">assert </span><span class="s1">grouped.ngroups == </span><span class="s4">2</span>
        <span class="s2">assert </span><span class="s1">(Timestamp(</span><span class="s5">&quot;2014-09-30&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">) </span><span class="s2">in </span><span class="s1">grouped.groups</span>
        <span class="s2">assert </span><span class="s1">(Timestamp(</span><span class="s5">&quot;2013-10-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">) </span><span class="s2">in </span><span class="s1">grouped.groups</span>

        <span class="s1">res = grouped.get_group((Timestamp(</span><span class="s5">&quot;2014-09-30&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">:])</span>
        <span class="s1">res = grouped.get_group((Timestamp(</span><span class="s5">&quot;2013-10-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">:])</span>

        <span class="s3"># length=3</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;event&quot;</span><span class="s1">: [</span><span class="s5">&quot;start&quot;</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;change&quot;</span><span class="s1">: [</span><span class="s4">1234</span><span class="s2">, </span><span class="s4">5678</span><span class="s2">, </span><span class="s4">9123</span><span class="s1">]}</span><span class="s2">,</span>
            <span class="s1">index=pd.DatetimeIndex([</span><span class="s5">&quot;2014-09-10&quot;</span><span class="s2">, </span><span class="s5">&quot;2013-10-10&quot;</span><span class="s2">, </span><span class="s5">&quot;2014-08-05&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">grouped = df.groupby([pd.Grouper(freq=</span><span class="s5">&quot;M&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;event&quot;</span><span class="s1">])</span>
        <span class="s2">assert </span><span class="s1">len(grouped.groups) == </span><span class="s4">3</span>
        <span class="s2">assert </span><span class="s1">grouped.ngroups == </span><span class="s4">3</span>
        <span class="s2">assert </span><span class="s1">(Timestamp(</span><span class="s5">&quot;2014-09-30&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">) </span><span class="s2">in </span><span class="s1">grouped.groups</span>
        <span class="s2">assert </span><span class="s1">(Timestamp(</span><span class="s5">&quot;2013-10-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">) </span><span class="s2">in </span><span class="s1">grouped.groups</span>
        <span class="s2">assert </span><span class="s1">(Timestamp(</span><span class="s5">&quot;2014-08-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">) </span><span class="s2">in </span><span class="s1">grouped.groups</span>

        <span class="s1">res = grouped.get_group((Timestamp(</span><span class="s5">&quot;2014-09-30&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">:])</span>
        <span class="s1">res = grouped.get_group((Timestamp(</span><span class="s5">&quot;2013-10-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">:])</span>
        <span class="s1">res = grouped.get_group((Timestamp(</span><span class="s5">&quot;2014-08-31&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;start&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s2">, </span><span class="s1">df.iloc[[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">:])</span>

    <span class="s2">def </span><span class="s1">test_grouping_string_repr(self):</span>
        <span class="s3"># GH 13394</span>
        <span class="s1">mi = MultiIndex.from_arrays([list(</span><span class="s5">&quot;AAB&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">list(</span><span class="s5">&quot;aba&quot;</span><span class="s1">)])</span>
        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=mi)</span>
        <span class="s1">gr = df.groupby(df[(</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">)])</span>

        <span class="s1">result = gr.grouper.groupings[</span><span class="s4">0</span><span class="s1">].__repr__()</span>
        <span class="s1">expected = </span><span class="s5">&quot;Grouping(('A', 'a'))&quot;</span>
        <span class="s2">assert </span><span class="s1">result == expected</span>
</pre>
</body>
</html>