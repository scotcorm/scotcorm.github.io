<html>
<head>
<title>_facet_grid.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_facet_grid.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span>

<span class="s0">from </span><span class="s1">plotly </span><span class="s0">import </span><span class="s1">exceptions</span><span class="s0">, </span><span class="s1">optional_imports</span>
<span class="s0">import </span><span class="s1">plotly.colors </span><span class="s0">as </span><span class="s1">clrs</span>
<span class="s0">from </span><span class="s1">plotly.figure_factory </span><span class="s0">import </span><span class="s1">utils</span>
<span class="s0">from </span><span class="s1">plotly.subplots </span><span class="s0">import </span><span class="s1">make_subplots</span>

<span class="s0">import </span><span class="s1">math</span>
<span class="s0">from </span><span class="s1">numbers </span><span class="s0">import </span><span class="s1">Number</span>

<span class="s1">pd = optional_imports.get_module(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>

<span class="s1">TICK_COLOR = </span><span class="s2">&quot;#969696&quot;</span>
<span class="s1">AXIS_TITLE_COLOR = </span><span class="s2">&quot;#0f0f0f&quot;</span>
<span class="s1">AXIS_TITLE_SIZE = </span><span class="s3">12</span>
<span class="s1">GRID_COLOR = </span><span class="s2">&quot;#ffffff&quot;</span>
<span class="s1">LEGEND_COLOR = </span><span class="s2">&quot;#efefef&quot;</span>
<span class="s1">PLOT_BGCOLOR = </span><span class="s2">&quot;#ededed&quot;</span>
<span class="s1">ANNOT_RECT_COLOR = </span><span class="s2">&quot;#d0d0d0&quot;</span>
<span class="s1">LEGEND_BORDER_WIDTH = </span><span class="s3">1</span>
<span class="s1">LEGEND_ANNOT_X = </span><span class="s3">1.05</span>
<span class="s1">LEGEND_ANNOT_Y = </span><span class="s3">0.5</span>
<span class="s1">MAX_TICKS_PER_AXIS = </span><span class="s3">5</span>
<span class="s1">THRES_FOR_FLIPPED_FACET_TITLES = </span><span class="s3">10</span>
<span class="s1">GRID_WIDTH = </span><span class="s3">1</span>

<span class="s1">VALID_TRACE_TYPES = [</span><span class="s2">&quot;scatter&quot;</span><span class="s0">, </span><span class="s2">&quot;scattergl&quot;</span><span class="s0">, </span><span class="s2">&quot;histogram&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">&quot;box&quot;</span><span class="s1">]</span>

<span class="s1">CUSTOM_LABEL_ERROR = (</span>
    <span class="s2">&quot;If you are using a dictionary for custom labels for the facet row/col, &quot;</span>
    <span class="s2">&quot;make sure each key in that column of the dataframe is in your facet &quot;</span>
    <span class="s2">&quot;labels. The keys you need are {}&quot;</span>
<span class="s1">)</span>


<span class="s0">def </span><span class="s1">_is_flipped(num):</span>
    <span class="s0">if </span><span class="s1">num &gt;= THRES_FOR_FLIPPED_FACET_TITLES:</span>
        <span class="s1">flipped = </span><span class="s0">True</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">flipped = </span><span class="s0">False</span>
    <span class="s0">return </span><span class="s1">flipped</span>


<span class="s0">def </span><span class="s1">_return_label(original_label</span><span class="s0">, </span><span class="s1">facet_labels</span><span class="s0">, </span><span class="s1">facet_var):</span>
    <span class="s0">if </span><span class="s1">isinstance(facet_labels</span><span class="s0">, </span><span class="s1">dict):</span>
        <span class="s1">label = facet_labels[original_label]</span>
    <span class="s0">elif </span><span class="s1">isinstance(facet_labels</span><span class="s0">, </span><span class="s1">str):</span>
        <span class="s1">label = </span><span class="s2">&quot;{}: {}&quot;</span><span class="s1">.format(facet_var</span><span class="s0">, </span><span class="s1">original_label)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">label = original_label</span>
    <span class="s0">return </span><span class="s1">label</span>


<span class="s0">def </span><span class="s1">_legend_annotation(color_name):</span>
    <span class="s1">legend_title = dict(</span>
        <span class="s1">textangle=</span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">xanchor=</span><span class="s2">&quot;left&quot;</span><span class="s0">,</span>
        <span class="s1">yanchor=</span><span class="s2">&quot;middle&quot;</span><span class="s0">,</span>
        <span class="s1">x=LEGEND_ANNOT_X</span><span class="s0">,</span>
        <span class="s1">y=</span><span class="s3">1.03</span><span class="s0">,</span>
        <span class="s1">showarrow=</span><span class="s0">False,</span>
        <span class="s1">xref=</span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
        <span class="s1">yref=</span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
        <span class="s1">text=</span><span class="s2">&quot;factor({})&quot;</span><span class="s1">.format(color_name)</span><span class="s0">,</span>
        <span class="s1">font=dict(size=</span><span class="s3">13</span><span class="s0">, </span><span class="s1">color=</span><span class="s2">&quot;#000000&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">return </span><span class="s1">legend_title</span>


<span class="s0">def </span><span class="s1">_annotation_dict(</span>
    <span class="s1">text</span><span class="s0">, </span><span class="s1">lane</span><span class="s0">, </span><span class="s1">num_of_lanes</span><span class="s0">, </span><span class="s1">SUBPLOT_SPACING</span><span class="s0">, </span><span class="s1">row_col=</span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s1">flipped=</span><span class="s0">True</span>
<span class="s1">):</span>
    <span class="s1">l = (</span><span class="s3">1 </span><span class="s1">- (num_of_lanes - </span><span class="s3">1</span><span class="s1">) * SUBPLOT_SPACING) / (num_of_lanes)</span>
    <span class="s0">if not </span><span class="s1">flipped:</span>
        <span class="s1">xanchor = </span><span class="s2">&quot;center&quot;</span>
        <span class="s1">yanchor = </span><span class="s2">&quot;middle&quot;</span>
        <span class="s0">if </span><span class="s1">row_col == </span><span class="s2">&quot;col&quot;</span><span class="s1">:</span>
            <span class="s1">x = (lane - </span><span class="s3">1</span><span class="s1">) * (l + SUBPLOT_SPACING) + </span><span class="s3">0.5 </span><span class="s1">* l</span>
            <span class="s1">y = </span><span class="s3">1.03</span>
            <span class="s1">textangle = </span><span class="s3">0</span>
        <span class="s0">elif </span><span class="s1">row_col == </span><span class="s2">&quot;row&quot;</span><span class="s1">:</span>
            <span class="s1">y = (lane - </span><span class="s3">1</span><span class="s1">) * (l + SUBPLOT_SPACING) + </span><span class="s3">0.5 </span><span class="s1">* l</span>
            <span class="s1">x = </span><span class="s3">1.03</span>
            <span class="s1">textangle = </span><span class="s3">90</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">if </span><span class="s1">row_col == </span><span class="s2">&quot;col&quot;</span><span class="s1">:</span>
            <span class="s1">xanchor = </span><span class="s2">&quot;center&quot;</span>
            <span class="s1">yanchor = </span><span class="s2">&quot;bottom&quot;</span>
            <span class="s1">x = (lane - </span><span class="s3">1</span><span class="s1">) * (l + SUBPLOT_SPACING) + </span><span class="s3">0.5 </span><span class="s1">* l</span>
            <span class="s1">y = </span><span class="s3">1.0</span>
            <span class="s1">textangle = </span><span class="s3">270</span>
        <span class="s0">elif </span><span class="s1">row_col == </span><span class="s2">&quot;row&quot;</span><span class="s1">:</span>
            <span class="s1">xanchor = </span><span class="s2">&quot;left&quot;</span>
            <span class="s1">yanchor = </span><span class="s2">&quot;middle&quot;</span>
            <span class="s1">y = (lane - </span><span class="s3">1</span><span class="s1">) * (l + SUBPLOT_SPACING) + </span><span class="s3">0.5 </span><span class="s1">* l</span>
            <span class="s1">x = </span><span class="s3">1.0</span>
            <span class="s1">textangle = </span><span class="s3">0</span>

    <span class="s1">annotation_dict = dict(</span>
        <span class="s1">textangle=textangle</span><span class="s0">,</span>
        <span class="s1">xanchor=xanchor</span><span class="s0">,</span>
        <span class="s1">yanchor=yanchor</span><span class="s0">,</span>
        <span class="s1">x=x</span><span class="s0">,</span>
        <span class="s1">y=y</span><span class="s0">,</span>
        <span class="s1">showarrow=</span><span class="s0">False,</span>
        <span class="s1">xref=</span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
        <span class="s1">yref=</span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
        <span class="s1">text=str(text)</span><span class="s0">,</span>
        <span class="s1">font=dict(size=</span><span class="s3">13</span><span class="s0">, </span><span class="s1">color=AXIS_TITLE_COLOR)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">return </span><span class="s1">annotation_dict</span>


<span class="s0">def </span><span class="s1">_axis_title_annotation(text</span><span class="s0">, </span><span class="s1">x_or_y_axis):</span>
    <span class="s0">if </span><span class="s1">x_or_y_axis == </span><span class="s2">&quot;x&quot;</span><span class="s1">:</span>
        <span class="s1">x_pos = </span><span class="s3">0.5</span>
        <span class="s1">y_pos = -</span><span class="s3">0.1</span>
        <span class="s1">textangle = </span><span class="s3">0</span>
    <span class="s0">elif </span><span class="s1">x_or_y_axis == </span><span class="s2">&quot;y&quot;</span><span class="s1">:</span>
        <span class="s1">x_pos = -</span><span class="s3">0.1</span>
        <span class="s1">y_pos = </span><span class="s3">0.5</span>
        <span class="s1">textangle = </span><span class="s3">270</span>

    <span class="s0">if not </span><span class="s1">text:</span>
        <span class="s1">text = </span><span class="s2">&quot;&quot;</span>

    <span class="s1">annot = {</span>
        <span class="s2">&quot;font&quot;</span><span class="s1">: {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;#000000&quot;</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">: AXIS_TITLE_SIZE}</span><span class="s0">,</span>
        <span class="s2">&quot;showarrow&quot;</span><span class="s1">: </span><span class="s0">False,</span>
        <span class="s2">&quot;text&quot;</span><span class="s1">: text</span><span class="s0">,</span>
        <span class="s2">&quot;textangle&quot;</span><span class="s1">: textangle</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s1">: x_pos</span><span class="s0">,</span>
        <span class="s2">&quot;xanchor&quot;</span><span class="s1">: </span><span class="s2">&quot;center&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;xref&quot;</span><span class="s1">: </span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;y&quot;</span><span class="s1">: y_pos</span><span class="s0">,</span>
        <span class="s2">&quot;yanchor&quot;</span><span class="s1">: </span><span class="s2">&quot;middle&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;yref&quot;</span><span class="s1">: </span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">annot</span>


<span class="s0">def </span><span class="s1">_add_shapes_to_fig(fig</span><span class="s0">, </span><span class="s1">annot_rect_color</span><span class="s0">, </span><span class="s1">flipped_rows=</span><span class="s0">False, </span><span class="s1">flipped_cols=</span><span class="s0">False</span><span class="s1">):</span>
    <span class="s1">shapes_list = []</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">].to_plotly_json().keys():</span>
        <span class="s0">if </span><span class="s2">&quot;axis&quot; </span><span class="s0">in </span><span class="s1">key </span><span class="s0">and </span><span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][key][</span><span class="s2">&quot;domain&quot;</span><span class="s1">] != [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]:</span>
            <span class="s1">shape = {</span>
                <span class="s2">&quot;fillcolor&quot;</span><span class="s1">: annot_rect_color</span><span class="s0">,</span>
                <span class="s2">&quot;layer&quot;</span><span class="s1">: </span><span class="s2">&quot;below&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;line&quot;</span><span class="s1">: {</span><span class="s2">&quot;color&quot;</span><span class="s1">: annot_rect_color</span><span class="s0">, </span><span class="s2">&quot;width&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">,</span>
                <span class="s2">&quot;type&quot;</span><span class="s1">: </span><span class="s2">&quot;rect&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;xref&quot;</span><span class="s1">: </span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;yref&quot;</span><span class="s1">: </span><span class="s2">&quot;paper&quot;</span><span class="s0">,</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s2">&quot;xaxis&quot; </span><span class="s0">in </span><span class="s1">key:</span>
                <span class="s1">shape[</span><span class="s2">&quot;x0&quot;</span><span class="s1">] = fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][key][</span><span class="s2">&quot;domain&quot;</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span>
                <span class="s1">shape[</span><span class="s2">&quot;x1&quot;</span><span class="s1">] = fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][key][</span><span class="s2">&quot;domain&quot;</span><span class="s1">][</span><span class="s3">1</span><span class="s1">]</span>
                <span class="s1">shape[</span><span class="s2">&quot;y0&quot;</span><span class="s1">] = </span><span class="s3">1.005</span>
                <span class="s1">shape[</span><span class="s2">&quot;y1&quot;</span><span class="s1">] = </span><span class="s3">1.05</span>

                <span class="s0">if </span><span class="s1">flipped_cols:</span>
                    <span class="s1">shape[</span><span class="s2">&quot;y1&quot;</span><span class="s1">] += </span><span class="s3">0.5</span>
                <span class="s1">shapes_list.append(shape)</span>

            <span class="s0">elif </span><span class="s2">&quot;yaxis&quot; </span><span class="s0">in </span><span class="s1">key:</span>
                <span class="s1">shape[</span><span class="s2">&quot;x0&quot;</span><span class="s1">] = </span><span class="s3">1.005</span>
                <span class="s1">shape[</span><span class="s2">&quot;x1&quot;</span><span class="s1">] = </span><span class="s3">1.05</span>
                <span class="s1">shape[</span><span class="s2">&quot;y0&quot;</span><span class="s1">] = fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][key][</span><span class="s2">&quot;domain&quot;</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span>
                <span class="s1">shape[</span><span class="s2">&quot;y1&quot;</span><span class="s1">] = fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][key][</span><span class="s2">&quot;domain&quot;</span><span class="s1">][</span><span class="s3">1</span><span class="s1">]</span>

                <span class="s0">if </span><span class="s1">flipped_rows:</span>
                    <span class="s1">shape[</span><span class="s2">&quot;x1&quot;</span><span class="s1">] += </span><span class="s3">1</span>
                <span class="s1">shapes_list.append(shape)</span>

    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;shapes&quot;</span><span class="s1">] = shapes_list</span>


<span class="s0">def </span><span class="s1">_make_trace_for_scatter(trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">color</span><span class="s0">, </span><span class="s1">**kwargs_marker):</span>
    <span class="s0">if </span><span class="s1">trace_type </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;scatter&quot;</span><span class="s0">, </span><span class="s2">&quot;scattergl&quot;</span><span class="s1">]:</span>
        <span class="s1">trace[</span><span class="s2">&quot;mode&quot;</span><span class="s1">] = </span><span class="s2">&quot;markers&quot;</span>
        <span class="s1">trace[</span><span class="s2">&quot;marker&quot;</span><span class="s1">] = dict(color=color</span><span class="s0">, </span><span class="s1">**kwargs_marker)</span>
    <span class="s0">return </span><span class="s1">trace</span>


<span class="s0">def </span><span class="s1">_facet_grid_color_categorical(</span>
    <span class="s1">df</span><span class="s0">,</span>
    <span class="s1">x</span><span class="s0">,</span>
    <span class="s1">y</span><span class="s0">,</span>
    <span class="s1">facet_row</span><span class="s0">,</span>
    <span class="s1">facet_col</span><span class="s0">,</span>
    <span class="s1">color_name</span><span class="s0">,</span>
    <span class="s1">colormap</span><span class="s0">,</span>
    <span class="s1">num_of_rows</span><span class="s0">,</span>
    <span class="s1">num_of_cols</span><span class="s0">,</span>
    <span class="s1">facet_row_labels</span><span class="s0">,</span>
    <span class="s1">facet_col_labels</span><span class="s0">,</span>
    <span class="s1">trace_type</span><span class="s0">,</span>
    <span class="s1">flipped_rows</span><span class="s0">,</span>
    <span class="s1">flipped_cols</span><span class="s0">,</span>
    <span class="s1">show_boxes</span><span class="s0">,</span>
    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
    <span class="s1">marker_color</span><span class="s0">,</span>
    <span class="s1">kwargs_trace</span><span class="s0">,</span>
    <span class="s1">kwargs_marker</span><span class="s0">,</span>
<span class="s1">):</span>

    <span class="s1">fig = make_subplots(</span>
        <span class="s1">rows=num_of_rows</span><span class="s0">,</span>
        <span class="s1">cols=num_of_cols</span><span class="s0">,</span>
        <span class="s1">shared_xaxes=</span><span class="s0">True,</span>
        <span class="s1">shared_yaxes=</span><span class="s0">True,</span>
        <span class="s1">horizontal_spacing=SUBPLOT_SPACING</span><span class="s0">,</span>
        <span class="s1">vertical_spacing=SUBPLOT_SPACING</span><span class="s0">,</span>
        <span class="s1">print_grid=</span><span class="s0">False,</span>
    <span class="s1">)</span>

    <span class="s1">annotations = []</span>
    <span class="s0">if not </span><span class="s1">facet_row </span><span class="s0">and not </span><span class="s1">facet_col:</span>
        <span class="s1">color_groups = list(df.groupby(color_name))</span>
        <span class="s0">for </span><span class="s1">group </span><span class="s0">in </span><span class="s1">color_groups:</span>
            <span class="s1">trace = dict(</span>
                <span class="s1">type=trace_type</span><span class="s0">,</span>
                <span class="s1">name=group[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">marker=dict(color=colormap[group[</span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
                <span class="s1">**kwargs_trace</span>
            <span class="s1">)</span>
            <span class="s0">if </span><span class="s1">x:</span>
                <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = group[</span><span class="s3">1</span><span class="s1">][x]</span>
            <span class="s0">if </span><span class="s1">y:</span>
                <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = group[</span><span class="s3">1</span><span class="s1">][y]</span>
            <span class="s1">trace = _make_trace_for_scatter(</span>
                <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">colormap[group[</span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
            <span class="s1">)</span>

            <span class="s1">fig.append_trace(trace</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">elif </span><span class="s1">(facet_row </span><span class="s0">and not </span><span class="s1">facet_col) </span><span class="s0">or </span><span class="s1">(</span><span class="s0">not </span><span class="s1">facet_row </span><span class="s0">and </span><span class="s1">facet_col):</span>
        <span class="s1">groups_by_facet = list(df.groupby(facet_row </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col))</span>
        <span class="s0">for </span><span class="s1">j</span><span class="s0">, </span><span class="s1">group </span><span class="s0">in </span><span class="s1">enumerate(groups_by_facet):</span>
            <span class="s0">for </span><span class="s1">color_val </span><span class="s0">in </span><span class="s1">df[color_name].unique():</span>
                <span class="s1">data_by_color = group[</span><span class="s3">1</span><span class="s1">][group[</span><span class="s3">1</span><span class="s1">][color_name] == color_val]</span>
                <span class="s1">trace = dict(</span>
                    <span class="s1">type=trace_type</span><span class="s0">,</span>
                    <span class="s1">name=color_val</span><span class="s0">,</span>
                    <span class="s1">marker=dict(color=colormap[color_val])</span><span class="s0">,</span>
                    <span class="s1">**kwargs_trace</span>
                <span class="s1">)</span>
                <span class="s0">if </span><span class="s1">x:</span>
                    <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = data_by_color[x]</span>
                <span class="s0">if </span><span class="s1">y:</span>
                    <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = data_by_color[y]</span>
                <span class="s1">trace = _make_trace_for_scatter(</span>
                    <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">colormap[color_val]</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
                <span class="s1">)</span>

                <span class="s1">fig.append_trace(</span>
                    <span class="s1">trace</span><span class="s0">, </span><span class="s1">j + </span><span class="s3">1 </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1 </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">j + </span><span class="s3">1</span>
                <span class="s1">)</span>

            <span class="s1">label = _return_label(</span>
                <span class="s1">group[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">facet_row_labels </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col_labels</span><span class="s0">,</span>
                <span class="s1">facet_row </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col</span><span class="s0">,</span>
            <span class="s1">)</span>

            <span class="s1">annotations.append(</span>
                <span class="s1">_annotation_dict(</span>
                    <span class="s1">label</span><span class="s0">,</span>
                    <span class="s1">num_of_rows - j </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">j + </span><span class="s3">1</span><span class="s0">,</span>
                    <span class="s1">num_of_rows </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">num_of_cols</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s2">&quot;row&quot; </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s2">&quot;col&quot;</span><span class="s0">,</span>
                    <span class="s1">flipped_rows</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s0">elif </span><span class="s1">facet_row </span><span class="s0">and </span><span class="s1">facet_col:</span>
        <span class="s1">groups_by_facets = list(df.groupby([facet_row</span><span class="s0">, </span><span class="s1">facet_col]))</span>
        <span class="s1">tuple_to_facet_group = {item[</span><span class="s3">0</span><span class="s1">]: item[</span><span class="s3">1</span><span class="s1">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">groups_by_facets}</span>

        <span class="s1">row_values = df[facet_row].unique()</span>
        <span class="s1">col_values = df[facet_col].unique()</span>
        <span class="s1">color_vals = df[color_name].unique()</span>
        <span class="s0">for </span><span class="s1">row_count</span><span class="s0">, </span><span class="s1">x_val </span><span class="s0">in </span><span class="s1">enumerate(row_values):</span>
            <span class="s0">for </span><span class="s1">col_count</span><span class="s0">, </span><span class="s1">y_val </span><span class="s0">in </span><span class="s1">enumerate(col_values):</span>
                <span class="s0">try</span><span class="s1">:</span>
                    <span class="s1">group = tuple_to_facet_group[(x_val</span><span class="s0">, </span><span class="s1">y_val)]</span>
                <span class="s0">except </span><span class="s1">KeyError:</span>
                    <span class="s1">group = pd.DataFrame(</span>
                        <span class="s1">[[</span><span class="s0">None, None, None</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">color_name]</span>
                    <span class="s1">)</span>

                <span class="s0">for </span><span class="s1">color_val </span><span class="s0">in </span><span class="s1">color_vals:</span>
                    <span class="s0">if </span><span class="s1">group.values.tolist() != [[</span><span class="s0">None, None, None</span><span class="s1">]]:</span>
                        <span class="s1">group_filtered = group[group[color_name] == color_val]</span>

                        <span class="s1">trace = dict(</span>
                            <span class="s1">type=trace_type</span><span class="s0">,</span>
                            <span class="s1">name=color_val</span><span class="s0">,</span>
                            <span class="s1">marker=dict(color=colormap[color_val])</span><span class="s0">,</span>
                            <span class="s1">**kwargs_trace</span>
                        <span class="s1">)</span>
                        <span class="s1">new_x = group_filtered[x]</span>
                        <span class="s1">new_y = group_filtered[y]</span>
                    <span class="s0">else</span><span class="s1">:</span>
                        <span class="s1">trace = dict(</span>
                            <span class="s1">type=trace_type</span><span class="s0">,</span>
                            <span class="s1">name=color_val</span><span class="s0">,</span>
                            <span class="s1">marker=dict(color=colormap[color_val])</span><span class="s0">,</span>
                            <span class="s1">showlegend=</span><span class="s0">False,</span>
                            <span class="s1">**kwargs_trace</span>
                        <span class="s1">)</span>
                        <span class="s1">new_x = group[x]</span>
                        <span class="s1">new_y = group[y]</span>

                    <span class="s0">if </span><span class="s1">x:</span>
                        <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = new_x</span>
                    <span class="s0">if </span><span class="s1">y:</span>
                        <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = new_y</span>
                    <span class="s1">trace = _make_trace_for_scatter(</span>
                        <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">colormap[color_val]</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
                    <span class="s1">)</span>

                    <span class="s1">fig.append_trace(trace</span><span class="s0">, </span><span class="s1">row_count + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">col_count + </span><span class="s3">1</span><span class="s1">)</span>
                <span class="s0">if </span><span class="s1">row_count == </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">label = _return_label(</span>
                        <span class="s1">col_values[col_count]</span><span class="s0">, </span><span class="s1">facet_col_labels</span><span class="s0">, </span><span class="s1">facet_col</span>
                    <span class="s1">)</span>
                    <span class="s1">annotations.append(</span>
                        <span class="s1">_annotation_dict(</span>
                            <span class="s1">label</span><span class="s0">,</span>
                            <span class="s1">col_count + </span><span class="s3">1</span><span class="s0">,</span>
                            <span class="s1">num_of_cols</span><span class="s0">,</span>
                            <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                            <span class="s1">row_col=</span><span class="s2">&quot;col&quot;</span><span class="s0">,</span>
                            <span class="s1">flipped=flipped_cols</span><span class="s0">,</span>
                        <span class="s1">)</span>
                    <span class="s1">)</span>
            <span class="s1">label = _return_label(row_values[row_count]</span><span class="s0">, </span><span class="s1">facet_row_labels</span><span class="s0">, </span><span class="s1">facet_row)</span>
            <span class="s1">annotations.append(</span>
                <span class="s1">_annotation_dict(</span>
                    <span class="s1">label</span><span class="s0">,</span>
                    <span class="s1">num_of_rows - row_count</span><span class="s0">,</span>
                    <span class="s1">num_of_rows</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s1">row_col=</span><span class="s2">&quot;row&quot;</span><span class="s0">,</span>
                    <span class="s1">flipped=flipped_rows</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s0">return </span><span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations</span>


<span class="s0">def </span><span class="s1">_facet_grid_color_numerical(</span>
    <span class="s1">df</span><span class="s0">,</span>
    <span class="s1">x</span><span class="s0">,</span>
    <span class="s1">y</span><span class="s0">,</span>
    <span class="s1">facet_row</span><span class="s0">,</span>
    <span class="s1">facet_col</span><span class="s0">,</span>
    <span class="s1">color_name</span><span class="s0">,</span>
    <span class="s1">colormap</span><span class="s0">,</span>
    <span class="s1">num_of_rows</span><span class="s0">,</span>
    <span class="s1">num_of_cols</span><span class="s0">,</span>
    <span class="s1">facet_row_labels</span><span class="s0">,</span>
    <span class="s1">facet_col_labels</span><span class="s0">,</span>
    <span class="s1">trace_type</span><span class="s0">,</span>
    <span class="s1">flipped_rows</span><span class="s0">,</span>
    <span class="s1">flipped_cols</span><span class="s0">,</span>
    <span class="s1">show_boxes</span><span class="s0">,</span>
    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
    <span class="s1">marker_color</span><span class="s0">,</span>
    <span class="s1">kwargs_trace</span><span class="s0">,</span>
    <span class="s1">kwargs_marker</span><span class="s0">,</span>
<span class="s1">):</span>

    <span class="s1">fig = make_subplots(</span>
        <span class="s1">rows=num_of_rows</span><span class="s0">,</span>
        <span class="s1">cols=num_of_cols</span><span class="s0">,</span>
        <span class="s1">shared_xaxes=</span><span class="s0">True,</span>
        <span class="s1">shared_yaxes=</span><span class="s0">True,</span>
        <span class="s1">horizontal_spacing=SUBPLOT_SPACING</span><span class="s0">,</span>
        <span class="s1">vertical_spacing=SUBPLOT_SPACING</span><span class="s0">,</span>
        <span class="s1">print_grid=</span><span class="s0">False,</span>
    <span class="s1">)</span>

    <span class="s1">annotations = []</span>
    <span class="s0">if not </span><span class="s1">facet_row </span><span class="s0">and not </span><span class="s1">facet_col:</span>
        <span class="s1">trace = dict(</span>
            <span class="s1">type=trace_type</span><span class="s0">,</span>
            <span class="s1">marker=dict(color=df[color_name]</span><span class="s0">, </span><span class="s1">colorscale=colormap</span><span class="s0">, </span><span class="s1">showscale=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">**kwargs_trace</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">x:</span>
            <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = df[x]</span>
        <span class="s0">if </span><span class="s1">y:</span>
            <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = df[y]</span>
        <span class="s1">trace = _make_trace_for_scatter(</span>
            <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">df[color_name]</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
        <span class="s1">)</span>

        <span class="s1">fig.append_trace(trace</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">(facet_row </span><span class="s0">and not </span><span class="s1">facet_col) </span><span class="s0">or </span><span class="s1">(</span><span class="s0">not </span><span class="s1">facet_row </span><span class="s0">and </span><span class="s1">facet_col):</span>
        <span class="s1">groups_by_facet = list(df.groupby(facet_row </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col))</span>
        <span class="s0">for </span><span class="s1">j</span><span class="s0">, </span><span class="s1">group </span><span class="s0">in </span><span class="s1">enumerate(groups_by_facet):</span>
            <span class="s1">trace = dict(</span>
                <span class="s1">type=trace_type</span><span class="s0">,</span>
                <span class="s1">marker=dict(</span>
                    <span class="s1">color=df[color_name]</span><span class="s0">,</span>
                    <span class="s1">colorscale=colormap</span><span class="s0">,</span>
                    <span class="s1">showscale=</span><span class="s0">True,</span>
                    <span class="s1">colorbar=dict(x=</span><span class="s3">1.15</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">**kwargs_trace</span>
            <span class="s1">)</span>
            <span class="s0">if </span><span class="s1">x:</span>
                <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = group[</span><span class="s3">1</span><span class="s1">][x]</span>
            <span class="s0">if </span><span class="s1">y:</span>
                <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = group[</span><span class="s3">1</span><span class="s1">][y]</span>
            <span class="s1">trace = _make_trace_for_scatter(</span>
                <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">df[color_name]</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
            <span class="s1">)</span>

            <span class="s1">fig.append_trace(</span>
                <span class="s1">trace</span><span class="s0">, </span><span class="s1">j + </span><span class="s3">1 </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1 </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">j + </span><span class="s3">1</span>
            <span class="s1">)</span>

            <span class="s1">labels = facet_row_labels </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col_labels</span>
            <span class="s1">label = _return_label(</span>
                <span class="s1">group[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">labels</span><span class="s0">, </span><span class="s1">facet_row </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col</span>
            <span class="s1">)</span>

            <span class="s1">annotations.append(</span>
                <span class="s1">_annotation_dict(</span>
                    <span class="s1">label</span><span class="s0">,</span>
                    <span class="s1">num_of_rows - j </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">j + </span><span class="s3">1</span><span class="s0">,</span>
                    <span class="s1">num_of_rows </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">num_of_cols</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s2">&quot;row&quot; </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s2">&quot;col&quot;</span><span class="s0">,</span>
                    <span class="s1">flipped=flipped_rows</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s0">elif </span><span class="s1">facet_row </span><span class="s0">and </span><span class="s1">facet_col:</span>
        <span class="s1">groups_by_facets = list(df.groupby([facet_row</span><span class="s0">, </span><span class="s1">facet_col]))</span>
        <span class="s1">tuple_to_facet_group = {item[</span><span class="s3">0</span><span class="s1">]: item[</span><span class="s3">1</span><span class="s1">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">groups_by_facets}</span>

        <span class="s1">row_values = df[facet_row].unique()</span>
        <span class="s1">col_values = df[facet_col].unique()</span>
        <span class="s0">for </span><span class="s1">row_count</span><span class="s0">, </span><span class="s1">x_val </span><span class="s0">in </span><span class="s1">enumerate(row_values):</span>
            <span class="s0">for </span><span class="s1">col_count</span><span class="s0">, </span><span class="s1">y_val </span><span class="s0">in </span><span class="s1">enumerate(col_values):</span>
                <span class="s0">try</span><span class="s1">:</span>
                    <span class="s1">group = tuple_to_facet_group[(x_val</span><span class="s0">, </span><span class="s1">y_val)]</span>
                <span class="s0">except </span><span class="s1">KeyError:</span>
                    <span class="s1">group = pd.DataFrame(</span>
                        <span class="s1">[[</span><span class="s0">None, None, None</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">color_name]</span>
                    <span class="s1">)</span>

                <span class="s0">if </span><span class="s1">group.values.tolist() != [[</span><span class="s0">None, None, None</span><span class="s1">]]:</span>
                    <span class="s1">trace = dict(</span>
                        <span class="s1">type=trace_type</span><span class="s0">,</span>
                        <span class="s1">marker=dict(</span>
                            <span class="s1">color=df[color_name]</span><span class="s0">,</span>
                            <span class="s1">colorscale=colormap</span><span class="s0">,</span>
                            <span class="s1">showscale=(row_count == </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">colorbar=dict(x=</span><span class="s3">1.15</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">**kwargs_trace</span>
                    <span class="s1">)</span>

                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">trace = dict(type=trace_type</span><span class="s0">, </span><span class="s1">showlegend=</span><span class="s0">False, </span><span class="s1">**kwargs_trace)</span>

                <span class="s0">if </span><span class="s1">x:</span>
                    <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = group[x]</span>
                <span class="s0">if </span><span class="s1">y:</span>
                    <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = group[y]</span>
                <span class="s1">trace = _make_trace_for_scatter(</span>
                    <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">df[color_name]</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
                <span class="s1">)</span>

                <span class="s1">fig.append_trace(trace</span><span class="s0">, </span><span class="s1">row_count + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">col_count + </span><span class="s3">1</span><span class="s1">)</span>
                <span class="s0">if </span><span class="s1">row_count == </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">label = _return_label(</span>
                        <span class="s1">col_values[col_count]</span><span class="s0">, </span><span class="s1">facet_col_labels</span><span class="s0">, </span><span class="s1">facet_col</span>
                    <span class="s1">)</span>
                    <span class="s1">annotations.append(</span>
                        <span class="s1">_annotation_dict(</span>
                            <span class="s1">label</span><span class="s0">,</span>
                            <span class="s1">col_count + </span><span class="s3">1</span><span class="s0">,</span>
                            <span class="s1">num_of_cols</span><span class="s0">,</span>
                            <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                            <span class="s1">row_col=</span><span class="s2">&quot;col&quot;</span><span class="s0">,</span>
                            <span class="s1">flipped=flipped_cols</span><span class="s0">,</span>
                        <span class="s1">)</span>
                    <span class="s1">)</span>
            <span class="s1">label = _return_label(row_values[row_count]</span><span class="s0">, </span><span class="s1">facet_row_labels</span><span class="s0">, </span><span class="s1">facet_row)</span>
            <span class="s1">annotations.append(</span>
                <span class="s1">_annotation_dict(</span>
                    <span class="s1">row_values[row_count]</span><span class="s0">,</span>
                    <span class="s1">num_of_rows - row_count</span><span class="s0">,</span>
                    <span class="s1">num_of_rows</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s1">row_col=</span><span class="s2">&quot;row&quot;</span><span class="s0">,</span>
                    <span class="s1">flipped=flipped_rows</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s0">return </span><span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations</span>


<span class="s0">def </span><span class="s1">_facet_grid(</span>
    <span class="s1">df</span><span class="s0">,</span>
    <span class="s1">x</span><span class="s0">,</span>
    <span class="s1">y</span><span class="s0">,</span>
    <span class="s1">facet_row</span><span class="s0">,</span>
    <span class="s1">facet_col</span><span class="s0">,</span>
    <span class="s1">num_of_rows</span><span class="s0">,</span>
    <span class="s1">num_of_cols</span><span class="s0">,</span>
    <span class="s1">facet_row_labels</span><span class="s0">,</span>
    <span class="s1">facet_col_labels</span><span class="s0">,</span>
    <span class="s1">trace_type</span><span class="s0">,</span>
    <span class="s1">flipped_rows</span><span class="s0">,</span>
    <span class="s1">flipped_cols</span><span class="s0">,</span>
    <span class="s1">show_boxes</span><span class="s0">,</span>
    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
    <span class="s1">marker_color</span><span class="s0">,</span>
    <span class="s1">kwargs_trace</span><span class="s0">,</span>
    <span class="s1">kwargs_marker</span><span class="s0">,</span>
<span class="s1">):</span>

    <span class="s1">fig = make_subplots(</span>
        <span class="s1">rows=num_of_rows</span><span class="s0">,</span>
        <span class="s1">cols=num_of_cols</span><span class="s0">,</span>
        <span class="s1">shared_xaxes=</span><span class="s0">True,</span>
        <span class="s1">shared_yaxes=</span><span class="s0">True,</span>
        <span class="s1">horizontal_spacing=SUBPLOT_SPACING</span><span class="s0">,</span>
        <span class="s1">vertical_spacing=SUBPLOT_SPACING</span><span class="s0">,</span>
        <span class="s1">print_grid=</span><span class="s0">False,</span>
    <span class="s1">)</span>
    <span class="s1">annotations = []</span>
    <span class="s0">if not </span><span class="s1">facet_row </span><span class="s0">and not </span><span class="s1">facet_col:</span>
        <span class="s1">trace = dict(</span>
            <span class="s1">type=trace_type</span><span class="s0">,</span>
            <span class="s1">marker=dict(color=marker_color</span><span class="s0">, </span><span class="s1">line=kwargs_marker[</span><span class="s2">&quot;line&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">**kwargs_trace</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">x:</span>
            <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = df[x]</span>
        <span class="s0">if </span><span class="s1">y:</span>
            <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = df[y]</span>
        <span class="s1">trace = _make_trace_for_scatter(</span>
            <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">marker_color</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
        <span class="s1">)</span>

        <span class="s1">fig.append_trace(trace</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">elif </span><span class="s1">(facet_row </span><span class="s0">and not </span><span class="s1">facet_col) </span><span class="s0">or </span><span class="s1">(</span><span class="s0">not </span><span class="s1">facet_row </span><span class="s0">and </span><span class="s1">facet_col):</span>
        <span class="s1">groups_by_facet = list(df.groupby(facet_row </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col))</span>
        <span class="s0">for </span><span class="s1">j</span><span class="s0">, </span><span class="s1">group </span><span class="s0">in </span><span class="s1">enumerate(groups_by_facet):</span>
            <span class="s1">trace = dict(</span>
                <span class="s1">type=trace_type</span><span class="s0">,</span>
                <span class="s1">marker=dict(color=marker_color</span><span class="s0">, </span><span class="s1">line=kwargs_marker[</span><span class="s2">&quot;line&quot;</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">**kwargs_trace</span>
            <span class="s1">)</span>

            <span class="s0">if </span><span class="s1">x:</span>
                <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = group[</span><span class="s3">1</span><span class="s1">][x]</span>
            <span class="s0">if </span><span class="s1">y:</span>
                <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = group[</span><span class="s3">1</span><span class="s1">][y]</span>
            <span class="s1">trace = _make_trace_for_scatter(</span>
                <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">marker_color</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
            <span class="s1">)</span>

            <span class="s1">fig.append_trace(</span>
                <span class="s1">trace</span><span class="s0">, </span><span class="s1">j + </span><span class="s3">1 </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1 </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">j + </span><span class="s3">1</span>
            <span class="s1">)</span>

            <span class="s1">label = _return_label(</span>
                <span class="s1">group[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">facet_row_labels </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col_labels</span><span class="s0">,</span>
                <span class="s1">facet_row </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">facet_col</span><span class="s0">,</span>
            <span class="s1">)</span>

            <span class="s1">annotations.append(</span>
                <span class="s1">_annotation_dict(</span>
                    <span class="s1">label</span><span class="s0">,</span>
                    <span class="s1">num_of_rows - j </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">j + </span><span class="s3">1</span><span class="s0">,</span>
                    <span class="s1">num_of_rows </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s1">num_of_cols</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s2">&quot;row&quot; </span><span class="s0">if </span><span class="s1">facet_row </span><span class="s0">else </span><span class="s2">&quot;col&quot;</span><span class="s0">,</span>
                    <span class="s1">flipped_rows</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s0">elif </span><span class="s1">facet_row </span><span class="s0">and </span><span class="s1">facet_col:</span>
        <span class="s1">groups_by_facets = list(df.groupby([facet_row</span><span class="s0">, </span><span class="s1">facet_col]))</span>
        <span class="s1">tuple_to_facet_group = {item[</span><span class="s3">0</span><span class="s1">]: item[</span><span class="s3">1</span><span class="s1">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">groups_by_facets}</span>

        <span class="s1">row_values = df[facet_row].unique()</span>
        <span class="s1">col_values = df[facet_col].unique()</span>
        <span class="s0">for </span><span class="s1">row_count</span><span class="s0">, </span><span class="s1">x_val </span><span class="s0">in </span><span class="s1">enumerate(row_values):</span>
            <span class="s0">for </span><span class="s1">col_count</span><span class="s0">, </span><span class="s1">y_val </span><span class="s0">in </span><span class="s1">enumerate(col_values):</span>
                <span class="s0">try</span><span class="s1">:</span>
                    <span class="s1">group = tuple_to_facet_group[(x_val</span><span class="s0">, </span><span class="s1">y_val)]</span>
                <span class="s0">except </span><span class="s1">KeyError:</span>
                    <span class="s1">group = pd.DataFrame([[</span><span class="s0">None, None</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[x</span><span class="s0">, </span><span class="s1">y])</span>
                <span class="s1">trace = dict(</span>
                    <span class="s1">type=trace_type</span><span class="s0">,</span>
                    <span class="s1">marker=dict(color=marker_color</span><span class="s0">, </span><span class="s1">line=kwargs_marker[</span><span class="s2">&quot;line&quot;</span><span class="s1">])</span><span class="s0">,</span>
                    <span class="s1">**kwargs_trace</span>
                <span class="s1">)</span>
                <span class="s0">if </span><span class="s1">x:</span>
                    <span class="s1">trace[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = group[x]</span>
                <span class="s0">if </span><span class="s1">y:</span>
                    <span class="s1">trace[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = group[y]</span>
                <span class="s1">trace = _make_trace_for_scatter(</span>
                    <span class="s1">trace</span><span class="s0">, </span><span class="s1">trace_type</span><span class="s0">, </span><span class="s1">marker_color</span><span class="s0">, </span><span class="s1">**kwargs_marker</span>
                <span class="s1">)</span>

                <span class="s1">fig.append_trace(trace</span><span class="s0">, </span><span class="s1">row_count + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">col_count + </span><span class="s3">1</span><span class="s1">)</span>
                <span class="s0">if </span><span class="s1">row_count == </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">label = _return_label(</span>
                        <span class="s1">col_values[col_count]</span><span class="s0">, </span><span class="s1">facet_col_labels</span><span class="s0">, </span><span class="s1">facet_col</span>
                    <span class="s1">)</span>
                    <span class="s1">annotations.append(</span>
                        <span class="s1">_annotation_dict(</span>
                            <span class="s1">label</span><span class="s0">,</span>
                            <span class="s1">col_count + </span><span class="s3">1</span><span class="s0">,</span>
                            <span class="s1">num_of_cols</span><span class="s0">,</span>
                            <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                            <span class="s1">row_col=</span><span class="s2">&quot;col&quot;</span><span class="s0">,</span>
                            <span class="s1">flipped=flipped_cols</span><span class="s0">,</span>
                        <span class="s1">)</span>
                    <span class="s1">)</span>

            <span class="s1">label = _return_label(row_values[row_count]</span><span class="s0">, </span><span class="s1">facet_row_labels</span><span class="s0">, </span><span class="s1">facet_row)</span>
            <span class="s1">annotations.append(</span>
                <span class="s1">_annotation_dict(</span>
                    <span class="s1">label</span><span class="s0">,</span>
                    <span class="s1">num_of_rows - row_count</span><span class="s0">,</span>
                    <span class="s1">num_of_rows</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s1">row_col=</span><span class="s2">&quot;row&quot;</span><span class="s0">,</span>
                    <span class="s1">flipped=flipped_rows</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s0">return </span><span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations</span>


<span class="s0">def </span><span class="s1">create_facet_grid(</span>
    <span class="s1">df</span><span class="s0">,</span>
    <span class="s1">x=</span><span class="s0">None,</span>
    <span class="s1">y=</span><span class="s0">None,</span>
    <span class="s1">facet_row=</span><span class="s0">None,</span>
    <span class="s1">facet_col=</span><span class="s0">None,</span>
    <span class="s1">color_name=</span><span class="s0">None,</span>
    <span class="s1">colormap=</span><span class="s0">None,</span>
    <span class="s1">color_is_cat=</span><span class="s0">False,</span>
    <span class="s1">facet_row_labels=</span><span class="s0">None,</span>
    <span class="s1">facet_col_labels=</span><span class="s0">None,</span>
    <span class="s1">height=</span><span class="s0">None,</span>
    <span class="s1">width=</span><span class="s0">None,</span>
    <span class="s1">trace_type=</span><span class="s2">&quot;scatter&quot;</span><span class="s0">,</span>
    <span class="s1">scales=</span><span class="s2">&quot;fixed&quot;</span><span class="s0">,</span>
    <span class="s1">dtick_x=</span><span class="s0">None,</span>
    <span class="s1">dtick_y=</span><span class="s0">None,</span>
    <span class="s1">show_boxes=</span><span class="s0">True,</span>
    <span class="s1">ggplot2=</span><span class="s0">False,</span>
    <span class="s1">binsize=</span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">**kwargs</span>
<span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Returns figure for facet grid; **this function is deprecated**, since 
    plotly.express functions should be used instead, for example 
 
    &gt;&gt;&gt; import plotly.express as px 
    &gt;&gt;&gt; tips = px.data.tips() 
    &gt;&gt;&gt; fig = px.scatter(tips,  
    ...     x='total_bill', 
    ...     y='tip', 
    ...     facet_row='sex', 
    ...     facet_col='smoker', 
    ...     color='size') 
 
 
    :param (pd.DataFrame) df: the dataframe of columns for the facet grid. 
    :param (str) x: the name of the dataframe column for the x axis data. 
    :param (str) y: the name of the dataframe column for the y axis data. 
    :param (str) facet_row: the name of the dataframe column that is used to 
        facet the grid into row panels. 
    :param (str) facet_col: the name of the dataframe column that is used to 
        facet the grid into column panels. 
    :param (str) color_name: the name of your dataframe column that will 
        function as the colormap variable. 
    :param (str|list|dict) colormap: the param that determines how the 
        color_name column colors the data. If the dataframe contains numeric 
        data, then a dictionary of colors will group the data categorically 
        while a Plotly Colorscale name or a custom colorscale will treat it 
        numerically. To learn more about colors and types of colormap, run 
        `help(plotly.colors)`. 
    :param (bool) color_is_cat: determines whether a numerical column for the 
        colormap will be treated as categorical (True) or sequential (False). 
            Default = False. 
    :param (str|dict) facet_row_labels: set to either 'name' or a dictionary 
        of all the unique values in the faceting row mapped to some text to 
        show up in the label annotations. If None, labeling works like usual. 
    :param (str|dict) facet_col_labels: set to either 'name' or a dictionary 
        of all the values in the faceting row mapped to some text to show up 
        in the label annotations. If None, labeling works like usual. 
    :param (int) height: the height of the facet grid figure. 
    :param (int) width: the width of the facet grid figure. 
    :param (str) trace_type: decides the type of plot to appear in the 
        facet grid. The options are 'scatter', 'scattergl', 'histogram', 
        'bar', and 'box'. 
        Default = 'scatter'. 
    :param (str) scales: determines if axes have fixed ranges or not. Valid 
        settings are 'fixed' (all axes fixed), 'free_x' (x axis free only), 
        'free_y' (y axis free only) or 'free' (both axes free). 
    :param (float) dtick_x: determines the distance between each tick on the 
        x-axis. Default is None which means dtick_x is set automatically. 
    :param (float) dtick_y: determines the distance between each tick on the 
        y-axis. Default is None which means dtick_y is set automatically. 
    :param (bool) show_boxes: draws grey boxes behind the facet titles. 
    :param (bool) ggplot2: draws the facet grid in the style of `ggplot2`. See 
        http://ggplot2.tidyverse.org/reference/facet_grid.html for reference. 
        Default = False 
    :param (int) binsize: groups all data into bins of a given length. 
    :param (dict) kwargs: a dictionary of scatterplot arguments. 
 
    Examples 1: One Way Faceting 
 
    &gt;&gt;&gt; import plotly.figure_factory as ff 
    &gt;&gt;&gt; import pandas as pd 
    &gt;&gt;&gt; mpg = pd.read_table('https://raw.githubusercontent.com/plotly/datasets/master/mpg_2017.txt') 
 
    &gt;&gt;&gt; fig = ff.create_facet_grid( 
    ...     mpg, 
    ...     x='displ', 
    ...     y='cty', 
    ...     facet_col='cyl', 
    ... ) 
    &gt;&gt;&gt; fig.show() 
 
    Example 2: Two Way Faceting 
 
    &gt;&gt;&gt; import plotly.figure_factory as ff 
 
    &gt;&gt;&gt; import pandas as pd 
 
    &gt;&gt;&gt; mpg = pd.read_table('https://raw.githubusercontent.com/plotly/datasets/master/mpg_2017.txt') 
 
    &gt;&gt;&gt; fig = ff.create_facet_grid( 
    ...     mpg, 
    ...     x='displ', 
    ...     y='cty', 
    ...     facet_row='drv', 
    ...     facet_col='cyl', 
    ... ) 
    &gt;&gt;&gt; fig.show() 
 
    Example 3: Categorical Coloring 
 
    &gt;&gt;&gt; import plotly.figure_factory as ff 
    &gt;&gt;&gt; import pandas as pd 
    &gt;&gt;&gt; mtcars = pd.read_csv('https://raw.githubusercontent.com/plotly/datasets/master/mtcars.csv') 
    &gt;&gt;&gt; mtcars.cyl = mtcars.cyl.astype(str) 
    &gt;&gt;&gt; fig = ff.create_facet_grid( 
    ...     mtcars, 
    ...     x='mpg', 
    ...     y='wt', 
    ...     facet_col='cyl', 
    ...     color_name='cyl', 
    ...     color_is_cat=True, 
    ... ) 
    &gt;&gt;&gt; fig.show() 
 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if not </span><span class="s1">pd:</span>
        <span class="s0">raise </span><span class="s1">ImportError(</span><span class="s2">&quot;'pandas' must be installed for this figure_factory.&quot;</span><span class="s1">)</span>

    <span class="s0">if not </span><span class="s1">isinstance(df</span><span class="s0">, </span><span class="s1">pd.DataFrame):</span>
        <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span><span class="s2">&quot;You must input a pandas DataFrame.&quot;</span><span class="s1">)</span>

    <span class="s5"># make sure all columns are of homogenous datatype</span>
    <span class="s1">utils.validate_dataframe(df)</span>

    <span class="s0">if </span><span class="s1">trace_type </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;scatter&quot;</span><span class="s0">, </span><span class="s2">&quot;scattergl&quot;</span><span class="s1">]:</span>
        <span class="s0">if not </span><span class="s1">x </span><span class="s0">or not </span><span class="s1">y:</span>
            <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
                <span class="s2">&quot;You need to input 'x' and 'y' if you are you are using a &quot;</span>
                <span class="s2">&quot;trace_type of 'scatter' or 'scattergl'.&quot;</span>
            <span class="s1">)</span>

    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">facet_row</span><span class="s0">, </span><span class="s1">facet_col</span><span class="s0">, </span><span class="s1">color_name]:</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">df[key]</span>
            <span class="s0">except </span><span class="s1">KeyError:</span>
                <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
                    <span class="s2">&quot;x, y, facet_row, facet_col and color_name must be keys &quot;</span>
                    <span class="s2">&quot;in your dataframe.&quot;</span>
                <span class="s1">)</span>
    <span class="s5"># autoscale histogram bars</span>
    <span class="s0">if </span><span class="s1">trace_type </span><span class="s0">not in </span><span class="s1">[</span><span class="s2">&quot;scatter&quot;</span><span class="s0">, </span><span class="s2">&quot;scattergl&quot;</span><span class="s1">]:</span>
        <span class="s1">scales = </span><span class="s2">&quot;free&quot;</span>

    <span class="s5"># validate scales</span>
    <span class="s0">if </span><span class="s1">scales </span><span class="s0">not in </span><span class="s1">[</span><span class="s2">&quot;fixed&quot;</span><span class="s0">, </span><span class="s2">&quot;free_x&quot;</span><span class="s0">, </span><span class="s2">&quot;free_y&quot;</span><span class="s0">, </span><span class="s2">&quot;free&quot;</span><span class="s1">]:</span>
        <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
            <span class="s2">&quot;'scales' must be set to 'fixed', 'free_x', 'free_y' and 'free'.&quot;</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">trace_type </span><span class="s0">not in </span><span class="s1">VALID_TRACE_TYPES:</span>
        <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
            <span class="s2">&quot;'trace_type' must be in {}&quot;</span><span class="s1">.format(VALID_TRACE_TYPES)</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">trace_type == </span><span class="s2">&quot;histogram&quot;</span><span class="s1">:</span>
        <span class="s1">SUBPLOT_SPACING = </span><span class="s3">0.06</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">SUBPLOT_SPACING = </span><span class="s3">0.015</span>

    <span class="s5"># seperate kwargs for marker and else</span>
    <span class="s0">if </span><span class="s2">&quot;marker&quot; </span><span class="s0">in </span><span class="s1">kwargs:</span>
        <span class="s1">kwargs_marker = kwargs[</span><span class="s2">&quot;marker&quot;</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">kwargs_marker = {}</span>
    <span class="s1">marker_color = kwargs_marker.pop(</span><span class="s2">&quot;color&quot;</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">kwargs.pop(</span><span class="s2">&quot;marker&quot;</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">kwargs_trace = kwargs</span>

    <span class="s0">if </span><span class="s2">&quot;size&quot; </span><span class="s0">not in </span><span class="s1">kwargs_marker:</span>
        <span class="s0">if </span><span class="s1">ggplot2:</span>
            <span class="s1">kwargs_marker[</span><span class="s2">&quot;size&quot;</span><span class="s1">] = </span><span class="s3">5</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">kwargs_marker[</span><span class="s2">&quot;size&quot;</span><span class="s1">] = </span><span class="s3">8</span>

    <span class="s0">if </span><span class="s2">&quot;opacity&quot; </span><span class="s0">not in </span><span class="s1">kwargs_marker:</span>
        <span class="s0">if not </span><span class="s1">ggplot2:</span>
            <span class="s1">kwargs_trace[</span><span class="s2">&quot;opacity&quot;</span><span class="s1">] = </span><span class="s3">0.6</span>

    <span class="s0">if </span><span class="s2">&quot;line&quot; </span><span class="s0">not in </span><span class="s1">kwargs_marker:</span>
        <span class="s0">if not </span><span class="s1">ggplot2:</span>
            <span class="s1">kwargs_marker[</span><span class="s2">&quot;line&quot;</span><span class="s1">] = {</span><span class="s2">&quot;color&quot;</span><span class="s1">: </span><span class="s2">&quot;darkgrey&quot;</span><span class="s0">, </span><span class="s2">&quot;width&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">kwargs_marker[</span><span class="s2">&quot;line&quot;</span><span class="s1">] = {}</span>

    <span class="s5"># default marker size</span>
    <span class="s0">if not </span><span class="s1">ggplot2:</span>
        <span class="s0">if not </span><span class="s1">marker_color:</span>
            <span class="s1">marker_color = </span><span class="s2">&quot;rgb(31, 119, 180)&quot;</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">marker_color = </span><span class="s2">&quot;rgb(0, 0, 0)&quot;</span>

    <span class="s1">num_of_rows = </span><span class="s3">1</span>
    <span class="s1">num_of_cols = </span><span class="s3">1</span>
    <span class="s1">flipped_rows = </span><span class="s0">False</span>
    <span class="s1">flipped_cols = </span><span class="s0">False</span>
    <span class="s0">if </span><span class="s1">facet_row:</span>
        <span class="s1">num_of_rows = len(df[facet_row].unique())</span>
        <span class="s1">flipped_rows = _is_flipped(num_of_rows)</span>
        <span class="s0">if </span><span class="s1">isinstance(facet_row_labels</span><span class="s0">, </span><span class="s1">dict):</span>
            <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">df[facet_row].unique():</span>
                <span class="s0">if </span><span class="s1">key </span><span class="s0">not in </span><span class="s1">facet_row_labels.keys():</span>
                    <span class="s1">unique_keys = df[facet_row].unique().tolist()</span>
                    <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(CUSTOM_LABEL_ERROR.format(unique_keys))</span>
    <span class="s0">if </span><span class="s1">facet_col:</span>
        <span class="s1">num_of_cols = len(df[facet_col].unique())</span>
        <span class="s1">flipped_cols = _is_flipped(num_of_cols)</span>
        <span class="s0">if </span><span class="s1">isinstance(facet_col_labels</span><span class="s0">, </span><span class="s1">dict):</span>
            <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">df[facet_col].unique():</span>
                <span class="s0">if </span><span class="s1">key </span><span class="s0">not in </span><span class="s1">facet_col_labels.keys():</span>
                    <span class="s1">unique_keys = df[facet_col].unique().tolist()</span>
                    <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(CUSTOM_LABEL_ERROR.format(unique_keys))</span>
    <span class="s1">show_legend = </span><span class="s0">False</span>
    <span class="s0">if </span><span class="s1">color_name:</span>
        <span class="s0">if </span><span class="s1">isinstance(df[color_name].iloc[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">str) </span><span class="s0">or </span><span class="s1">color_is_cat:</span>
            <span class="s1">show_legend = </span><span class="s0">True</span>
            <span class="s0">if </span><span class="s1">isinstance(colormap</span><span class="s0">, </span><span class="s1">dict):</span>
                <span class="s1">clrs.validate_colors_dict(colormap</span><span class="s0">, </span><span class="s2">&quot;rgb&quot;</span><span class="s1">)</span>

                <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">df[color_name].unique():</span>
                    <span class="s0">if </span><span class="s1">val </span><span class="s0">not in </span><span class="s1">colormap.keys():</span>
                        <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
                            <span class="s2">&quot;If using 'colormap' as a dictionary, make sure &quot;</span>
                            <span class="s2">&quot;all the values of the colormap column are in &quot;</span>
                            <span class="s2">&quot;the keys of your dictionary.&quot;</span>
                        <span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s5"># use default plotly colors for dictionary</span>
                <span class="s1">default_colors = clrs.DEFAULT_PLOTLY_COLORS</span>
                <span class="s1">colormap = {}</span>
                <span class="s1">j = </span><span class="s3">0</span>
                <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">df[color_name].unique():</span>
                    <span class="s0">if </span><span class="s1">j &gt;= len(default_colors):</span>
                        <span class="s1">j = </span><span class="s3">0</span>
                    <span class="s1">colormap[val] = default_colors[j]</span>
                    <span class="s1">j += </span><span class="s3">1</span>
            <span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations = _facet_grid_color_categorical(</span>
                <span class="s1">df</span><span class="s0">,</span>
                <span class="s1">x</span><span class="s0">,</span>
                <span class="s1">y</span><span class="s0">,</span>
                <span class="s1">facet_row</span><span class="s0">,</span>
                <span class="s1">facet_col</span><span class="s0">,</span>
                <span class="s1">color_name</span><span class="s0">,</span>
                <span class="s1">colormap</span><span class="s0">,</span>
                <span class="s1">num_of_rows</span><span class="s0">,</span>
                <span class="s1">num_of_cols</span><span class="s0">,</span>
                <span class="s1">facet_row_labels</span><span class="s0">,</span>
                <span class="s1">facet_col_labels</span><span class="s0">,</span>
                <span class="s1">trace_type</span><span class="s0">,</span>
                <span class="s1">flipped_rows</span><span class="s0">,</span>
                <span class="s1">flipped_cols</span><span class="s0">,</span>
                <span class="s1">show_boxes</span><span class="s0">,</span>
                <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                <span class="s1">marker_color</span><span class="s0">,</span>
                <span class="s1">kwargs_trace</span><span class="s0">,</span>
                <span class="s1">kwargs_marker</span><span class="s0">,</span>
            <span class="s1">)</span>

        <span class="s0">elif </span><span class="s1">isinstance(df[color_name].iloc[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">Number):</span>
            <span class="s0">if </span><span class="s1">isinstance(colormap</span><span class="s0">, </span><span class="s1">dict):</span>
                <span class="s1">show_legend = </span><span class="s0">True</span>
                <span class="s1">clrs.validate_colors_dict(colormap</span><span class="s0">, </span><span class="s2">&quot;rgb&quot;</span><span class="s1">)</span>

                <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">df[color_name].unique():</span>
                    <span class="s0">if </span><span class="s1">val </span><span class="s0">not in </span><span class="s1">colormap.keys():</span>
                        <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
                            <span class="s2">&quot;If using 'colormap' as a dictionary, make sure &quot;</span>
                            <span class="s2">&quot;all the values of the colormap column are in &quot;</span>
                            <span class="s2">&quot;the keys of your dictionary.&quot;</span>
                        <span class="s1">)</span>
                <span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations = _facet_grid_color_categorical(</span>
                    <span class="s1">df</span><span class="s0">,</span>
                    <span class="s1">x</span><span class="s0">,</span>
                    <span class="s1">y</span><span class="s0">,</span>
                    <span class="s1">facet_row</span><span class="s0">,</span>
                    <span class="s1">facet_col</span><span class="s0">,</span>
                    <span class="s1">color_name</span><span class="s0">,</span>
                    <span class="s1">colormap</span><span class="s0">,</span>
                    <span class="s1">num_of_rows</span><span class="s0">,</span>
                    <span class="s1">num_of_cols</span><span class="s0">,</span>
                    <span class="s1">facet_row_labels</span><span class="s0">,</span>
                    <span class="s1">facet_col_labels</span><span class="s0">,</span>
                    <span class="s1">trace_type</span><span class="s0">,</span>
                    <span class="s1">flipped_rows</span><span class="s0">,</span>
                    <span class="s1">flipped_cols</span><span class="s0">,</span>
                    <span class="s1">show_boxes</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s1">marker_color</span><span class="s0">,</span>
                    <span class="s1">kwargs_trace</span><span class="s0">,</span>
                    <span class="s1">kwargs_marker</span><span class="s0">,</span>
                <span class="s1">)</span>

            <span class="s0">elif </span><span class="s1">isinstance(colormap</span><span class="s0">, </span><span class="s1">list):</span>
                <span class="s1">colorscale_list = colormap</span>
                <span class="s1">clrs.validate_colorscale(colorscale_list)</span>

                <span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations = _facet_grid_color_numerical(</span>
                    <span class="s1">df</span><span class="s0">,</span>
                    <span class="s1">x</span><span class="s0">,</span>
                    <span class="s1">y</span><span class="s0">,</span>
                    <span class="s1">facet_row</span><span class="s0">,</span>
                    <span class="s1">facet_col</span><span class="s0">,</span>
                    <span class="s1">color_name</span><span class="s0">,</span>
                    <span class="s1">colorscale_list</span><span class="s0">,</span>
                    <span class="s1">num_of_rows</span><span class="s0">,</span>
                    <span class="s1">num_of_cols</span><span class="s0">,</span>
                    <span class="s1">facet_row_labels</span><span class="s0">,</span>
                    <span class="s1">facet_col_labels</span><span class="s0">,</span>
                    <span class="s1">trace_type</span><span class="s0">,</span>
                    <span class="s1">flipped_rows</span><span class="s0">,</span>
                    <span class="s1">flipped_cols</span><span class="s0">,</span>
                    <span class="s1">show_boxes</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s1">marker_color</span><span class="s0">,</span>
                    <span class="s1">kwargs_trace</span><span class="s0">,</span>
                    <span class="s1">kwargs_marker</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s0">elif </span><span class="s1">isinstance(colormap</span><span class="s0">, </span><span class="s1">str):</span>
                <span class="s0">if </span><span class="s1">colormap </span><span class="s0">in </span><span class="s1">clrs.PLOTLY_SCALES.keys():</span>
                    <span class="s1">colorscale_list = clrs.PLOTLY_SCALES[colormap]</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
                        <span class="s2">&quot;If 'colormap' is a string, it must be the name &quot;</span>
                        <span class="s2">&quot;of a Plotly Colorscale. The available colorscale &quot;</span>
                        <span class="s2">&quot;names are {}&quot;</span><span class="s1">.format(clrs.PLOTLY_SCALES.keys())</span>
                    <span class="s1">)</span>
                <span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations = _facet_grid_color_numerical(</span>
                    <span class="s1">df</span><span class="s0">,</span>
                    <span class="s1">x</span><span class="s0">,</span>
                    <span class="s1">y</span><span class="s0">,</span>
                    <span class="s1">facet_row</span><span class="s0">,</span>
                    <span class="s1">facet_col</span><span class="s0">,</span>
                    <span class="s1">color_name</span><span class="s0">,</span>
                    <span class="s1">colorscale_list</span><span class="s0">,</span>
                    <span class="s1">num_of_rows</span><span class="s0">,</span>
                    <span class="s1">num_of_cols</span><span class="s0">,</span>
                    <span class="s1">facet_row_labels</span><span class="s0">,</span>
                    <span class="s1">facet_col_labels</span><span class="s0">,</span>
                    <span class="s1">trace_type</span><span class="s0">,</span>
                    <span class="s1">flipped_rows</span><span class="s0">,</span>
                    <span class="s1">flipped_cols</span><span class="s0">,</span>
                    <span class="s1">show_boxes</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s1">marker_color</span><span class="s0">,</span>
                    <span class="s1">kwargs_trace</span><span class="s0">,</span>
                    <span class="s1">kwargs_marker</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">colorscale_list = clrs.PLOTLY_SCALES[</span><span class="s2">&quot;Reds&quot;</span><span class="s1">]</span>
                <span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations = _facet_grid_color_numerical(</span>
                    <span class="s1">df</span><span class="s0">,</span>
                    <span class="s1">x</span><span class="s0">,</span>
                    <span class="s1">y</span><span class="s0">,</span>
                    <span class="s1">facet_row</span><span class="s0">,</span>
                    <span class="s1">facet_col</span><span class="s0">,</span>
                    <span class="s1">color_name</span><span class="s0">,</span>
                    <span class="s1">colorscale_list</span><span class="s0">,</span>
                    <span class="s1">num_of_rows</span><span class="s0">,</span>
                    <span class="s1">num_of_cols</span><span class="s0">,</span>
                    <span class="s1">facet_row_labels</span><span class="s0">,</span>
                    <span class="s1">facet_col_labels</span><span class="s0">,</span>
                    <span class="s1">trace_type</span><span class="s0">,</span>
                    <span class="s1">flipped_rows</span><span class="s0">,</span>
                    <span class="s1">flipped_cols</span><span class="s0">,</span>
                    <span class="s1">show_boxes</span><span class="s0">,</span>
                    <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
                    <span class="s1">marker_color</span><span class="s0">,</span>
                    <span class="s1">kwargs_trace</span><span class="s0">,</span>
                    <span class="s1">kwargs_marker</span><span class="s0">,</span>
                <span class="s1">)</span>

    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">fig</span><span class="s0">, </span><span class="s1">annotations = _facet_grid(</span>
            <span class="s1">df</span><span class="s0">,</span>
            <span class="s1">x</span><span class="s0">,</span>
            <span class="s1">y</span><span class="s0">,</span>
            <span class="s1">facet_row</span><span class="s0">,</span>
            <span class="s1">facet_col</span><span class="s0">,</span>
            <span class="s1">num_of_rows</span><span class="s0">,</span>
            <span class="s1">num_of_cols</span><span class="s0">,</span>
            <span class="s1">facet_row_labels</span><span class="s0">,</span>
            <span class="s1">facet_col_labels</span><span class="s0">,</span>
            <span class="s1">trace_type</span><span class="s0">,</span>
            <span class="s1">flipped_rows</span><span class="s0">,</span>
            <span class="s1">flipped_cols</span><span class="s0">,</span>
            <span class="s1">show_boxes</span><span class="s0">,</span>
            <span class="s1">SUBPLOT_SPACING</span><span class="s0">,</span>
            <span class="s1">marker_color</span><span class="s0">,</span>
            <span class="s1">kwargs_trace</span><span class="s0">,</span>
            <span class="s1">kwargs_marker</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">if not </span><span class="s1">height:</span>
        <span class="s1">height = max(</span><span class="s3">600</span><span class="s0">, </span><span class="s3">100 </span><span class="s1">* num_of_rows)</span>
    <span class="s0">if not </span><span class="s1">width:</span>
        <span class="s1">width = max(</span><span class="s3">600</span><span class="s0">, </span><span class="s3">100 </span><span class="s1">* num_of_cols)</span>

    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">].update(</span>
        <span class="s1">height=height</span><span class="s0">, </span><span class="s1">width=width</span><span class="s0">, </span><span class="s1">title=</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s1">paper_bgcolor=</span><span class="s2">&quot;rgb(251, 251, 251)&quot;</span>
    <span class="s1">)</span>
    <span class="s0">if </span><span class="s1">ggplot2:</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">].update(</span>
            <span class="s1">plot_bgcolor=PLOT_BGCOLOR</span><span class="s0">,</span>
            <span class="s1">paper_bgcolor=</span><span class="s2">&quot;rgb(255, 255, 255)&quot;</span><span class="s0">,</span>
            <span class="s1">hovermode=</span><span class="s2">&quot;closest&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s5"># axis titles</span>
    <span class="s1">x_title_annot = _axis_title_annotation(x</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span>
    <span class="s1">y_title_annot = _axis_title_annotation(y</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">)</span>

    <span class="s5"># annotations</span>
    <span class="s1">annotations.append(x_title_annot)</span>
    <span class="s1">annotations.append(y_title_annot)</span>

    <span class="s5"># legend</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;showlegend&quot;</span><span class="s1">] = show_legend</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;legend&quot;</span><span class="s1">][</span><span class="s2">&quot;bgcolor&quot;</span><span class="s1">] = LEGEND_COLOR</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;legend&quot;</span><span class="s1">][</span><span class="s2">&quot;borderwidth&quot;</span><span class="s1">] = LEGEND_BORDER_WIDTH</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;legend&quot;</span><span class="s1">][</span><span class="s2">&quot;x&quot;</span><span class="s1">] = </span><span class="s3">1.05</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;legend&quot;</span><span class="s1">][</span><span class="s2">&quot;y&quot;</span><span class="s1">] = </span><span class="s3">1</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;legend&quot;</span><span class="s1">][</span><span class="s2">&quot;yanchor&quot;</span><span class="s1">] = </span><span class="s2">&quot;top&quot;</span>

    <span class="s0">if </span><span class="s1">show_legend:</span>
        <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;showlegend&quot;</span><span class="s1">] = show_legend</span>
        <span class="s0">if </span><span class="s1">ggplot2:</span>
            <span class="s0">if </span><span class="s1">color_name:</span>
                <span class="s1">legend_annot = _legend_annotation(color_name)</span>
                <span class="s1">annotations.append(legend_annot)</span>
            <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;margin&quot;</span><span class="s1">][</span><span class="s2">&quot;r&quot;</span><span class="s1">] = </span><span class="s3">150</span>

    <span class="s5"># assign annotations to figure</span>
    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][</span><span class="s2">&quot;annotations&quot;</span><span class="s1">] = annotations</span>

    <span class="s5"># add shaded boxes behind axis titles</span>
    <span class="s0">if </span><span class="s1">show_boxes </span><span class="s0">and </span><span class="s1">ggplot2:</span>
        <span class="s1">_add_shapes_to_fig(fig</span><span class="s0">, </span><span class="s1">ANNOT_RECT_COLOR</span><span class="s0">, </span><span class="s1">flipped_rows</span><span class="s0">, </span><span class="s1">flipped_cols)</span>

    <span class="s5"># all xaxis and yaxis labels</span>
    <span class="s1">axis_labels = {</span><span class="s2">&quot;x&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: []}</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">]:</span>
        <span class="s0">if </span><span class="s2">&quot;xaxis&quot; </span><span class="s0">in </span><span class="s1">key:</span>
            <span class="s1">axis_labels[</span><span class="s2">&quot;x&quot;</span><span class="s1">].append(key)</span>
        <span class="s0">elif </span><span class="s2">&quot;yaxis&quot; </span><span class="s0">in </span><span class="s1">key:</span>
            <span class="s1">axis_labels[</span><span class="s2">&quot;y&quot;</span><span class="s1">].append(key)</span>

    <span class="s1">string_number_in_data = </span><span class="s0">False</span>
    <span class="s0">for </span><span class="s1">var </span><span class="s0">in </span><span class="s1">[v </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">y] </span><span class="s0">if </span><span class="s1">v]:</span>
        <span class="s0">if </span><span class="s1">isinstance(df[var].tolist()[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">str):</span>
            <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">df[var]:</span>
                <span class="s0">try</span><span class="s1">:</span>
                    <span class="s1">int(item)</span>
                    <span class="s1">string_number_in_data = </span><span class="s0">True</span>
                <span class="s0">except </span><span class="s1">ValueError:</span>
                    <span class="s0">pass</span>

    <span class="s0">if </span><span class="s1">string_number_in_data:</span>
        <span class="s0">for </span><span class="s1">x_y </span><span class="s0">in </span><span class="s1">axis_labels.keys():</span>
            <span class="s0">for </span><span class="s1">axis_name </span><span class="s0">in </span><span class="s1">axis_labels[x_y]:</span>
                <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_name][</span><span class="s2">&quot;type&quot;</span><span class="s1">] = </span><span class="s2">&quot;category&quot;</span>

    <span class="s0">if </span><span class="s1">scales == </span><span class="s2">&quot;fixed&quot;</span><span class="s1">:</span>
        <span class="s1">fixed_axes = [</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">scales == </span><span class="s2">&quot;free_x&quot;</span><span class="s1">:</span>
        <span class="s1">fixed_axes = [</span><span class="s2">&quot;y&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">scales == </span><span class="s2">&quot;free_y&quot;</span><span class="s1">:</span>
        <span class="s1">fixed_axes = [</span><span class="s2">&quot;x&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">scales == </span><span class="s2">&quot;free&quot;</span><span class="s1">:</span>
        <span class="s1">fixed_axes = []</span>

    <span class="s5"># fixed ranges</span>
    <span class="s0">for </span><span class="s1">x_y </span><span class="s0">in </span><span class="s1">fixed_axes:</span>
        <span class="s1">min_ranges = []</span>
        <span class="s1">max_ranges = []</span>
        <span class="s0">for </span><span class="s1">trace </span><span class="s0">in </span><span class="s1">fig[</span><span class="s2">&quot;data&quot;</span><span class="s1">]:</span>
            <span class="s0">if </span><span class="s1">trace[x_y] </span><span class="s0">is not None and </span><span class="s1">len(trace[x_y]) &gt; </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s1">min_ranges.append(min(trace[x_y]))</span>
                <span class="s1">max_ranges.append(max(trace[x_y]))</span>
        <span class="s0">while None in </span><span class="s1">min_ranges:</span>
            <span class="s1">min_ranges.remove(</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">while None in </span><span class="s1">max_ranges:</span>
            <span class="s1">max_ranges.remove(</span><span class="s0">None</span><span class="s1">)</span>

        <span class="s1">min_range = min(min_ranges)</span>
        <span class="s1">max_range = max(max_ranges)</span>

        <span class="s1">range_are_numbers = isinstance(min_range</span><span class="s0">, </span><span class="s1">Number) </span><span class="s0">and </span><span class="s1">isinstance(</span>
            <span class="s1">max_range</span><span class="s0">, </span><span class="s1">Number</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">range_are_numbers:</span>
            <span class="s1">min_range = math.floor(min_range)</span>
            <span class="s1">max_range = math.ceil(max_range)</span>

            <span class="s5"># extend widen frame by 5% on each side</span>
            <span class="s1">min_range -= </span><span class="s3">0.05 </span><span class="s1">* (max_range - min_range)</span>
            <span class="s1">max_range += </span><span class="s3">0.05 </span><span class="s1">* (max_range - min_range)</span>

            <span class="s0">if </span><span class="s1">x_y == </span><span class="s2">&quot;x&quot;</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">dtick_x:</span>
                    <span class="s1">dtick = dtick_x</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">dtick = math.floor((max_range - min_range) / MAX_TICKS_PER_AXIS)</span>
            <span class="s0">elif </span><span class="s1">x_y == </span><span class="s2">&quot;y&quot;</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">dtick_y:</span>
                    <span class="s1">dtick = dtick_y</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">dtick = math.floor((max_range - min_range) / MAX_TICKS_PER_AXIS)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">dtick = </span><span class="s3">1</span>

        <span class="s0">for </span><span class="s1">axis_title </span><span class="s0">in </span><span class="s1">axis_labels[x_y]:</span>
            <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;dtick&quot;</span><span class="s1">] = dtick</span>
            <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;ticklen&quot;</span><span class="s1">] = </span><span class="s3">0</span>
            <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;zeroline&quot;</span><span class="s1">] = </span><span class="s0">False</span>
            <span class="s0">if </span><span class="s1">ggplot2:</span>
                <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;tickwidth&quot;</span><span class="s1">] = </span><span class="s3">1</span>
                <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;ticklen&quot;</span><span class="s1">] = </span><span class="s3">4</span>
                <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;gridwidth&quot;</span><span class="s1">] = GRID_WIDTH</span>

                <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;gridcolor&quot;</span><span class="s1">] = GRID_COLOR</span>
                <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;gridwidth&quot;</span><span class="s1">] = </span><span class="s3">2</span>
                <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][axis_title][</span><span class="s2">&quot;tickfont&quot;</span><span class="s1">] = {</span>
                    <span class="s2">&quot;color&quot;</span><span class="s1">: TICK_COLOR</span><span class="s0">,</span>
                    <span class="s2">&quot;size&quot;</span><span class="s1">: </span><span class="s3">10</span><span class="s0">,</span>
                <span class="s1">}</span>

        <span class="s5"># insert ranges into fig</span>
        <span class="s0">if </span><span class="s1">x_y </span><span class="s0">in </span><span class="s1">fixed_axes:</span>
            <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">]:</span>
                <span class="s0">if </span><span class="s2">&quot;{}axis&quot;</span><span class="s1">.format(x_y) </span><span class="s0">in </span><span class="s1">key </span><span class="s0">and </span><span class="s1">range_are_numbers:</span>
                    <span class="s1">fig[</span><span class="s2">&quot;layout&quot;</span><span class="s1">][key][</span><span class="s2">&quot;range&quot;</span><span class="s1">] = [min_range</span><span class="s0">, </span><span class="s1">max_range]</span>

    <span class="s0">return </span><span class="s1">fig</span>
</pre>
</body>
</html>