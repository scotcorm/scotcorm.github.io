<html>
<head>
<title>testing.pyx</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
testing.pyx</font>
</center></td></tr></table>
<pre><span class="s0">import cmath</span>
<span class="s0">import math</span>

<span class="s0">import numpy as np</span>

<span class="s0">from numpy cimport import_array</span>

<span class="s0">import_array()</span>

<span class="s0">from pandas._libs.util cimport (</span>
    <span class="s0">is_array,</span>
    <span class="s0">is_complex_object,</span>
    <span class="s0">is_real_number_object,</span>
<span class="s0">)</span>

<span class="s0">from pandas.core.dtypes.common import is_dtype_equal</span>
<span class="s0">from pandas.core.dtypes.missing import (</span>
    <span class="s0">array_equivalent,</span>
    <span class="s0">isna,</span>
<span class="s0">)</span>


<span class="s0">cdef bint isiterable(obj):</span>
    <span class="s0">return hasattr(obj, '__iter__')</span>


<span class="s0">cdef bint has_length(obj):</span>
    <span class="s0">return hasattr(obj, '__len__')</span>


<span class="s0">cdef bint is_dictlike(obj):</span>
    <span class="s0">return hasattr(obj, 'keys') and hasattr(obj, '__getitem__')</span>


<span class="s0">cpdef assert_dict_equal(a, b, bint compare_keys=True):</span>
    <span class="s0">assert is_dictlike(a) and is_dictlike(b), (</span>
        <span class="s0">&quot;Cannot compare dict objects, one or both is not dict-like&quot;</span>
    <span class="s0">)</span>

    <span class="s0">a_keys = frozenset(a.keys())</span>
    <span class="s0">b_keys = frozenset(b.keys())</span>

    <span class="s0">if compare_keys:</span>
        <span class="s0">assert a_keys == b_keys</span>

    <span class="s0">for k in a_keys:</span>
        <span class="s0">assert_almost_equal(a[k], b[k])</span>

    <span class="s0">return True</span>


<span class="s0">cpdef assert_almost_equal(a, b,</span>
                          <span class="s0">rtol=1.e-5, atol=1.e-8,</span>
                          <span class="s0">bint check_dtype=True,</span>
                          <span class="s0">obj=None, lobj=None, robj=None, index_values=None):</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Check that left and right objects are almost equal.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">a : object</span>
    <span class="s0">b : object</span>
    <span class="s0">rtol : float, default 1e-5</span>
        <span class="s0">Relative tolerance.</span>

        <span class="s0">.. versionadded:: 1.1.0</span>
    <span class="s0">atol : float, default 1e-8</span>
        <span class="s0">Absolute tolerance.</span>

        <span class="s0">.. versionadded:: 1.1.0</span>
    <span class="s0">check_dtype: bool, default True</span>
        <span class="s0">check dtype if both a and b are np.ndarray.</span>
    <span class="s0">obj : str, default None</span>
        <span class="s0">Specify object name being compared, internally used to show</span>
        <span class="s0">appropriate assertion message.</span>
    <span class="s0">lobj : str, default None</span>
        <span class="s0">Specify left object name being compared, internally used to show</span>
        <span class="s0">appropriate assertion message.</span>
    <span class="s0">robj : str, default None</span>
        <span class="s0">Specify right object name being compared, internally used to show</span>
        <span class="s0">appropriate assertion message.</span>
    <span class="s0">index_values : ndarray, default None</span>
        <span class="s0">Specify shared index values of objects being compared, internally used</span>
        <span class="s0">to show appropriate assertion message.</span>

        <span class="s0">.. versionadded:: 1.1.0</span>

    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">cdef:</span>
        <span class="s0">double diff = 0.0</span>
        <span class="s0">Py_ssize_t i, na, nb</span>
        <span class="s0">double fa, fb</span>
        <span class="s0">bint is_unequal = False, a_is_ndarray, b_is_ndarray</span>

    <span class="s0">if lobj is None:</span>
        <span class="s0">lobj = a</span>
    <span class="s0">if robj is None:</span>
        <span class="s0">robj = b</span>

    <span class="s0">if isinstance(a, dict) or isinstance(b, dict):</span>
        <span class="s0">return assert_dict_equal(a, b)</span>

    <span class="s0">if isinstance(a, str) or isinstance(b, str):</span>
        <span class="s0">assert a == b, f&quot;{a} != {b}&quot;</span>
        <span class="s0">return True</span>

    <span class="s0">a_is_ndarray = is_array(a)</span>
    <span class="s0">b_is_ndarray = is_array(b)</span>

    <span class="s0">if obj is None:</span>
        <span class="s0">if a_is_ndarray or b_is_ndarray:</span>
            <span class="s0">obj = 'numpy array'</span>
        <span class="s0">else:</span>
            <span class="s0">obj = 'Iterable'</span>

    <span class="s0">if isiterable(a):</span>

        <span class="s0">if not isiterable(b):</span>
            <span class="s0">from pandas._testing import assert_class_equal</span>

            <span class="s0"># classes can't be the same, to raise error</span>
            <span class="s0">assert_class_equal(a, b, obj=obj)</span>

        <span class="s0">assert has_length(a) and has_length(b), (</span>
            <span class="s0">f&quot;Can't compare objects without length, one or both is invalid: ({a}, {b})&quot;</span>
        <span class="s0">)</span>

        <span class="s0">if a_is_ndarray and b_is_ndarray:</span>
            <span class="s0">na, nb = a.size, b.size</span>
            <span class="s0">if a.shape != b.shape:</span>
                <span class="s0">from pandas._testing import raise_assert_detail</span>
                <span class="s0">raise_assert_detail(</span>
                    <span class="s0">obj, f'{obj} shapes are different', a.shape, b.shape)</span>

            <span class="s0">if check_dtype and not is_dtype_equal(a.dtype, b.dtype):</span>
                <span class="s0">from pandas._testing import assert_attr_equal</span>
                <span class="s0">assert_attr_equal('dtype', a, b, obj=obj)</span>

            <span class="s0">if array_equivalent(a, b, strict_nan=True):</span>
                <span class="s0">return True</span>

        <span class="s0">else:</span>
            <span class="s0">na, nb = len(a), len(b)</span>

        <span class="s0">if na != nb:</span>
            <span class="s0">from pandas._testing import raise_assert_detail</span>

            <span class="s0"># if we have a small diff set, print it</span>
            <span class="s0">if abs(na - nb) &lt; 10:</span>
                <span class="s0">r = list(set(a) ^ set(b))</span>
            <span class="s0">else:</span>
                <span class="s0">r = None</span>

            <span class="s0">raise_assert_detail(obj, f&quot;{obj} length are different&quot;, na, nb, r)</span>

        <span class="s0">for i in range(len(a)):</span>
            <span class="s0">try:</span>
                <span class="s0">assert_almost_equal(a[i], b[i], rtol=rtol, atol=atol)</span>
            <span class="s0">except AssertionError:</span>
                <span class="s0">is_unequal = True</span>
                <span class="s0">diff += 1</span>

        <span class="s0">if is_unequal:</span>
            <span class="s0">from pandas._testing import raise_assert_detail</span>
            <span class="s0">msg = (f&quot;{obj} values are different &quot;</span>
                   <span class="s0">f&quot;({np.round(diff * 100.0 / na, 5)} %)&quot;)</span>
            <span class="s0">raise_assert_detail(obj, msg, lobj, robj, index_values=index_values)</span>

        <span class="s0">return True</span>

    <span class="s0">elif isiterable(b):</span>
        <span class="s0">from pandas._testing import assert_class_equal</span>

        <span class="s0"># classes can't be the same, to raise error</span>
        <span class="s0">assert_class_equal(a, b, obj=obj)</span>

    <span class="s0">if isna(a) and isna(b):</span>
        <span class="s0"># TODO: Should require same-dtype NA?</span>
        <span class="s0"># nan / None comparison</span>
        <span class="s0">return True</span>

    <span class="s0">if a == b:</span>
        <span class="s0"># object comparison</span>
        <span class="s0">return True</span>

    <span class="s0">if is_real_number_object(a) and is_real_number_object(b):</span>
        <span class="s0">if array_equivalent(a, b, strict_nan=True):</span>
            <span class="s0"># inf comparison</span>
            <span class="s0">return True</span>

        <span class="s0">fa, fb = a, b</span>

        <span class="s0">if not math.isclose(fa, fb, rel_tol=rtol, abs_tol=atol):</span>
            <span class="s0">assert False, (f&quot;expected {fb:.5f} but got {fa:.5f}, &quot;</span>
                           <span class="s0">f&quot;with rtol={rtol}, atol={atol}&quot;)</span>
        <span class="s0">return True</span>

    <span class="s0">if is_complex_object(a) and is_complex_object(b):</span>
        <span class="s0">if array_equivalent(a, b, strict_nan=True):</span>
            <span class="s0"># inf comparison</span>
            <span class="s0">return True</span>

        <span class="s0">if not cmath.isclose(a, b, rel_tol=rtol, abs_tol=atol):</span>
            <span class="s0">assert False, (f&quot;expected {b:.5f} but got {a:.5f}, &quot;</span>
                           <span class="s0">f&quot;with rtol={rtol}, atol={atol}&quot;)</span>
        <span class="s0">return True</span>

    <span class="s0">raise AssertionError(f&quot;{a} != {b}&quot;)</span>
</pre>
</body>
</html>