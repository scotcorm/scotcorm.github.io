<html>
<head>
<title>_kaleido.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_kaleido.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span>
<span class="s0">from </span><span class="s1">six </span><span class="s0">import </span><span class="s1">string_types</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">json</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">plotly</span>
<span class="s0">from </span><span class="s1">plotly.io._utils </span><span class="s0">import </span><span class="s1">validate_coerce_fig_to_dict</span>

<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">from </span><span class="s1">kaleido.scopes.plotly </span><span class="s0">import </span><span class="s1">PlotlyScope</span>

    <span class="s1">scope = PlotlyScope()</span>

    <span class="s2"># Compute absolute path to the 'plotly/package_data/' directory</span>
    <span class="s1">root_dir = os.path.dirname(os.path.abspath(plotly.__file__))</span>
    <span class="s1">package_dir = os.path.join(root_dir</span><span class="s0">, </span><span class="s3">&quot;package_data&quot;</span><span class="s1">)</span>
    <span class="s1">scope.plotlyjs = os.path.join(package_dir</span><span class="s0">, </span><span class="s3">&quot;plotly.min.js&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">scope.mathjax </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">scope.mathjax = (</span>
            <span class="s3">&quot;https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js&quot;</span>
        <span class="s1">)</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s1">PlotlyScope = </span><span class="s0">None</span>
    <span class="s1">scope = </span><span class="s0">None</span>


<span class="s0">def </span><span class="s1">to_image(</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">format=</span><span class="s0">None, </span><span class="s1">width=</span><span class="s0">None, </span><span class="s1">height=</span><span class="s0">None, </span><span class="s1">scale=</span><span class="s0">None, </span><span class="s1">validate=</span><span class="s0">True, </span><span class="s1">engine=</span><span class="s3">&quot;auto&quot;</span>
<span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Convert a figure to a static image bytes string 
 
    Parameters 
    ---------- 
    fig: 
        Figure object or dict representing a figure 
 
    format: str or None 
        The desired image format. One of 
          - 'png' 
          - 'jpg' or 'jpeg' 
          - 'webp' 
          - 'svg' 
          - 'pdf' 
          - 'eps' (Requires the poppler library to be installed and on the PATH) 
 
        If not specified, will default to: 
             - `plotly.io.kaleido.scope.default_format` if engine is &quot;kaleido&quot; 
             - `plotly.io.orca.config.default_format` if engine is &quot;orca&quot; 
 
    width: int or None 
        The width of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the width of the exported image 
        in physical pixels. 
 
        If not specified, will default to: 
             - `plotly.io.kaleido.scope.default_width` if engine is &quot;kaleido&quot; 
             - `plotly.io.orca.config.default_width` if engine is &quot;orca&quot; 
 
    height: int or None 
        The height of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the height of the exported image 
        in physical pixels. 
 
        If not specified, will default to: 
             - `plotly.io.kaleido.scope.default_height` if engine is &quot;kaleido&quot; 
             - `plotly.io.orca.config.default_height` if engine is &quot;orca&quot; 
 
    scale: int or float or None 
        The scale factor to use when exporting the figure. A scale factor 
        larger than 1.0 will increase the image resolution with respect 
        to the figure's layout pixel dimensions. Whereas as scale factor of 
        less than 1.0 will decrease the image resolution. 
 
        If not specified, will default to: 
             - `plotly.io.kaleido.scope.default_scale` if engine is &quot;kaleido&quot; 
             - `plotly.io.orca.config.default_scale` if engine is &quot;orca&quot; 
 
 
    validate: bool 
        True if the figure should be validated before being converted to 
        an image, False otherwise. 
 
    engine: str 
        Image export engine to use: 
         - &quot;kaleido&quot;: Use Kaleido for image export 
         - &quot;orca&quot;: Use Orca for image export 
         - &quot;auto&quot; (default): Use Kaleido if installed, otherwise use orca 
 
    Returns 
    ------- 
    bytes 
        The image data 
    &quot;&quot;&quot;</span>
    <span class="s2"># Handle engine</span>
    <span class="s2"># -------------</span>
    <span class="s0">if </span><span class="s1">engine == </span><span class="s3">&quot;auto&quot;</span><span class="s1">:</span>
        <span class="s0">if </span><span class="s1">scope </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s2"># Default to kaleido if available</span>
            <span class="s1">engine = </span><span class="s3">&quot;kaleido&quot;</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s2"># See if orca is available</span>
            <span class="s0">from </span><span class="s1">._orca </span><span class="s0">import </span><span class="s1">validate_executable</span>

            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">validate_executable()</span>
                <span class="s1">engine = </span><span class="s3">&quot;orca&quot;</span>
            <span class="s0">except</span><span class="s1">:</span>
                <span class="s2"># If orca not configured properly, make sure we display the error</span>
                <span class="s2"># message advising the installation of kaleido</span>
                <span class="s1">engine = </span><span class="s3">&quot;kaleido&quot;</span>

    <span class="s0">if </span><span class="s1">engine == </span><span class="s3">&quot;orca&quot;</span><span class="s1">:</span>
        <span class="s2"># Fall back to legacy orca image export path</span>
        <span class="s0">from </span><span class="s1">._orca </span><span class="s0">import </span><span class="s1">to_image </span><span class="s0">as </span><span class="s1">to_image_orca</span>

        <span class="s0">return </span><span class="s1">to_image_orca(</span>
            <span class="s1">fig</span><span class="s0">,</span>
            <span class="s1">format=format</span><span class="s0">,</span>
            <span class="s1">width=width</span><span class="s0">,</span>
            <span class="s1">height=height</span><span class="s0">,</span>
            <span class="s1">scale=scale</span><span class="s0">,</span>
            <span class="s1">validate=validate</span><span class="s0">,</span>
        <span class="s1">)</span>
    <span class="s0">elif </span><span class="s1">engine != </span><span class="s3">&quot;kaleido&quot;</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s3">&quot;Invalid image export engine specified: {engine}&quot;</span><span class="s1">.format(</span>
                <span class="s1">engine=repr(engine)</span>
            <span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s2"># Raise informative error message if Kaleido is not installed</span>
    <span class="s0">if </span><span class="s1">scope </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s3">&quot;&quot;&quot; 
Image export using the &quot;kaleido&quot; engine requires the kaleido package, 
which can be installed using pip: 
    $ pip install -U kaleido 
&quot;&quot;&quot;</span>
        <span class="s1">)</span>

    <span class="s2"># Validate figure</span>
    <span class="s2"># ---------------</span>
    <span class="s1">fig_dict = validate_coerce_fig_to_dict(fig</span><span class="s0">, </span><span class="s1">validate)</span>
    <span class="s1">img_bytes = scope.transform(</span>
        <span class="s1">fig_dict</span><span class="s0">, </span><span class="s1">format=format</span><span class="s0">, </span><span class="s1">width=width</span><span class="s0">, </span><span class="s1">height=height</span><span class="s0">, </span><span class="s1">scale=scale</span>
    <span class="s1">)</span>

    <span class="s0">return </span><span class="s1">img_bytes</span>


<span class="s0">def </span><span class="s1">write_image(</span>
    <span class="s1">fig</span><span class="s0">,</span>
    <span class="s1">file</span><span class="s0">,</span>
    <span class="s1">format=</span><span class="s0">None,</span>
    <span class="s1">scale=</span><span class="s0">None,</span>
    <span class="s1">width=</span><span class="s0">None,</span>
    <span class="s1">height=</span><span class="s0">None,</span>
    <span class="s1">validate=</span><span class="s0">True,</span>
    <span class="s1">engine=</span><span class="s3">&quot;auto&quot;</span><span class="s0">,</span>
<span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Convert a figure to a static image and write it to a file or writeable 
    object 
 
    Parameters 
    ---------- 
    fig: 
        Figure object or dict representing a figure 
 
    file: str or writeable 
        A string representing a local file path or a writeable object 
        (e.g. a pathlib.Path object or an open file descriptor) 
 
    format: str or None 
        The desired image format. One of 
          - 'png' 
          - 'jpg' or 'jpeg' 
          - 'webp' 
          - 'svg' 
          - 'pdf' 
          - 'eps' (Requires the poppler library to be installed and on the PATH) 
 
        If not specified and `file` is a string then this will default to the 
        file extension. If not specified and `file` is not a string then this 
        will default to: 
            - `plotly.io.kaleido.scope.default_format` if engine is &quot;kaleido&quot; 
            - `plotly.io.orca.config.default_format` if engine is &quot;orca&quot; 
 
    width: int or None 
        The width of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the width of the exported image 
        in physical pixels. 
 
        If not specified, will default to: 
            - `plotly.io.kaleido.scope.default_width` if engine is &quot;kaleido&quot; 
            - `plotly.io.orca.config.default_width` if engine is &quot;orca&quot; 
 
    height: int or None 
        The height of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the height of the exported image 
        in physical pixels. 
 
        If not specified, will default to: 
            - `plotly.io.kaleido.scope.default_height` if engine is &quot;kaleido&quot; 
            - `plotly.io.orca.config.default_height` if engine is &quot;orca&quot; 
 
    scale: int or float or None 
        The scale factor to use when exporting the figure. A scale factor 
        larger than 1.0 will increase the image resolution with respect 
        to the figure's layout pixel dimensions. Whereas as scale factor of 
        less than 1.0 will decrease the image resolution. 
 
        If not specified, will default to: 
            - `plotly.io.kaleido.scope.default_scale` if engine is &quot;kaleido&quot; 
            - `plotly.io.orca.config.default_scale` if engine is &quot;orca&quot; 
 
    validate: bool 
        True if the figure should be validated before being converted to 
        an image, False otherwise. 
 
    engine: str 
        Image export engine to use: 
         - &quot;kaleido&quot;: Use Kaleido for image export 
         - &quot;orca&quot;: Use Orca for image export 
         - &quot;auto&quot; (default): Use Kaleido if installed, otherwise use orca 
 
    Returns 
    ------- 
    None 
    &quot;&quot;&quot;</span>
    <span class="s2"># Try to cast `file` as a pathlib object `path`.</span>
    <span class="s2"># ----------------------------------------------</span>
    <span class="s0">if </span><span class="s1">isinstance(file</span><span class="s0">, </span><span class="s1">string_types):</span>
        <span class="s2"># Use the standard Path constructor to make a pathlib object.</span>
        <span class="s1">path = Path(file)</span>
    <span class="s0">elif </span><span class="s1">isinstance(file</span><span class="s0">, </span><span class="s1">Path):</span>
        <span class="s2"># `file` is already a Path object.</span>
        <span class="s1">path = file</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s2"># We could not make a Path object out of file. Either `file` is an open file</span>
        <span class="s2"># descriptor with a `write()` method or it's an invalid object.</span>
        <span class="s1">path = </span><span class="s0">None</span>

    <span class="s2"># Infer format if not specified</span>
    <span class="s2"># -----------------------------</span>
    <span class="s0">if </span><span class="s1">path </span><span class="s0">is not None and </span><span class="s1">format </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">ext = path.suffix</span>
        <span class="s0">if </span><span class="s1">ext:</span>
            <span class="s1">format = ext.lstrip(</span><span class="s3">&quot;.&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s3">&quot;&quot;&quot; 
Cannot infer image type from output path '{file}'. 
Please add a file extension or specify the type using the format parameter. 
For example: 
 
    &gt;&gt;&gt; import plotly.io as pio 
    &gt;&gt;&gt; pio.write_image(fig, file_path, format='png') 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">file=file</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s2"># Request image</span>
    <span class="s2"># -------------</span>
    <span class="s2"># Do this first so we don't create a file if image conversion fails</span>
    <span class="s1">img_data = to_image(</span>
        <span class="s1">fig</span><span class="s0">,</span>
        <span class="s1">format=format</span><span class="s0">,</span>
        <span class="s1">scale=scale</span><span class="s0">,</span>
        <span class="s1">width=width</span><span class="s0">,</span>
        <span class="s1">height=height</span><span class="s0">,</span>
        <span class="s1">validate=validate</span><span class="s0">,</span>
        <span class="s1">engine=engine</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Open file</span>
    <span class="s2"># ---------</span>
    <span class="s0">if </span><span class="s1">path </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s2"># We previously failed to make sense of `file` as a pathlib object.</span>
        <span class="s2"># Attempt to write to `file` as an open file descriptor.</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">file.write(img_data)</span>
            <span class="s0">return</span>
        <span class="s0">except </span><span class="s1">AttributeError:</span>
            <span class="s0">pass</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s3">&quot;&quot;&quot; 
The 'file' argument '{file}' is not a string, pathlib.Path object, or file descriptor. 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">file=file</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s2"># We previously succeeded in interpreting `file` as a pathlib object.</span>
        <span class="s2"># Now we can use `write_bytes()`.</span>
        <span class="s1">path.write_bytes(img_data)</span>


<span class="s0">def </span><span class="s1">full_figure_for_development(fig</span><span class="s0">, </span><span class="s1">warn=</span><span class="s0">True, </span><span class="s1">as_dict=</span><span class="s0">False</span><span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Compute default values for all attributes not specified in the input figure and 
    returns the output as a &quot;full&quot; figure. This function calls Plotly.js via Kaleido 
    to populate unspecified attributes. This function is intended for interactive use 
    during development to learn more about how Plotly.js computes default values and is 
    not generally necessary or recommended for production use. 
 
    Parameters 
    ---------- 
    fig: 
        Figure object or dict representing a figure 
 
    warn: bool 
        If False, suppress warnings about not using this in production. 
 
    as_dict: bool 
        If True, output is a dict with some keys that go.Figure can't parse. 
        If False, output is a go.Figure with unparseable keys skipped. 
 
    Returns 
    ------- 
    plotly.graph_objects.Figure or dict 
        The full figure 
    &quot;&quot;&quot;</span>

    <span class="s2"># Raise informative error message if Kaleido is not installed</span>
    <span class="s0">if </span><span class="s1">scope </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s3">&quot;&quot;&quot; 
Full figure generation requires the kaleido package, 
which can be installed using pip: 
    $ pip install -U kaleido 
&quot;&quot;&quot;</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">warn:</span>
        <span class="s0">import </span><span class="s1">warnings</span>

        <span class="s1">warnings.warn(</span>
            <span class="s3">&quot;full_figure_for_development is not recommended or necessary for &quot;</span>
            <span class="s3">&quot;production use in most circumstances. </span><span class="s0">\n</span><span class="s3">&quot;</span>
            <span class="s3">&quot;To suppress this warning, set warn=False&quot;</span>
        <span class="s1">)</span>

    <span class="s1">fig = json.loads(scope.transform(fig</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;json&quot;</span><span class="s1">).decode(</span><span class="s3">&quot;utf-8&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">as_dict:</span>
        <span class="s0">return </span><span class="s1">fig</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">import </span><span class="s1">plotly.graph_objects </span><span class="s0">as </span><span class="s1">go</span>

        <span class="s0">return </span><span class="s1">go.Figure(fig</span><span class="s0">, </span><span class="s1">skip_invalid=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">__all__ = [</span><span class="s3">&quot;to_image&quot;</span><span class="s0">, </span><span class="s3">&quot;write_image&quot;</span><span class="s0">, </span><span class="s3">&quot;scope&quot;</span><span class="s0">, </span><span class="s3">&quot;full_figure_for_development&quot;</span><span class="s1">]</span>
</pre>
</body>
</html>