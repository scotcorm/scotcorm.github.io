<html>
<head>
<title>setitem.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
setitem.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.core.dtypes.dtypes </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DatetimeTZDtype</span><span class="s0">,</span>
    <span class="s1">IntervalDtype</span><span class="s0">,</span>
    <span class="s1">PandasDtype</span><span class="s0">,</span>
    <span class="s1">PeriodDtype</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.tests.extension.base.base </span><span class="s0">import </span><span class="s1">BaseExtensionTests</span>


<span class="s0">class </span><span class="s1">BaseSetitemTests(BaseExtensionTests):</span>
    <span class="s1">@pytest.fixture(</span>
        <span class="s1">params=[</span>
            <span class="s0">lambda </span><span class="s1">x: x.index</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: list(x.index)</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: slice(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">len(x))</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: range(len(x))</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: list(range(len(x)))</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x: np.ones(len(x)</span><span class="s0">, </span><span class="s1">dtype=bool)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">ids=[</span>
            <span class="s3">&quot;index&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;list[index]&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;null_slice&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;full_slice&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;range&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;list(range)&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;mask&quot;</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">full_indexer(self</span><span class="s0">, </span><span class="s1">request):</span>
        <span class="s4">&quot;&quot;&quot; 
        Fixture for an indexer to pass to obj.loc to get/set the full length of the 
        object. 
 
        In some cases, assumes that obj.index is the default RangeIndex. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">request.param</span>

    <span class="s0">def </span><span class="s1">test_setitem_scalar_series(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">data = pd.Series(data)</span>
        <span class="s1">data[</span><span class="s2">0</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">data[</span><span class="s2">0</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_sequence(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">data = pd.Series(data)</span>
        <span class="s1">original = data.copy()</span>

        <span class="s1">data[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]] = [data[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">data[</span><span class="s2">0</span><span class="s1">]]</span>
        <span class="s0">assert </span><span class="s1">data[</span><span class="s2">0</span><span class="s1">] == original[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">data[</span><span class="s2">1</span><span class="s1">] == original[</span><span class="s2">0</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_sequence_mismatched_length_raises(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">as_array):</span>
        <span class="s1">ser = pd.Series(data)</span>
        <span class="s1">original = ser.copy()</span>
        <span class="s1">value = [data[</span><span class="s2">0</span><span class="s1">]]</span>
        <span class="s0">if </span><span class="s1">as_array:</span>
            <span class="s1">value = data._from_sequence(value)</span>

        <span class="s1">xpr = </span><span class="s3">&quot;cannot set using a {} indexer with a different length&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=xpr.format(</span><span class="s3">&quot;list-like&quot;</span><span class="s1">)):</span>
            <span class="s1">ser[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]] = value</span>
        <span class="s5"># Ensure no modifications made before the exception</span>
        <span class="s1">self.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">original)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=xpr.format(</span><span class="s3">&quot;slice&quot;</span><span class="s1">)):</span>
            <span class="s1">ser[slice(</span><span class="s2">3</span><span class="s1">)] = value</span>
        <span class="s1">self.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">original)</span>

    <span class="s0">def </span><span class="s1">test_setitem_empty_indexer(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">data = pd.Series(data)</span>
        <span class="s1">original = data.copy()</span>
        <span class="s1">data[np.array([]</span><span class="s0">, </span><span class="s1">dtype=int)] = []</span>
        <span class="s1">self.assert_equal(data</span><span class="s0">, </span><span class="s1">original)</span>

    <span class="s0">def </span><span class="s1">test_setitem_sequence_broadcasts(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">data = pd.Series(data)</span>
        <span class="s1">data[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]] = data[</span><span class="s2">2</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">data[</span><span class="s2">0</span><span class="s1">] == data[</span><span class="s2">2</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">data[</span><span class="s2">1</span><span class="s1">] == data[</span><span class="s2">2</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;setter&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;loc&quot;</span><span class="s0">, </span><span class="s3">&quot;iloc&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_setitem_scalar(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">setter):</span>
        <span class="s1">arr = pd.Series(data)</span>
        <span class="s1">setter = getattr(arr</span><span class="s0">, </span><span class="s1">setter)</span>
        <span class="s1">setter[</span><span class="s2">0</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">arr[</span><span class="s2">0</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_loc_scalar_mixed(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: np.arange(len(data))</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">df.loc[</span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_loc_scalar_single(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">df.loc[</span><span class="s2">10</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s2">10</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_loc_scalar_multiple_homogoneous(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: data</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">df.loc[</span><span class="s2">10</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s2">10</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_iloc_scalar_mixed(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: np.arange(len(data))</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">df.iloc[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s2">0</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_iloc_scalar_single(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">df.iloc[</span><span class="s2">10</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s2">10</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_iloc_scalar_multiple_homogoneous(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: data</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">df.iloc[</span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s2">10</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;mask&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">np.array([</span><span class="s0">True, True, True, False, False</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">pd.array([</span><span class="s0">True, True, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;boolean&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">pd.array([</span><span class="s0">True, True, True, </span><span class="s1">pd.NA</span><span class="s0">, </span><span class="s1">pd.NA]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;boolean&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">ids=[</span><span class="s3">&quot;numpy-array&quot;</span><span class="s0">, </span><span class="s3">&quot;boolean-array&quot;</span><span class="s0">, </span><span class="s3">&quot;boolean-array-na&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_setitem_mask(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">mask</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s1">arr = data[:</span><span class="s2">5</span><span class="s1">].copy()</span>
        <span class="s1">expected = arr.take([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">arr = pd.Series(arr)</span>
            <span class="s1">expected = pd.Series(expected)</span>
        <span class="s1">arr[mask] = data[</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">self.assert_equal(expected</span><span class="s0">, </span><span class="s1">arr)</span>

    <span class="s0">def </span><span class="s1">test_setitem_mask_raises(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s5"># wrong length</span>
        <span class="s1">mask = np.array([</span><span class="s0">True, False</span><span class="s1">])</span>

        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">data = pd.Series(data)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;wrong length&quot;</span><span class="s1">):</span>
            <span class="s1">data[mask] = data[</span><span class="s2">0</span><span class="s1">]</span>

        <span class="s1">mask = pd.array(mask</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;boolean&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;wrong length&quot;</span><span class="s1">):</span>
            <span class="s1">data[mask] = data[</span><span class="s2">0</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_mask_boolean_array_with_na(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s1">mask = pd.array(np.zeros(data.shape</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;bool&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;boolean&quot;</span><span class="s1">)</span>
        <span class="s1">mask[:</span><span class="s2">3</span><span class="s1">] = </span><span class="s0">True</span>
        <span class="s1">mask[</span><span class="s2">3</span><span class="s1">:</span><span class="s2">5</span><span class="s1">] = pd.NA</span>

        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">data = pd.Series(data)</span>

        <span class="s1">data[mask] = data[</span><span class="s2">0</span><span class="s1">]</span>

        <span class="s0">assert </span><span class="s1">(data[:</span><span class="s2">3</span><span class="s1">] == data[</span><span class="s2">0</span><span class="s1">]).all()</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;idx&quot;</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">pd.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])]</span><span class="s0">,</span>
        <span class="s1">ids=[</span><span class="s3">&quot;list&quot;</span><span class="s0">, </span><span class="s3">&quot;integer-array&quot;</span><span class="s0">, </span><span class="s3">&quot;numpy-array&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_setitem_integer_array(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s1">arr = data[:</span><span class="s2">5</span><span class="s1">].copy()</span>
        <span class="s1">expected = data.take([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>

        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">arr = pd.Series(arr)</span>
            <span class="s1">expected = pd.Series(expected)</span>

        <span class="s1">arr[idx] = arr[</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">self.assert_equal(arr</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;idx, box_in_series&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">pd.NA]</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">pytest.param(</span>
                <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">pd.NA]</span><span class="s0">, True, </span><span class="s1">marks=pytest.mark.xfail(reason=</span><span class="s3">&quot;GH-31948&quot;</span><span class="s1">)</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(pd.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">pd.NA]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(pd.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">pd.NA]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">ids=[</span><span class="s3">&quot;list-False&quot;</span><span class="s0">, </span><span class="s3">&quot;list-True&quot;</span><span class="s0">, </span><span class="s3">&quot;integer-array-False&quot;</span><span class="s0">, </span><span class="s3">&quot;integer-array-True&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_setitem_integer_with_missing_raises(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s1">arr = data.copy()</span>

        <span class="s5"># TODO(xfail) this raises KeyError about labels not found (it tries label-based)</span>
        <span class="s5"># for list of labels with Series</span>
        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">arr = pd.Series(data</span><span class="s0">, </span><span class="s1">index=[tm.rands(</span><span class="s2">4</span><span class="s1">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(len(data))])</span>

        <span class="s1">msg = </span><span class="s3">&quot;Cannot index with an integer indexer containing NA values&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">arr[idx] = arr[</span><span class="s2">0</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;as_callable&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;setter&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;loc&quot;</span><span class="s0">, None</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_setitem_mask_aligned(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">as_callable</span><span class="s0">, </span><span class="s1">setter):</span>
        <span class="s1">ser = pd.Series(data)</span>
        <span class="s1">mask = np.zeros(len(data)</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">mask[:</span><span class="s2">2</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">as_callable:</span>
            <span class="s1">mask2 = </span><span class="s0">lambda </span><span class="s1">x: mask</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">mask2 = mask</span>

        <span class="s0">if </span><span class="s1">setter:</span>
            <span class="s5"># loc</span>
            <span class="s1">target = getattr(ser</span><span class="s0">, </span><span class="s1">setter)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s5"># Series.__setitem__</span>
            <span class="s1">target = ser</span>

        <span class="s1">target[mask2] = data[</span><span class="s2">5</span><span class="s1">:</span><span class="s2">7</span><span class="s1">]</span>

        <span class="s1">ser[mask2] = data[</span><span class="s2">5</span><span class="s1">:</span><span class="s2">7</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">ser[</span><span class="s2">0</span><span class="s1">] == data[</span><span class="s2">5</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">ser[</span><span class="s2">1</span><span class="s1">] == data[</span><span class="s2">6</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;setter&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;loc&quot;</span><span class="s0">, None</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_setitem_mask_broadcast(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">setter):</span>
        <span class="s1">ser = pd.Series(data)</span>
        <span class="s1">mask = np.zeros(len(data)</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">mask[:</span><span class="s2">2</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">setter:  </span><span class="s5"># loc</span>
            <span class="s1">target = getattr(ser</span><span class="s0">, </span><span class="s1">setter)</span>
        <span class="s0">else</span><span class="s1">:  </span><span class="s5"># __setitem__</span>
            <span class="s1">target = ser</span>

        <span class="s1">target[mask] = data[</span><span class="s2">10</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">ser[</span><span class="s2">0</span><span class="s1">] == data[</span><span class="s2">10</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">ser[</span><span class="s2">1</span><span class="s1">] == data[</span><span class="s2">10</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_expand_columns(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: data})</span>
        <span class="s1">result = df.copy()</span>
        <span class="s1">result[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">expected = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: data</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">] * len(data)})</span>
        <span class="s1">self.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.copy()</span>
        <span class="s1">result.loc[:</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">self.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s5"># overwrite with new type</span>
        <span class="s1">result[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = data</span>
        <span class="s1">expected = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: data</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">self.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_expand_with_extension(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">] * len(data)})</span>
        <span class="s1">result = df.copy()</span>
        <span class="s1">result[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = data</span>
        <span class="s1">expected = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">] * len(data)</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: data})</span>
        <span class="s1">self.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.copy()</span>
        <span class="s1">result.loc[:</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = data</span>
        <span class="s1">self.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_frame_invalid_length(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">] * len(data)})</span>
        <span class="s1">xpr = (</span>
            <span class="s3">rf&quot;Length of values \(</span><span class="s0">{</span><span class="s1">len(data[:</span><span class="s2">5</span><span class="s1">])</span><span class="s0">}</span><span class="s3">\) &quot;</span>
            <span class="s3">rf&quot;does not match length of index \(</span><span class="s0">{</span><span class="s1">len(df)</span><span class="s0">}</span><span class="s3">\)&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=xpr):</span>
            <span class="s1">df[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = data[:</span><span class="s2">5</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_tuple_index(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">ser = pd.Series(data[:</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)])</span>
        <span class="s1">expected = pd.Series(data.take([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">index=ser.index)</span>
        <span class="s1">ser[(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">self.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_slice(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">box_in_series):</span>
        <span class="s1">arr = data[:</span><span class="s2">5</span><span class="s1">].copy()</span>
        <span class="s1">expected = data.take([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s0">if </span><span class="s1">box_in_series:</span>
            <span class="s1">arr = pd.Series(arr)</span>
            <span class="s1">expected = pd.Series(expected)</span>

        <span class="s1">arr[:</span><span class="s2">3</span><span class="s1">] = data[</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">self.assert_equal(arr</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_loc_iloc_slice(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">arr = data[:</span><span class="s2">5</span><span class="s1">].copy()</span>
        <span class="s1">s = pd.Series(arr</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">])</span>
        <span class="s1">expected = pd.Series(data.take([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span><span class="s0">, </span><span class="s1">index=s.index)</span>

        <span class="s1">result = s.copy()</span>
        <span class="s1">result.iloc[:</span><span class="s2">3</span><span class="s1">] = data[</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">self.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = s.copy()</span>
        <span class="s1">result.loc[:</span><span class="s3">&quot;c&quot;</span><span class="s1">] = data[</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">self.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_slice_mismatch_length_raises(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">arr = data[:</span><span class="s2">5</span><span class="s1">]</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">arr[:</span><span class="s2">1</span><span class="s1">] = arr[:</span><span class="s2">2</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_slice_array(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">arr = data[:</span><span class="s2">5</span><span class="s1">].copy()</span>
        <span class="s1">arr[:</span><span class="s2">5</span><span class="s1">] = data[-</span><span class="s2">5</span><span class="s1">:]</span>
        <span class="s1">self.assert_extension_array_equal(arr</span><span class="s0">, </span><span class="s1">data[-</span><span class="s2">5</span><span class="s1">:])</span>

    <span class="s0">def </span><span class="s1">test_setitem_scalar_key_sequence_raise(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s1">arr = data[:</span><span class="s2">5</span><span class="s1">].copy()</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">arr[</span><span class="s2">0</span><span class="s1">] = arr[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span>

    <span class="s0">def </span><span class="s1">test_setitem_preserves_views(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s5"># GH#28150 setitem shouldn't swap the underlying data</span>
        <span class="s1">view1 = data.view()</span>
        <span class="s1">view2 = data[:]</span>

        <span class="s1">data[</span><span class="s2">0</span><span class="s1">] = data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">view1[</span><span class="s2">0</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">view2[</span><span class="s2">0</span><span class="s1">] == data[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_setitem_with_expansion_dataframe_column(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">full_indexer):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/32395</span>
        <span class="s1">df = expected = pd.DataFrame({</span><span class="s3">&quot;data&quot;</span><span class="s1">: pd.Series(data)})</span>
        <span class="s1">result = pd.DataFrame(index=df.index)</span>

        <span class="s1">key = full_indexer(df)</span>
        <span class="s1">result.loc[key</span><span class="s0">, </span><span class="s3">&quot;data&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;data&quot;</span><span class="s1">]</span>

        <span class="s1">self.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_series(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">full_indexer):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/32395</span>
        <span class="s1">ser = pd.Series(data</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;data&quot;</span><span class="s1">)</span>
        <span class="s1">result = pd.Series(index=ser.index</span><span class="s0">, </span><span class="s1">dtype=object</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;data&quot;</span><span class="s1">)</span>

        <span class="s5"># because result has object dtype, the attempt to do setting inplace</span>
        <span class="s5">#  is successful, and object dtype is retained</span>
        <span class="s1">key = full_indexer(ser)</span>
        <span class="s1">result.loc[key] = ser</span>

        <span class="s1">expected = pd.Series(</span>
            <span class="s1">data.astype(object)</span><span class="s0">, </span><span class="s1">index=ser.index</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;data&quot;</span><span class="s0">, </span><span class="s1">dtype=object</span>
        <span class="s1">)</span>
        <span class="s1">self.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_frame_2d_values(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">request):</span>
        <span class="s5"># GH#44514</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: data})</span>

        <span class="s5"># Avoiding using_array_manager fixture</span>
        <span class="s5">#  https://github.com/pandas-dev/pandas/pull/44514#discussion_r754002410</span>
        <span class="s1">using_array_manager = isinstance(df._mgr</span><span class="s0">, </span><span class="s1">pd.core.internals.ArrayManager)</span>
        <span class="s0">if </span><span class="s1">using_array_manager:</span>
            <span class="s0">if not </span><span class="s1">isinstance(</span>
                <span class="s1">data.dtype</span><span class="s0">, </span><span class="s1">(PandasDtype</span><span class="s0">, </span><span class="s1">PeriodDtype</span><span class="s0">, </span><span class="s1">IntervalDtype</span><span class="s0">, </span><span class="s1">DatetimeTZDtype)</span>
            <span class="s1">):</span>
                <span class="s5"># These dtypes have non-broken implementations of _can_hold_element</span>
                <span class="s1">mark = pytest.mark.xfail(reason=</span><span class="s3">&quot;Goes through split path, loses dtype&quot;</span><span class="s1">)</span>
                <span class="s1">request.node.add_marker(mark)</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: data})</span>
        <span class="s1">orig = df.copy()</span>

        <span class="s1">df.iloc[:] = df</span>
        <span class="s1">self.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">orig)</span>

        <span class="s1">df.iloc[:-</span><span class="s2">1</span><span class="s1">] = df.iloc[:-</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">self.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">orig)</span>

        <span class="s1">df.iloc[:] = df.values</span>
        <span class="s1">self.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">orig)</span>

        <span class="s1">df.iloc[:-</span><span class="s2">1</span><span class="s1">] = df.values[:-</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">self.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">orig)</span>

    <span class="s0">def </span><span class="s1">test_delitem_series(self</span><span class="s0">, </span><span class="s1">data):</span>
        <span class="s5"># GH#40763</span>
        <span class="s1">ser = pd.Series(data</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;data&quot;</span><span class="s1">)</span>

        <span class="s1">taker = np.arange(len(ser))</span>
        <span class="s1">taker = np.delete(taker</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>

        <span class="s1">expected = ser[taker]</span>
        <span class="s0">del </span><span class="s1">ser[</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">self.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_setitem_invalid(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">invalid_scalar):</span>
        <span class="s1">msg = </span><span class="s3">&quot;&quot;  </span><span class="s5"># messages vary by subclass, so we do not test it</span>
        <span class="s0">with </span><span class="s1">pytest.raises((ValueError</span><span class="s0">, </span><span class="s1">TypeError)</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">data[</span><span class="s2">0</span><span class="s1">] = invalid_scalar</span>

        <span class="s0">with </span><span class="s1">pytest.raises((ValueError</span><span class="s0">, </span><span class="s1">TypeError)</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">data[:] = invalid_scalar</span>
</pre>
</body>
</html>