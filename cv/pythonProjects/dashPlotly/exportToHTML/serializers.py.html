<html>
<head>
<title>serializers.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
serializers.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">.basedatatypes </span><span class="s0">import </span><span class="s1">Undefined</span>
<span class="s0">from </span><span class="s1">.optional_imports </span><span class="s0">import </span><span class="s1">get_module</span>

<span class="s1">np = get_module(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">_py_to_js(v</span><span class="s0">, </span><span class="s1">widget_manager):</span>
    <span class="s3">&quot;&quot;&quot; 
    Python -&gt; Javascript ipywidget serializer 
 
    This function must repalce all objects that the ipywidget library 
    can't serialize natively (e.g. numpy arrays) with serializable 
    representations 
 
    Parameters 
    ---------- 
    v 
        Object to be serialized 
    widget_manager 
        ipywidget widget_manager (unused) 
 
    Returns 
    ------- 
    any 
        Value that the ipywidget library can serialize natively 
    &quot;&quot;&quot;</span>

    <span class="s4"># Handle dict recursively</span>
    <span class="s4"># -----------------------</span>
    <span class="s0">if </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">dict):</span>
        <span class="s0">return </span><span class="s1">{k: _py_to_js(v</span><span class="s0">, </span><span class="s1">widget_manager) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">v.items()}</span>

    <span class="s4"># Handle list/tuple recursively</span>
    <span class="s4"># -----------------------------</span>
    <span class="s0">elif </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">(list</span><span class="s0">, </span><span class="s1">tuple)):</span>
        <span class="s0">return </span><span class="s1">[_py_to_js(v</span><span class="s0">, </span><span class="s1">widget_manager) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">v]</span>

    <span class="s4"># Handle numpy array</span>
    <span class="s4"># ------------------</span>
    <span class="s0">elif </span><span class="s1">np </span><span class="s0">is not None and </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">np.ndarray):</span>
        <span class="s4"># Convert 1D numpy arrays with numeric types to memoryviews with</span>
        <span class="s4"># datatype and shape metadata.</span>
        <span class="s0">if </span><span class="s1">(</span>
            <span class="s1">v.ndim == </span><span class="s5">1</span>
            <span class="s0">and </span><span class="s1">v.dtype.kind </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;u&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s2">&quot;f&quot;</span><span class="s1">]</span>
            <span class="s0">and </span><span class="s1">v.dtype != </span><span class="s2">&quot;int64&quot;</span>
            <span class="s0">and </span><span class="s1">v.dtype != </span><span class="s2">&quot;uint64&quot;</span>
        <span class="s1">):</span>

            <span class="s4"># We have a numpy array the we can directly map to a JavaScript</span>
            <span class="s4"># Typed array</span>
            <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;buffer&quot;</span><span class="s1">: memoryview(v)</span><span class="s0">, </span><span class="s2">&quot;dtype&quot;</span><span class="s1">: str(v.dtype)</span><span class="s0">, </span><span class="s2">&quot;shape&quot;</span><span class="s1">: v.shape}</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s4"># Convert all other numpy arrays to lists</span>
            <span class="s0">return </span><span class="s1">v.tolist()</span>

    <span class="s4"># Handle Undefined</span>
    <span class="s4"># ----------------</span>
    <span class="s0">if </span><span class="s1">v </span><span class="s0">is </span><span class="s1">Undefined:</span>
        <span class="s0">return </span><span class="s2">&quot;_undefined_&quot;</span>

    <span class="s4"># Handle simple value</span>
    <span class="s4"># -------------------</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">return </span><span class="s1">v</span>


<span class="s0">def </span><span class="s1">_js_to_py(v</span><span class="s0">, </span><span class="s1">widget_manager):</span>
    <span class="s3">&quot;&quot;&quot; 
    Javascript -&gt; Python ipywidget deserializer 
 
    Parameters 
    ---------- 
    v 
        Object to be deserialized 
    widget_manager 
        ipywidget widget_manager (unused) 
 
    Returns 
    ------- 
    any 
        Deserialized object for use by the Python side of the library 
    &quot;&quot;&quot;</span>
    <span class="s4"># Handle dict</span>
    <span class="s4"># -----------</span>
    <span class="s0">if </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">dict):</span>
        <span class="s0">return </span><span class="s1">{k: _js_to_py(v</span><span class="s0">, </span><span class="s1">widget_manager) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">v.items()}</span>

    <span class="s4"># Handle list/tuple</span>
    <span class="s4"># -----------------</span>
    <span class="s0">elif </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">(list</span><span class="s0">, </span><span class="s1">tuple)):</span>
        <span class="s0">return </span><span class="s1">[_js_to_py(v</span><span class="s0">, </span><span class="s1">widget_manager) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">v]</span>

    <span class="s4"># Handle Undefined</span>
    <span class="s4"># ----------------</span>
    <span class="s0">elif </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">str) </span><span class="s0">and </span><span class="s1">v == </span><span class="s2">&quot;_undefined_&quot;</span><span class="s1">:</span>
        <span class="s0">return </span><span class="s1">Undefined</span>

    <span class="s4"># Handle simple value</span>
    <span class="s4"># -------------------</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">return </span><span class="s1">v</span>


<span class="s4"># Custom serializer dict for use in ipywidget traitlet definitions</span>
<span class="s1">custom_serializers = {</span><span class="s2">&quot;from_json&quot;</span><span class="s1">: _js_to_py</span><span class="s0">, </span><span class="s2">&quot;to_json&quot;</span><span class="s1">: _py_to_js}</span>
</pre>
</body>
</html>