<html>
<head>
<title>test_longdouble.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #808080;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_longdouble.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_raises</span><span class="s0">, </span><span class="s1">assert_warns</span><span class="s0">, </span><span class="s1">assert_array_equal</span><span class="s0">,</span>
    <span class="s1">temppath</span><span class="s0">,</span>
    <span class="s1">)</span>
<span class="s0">from </span><span class="s1">numpy.core.tests._locales </span><span class="s0">import </span><span class="s1">CommaDecimalPointLocale</span>


<span class="s1">LD_INFO = np.finfo(np.longdouble)</span>
<span class="s1">longdouble_longer_than_double = (LD_INFO.eps &lt; np.finfo(np.double).eps)</span>


<span class="s1">_o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
<span class="s1">string_to_longdouble_inaccurate = (_o != np.longdouble(repr(_o)))</span>
<span class="s0">del </span><span class="s1">_o</span>


<span class="s0">def </span><span class="s1">test_scalar_extraction():</span>
    <span class="s3">&quot;&quot;&quot;Confirm that extracting a value doesn't convert to python float&quot;&quot;&quot;</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">a = np.array([o</span><span class="s0">, </span><span class="s1">o</span><span class="s0">, </span><span class="s1">o])</span>
    <span class="s1">assert_equal(a[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">o)</span>


<span class="s4"># Conversions string -&gt; long double</span>

<span class="s4"># 0.1 not exactly representable in base 2 floating point.</span>
<span class="s1">repr_precision = len(repr(np.longdouble(</span><span class="s2">0.1</span><span class="s1">)))</span>
<span class="s4"># +2 from macro block starting around line 842 in scalartypes.c.src.</span>
<span class="s1">@pytest.mark.skipif(LD_INFO.precision + </span><span class="s2">2 </span><span class="s1">&gt;= repr_precision</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s5">&quot;repr precision not enough to show eps&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_repr_roundtrip():</span>
    <span class="s4"># We will only see eps in repr if within printing precision.</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">assert_equal(np.longdouble(repr(o))</span><span class="s0">, </span><span class="s1">o</span><span class="s0">, </span><span class="s5">&quot;repr was %s&quot; </span><span class="s1">% repr(o))</span>


<span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">, </span><span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_repr_roundtrip_bytes():</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">assert_equal(np.longdouble(repr(o).encode(</span><span class="s5">&quot;ascii&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">o)</span>


<span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">, </span><span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;strtype&quot;</span><span class="s0">, </span><span class="s1">(np.str_</span><span class="s0">, </span><span class="s1">np.bytes_</span><span class="s0">, </span><span class="s1">str</span><span class="s0">, </span><span class="s1">bytes))</span>
<span class="s0">def </span><span class="s1">test_array_and_stringlike_roundtrip(strtype):</span>
    <span class="s3">&quot;&quot;&quot; 
    Test that string representations of long-double roundtrip both 
    for array casting and scalar coercion, see also gh-15608. 
    &quot;&quot;&quot;</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>

    <span class="s0">if </span><span class="s1">strtype </span><span class="s0">in </span><span class="s1">(np.bytes_</span><span class="s0">, </span><span class="s1">bytes):</span>
        <span class="s1">o_str = strtype(repr(o).encode(</span><span class="s5">&quot;ascii&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">o_str = strtype(repr(o))</span>

    <span class="s4"># Test that `o` is correctly coerced from the string-like</span>
    <span class="s0">assert </span><span class="s1">o == np.longdouble(o_str)</span>

    <span class="s4"># Test that arrays also roundtrip correctly:</span>
    <span class="s1">o_strarr = np.asarray([o] * </span><span class="s2">3</span><span class="s0">, </span><span class="s1">dtype=strtype)</span>
    <span class="s0">assert </span><span class="s1">(o == o_strarr.astype(np.longdouble)).all()</span>

    <span class="s4"># And array coercion and casting to string give the same as scalar repr:</span>
    <span class="s0">assert </span><span class="s1">(o_strarr == o_str).all()</span>
    <span class="s0">assert </span><span class="s1">(np.asarray([o] * </span><span class="s2">3</span><span class="s1">).astype(strtype) == o_str).all()</span>


<span class="s0">def </span><span class="s1">test_bogus_string():</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.longdouble</span><span class="s0">, </span><span class="s5">&quot;spam&quot;</span><span class="s1">)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.longdouble</span><span class="s0">, </span><span class="s5">&quot;1.0 flub&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">, </span><span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_fromstring():</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">s = (</span><span class="s5">&quot; &quot; </span><span class="s1">+ repr(o))*</span><span class="s2">5</span>
    <span class="s1">a = np.array([o]*</span><span class="s2">5</span><span class="s1">)</span>
    <span class="s1">assert_equal(np.fromstring(s</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s0">, </span><span class="s1">dtype=np.longdouble)</span><span class="s0">, </span><span class="s1">a</span><span class="s0">,</span>
                 <span class="s1">err_msg=</span><span class="s5">&quot;reading '%s'&quot; </span><span class="s1">% s)</span>


<span class="s0">def </span><span class="s1">test_fromstring_complex():</span>
    <span class="s0">for </span><span class="s1">ctype </span><span class="s0">in </span><span class="s1">[</span><span class="s5">&quot;complex&quot;</span><span class="s0">, </span><span class="s5">&quot;cdouble&quot;</span><span class="s0">, </span><span class="s5">&quot;cfloat&quot;</span><span class="s1">]:</span>
        <span class="s4"># Check spacing between separator</span>
        <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1, 2 ,  3  ,4&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype)</span><span class="s0">,</span>
                     <span class="s1">np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s0">, </span><span class="s2">4.</span><span class="s1">]))</span>
        <span class="s4"># Real component not specified</span>
        <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1j, -2j,  3j, 4e1j&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype)</span><span class="s0">,</span>
                     <span class="s1">np.array([</span><span class="s2">1.j</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2.j</span><span class="s0">, </span><span class="s2">3.j</span><span class="s0">, </span><span class="s2">40.j</span><span class="s1">]))</span>
        <span class="s4"># Both components specified</span>
        <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1+1j,2-2j, -3+3j,  -4e1+4j&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype)</span><span class="s0">,</span>
                     <span class="s1">np.array([</span><span class="s2">1. </span><span class="s1">+ </span><span class="s2">1.j</span><span class="s0">, </span><span class="s2">2. </span><span class="s1">- </span><span class="s2">2.j</span><span class="s0">, </span><span class="s1">- </span><span class="s2">3. </span><span class="s1">+ </span><span class="s2">3.j</span><span class="s0">, </span><span class="s1">- </span><span class="s2">40. </span><span class="s1">+ </span><span class="s2">4j</span><span class="s1">]))</span>
        <span class="s4"># Spaces at wrong places</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1+2 j,3&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1+ 2j,3&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1 +2j,3&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1+j&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1+&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1j+1&quot;</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1j</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_fromstring_bogus():</span>
    <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
        <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1. 2. 3. flop 4.&quot;</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span><span class="s0">,</span>
                     <span class="s1">np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_fromstring_empty():</span>
    <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
        <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;xxxxx&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
                     <span class="s1">np.array([]))</span>


<span class="s0">def </span><span class="s1">test_fromstring_missing():</span>
    <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
        <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1xx3x4x5x6&quot;</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
                     <span class="s1">np.array([</span><span class="s2">1</span><span class="s1">]))</span>


<span class="s0">class </span><span class="s1">TestFileBased:</span>

    <span class="s1">ldbl = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">tgt = np.array([ldbl]*</span><span class="s2">5</span><span class="s1">)</span>
    <span class="s1">out = </span><span class="s5">''</span><span class="s1">.join([repr(t) + </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">' </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">tgt])</span>

    <span class="s0">def </span><span class="s1">test_fromfile_bogus(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s5">&quot;1. 2. 3. flop 4.</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

            <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
                <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_fromfile_complex(self):</span>
        <span class="s0">for </span><span class="s1">ctype </span><span class="s0">in </span><span class="s1">[</span><span class="s5">&quot;complex&quot;</span><span class="s0">, </span><span class="s5">&quot;cdouble&quot;</span><span class="s0">, </span><span class="s5">&quot;cfloat&quot;</span><span class="s1">]:</span>
            <span class="s4"># Check spacing between separator and only real component specified</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1, 2 ,  3  ,4</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s0">, </span><span class="s2">4.</span><span class="s1">]))</span>

            <span class="s4"># Real component not specified</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1j, -2j,  3j, 4e1j</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.j</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2.j</span><span class="s0">, </span><span class="s2">3.j</span><span class="s0">, </span><span class="s2">40.j</span><span class="s1">]))</span>

            <span class="s4"># Both components specified</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1+1j,2-2j, -3+3j,  -4e1+4j</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1. </span><span class="s1">+ </span><span class="s2">1.j</span><span class="s0">, </span><span class="s2">2. </span><span class="s1">- </span><span class="s2">2.j</span><span class="s0">, </span><span class="s1">- </span><span class="s2">3. </span><span class="s1">+ </span><span class="s2">3.j</span><span class="s0">, </span><span class="s1">- </span><span class="s2">40. </span><span class="s1">+ </span><span class="s2">4j</span><span class="s1">]))</span>

            <span class="s4"># Spaces at wrong places</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1+2 j,3</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
                    <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>

            <span class="s4"># Spaces at wrong places</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1+ 2j,3</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
                    <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>

            <span class="s4"># Spaces at wrong places</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1 +2j,3</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
                    <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>

            <span class="s4"># Spaces at wrong places</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1+j</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
                    <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>

            <span class="s4"># Spaces at wrong places</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1+</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
                    <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>

            <span class="s4"># Spaces at wrong places</span>
            <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
                <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">f.write(</span><span class="s5">&quot;1j+1</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>

                <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
                    <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=ctype</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
            <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.j</span><span class="s1">]))</span>



    <span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">,</span>
                        <span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_fromfile(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(self.out)</span>
            <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=np.longdouble</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">self.tgt)</span>

    <span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">,</span>
                        <span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_genfromtxt(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(self.out)</span>
            <span class="s1">res = np.genfromtxt(path</span><span class="s0">, </span><span class="s1">dtype=np.longdouble)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">self.tgt)</span>

    <span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">,</span>
                        <span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_loadtxt(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s5">'wt'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">f.write(self.out)</span>
            <span class="s1">res = np.loadtxt(path</span><span class="s0">, </span><span class="s1">dtype=np.longdouble)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">self.tgt)</span>

    <span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">,</span>
                        <span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_tofile_roundtrip(self):</span>
        <span class="s0">with </span><span class="s1">temppath() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">self.tgt.tofile(path</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span>
            <span class="s1">res = np.fromfile(path</span><span class="s0">, </span><span class="s1">dtype=np.longdouble</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">self.tgt)</span>


<span class="s4"># Conversions long double -&gt; string</span>


<span class="s0">def </span><span class="s1">test_repr_exact():</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">assert_(repr(o) != </span><span class="s5">'1'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.skipif(longdouble_longer_than_double</span><span class="s0">, </span><span class="s1">reason=</span><span class="s5">&quot;BUG #2376&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_format():</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">assert_(</span><span class="s5">&quot;{0:.40g}&quot;</span><span class="s1">.format(o) != </span><span class="s5">'1'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.skipif(longdouble_longer_than_double</span><span class="s0">, </span><span class="s1">reason=</span><span class="s5">&quot;BUG #2376&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_percent():</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">assert_(</span><span class="s5">&quot;%.40g&quot; </span><span class="s1">% o != </span><span class="s5">'1'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.skipif(longdouble_longer_than_double</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s5">&quot;array repr problem&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.skipif(string_to_longdouble_inaccurate</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s5">&quot;Need strtold_l&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_array_repr():</span>
    <span class="s1">o = </span><span class="s2">1 </span><span class="s1">+ LD_INFO.eps</span>
    <span class="s1">a = np.array([o])</span>
    <span class="s1">b = np.array([</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.longdouble)</span>
    <span class="s0">if not </span><span class="s1">np.all(a != b):</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s5">&quot;precision loss creating arrays&quot;</span><span class="s1">)</span>
    <span class="s1">assert_(repr(a) != repr(b))</span>

<span class="s4">#</span>
<span class="s4"># Locale tests: scalar types formatting should be independent of the locale</span>
<span class="s4">#</span>

<span class="s0">class </span><span class="s1">TestCommaDecimalPointLocale(CommaDecimalPointLocale):</span>

    <span class="s0">def </span><span class="s1">test_repr_roundtrip_foreign(self):</span>
        <span class="s1">o = </span><span class="s2">1.5</span>
        <span class="s1">assert_equal(o</span><span class="s0">, </span><span class="s1">np.longdouble(repr(o)))</span>

    <span class="s0">def </span><span class="s1">test_fromstring_foreign_repr(self):</span>
        <span class="s1">f = </span><span class="s2">1.234</span>
        <span class="s1">a = np.fromstring(repr(f)</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(a[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">f)</span>

    <span class="s0">def </span><span class="s1">test_fromstring_best_effort_float(self):</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1,234&quot;</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_fromstring_best_effort(self):</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">assert_equal(np.fromstring(</span><span class="s5">&quot;1,234&quot;</span><span class="s0">, </span><span class="s1">dtype=np.longdouble</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span><span class="s0">,</span>
                         <span class="s1">np.array([</span><span class="s2">1.</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_fromstring_foreign(self):</span>
        <span class="s1">s = </span><span class="s5">&quot;1.234&quot;</span>
        <span class="s1">a = np.fromstring(s</span><span class="s0">, </span><span class="s1">dtype=np.longdouble</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(a[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.longdouble(s))</span>

    <span class="s0">def </span><span class="s1">test_fromstring_foreign_sep(self):</span>
        <span class="s1">a = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">b = np.fromstring(</span><span class="s5">&quot;1,2,3,4,&quot;</span><span class="s0">, </span><span class="s1">dtype=np.longdouble</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot;,&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">test_fromstring_foreign_value(self):</span>
        <span class="s0">with </span><span class="s1">assert_warns(DeprecationWarning):</span>
            <span class="s1">b = np.fromstring(</span><span class="s5">&quot;1,234&quot;</span><span class="s0">, </span><span class="s1">dtype=np.longdouble</span><span class="s0">, </span><span class="s1">sep=</span><span class="s5">&quot; &quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_equal(b[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;int_val&quot;</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s4"># cases discussed in gh-10723</span>
    <span class="s4"># and gh-9968</span>
    <span class="s2">2 </span><span class="s1">** </span><span class="s2">1024</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_longdouble_from_int(int_val):</span>
    <span class="s4"># for issue gh-9968</span>
    <span class="s1">str_val = str(int_val)</span>
    <span class="s4"># we'll expect a RuntimeWarning on platforms</span>
    <span class="s4"># with np.longdouble equivalent to np.double</span>
    <span class="s4"># for large integer input</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
        <span class="s1">warnings.filterwarnings(</span><span class="s5">'always'</span><span class="s0">, </span><span class="s5">''</span><span class="s0">, </span><span class="s1">RuntimeWarning)</span>
        <span class="s4"># can be inf==inf on some platforms</span>
        <span class="s0">assert </span><span class="s1">np.longdouble(int_val) == np.longdouble(str_val)</span>
        <span class="s4"># we can't directly compare the int and</span>
        <span class="s4"># max longdouble value on all platforms</span>
        <span class="s0">if </span><span class="s1">np.allclose(np.finfo(np.longdouble).max</span><span class="s0">,</span>
                       <span class="s1">np.finfo(np.double).max) </span><span class="s0">and </span><span class="s1">w:</span>
            <span class="s0">assert </span><span class="s1">w[</span><span class="s2">0</span><span class="s1">].category </span><span class="s0">is </span><span class="s1">RuntimeWarning</span>

<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;bool_val&quot;</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_longdouble_from_bool(bool_val):</span>
    <span class="s0">assert </span><span class="s1">np.longdouble(bool_val) == np.longdouble(int(bool_val))</span>
</pre>
</body>
</html>