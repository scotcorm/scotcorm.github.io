<html>
<head>
<title>test_libsparse.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_libsparse.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">operator</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas._libs.sparse </span><span class="s0">as </span><span class="s1">splib</span>
<span class="s0">import </span><span class="s1">pandas.util._test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">Series</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.arrays.sparse </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">BlockIndex</span><span class="s0">,</span>
    <span class="s1">IntIndex</span><span class="s0">,</span>
    <span class="s1">make_sparse_index</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s1">TEST_LENGTH = </span><span class="s2">20</span>

<span class="s1">plain_case = {</span>
    <span class="s3">&quot;xloc&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">15</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;xlen&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;yloc&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">14</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;ylen&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_loc&quot;</span><span class="s1">: [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">15</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_len&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">}</span>
<span class="s1">delete_blocks = {</span>
    <span class="s3">&quot;xloc&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;xlen&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;yloc&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;ylen&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_loc&quot;</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_len&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">}</span>
<span class="s1">split_blocks = {</span>
    <span class="s3">&quot;xloc&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;xlen&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;yloc&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;ylen&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_loc&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_len&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">}</span>
<span class="s1">skip_block = {</span>
    <span class="s3">&quot;xloc&quot;</span><span class="s1">: [</span><span class="s2">10</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;xlen&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;yloc&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;ylen&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_loc&quot;</span><span class="s1">: [</span><span class="s2">12</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_len&quot;</span><span class="s1">: [</span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">}</span>

<span class="s1">no_intersect = {</span>
    <span class="s3">&quot;xloc&quot;</span><span class="s1">: [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;xlen&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;yloc&quot;</span><span class="s1">: [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">17</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;ylen&quot;</span><span class="s1">: [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_loc&quot;</span><span class="s1">: []</span><span class="s0">,</span>
    <span class="s3">&quot;intersect_len&quot;</span><span class="s1">: []</span><span class="s0">,</span>
<span class="s1">}</span>


<span class="s0">def </span><span class="s1">check_cases(_check_case):</span>
    <span class="s0">def </span><span class="s1">_check_case_dict(case):</span>
        <span class="s1">_check_case(</span>
            <span class="s1">case[</span><span class="s3">&quot;xloc&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">case[</span><span class="s3">&quot;xlen&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">case[</span><span class="s3">&quot;yloc&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">case[</span><span class="s3">&quot;ylen&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">case[</span><span class="s3">&quot;intersect_loc&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">case[</span><span class="s3">&quot;intersect_len&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s1">_check_case_dict(plain_case)</span>
    <span class="s1">_check_case_dict(delete_blocks)</span>
    <span class="s1">_check_case_dict(split_blocks)</span>
    <span class="s1">_check_case_dict(skip_block)</span>
    <span class="s1">_check_case_dict(no_intersect)</span>

    <span class="s4"># one or both is empty</span>
    <span class="s1">_check_case([</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[])</span>
    <span class="s1">_check_case([]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[])</span>


<span class="s0">class </span><span class="s1">TestSparseIndexUnion:</span>
    <span class="s0">def </span><span class="s1">test_index_make_union(self):</span>
        <span class="s0">def </span><span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen):</span>
            <span class="s1">xindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">xloc</span><span class="s0">, </span><span class="s1">xlen)</span>
            <span class="s1">yindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen)</span>
            <span class="s1">bresult = xindex.make_union(yindex)</span>
            <span class="s0">assert </span><span class="s1">isinstance(bresult</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
            <span class="s1">tm.assert_numpy_array_equal(bresult.blocs</span><span class="s0">, </span><span class="s1">np.array(eloc</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">tm.assert_numpy_array_equal(</span>
                <span class="s1">bresult.blengths</span><span class="s0">, </span><span class="s1">np.array(elen</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">)</span>

            <span class="s1">ixindex = xindex.to_int_index()</span>
            <span class="s1">iyindex = yindex.to_int_index()</span>
            <span class="s1">iresult = ixindex.make_union(iyindex)</span>
            <span class="s0">assert </span><span class="s1">isinstance(iresult</span><span class="s0">, </span><span class="s1">IntIndex)</span>
            <span class="s1">tm.assert_numpy_array_equal(iresult.indices</span><span class="s0">, </span><span class="s1">bresult.to_int_index().indices)</span>

        <span class="s3">&quot;&quot;&quot; 
        x: ---- 
        y:     ---- 
        r: -------- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">5</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">5</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">4</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">9</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
        <span class="s3">&quot;&quot;&quot; 
        x: -----     ----- 
        y:   -----          -- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">17</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">17</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">7</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
        <span class="s3">&quot;&quot;&quot; 
        x: ------ 
        y:    ------- 
        r: ---------- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">5</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">3</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">5</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">7</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
        <span class="s3">&quot;&quot;&quot; 
        x: ------  ----- 
        y:    ------- 
        r: ------------- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">4</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">8</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">12</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
        <span class="s3">&quot;&quot;&quot; 
        x: ---  ----- 
        y: ------- 
        r: ------------- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">7</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">10</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
        <span class="s3">&quot;&quot;&quot; 
        x: ------  ----- 
        y:    -------  --- 
        r: ------------- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">13</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">8</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">15</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
        <span class="s3">&quot;&quot;&quot; 
        x: ---------------------- 
        y:   ----  ----   --- 
        r: ---------------------- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">15</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">14</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">15</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
        <span class="s3">&quot;&quot;&quot; 
        x: ----       --- 
        y:       ---       --- 
        &quot;&quot;&quot;</span>
        <span class="s1">xloc = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span>
        <span class="s1">xlen = [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span>
        <span class="s1">yloc = [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">15</span><span class="s1">]</span>
        <span class="s1">ylen = [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">eloc = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">15</span><span class="s1">]</span>
        <span class="s1">elen = [</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
        <span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>

    <span class="s0">def </span><span class="s1">test_int_index_make_union(self):</span>
        <span class="s1">a = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">b = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">res = a.make_union(b)</span>
        <span class="s1">exp = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.int32))</span>
        <span class="s0">assert </span><span class="s1">res.equals(exp)</span>

        <span class="s1">a = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">b = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">res = a.make_union(b)</span>
        <span class="s1">exp = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.int32))</span>
        <span class="s0">assert </span><span class="s1">res.equals(exp)</span>

        <span class="s1">a = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">b = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">res = a.make_union(b)</span>
        <span class="s1">exp = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">np.int32))</span>
        <span class="s0">assert </span><span class="s1">res.equals(exp)</span>

        <span class="s1">a = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">b = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">res = a.make_union(b)</span>
        <span class="s1">exp = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.int32))</span>
        <span class="s0">assert </span><span class="s1">res.equals(exp)</span>

        <span class="s1">a = IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">b = IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">msg = </span><span class="s3">&quot;Indices must reference same underlying length&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">a.make_union(b)</span>


<span class="s0">class </span><span class="s1">TestSparseIndexIntersect:</span>
    <span class="s1">@td.skip_if_windows</span>
    <span class="s0">def </span><span class="s1">test_intersect(self):</span>
        <span class="s0">def </span><span class="s1">_check_correct(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">expected):</span>
            <span class="s1">result = a.intersect(b)</span>
            <span class="s0">assert </span><span class="s1">result.equals(expected)</span>

        <span class="s0">def </span><span class="s1">_check_length_exc(a</span><span class="s0">, </span><span class="s1">longer):</span>
            <span class="s1">msg = </span><span class="s3">&quot;Indices must reference same underlying length&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(Exception</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">a.intersect(longer)</span>

        <span class="s0">def </span><span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen):</span>
            <span class="s1">xindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">xloc</span><span class="s0">, </span><span class="s1">xlen)</span>
            <span class="s1">yindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen)</span>
            <span class="s1">expected = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen)</span>
            <span class="s1">longer_index = BlockIndex(TEST_LENGTH + </span><span class="s2">1</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen)</span>

            <span class="s1">_check_correct(xindex</span><span class="s0">, </span><span class="s1">yindex</span><span class="s0">, </span><span class="s1">expected)</span>
            <span class="s1">_check_correct(</span>
                <span class="s1">xindex.to_int_index()</span><span class="s0">, </span><span class="s1">yindex.to_int_index()</span><span class="s0">, </span><span class="s1">expected.to_int_index()</span>
            <span class="s1">)</span>

            <span class="s1">_check_length_exc(xindex</span><span class="s0">, </span><span class="s1">longer_index)</span>
            <span class="s1">_check_length_exc(xindex.to_int_index()</span><span class="s0">, </span><span class="s1">longer_index.to_int_index())</span>

        <span class="s1">check_cases(_check_case)</span>

    <span class="s0">def </span><span class="s1">test_intersect_empty(self):</span>
        <span class="s1">xindex = IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">yindex = IntIndex(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s0">assert </span><span class="s1">xindex.intersect(yindex).equals(xindex)</span>
        <span class="s0">assert </span><span class="s1">yindex.intersect(xindex).equals(xindex)</span>

        <span class="s1">xindex = xindex.to_block_index()</span>
        <span class="s1">yindex = yindex.to_block_index()</span>
        <span class="s0">assert </span><span class="s1">xindex.intersect(yindex).equals(xindex)</span>
        <span class="s0">assert </span><span class="s1">yindex.intersect(xindex).equals(xindex)</span>

    <span class="s0">def </span><span class="s1">test_intersect_identical(self):</span>
        <span class="s1">cases = [</span>
            <span class="s1">IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span><span class="s0">,</span>
            <span class="s1">IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span><span class="s0">,</span>
            <span class="s1">IntIndex(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span><span class="s0">,</span>
            <span class="s1">IntIndex(</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span><span class="s0">,</span>
        <span class="s1">]</span>

        <span class="s0">for </span><span class="s1">case </span><span class="s0">in </span><span class="s1">cases:</span>
            <span class="s0">assert </span><span class="s1">case.intersect(case).equals(case)</span>
            <span class="s1">case = case.to_block_index()</span>
            <span class="s0">assert </span><span class="s1">case.intersect(case).equals(case)</span>


<span class="s0">class </span><span class="s1">TestSparseIndexCommon:</span>
    <span class="s0">def </span><span class="s1">test_int_internal(self):</span>
        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">IntIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">2</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.indices</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">IntIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">0</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.indices</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span>
            <span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">IntIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">4</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.indices</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

    <span class="s0">def </span><span class="s1">test_block_internal(self):</span>
        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">2</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">0</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">4</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">3</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

    <span class="s0">def </span><span class="s1">test_lookup(self):</span>
        <span class="s0">for </span><span class="s1">kind </span><span class="s0">in </span><span class="s1">[</span><span class="s3">&quot;integer&quot;</span><span class="s0">, </span><span class="s3">&quot;block&quot;</span><span class="s1">]:</span>
            <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind)</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(-</span><span class="s2">1</span><span class="s1">) == -</span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">0</span><span class="s1">) == -</span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">1</span><span class="s1">) == -</span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">2</span><span class="s1">) == </span><span class="s2">0</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">3</span><span class="s1">) == </span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">4</span><span class="s1">) == -</span><span class="s2">1</span>

            <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind)</span>

            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">5</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">idx.lookup(i) == -</span><span class="s2">1</span>

            <span class="s1">idx = make_sparse_index(</span>
                <span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind</span>
            <span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(-</span><span class="s2">1</span><span class="s1">) == -</span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">0</span><span class="s1">) == </span><span class="s2">0</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">1</span><span class="s1">) == </span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">2</span><span class="s1">) == </span><span class="s2">2</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">3</span><span class="s1">) == </span><span class="s2">3</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">4</span><span class="s1">) == -</span><span class="s2">1</span>

            <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind)</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(-</span><span class="s2">1</span><span class="s1">) == -</span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">0</span><span class="s1">) == </span><span class="s2">0</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">1</span><span class="s1">) == -</span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">2</span><span class="s1">) == </span><span class="s2">1</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">3</span><span class="s1">) == </span><span class="s2">2</span>
            <span class="s0">assert </span><span class="s1">idx.lookup(</span><span class="s2">4</span><span class="s1">) == -</span><span class="s2">1</span>

    <span class="s0">def </span><span class="s1">test_lookup_array(self):</span>
        <span class="s0">for </span><span class="s1">kind </span><span class="s0">in </span><span class="s1">[</span><span class="s3">&quot;integer&quot;</span><span class="s0">, </span><span class="s3">&quot;block&quot;</span><span class="s1">]:</span>
            <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind)</span>

            <span class="s1">res = idx.lookup_array(np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">exp = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

            <span class="s1">res = idx.lookup_array(np.array([</span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">exp = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

            <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind)</span>
            <span class="s1">res = idx.lookup_array(np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">exp = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>

            <span class="s1">idx = make_sparse_index(</span>
                <span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind</span>
            <span class="s1">)</span>
            <span class="s1">res = idx.lookup_array(np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">exp = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

            <span class="s1">res = idx.lookup_array(np.array([</span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">exp = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

            <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=kind)</span>
            <span class="s1">res = idx.lookup_array(np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">exp = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

            <span class="s1">res = idx.lookup_array(np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
            <span class="s1">exp = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;idx, expected&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">7</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">8</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">10</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">11</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">12</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">17</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">18</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_lookup_basics(self</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">expected):</span>
        <span class="s1">bindex = BlockIndex(</span><span class="s2">20</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">bindex.lookup(idx) == expected</span>

        <span class="s1">iindex = bindex.to_int_index()</span>
        <span class="s0">assert </span><span class="s1">iindex.lookup(idx) == expected</span>


<span class="s0">class </span><span class="s1">TestBlockIndex:</span>
    <span class="s0">def </span><span class="s1">test_block_internal(self):</span>
        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">2</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">0</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">4</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">3</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

    <span class="s0">def </span><span class="s1">test_make_block_boundary(self):</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">100</span><span class="s0">, </span><span class="s2">101</span><span class="s1">]:</span>
            <span class="s1">idx = make_sparse_index(i</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;block&quot;</span><span class="s1">)</span>

            <span class="s1">exp = np.arange(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
            <span class="s1">tm.assert_numpy_array_equal(idx.blocs</span><span class="s0">, </span><span class="s1">exp)</span>
            <span class="s1">tm.assert_numpy_array_equal(idx.blengths</span><span class="s0">, </span><span class="s1">np.ones(len(exp)</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

    <span class="s0">def </span><span class="s1">test_equals(self):</span>
        <span class="s1">index = BlockIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>

        <span class="s0">assert </span><span class="s1">index.equals(index)</span>
        <span class="s0">assert not </span><span class="s1">index.equals(BlockIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_check_integrity(self):</span>
        <span class="s1">locs = []</span>
        <span class="s1">lengths = []</span>

        <span class="s4"># 0-length OK</span>
        <span class="s1">BlockIndex(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">locs</span><span class="s0">, </span><span class="s1">lengths)</span>

        <span class="s4"># also OK even though empty</span>
        <span class="s1">BlockIndex(</span><span class="s2">1</span><span class="s0">, </span><span class="s1">locs</span><span class="s0">, </span><span class="s1">lengths)</span>

        <span class="s1">msg = </span><span class="s3">&quot;Block 0 extends beyond end&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">BlockIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">10</span><span class="s1">])</span>

        <span class="s1">msg = </span><span class="s3">&quot;Block 0 overlaps&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">BlockIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_to_int_index(self):</span>
        <span class="s1">locs = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span>
        <span class="s1">lengths = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span>
        <span class="s1">exp_inds = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s1">]</span>

        <span class="s1">block = BlockIndex(</span><span class="s2">20</span><span class="s0">, </span><span class="s1">locs</span><span class="s0">, </span><span class="s1">lengths)</span>
        <span class="s1">dense = block.to_int_index()</span>

        <span class="s1">tm.assert_numpy_array_equal(dense.indices</span><span class="s0">, </span><span class="s1">np.array(exp_inds</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

    <span class="s0">def </span><span class="s1">test_to_block_index(self):</span>
        <span class="s1">index = BlockIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">index.to_block_index() </span><span class="s0">is </span><span class="s1">index</span>


<span class="s0">class </span><span class="s1">TestIntIndex:</span>
    <span class="s0">def </span><span class="s1">test_check_integrity(self):</span>

        <span class="s4"># Too many indices than specified in self.length</span>
        <span class="s1">msg = </span><span class="s3">&quot;Too many indices&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">IntIndex(length=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

        <span class="s4"># No index can be negative.</span>
        <span class="s1">msg = </span><span class="s3">&quot;No index can be less than zero&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">IntIndex(length=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

        <span class="s4"># No index can be negative.</span>
        <span class="s1">msg = </span><span class="s3">&quot;No index can be less than zero&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">IntIndex(length=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

        <span class="s4"># All indices must be less than the length.</span>
        <span class="s1">msg = </span><span class="s3">&quot;All indices must be less than the length&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">IntIndex(length=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">IntIndex(length=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>

        <span class="s4"># Indices must be strictly ascending.</span>
        <span class="s1">msg = </span><span class="s3">&quot;Indices must be strictly increasing&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">IntIndex(length=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">IntIndex(length=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_int_internal(self):</span>
        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">IntIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">2</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.indices</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span><span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">IntIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">0</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.indices</span><span class="s0">, </span><span class="s1">np.array([]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

        <span class="s1">idx = make_sparse_index(</span>
            <span class="s2">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">, </span><span class="s1">kind=</span><span class="s3">&quot;integer&quot;</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(idx</span><span class="s0">, </span><span class="s1">IntIndex)</span>
        <span class="s0">assert </span><span class="s1">idx.npoints == </span><span class="s2">4</span>
        <span class="s1">tm.assert_numpy_array_equal(idx.indices</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

    <span class="s0">def </span><span class="s1">test_equals(self):</span>
        <span class="s1">index = IntIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">index.equals(index)</span>
        <span class="s0">assert not </span><span class="s1">index.equals(IntIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_to_block_index(self):</span>
        <span class="s0">def </span><span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen):</span>
            <span class="s1">xindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">xloc</span><span class="s0">, </span><span class="s1">xlen)</span>
            <span class="s1">yindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen)</span>

            <span class="s4"># see if survive the round trip</span>
            <span class="s1">xbindex = xindex.to_int_index().to_block_index()</span>
            <span class="s1">ybindex = yindex.to_int_index().to_block_index()</span>
            <span class="s0">assert </span><span class="s1">isinstance(xbindex</span><span class="s0">, </span><span class="s1">BlockIndex)</span>
            <span class="s0">assert </span><span class="s1">xbindex.equals(xindex)</span>
            <span class="s0">assert </span><span class="s1">ybindex.equals(yindex)</span>

        <span class="s1">check_cases(_check_case)</span>

    <span class="s0">def </span><span class="s1">test_to_int_index(self):</span>
        <span class="s1">index = IntIndex(</span><span class="s2">10</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">index.to_int_index() </span><span class="s0">is </span><span class="s1">index</span>


<span class="s0">class </span><span class="s1">TestSparseOperators:</span>
    <span class="s0">def </span><span class="s1">_op_tests(self</span><span class="s0">, </span><span class="s1">sparse_op</span><span class="s0">, </span><span class="s1">python_op):</span>
        <span class="s0">def </span><span class="s1">_check_case(xloc</span><span class="s0">, </span><span class="s1">xlen</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen</span><span class="s0">, </span><span class="s1">eloc</span><span class="s0">, </span><span class="s1">elen):</span>
            <span class="s1">xindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">xloc</span><span class="s0">, </span><span class="s1">xlen)</span>
            <span class="s1">yindex = BlockIndex(TEST_LENGTH</span><span class="s0">, </span><span class="s1">yloc</span><span class="s0">, </span><span class="s1">ylen)</span>

            <span class="s1">xdindex = xindex.to_int_index()</span>
            <span class="s1">ydindex = yindex.to_int_index()</span>

            <span class="s1">x = np.arange(xindex.npoints) * </span><span class="s2">10.0 </span><span class="s1">+ </span><span class="s2">1</span>
            <span class="s1">y = np.arange(yindex.npoints) * </span><span class="s2">100.0 </span><span class="s1">+ </span><span class="s2">1</span>

            <span class="s1">xfill = </span><span class="s2">0</span>
            <span class="s1">yfill = </span><span class="s2">2</span>

            <span class="s1">result_block_vals</span><span class="s0">, </span><span class="s1">rb_index</span><span class="s0">, </span><span class="s1">bfill = sparse_op(</span>
                <span class="s1">x</span><span class="s0">, </span><span class="s1">xindex</span><span class="s0">, </span><span class="s1">xfill</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">yindex</span><span class="s0">, </span><span class="s1">yfill</span>
            <span class="s1">)</span>
            <span class="s1">result_int_vals</span><span class="s0">, </span><span class="s1">ri_index</span><span class="s0">, </span><span class="s1">ifill = sparse_op(</span>
                <span class="s1">x</span><span class="s0">, </span><span class="s1">xdindex</span><span class="s0">, </span><span class="s1">xfill</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">ydindex</span><span class="s0">, </span><span class="s1">yfill</span>
            <span class="s1">)</span>

            <span class="s0">assert </span><span class="s1">rb_index.to_int_index().equals(ri_index)</span>
            <span class="s1">tm.assert_numpy_array_equal(result_block_vals</span><span class="s0">, </span><span class="s1">result_int_vals)</span>
            <span class="s0">assert </span><span class="s1">bfill == ifill</span>

            <span class="s4"># check versus Series...</span>
            <span class="s1">xseries = Series(x</span><span class="s0">, </span><span class="s1">xdindex.indices)</span>
            <span class="s1">xseries = xseries.reindex(np.arange(TEST_LENGTH)).fillna(xfill)</span>

            <span class="s1">yseries = Series(y</span><span class="s0">, </span><span class="s1">ydindex.indices)</span>
            <span class="s1">yseries = yseries.reindex(np.arange(TEST_LENGTH)).fillna(yfill)</span>

            <span class="s1">series_result = python_op(xseries</span><span class="s0">, </span><span class="s1">yseries)</span>
            <span class="s1">series_result = series_result.reindex(ri_index.indices)</span>

            <span class="s1">tm.assert_numpy_array_equal(result_block_vals</span><span class="s0">, </span><span class="s1">series_result.values)</span>
            <span class="s1">tm.assert_numpy_array_equal(result_int_vals</span><span class="s0">, </span><span class="s1">series_result.values)</span>

        <span class="s1">check_cases(_check_case)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;opname&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;add&quot;</span><span class="s0">, </span><span class="s3">&quot;sub&quot;</span><span class="s0">, </span><span class="s3">&quot;mul&quot;</span><span class="s0">, </span><span class="s3">&quot;truediv&quot;</span><span class="s0">, </span><span class="s3">&quot;floordiv&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_op(self</span><span class="s0">, </span><span class="s1">opname):</span>
        <span class="s1">sparse_op = getattr(splib</span><span class="s0">, </span><span class="s3">f&quot;sparse_</span><span class="s0">{</span><span class="s1">opname</span><span class="s0">}</span><span class="s3">_float64&quot;</span><span class="s1">)</span>
        <span class="s1">python_op = getattr(operator</span><span class="s0">, </span><span class="s1">opname)</span>
        <span class="s1">self._op_tests(sparse_op</span><span class="s0">, </span><span class="s1">python_op)</span>
</pre>
</body>
</html>