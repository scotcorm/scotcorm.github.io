<html>
<head>
<title>test_recfunctions.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #a5c261;}
.s6 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_recfunctions.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">numpy.ma </span><span class="s0">as </span><span class="s1">ma</span>
<span class="s0">from </span><span class="s1">numpy.ma.mrecords </span><span class="s0">import </span><span class="s1">MaskedRecords</span>
<span class="s0">from </span><span class="s1">numpy.ma.testutils </span><span class="s0">import </span><span class="s1">assert_equal</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_raises</span>
<span class="s0">from </span><span class="s1">numpy.lib.recfunctions </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">drop_fields</span><span class="s0">, </span><span class="s1">rename_fields</span><span class="s0">, </span><span class="s1">get_fieldstructure</span><span class="s0">, </span><span class="s1">recursive_fill_fields</span><span class="s0">,</span>
    <span class="s1">find_duplicates</span><span class="s0">, </span><span class="s1">merge_arrays</span><span class="s0">, </span><span class="s1">append_fields</span><span class="s0">, </span><span class="s1">stack_arrays</span><span class="s0">, </span><span class="s1">join_by</span><span class="s0">,</span>
    <span class="s1">repack_fields</span><span class="s0">, </span><span class="s1">unstructured_to_structured</span><span class="s0">, </span><span class="s1">structured_to_unstructured</span><span class="s0">,</span>
    <span class="s1">apply_along_fields</span><span class="s0">, </span><span class="s1">require_fields</span><span class="s0">, </span><span class="s1">assign_fields_by_name)</span>
<span class="s1">get_fieldspec = np.lib.recfunctions._get_fieldspec</span>
<span class="s1">get_names = np.lib.recfunctions.get_names</span>
<span class="s1">get_names_flat = np.lib.recfunctions.get_names_flat</span>
<span class="s1">zip_descr = np.lib.recfunctions._zip_descr</span>
<span class="s1">zip_dtype = np.lib.recfunctions._zip_dtype</span>


<span class="s0">class </span><span class="s1">TestRecFunctions:</span>
    <span class="s2"># Misc tests</span>

    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">z = np.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">)]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">w = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">))]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>
        <span class="s1">self.data = (w</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span>

    <span class="s0">def </span><span class="s1">test_zip_descr(self):</span>
        <span class="s2"># Test zip_descr</span>
        <span class="s1">(w</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z) = self.data</span>

        <span class="s2"># Std array</span>
        <span class="s1">test = zip_descr((x</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">,</span>
                     <span class="s1">np.dtype([(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)]))</span>
        <span class="s1">test = zip_descr((x</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">,</span>
                     <span class="s1">np.dtype([(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)]))</span>

        <span class="s2"># Std &amp; flexible-dtype</span>
        <span class="s1">test = zip_descr((x</span><span class="s0">, </span><span class="s1">z)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">,</span>
                     <span class="s1">np.dtype([(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)]))</span>
        <span class="s1">test = zip_descr((x</span><span class="s0">, </span><span class="s1">z)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">,</span>
                     <span class="s1">np.dtype([(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                               <span class="s1">(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])]))</span>

        <span class="s2"># Standard &amp; nested dtype</span>
        <span class="s1">test = zip_descr((x</span><span class="s0">, </span><span class="s1">w)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">,</span>
                     <span class="s1">np.dtype([(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                               <span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                               <span class="s1">(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)]))</span>
        <span class="s1">test = zip_descr((x</span><span class="s0">, </span><span class="s1">w)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">,</span>
                     <span class="s1">np.dtype([(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                               <span class="s1">(</span><span class="s4">''</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                     <span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])]))</span>

    <span class="s0">def </span><span class="s1">test_drop_fields(self):</span>
        <span class="s2"># Test drop_fields</span>
        <span class="s1">a = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">))]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>

        <span class="s2"># A basic field</span>
        <span class="s1">test = drop_fields(a</span><span class="s0">, </span><span class="s4">'a'</span><span class="s1">)</span>
        <span class="s1">control = np.array([((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s2"># Another basic field (but nesting two fields)</span>
        <span class="s1">test = drop_fields(a</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s2"># A nested sub-field</span>
        <span class="s1">test = drop_fields(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">])</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3.0</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6.0</span><span class="s0">,</span><span class="s1">))]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s2"># All the nested sub-field from a field: zap that field</span>
        <span class="s1">test = drop_fields(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s4">'bb'</span><span class="s1">])</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s2"># dropping all fields results in an array with no fields</span>
        <span class="s1">test = drop_fields(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">])</span>
        <span class="s1">control = np.array([()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">, </span><span class="s1">dtype=[])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_rename_fields(self):</span>
        <span class="s2"># Test rename fields</span>
        <span class="s1">a = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">30.</span><span class="s1">]))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">60.</span><span class="s1">]))]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">(float</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))])])</span>
        <span class="s1">test = rename_fields(a</span><span class="s0">, </span><span class="s1">{</span><span class="s4">'a'</span><span class="s1">: </span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'bb'</span><span class="s1">: </span><span class="s4">'BB'</span><span class="s1">})</span>
        <span class="s1">newdtype = [(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'BB'</span><span class="s0">, </span><span class="s1">(float</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))])]</span>
        <span class="s1">control = a.view(newdtype)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s0">, </span><span class="s1">newdtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_get_names(self):</span>
        <span class="s2"># Test get_names</span>
        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">test = get_names(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">))</span>

        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>
        <span class="s1">test = get_names(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s4">'bb'</span><span class="s1">))))</span>

        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[])])</span>
        <span class="s1">test = get_names(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">())))</span>

        <span class="s1">ndtype = np.dtype([])</span>
        <span class="s1">test = get_names(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">())</span>

    <span class="s0">def </span><span class="s1">test_get_names_flat(self):</span>
        <span class="s2"># Test get_names_flat</span>
        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">test = get_names_flat(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">))</span>

        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>
        <span class="s1">test = get_names_flat(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'ba'</span><span class="s0">, </span><span class="s4">'bb'</span><span class="s1">))</span>

        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[])])</span>
        <span class="s1">test = get_names_flat(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">))</span>

        <span class="s1">ndtype = np.dtype([])</span>
        <span class="s1">test = get_names_flat(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">())</span>

    <span class="s0">def </span><span class="s1">test_get_fieldstructure(self):</span>
        <span class="s2"># Test get_fieldstructure</span>

        <span class="s2"># No nested fields</span>
        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">test = get_fieldstructure(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">{</span><span class="s4">'A'</span><span class="s1">: []</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">: []})</span>

        <span class="s2"># One 1-nested field</span>
        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'BA'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'BB'</span><span class="s0">, </span><span class="s4">'|S1'</span><span class="s1">)])])</span>
        <span class="s1">test = get_fieldstructure(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">{</span><span class="s4">'A'</span><span class="s1">: []</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">: []</span><span class="s0">, </span><span class="s4">'BA'</span><span class="s1">: [</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">]</span><span class="s0">, </span><span class="s4">'BB'</span><span class="s1">: [</span><span class="s4">'B'</span><span class="s1">]})</span>

        <span class="s2"># One 2-nested fields</span>
        <span class="s1">ndtype = np.dtype([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                           <span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'BA'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'BB'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'BBA'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'BBB'</span><span class="s0">, </span><span class="s1">int)])])])</span>
        <span class="s1">test = get_fieldstructure(ndtype)</span>
        <span class="s1">control = {</span><span class="s4">'A'</span><span class="s1">: []</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">: []</span><span class="s0">, </span><span class="s4">'BA'</span><span class="s1">: [</span><span class="s4">'B'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">'BB'</span><span class="s1">: [</span><span class="s4">'B'</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s4">'BBA'</span><span class="s1">: [</span><span class="s4">'B'</span><span class="s0">, </span><span class="s4">'BB'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">'BBB'</span><span class="s1">: [</span><span class="s4">'B'</span><span class="s0">, </span><span class="s4">'BB'</span><span class="s1">]}</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s2"># 0 fields</span>
        <span class="s1">ndtype = np.dtype([])</span>
        <span class="s1">test = get_fieldstructure(ndtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">{})</span>

    <span class="s0">def </span><span class="s1">test_find_duplicates(self):</span>
        <span class="s2"># Test find_duplicates</span>
        <span class="s1">a = ma.array([(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2.</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2.</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2.</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">))</span><span class="s0">,</span>
                      <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1.</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2.</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2.</span><span class="s0">, </span><span class="s4">'C'</span><span class="s1">))]</span><span class="s0">,</span>
                     <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
                           <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'BA'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'BB'</span><span class="s0">, </span><span class="s4">'|S1'</span><span class="s1">)])])</span>

        <span class="s1">test = find_duplicates(a</span><span class="s0">, </span><span class="s1">ignoremask=</span><span class="s0">False, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">assert_equal(sorted(test[-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[test[-</span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s1">test = find_duplicates(a</span><span class="s0">, </span><span class="s1">key=</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">assert_equal(sorted(test[-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[test[-</span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s1">test = find_duplicates(a</span><span class="s0">, </span><span class="s1">key=</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>
        <span class="s1">assert_equal(sorted(test[-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[test[-</span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s1">test = find_duplicates(a</span><span class="s0">, </span><span class="s1">key=</span><span class="s4">'BA'</span><span class="s0">, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>
        <span class="s1">assert_equal(sorted(test[-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[test[-</span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s1">test = find_duplicates(a</span><span class="s0">, </span><span class="s1">key=</span><span class="s4">'BB'</span><span class="s0">, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>
        <span class="s1">assert_equal(sorted(test[-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[test[-</span><span class="s3">1</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_find_duplicates_ignoremask(self):</span>
        <span class="s2"># Test the ignoremask option of find_duplicates</span>
        <span class="s1">ndtype = [(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)]</span>
        <span class="s1">a = ma.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">mask=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]).view(ndtype)</span>
        <span class="s1">test = find_duplicates(a</span><span class="s0">, </span><span class="s1">ignoremask=</span><span class="s0">True, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>
        <span class="s1">assert_equal(sorted(test[-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[test[-</span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s1">test = find_duplicates(a</span><span class="s0">, </span><span class="s1">ignoremask=</span><span class="s0">False, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span>
        <span class="s1">assert_equal(sorted(test[-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[test[-</span><span class="s3">1</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_repack_fields(self):</span>
        <span class="s1">dt = np.dtype(</span><span class="s4">'u1,f4,i8'</span><span class="s0">, </span><span class="s1">align=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">a = np.zeros(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dtype=dt)</span>

        <span class="s1">assert_equal(repack_fields(dt)</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s4">'u1,f4,i8'</span><span class="s1">))</span>
        <span class="s1">assert_equal(repack_fields(a).itemsize</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)</span>
        <span class="s1">assert_equal(repack_fields(repack_fields(dt)</span><span class="s0">, </span><span class="s1">align=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dt)</span>

        <span class="s2"># make sure type is preserved</span>
        <span class="s1">dt = np.dtype((np.record</span><span class="s0">, </span><span class="s1">dt))</span>
        <span class="s1">assert_(repack_fields(dt).type </span><span class="s0">is </span><span class="s1">np.record)</span>

    <span class="s0">def </span><span class="s1">test_structured_to_unstructured(self):</span>
        <span class="s1">a = np.zeros(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f4,u2'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)])</span>
        <span class="s1">out = structured_to_unstructured(a)</span>
        <span class="s1">assert_equal(out</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s3">4</span><span class="s0">,</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s4">'f8'</span><span class="s1">))</span>

        <span class="s1">b = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8 </span><span class="s0">,</span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'x'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'y'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'z'</span><span class="s0">, </span><span class="s4">'f8'</span><span class="s1">)])</span>
        <span class="s1">out = np.mean(structured_to_unstructured(b[[</span><span class="s4">'x'</span><span class="s0">, </span><span class="s4">'z'</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(out</span><span class="s0">, </span><span class="s1">np.array([ </span><span class="s3">3. </span><span class="s0">,  </span><span class="s3">5.5</span><span class="s0">,  </span><span class="s3">9. </span><span class="s0">, </span><span class="s3">11. </span><span class="s1">]))</span>
        <span class="s1">out = np.mean(structured_to_unstructured(b[[</span><span class="s4">'x'</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(out</span><span class="s0">, </span><span class="s1">np.array([ </span><span class="s3">1. </span><span class="s0">,  </span><span class="s3">4. </span><span class="s0">,  </span><span class="s3">7. </span><span class="s0">, </span><span class="s3">10. </span><span class="s1">]))</span>

        <span class="s1">c = np.arange(</span><span class="s3">20</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">,</span><span class="s3">5</span><span class="s1">))</span>
        <span class="s1">out = unstructured_to_structured(c</span><span class="s0">, </span><span class="s1">a.dtype)</span>
        <span class="s1">want = np.array([( </span><span class="s3">0</span><span class="s0">, </span><span class="s1">( </span><span class="s3">1.</span><span class="s0">,  </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[ </span><span class="s3">3.</span><span class="s0">,  </span><span class="s3">4.</span><span class="s1">])</span><span class="s0">,</span>
                         <span class="s1">( </span><span class="s3">5</span><span class="s0">, </span><span class="s1">( </span><span class="s3">6.</span><span class="s0">,  </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[ </span><span class="s3">8.</span><span class="s0">,  </span><span class="s3">9.</span><span class="s1">])</span><span class="s0">,</span>
                         <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11.</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">13.</span><span class="s0">, </span><span class="s3">14.</span><span class="s1">])</span><span class="s0">,</span>
                         <span class="s1">(</span><span class="s3">15</span><span class="s0">, </span><span class="s1">(</span><span class="s3">16.</span><span class="s0">, </span><span class="s3">17</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">18.</span><span class="s0">, </span><span class="s3">19.</span><span class="s1">])]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s4">'u2'</span><span class="s1">)])</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))])</span>
        <span class="s1">assert_equal(out</span><span class="s0">, </span><span class="s1">want)</span>

        <span class="s1">d = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8 </span><span class="s0">,</span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'x'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'y'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'z'</span><span class="s0">, </span><span class="s4">'f8'</span><span class="s1">)])</span>
        <span class="s1">assert_equal(apply_along_fields(np.mean</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">,</span>
                     <span class="s1">np.array([ </span><span class="s3">8.0</span><span class="s1">/</span><span class="s3">3</span><span class="s0">,  </span><span class="s3">16.0</span><span class="s1">/</span><span class="s3">3</span><span class="s0">,  </span><span class="s3">26.0</span><span class="s1">/</span><span class="s3">3</span><span class="s0">, </span><span class="s3">11. </span><span class="s1">]))</span>
        <span class="s1">assert_equal(apply_along_fields(np.mean</span><span class="s0">, </span><span class="s1">d[[</span><span class="s4">'x'</span><span class="s0">, </span><span class="s4">'z'</span><span class="s1">]])</span><span class="s0">,</span>
                     <span class="s1">np.array([ </span><span class="s3">3. </span><span class="s0">,  </span><span class="s3">5.5</span><span class="s0">,  </span><span class="s3">9. </span><span class="s0">, </span><span class="s3">11. </span><span class="s1">]))</span>

        <span class="s2"># check that for uniform field dtypes we get a view, not a copy:</span>
        <span class="s1">d = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8 </span><span class="s0">,</span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'x'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'y'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'z'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)])</span>
        <span class="s1">dd = structured_to_unstructured(d)</span>
        <span class="s1">ddd = unstructured_to_structured(dd</span><span class="s0">, </span><span class="s1">d.dtype)</span>
        <span class="s1">assert_(dd.base </span><span class="s0">is </span><span class="s1">d)</span>
        <span class="s1">assert_(ddd.base </span><span class="s0">is </span><span class="s1">d)</span>

        <span class="s2"># including uniform fields with subarrays unpacked</span>
        <span class="s1">d = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">,  </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[ </span><span class="s3">4</span><span class="s0">,  </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[ </span><span class="s3">6</span><span class="s0">,  </span><span class="s3">7</span><span class="s1">]])</span><span class="s0">,</span>
                      <span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s1">]])]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'x0'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'x1'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'i4'</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s4">'x2'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'i4'</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))])</span>
        <span class="s1">dd = structured_to_unstructured(d)</span>
        <span class="s1">ddd = unstructured_to_structured(dd</span><span class="s0">, </span><span class="s1">d.dtype)</span>
        <span class="s1">assert_(dd.base </span><span class="s0">is </span><span class="s1">d)</span>
        <span class="s1">assert_(ddd.base </span><span class="s0">is </span><span class="s1">d)</span>

        <span class="s2"># test that nested fields with identical names don't break anything</span>
        <span class="s1">point = np.dtype([(</span><span class="s4">'x'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'y'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">triangle = np.dtype([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">point)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">point)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">point)])</span>
        <span class="s1">arr = np.zeros(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">triangle)</span>
        <span class="s1">res = structured_to_unstructured(arr</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=int))</span>


        <span class="s2"># test nested combinations of subarrays and structured arrays, gh-13333</span>
        <span class="s0">def </span><span class="s1">subarray(dt</span><span class="s0">, </span><span class="s1">shape):</span>
            <span class="s0">return </span><span class="s1">np.dtype((dt</span><span class="s0">, </span><span class="s1">shape))</span>

        <span class="s0">def </span><span class="s1">structured(*dts):</span>
            <span class="s0">return </span><span class="s1">np.dtype([(</span><span class="s4">'x{}'</span><span class="s1">.format(i)</span><span class="s0">, </span><span class="s1">dt) </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">enumerate(dts)])</span>

        <span class="s0">def </span><span class="s1">inspect(dt</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">):</span>
            <span class="s1">arr = np.zeros(()</span><span class="s0">, </span><span class="s1">dt)</span>
            <span class="s1">ret = structured_to_unstructured(arr</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">backarr = unstructured_to_structured(ret</span><span class="s0">, </span><span class="s1">dt)</span>
            <span class="s0">return </span><span class="s1">ret.shape</span><span class="s0">, </span><span class="s1">ret.dtype</span><span class="s0">, </span><span class="s1">backarr.dtype</span>

        <span class="s1">dt = structured(subarray(structured(np.int32</span><span class="s0">, </span><span class="s1">np.int32)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_equal(inspect(dt)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32</span><span class="s0">, </span><span class="s1">dt))</span>

        <span class="s1">dt = structured(subarray(subarray(np.int32</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(inspect(dt)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32</span><span class="s0">, </span><span class="s1">dt))</span>

        <span class="s1">dt = structured(np.int32)</span>
        <span class="s1">assert_equal(inspect(dt)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32</span><span class="s0">, </span><span class="s1">dt))</span>

        <span class="s1">dt = structured(np.int32</span><span class="s0">, </span><span class="s1">subarray(subarray(np.int32</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(inspect(dt)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32</span><span class="s0">, </span><span class="s1">dt))</span>

        <span class="s1">dt = structured()</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">structured_to_unstructured</span><span class="s0">, </span><span class="s1">np.zeros(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dt))</span>

        <span class="s2"># these currently don't work, but we may make it work in the future</span>
        <span class="s1">assert_raises(NotImplementedError</span><span class="s0">, </span><span class="s1">structured_to_unstructured</span><span class="s0">,</span>
                                           <span class="s1">np.zeros(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dt)</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
        <span class="s1">assert_raises(NotImplementedError</span><span class="s0">, </span><span class="s1">unstructured_to_structured</span><span class="s0">,</span>
                                           <span class="s1">np.zeros((</span><span class="s3">3</span><span class="s0">,</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.int32))</span>

    <span class="s0">def </span><span class="s1">test_field_assignment_by_name(self):</span>
        <span class="s1">a = np.ones(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)])</span>
        <span class="s1">newdt = [(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)]</span>

        <span class="s1">assert_equal(require_fields(a</span><span class="s0">, </span><span class="s1">newdt)</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">newdt))</span>

        <span class="s1">b = np.array([(</span><span class="s3">1</span><span class="s0">,</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s3">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=newdt)</span>
        <span class="s1">assign_fields_by_name(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">zero_unassigned=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([(</span><span class="s3">1</span><span class="s0">,</span><span class="s3">1</span><span class="s0">,</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s3">3</span><span class="s0">,</span><span class="s3">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>
        <span class="s1">assign_fields_by_name(a</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([(</span><span class="s3">0</span><span class="s0">,</span><span class="s3">1</span><span class="s0">,</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s3">3</span><span class="s0">,</span><span class="s3">4</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>

        <span class="s2"># test nested fields</span>
        <span class="s1">a = np.ones(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)])])</span>
        <span class="s1">newdt = [(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)])]</span>
        <span class="s1">assert_equal(require_fields(a</span><span class="s0">, </span><span class="s1">newdt)</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">newdt))</span>
        <span class="s1">b = np.array([((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=newdt)</span>
        <span class="s1">assign_fields_by_name(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">zero_unassigned=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([((</span><span class="s3">1</span><span class="s0">,</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">,</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>
        <span class="s1">assign_fields_by_name(a</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">np.array([((</span><span class="s3">0</span><span class="s0">,</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>

        <span class="s2"># test unstructured code path for 0d arrays</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = np.array(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array(</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assign_fields_by_name(b</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(b[()]</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestRecursiveFillFields:</span>
    <span class="s2"># Test recursive_fill_fields.</span>
    <span class="s0">def </span><span class="s1">test_simple_flexible(self):</span>
        <span class="s2"># Test recursive_fill_fields on flexible-array</span>
        <span class="s1">a = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20.</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">b = np.zeros((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=a.dtype)</span>
        <span class="s1">test = recursive_fill_fields(a</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_masked_flexible(self):</span>
        <span class="s2"># Test recursive_fill_fields on masked flexible-array</span>
        <span class="s1">a = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20.</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">b = ma.zeros((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=a.dtype)</span>
        <span class="s1">test = recursive_fill_fields(a</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>


<span class="s0">class </span><span class="s1">TestMergeArrays:</span>
    <span class="s2"># Test merge_arrays</span>

    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">z = np.array(</span>
            <span class="s1">[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">w = np.array(</span>
            <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s1">()))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s1">()))]</span><span class="s0">,</span>
            <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bc'</span><span class="s0">, </span><span class="s1">[])])])</span>
        <span class="s1">self.data = (w</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span>

    <span class="s0">def </span><span class="s1">test_solo(self):</span>
        <span class="s2"># Test merge_arrays on a single array.</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">z) = self.data</span>

        <span class="s1">test = merge_arrays(x)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">test = merge_arrays((x</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s1">test = merge_arrays(z</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">z)</span>
        <span class="s1">test = merge_arrays(z</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">z)</span>

    <span class="s0">def </span><span class="s1">test_solo_w_flatten(self):</span>
        <span class="s2"># Test merge_arrays on a single array w &amp; w/o flattening</span>
        <span class="s1">w = self.data[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">test = merge_arrays(w</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">w)</span>

        <span class="s1">test = merge_arrays(w</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_standard(self):</span>
        <span class="s2"># Test standard &amp; standard</span>
        <span class="s2"># Test merge arrays</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">_) = self.data</span>
        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

    <span class="s0">def </span><span class="s1">test_flatten(self):</span>
        <span class="s2"># Test standard &amp; flexible</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">z) = self.data</span>
        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">z)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">z)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">))]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_flatten_wflexible(self):</span>
        <span class="s2"># Test flatten standard &amp; nested</span>
        <span class="s1">(w</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_) = self.data</span>
        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">w)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">w)</span><span class="s0">, </span><span class="s1">flatten=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">controldtype = [(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                <span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                        <span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bc'</span><span class="s0">, </span><span class="s1">[])])])]</span>
        <span class="s1">control = np.array([(</span><span class="s3">1.</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s1">())))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s1">())))]</span><span class="s0">,</span>
                           <span class="s1">dtype=controldtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_wmasked_arrays(self):</span>
        <span class="s2"># Test merge_arrays masked arrays</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_) = self.data</span>
        <span class="s1">mx = ma.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">mask=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">mx)</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">test = merge_arrays((x</span><span class="s0">, </span><span class="s1">mx)</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">True, </span><span class="s1">asrecarray=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_(isinstance(test</span><span class="s0">, </span><span class="s1">MaskedRecords))</span>

    <span class="s0">def </span><span class="s1">test_w_singlefield(self):</span>
        <span class="s2"># Test single field</span>
        <span class="s1">test = merge_arrays((np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]).view([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)])</span><span class="s0">,</span>
                             <span class="s1">np.array([</span><span class="s3">10.</span><span class="s0">, </span><span class="s3">20.</span><span class="s0">, </span><span class="s3">30.</span><span class="s1">]))</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">30.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_w_shorter_flex(self):</span>
        <span class="s2"># Test merge_arrays w/ a shorter flexndarray.</span>
        <span class="s1">z = self.data[-</span><span class="s3">1</span><span class="s1">]</span>

        <span class="s2"># Fixme, this test looks incomplete and broken</span>
        <span class="s2">#test = merge_arrays((z, np.array([10, 20, 30]).view([('C', int)])))</span>
        <span class="s2">#control = np.array([('A', 1., 10), ('B', 2., 20), ('-1', -1, 20)],</span>
        <span class="s2">#                   dtype=[('A', '|S3'), ('B', float), ('C', int)])</span>
        <span class="s2">#assert_equal(test, control)</span>

        <span class="s2"># Hack to avoid pyflakes warnings about unused variables</span>
        <span class="s1">merge_arrays((z</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]).view([(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">int)])))</span>
        <span class="s1">np.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'-1'</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)]</span><span class="s0">,</span>
                 <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">int)])</span>

    <span class="s0">def </span><span class="s1">test_singlerecord(self):</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z) = self.data</span>
        <span class="s1">test = merge_arrays((x[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">z[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'f1'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'f2'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>


<span class="s0">class </span><span class="s1">TestAppendFields:</span>
    <span class="s2"># Test append_fields</span>

    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">z = np.array(</span>
            <span class="s1">[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">w = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">))]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>
        <span class="s1">self.data = (w</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span>

    <span class="s0">def </span><span class="s1">test_append_single(self):</span>
        <span class="s2"># Test simple case</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_) = self.data</span>
        <span class="s1">test = append_fields(x</span><span class="s0">, </span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">data=[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)]</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_append_double(self):</span>
        <span class="s2"># Test simple case</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_) = self.data</span>
        <span class="s1">test = append_fields(x</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">data=[[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">200</span><span class="s1">]])</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">200</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">int)]</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_append_on_flex(self):</span>
        <span class="s2"># Test append_fields on flexible type arrays</span>
        <span class="s1">z = self.data[-</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">test = append_fields(z</span><span class="s0">, </span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">data=[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">control = ma.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">int)]</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_append_on_nested(self):</span>
        <span class="s2"># Test append_fields on nested fields</span>
        <span class="s1">w = self.data[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">test = append_fields(w</span><span class="s0">, </span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">data=[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.</span><span class="s1">)</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span>
                               <span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">int)]</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>


<span class="s0">class </span><span class="s1">TestStackArrays:</span>
    <span class="s2"># Test stack_arrays</span>
    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">z = np.array(</span>
            <span class="s1">[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">w = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">))]</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">'ba'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'bb'</span><span class="s0">, </span><span class="s1">int)])])</span>
        <span class="s1">self.data = (w</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span>

    <span class="s0">def </span><span class="s1">test_solo(self):</span>
        <span class="s2"># Test stack_arrays on single arrays</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_) = self.data</span>
        <span class="s1">test = stack_arrays((x</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">x)</span>
        <span class="s1">assert_(test </span><span class="s0">is </span><span class="s1">x)</span>

        <span class="s1">test = stack_arrays(x)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">x)</span>
        <span class="s1">assert_(test </span><span class="s0">is </span><span class="s1">x)</span>

    <span class="s0">def </span><span class="s1">test_unnamed_fields(self):</span>
        <span class="s2"># Tests combinations of arrays w/o named fields</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">_) = self.data</span>

        <span class="s1">test = stack_arrays((x</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">control = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s1">test = stack_arrays((x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">control = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

        <span class="s1">test = stack_arrays((y</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">control = np.array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_unnamed_and_named_fields(self):</span>
        <span class="s2"># Test combination of arrays w/ &amp; w/o named fields</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">z) = self.data</span>

        <span class="s1">test = stack_arrays((x</span><span class="s0">, </span><span class="s1">z))</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'f0'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

        <span class="s1">test = stack_arrays((z</span><span class="s0">, </span><span class="s1">x))</span>
        <span class="s1">control = ma.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f2'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

        <span class="s1">test = stack_arrays((z</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">x))</span>
        <span class="s1">control = ma.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f2'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_matching_named_fields(self):</span>
        <span class="s2"># Test combination of arrays w/ matching field names</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">z) = self.data</span>
        <span class="s1">zz = np.array([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s3">10.</span><span class="s0">, </span><span class="s3">100.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s3">20.</span><span class="s0">, </span><span class="s3">200.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s3">30.</span><span class="s0">, </span><span class="s3">300.</span><span class="s1">)]</span><span class="s0">,</span>
                      <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">test = stack_arrays((z</span><span class="s0">, </span><span class="s1">zz))</span>
        <span class="s1">control = ma.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span>
                                <span class="s4">'a'</span><span class="s0">, </span><span class="s3">10.</span><span class="s0">, </span><span class="s3">100.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s3">20.</span><span class="s0">, </span><span class="s3">200.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s3">30.</span><span class="s0">, </span><span class="s3">300.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

        <span class="s1">test = stack_arrays((z</span><span class="s0">, </span><span class="s1">zz</span><span class="s0">, </span><span class="s1">x))</span>
        <span class="s1">ndtype = [(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f3'</span><span class="s0">, </span><span class="s1">int)]</span>
        <span class="s1">control = ma.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s3">10.</span><span class="s0">, </span><span class="s3">100.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s3">20.</span><span class="s0">, </span><span class="s3">200.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s3">30.</span><span class="s0">, </span><span class="s3">300.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=ndtype</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

    <span class="s0">def </span><span class="s1">test_defaults(self):</span>
        <span class="s2"># Test defaults: no exception raised if keys of defaults are not fields.</span>
        <span class="s1">(_</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">z) = self.data</span>
        <span class="s1">zz = np.array([(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s3">10.</span><span class="s0">, </span><span class="s3">100.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s3">20.</span><span class="s0">, </span><span class="s3">200.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s3">30.</span><span class="s0">, </span><span class="s3">300.</span><span class="s1">)]</span><span class="s0">,</span>
                      <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">defaults = {</span><span class="s4">'A'</span><span class="s1">: </span><span class="s4">'???'</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">: -</span><span class="s3">999.</span><span class="s0">, </span><span class="s4">'C'</span><span class="s1">: -</span><span class="s3">9999.</span><span class="s0">, </span><span class="s4">'D'</span><span class="s1">: -</span><span class="s3">99999.</span><span class="s1">}</span>
        <span class="s1">test = stack_arrays((z</span><span class="s0">, </span><span class="s1">zz)</span><span class="s0">, </span><span class="s1">defaults=defaults)</span>
        <span class="s1">control = ma.array([(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9999.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9999.</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span>
                                <span class="s4">'a'</span><span class="s0">, </span><span class="s3">10.</span><span class="s0">, </span><span class="s3">100.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s3">20.</span><span class="s0">, </span><span class="s3">200.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s3">30.</span><span class="s0">, </span><span class="s3">300.</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.data</span><span class="s0">, </span><span class="s1">control.data)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

    <span class="s0">def </span><span class="s1">test_autoconversion(self):</span>
        <span class="s2"># Tests autoconversion</span>
        <span class="s1">adtype = [(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">bool)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">a = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=adtype)</span>
        <span class="s1">bdtype = [(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">b = ma.array([(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=bdtype)</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=bdtype)</span>
        <span class="s1">test = stack_arrays((a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">autoconvert=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>
        <span class="s0">with </span><span class="s1">assert_raises(TypeError):</span>
            <span class="s1">stack_arrays((a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">autoconvert=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_checktitles(self):</span>
        <span class="s2"># Test using titles in the field names</span>
        <span class="s1">adtype = [((</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'A'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">bool)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'C'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">a = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=adtype)</span>
        <span class="s1">bdtype = [((</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'A'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'B'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">bool)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'C'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float)]</span>
        <span class="s1">b = ma.array([(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=bdtype)</span>
        <span class="s1">test = stack_arrays((a</span><span class="s0">, </span><span class="s1">b))</span>
        <span class="s1">control = ma.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=bdtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
        <span class="s1">assert_equal(test.mask</span><span class="s0">, </span><span class="s1">control.mask)</span>

    <span class="s0">def </span><span class="s1">test_subdtype(self):</span>
        <span class="s1">z = np.array([</span>
            <span class="s1">(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))])</span>
        <span class="s1">zz = np.array([</span>
            <span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10.</span><span class="s1">]</span><span class="s0">, </span><span class="s3">100.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20.</span><span class="s1">]</span><span class="s0">, </span><span class="s3">200.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">30.</span><span class="s1">]</span><span class="s0">, </span><span class="s3">300.</span><span class="s1">)</span>
        <span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s4">'|S3'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">float)])</span>

        <span class="s1">res = stack_arrays((z</span><span class="s0">, </span><span class="s1">zz))</span>
        <span class="s1">expected = ma.array(</span>
            <span class="s1">data=[</span>
                <span class="s1">(</span><span class="s5">b'A'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">b'B'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">b'a'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10.0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">100.0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">b'b'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20.0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">200.0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">b'c'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">30.0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">300.0</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">mask=[</span>
                <span class="s1">(</span><span class="s0">False, </span><span class="s1">[</span><span class="s0">False</span><span class="s1">]</span><span class="s0">,  True</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s0">False, </span><span class="s1">[</span><span class="s0">False</span><span class="s1">]</span><span class="s0">,  True</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s0">False, </span><span class="s1">[</span><span class="s0">False</span><span class="s1">]</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s0">False, </span><span class="s1">[</span><span class="s0">False</span><span class="s1">]</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s0">False, </span><span class="s1">[</span><span class="s0">False</span><span class="s1">]</span><span class="s0">, False</span><span class="s1">)</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">dtype=zz.dtype</span>
        <span class="s1">)</span>
        <span class="s1">assert_equal(res.dtype</span><span class="s0">, </span><span class="s1">expected.dtype)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s1">assert_equal(res.mask</span><span class="s0">, </span><span class="s1">expected.mask)</span>


<span class="s0">class </span><span class="s1">TestJoinBy:</span>
    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s1">self.a = np.array(list(zip(np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">50</span><span class="s0">, </span><span class="s3">60</span><span class="s1">)</span><span class="s0">,</span>
                                   <span class="s1">np.arange(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">110</span><span class="s1">)))</span><span class="s0">,</span>
                          <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">self.b = np.array(list(zip(np.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">65</span><span class="s0">, </span><span class="s3">75</span><span class="s1">)</span><span class="s0">,</span>
                                   <span class="s1">np.arange(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">110</span><span class="s1">)))</span><span class="s0">,</span>
                          <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>

    <span class="s0">def </span><span class="s1">test_inner_join(self):</span>
        <span class="s2"># Basic test of join_by</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = self.a</span><span class="s0">, </span><span class="s1">self.b</span>

        <span class="s1">test = join_by(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">jointype=</span><span class="s4">'inner'</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">65</span><span class="s0">, </span><span class="s3">105</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">66</span><span class="s0">, </span><span class="s3">106</span><span class="s0">, </span><span class="s3">101</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">67</span><span class="s0">, </span><span class="s3">107</span><span class="s0">, </span><span class="s3">102</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">68</span><span class="s0">, </span><span class="s3">108</span><span class="s0">, </span><span class="s3">103</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">69</span><span class="s0">, </span><span class="s3">109</span><span class="s0">, </span><span class="s3">104</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b1'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b2'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_join(self):</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = self.a</span><span class="s0">, </span><span class="s1">self.b</span>

        <span class="s2"># Fixme, this test is broken</span>
        <span class="s2">#test = join_by(('a', 'b'), a, b)</span>
        <span class="s2">#control = np.array([(5, 55, 105, 100), (6, 56, 106, 101),</span>
        <span class="s2">#                    (7, 57, 107, 102), (8, 58, 108, 103),</span>
        <span class="s2">#                    (9, 59, 109, 104)],</span>
        <span class="s2">#                   dtype=[('a', int), ('b', int),</span>
        <span class="s2">#                          ('c', int), ('d', int)])</span>
        <span class="s2">#assert_equal(test, control)</span>

        <span class="s2"># Hack to avoid pyflakes unused variable warnings</span>
        <span class="s1">join_by((</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">np.array([(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">105</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">106</span><span class="s0">, </span><span class="s3">101</span><span class="s1">)</span><span class="s0">,</span>
                  <span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">107</span><span class="s0">, </span><span class="s3">102</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">108</span><span class="s0">, </span><span class="s3">103</span><span class="s1">)</span><span class="s0">,</span>
                  <span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">109</span><span class="s0">, </span><span class="s3">104</span><span class="s1">)]</span><span class="s0">,</span>
                  <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                         <span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>

    <span class="s0">def </span><span class="s1">test_join_subdtype(self):</span>
        <span class="s2"># tests the bug in https://stackoverflow.com/q/44769632/102441</span>
        <span class="s1">foo = np.array([(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">,</span>
                       <span class="s1">dtype=[(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">bar = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">1</span><span class="s0">,</span><span class="s3">2</span><span class="s0">,</span><span class="s3">3</span><span class="s1">]))]</span><span class="s0">,</span>
                       <span class="s1">dtype=[(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value'</span><span class="s0">, </span><span class="s4">'uint16'</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>
        <span class="s1">res = join_by(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s1">foo</span><span class="s0">, </span><span class="s1">bar)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">bar.view(ma.MaskedArray))</span>

    <span class="s0">def </span><span class="s1">test_outer_join(self):</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = self.a</span><span class="s0">, </span><span class="s1">self.b</span>

        <span class="s1">test = join_by((</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s4">'outer'</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">101</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">102</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">103</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">104</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">105</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">65</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">106</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">66</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">101</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">107</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">67</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">102</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">108</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">68</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">103</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">109</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">69</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">104</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">70</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">105</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">71</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">106</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">12</span><span class="s0">, </span><span class="s3">72</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">107</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">13</span><span class="s0">, </span><span class="s3">73</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">108</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">14</span><span class="s0">, </span><span class="s3">74</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">109</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_leftouter_join(self):</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = self.a</span><span class="s0">, </span><span class="s1">self.b</span>

        <span class="s1">test = join_by((</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s4">'leftouter'</span><span class="s1">)</span>
        <span class="s1">control = ma.array([(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">101</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">102</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">103</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">104</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">105</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">106</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">107</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">108</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">109</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">mask=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                                 <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_different_field_order(self):</span>
        <span class="s2"># gh-8940</span>
        <span class="s1">a = np.zeros(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)])</span>
        <span class="s1">b = np.ones(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)])</span>
        <span class="s2"># this should not give a FutureWarning:</span>
        <span class="s1">j = join_by([</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">jointype=</span><span class="s4">'inner'</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(j.dtype.names</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'a1'</span><span class="s0">, </span><span class="s4">'a2'</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_duplicate_keys(self):</span>
        <span class="s1">a = np.zeros(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)])</span>
        <span class="s1">b = np.ones(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s4">'u1'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'i4'</span><span class="s1">)])</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">join_by</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s0">, </span><span class="s4">'b'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s1">@pytest.mark.xfail(reason=</span><span class="s4">&quot;See comment at gh-9343&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_same_name_different_dtypes_key(self):</span>
        <span class="s1">a_dtype = np.dtype([(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s4">'S5'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)])</span>
        <span class="s1">b_dtype = np.dtype([(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s4">'S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)])</span>
        <span class="s1">expected_dtype = np.dtype([</span>
            <span class="s1">(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s4">'S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value1'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value2'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)])</span>

        <span class="s1">a = np.array([(</span><span class="s4">'Sarah'</span><span class="s0">,  </span><span class="s3">8.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'John'</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=a_dtype)</span>
        <span class="s1">b = np.array([(</span><span class="s4">'Sarah'</span><span class="s0">, </span><span class="s3">10.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'John'</span><span class="s0">, </span><span class="s3">7.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=b_dtype)</span>
        <span class="s1">res = join_by(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>

        <span class="s1">assert_equal(res.dtype</span><span class="s0">, </span><span class="s1">expected_dtype)</span>

    <span class="s0">def </span><span class="s1">test_same_name_different_dtypes(self):</span>
        <span class="s2"># gh-9338</span>
        <span class="s1">a_dtype = np.dtype([(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s4">'S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)])</span>
        <span class="s1">b_dtype = np.dtype([(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s4">'S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value'</span><span class="s0">, </span><span class="s4">'&lt;f8'</span><span class="s1">)])</span>
        <span class="s1">expected_dtype = np.dtype([</span>
            <span class="s1">(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s4">'|S10'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value1'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'value2'</span><span class="s0">, </span><span class="s4">'&lt;f8'</span><span class="s1">)])</span>

        <span class="s1">a = np.array([(</span><span class="s4">'Sarah'</span><span class="s0">,  </span><span class="s3">8.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'John'</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=a_dtype)</span>
        <span class="s1">b = np.array([(</span><span class="s4">'Sarah'</span><span class="s0">, </span><span class="s3">10.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'John'</span><span class="s0">, </span><span class="s3">7.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=b_dtype)</span>
        <span class="s1">res = join_by(</span><span class="s4">'key'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>

        <span class="s1">assert_equal(res.dtype</span><span class="s0">, </span><span class="s1">expected_dtype)</span>

    <span class="s0">def </span><span class="s1">test_subarray_key(self):</span>
        <span class="s1">a_dtype = np.dtype([(</span><span class="s4">'pos'</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)])</span>
        <span class="s1">a = np.array([([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.pi)</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=a_dtype)</span>

        <span class="s1">b_dtype = np.dtype([(</span><span class="s4">'pos'</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'g'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)])</span>
        <span class="s1">b = np.array([([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=b_dtype)</span>

        <span class="s1">expected_dtype = np.dtype([(</span><span class="s4">'pos'</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'f'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'g'</span><span class="s0">, </span><span class="s4">'&lt;f4'</span><span class="s1">)])</span>
        <span class="s1">expected = np.array([([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.pi</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=expected_dtype)</span>

        <span class="s1">res = join_by(</span><span class="s4">'pos'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(res.dtype</span><span class="s0">, </span><span class="s1">expected_dtype)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_padded_dtype(self):</span>
        <span class="s1">dt = np.dtype(</span><span class="s4">'i1,f4'</span><span class="s0">, </span><span class="s1">align=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">dt.names = (</span><span class="s4">'k'</span><span class="s0">, </span><span class="s4">'v'</span><span class="s1">)</span>
        <span class="s1">assert_(len(dt.descr)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)  </span><span class="s2"># padding field is inserted</span>

        <span class="s1">a = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dt)</span>
        <span class="s1">b = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dt)</span>
        <span class="s1">res = join_by(</span><span class="s4">'k'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>

        <span class="s2"># no padding fields remain</span>
        <span class="s1">expected_dtype = np.dtype([</span>
            <span class="s1">(</span><span class="s4">'k'</span><span class="s0">, </span><span class="s4">'i1'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'v1'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'v2'</span><span class="s0">, </span><span class="s4">'f4'</span><span class="s1">)</span>
        <span class="s1">])</span>

        <span class="s1">assert_equal(res.dtype</span><span class="s0">, </span><span class="s1">expected_dtype)</span>


<span class="s0">class </span><span class="s1">TestJoinBy2:</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup(cls):</span>
        <span class="s1">cls.a = np.array(list(zip(np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">50</span><span class="s0">, </span><span class="s3">60</span><span class="s1">)</span><span class="s0">,</span>
                                  <span class="s1">np.arange(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">110</span><span class="s1">)))</span><span class="s0">,</span>
                         <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">cls.b = np.array(list(zip(np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">65</span><span class="s0">, </span><span class="s3">75</span><span class="s1">)</span><span class="s0">,</span>
                                  <span class="s1">np.arange(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">110</span><span class="s1">)))</span><span class="s0">,</span>
                         <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>

    <span class="s0">def </span><span class="s1">test_no_r1postfix(self):</span>
        <span class="s2"># Basic test of join_by no_r1postfix</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = self.a</span><span class="s0">, </span><span class="s1">self.b</span>

        <span class="s1">test = join_by(</span>
            <span class="s4">'a'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">r1postfix=</span><span class="s4">''</span><span class="s0">, </span><span class="s1">r2postfix=</span><span class="s4">'2'</span><span class="s0">, </span><span class="s1">jointype=</span><span class="s4">'inner'</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">65</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">66</span><span class="s0">, </span><span class="s3">101</span><span class="s0">, </span><span class="s3">101</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">67</span><span class="s0">, </span><span class="s3">102</span><span class="s0">, </span><span class="s3">102</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">68</span><span class="s0">, </span><span class="s3">103</span><span class="s0">, </span><span class="s3">103</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">69</span><span class="s0">, </span><span class="s3">104</span><span class="s0">, </span><span class="s3">104</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">70</span><span class="s0">, </span><span class="s3">105</span><span class="s0">, </span><span class="s3">105</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">71</span><span class="s0">, </span><span class="s3">106</span><span class="s0">, </span><span class="s3">106</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">72</span><span class="s0">, </span><span class="s3">107</span><span class="s0">, </span><span class="s3">107</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">73</span><span class="s0">, </span><span class="s3">108</span><span class="s0">, </span><span class="s3">108</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">74</span><span class="s0">, </span><span class="s3">109</span><span class="s0">, </span><span class="s3">109</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b2'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_no_postfix(self):</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">join_by</span><span class="s0">, </span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">self.a</span><span class="s0">, </span><span class="s1">self.b</span><span class="s0">,</span>
                      <span class="s1">r1postfix=</span><span class="s4">''</span><span class="s0">, </span><span class="s1">r2postfix=</span><span class="s4">''</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_no_r2postfix(self):</span>
        <span class="s2"># Basic test of join_by no_r2postfix</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = self.a</span><span class="s0">, </span><span class="s1">self.b</span>

        <span class="s1">test = join_by(</span>
            <span class="s4">'a'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">r1postfix=</span><span class="s4">'1'</span><span class="s0">, </span><span class="s1">r2postfix=</span><span class="s4">''</span><span class="s0">, </span><span class="s1">jointype=</span><span class="s4">'inner'</span><span class="s1">)</span>
        <span class="s1">control = np.array([(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">65</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">66</span><span class="s0">, </span><span class="s3">101</span><span class="s0">, </span><span class="s3">101</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">67</span><span class="s0">, </span><span class="s3">102</span><span class="s0">, </span><span class="s3">102</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">68</span><span class="s0">, </span><span class="s3">103</span><span class="s0">, </span><span class="s3">103</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">69</span><span class="s0">, </span><span class="s3">104</span><span class="s0">, </span><span class="s3">104</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">70</span><span class="s0">, </span><span class="s3">105</span><span class="s0">, </span><span class="s3">105</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">71</span><span class="s0">, </span><span class="s3">106</span><span class="s0">, </span><span class="s3">106</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">72</span><span class="s0">, </span><span class="s3">107</span><span class="s0">, </span><span class="s3">107</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">73</span><span class="s0">, </span><span class="s3">108</span><span class="s0">, </span><span class="s3">108</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">74</span><span class="s0">, </span><span class="s3">109</span><span class="s0">, </span><span class="s3">109</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b1'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'d'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

    <span class="s0">def </span><span class="s1">test_two_keys_two_vars(self):</span>
        <span class="s1">a = np.array(list(zip(np.tile([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.repeat(np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                              <span class="s1">np.arange(</span><span class="s3">50</span><span class="s0">, </span><span class="s3">60</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)))</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'k'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)])</span>

        <span class="s1">b = np.array(list(zip(np.tile([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.repeat(np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                              <span class="s1">np.arange(</span><span class="s3">65</span><span class="s0">, </span><span class="s3">75</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span><span class="s0">,</span>
                     <span class="s1">dtype=[(</span><span class="s4">'k'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c'</span><span class="s0">, </span><span class="s1">int)])</span>

        <span class="s1">control = np.array([(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">65</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">66</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">67</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">68</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">69</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">70</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">71</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">72</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">73</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">74</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'k'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'a'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'b1'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">,</span>
                                  <span class="s1">(</span><span class="s4">'b2'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c1'</span><span class="s0">, </span><span class="s1">int)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'c2'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">test = join_by(</span>
            <span class="s1">[</span><span class="s4">'a'</span><span class="s0">, </span><span class="s4">'k'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">r1postfix=</span><span class="s4">'1'</span><span class="s0">, </span><span class="s1">r2postfix=</span><span class="s4">'2'</span><span class="s0">, </span><span class="s1">jointype=</span><span class="s4">'inner'</span><span class="s1">)</span>
        <span class="s1">assert_equal(test.dtype</span><span class="s0">, </span><span class="s1">control.dtype)</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>

<span class="s0">class </span><span class="s1">TestAppendFieldsObj:</span>
    <span class="s6">&quot;&quot;&quot; 
    Test append_fields with arrays containing objects 
    &quot;&quot;&quot;</span>
    <span class="s2"># https://github.com/numpy/numpy/issues/2346</span>

    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">date</span>
        <span class="s1">self.data = dict(obj=date(</span><span class="s3">2000</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_append_to_objects(self):</span>
        <span class="s6">&quot;Test append_fields when the base array contains objects&quot;</span>
        <span class="s1">obj = self.data[</span><span class="s4">'obj'</span><span class="s1">]</span>
        <span class="s1">x = np.array([(obj</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(obj</span><span class="s0">, </span><span class="s3">2.</span><span class="s1">)]</span><span class="s0">,</span>
                      <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)])</span>
        <span class="s1">y = np.array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">test = append_fields(x</span><span class="s0">, </span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">data=y</span><span class="s0">, </span><span class="s1">usemask=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">control = np.array([(obj</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(obj</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)]</span><span class="s0">,</span>
                           <span class="s1">dtype=[(</span><span class="s4">'A'</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'B'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">'C'</span><span class="s0">, </span><span class="s1">int)])</span>
        <span class="s1">assert_equal(test</span><span class="s0">, </span><span class="s1">control)</span>
</pre>
</body>
</html>