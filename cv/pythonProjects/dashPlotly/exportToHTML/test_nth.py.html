<html>
<head>
<title>test_nth.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_nth.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
    <span class="s1">isna</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>


<span class="s0">def </span><span class="s1">test_first_last_nth(df):</span>
    <span class="s2"># tests for first / last / nth</span>
    <span class="s1">grouped = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">first = grouped.first()</span>
    <span class="s1">expected = df.loc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]]</span>
    <span class="s1">expected.index = Index([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">expected = expected.sort_index()</span>
    <span class="s1">tm.assert_frame_equal(first</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">nth = grouped.nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(nth</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">last = grouped.last()</span>
    <span class="s1">expected = df.loc[[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]]</span>
    <span class="s1">expected.index = Index([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(last</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">nth = grouped.nth(-</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(nth</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">nth = grouped.nth(</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = df.loc[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s1">]].copy()</span>
    <span class="s1">expected.index = Index([</span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">expected = expected.sort_index()</span>
    <span class="s1">tm.assert_frame_equal(nth</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s2"># it works!</span>
    <span class="s1">grouped[</span><span class="s3">&quot;B&quot;</span><span class="s1">].first()</span>
    <span class="s1">grouped[</span><span class="s3">&quot;B&quot;</span><span class="s1">].last()</span>
    <span class="s1">grouped[</span><span class="s3">&quot;B&quot;</span><span class="s1">].nth(</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">df.loc[df[</span><span class="s3">&quot;A&quot;</span><span class="s1">] == </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">] = np.nan</span>
    <span class="s0">assert </span><span class="s1">isna(grouped[</span><span class="s3">&quot;B&quot;</span><span class="s1">].first()[</span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">isna(grouped[</span><span class="s3">&quot;B&quot;</span><span class="s1">].last()[</span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">isna(grouped[</span><span class="s3">&quot;B&quot;</span><span class="s1">].nth(</span><span class="s4">0</span><span class="s1">)[</span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span>

    <span class="s2"># v0.14.0 whatsnew</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">result = g.first()</span>
    <span class="s1">expected = df.iloc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">expected = df.iloc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">result = g.nth(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;any&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;last&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_first_last_with_na_object(method</span><span class="s0">, </span><span class="s1">nulls_fixture):</span>
    <span class="s2"># https://github.com/pandas-dev/pandas/issues/32123</span>
    <span class="s1">groups = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">nulls_fixture]}).groupby(</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">result = getattr(groups</span><span class="s0">, </span><span class="s1">method)()</span>

    <span class="s0">if </span><span class="s1">method == </span><span class="s3">&quot;first&quot;</span><span class="s1">:</span>
        <span class="s1">values = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">values = [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>

    <span class="s1">values = np.array(values</span><span class="s0">, </span><span class="s1">dtype=result[</span><span class="s3">&quot;b&quot;</span><span class="s1">].dtype)</span>
    <span class="s1">idx = Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: values}</span><span class="s0">, </span><span class="s1">index=idx)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;index&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_nth_with_na_object(index</span><span class="s0">, </span><span class="s1">nulls_fixture):</span>
    <span class="s2"># https://github.com/pandas-dev/pandas/issues/32123</span>
    <span class="s1">groups = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">nulls_fixture]}).groupby(</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">result = groups.nth(index)</span>

    <span class="s0">if </span><span class="s1">index == </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s1">values = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">values = [</span><span class="s4">2</span><span class="s0">, </span><span class="s1">nulls_fixture]</span>

    <span class="s1">values = np.array(values</span><span class="s0">, </span><span class="s1">dtype=result[</span><span class="s3">&quot;b&quot;</span><span class="s1">].dtype)</span>
    <span class="s1">idx = Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: values}</span><span class="s0">, </span><span class="s1">index=idx)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;last&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_first_last_with_None(method):</span>
    <span class="s2"># https://github.com/pandas-dev/pandas/issues/32800</span>
    <span class="s2"># None should be preserved as object dtype</span>
    <span class="s1">df = DataFrame.from_dict({</span><span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s0">None</span><span class="s1">]})</span>
    <span class="s1">groups = df.groupby(</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">result = getattr(groups</span><span class="s0">, </span><span class="s1">method)()</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;last&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;df, expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s3">&quot;id&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s0">None, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">np.nan]})</span><span class="s0">,</span>
            <span class="s1">DataFrame({</span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s3">&quot;foo&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;id&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s3">&quot;id&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;value&quot;</span><span class="s1">: [np.nan]}</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">,</span>
            <span class="s1">DataFrame({</span><span class="s3">&quot;value&quot;</span><span class="s1">: [</span><span class="s0">None</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;id&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_first_last_with_None_expanded(method</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s2"># GH 32800, 38286</span>
    <span class="s1">result = getattr(df.groupby(</span><span class="s3">&quot;id&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_first_last_nth_dtypes(df_mixed_floats):</span>

    <span class="s1">df = df_mixed_floats.copy()</span>
    <span class="s1">df[</span><span class="s3">&quot;E&quot;</span><span class="s1">] = </span><span class="s0">True</span>
    <span class="s1">df[</span><span class="s3">&quot;F&quot;</span><span class="s1">] = </span><span class="s4">1</span>

    <span class="s2"># tests for first / last / nth</span>
    <span class="s1">grouped = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">first = grouped.first()</span>
    <span class="s1">expected = df.loc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;F&quot;</span><span class="s1">]]</span>
    <span class="s1">expected.index = Index([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">expected = expected.sort_index()</span>
    <span class="s1">tm.assert_frame_equal(first</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">last = grouped.last()</span>
    <span class="s1">expected = df.loc[[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;F&quot;</span><span class="s1">]]</span>
    <span class="s1">expected.index = Index([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">expected = expected.sort_index()</span>
    <span class="s1">tm.assert_frame_equal(last</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">nth = grouped.nth(</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = df.loc[[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;D&quot;</span><span class="s0">, </span><span class="s3">&quot;E&quot;</span><span class="s0">, </span><span class="s3">&quot;F&quot;</span><span class="s1">]]</span>
    <span class="s1">expected.index = Index([</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">expected = expected.sort_index()</span>
    <span class="s1">tm.assert_frame_equal(nth</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s2"># GH 2763, first/last shifting dtypes</span>
    <span class="s1">idx = list(range(</span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">idx.append(</span><span class="s4">9</span><span class="s1">)</span>
    <span class="s1">s = Series(data=range(</span><span class="s4">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=idx</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;IntCol&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s.dtype == </span><span class="s3">&quot;int64&quot;</span>
    <span class="s1">f = s.groupby(level=</span><span class="s4">0</span><span class="s1">).first()</span>
    <span class="s0">assert </span><span class="s1">f.dtype == </span><span class="s3">&quot;int64&quot;</span>


<span class="s0">def </span><span class="s1">test_first_last_nth_nan_dtype():</span>
    <span class="s2"># GH 33591</span>
    <span class="s1">df = DataFrame({</span><span class="s3">&quot;data&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;nans&quot;</span><span class="s1">: Series([np.nan]</span><span class="s0">, </span><span class="s1">dtype=object)})</span>

    <span class="s1">grouped = df.groupby(</span><span class="s3">&quot;data&quot;</span><span class="s1">)</span>
    <span class="s1">expected = df.set_index(</span><span class="s3">&quot;data&quot;</span><span class="s1">).nans</span>
    <span class="s1">tm.assert_series_equal(grouped.nans.first()</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_series_equal(grouped.nans.last()</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_series_equal(grouped.nans.nth(-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_series_equal(grouped.nans.nth(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_first_strings_timestamps():</span>
    <span class="s2"># GH 11244</span>
    <span class="s1">test = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;2012-01-01 00:00:00&quot;</span><span class="s1">): [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">Timestamp(</span><span class="s3">&quot;2012-01-02 00:00:00&quot;</span><span class="s1">): [</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;name&quot;</span><span class="s1">: [</span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;aaaa&quot;</span><span class="s1">: [</span><span class="s3">&quot;f&quot;</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">result = test.groupby(</span><span class="s3">&quot;name&quot;</span><span class="s1">).first()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=Index([Timestamp(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s3">&quot;2012-01-02&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;aaaa&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">index=Index([</span><span class="s3">&quot;e&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;name&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nth():</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(g.nth(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth(</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">1</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.loc[[]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth(-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth(-</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth(-</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.loc[[]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_series_equal(g.B.nth(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">).B.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
    <span class="s1">tm.assert_series_equal(g.B.nth(</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">).B.iloc[[</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">tm.assert_frame_equal(g[[</span><span class="s3">&quot;B&quot;</span><span class="s1">]].nth(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.loc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>

    <span class="s1">exp = df.set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(g.nth(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;any&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">exp.iloc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
    <span class="s1">tm.assert_frame_equal(g.nth(-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;any&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">exp.iloc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>

    <span class="s1">exp[</span><span class="s3">&quot;B&quot;</span><span class="s1">] = np.nan</span>
    <span class="s1">tm.assert_frame_equal(g.nth(</span><span class="s4">7</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;any&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">exp.iloc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>
    <span class="s1">tm.assert_frame_equal(g.nth(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;any&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">exp.iloc[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>

    <span class="s2"># out of bounds, regression from 0.13.1</span>
    <span class="s2"># GH 6621</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;color&quot;</span><span class="s1">: {</span><span class="s4">0</span><span class="s1">: </span><span class="s3">&quot;green&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s3">&quot;green&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: </span><span class="s3">&quot;red&quot;</span><span class="s0">, </span><span class="s4">3</span><span class="s1">: </span><span class="s3">&quot;red&quot;</span><span class="s0">, </span><span class="s4">4</span><span class="s1">: </span><span class="s3">&quot;red&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;food&quot;</span><span class="s1">: {</span><span class="s4">0</span><span class="s1">: </span><span class="s3">&quot;ham&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s3">&quot;eggs&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: </span><span class="s3">&quot;eggs&quot;</span><span class="s0">, </span><span class="s4">3</span><span class="s1">: </span><span class="s3">&quot;ham&quot;</span><span class="s0">, </span><span class="s4">4</span><span class="s1">: </span><span class="s3">&quot;pork&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;two&quot;</span><span class="s1">: {</span>
                <span class="s4">0</span><span class="s1">: </span><span class="s4">1.5456590000000001</span><span class="s0">,</span>
                <span class="s4">1</span><span class="s1">: -</span><span class="s4">0.070345000000000005</span><span class="s0">,</span>
                <span class="s4">2</span><span class="s1">: -</span><span class="s4">2.4004539999999999</span><span class="s0">,</span>
                <span class="s4">3</span><span class="s1">: </span><span class="s4">0.46206000000000003</span><span class="s0">,</span>
                <span class="s4">4</span><span class="s1">: </span><span class="s4">0.52350799999999997</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s3">&quot;one&quot;</span><span class="s1">: {</span>
                <span class="s4">0</span><span class="s1">: </span><span class="s4">0.56573799999999996</span><span class="s0">,</span>
                <span class="s4">1</span><span class="s1">: -</span><span class="s4">0.9742360000000001</span><span class="s0">,</span>
                <span class="s4">2</span><span class="s1">: </span><span class="s4">1.033801</span><span class="s0">,</span>
                <span class="s4">3</span><span class="s1">: -</span><span class="s4">0.78543499999999999</span><span class="s0">,</span>
                <span class="s4">4</span><span class="s1">: </span><span class="s4">0.70422799999999997</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">).set_index([</span><span class="s3">&quot;color&quot;</span><span class="s0">, </span><span class="s3">&quot;food&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.groupby(level=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">).nth(</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[[-</span><span class="s4">1</span><span class="s1">]]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.groupby(level=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">).nth(</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">expected = df.loc[[]]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s2"># GH 7559</span>
    <span class="s2"># from the vbench</span>
    <span class="s1">df = DataFrame(np.random.randint(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;int64&quot;</span><span class="s1">)</span>
    <span class="s1">s = df[</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">g = df[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">expected = s.groupby(g).first()</span>
    <span class="s1">expected2 = s.groupby(g).apply(</span><span class="s0">lambda </span><span class="s1">x: x.iloc[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(expected2</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">expected.name == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">expected2.name == </span><span class="s4">1</span>

    <span class="s2"># validate first</span>
    <span class="s1">v = s[g == </span><span class="s4">1</span><span class="s1">].iloc[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">expected.iloc[</span><span class="s4">0</span><span class="s1">] == v</span>
    <span class="s0">assert </span><span class="s1">expected2.iloc[</span><span class="s4">0</span><span class="s1">] == v</span>

    <span class="s2"># this is NOT the same as .first (as sorted is default!)</span>
    <span class="s2"># as it keeps the order in the series (and not the group order)</span>
    <span class="s2"># related GH 7287</span>
    <span class="s1">expected = s.groupby(g</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">).first()</span>
    <span class="s1">result = s.groupby(g</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">).nth(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;all&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;For a DataFrame&quot;</span><span class="s1">):</span>
        <span class="s1">s.groupby(g</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False</span><span class="s1">).nth(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s2"># doc example</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">result = g.B.nth(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;all&quot;</span><span class="s1">)</span>
    <span class="s1">expected = g.B.first()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s2"># test multiple nth values</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(g.nth(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth([</span><span class="s4">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth([</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth([</span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.iloc[[</span><span class="s4">2</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(g.nth([</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span><span class="s0">, </span><span class="s1">df.loc[[]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">))</span>

    <span class="s1">business_dates = pd.date_range(start=</span><span class="s3">&quot;4/1/2014&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s3">&quot;6/30/2014&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s3">&quot;B&quot;</span><span class="s1">)</span>
    <span class="s1">df = DataFrame(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">index=business_dates</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s2"># get the first, fourth and last two business days for each month</span>
    <span class="s1">key = [df.index.year</span><span class="s0">, </span><span class="s1">df.index.month]</span>
    <span class="s1">result = df.groupby(key</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">).nth([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">-</span><span class="s4">2</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">expected_dates = pd.to_datetime(</span>
        <span class="s1">[</span>
            <span class="s3">&quot;2014/4/1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/4/4&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/4/29&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/4/30&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/5/1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/5/6&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/5/29&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/5/30&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/6/2&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/6/5&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/6/27&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;2014/6/30&quot;</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=expected_dates)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nth_multi_index(three_group):</span>
    <span class="s2"># PR 9090, related to issue 8979</span>
    <span class="s2"># test nth on MultiIndex, should match .first()</span>
    <span class="s1">grouped = three_group.groupby([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">result = grouped.nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">expected = grouped.first()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;data, expected_first, expected_last&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;time&quot;</span><span class="s1">: Timestamp(</span><span class="s3">&quot;2012-02-01 14:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Central&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;time&quot;</span><span class="s1">: Timestamp(</span><span class="s3">&quot;2012-02-01 14:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Central&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;time&quot;</span><span class="s1">: Timestamp(</span><span class="s3">&quot;2012-02-01 14:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Central&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;time&quot;</span><span class="s1">: [</span>
                    <span class="s1">Timestamp(</span><span class="s3">&quot;2012-01-01 13:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;America/New_York&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">Timestamp(</span><span class="s3">&quot;2012-02-01 14:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Central&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">Timestamp(</span><span class="s3">&quot;2012-03-01 12:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Europe/London&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;time&quot;</span><span class="s1">: [</span>
                    <span class="s1">Timestamp(</span><span class="s3">&quot;2012-01-01 13:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;America/New_York&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">Timestamp(</span><span class="s3">&quot;2012-02-01 14:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Central&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s1">: [</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;time&quot;</span><span class="s1">: [</span>
                    <span class="s1">Timestamp(</span><span class="s3">&quot;2012-03-01 12:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;Europe/London&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">Timestamp(</span><span class="s3">&quot;2012-02-01 14:00:00&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Central&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_first_last_tz(data</span><span class="s0">, </span><span class="s1">expected_first</span><span class="s0">, </span><span class="s1">expected_last):</span>
    <span class="s2"># GH15884</span>
    <span class="s2"># Test that the timezone is retained when calling first</span>
    <span class="s2"># or last on groupby with as_index=False</span>

    <span class="s1">df = DataFrame(data)</span>

    <span class="s1">result = df.groupby(</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">).first()</span>
    <span class="s1">expected = DataFrame(expected_first)</span>
    <span class="s1">cols = [</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;time&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result[cols]</span><span class="s0">, </span><span class="s1">expected[cols])</span>

    <span class="s1">result = df.groupby(</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">)[</span><span class="s3">&quot;time&quot;</span><span class="s1">].first()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected[[</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;time&quot;</span><span class="s1">]])</span>

    <span class="s1">result = df.groupby(</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">).last()</span>
    <span class="s1">expected = DataFrame(expected_last)</span>
    <span class="s1">cols = [</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;time&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span>
    <span class="s1">tm.assert_frame_equal(result[cols]</span><span class="s0">, </span><span class="s1">expected[cols])</span>

    <span class="s1">result = df.groupby(</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">as_index=</span><span class="s0">False</span><span class="s1">)[</span><span class="s3">&quot;time&quot;</span><span class="s1">].last()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected[[</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s3">&quot;time&quot;</span><span class="s1">]])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;method, ts, alpha&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s3">&quot;2013-01-01&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">&quot;last&quot;</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s3">&quot;2013-01-02&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_first_last_tz_multi_column(method</span><span class="s0">, </span><span class="s1">ts</span><span class="s0">, </span><span class="s1">alpha):</span>
    <span class="s2"># GH 21603</span>
    <span class="s1">category_string = Series(list(</span><span class="s3">&quot;abc&quot;</span><span class="s1">)).astype(</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;group&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;category_string&quot;</span><span class="s1">: category_string</span><span class="s0">,</span>
            <span class="s3">&quot;datetimetz&quot;</span><span class="s1">: pd.date_range(</span><span class="s3">&quot;20130101&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">result = getattr(df.groupby(</span><span class="s3">&quot;group&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;category_string&quot;</span><span class="s1">: pd.Categorical(</span>
                <span class="s1">[alpha</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=category_string.dtype</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;datetimetz&quot;</span><span class="s1">: [ts</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s3">&quot;2013-01-03&quot;</span><span class="s0">, </span><span class="s1">tz=</span><span class="s3">&quot;US/Eastern&quot;</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;group&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;values&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">pd.array([</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;boolean&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pd.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;Int64&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pd.to_datetime([</span><span class="s3">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s3">&quot;2020-02-01&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">pd.to_timedelta([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">unit=</span><span class="s3">&quot;D&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;function&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;last&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_first_last_extension_array_keeps_dtype(values</span><span class="s0">, </span><span class="s1">function):</span>
    <span class="s2"># https://github.com/pandas-dev/pandas/issues/33071</span>
    <span class="s2"># https://github.com/pandas-dev/pandas/issues/32194</span>
    <span class="s1">df = DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: values})</span>
    <span class="s1">grouped = df.groupby(</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">idx = Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected_series = Series(values</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">index=idx)</span>
    <span class="s1">expected_frame = DataFrame({</span><span class="s3">&quot;b&quot;</span><span class="s1">: values}</span><span class="s0">, </span><span class="s1">index=idx)</span>

    <span class="s1">result_series = getattr(grouped[</span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">function)()</span>
    <span class="s1">tm.assert_series_equal(result_series</span><span class="s0">, </span><span class="s1">expected_series)</span>

    <span class="s1">result_frame = grouped.agg({</span><span class="s3">&quot;b&quot;</span><span class="s1">: function})</span>
    <span class="s1">tm.assert_frame_equal(result_frame</span><span class="s0">, </span><span class="s1">expected_frame)</span>


<span class="s0">def </span><span class="s1">test_nth_multi_index_as_expected():</span>
    <span class="s2"># PR 9090, related to issue 8979</span>
    <span class="s2"># test nth on MultiIndex</span>
    <span class="s1">three_group = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;two&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;one&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;C&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;dull&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;shiny&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">grouped = three_group.groupby([</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">result = grouped.nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">&quot;dull&quot;</span><span class="s0">, </span><span class="s3">&quot;dull&quot;</span><span class="s0">, </span><span class="s3">&quot;dull&quot;</span><span class="s0">, </span><span class="s3">&quot;dull&quot;</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=MultiIndex.from_arrays(</span>
            <span class="s1">[[</span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s0">, </span><span class="s3">&quot;one&quot;</span><span class="s0">, </span><span class="s3">&quot;two&quot;</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;op, n, expected_rows&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;columns&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;as_index&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_groupby_head_tail(op</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">expected_rows</span><span class="s0">, </span><span class="s1">columns</span><span class="s0">, </span><span class="s1">as_index):</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s1">as_index=as_index)</span>
    <span class="s1">expected = df.iloc[expected_rows]</span>
    <span class="s0">if </span><span class="s1">columns </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">g = g[columns]</span>
        <span class="s1">expected = expected[columns]</span>
    <span class="s1">result = getattr(g</span><span class="s0">, </span><span class="s1">op)(n)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;op, n, expected_cols&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;head&quot;</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;tail&quot;</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_groupby_head_tail_axis_1(op</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">expected_cols):</span>
    <span class="s2"># GH 9772</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">g = df.groupby([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = df.iloc[:</span><span class="s0">, </span><span class="s1">expected_cols]</span>
    <span class="s1">result = getattr(g</span><span class="s0">, </span><span class="s1">op)(n)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_group_selection_cache():</span>
    <span class="s2"># GH 12839 nth, head, and tail should return same result consistently</span>
    <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">])</span>
    <span class="s1">expected = df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]].set_index(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>

    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">result1 = g.head(n=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">result2 = g.nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">df)</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">result1 = g.tail(n=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">result2 = g.nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">df)</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">result1 = g.nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">result2 = g.head(n=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s1">g = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">result1 = g.nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">result2 = g.tail(n=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_nth_empty():</span>
    <span class="s2"># GH 16064</span>
    <span class="s1">df = DataFrame(index=[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">result = df.groupby(</span><span class="s3">&quot;a&quot;</span><span class="s1">).nth(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(index=Index([]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.groupby([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]).nth(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">index=MultiIndex([[]</span><span class="s0">, </span><span class="s1">[]]</span><span class="s0">, </span><span class="s1">[[]</span><span class="s0">, </span><span class="s1">[]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;c&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nth_column_order():</span>
    <span class="s2"># GH 20760</span>
    <span class="s2"># Check that nth preserves column order</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s4">50</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s4">200</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s4">150</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">).nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s4">100.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s4">200.0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.groupby(</span><span class="s3">&quot;A&quot;</span><span class="s1">).nth(-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s3">&quot;any&quot;</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s4">50.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s4">150.0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;A&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dropna&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">&quot;any&quot;</span><span class="s0">, </span><span class="s3">&quot;all&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_nth_nan_in_grouper(dropna):</span>
    <span class="s2"># GH 26011</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[np.nan</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;def&quot;</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=list(</span><span class="s3">&quot;abc&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.groupby(</span><span class="s3">&quot;a&quot;</span><span class="s1">).nth(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">dropna=dropna)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s3">&quot;bc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">&quot;abc&quot;</span><span class="s0">, </span><span class="s3">&quot;def&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_first_categorical_and_datetime_data_nat():</span>
    <span class="s2"># GH 20520</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;group&quot;</span><span class="s1">: [</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s0">, </span><span class="s3">&quot;third&quot;</span><span class="s0">, </span><span class="s3">&quot;third&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;time&quot;</span><span class="s1">: </span><span class="s4">5 </span><span class="s1">* [np.datetime64(</span><span class="s3">&quot;NaT&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s3">&quot;categories&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">&quot;category&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">result = df.groupby(</span><span class="s3">&quot;group&quot;</span><span class="s1">).first()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;time&quot;</span><span class="s1">: </span><span class="s4">3 </span><span class="s1">* [np.datetime64(</span><span class="s3">&quot;NaT&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s3">&quot;categories&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">]).astype(</span>
                <span class="s1">pd.CategoricalDtype([</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">])</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">expected.index = Index([</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;second&quot;</span><span class="s0">, </span><span class="s3">&quot;third&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;group&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_first_multi_key_groupbby_categorical():</span>
    <span class="s2"># GH 22512</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">200</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">&quot;apple&quot;</span><span class="s0">, </span><span class="s3">&quot;orange&quot;</span><span class="s0">, </span><span class="s3">&quot;mango&quot;</span><span class="s0">, </span><span class="s3">&quot;mango&quot;</span><span class="s0">, </span><span class="s3">&quot;orange&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;D&quot;</span><span class="s1">: [</span><span class="s3">&quot;jupiter&quot;</span><span class="s0">, </span><span class="s3">&quot;mercury&quot;</span><span class="s0">, </span><span class="s3">&quot;mars&quot;</span><span class="s0">, </span><span class="s3">&quot;venus&quot;</span><span class="s0">, </span><span class="s3">&quot;venus&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">df = df.astype({</span><span class="s3">&quot;D&quot;</span><span class="s1">: </span><span class="s3">&quot;category&quot;</span><span class="s1">})</span>
    <span class="s1">result = df.groupby(by=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]).first()</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">&quot;apple&quot;</span><span class="s0">, </span><span class="s3">&quot;mango&quot;</span><span class="s0">, </span><span class="s3">&quot;mango&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;D&quot;</span><span class="s1">: Series([</span><span class="s3">&quot;jupiter&quot;</span><span class="s0">, </span><span class="s3">&quot;mars&quot;</span><span class="s0">, </span><span class="s3">&quot;venus&quot;</span><span class="s1">]).astype(</span>
                <span class="s1">pd.CategoricalDtype([</span><span class="s3">&quot;jupiter&quot;</span><span class="s0">, </span><span class="s3">&quot;mars&quot;</span><span class="s0">, </span><span class="s3">&quot;mercury&quot;</span><span class="s0">, </span><span class="s3">&quot;venus&quot;</span><span class="s1">])</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">expected.index = MultiIndex.from_tuples(</span>
        <span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">200</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s3">&quot;A&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;first&quot;</span><span class="s0">, </span><span class="s3">&quot;last&quot;</span><span class="s0">, </span><span class="s3">&quot;nth&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_groupby_last_first_nth_with_none(method</span><span class="s0">, </span><span class="s1">nulls_fixture):</span>
    <span class="s2"># GH29645</span>
    <span class="s1">expected = Series([</span><span class="s3">&quot;y&quot;</span><span class="s1">])</span>
    <span class="s1">data = Series(</span>
        <span class="s1">[nulls_fixture</span><span class="s0">, </span><span class="s1">nulls_fixture</span><span class="s0">, </span><span class="s1">nulls_fixture</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s1">nulls_fixture]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">).groupby(level=</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">method == </span><span class="s3">&quot;nth&quot;</span><span class="s1">:</span>
        <span class="s1">result = getattr(data</span><span class="s0">, </span><span class="s1">method)(</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">result = getattr(data</span><span class="s0">, </span><span class="s1">method)()</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;arg, expected_rows&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[slice(</span><span class="s0">None, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s0">None, </span><span class="s1">-</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[[slice(</span><span class="s0">None, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(-</span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(-</span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_slice(slice_test_df</span><span class="s0">, </span><span class="s1">slice_test_grouped</span><span class="s0">, </span><span class="s1">arg</span><span class="s0">, </span><span class="s1">expected_rows):</span>
    <span class="s2"># Test slices     GH #42947</span>

    <span class="s1">result = slice_test_grouped.nth[arg]</span>
    <span class="s1">equivalent = slice_test_grouped.nth(arg)</span>
    <span class="s1">expected = slice_test_df.iloc[expected_rows]</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(equivalent</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nth_indexed(slice_test_df</span><span class="s0">, </span><span class="s1">slice_test_grouped):</span>
    <span class="s2"># Test index notation     GH #44688</span>

    <span class="s1">result = slice_test_grouped.nth[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">2</span><span class="s1">:]</span>
    <span class="s1">equivalent = slice_test_grouped.nth([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(-</span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)])</span>
    <span class="s1">expected = slice_test_df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]]</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(equivalent</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_invalid_argument(slice_test_grouped):</span>
    <span class="s2"># Test for error on invalid argument</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;Invalid index&quot;</span><span class="s1">):</span>
        <span class="s1">slice_test_grouped.nth(</span><span class="s4">3.14</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_negative_step(slice_test_grouped):</span>
    <span class="s2"># Test for error on negative slice step</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;Invalid step&quot;</span><span class="s1">):</span>
        <span class="s1">slice_test_grouped.nth(slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_np_ints(slice_test_df</span><span class="s0">, </span><span class="s1">slice_test_grouped):</span>
    <span class="s2"># Test np ints work</span>

    <span class="s1">result = slice_test_grouped.nth(np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]))</span>
    <span class="s1">expected = slice_test_df.iloc[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]]</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_groupby_nth_with_column_axis():</span>
    <span class="s2"># GH43926</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s3">&quot;C&quot;</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s0">, </span><span class="s3">&quot;A&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.groupby(df.iloc[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">).nth(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=[</span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">expected.columns.name = </span><span class="s3">&quot;y&quot;</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;start, stop, expected_values, expected_columns&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">None, None, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, </span><span class="s4">9</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">1</span><span class="s0">, None, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s4">1</span><span class="s0">, None, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;call&quot;</span><span class="s0">, </span><span class="s3">&quot;index&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_nth_slices_with_column_axis(</span>
    <span class="s1">start</span><span class="s0">, </span><span class="s1">stop</span><span class="s0">, </span><span class="s1">expected_values</span><span class="s0">, </span><span class="s1">expected_columns</span><span class="s0">, </span><span class="s1">method</span>
<span class="s1">):</span>
    <span class="s1">df = DataFrame([range(</span><span class="s4">5</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">columns=[list(</span><span class="s3">&quot;ABCDE&quot;</span><span class="s1">)])</span>
    <span class="s1">gb = df.groupby([</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">result = {</span>
        <span class="s3">&quot;call&quot;</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">start</span><span class="s0">, </span><span class="s1">stop: gb.nth(slice(start</span><span class="s0">, </span><span class="s1">stop))</span><span class="s0">,</span>
        <span class="s3">&quot;index&quot;</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">start</span><span class="s0">, </span><span class="s1">stop: gb.nth[start:stop]</span><span class="s0">,</span>
    <span class="s1">}[method](start</span><span class="s0">, </span><span class="s1">stop)</span>
    <span class="s1">expected = DataFrame([expected_values]</span><span class="s0">, </span><span class="s1">columns=expected_columns)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_head_tail_dropna_true():</span>
    <span class="s2"># GH#45089</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">expected = DataFrame([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.groupby([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]).head(n=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.groupby([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]).tail(n=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.groupby([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]).nth(n=</span><span class="s4">0</span><span class="s1">).reset_index()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_head_tail_dropna_false():</span>
    <span class="s2"># GH#45089</span>
    <span class="s1">df = DataFrame([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">])</span>
    <span class="s1">expected = DataFrame([[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">])</span>

    <span class="s1">result = df.groupby([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">).head(n=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.groupby([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">).tail(n=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.groupby([</span><span class="s3">&quot;X&quot;</span><span class="s0">, </span><span class="s3">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dropna=</span><span class="s0">False</span><span class="s1">).nth(n=</span><span class="s4">0</span><span class="s1">).reset_index()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>