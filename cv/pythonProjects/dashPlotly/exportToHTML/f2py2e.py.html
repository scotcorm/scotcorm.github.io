<html>
<head>
<title>f2py2e.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
f2py2e.py</font>
</center></td></tr></table>
<pre><span class="s0">#!/usr/bin/env python3</span>
<span class="s2">&quot;&quot;&quot; 
 
f2py2e - Fortran to Python C/API generator. 2nd Edition. 
         See __usage__ below. 
 
Copyright 1999--2011 Pearu Peterson all rights reserved, 
Pearu Peterson &lt;pearu@cens.ioc.ee&gt; 
Permission to use, modify, and distribute this software is given under the 
terms of the NumPy License. 
 
NO WARRANTY IS EXPRESSED OR IMPLIED.  USE AT YOUR OWN RISK. 
$Date: 2005/05/06 08:31:19 $ 
Pearu Peterson 
 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">pprint</span>
<span class="s3">import </span><span class="s1">re</span>

<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">crackfortran</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">rules</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">cb_rules</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">auxfuncs</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">cfuncs</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">f90mod_rules</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">__version__</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">capi_maps</span>

<span class="s1">f2py_version = __version__.version</span>
<span class="s1">numpy_version = __version__.version</span>
<span class="s1">errmess = sys.stderr.write</span>
<span class="s0"># outmess=sys.stdout.write</span>
<span class="s1">show = pprint.pprint</span>
<span class="s1">outmess = auxfuncs.outmess</span>

<span class="s1">__usage__ =\</span>
<span class="s4">f&quot;&quot;&quot;Usage:</span>

<span class="s4">1) To construct extension module sources:</span>

      <span class="s4">f2py [&lt;options&gt;] &lt;fortran files&gt; [[[only:]||[skip:]] </span><span class="s3">\\</span>
                                        <span class="s4">&lt;fortran functions&gt; ] </span><span class="s3">\\</span>
                                       <span class="s4">[: &lt;fortran files&gt; ...]</span>

<span class="s4">2) To compile fortran files and build extension modules:</span>

      <span class="s4">f2py -c [&lt;options&gt;, &lt;build_flib options&gt;, &lt;extra options&gt;] &lt;fortran files&gt;</span>

<span class="s4">3) To generate signature files:</span>

      <span class="s4">f2py -h &lt;filename.pyf&gt; ...&lt; same options as in (1) &gt;</span>

<span class="s4">Description: This program generates a Python C/API file (&lt;modulename&gt;module.c)</span>
             <span class="s4">that contains wrappers for given fortran functions so that they</span>
             <span class="s4">can be called from Python. With the -c option the corresponding</span>
             <span class="s4">extension modules are built.</span>

<span class="s4">Options:</span>

  <span class="s4">--2d-numpy       Use numpy.f2py tool with NumPy support. [DEFAULT]</span>
  <span class="s4">--2d-numeric     Use f2py2e tool with Numeric support.</span>
  <span class="s4">--2d-numarray    Use f2py2e tool with Numarray support.</span>
  <span class="s4">--g3-numpy       Use 3rd generation f2py from the separate f2py package.</span>
                   <span class="s4">[NOT AVAILABLE YET]</span>

  <span class="s4">-h &lt;filename&gt;    Write signatures of the fortran routines to file &lt;filename&gt;</span>
                   <span class="s4">and exit. You can then edit &lt;filename&gt; and use it instead</span>
                   <span class="s4">of &lt;fortran files&gt;. If &lt;filename&gt;==stdout then the</span>
                   <span class="s4">signatures are printed to stdout.</span>
  <span class="s4">&lt;fortran functions&gt;  Names of fortran routines for which Python C/API</span>
                   <span class="s4">functions will be generated. Default is all that are found</span>
                   <span class="s4">in &lt;fortran files&gt;.</span>
  <span class="s4">&lt;fortran files&gt;  Paths to fortran/signature files that will be scanned for</span>
                   <span class="s4">&lt;fortran functions&gt; in order to determine their signatures.</span>
  <span class="s4">skip:            Ignore fortran functions that follow until `:'.</span>
  <span class="s4">only:            Use only fortran functions that follow until `:'.</span>
  <span class="s4">:                Get back to &lt;fortran files&gt; mode.</span>

  <span class="s4">-m &lt;modulename&gt;  Name of the module; f2py generates a Python/C API</span>
                   <span class="s4">file &lt;modulename&gt;module.c or extension module &lt;modulename&gt;.</span>
                   <span class="s4">Default is 'untitled'.</span>

  <span class="s4">--[no-]lower     Do [not] lower the cases in &lt;fortran files&gt;. By default,</span>
                   <span class="s4">--lower is assumed with -h key, and --no-lower without -h key.</span>

  <span class="s4">--build-dir &lt;dirname&gt;  All f2py generated files are created in &lt;dirname&gt;.</span>
                   <span class="s4">Default is tempfile.mkdtemp().</span>

  <span class="s4">--overwrite-signature  Overwrite existing signature file.</span>

  <span class="s4">--[no-]latex-doc Create (or not) &lt;modulename&gt;module.tex.</span>
                   <span class="s4">Default is --no-latex-doc.</span>
  <span class="s4">--short-latex    Create 'incomplete' LaTeX document (without commands</span>
                   <span class="s3">\\</span><span class="s4">documentclass, </span><span class="s3">\\</span><span class="s4">tableofcontents, and </span><span class="s3">\\</span><span class="s4">begin</span><span class="s3">{{</span><span class="s4">document</span><span class="s3">}}</span><span class="s4">,</span>
                   <span class="s3">\\</span><span class="s4">end</span><span class="s3">{{</span><span class="s4">document</span><span class="s3">}}</span><span class="s4">).</span>

  <span class="s4">--[no-]rest-doc Create (or not) &lt;modulename&gt;module.rst.</span>
                   <span class="s4">Default is --no-rest-doc.</span>

  <span class="s4">--debug-capi     Create C/API code that reports the state of the wrappers</span>
                   <span class="s4">during runtime. Useful for debugging.</span>

  <span class="s4">--[no-]wrap-functions    Create Fortran subroutine wrappers to Fortran 77</span>
                   <span class="s4">functions. --wrap-functions is default because it ensures</span>
                   <span class="s4">maximum portability/compiler independence.</span>

  <span class="s4">--include-paths &lt;path1&gt;:&lt;path2&gt;:...   Search include files from the given</span>
                   <span class="s4">directories.</span>

  <span class="s4">--help-link [..] List system resources found by system_info.py. See also</span>
                   <span class="s4">--link-&lt;resource&gt; switch below. [..] is optional list</span>
                   <span class="s4">of resources names. E.g. try 'f2py --help-link lapack_opt'.</span>

  <span class="s4">--f2cmap &lt;filename&gt;  Load Fortran-to-Python KIND specification from the given</span>
                   <span class="s4">file. Default: .f2py_f2cmap in current directory.</span>

  <span class="s4">--quiet          Run quietly.</span>
  <span class="s4">--verbose        Run with extra verbosity.</span>
  <span class="s4">-v               Print f2py version ID and exit.</span>


<span class="s4">numpy.distutils options (only effective with -c):</span>

  <span class="s4">--fcompiler=         Specify Fortran compiler type by vendor</span>
  <span class="s4">--compiler=          Specify C compiler type (as defined by distutils)</span>

  <span class="s4">--help-fcompiler     List available Fortran compilers and exit</span>
  <span class="s4">--f77exec=           Specify the path to F77 compiler</span>
  <span class="s4">--f90exec=           Specify the path to F90 compiler</span>
  <span class="s4">--f77flags=          Specify F77 compiler flags</span>
  <span class="s4">--f90flags=          Specify F90 compiler flags</span>
  <span class="s4">--opt=               Specify optimization flags</span>
  <span class="s4">--arch=              Specify architecture specific optimization flags</span>
  <span class="s4">--noopt              Compile without optimization</span>
  <span class="s4">--noarch             Compile without arch-dependent optimization</span>
  <span class="s4">--debug              Compile with debugging information</span>

<span class="s4">Extra options (only effective with -c):</span>

  <span class="s4">--link-&lt;resource&gt;    Link extension module with &lt;resource&gt; as defined</span>
                       <span class="s4">by numpy.distutils/system_info.py. E.g. to link</span>
                       <span class="s4">with optimized LAPACK libraries (vecLib on MacOSX,</span>
                       <span class="s4">ATLAS elsewhere), use --link-lapack_opt.</span>
                       <span class="s4">See also --help-link switch.</span>

  <span class="s4">-L/path/to/lib/ -l&lt;libname&gt;</span>
  <span class="s4">-D&lt;define&gt; -U&lt;name&gt;</span>
  <span class="s4">-I/path/to/include/</span>
  <span class="s4">&lt;filename&gt;.o &lt;filename&gt;.so &lt;filename&gt;.a</span>

  <span class="s4">Using the following macros may be required with non-gcc Fortran</span>
  <span class="s4">compilers:</span>
    <span class="s4">-DPREPEND_FORTRAN -DNO_APPEND_FORTRAN -DUPPERCASE_FORTRAN</span>
    <span class="s4">-DUNDERSCORE_G77</span>

  <span class="s4">When using -DF2PY_REPORT_ATEXIT, a performance report of F2PY</span>
  <span class="s4">interface is printed out at exit (platforms: Linux).</span>

  <span class="s4">When using -DF2PY_REPORT_ON_ARRAY_COPY=&lt;int&gt;, a message is</span>
  <span class="s4">sent to stderr whenever F2PY interface makes a copy of an</span>
  <span class="s4">array. Integer &lt;int&gt; sets the threshold for array sizes when</span>
  <span class="s4">a message should be shown.</span>

<span class="s4">Version:     </span><span class="s3">{</span><span class="s1">f2py_version</span><span class="s3">}</span>
<span class="s4">numpy Version: </span><span class="s3">{</span><span class="s1">numpy_version</span><span class="s3">}</span>
<span class="s4">Requires:    Python 3.5 or higher.</span>
<span class="s4">License:     NumPy license (see LICENSE.txt in the NumPy source code)</span>
<span class="s4">Copyright 1999 - 2011 Pearu Peterson all rights reserved.</span>
<span class="s4">https://web.archive.org/web/20140822061353/http://cens.ioc.ee/projects/f2py2e&quot;&quot;&quot;</span>


<span class="s3">def </span><span class="s1">scaninputline(inputline):</span>
    <span class="s1">files</span><span class="s3">, </span><span class="s1">skipfuncs</span><span class="s3">, </span><span class="s1">onlyfuncs</span><span class="s3">, </span><span class="s1">debug = []</span><span class="s3">, </span><span class="s1">[]</span><span class="s3">, </span><span class="s1">[]</span><span class="s3">, </span><span class="s1">[]</span>
    <span class="s1">f</span><span class="s3">, </span><span class="s1">f2</span><span class="s3">, </span><span class="s1">f3</span><span class="s3">, </span><span class="s1">f5</span><span class="s3">, </span><span class="s1">f6</span><span class="s3">, </span><span class="s1">f7</span><span class="s3">, </span><span class="s1">f8</span><span class="s3">, </span><span class="s1">f9</span><span class="s3">, </span><span class="s1">f10 = </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>
    <span class="s1">verbose = </span><span class="s5">1</span>
    <span class="s1">dolc = -</span><span class="s5">1</span>
    <span class="s1">dolatexdoc = </span><span class="s5">0</span>
    <span class="s1">dorestdoc = </span><span class="s5">0</span>
    <span class="s1">wrapfuncs = </span><span class="s5">1</span>
    <span class="s1">buildpath = </span><span class="s4">'.'</span>
    <span class="s1">include_paths = []</span>
    <span class="s1">signsfile</span><span class="s3">, </span><span class="s1">modulename = </span><span class="s3">None, None</span>
    <span class="s1">options = {</span><span class="s4">'buildpath'</span><span class="s1">: buildpath</span><span class="s3">,</span>
               <span class="s4">'coutput'</span><span class="s1">: </span><span class="s3">None,</span>
               <span class="s4">'f2py_wrapper_output'</span><span class="s1">: </span><span class="s3">None</span><span class="s1">}</span>
    <span class="s3">for </span><span class="s1">l </span><span class="s3">in </span><span class="s1">inputline:</span>
        <span class="s3">if </span><span class="s1">l == </span><span class="s4">''</span><span class="s1">:</span>
            <span class="s3">pass</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'only:'</span><span class="s1">:</span>
            <span class="s1">f = </span><span class="s5">0</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'skip:'</span><span class="s1">:</span>
            <span class="s1">f = -</span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">':'</span><span class="s1">:</span>
            <span class="s1">f = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l[:</span><span class="s5">8</span><span class="s1">] == </span><span class="s4">'--debug-'</span><span class="s1">:</span>
            <span class="s1">debug.append(l[</span><span class="s5">8</span><span class="s1">:])</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--lower'</span><span class="s1">:</span>
            <span class="s1">dolc = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--build-dir'</span><span class="s1">:</span>
            <span class="s1">f6 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--no-lower'</span><span class="s1">:</span>
            <span class="s1">dolc = </span><span class="s5">0</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--quiet'</span><span class="s1">:</span>
            <span class="s1">verbose = </span><span class="s5">0</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--verbose'</span><span class="s1">:</span>
            <span class="s1">verbose += </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--latex-doc'</span><span class="s1">:</span>
            <span class="s1">dolatexdoc = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--no-latex-doc'</span><span class="s1">:</span>
            <span class="s1">dolatexdoc = </span><span class="s5">0</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--rest-doc'</span><span class="s1">:</span>
            <span class="s1">dorestdoc = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--no-rest-doc'</span><span class="s1">:</span>
            <span class="s1">dorestdoc = </span><span class="s5">0</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--wrap-functions'</span><span class="s1">:</span>
            <span class="s1">wrapfuncs = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--no-wrap-functions'</span><span class="s1">:</span>
            <span class="s1">wrapfuncs = </span><span class="s5">0</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--short-latex'</span><span class="s1">:</span>
            <span class="s1">options[</span><span class="s4">'shortlatex'</span><span class="s1">] = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--coutput'</span><span class="s1">:</span>
            <span class="s1">f8 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--f2py-wrapper-output'</span><span class="s1">:</span>
            <span class="s1">f9 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--f2cmap'</span><span class="s1">:</span>
            <span class="s1">f10 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--overwrite-signature'</span><span class="s1">:</span>
            <span class="s1">options[</span><span class="s4">'h-overwrite'</span><span class="s1">] = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'-h'</span><span class="s1">:</span>
            <span class="s1">f2 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'-m'</span><span class="s1">:</span>
            <span class="s1">f3 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l[:</span><span class="s5">2</span><span class="s1">] == </span><span class="s4">'-v'</span><span class="s1">:</span>
            <span class="s1">print(f2py_version)</span>
            <span class="s1">sys.exit()</span>
        <span class="s3">elif </span><span class="s1">l == </span><span class="s4">'--show-compilers'</span><span class="s1">:</span>
            <span class="s1">f5 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l[:</span><span class="s5">8</span><span class="s1">] == </span><span class="s4">'-include'</span><span class="s1">:</span>
            <span class="s1">cfuncs.outneeds[</span><span class="s4">'userincludes'</span><span class="s1">].append(l[</span><span class="s5">9</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">cfuncs.userincludes[l[</span><span class="s5">9</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]] = </span><span class="s4">'#include ' </span><span class="s1">+ l[</span><span class="s5">8</span><span class="s1">:]</span>
        <span class="s3">elif </span><span class="s1">l[:</span><span class="s5">15</span><span class="s1">] </span><span class="s3">in </span><span class="s4">'--include_paths'</span><span class="s1">:</span>
            <span class="s1">outmess(</span>
                <span class="s4">'f2py option --include_paths is deprecated, use --include-paths instead.</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">)</span>
            <span class="s1">f7 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l[:</span><span class="s5">15</span><span class="s1">] </span><span class="s3">in </span><span class="s4">'--include-paths'</span><span class="s1">:</span>
            <span class="s1">f7 = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">l[</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">'-'</span><span class="s1">:</span>
            <span class="s1">errmess(</span><span class="s4">'Unknown option %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% repr(l))</span>
            <span class="s1">sys.exit()</span>
        <span class="s3">elif </span><span class="s1">f2:</span>
            <span class="s1">f2 = </span><span class="s5">0</span>
            <span class="s1">signsfile = l</span>
        <span class="s3">elif </span><span class="s1">f3:</span>
            <span class="s1">f3 = </span><span class="s5">0</span>
            <span class="s1">modulename = l</span>
        <span class="s3">elif </span><span class="s1">f6:</span>
            <span class="s1">f6 = </span><span class="s5">0</span>
            <span class="s1">buildpath = l</span>
        <span class="s3">elif </span><span class="s1">f7:</span>
            <span class="s1">f7 = </span><span class="s5">0</span>
            <span class="s1">include_paths.extend(l.split(os.pathsep))</span>
        <span class="s3">elif </span><span class="s1">f8:</span>
            <span class="s1">f8 = </span><span class="s5">0</span>
            <span class="s1">options[</span><span class="s4">&quot;coutput&quot;</span><span class="s1">] = l</span>
        <span class="s3">elif </span><span class="s1">f9:</span>
            <span class="s1">f9 = </span><span class="s5">0</span>
            <span class="s1">options[</span><span class="s4">&quot;f2py_wrapper_output&quot;</span><span class="s1">] = l</span>
        <span class="s3">elif </span><span class="s1">f10:</span>
            <span class="s1">f10 = </span><span class="s5">0</span>
            <span class="s1">options[</span><span class="s4">&quot;f2cmap_file&quot;</span><span class="s1">] = l</span>
        <span class="s3">elif </span><span class="s1">f == </span><span class="s5">1</span><span class="s1">:</span>
            <span class="s3">try</span><span class="s1">:</span>
                <span class="s3">with </span><span class="s1">open(l):</span>
                    <span class="s3">pass</span>
                <span class="s1">files.append(l)</span>
            <span class="s3">except </span><span class="s1">OSError </span><span class="s3">as </span><span class="s1">detail:</span>
                <span class="s1">errmess(</span><span class="s4">f'OSError: </span><span class="s3">{</span><span class="s1">detail</span><span class="s3">!s}</span><span class="s4">. Skipping file &quot;</span><span class="s3">{</span><span class="s1">l</span><span class="s3">!s}</span><span class="s4">&quot;.</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">)</span>
        <span class="s3">elif </span><span class="s1">f == -</span><span class="s5">1</span><span class="s1">:</span>
            <span class="s1">skipfuncs.append(l)</span>
        <span class="s3">elif </span><span class="s1">f == </span><span class="s5">0</span><span class="s1">:</span>
            <span class="s1">onlyfuncs.append(l)</span>
    <span class="s3">if not </span><span class="s1">f5 </span><span class="s3">and not </span><span class="s1">files </span><span class="s3">and not </span><span class="s1">modulename:</span>
        <span class="s1">print(__usage__)</span>
        <span class="s1">sys.exit()</span>
    <span class="s3">if not </span><span class="s1">os.path.isdir(buildpath):</span>
        <span class="s3">if not </span><span class="s1">verbose:</span>
            <span class="s1">outmess(</span><span class="s4">'Creating build directory %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (buildpath))</span>
        <span class="s1">os.mkdir(buildpath)</span>
    <span class="s3">if </span><span class="s1">signsfile:</span>
        <span class="s1">signsfile = os.path.join(buildpath</span><span class="s3">, </span><span class="s1">signsfile)</span>
    <span class="s3">if </span><span class="s1">signsfile </span><span class="s3">and </span><span class="s1">os.path.isfile(signsfile) </span><span class="s3">and </span><span class="s4">'h-overwrite' </span><span class="s3">not in </span><span class="s1">options:</span>
        <span class="s1">errmess(</span>
            <span class="s4">'Signature file &quot;%s&quot; exists!!! Use --overwrite-signature to overwrite.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (signsfile))</span>
        <span class="s1">sys.exit()</span>

    <span class="s1">options[</span><span class="s4">'debug'</span><span class="s1">] = debug</span>
    <span class="s1">options[</span><span class="s4">'verbose'</span><span class="s1">] = verbose</span>
    <span class="s3">if </span><span class="s1">dolc == -</span><span class="s5">1 </span><span class="s3">and not </span><span class="s1">signsfile:</span>
        <span class="s1">options[</span><span class="s4">'do-lower'</span><span class="s1">] = </span><span class="s5">0</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">options[</span><span class="s4">'do-lower'</span><span class="s1">] = dolc</span>
    <span class="s3">if </span><span class="s1">modulename:</span>
        <span class="s1">options[</span><span class="s4">'module'</span><span class="s1">] = modulename</span>
    <span class="s3">if </span><span class="s1">signsfile:</span>
        <span class="s1">options[</span><span class="s4">'signsfile'</span><span class="s1">] = signsfile</span>
    <span class="s3">if </span><span class="s1">onlyfuncs:</span>
        <span class="s1">options[</span><span class="s4">'onlyfuncs'</span><span class="s1">] = onlyfuncs</span>
    <span class="s3">if </span><span class="s1">skipfuncs:</span>
        <span class="s1">options[</span><span class="s4">'skipfuncs'</span><span class="s1">] = skipfuncs</span>
    <span class="s1">options[</span><span class="s4">'dolatexdoc'</span><span class="s1">] = dolatexdoc</span>
    <span class="s1">options[</span><span class="s4">'dorestdoc'</span><span class="s1">] = dorestdoc</span>
    <span class="s1">options[</span><span class="s4">'wrapfuncs'</span><span class="s1">] = wrapfuncs</span>
    <span class="s1">options[</span><span class="s4">'buildpath'</span><span class="s1">] = buildpath</span>
    <span class="s1">options[</span><span class="s4">'include_paths'</span><span class="s1">] = include_paths</span>
    <span class="s1">options.setdefault(</span><span class="s4">'f2cmap_file'</span><span class="s3">, None</span><span class="s1">)</span>
    <span class="s3">return </span><span class="s1">files</span><span class="s3">, </span><span class="s1">options</span>


<span class="s3">def </span><span class="s1">callcrackfortran(files</span><span class="s3">, </span><span class="s1">options):</span>
    <span class="s1">rules.options = options</span>
    <span class="s1">crackfortran.debug = options[</span><span class="s4">'debug'</span><span class="s1">]</span>
    <span class="s1">crackfortran.verbose = options[</span><span class="s4">'verbose'</span><span class="s1">]</span>
    <span class="s3">if </span><span class="s4">'module' </span><span class="s3">in </span><span class="s1">options:</span>
        <span class="s1">crackfortran.f77modulename = options[</span><span class="s4">'module'</span><span class="s1">]</span>
    <span class="s3">if </span><span class="s4">'skipfuncs' </span><span class="s3">in </span><span class="s1">options:</span>
        <span class="s1">crackfortran.skipfuncs = options[</span><span class="s4">'skipfuncs'</span><span class="s1">]</span>
    <span class="s3">if </span><span class="s4">'onlyfuncs' </span><span class="s3">in </span><span class="s1">options:</span>
        <span class="s1">crackfortran.onlyfuncs = options[</span><span class="s4">'onlyfuncs'</span><span class="s1">]</span>
    <span class="s1">crackfortran.include_paths[:] = options[</span><span class="s4">'include_paths'</span><span class="s1">]</span>
    <span class="s1">crackfortran.dolowercase = options[</span><span class="s4">'do-lower'</span><span class="s1">]</span>
    <span class="s1">postlist = crackfortran.crackfortran(files)</span>
    <span class="s3">if </span><span class="s4">'signsfile' </span><span class="s3">in </span><span class="s1">options:</span>
        <span class="s1">outmess(</span><span class="s4">'Saving signatures to file &quot;%s&quot;</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (options[</span><span class="s4">'signsfile'</span><span class="s1">]))</span>
        <span class="s1">pyf = crackfortran.crack2fortran(postlist)</span>
        <span class="s3">if </span><span class="s1">options[</span><span class="s4">'signsfile'</span><span class="s1">][-</span><span class="s5">6</span><span class="s1">:] == </span><span class="s4">'stdout'</span><span class="s1">:</span>
            <span class="s1">sys.stdout.write(pyf)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">with </span><span class="s1">open(options[</span><span class="s4">'signsfile'</span><span class="s1">]</span><span class="s3">, </span><span class="s4">'w'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
                <span class="s1">f.write(pyf)</span>
    <span class="s3">if </span><span class="s1">options[</span><span class="s4">&quot;coutput&quot;</span><span class="s1">] </span><span class="s3">is None</span><span class="s1">:</span>
        <span class="s3">for </span><span class="s1">mod </span><span class="s3">in </span><span class="s1">postlist:</span>
            <span class="s1">mod[</span><span class="s4">&quot;coutput&quot;</span><span class="s1">] = </span><span class="s4">&quot;%smodule.c&quot; </span><span class="s1">% mod[</span><span class="s4">&quot;name&quot;</span><span class="s1">]</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">for </span><span class="s1">mod </span><span class="s3">in </span><span class="s1">postlist:</span>
            <span class="s1">mod[</span><span class="s4">&quot;coutput&quot;</span><span class="s1">] = options[</span><span class="s4">&quot;coutput&quot;</span><span class="s1">]</span>
    <span class="s3">if </span><span class="s1">options[</span><span class="s4">&quot;f2py_wrapper_output&quot;</span><span class="s1">] </span><span class="s3">is None</span><span class="s1">:</span>
        <span class="s3">for </span><span class="s1">mod </span><span class="s3">in </span><span class="s1">postlist:</span>
            <span class="s1">mod[</span><span class="s4">&quot;f2py_wrapper_output&quot;</span><span class="s1">] = </span><span class="s4">&quot;%s-f2pywrappers.f&quot; </span><span class="s1">% mod[</span><span class="s4">&quot;name&quot;</span><span class="s1">]</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">for </span><span class="s1">mod </span><span class="s3">in </span><span class="s1">postlist:</span>
            <span class="s1">mod[</span><span class="s4">&quot;f2py_wrapper_output&quot;</span><span class="s1">] = options[</span><span class="s4">&quot;f2py_wrapper_output&quot;</span><span class="s1">]</span>
    <span class="s3">return </span><span class="s1">postlist</span>


<span class="s3">def </span><span class="s1">buildmodules(lst):</span>
    <span class="s1">cfuncs.buildcfuncs()</span>
    <span class="s1">outmess(</span><span class="s4">'Building modules...</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">)</span>
    <span class="s1">modules</span><span class="s3">, </span><span class="s1">mnames</span><span class="s3">, </span><span class="s1">isusedby = []</span><span class="s3">, </span><span class="s1">[]</span><span class="s3">, </span><span class="s1">{}</span>
    <span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">lst:</span>
        <span class="s3">if </span><span class="s4">'__user__' </span><span class="s3">in </span><span class="s1">item[</span><span class="s4">'name'</span><span class="s1">]:</span>
            <span class="s1">cb_rules.buildcallbacks(item)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s4">'use' </span><span class="s3">in </span><span class="s1">item:</span>
                <span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">item[</span><span class="s4">'use'</span><span class="s1">].keys():</span>
                    <span class="s3">if </span><span class="s1">u </span><span class="s3">not in </span><span class="s1">isusedby:</span>
                        <span class="s1">isusedby[u] = []</span>
                    <span class="s1">isusedby[u].append(item[</span><span class="s4">'name'</span><span class="s1">])</span>
            <span class="s1">modules.append(item)</span>
            <span class="s1">mnames.append(item[</span><span class="s4">'name'</span><span class="s1">])</span>
    <span class="s1">ret = {}</span>
    <span class="s3">for </span><span class="s1">module</span><span class="s3">, </span><span class="s1">name </span><span class="s3">in </span><span class="s1">zip(modules</span><span class="s3">, </span><span class="s1">mnames):</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">isusedby:</span>
            <span class="s1">outmess(</span><span class="s4">'</span><span class="s3">\t</span><span class="s4">Skipping module &quot;%s&quot; which is used by %s.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (</span>
                <span class="s1">name</span><span class="s3">, </span><span class="s4">','</span><span class="s1">.join(</span><span class="s4">'&quot;%s&quot;' </span><span class="s1">% s </span><span class="s3">for </span><span class="s1">s </span><span class="s3">in </span><span class="s1">isusedby[name])))</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">um = []</span>
            <span class="s3">if </span><span class="s4">'use' </span><span class="s3">in </span><span class="s1">module:</span>
                <span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">module[</span><span class="s4">'use'</span><span class="s1">].keys():</span>
                    <span class="s3">if </span><span class="s1">u </span><span class="s3">in </span><span class="s1">isusedby </span><span class="s3">and </span><span class="s1">u </span><span class="s3">in </span><span class="s1">mnames:</span>
                        <span class="s1">um.append(modules[mnames.index(u)])</span>
                    <span class="s3">else</span><span class="s1">:</span>
                        <span class="s1">outmess(</span>
                            <span class="s4">f'</span><span class="s3">\t</span><span class="s4">Module &quot;</span><span class="s3">{</span><span class="s1">name</span><span class="s3">}</span><span class="s4">&quot; uses nonexisting &quot;</span><span class="s3">{</span><span class="s1">u</span><span class="s3">}</span><span class="s4">&quot; '</span>
                            <span class="s4">'which will be ignored.</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">)</span>
            <span class="s1">ret[name] = {}</span>
            <span class="s1">dict_append(ret[name]</span><span class="s3">, </span><span class="s1">rules.buildmodule(module</span><span class="s3">, </span><span class="s1">um))</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">dict_append(d_out</span><span class="s3">, </span><span class="s1">d_in):</span>
    <span class="s3">for </span><span class="s1">(k</span><span class="s3">, </span><span class="s1">v) </span><span class="s3">in </span><span class="s1">d_in.items():</span>
        <span class="s3">if </span><span class="s1">k </span><span class="s3">not in </span><span class="s1">d_out:</span>
            <span class="s1">d_out[k] = []</span>
        <span class="s3">if </span><span class="s1">isinstance(v</span><span class="s3">, </span><span class="s1">list):</span>
            <span class="s1">d_out[k] = d_out[k] + v</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">d_out[k].append(v)</span>


<span class="s3">def </span><span class="s1">run_main(comline_list):</span>
    <span class="s2">&quot;&quot;&quot; 
    Equivalent to running:: 
 
        f2py &lt;args&gt; 
 
    where ``&lt;args&gt;=string.join(&lt;list&gt;,' ')``, but in Python.  Unless 
    ``-h`` is used, this function returns a dictionary containing 
    information on generated modules and their dependencies on source 
    files.  For example, the command ``f2py -m scalar scalar.f`` can be 
    executed from Python as follows 
 
    You cannot build extension modules with this function, that is, 
    using ``-c`` is not allowed. Use ``compile`` command instead 
 
    Examples 
    -------- 
    .. literalinclude:: ../../source/f2py/code/results/run_main_session.dat 
        :language: python 
 
    &quot;&quot;&quot;</span>
    <span class="s1">crackfortran.reset_global_f2py_vars()</span>
    <span class="s1">f2pydir = os.path.dirname(os.path.abspath(cfuncs.__file__))</span>
    <span class="s1">fobjhsrc = os.path.join(f2pydir</span><span class="s3">, </span><span class="s4">'src'</span><span class="s3">, </span><span class="s4">'fortranobject.h'</span><span class="s1">)</span>
    <span class="s1">fobjcsrc = os.path.join(f2pydir</span><span class="s3">, </span><span class="s4">'src'</span><span class="s3">, </span><span class="s4">'fortranobject.c'</span><span class="s1">)</span>
    <span class="s1">files</span><span class="s3">, </span><span class="s1">options = scaninputline(comline_list)</span>
    <span class="s1">auxfuncs.options = options</span>
    <span class="s1">capi_maps.load_f2cmap_file(options[</span><span class="s4">'f2cmap_file'</span><span class="s1">])</span>
    <span class="s1">postlist = callcrackfortran(files</span><span class="s3">, </span><span class="s1">options)</span>
    <span class="s1">isusedby = {}</span>
    <span class="s3">for </span><span class="s1">plist </span><span class="s3">in </span><span class="s1">postlist:</span>
        <span class="s3">if </span><span class="s4">'use' </span><span class="s3">in </span><span class="s1">plist:</span>
            <span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">plist[</span><span class="s4">'use'</span><span class="s1">].keys():</span>
                <span class="s3">if </span><span class="s1">u </span><span class="s3">not in </span><span class="s1">isusedby:</span>
                    <span class="s1">isusedby[u] = []</span>
                <span class="s1">isusedby[u].append(plist[</span><span class="s4">'name'</span><span class="s1">])</span>
    <span class="s3">for </span><span class="s1">plist </span><span class="s3">in </span><span class="s1">postlist:</span>
        <span class="s3">if </span><span class="s1">plist[</span><span class="s4">'block'</span><span class="s1">] == </span><span class="s4">'python module' </span><span class="s3">and </span><span class="s4">'__user__' </span><span class="s3">in </span><span class="s1">plist[</span><span class="s4">'name'</span><span class="s1">]:</span>
            <span class="s3">if </span><span class="s1">plist[</span><span class="s4">'name'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">isusedby:</span>
                <span class="s0"># if not quiet:</span>
                <span class="s1">outmess(</span>
                    <span class="s4">f'Skipping Makefile build for module &quot;</span><span class="s3">{</span><span class="s1">plist[</span><span class="s4">&quot;name&quot;</span><span class="s1">]</span><span class="s3">}</span><span class="s4">&quot; '</span>
                    <span class="s4">'which is used by {}</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">.format(</span>
                        <span class="s4">','</span><span class="s1">.join(</span><span class="s4">f'&quot;</span><span class="s3">{</span><span class="s1">s</span><span class="s3">}</span><span class="s4">&quot;' </span><span class="s3">for </span><span class="s1">s </span><span class="s3">in </span><span class="s1">isusedby[plist[</span><span class="s4">'name'</span><span class="s1">]])))</span>
    <span class="s3">if </span><span class="s4">'signsfile' </span><span class="s3">in </span><span class="s1">options:</span>
        <span class="s3">if </span><span class="s1">options[</span><span class="s4">'verbose'</span><span class="s1">] &gt; </span><span class="s5">1</span><span class="s1">:</span>
            <span class="s1">outmess(</span>
                <span class="s4">'Stopping. Edit the signature file and then run f2py on the signature file: '</span><span class="s1">)</span>
            <span class="s1">outmess(</span><span class="s4">'%s %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">%</span>
                    <span class="s1">(os.path.basename(sys.argv[</span><span class="s5">0</span><span class="s1">])</span><span class="s3">, </span><span class="s1">options[</span><span class="s4">'signsfile'</span><span class="s1">]))</span>
        <span class="s3">return</span>
    <span class="s3">for </span><span class="s1">plist </span><span class="s3">in </span><span class="s1">postlist:</span>
        <span class="s3">if </span><span class="s1">plist[</span><span class="s4">'block'</span><span class="s1">] != </span><span class="s4">'python module'</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s4">'python module' </span><span class="s3">not in </span><span class="s1">options:</span>
                <span class="s1">errmess(</span>
                    <span class="s4">'Tip: If your original code is Fortran source then you must use -m option.</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">)</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">'All blocks must be python module blocks but got %s' </span><span class="s1">% (</span>
                <span class="s1">repr(postlist[i][</span><span class="s4">'block'</span><span class="s1">])))</span>
    <span class="s1">auxfuncs.debugoptions = options[</span><span class="s4">'debug'</span><span class="s1">]</span>
    <span class="s1">f90mod_rules.options = options</span>
    <span class="s1">auxfuncs.wrapfuncs = options[</span><span class="s4">'wrapfuncs'</span><span class="s1">]</span>

    <span class="s1">ret = buildmodules(postlist)</span>

    <span class="s3">for </span><span class="s1">mn </span><span class="s3">in </span><span class="s1">ret.keys():</span>
        <span class="s1">dict_append(ret[mn]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'csrc'</span><span class="s1">: fobjcsrc</span><span class="s3">, </span><span class="s4">'h'</span><span class="s1">: fobjhsrc})</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">filter_files(prefix</span><span class="s3">, </span><span class="s1">suffix</span><span class="s3">, </span><span class="s1">files</span><span class="s3">, </span><span class="s1">remove_prefix=</span><span class="s3">None</span><span class="s1">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Filter files by prefix and suffix. 
    &quot;&quot;&quot;</span>
    <span class="s1">filtered</span><span class="s3">, </span><span class="s1">rest = []</span><span class="s3">, </span><span class="s1">[]</span>
    <span class="s1">match = re.compile(prefix + </span><span class="s4">r'.*' </span><span class="s1">+ suffix + </span><span class="s4">r'\Z'</span><span class="s1">).match</span>
    <span class="s3">if </span><span class="s1">remove_prefix:</span>
        <span class="s1">ind = len(prefix)</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ind = </span><span class="s5">0</span>
    <span class="s3">for </span><span class="s1">file </span><span class="s3">in </span><span class="s1">[x.strip() </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">files]:</span>
        <span class="s3">if </span><span class="s1">match(file):</span>
            <span class="s1">filtered.append(file[ind:])</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">rest.append(file)</span>
    <span class="s3">return </span><span class="s1">filtered</span><span class="s3">, </span><span class="s1">rest</span>


<span class="s3">def </span><span class="s1">get_prefix(module):</span>
    <span class="s1">p = os.path.dirname(os.path.dirname(module.__file__))</span>
    <span class="s3">return </span><span class="s1">p</span>


<span class="s3">def </span><span class="s1">run_compile():</span>
    <span class="s2">&quot;&quot;&quot; 
    Do it all in one call! 
    &quot;&quot;&quot;</span>
    <span class="s3">import </span><span class="s1">tempfile</span>

    <span class="s1">i = sys.argv.index(</span><span class="s4">'-c'</span><span class="s1">)</span>
    <span class="s3">del </span><span class="s1">sys.argv[i]</span>

    <span class="s1">remove_build_dir = </span><span class="s5">0</span>
    <span class="s3">try</span><span class="s1">:</span>
        <span class="s1">i = sys.argv.index(</span><span class="s4">'--build-dir'</span><span class="s1">)</span>
    <span class="s3">except </span><span class="s1">ValueError:</span>
        <span class="s1">i = </span><span class="s3">None</span>
    <span class="s3">if </span><span class="s1">i </span><span class="s3">is not None</span><span class="s1">:</span>
        <span class="s1">build_dir = sys.argv[i + </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s3">del </span><span class="s1">sys.argv[i + </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s3">del </span><span class="s1">sys.argv[i]</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">remove_build_dir = </span><span class="s5">1</span>
        <span class="s1">build_dir = tempfile.mkdtemp()</span>

    <span class="s1">_reg1 = re.compile(</span><span class="s4">r'--link-'</span><span class="s1">)</span>
    <span class="s1">sysinfo_flags = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:] </span><span class="s3">if </span><span class="s1">_reg1.match(_m)]</span>
    <span class="s1">sys.argv = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv </span><span class="s3">if </span><span class="s1">_m </span><span class="s3">not in </span><span class="s1">sysinfo_flags]</span>
    <span class="s3">if </span><span class="s1">sysinfo_flags:</span>
        <span class="s1">sysinfo_flags = [f[</span><span class="s5">7</span><span class="s1">:] </span><span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">sysinfo_flags]</span>

    <span class="s1">_reg2 = re.compile(</span>
        <span class="s4">r'--((no-|)(wrap-functions|lower)|debug-capi|quiet)|-include'</span><span class="s1">)</span>
    <span class="s1">f2py_flags = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:] </span><span class="s3">if </span><span class="s1">_reg2.match(_m)]</span>
    <span class="s1">sys.argv = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv </span><span class="s3">if </span><span class="s1">_m </span><span class="s3">not in </span><span class="s1">f2py_flags]</span>
    <span class="s1">f2py_flags2 = []</span>
    <span class="s1">fl = </span><span class="s5">0</span>
    <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:]:</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">[</span><span class="s4">'only:'</span><span class="s3">, </span><span class="s4">'skip:'</span><span class="s1">]:</span>
            <span class="s1">fl = </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">a == </span><span class="s4">':'</span><span class="s1">:</span>
            <span class="s1">fl = </span><span class="s5">0</span>
        <span class="s3">if </span><span class="s1">fl </span><span class="s3">or </span><span class="s1">a == </span><span class="s4">':'</span><span class="s1">:</span>
            <span class="s1">f2py_flags2.append(a)</span>
    <span class="s3">if </span><span class="s1">f2py_flags2 </span><span class="s3">and </span><span class="s1">f2py_flags2[-</span><span class="s5">1</span><span class="s1">] != </span><span class="s4">':'</span><span class="s1">:</span>
        <span class="s1">f2py_flags2.append(</span><span class="s4">':'</span><span class="s1">)</span>
    <span class="s1">f2py_flags.extend(f2py_flags2)</span>

    <span class="s1">sys.argv = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv </span><span class="s3">if </span><span class="s1">_m </span><span class="s3">not in </span><span class="s1">f2py_flags2]</span>
    <span class="s1">_reg3 = re.compile(</span>
        <span class="s4">r'--((f(90)?compiler(-exec|)|compiler)=|help-compiler)'</span><span class="s1">)</span>
    <span class="s1">flib_flags = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:] </span><span class="s3">if </span><span class="s1">_reg3.match(_m)]</span>
    <span class="s1">sys.argv = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv </span><span class="s3">if </span><span class="s1">_m </span><span class="s3">not in </span><span class="s1">flib_flags]</span>
    <span class="s1">_reg4 = re.compile(</span>
        <span class="s4">r'--((f(77|90)(flags|exec)|opt|arch)=|(debug|noopt|noarch|help-fcompiler))'</span><span class="s1">)</span>
    <span class="s1">fc_flags = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:] </span><span class="s3">if </span><span class="s1">_reg4.match(_m)]</span>
    <span class="s1">sys.argv = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv </span><span class="s3">if </span><span class="s1">_m </span><span class="s3">not in </span><span class="s1">fc_flags]</span>

    <span class="s1">del_list = []</span>
    <span class="s3">for </span><span class="s1">s </span><span class="s3">in </span><span class="s1">flib_flags:</span>
        <span class="s1">v = </span><span class="s4">'--fcompiler='</span>
        <span class="s3">if </span><span class="s1">s[:len(v)] == v:</span>
            <span class="s3">from </span><span class="s1">numpy.distutils </span><span class="s3">import </span><span class="s1">fcompiler</span>
            <span class="s1">fcompiler.load_all_fcompiler_classes()</span>
            <span class="s1">allowed_keys = list(fcompiler.fcompiler_class.keys())</span>
            <span class="s1">nv = ov = s[len(v):].lower()</span>
            <span class="s3">if </span><span class="s1">ov </span><span class="s3">not in </span><span class="s1">allowed_keys:</span>
                <span class="s1">vmap = {}  </span><span class="s0"># XXX</span>
                <span class="s3">try</span><span class="s1">:</span>
                    <span class="s1">nv = vmap[ov]</span>
                <span class="s3">except </span><span class="s1">KeyError:</span>
                    <span class="s3">if </span><span class="s1">ov </span><span class="s3">not in </span><span class="s1">vmap.values():</span>
                        <span class="s1">print(</span><span class="s4">'Unknown vendor: &quot;%s&quot;' </span><span class="s1">% (s[len(v):]))</span>
                <span class="s1">nv = ov</span>
            <span class="s1">i = flib_flags.index(s)</span>
            <span class="s1">flib_flags[i] = </span><span class="s4">'--fcompiler=' </span><span class="s1">+ nv</span>
            <span class="s3">continue</span>
    <span class="s3">for </span><span class="s1">s </span><span class="s3">in </span><span class="s1">del_list:</span>
        <span class="s1">i = flib_flags.index(s)</span>
        <span class="s3">del </span><span class="s1">flib_flags[i]</span>
    <span class="s3">assert </span><span class="s1">len(flib_flags) &lt;= </span><span class="s5">2</span><span class="s3">, </span><span class="s1">repr(flib_flags)</span>

    <span class="s1">_reg5 = re.compile(</span><span class="s4">r'--(verbose)'</span><span class="s1">)</span>
    <span class="s1">setup_flags = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:] </span><span class="s3">if </span><span class="s1">_reg5.match(_m)]</span>
    <span class="s1">sys.argv = [_m </span><span class="s3">for </span><span class="s1">_m </span><span class="s3">in </span><span class="s1">sys.argv </span><span class="s3">if </span><span class="s1">_m </span><span class="s3">not in </span><span class="s1">setup_flags]</span>

    <span class="s3">if </span><span class="s4">'--quiet' </span><span class="s3">in </span><span class="s1">f2py_flags:</span>
        <span class="s1">setup_flags.append(</span><span class="s4">'--quiet'</span><span class="s1">)</span>

    <span class="s1">modulename = </span><span class="s4">'untitled'</span>
    <span class="s1">sources = sys.argv[</span><span class="s5">1</span><span class="s1">:]</span>

    <span class="s3">for </span><span class="s1">optname </span><span class="s3">in </span><span class="s1">[</span><span class="s4">'--include_paths'</span><span class="s3">, </span><span class="s4">'--include-paths'</span><span class="s3">, </span><span class="s4">'--f2cmap'</span><span class="s1">]:</span>
        <span class="s3">if </span><span class="s1">optname </span><span class="s3">in </span><span class="s1">sys.argv:</span>
            <span class="s1">i = sys.argv.index(optname)</span>
            <span class="s1">f2py_flags.extend(sys.argv[i:i + </span><span class="s5">2</span><span class="s1">])</span>
            <span class="s3">del </span><span class="s1">sys.argv[i + </span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">sys.argv[i]</span>
            <span class="s1">sources = sys.argv[</span><span class="s5">1</span><span class="s1">:]</span>

    <span class="s3">if </span><span class="s4">'-m' </span><span class="s3">in </span><span class="s1">sys.argv:</span>
        <span class="s1">i = sys.argv.index(</span><span class="s4">'-m'</span><span class="s1">)</span>
        <span class="s1">modulename = sys.argv[i + </span><span class="s5">1</span><span class="s1">]</span>
        <span class="s3">del </span><span class="s1">sys.argv[i + </span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">sys.argv[i]</span>
        <span class="s1">sources = sys.argv[</span><span class="s5">1</span><span class="s1">:]</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">from </span><span class="s1">numpy.distutils.command.build_src </span><span class="s3">import </span><span class="s1">get_f2py_modulename</span>
        <span class="s1">pyf_files</span><span class="s3">, </span><span class="s1">sources = filter_files(</span><span class="s4">''</span><span class="s3">, </span><span class="s4">'[.]pyf([.]src|)'</span><span class="s3">, </span><span class="s1">sources)</span>
        <span class="s1">sources = pyf_files + sources</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">pyf_files:</span>
            <span class="s1">modulename = get_f2py_modulename(f)</span>
            <span class="s3">if </span><span class="s1">modulename:</span>
                <span class="s3">break</span>

    <span class="s1">extra_objects</span><span class="s3">, </span><span class="s1">sources = filter_files(</span><span class="s4">''</span><span class="s3">, </span><span class="s4">'[.](o|a|so|dylib)'</span><span class="s3">, </span><span class="s1">sources)</span>
    <span class="s1">include_dirs</span><span class="s3">, </span><span class="s1">sources = filter_files(</span><span class="s4">'-I'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">remove_prefix=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">library_dirs</span><span class="s3">, </span><span class="s1">sources = filter_files(</span><span class="s4">'-L'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">remove_prefix=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">libraries</span><span class="s3">, </span><span class="s1">sources = filter_files(</span><span class="s4">'-l'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">remove_prefix=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">undef_macros</span><span class="s3">, </span><span class="s1">sources = filter_files(</span><span class="s4">'-U'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">remove_prefix=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">define_macros</span><span class="s3">, </span><span class="s1">sources = filter_files(</span><span class="s4">'-D'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">, </span><span class="s1">remove_prefix=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(len(define_macros)):</span>
        <span class="s1">name_value = define_macros[i].split(</span><span class="s4">'='</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">len(name_value) == </span><span class="s5">1</span><span class="s1">:</span>
            <span class="s1">name_value.append(</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">len(name_value) == </span><span class="s5">2</span><span class="s1">:</span>
            <span class="s1">define_macros[i] = tuple(name_value)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">print(</span><span class="s4">'Invalid use of -D:'</span><span class="s3">, </span><span class="s1">name_value)</span>

    <span class="s3">from </span><span class="s1">numpy.distutils.system_info </span><span class="s3">import </span><span class="s1">get_info</span>

    <span class="s1">num_info = {}</span>
    <span class="s3">if </span><span class="s1">num_info:</span>
        <span class="s1">include_dirs.extend(num_info.get(</span><span class="s4">'include_dirs'</span><span class="s3">, </span><span class="s1">[]))</span>

    <span class="s3">from </span><span class="s1">numpy.distutils.core </span><span class="s3">import </span><span class="s1">setup</span><span class="s3">, </span><span class="s1">Extension</span>
    <span class="s1">ext_args = {</span><span class="s4">'name'</span><span class="s1">: modulename</span><span class="s3">, </span><span class="s4">'sources'</span><span class="s1">: sources</span><span class="s3">,</span>
                <span class="s4">'include_dirs'</span><span class="s1">: include_dirs</span><span class="s3">,</span>
                <span class="s4">'library_dirs'</span><span class="s1">: library_dirs</span><span class="s3">,</span>
                <span class="s4">'libraries'</span><span class="s1">: libraries</span><span class="s3">,</span>
                <span class="s4">'define_macros'</span><span class="s1">: define_macros</span><span class="s3">,</span>
                <span class="s4">'undef_macros'</span><span class="s1">: undef_macros</span><span class="s3">,</span>
                <span class="s4">'extra_objects'</span><span class="s1">: extra_objects</span><span class="s3">,</span>
                <span class="s4">'f2py_options'</span><span class="s1">: f2py_flags</span><span class="s3">,</span>
                <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">sysinfo_flags:</span>
        <span class="s3">from </span><span class="s1">numpy.distutils.misc_util </span><span class="s3">import </span><span class="s1">dict_append</span>
        <span class="s3">for </span><span class="s1">n </span><span class="s3">in </span><span class="s1">sysinfo_flags:</span>
            <span class="s1">i = get_info(n)</span>
            <span class="s3">if not </span><span class="s1">i:</span>
                <span class="s1">outmess(</span><span class="s4">'No %s resources found in system'</span>
                        <span class="s4">' (try `f2py --help-link`)</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (repr(n)))</span>
            <span class="s1">dict_append(ext_args</span><span class="s3">, </span><span class="s1">**i)</span>

    <span class="s1">ext = Extension(**ext_args)</span>
    <span class="s1">sys.argv = [sys.argv[</span><span class="s5">0</span><span class="s1">]] + setup_flags</span>
    <span class="s1">sys.argv.extend([</span><span class="s4">'build'</span><span class="s3">,</span>
                     <span class="s4">'--build-temp'</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">,</span>
                     <span class="s4">'--build-base'</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">,</span>
                     <span class="s4">'--build-platlib'</span><span class="s3">, </span><span class="s4">'.'</span><span class="s3">,</span>
                     <span class="s0"># disable CCompilerOpt</span>
                     <span class="s4">'--disable-optimization'</span><span class="s1">])</span>
    <span class="s3">if </span><span class="s1">fc_flags:</span>
        <span class="s1">sys.argv.extend([</span><span class="s4">'config_fc'</span><span class="s1">] + fc_flags)</span>
    <span class="s3">if </span><span class="s1">flib_flags:</span>
        <span class="s1">sys.argv.extend([</span><span class="s4">'build_ext'</span><span class="s1">] + flib_flags)</span>

    <span class="s1">setup(ext_modules=[ext])</span>

    <span class="s3">if </span><span class="s1">remove_build_dir </span><span class="s3">and </span><span class="s1">os.path.exists(build_dir):</span>
        <span class="s3">import </span><span class="s1">shutil</span>
        <span class="s1">outmess(</span><span class="s4">'Removing build directory %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (build_dir))</span>
        <span class="s1">shutil.rmtree(build_dir)</span>


<span class="s3">def </span><span class="s1">main():</span>
    <span class="s3">if </span><span class="s4">'--help-link' </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:]:</span>
        <span class="s1">sys.argv.remove(</span><span class="s4">'--help-link'</span><span class="s1">)</span>
        <span class="s3">from </span><span class="s1">numpy.distutils.system_info </span><span class="s3">import </span><span class="s1">show_all</span>
        <span class="s1">show_all()</span>
        <span class="s3">return</span>

    <span class="s0"># Probably outdated options that were not working before 1.16</span>
    <span class="s3">if </span><span class="s4">'--g3-numpy' </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:]:</span>
        <span class="s1">sys.stderr.write(</span><span class="s4">&quot;G3 f2py support is not implemented, yet.</span><span class="s3">\\</span><span class="s4">n&quot;</span><span class="s1">)</span>
        <span class="s1">sys.exit(</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s3">elif </span><span class="s4">'--2e-numeric' </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:]:</span>
        <span class="s1">sys.argv.remove(</span><span class="s4">'--2e-numeric'</span><span class="s1">)</span>
    <span class="s3">elif </span><span class="s4">'--2e-numarray' </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:]:</span>
        <span class="s0"># Note that this errors becaust the -DNUMARRAY argument is</span>
        <span class="s0"># not recognized. Just here for back compatibility and the</span>
        <span class="s0"># error message.</span>
        <span class="s1">sys.argv.append(</span><span class="s4">&quot;-DNUMARRAY&quot;</span><span class="s1">)</span>
        <span class="s1">sys.argv.remove(</span><span class="s4">'--2e-numarray'</span><span class="s1">)</span>
    <span class="s3">elif </span><span class="s4">'--2e-numpy' </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:]:</span>
        <span class="s1">sys.argv.remove(</span><span class="s4">'--2e-numpy'</span><span class="s1">)</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">pass</span>

    <span class="s3">if </span><span class="s4">'-c' </span><span class="s3">in </span><span class="s1">sys.argv[</span><span class="s5">1</span><span class="s1">:]:</span>
        <span class="s1">run_compile()</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">run_main(sys.argv[</span><span class="s5">1</span><span class="s1">:])</span>
</pre>
</body>
</html>