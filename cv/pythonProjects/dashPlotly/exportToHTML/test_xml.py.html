<html>
<head>
<title>test_xml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_xml.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">BytesIO</span><span class="s0">,</span>
    <span class="s1">StringIO</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">lzma </span><span class="s0">import </span><span class="s1">LZMAError</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">urllib.error </span><span class="s0">import </span><span class="s1">HTTPError</span>
<span class="s0">from </span><span class="s1">zipfile </span><span class="s0">import </span><span class="s1">BadZipFile</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.compat._optional </span><span class="s0">import </span><span class="s1">import_optional_dependency</span>
<span class="s0">import </span><span class="s1">pandas.util._test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">DataFrame</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>

<span class="s0">from </span><span class="s1">pandas.io.xml </span><span class="s0">import </span><span class="s1">read_xml</span>

<span class="s2">&quot;&quot;&quot; 
CHECK LIST 
 
[x] - ValueError: &quot;Values for parser can only be lxml or etree.&quot; 
 
etree 
[X] - ImportError: &quot;lxml not found, please install or use the etree parser.&quot; 
[X] - TypeError: &quot;expected str, bytes or os.PathLike object, not NoneType&quot; 
[X] - ValueError: &quot;Either element or attributes can be parsed not both.&quot; 
[X] - ValueError: &quot;xpath does not return any nodes...&quot; 
[X] - SyntaxError: &quot;You have used an incorrect or unsupported XPath&quot; 
[X] - ValueError: &quot;names does not match length of child elements in xpath.&quot; 
[X] - TypeError: &quot;...is not a valid type for names&quot; 
[X] - ValueError: &quot;To use stylesheet, you need lxml installed...&quot; 
[]  - URLError: (GENERAL ERROR WITH HTTPError AS SUBCLASS) 
[X] - HTTPError: &quot;HTTP Error 404: Not Found&quot; 
[]  - OSError: (GENERAL ERROR WITH FileNotFoundError AS SUBCLASS) 
[X] - FileNotFoundError: &quot;No such file or directory&quot; 
[]  - ParseError    (FAILSAFE CATCH ALL FOR VERY COMPLEX XML) 
[X] - UnicodeDecodeError: &quot;'utf-8' codec can't decode byte 0xe9...&quot; 
[X] - UnicodeError: &quot;UTF-16 stream does not start with BOM&quot; 
[X] - BadZipFile: &quot;File is not a zip file&quot; 
[X] - OSError: &quot;Invalid data stream&quot; 
[X] - LZMAError: &quot;Input format not supported by decoder&quot; 
[X] - ValueError: &quot;Unrecognized compression type&quot; 
[X] - PermissionError: &quot;Forbidden&quot; 
 
lxml 
[X] - ValueError: &quot;Either element or attributes can be parsed not both.&quot; 
[X] - AttributeError: &quot;__enter__&quot; 
[X] - XSLTApplyError: &quot;Cannot resolve URI&quot; 
[X] - XSLTParseError: &quot;document is not a stylesheet&quot; 
[X] - ValueError: &quot;xpath does not return any nodes.&quot; 
[X] - XPathEvalError: &quot;Invalid expression&quot; 
[]  - XPathSyntaxError: (OLD VERSION IN lxml FOR XPATH ERRORS) 
[X] - TypeError: &quot;empty namespace prefix is not supported in XPath&quot; 
[X] - ValueError: &quot;names does not match length of child elements in xpath.&quot; 
[X] - TypeError: &quot;...is not a valid type for names&quot; 
[X] - LookupError: &quot;unknown encoding&quot; 
[]  - URLError: (USUALLY DUE TO NETWORKING) 
[X  - HTTPError: &quot;HTTP Error 404: Not Found&quot; 
[X] - OSError: &quot;failed to load external entity&quot; 
[X] - XMLSyntaxError: &quot;Start tag expected, '&lt;' not found&quot; 
[]  - ParserError: (FAILSAFE CATCH ALL FOR VERY COMPLEX XML 
[X] - ValueError: &quot;Values for parser can only be lxml or etree.&quot; 
[X] - UnicodeDecodeError: &quot;'utf-8' codec can't decode byte 0xe9...&quot; 
[X] - UnicodeError: &quot;UTF-16 stream does not start with BOM&quot; 
[X] - BadZipFile: &quot;File is not a zip file&quot; 
[X] - OSError: &quot;Invalid data stream&quot; 
[X] - LZMAError: &quot;Input format not supported by decoder&quot; 
[X] - ValueError: &quot;Unrecognized compression type&quot; 
[X] - PermissionError: &quot;Forbidden&quot; 
&quot;&quot;&quot;</span>

<span class="s1">geom_df = DataFrame(</span>
    <span class="s1">{</span>
        <span class="s2">&quot;shape&quot;</span><span class="s1">: [</span><span class="s2">&quot;square&quot;</span><span class="s0">, </span><span class="s2">&quot;circle&quot;</span><span class="s0">, </span><span class="s2">&quot;triangle&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s2">&quot;degrees&quot;</span><span class="s1">: [</span><span class="s3">360</span><span class="s0">, </span><span class="s3">360</span><span class="s0">, </span><span class="s3">180</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s2">&quot;sides&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">}</span>
<span class="s1">)</span>

<span class="s1">xml_default_nmsp = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data xmlns=&quot;http://example.com&quot;&gt; 
  &lt;row&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

<span class="s1">xml_prefix_nmsp = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns:doc=&quot;http://example.com&quot;&gt; 
  &lt;doc:row&gt; 
    &lt;doc:shape&gt;square&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;4.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:shape&gt;circle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides/&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:shape&gt;triangle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;180&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;3.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>


<span class="s1">df_kml = DataFrame(</span>
    <span class="s1">{</span>
        <span class="s2">&quot;id&quot;</span><span class="s1">: {</span>
            <span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;ID_00001&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;ID_00002&quot;</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: </span><span class="s2">&quot;ID_00003&quot;</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s1">: </span><span class="s2">&quot;ID_00004&quot;</span><span class="s0">,</span>
            <span class="s3">4</span><span class="s1">: </span><span class="s2">&quot;ID_00005&quot;</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;name&quot;</span><span class="s1">: {</span>
            <span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;Blue Line (Forest Park)&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;Red, Purple Line&quot;</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: </span><span class="s2">&quot;Red, Purple Line&quot;</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s1">: </span><span class="s2">&quot;Red, Purple Line&quot;</span><span class="s0">,</span>
            <span class="s3">4</span><span class="s1">: </span><span class="s2">&quot;Red, Purple Line&quot;</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;styleUrl&quot;</span><span class="s1">: {</span>
            <span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;#LineStyle01&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;#LineStyle01&quot;</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: </span><span class="s2">&quot;#LineStyle01&quot;</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s1">: </span><span class="s2">&quot;#LineStyle01&quot;</span><span class="s0">,</span>
            <span class="s3">4</span><span class="s1">: </span><span class="s2">&quot;#LineStyle01&quot;</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;extrude&quot;</span><span class="s1">: {</span><span class="s3">0</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;altitudeMode&quot;</span><span class="s1">: {</span>
            <span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;clampedToGround&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;clampedToGround&quot;</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: </span><span class="s2">&quot;clampedToGround&quot;</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s1">: </span><span class="s2">&quot;clampedToGround&quot;</span><span class="s0">,</span>
            <span class="s3">4</span><span class="s1">: </span><span class="s2">&quot;clampedToGround&quot;</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s2">&quot;coordinates&quot;</span><span class="s1">: {</span>
            <span class="s3">0</span><span class="s1">: (</span>
                <span class="s2">&quot;-87.77678526964958,41.8708863930319,0 &quot;</span>
                <span class="s2">&quot;-87.77826234150609,41.87097820122218,0 &quot;</span>
                <span class="s2">&quot;-87.78251583439344,41.87130129991005,0 &quot;</span>
                <span class="s2">&quot;-87.78418294588424,41.87145055520308,0 &quot;</span>
                <span class="s2">&quot;-87.7872369165933,41.8717239119163,0 &quot;</span>
                <span class="s2">&quot;-87.79160214925886,41.87210797280065,0&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: (</span>
                <span class="s2">&quot;-87.65758750947528,41.96427269188822,0 &quot;</span>
                <span class="s2">&quot;-87.65802133507393,41.96581929055245,0 &quot;</span>
                <span class="s2">&quot;-87.65819033925305,41.96621846093642,0 &quot;</span>
                <span class="s2">&quot;-87.6583189819129,41.96650362897086,0 &quot;</span>
                <span class="s2">&quot;-87.65835858701473,41.96669002089185,0 &quot;</span>
                <span class="s2">&quot;-87.65838428411853,41.96688150295095,0 &quot;</span>
                <span class="s2">&quot;-87.65842208882658,41.96745896091846,0 &quot;</span>
                <span class="s2">&quot;-87.65846556843937,41.9683761425439,0 &quot;</span>
                <span class="s2">&quot;-87.65849296214573,41.96913893870342,0&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: (</span>
                <span class="s2">&quot;-87.65492939166126,41.95377494531437,0 &quot;</span>
                <span class="s2">&quot;-87.65557043199591,41.95376544118533,0 &quot;</span>
                <span class="s2">&quot;-87.65606302030132,41.95376391658746,0 &quot;</span>
                <span class="s2">&quot;-87.65623502146268,41.95377379126367,0 &quot;</span>
                <span class="s2">&quot;-87.65634748981634,41.95380103566435,0 &quot;</span>
                <span class="s2">&quot;-87.65646537904269,41.95387703994676,0 &quot;</span>
                <span class="s2">&quot;-87.65656532461145,41.95396622645799,0 &quot;</span>
                <span class="s2">&quot;-87.65664760856414,41.95404201996044,0 &quot;</span>
                <span class="s2">&quot;-87.65671750555913,41.95416647054043,0 &quot;</span>
                <span class="s2">&quot;-87.65673983607117,41.95429949810849,0 &quot;</span>
                <span class="s2">&quot;-87.65673866475777,41.95441024240925,0 &quot;</span>
                <span class="s2">&quot;-87.6567690255541,41.95490657227902,0 &quot;</span>
                <span class="s2">&quot;-87.65683672482363,41.95692259283837,0 &quot;</span>
                <span class="s2">&quot;-87.6568900886376,41.95861070983142,0 &quot;</span>
                <span class="s2">&quot;-87.65699865558875,41.96181418669004,0 &quot;</span>
                <span class="s2">&quot;-87.65756347177603,41.96397045777844,0 &quot;</span>
                <span class="s2">&quot;-87.65758750947528,41.96427269188822,0&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s1">: (</span>
                <span class="s2">&quot;-87.65362593118043,41.94742799535678,0 &quot;</span>
                <span class="s2">&quot;-87.65363554415794,41.94819886386848,0 &quot;</span>
                <span class="s2">&quot;-87.6536456393239,41.95059994675451,0 &quot;</span>
                <span class="s2">&quot;-87.65365831235026,41.95108288489359,0 &quot;</span>
                <span class="s2">&quot;-87.6536604873874,41.9519954657554,0 &quot;</span>
                <span class="s2">&quot;-87.65362592053201,41.95245597302328,0 &quot;</span>
                <span class="s2">&quot;-87.65367158496069,41.95311153649393,0 &quot;</span>
                <span class="s2">&quot;-87.65368468595476,41.9533202828916,0 &quot;</span>
                <span class="s2">&quot;-87.65369271253692,41.95343095587119,0 &quot;</span>
                <span class="s2">&quot;-87.65373335834569,41.95351536301472,0 &quot;</span>
                <span class="s2">&quot;-87.65378605844126,41.95358212680591,0 &quot;</span>
                <span class="s2">&quot;-87.65385067928185,41.95364452823767,0 &quot;</span>
                <span class="s2">&quot;-87.6539390793817,41.95370263886964,0 &quot;</span>
                <span class="s2">&quot;-87.6540786298351,41.95373403675265,0 &quot;</span>
                <span class="s2">&quot;-87.65430648647626,41.9537535411832,0 &quot;</span>
                <span class="s2">&quot;-87.65492939166126,41.95377494531437,0&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">4</span><span class="s1">: (</span>
                <span class="s2">&quot;-87.65345391792157,41.94217681262115,0 &quot;</span>
                <span class="s2">&quot;-87.65342448305786,41.94237224420864,0 &quot;</span>
                <span class="s2">&quot;-87.65339745703922,41.94268217746244,0 &quot;</span>
                <span class="s2">&quot;-87.65337753982941,41.94288140770284,0 &quot;</span>
                <span class="s2">&quot;-87.65336256753105,41.94317369618263,0 &quot;</span>
                <span class="s2">&quot;-87.65338799707138,41.94357253961736,0 &quot;</span>
                <span class="s2">&quot;-87.65340240886648,41.94389158188269,0 &quot;</span>
                <span class="s2">&quot;-87.65341837392448,41.94406444407721,0 &quot;</span>
                <span class="s2">&quot;-87.65342275247338,41.94421065714904,0 &quot;</span>
                <span class="s2">&quot;-87.65347469646018,41.94434829382345,0 &quot;</span>
                <span class="s2">&quot;-87.65351486483024,41.94447699917548,0 &quot;</span>
                <span class="s2">&quot;-87.65353483605053,41.9453896864472,0 &quot;</span>
                <span class="s2">&quot;-87.65361975532807,41.94689193720703,0 &quot;</span>
                <span class="s2">&quot;-87.65362593118043,41.94742799535678,0&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
    <span class="s1">}</span>
<span class="s1">)</span>


<span class="s1">@pytest.fixture(params=[</span><span class="s2">&quot;rb&quot;</span><span class="s0">, </span><span class="s2">&quot;r&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">mode(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s1">@pytest.fixture(params=[pytest.param(</span><span class="s2">&quot;lxml&quot;</span><span class="s0">, </span><span class="s1">marks=td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;etree&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">parser(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s4"># FILE / URL</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_parser_consistency_file(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file_lxml = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file_etree = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_file_lxml</span><span class="s0">, </span><span class="s1">df_file_etree)</span>


<span class="s1">@tm.network</span>
<span class="s1">@pytest.mark.slow</span>
<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_parser_consistency_url(datapath):</span>
    <span class="s1">url = (</span>
        <span class="s2">&quot;https://data.cityofchicago.org/api/views/&quot;</span>
        <span class="s2">&quot;8pix-ypme/rows.xml?accessType=DOWNLOAD&quot;</span>
    <span class="s1">)</span>
    <span class="s1">df_url_lxml = read_xml(url</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//row/row&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
    <span class="s1">df_url_etree = read_xml(url</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//row/row&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_url_lxml</span><span class="s0">, </span><span class="s1">df_url_etree)</span>


<span class="s0">def </span><span class="s1">test_file_like(datapath</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">open(filename</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">df_file = read_xml(f</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;category&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;author&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_file</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_file_io(datapath</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">open(filename</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">xml_obj = f.read()</span>

    <span class="s1">df_io = read_xml(</span>
        <span class="s1">(BytesIO(xml_obj) </span><span class="s0">if </span><span class="s1">isinstance(xml_obj</span><span class="s0">, </span><span class="s1">bytes) </span><span class="s0">else </span><span class="s1">StringIO(xml_obj))</span><span class="s0">,</span>
        <span class="s1">parser=parser</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;category&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;author&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_io</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_file_buffered_reader_string(datapath</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">open(filename</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">xml_obj = f.read()</span>

    <span class="s1">df_str = read_xml(xml_obj</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;category&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;author&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_str</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_file_buffered_reader_no_xml_declaration(datapath</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">open(filename</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">next(f)</span>
        <span class="s1">xml_obj = f.read()</span>

    <span class="s1">df_str = read_xml(xml_obj</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;category&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;author&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_str</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_file_handle_close(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">xml_file = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">open(xml_file</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">read_xml(BytesIO(f.read())</span><span class="s0">, </span><span class="s1">parser=parser)</span>

        <span class="s0">assert not </span><span class="s1">f.closed</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_empty_string_lxml(val):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s0">with </span><span class="s1">pytest.raises(XMLSyntaxError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Document is empty&quot;</span><span class="s1">):</span>
        <span class="s1">read_xml(val</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_empty_string_etree(val):</span>
    <span class="s0">from </span><span class="s1">xml.etree.ElementTree </span><span class="s0">import </span><span class="s1">ParseError</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ParseError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;no element found&quot;</span><span class="s1">):</span>
        <span class="s1">read_xml(val</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_wrong_file_path_lxml():</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s1">filename = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">XMLSyntaxError</span><span class="s0">,</span>
        <span class="s1">match=(</span><span class="s2">&quot;Start tag expected, '&lt;' not found&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_wrong_file_path_etree():</span>
    <span class="s0">from </span><span class="s1">xml.etree.ElementTree </span><span class="s0">import </span><span class="s1">ParseError</span>

    <span class="s1">filename = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ParseError</span><span class="s0">,</span>
        <span class="s1">match=(</span><span class="s2">&quot;not well-formed&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>


<span class="s1">@tm.network</span>
<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_url():</span>
    <span class="s1">url = </span><span class="s2">&quot;https://www.w3schools.com/xml/books.xml&quot;</span>
    <span class="s1">df_url = read_xml(url</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//book[count(*)=4]&quot;</span><span class="s1">)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;category&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;author&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;cover&quot;</span><span class="s1">: [</span><span class="s0">None, None, </span><span class="s2">&quot;paperback&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_url</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s1">@tm.network</span>
<span class="s0">def </span><span class="s1">test_wrong_url(parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(HTTPError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;HTTP Error 404: Not Found&quot;</span><span class="s1">)):</span>
        <span class="s1">url = </span><span class="s2">&quot;https://www.w3schools.com/xml/python.xml&quot;</span>
        <span class="s1">read_xml(url</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//book[count(*)=4]&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s4"># XPATH</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_empty_xpath_lxml(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;xpath does not return any nodes&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//python&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_bad_xpath_etree(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">SyntaxError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;You have used an incorrect or unsupported XPath&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//[book]&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_bad_xpath_lxml(datapath):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XPathEvalError</span>

    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(XPathEvalError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Invalid expression&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//[book]&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>


<span class="s4"># NAMESPACE</span>


<span class="s0">def </span><span class="s1">test_default_namespace(parser):</span>
    <span class="s1">df_nmsp = read_xml(</span>
        <span class="s1">xml_default_nmsp</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//ns:row&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;ns&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=parser</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: [</span><span class="s2">&quot;square&quot;</span><span class="s0">, </span><span class="s2">&quot;circle&quot;</span><span class="s0">, </span><span class="s2">&quot;triangle&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;degrees&quot;</span><span class="s1">: [</span><span class="s3">360</span><span class="s0">, </span><span class="s3">360</span><span class="s0">, </span><span class="s3">180</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;sides&quot;</span><span class="s1">: [</span><span class="s3">4.0</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_nmsp</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_prefix_namespace(parser):</span>
    <span class="s1">df_nmsp = read_xml(</span>
        <span class="s1">xml_prefix_nmsp</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//doc:row&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;doc&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=parser</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: [</span><span class="s2">&quot;square&quot;</span><span class="s0">, </span><span class="s2">&quot;circle&quot;</span><span class="s0">, </span><span class="s2">&quot;triangle&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;degrees&quot;</span><span class="s1">: [</span><span class="s3">360</span><span class="s0">, </span><span class="s3">360</span><span class="s0">, </span><span class="s3">180</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;sides&quot;</span><span class="s1">: [</span><span class="s3">4.0</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_nmsp</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_consistency_default_namespace():</span>
    <span class="s1">df_lxml = read_xml(</span>
        <span class="s1">xml_default_nmsp</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//ns:row&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;ns&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df_etree = read_xml(</span>
        <span class="s1">xml_default_nmsp</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//doc:row&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;doc&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_lxml</span><span class="s0">, </span><span class="s1">df_etree)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_consistency_prefix_namespace():</span>
    <span class="s1">df_lxml = read_xml(</span>
        <span class="s1">xml_prefix_nmsp</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//doc:row&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;doc&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df_etree = read_xml(</span>
        <span class="s1">xml_prefix_nmsp</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//doc:row&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;doc&quot;</span><span class="s1">: </span><span class="s2">&quot;http://example.com&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_lxml</span><span class="s0">, </span><span class="s1">df_etree)</span>


<span class="s4"># PREFIX</span>


<span class="s0">def </span><span class="s1">test_missing_prefix_with_default_namespace(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;xpath does not return any nodes&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//Placemark&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_missing_prefix_definition_etree(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(SyntaxError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;you used an undeclared namespace prefix&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//kml:Placemark&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_missing_prefix_definition_lxml(datapath):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XPathEvalError</span>

    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(XPathEvalError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Undefined namespace prefix&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//kml:Placemark&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;&quot;</span><span class="s0">, None</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_none_namespace_prefix(key):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">TypeError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;empty namespace prefix is not supported in XPath&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(</span>
            <span class="s1">xml_default_nmsp</span><span class="s0">,</span>
            <span class="s1">xpath=</span><span class="s2">&quot;.//kml:Placemark&quot;</span><span class="s0">,</span>
            <span class="s1">namespaces={key: </span><span class="s2">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s4"># ELEMS AND ATTRS</span>


<span class="s0">def </span><span class="s1">test_file_elems_and_attrs(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser)</span>
    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;category&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;author&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_file</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_file_only_attrs(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">attrs_only=</span><span class="s0">True, </span><span class="s1">parser=parser)</span>
    <span class="s1">df_expected = DataFrame({</span><span class="s2">&quot;category&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]})</span>

    <span class="s1">tm.assert_frame_equal(df_file</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_file_only_elems(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(filename</span><span class="s0">, </span><span class="s1">elems_only=</span><span class="s0">True, </span><span class="s1">parser=parser)</span>
    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;author&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;year&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;price&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_file</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_elem_and_attrs_only(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">,</span>
        <span class="s1">match=(</span><span class="s2">&quot;Either element or attributes can be parsed not both&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">elems_only=</span><span class="s0">True, </span><span class="s1">attrs_only=</span><span class="s0">True, </span><span class="s1">parser=parser)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_attribute_centric_xml():</span>
    <span class="s1">xml = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; 
&lt;TrainSchedule&gt; 
      &lt;Stations&gt; 
         &lt;station Name=&quot;Manhattan&quot; coords=&quot;31,460,195,498&quot;/&gt; 
         &lt;station Name=&quot;Laraway Road&quot; coords=&quot;63,409,194,455&quot;/&gt; 
         &lt;station Name=&quot;179th St (Orland Park)&quot; coords=&quot;0,364,110,395&quot;/&gt; 
         &lt;station Name=&quot;153rd St (Orland Park)&quot; coords=&quot;7,333,113,362&quot;/&gt; 
         &lt;station Name=&quot;143rd St (Orland Park)&quot; coords=&quot;17,297,115,330&quot;/&gt; 
         &lt;station Name=&quot;Palos Park&quot; coords=&quot;128,281,239,303&quot;/&gt; 
         &lt;station Name=&quot;Palos Heights&quot; coords=&quot;148,257,283,279&quot;/&gt; 
         &lt;station Name=&quot;Worth&quot; coords=&quot;170,230,248,255&quot;/&gt; 
         &lt;station Name=&quot;Chicago Ridge&quot; coords=&quot;70,187,208,214&quot;/&gt; 
         &lt;station Name=&quot;Oak Lawn&quot; coords=&quot;166,159,266,185&quot;/&gt; 
         &lt;station Name=&quot;Ashburn&quot; coords=&quot;197,133,336,157&quot;/&gt; 
         &lt;station Name=&quot;Wrightwood&quot; coords=&quot;219,106,340,133&quot;/&gt; 
         &lt;station Name=&quot;Chicago Union Sta&quot; coords=&quot;220,0,360,43&quot;/&gt; 
      &lt;/Stations&gt; 
&lt;/TrainSchedule&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_lxml = read_xml(xml</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//station&quot;</span><span class="s1">)</span>
    <span class="s1">df_etree = read_xml(xml</span><span class="s0">, </span><span class="s1">xpath=</span><span class="s2">&quot;.//station&quot;</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_lxml</span><span class="s0">, </span><span class="s1">df_etree)</span>


<span class="s4"># NAMES</span>


<span class="s0">def </span><span class="s1">test_names_option_output(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_file = read_xml(</span>
        <span class="s1">filename</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;Col1&quot;</span><span class="s0">, </span><span class="s2">&quot;Col2&quot;</span><span class="s0">, </span><span class="s2">&quot;Col3&quot;</span><span class="s0">, </span><span class="s2">&quot;Col4&quot;</span><span class="s0">, </span><span class="s2">&quot;Col5&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parser=parser</span>
    <span class="s1">)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;Col1&quot;</span><span class="s1">: [</span><span class="s2">&quot;cooking&quot;</span><span class="s0">, </span><span class="s2">&quot;children&quot;</span><span class="s0">, </span><span class="s2">&quot;web&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;Col2&quot;</span><span class="s1">: [</span><span class="s2">&quot;Everyday Italian&quot;</span><span class="s0">, </span><span class="s2">&quot;Harry Potter&quot;</span><span class="s0">, </span><span class="s2">&quot;Learning XML&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;Col3&quot;</span><span class="s1">: [</span><span class="s2">&quot;Giada De Laurentiis&quot;</span><span class="s0">, </span><span class="s2">&quot;J K. Rowling&quot;</span><span class="s0">, </span><span class="s2">&quot;Erik T. Ray&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;Col4&quot;</span><span class="s1">: [</span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2005</span><span class="s0">, </span><span class="s3">2003</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;Col5&quot;</span><span class="s1">: [</span><span class="s3">30.00</span><span class="s0">, </span><span class="s3">29.99</span><span class="s0">, </span><span class="s3">39.95</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_file</span><span class="s0">, </span><span class="s1">df_expected)</span>


<span class="s0">def </span><span class="s1">test_names_option_wrong_length(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;names does not match length&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;Col1&quot;</span><span class="s0">, </span><span class="s2">&quot;Col2&quot;</span><span class="s0">, </span><span class="s2">&quot;Col3&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_names_option_wrong_type(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;is not a valid type for names&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">names=</span><span class="s2">&quot;Col1, Col2, Col3&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s4"># ENCODING</span>


<span class="s0">def </span><span class="s1">test_wrong_encoding(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(UnicodeDecodeError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;'utf-8' codec can't decode&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_utf16_encoding(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">UnicodeError</span><span class="s0">,</span>
        <span class="s1">match=(</span>
            <span class="s2">&quot;UTF-16 stream does not start with BOM|&quot;</span>
            <span class="s2">&quot;'utf-16-le' codec can't decode byte&quot;</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;UTF-16&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_unknown_encoding(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(LookupError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;unknown encoding: UFT-8&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;UFT-8&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">def </span><span class="s1">test_ascii_encoding(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(UnicodeDecodeError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;'ascii' codec can't decode byte&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;ascii&quot;</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_parser_consistency_with_encoding(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;baby_names.xml&quot;</span><span class="s1">)</span>
    <span class="s1">df_lxml = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="s1">)</span>
    <span class="s1">df_etree = read_xml(filename</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">&quot;iso-8859-1&quot;</span><span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_lxml</span><span class="s0">, </span><span class="s1">df_etree)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_wrong_encoding_for_lxml():</span>
    <span class="s4"># GH#45133</span>
    <span class="s1">data = </span><span class="s2">&quot;&quot;&quot;&lt;data&gt; 
  &lt;row&gt; 
    &lt;a&gt;c&lt;/a&gt; 
  &lt;/row&gt; 
&lt;/data&gt; 
&quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;encoding None&quot;</span><span class="s1">):</span>
        <span class="s1">read_xml(StringIO(data)</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s0">None</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_none_encoding_etree():</span>
    <span class="s4"># GH#45133</span>
    <span class="s1">data = </span><span class="s2">&quot;&quot;&quot;&lt;data&gt; 
  &lt;row&gt; 
    &lt;a&gt;c&lt;/a&gt; 
  &lt;/row&gt; 
&lt;/data&gt; 
&quot;&quot;&quot;</span>
    <span class="s1">result = read_xml(StringIO(data)</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;c&quot;</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s4"># PARSER</span>


<span class="s1">@td.skip_if_installed(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_default_parser_no_lxml(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ImportError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;lxml not found, please install or use the etree parser.&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(filename)</span>


<span class="s0">def </span><span class="s1">test_wrong_parser(datapath):</span>
    <span class="s1">filename = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Values for parser can only be lxml or etree.&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(filename</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;bs4&quot;</span><span class="s1">)</span>


<span class="s4"># STYLESHEET</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_file(datapath):</span>
    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;flatten_doc.xsl&quot;</span><span class="s1">)</span>

    <span class="s1">df_style = read_xml(</span>
        <span class="s1">kml</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//k:Placemark&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;k&quot;</span><span class="s1">: </span><span class="s2">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">stylesheet=xsl</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_kml</span><span class="s0">, </span><span class="s1">df_style)</span>


<span class="s0">def </span><span class="s1">test_read_xml_passing_as_positional_deprecated(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s4"># GH#45133</span>
    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;keyword-only&quot;</span><span class="s1">):</span>
        <span class="s1">read_xml(</span>
            <span class="s1">kml</span><span class="s0">,</span>
            <span class="s2">&quot;.//k:Placemark&quot;</span><span class="s0">,</span>
            <span class="s1">namespaces={</span><span class="s2">&quot;k&quot;</span><span class="s1">: </span><span class="s2">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">parser=parser</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_file_like(datapath</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;flatten_doc.xsl&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">open(xsl</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">df_style = read_xml(</span>
            <span class="s1">kml</span><span class="s0">,</span>
            <span class="s1">xpath=</span><span class="s2">&quot;.//k:Placemark&quot;</span><span class="s0">,</span>
            <span class="s1">namespaces={</span><span class="s2">&quot;k&quot;</span><span class="s1">: </span><span class="s2">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s1">}</span><span class="s0">,</span>
            <span class="s1">stylesheet=f</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_kml</span><span class="s0">, </span><span class="s1">df_style)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_io(datapath</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;flatten_doc.xsl&quot;</span><span class="s1">)</span>

    <span class="s1">xsl_obj: BytesIO | StringIO</span>

    <span class="s0">with </span><span class="s1">open(xsl</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">if </span><span class="s1">mode == </span><span class="s2">&quot;rb&quot;</span><span class="s1">:</span>
            <span class="s1">xsl_obj = BytesIO(f.read())</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">xsl_obj = StringIO(f.read())</span>

    <span class="s1">df_style = read_xml(</span>
        <span class="s1">kml</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//k:Placemark&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;k&quot;</span><span class="s1">: </span><span class="s2">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">stylesheet=xsl_obj</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_kml</span><span class="s0">, </span><span class="s1">df_style)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_buffered_reader(datapath</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;flatten_doc.xsl&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">open(xsl</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">xsl_obj = f.read()</span>

    <span class="s1">df_style = read_xml(</span>
        <span class="s1">kml</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//k:Placemark&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;k&quot;</span><span class="s1">: </span><span class="s2">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">stylesheet=xsl_obj</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_kml</span><span class="s0">, </span><span class="s1">df_style)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_not_stylesheet(datapath):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XSLTParseError</span>

    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;books.xml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(XSLTParseError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;document is not a stylesheet&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_incorrect_xsl_syntax(datapath):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; 
                              xmlns:k=&quot;http://www.opengis.net/kml/2.2&quot;/&gt; 
    &lt;xsl:output method=&quot;xml&quot; omit-xml-declaration=&quot;yes&quot; 
                cdata-section-elements=&quot;k:description&quot; indent=&quot;yes&quot;/&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;node()|@*&quot;&gt; 
     &lt;xsl:copy&gt; 
       &lt;xsl:apply-templates select=&quot;node()|@*&quot;/&gt; 
     &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:MultiGeometry|k:LineString&quot;&gt; 
        &lt;xsl:apply-templates select='*'/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:description|k:Snippet|k:Style&quot;/&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">XMLSyntaxError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Extra content at the end of the document&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_incorrect_xsl_eval(datapath):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XSLTParseError</span>

    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; 
                              xmlns:k=&quot;http://www.opengis.net/kml/2.2&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; omit-xml-declaration=&quot;yes&quot; 
                cdata-section-elements=&quot;k:description&quot; indent=&quot;yes&quot;/&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;node(*)|@*&quot;&gt; 
     &lt;xsl:copy&gt; 
       &lt;xsl:apply-templates select=&quot;node()|@*&quot;/&gt; 
     &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:MultiGeometry|k:LineString&quot;&gt; 
        &lt;xsl:apply-templates select='*'/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:description|k:Snippet|k:Style&quot;/&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(XSLTParseError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;failed to compile&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_incorrect_xsl_apply(datapath):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XSLTApplyError</span>

    <span class="s1">xsl = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node()&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:copy-of select=&quot;document('non_existent.xml')/*&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(XSLTApplyError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Cannot resolve URI&quot;</span><span class="s1">)):</span>
        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_wrong_stylesheet():</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s1">kml = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;flatten.xsl&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">XMLSyntaxError</span><span class="s0">,</span>
        <span class="s1">match=(</span><span class="s2">&quot;Start tag expected, '&lt;' not found&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_file_close(datapath</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">kml = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = datapath(</span><span class="s2">&quot;io&quot;</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;flatten_doc.xsl&quot;</span><span class="s1">)</span>

    <span class="s1">xsl_obj: BytesIO | StringIO</span>

    <span class="s0">with </span><span class="s1">open(xsl</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">if </span><span class="s1">mode == </span><span class="s2">&quot;rb&quot;</span><span class="s1">:</span>
            <span class="s1">xsl_obj = BytesIO(f.read())</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">xsl_obj = StringIO(f.read())</span>

        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">stylesheet=xsl_obj)</span>

        <span class="s0">assert not </span><span class="s1">f.closed</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stylesheet_with_etree(datapath):</span>
    <span class="s1">kml = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>
    <span class="s1">xsl = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;flatten_doc.xsl&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;To use stylesheet, you need lxml installed&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s0">, </span><span class="s1">stylesheet=xsl)</span>


<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_empty_stylesheet(val):</span>
    <span class="s0">from </span><span class="s1">lxml.etree </span><span class="s0">import </span><span class="s1">XMLSyntaxError</span>

    <span class="s1">kml = os.path.join(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s2">&quot;xml&quot;</span><span class="s0">, </span><span class="s2">&quot;cta_rail_lines.kml&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">XMLSyntaxError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Document is empty|Start tag expected, '&lt;' not found&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s1">read_xml(kml</span><span class="s0">, </span><span class="s1">stylesheet=val)</span>


<span class="s1">@tm.network</span>
<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_online_stylesheet():</span>
    <span class="s1">xml = </span><span class="s2">&quot;https://www.w3schools.com/xml/cdcatalog_with_xsl.xml&quot;</span>
    <span class="s1">xsl = </span><span class="s2">&quot;https://www.w3schools.com/xml/cdcatalog.xsl&quot;</span>

    <span class="s1">df_xsl = read_xml(</span>
        <span class="s1">xml</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//tr[td and position() &lt;= 6]&quot;</span><span class="s0">,</span>
        <span class="s1">names=[</span><span class="s2">&quot;title&quot;</span><span class="s0">, </span><span class="s2">&quot;artist&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">stylesheet=xsl</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df_expected = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;title&quot;</span><span class="s1">: {</span>
                <span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;Empire Burlesque&quot;</span><span class="s0">,</span>
                <span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;Hide your heart&quot;</span><span class="s0">,</span>
                <span class="s3">2</span><span class="s1">: </span><span class="s2">&quot;Greatest Hits&quot;</span><span class="s0">,</span>
                <span class="s3">3</span><span class="s1">: </span><span class="s2">&quot;Still got the blues&quot;</span><span class="s0">,</span>
                <span class="s3">4</span><span class="s1">: </span><span class="s2">&quot;Eros&quot;</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s2">&quot;artist&quot;</span><span class="s1">: {</span>
                <span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;Bob Dylan&quot;</span><span class="s0">,</span>
                <span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;Bonnie Tyler&quot;</span><span class="s0">,</span>
                <span class="s3">2</span><span class="s1">: </span><span class="s2">&quot;Dolly Parton&quot;</span><span class="s0">,</span>
                <span class="s3">3</span><span class="s1">: </span><span class="s2">&quot;Gary Moore&quot;</span><span class="s0">,</span>
                <span class="s3">4</span><span class="s1">: </span><span class="s2">&quot;Eros Ramazzotti&quot;</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_expected</span><span class="s0">, </span><span class="s1">df_xsl)</span>


<span class="s4"># COMPRESSION</span>


<span class="s0">def </span><span class="s1">test_compression_read(parser</span><span class="s0">, </span><span class="s1">compression_only):</span>
    <span class="s0">with </span><span class="s1">tm.ensure_clean() </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">geom_df.to_xml(path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=compression_only)</span>

        <span class="s1">xml_df = read_xml(path</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=compression_only)</span>

    <span class="s1">tm.assert_frame_equal(xml_df</span><span class="s0">, </span><span class="s1">geom_df)</span>


<span class="s0">def </span><span class="s1">test_wrong_compression(parser</span><span class="s0">, </span><span class="s1">compression</span><span class="s0">, </span><span class="s1">compression_only):</span>
    <span class="s1">actual_compression = compression</span>
    <span class="s1">attempted_compression = compression_only</span>

    <span class="s0">if </span><span class="s1">actual_compression == attempted_compression:</span>
        <span class="s0">return</span>

    <span class="s1">errors = {</span>
        <span class="s2">&quot;bz2&quot;</span><span class="s1">: (OSError</span><span class="s0">, </span><span class="s2">&quot;Invalid data stream&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;gzip&quot;</span><span class="s1">: (OSError</span><span class="s0">, </span><span class="s2">&quot;Not a gzipped file&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;zip&quot;</span><span class="s1">: (BadZipFile</span><span class="s0">, </span><span class="s2">&quot;File is not a zip file&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">zstd = import_optional_dependency(</span><span class="s2">&quot;zstandard&quot;</span><span class="s0">, </span><span class="s1">errors=</span><span class="s2">&quot;ignore&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">zstd </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">errors[</span><span class="s2">&quot;zstd&quot;</span><span class="s1">] = (zstd.ZstdError</span><span class="s0">, </span><span class="s2">&quot;Unknown frame descriptor&quot;</span><span class="s1">)</span>
    <span class="s1">lzma = import_optional_dependency(</span><span class="s2">&quot;lzma&quot;</span><span class="s0">, </span><span class="s1">errors=</span><span class="s2">&quot;ignore&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">lzma </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">errors[</span><span class="s2">&quot;xz&quot;</span><span class="s1">] = (LZMAError</span><span class="s0">, </span><span class="s2">&quot;Input format not supported by decoder&quot;</span><span class="s1">)</span>
    <span class="s1">error_cls</span><span class="s0">, </span><span class="s1">error_str = errors[attempted_compression]</span>

    <span class="s0">with </span><span class="s1">tm.ensure_clean() </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s1">geom_df.to_xml(path</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=actual_compression)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(error_cls</span><span class="s0">, </span><span class="s1">match=error_str):</span>
            <span class="s1">read_xml(path</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=attempted_compression)</span>


<span class="s0">def </span><span class="s1">test_unsuported_compression(datapath</span><span class="s0">, </span><span class="s1">parser):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Unrecognized compression type&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">tm.ensure_clean() </span><span class="s0">as </span><span class="s1">path:</span>
            <span class="s1">read_xml(path</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;7z&quot;</span><span class="s1">)</span>


<span class="s4"># STORAGE OPTIONS</span>


<span class="s1">@tm.network</span>
<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;s3fs&quot;</span><span class="s1">)</span>
<span class="s1">@td.skip_if_no(</span><span class="s2">&quot;lxml&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_s3_parser_consistency():</span>
    <span class="s4"># Python Software Foundation (2019 IRS-990 RETURN)</span>
    <span class="s1">s3 = </span><span class="s2">&quot;s3://irs-form-990/201923199349319487_public.xml&quot;</span>

    <span class="s1">df_lxml = read_xml(</span>
        <span class="s1">s3</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//irs:Form990PartVIISectionAGrp&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;irs&quot;</span><span class="s1">: </span><span class="s2">&quot;http://www.irs.gov/efile&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=</span><span class="s2">&quot;lxml&quot;</span><span class="s0">,</span>
        <span class="s1">storage_options={</span><span class="s2">&quot;anon&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df_etree = read_xml(</span>
        <span class="s1">s3</span><span class="s0">,</span>
        <span class="s1">xpath=</span><span class="s2">&quot;.//irs:Form990PartVIISectionAGrp&quot;</span><span class="s0">,</span>
        <span class="s1">namespaces={</span><span class="s2">&quot;irs&quot;</span><span class="s1">: </span><span class="s2">&quot;http://www.irs.gov/efile&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">parser=</span><span class="s2">&quot;etree&quot;</span><span class="s0">,</span>
        <span class="s1">storage_options={</span><span class="s2">&quot;anon&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">tm.assert_frame_equal(df_lxml</span><span class="s0">, </span><span class="s1">df_etree)</span>
</pre>
</body>
</html>