<html>
<head>
<title>test_indexing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_indexing.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; test fancy indexing &amp; misc &quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">datetime </span><span class="s2">import </span><span class="s1">datetime</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">weakref</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">pandas.util._test_decorators </span><span class="s2">as </span><span class="s1">td</span>

<span class="s2">from </span><span class="s1">pandas.core.dtypes.common </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">is_float_dtype</span><span class="s2">,</span>
    <span class="s1">is_integer_dtype</span><span class="s2">,</span>
<span class="s1">)</span>

<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">NaT</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
    <span class="s1">offsets</span><span class="s2">,</span>
    <span class="s1">timedelta_range</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">import </span><span class="s1">pandas._testing </span><span class="s2">as </span><span class="s1">tm</span>
<span class="s2">from </span><span class="s1">pandas.core.api </span><span class="s2">import </span><span class="s1">Float64Index</span>
<span class="s2">from </span><span class="s1">pandas.tests.indexing.common </span><span class="s2">import </span><span class="s1">_mklbl</span>
<span class="s2">from </span><span class="s1">pandas.tests.indexing.test_floats </span><span class="s2">import </span><span class="s1">gen_obj</span>

<span class="s3"># ------------------------------------------------------------------------</span>
<span class="s3"># Indexing test cases</span>


<span class="s2">class </span><span class="s1">TestFancy:</span>
    <span class="s0">&quot;&quot;&quot;pure get/set item &amp; fancy indexing&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">test_setitem_ndarray_1d(self):</span>
        <span class="s3"># GH5508</span>

        <span class="s3"># len of indexer vs length of the 1d ndarray</span>
        <span class="s1">df = DataFrame(index=Index(np.arange(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">11</span><span class="s1">)))</span>
        <span class="s1">df[</span><span class="s5">&quot;foo&quot;</span><span class="s1">] = np.zeros(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">df[</span><span class="s5">&quot;bar&quot;</span><span class="s1">] = np.zeros(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype=complex)</span>

        <span class="s3"># invalid</span>
        <span class="s1">msg = </span><span class="s5">&quot;Must have equal len keys and value when setting with an iterable&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.loc[df.index[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">5</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">] = np.array([</span><span class="s4">2.33j</span><span class="s2">, </span><span class="s4">1.23 </span><span class="s1">+ </span><span class="s4">0.1j</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">])</span>

        <span class="s3"># valid</span>
        <span class="s1">df.loc[df.index[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">] = np.array([</span><span class="s4">2.33j</span><span class="s2">, </span><span class="s4">1.23 </span><span class="s1">+ </span><span class="s4">0.1j</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">])</span>

        <span class="s1">result = df.loc[df.index[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">]</span>
        <span class="s1">expected = Series(</span>
            <span class="s1">[</span><span class="s4">2.33j</span><span class="s2">, </span><span class="s4">1.23 </span><span class="s1">+ </span><span class="s4">0.1j</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;bar&quot;</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_setitem_ndarray_1d_2(self):</span>
        <span class="s3"># GH5508</span>

        <span class="s3"># dtype getting changed?</span>
        <span class="s1">df = DataFrame(index=Index(np.arange(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">11</span><span class="s1">)))</span>
        <span class="s1">df[</span><span class="s5">&quot;foo&quot;</span><span class="s1">] = np.zeros(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">df[</span><span class="s5">&quot;bar&quot;</span><span class="s1">] = np.zeros(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype=complex)</span>

        <span class="s1">msg = </span><span class="s5">&quot;Must have equal len keys and value when setting with an iterable&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">df[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">5</span><span class="s1">] = np.arange(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s1">) * </span><span class="s4">1j</span>

    <span class="s2">def </span><span class="s1">test_getitem_ndarray_3d(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">frame_or_series</span><span class="s2">, </span><span class="s1">indexer_sli</span><span class="s2">, </span><span class="s1">using_array_manager</span>
    <span class="s1">):</span>
        <span class="s3"># GH 25567</span>
        <span class="s1">obj = gen_obj(frame_or_series</span><span class="s2">, </span><span class="s1">index)</span>
        <span class="s1">idxr = indexer_sli(obj)</span>
        <span class="s1">nd3 = np.random.randint(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">size=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s1">))</span>

        <span class="s1">msgs = []</span>
        <span class="s2">if </span><span class="s1">frame_or_series </span><span class="s2">is </span><span class="s1">Series </span><span class="s2">and </span><span class="s1">indexer_sli </span><span class="s2">in </span><span class="s1">[tm.setitem</span><span class="s2">, </span><span class="s1">tm.iloc]:</span>
            <span class="s1">msgs.append(</span><span class="s5">r&quot;Wrong number of dimensions. values.ndim &gt; ndim \[3 &gt; 1\]&quot;</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">using_array_manager:</span>
                <span class="s1">msgs.append(</span><span class="s5">&quot;Passed array should be 1-dimensional&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">frame_or_series </span><span class="s2">is </span><span class="s1">Series </span><span class="s2">or </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.iloc:</span>
            <span class="s1">msgs.append(</span><span class="s5">r&quot;Buffer has wrong number of dimensions \(expected 1, got 3\)&quot;</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">using_array_manager:</span>
                <span class="s1">msgs.append(</span><span class="s5">&quot;indexer should be 1-dimensional&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.loc </span><span class="s2">or </span><span class="s1">(</span>
            <span class="s1">frame_or_series </span><span class="s2">is </span><span class="s1">Series </span><span class="s2">and </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.setitem</span>
        <span class="s1">):</span>
            <span class="s1">msgs.append(</span><span class="s5">&quot;Cannot index with multidimensional key&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">frame_or_series </span><span class="s2">is </span><span class="s1">DataFrame </span><span class="s2">and </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.setitem:</span>
            <span class="s1">msgs.append(</span><span class="s5">&quot;Index data must be 1-dimensional&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">isinstance(index</span><span class="s2">, </span><span class="s1">pd.IntervalIndex) </span><span class="s2">and </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.iloc:</span>
            <span class="s1">msgs.append(</span><span class="s5">&quot;Index data must be 1-dimensional&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">isinstance(index</span><span class="s2">, </span><span class="s1">(pd.TimedeltaIndex</span><span class="s2">, </span><span class="s1">pd.DatetimeIndex</span><span class="s2">, </span><span class="s1">pd.PeriodIndex)):</span>
            <span class="s1">msgs.append(</span><span class="s5">&quot;Data must be 1-dimensional&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">len(index) == </span><span class="s4">0 </span><span class="s2">or </span><span class="s1">isinstance(index</span><span class="s2">, </span><span class="s1">pd.MultiIndex):</span>
            <span class="s1">msgs.append(</span><span class="s5">&quot;positional indexers are out-of-bounds&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">type(index) </span><span class="s2">is </span><span class="s1">Index </span><span class="s2">and not </span><span class="s1">isinstance(index._values</span><span class="s2">, </span><span class="s1">np.ndarray):</span>
            <span class="s3"># e.g. Int64</span>
            <span class="s1">msgs.append(</span><span class="s5">&quot;values must be a 1D array&quot;</span><span class="s1">)</span>

            <span class="s3"># string[pyarrow]</span>
            <span class="s1">msgs.append(</span><span class="s5">&quot;only handle 1-dimensional arrays&quot;</span><span class="s1">)</span>

        <span class="s1">msg = </span><span class="s5">&quot;|&quot;</span><span class="s1">.join(msgs)</span>

        <span class="s1">potential_errors = (IndexError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">NotImplementedError)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(potential_errors</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">idxr[nd3]</span>

    <span class="s2">def </span><span class="s1">test_setitem_ndarray_3d(self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">frame_or_series</span><span class="s2">, </span><span class="s1">indexer_sli):</span>
        <span class="s3"># GH 25567</span>
        <span class="s1">obj = gen_obj(frame_or_series</span><span class="s2">, </span><span class="s1">index)</span>
        <span class="s1">idxr = indexer_sli(obj)</span>
        <span class="s1">nd3 = np.random.randint(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">size=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s1">))</span>

        <span class="s2">if </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.iloc:</span>
            <span class="s1">err = ValueError</span>
            <span class="s1">msg = </span><span class="s5">f&quot;Cannot set values with ndim &gt; </span><span class="s2">{</span><span class="s1">obj.ndim</span><span class="s2">}</span><span class="s5">&quot;</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">err = ValueError</span>
            <span class="s1">msg = </span><span class="s5">&quot;|&quot;</span><span class="s1">.join(</span>
                <span class="s1">[</span>
                    <span class="s5">r&quot;Buffer has wrong number of dimensions \(expected 1, got 3\)&quot;</span><span class="s2">,</span>
                    <span class="s5">&quot;Cannot set values with ndim &gt; 1&quot;</span><span class="s2">,</span>
                    <span class="s5">&quot;Index data must be 1-dimensional&quot;</span><span class="s2">,</span>
                    <span class="s5">&quot;Data must be 1-dimensional&quot;</span><span class="s2">,</span>
                    <span class="s5">&quot;Array conditional must be same shape as self&quot;</span><span class="s2">,</span>
                <span class="s1">]</span>
            <span class="s1">)</span>

        <span class="s2">with </span><span class="s1">pytest.raises(err</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">idxr[nd3] = </span><span class="s4">0</span>

    <span class="s2">def </span><span class="s1">test_getitem_ndarray_0d(self):</span>
        <span class="s3"># GH#24924</span>
        <span class="s1">key = np.array(</span><span class="s4">0</span><span class="s1">)</span>

        <span class="s3"># dataframe __getitem__</span>
        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]])</span>
        <span class="s1">result = df[key]</span>
        <span class="s1">expected = Series([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># series __getitem__</span>
        <span class="s1">ser = Series([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">result = ser[key]</span>
        <span class="s2">assert </span><span class="s1">result == </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">test_inf_upcast(self):</span>
        <span class="s3"># GH 16957</span>
        <span class="s3"># We should be able to use np.inf as a key</span>
        <span class="s3"># np.inf should cause an index to convert to float</span>

        <span class="s3"># Test with np.inf in rows</span>
        <span class="s1">df = DataFrame(columns=[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">df.loc[</span><span class="s4">1</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">df.loc[</span><span class="s4">2</span><span class="s1">] = </span><span class="s4">2</span>
        <span class="s1">df.loc[np.inf] = </span><span class="s4">3</span>

        <span class="s3"># make sure we can look up the value</span>
        <span class="s2">assert </span><span class="s1">df.loc[np.inf</span><span class="s2">, </span><span class="s4">0</span><span class="s1">] == </span><span class="s4">3</span>

        <span class="s1">result = df.index</span>
        <span class="s1">expected = Float64Index([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">np.inf])</span>
        <span class="s1">tm.assert_index_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_setitem_dtype_upcast(self):</span>

        <span class="s3"># GH3216</span>
        <span class="s1">df = DataFrame([{</span><span class="s5">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">}</span><span class="s2">, </span><span class="s1">{</span><span class="s5">&quot;a&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">}])</span>
        <span class="s1">df[</span><span class="s5">&quot;c&quot;</span><span class="s1">] = np.nan</span>
        <span class="s2">assert </span><span class="s1">df[</span><span class="s5">&quot;c&quot;</span><span class="s1">].dtype == np.float64</span>

        <span class="s1">df.loc[</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">] = </span><span class="s5">&quot;foo&quot;</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[{</span><span class="s5">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: np.nan</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">: </span><span class="s5">&quot;foo&quot;</span><span class="s1">}</span><span class="s2">, </span><span class="s1">{</span><span class="s5">&quot;a&quot;</span><span class="s1">: </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">: np.nan}]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;val&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">3.14</span><span class="s2">, </span><span class="s5">&quot;wxyz&quot;</span><span class="s1">])</span>
    <span class="s2">def </span><span class="s1">test_setitem_dtype_upcast2(self</span><span class="s2">, </span><span class="s1">val):</span>

        <span class="s3"># GH10280</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s4">6</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;int64&quot;</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">index=list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s1">left = df.copy()</span>
        <span class="s1">left.loc[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">] = val</span>
        <span class="s1">right = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]]</span><span class="s2">,</span>
            <span class="s1">index=list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(left</span><span class="s2">, </span><span class="s1">right)</span>
        <span class="s2">assert </span><span class="s1">is_integer_dtype(left[</span><span class="s5">&quot;foo&quot;</span><span class="s1">])</span>
        <span class="s2">assert </span><span class="s1">is_integer_dtype(left[</span><span class="s5">&quot;baz&quot;</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">test_setitem_dtype_upcast3(self):</span>
        <span class="s1">left = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s4">6</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;int64&quot;</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">10.0</span><span class="s2">,</span>
            <span class="s1">index=list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">left.loc[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">] = </span><span class="s5">&quot;wxyz&quot;</span>

        <span class="s1">right = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;wxyz&quot;</span><span class="s2">, </span><span class="s4">0.2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0.3</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">, </span><span class="s4">0.5</span><span class="s1">]]</span><span class="s2">,</span>
            <span class="s1">index=list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s1">tm.assert_frame_equal(left</span><span class="s2">, </span><span class="s1">right)</span>
        <span class="s2">assert </span><span class="s1">is_float_dtype(left[</span><span class="s5">&quot;foo&quot;</span><span class="s1">])</span>
        <span class="s2">assert </span><span class="s1">is_float_dtype(left[</span><span class="s5">&quot;baz&quot;</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing(self):</span>

        <span class="s3"># GH 3455</span>

        <span class="s1">df = tm.makeCustomDataframe(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">df.columns = [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s1">result = df[[</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">]].columns</span>
        <span class="s1">expected = Index([</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">tm.assert_index_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing_across_dtypes(self):</span>

        <span class="s3"># across dtypes</span>
        <span class="s1">df = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;aaaaaaa&quot;</span><span class="s1">))</span>
        <span class="s1">df.head()</span>
        <span class="s1">str(df)</span>
        <span class="s1">result = DataFrame([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s1">]])</span>
        <span class="s1">result.columns = list(</span><span class="s5">&quot;aaaaaaa&quot;</span><span class="s1">)  </span><span class="s3"># GH#3468</span>

        <span class="s3"># GH#3509 smoke tests for indexing with duplicate columns</span>
        <span class="s1">df.iloc[:</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">result.iloc[:</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]</span>

        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">result)</span>

    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing_not_in_order(self):</span>
        <span class="s3"># GH 3561, dups not in selected order</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;test&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">11</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;test1&quot;</span><span class="s1">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;other&quot;</span><span class="s1">: list(</span><span class="s5">&quot;abcd&quot;</span><span class="s1">)}</span><span class="s2">,</span>
            <span class="s1">index=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">rows = [</span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;test&quot;</span><span class="s1">: [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">9</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;test1&quot;</span><span class="s1">: [</span><span class="s4">7.0</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;other&quot;</span><span class="s1">: [</span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=rows</span>
        <span class="s1">)</span>
        <span class="s1">result = df.loc[rows]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.loc[Index(rows)]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">rows = [</span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;E&quot;</span><span class="s1">]</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;not in index&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[rows]</span>

        <span class="s3"># see GH5553, make sure we use the right indexer</span>
        <span class="s1">rows = [</span><span class="s5">&quot;F&quot;</span><span class="s2">, </span><span class="s5">&quot;G&quot;</span><span class="s2">, </span><span class="s5">&quot;H&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;E&quot;</span><span class="s1">]</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;not in index&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[rows]</span>

    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing_only_missing_label(self):</span>

        <span class="s3"># List containing only missing label</span>
        <span class="s1">dfnu = DataFrame(np.random.randn(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=list(</span><span class="s5">&quot;AABCD&quot;</span><span class="s1">))</span>
        <span class="s2">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">KeyError</span><span class="s2">,</span>
            <span class="s1">match=re.escape(</span>
                <span class="s5">&quot;</span><span class="s2">\&quot;</span><span class="s5">None of [Index(['E'], dtype='object')] are in the [index]</span><span class="s2">\&quot;</span><span class="s5">&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">):</span>
            <span class="s1">dfnu.loc[[</span><span class="s5">&quot;E&quot;</span><span class="s1">]]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;vals&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">list(</span><span class="s5">&quot;abc&quot;</span><span class="s1">)])</span>
    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing_missing_label(self</span><span class="s2">, </span><span class="s1">vals):</span>

        <span class="s3"># GH 4619; duplicate indexer with missing label</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;A&quot;</span><span class="s1">: vals})</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;not in index&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]]</span>

    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing_non_unique(self):</span>

        <span class="s3"># non unique with non unique selector</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;test&quot;</span><span class="s1">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">11</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">])</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;not in index&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;E&quot;</span><span class="s1">]]</span>

    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing2(self):</span>
        <span class="s3"># GH 5835</span>
        <span class="s3"># dups on index and missing values</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s1">)</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">])</span>

        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;not in index&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]]</span>

    <span class="s2">def </span><span class="s1">test_dups_fancy_indexing3(self):</span>

        <span class="s3"># GH 6504, multi-axis indexing</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randn(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

        <span class="s1">expected = df.iloc[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">6</span><span class="s1">]</span>
        <span class="s1">result = df.loc[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df</span>
        <span class="s1">result = df.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">expected = df.iloc[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">6</span><span class="s2">, </span><span class="s1">:]</span>
        <span class="s1">result = df.loc[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_duplicate_int_indexing(self</span><span class="s2">, </span><span class="s1">indexer_sl):</span>
        <span class="s3"># GH 17347</span>
        <span class="s1">ser = Series(range(</span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">expected = Series(range(</span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">result = indexer_sl(ser)[[</span><span class="s4">1</span><span class="s1">]]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_indexing_mixed_frame_bug(self):</span>

        <span class="s3"># GH3492</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s5">&quot;a&quot;</span><span class="s1">: {</span><span class="s4">1</span><span class="s1">: </span><span class="s5">&quot;aaa&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s1">: </span><span class="s5">&quot;bbb&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s1">: </span><span class="s5">&quot;ccc&quot;</span><span class="s1">}</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: {</span><span class="s4">1</span><span class="s1">: </span><span class="s4">111</span><span class="s2">, </span><span class="s4">2</span><span class="s1">: </span><span class="s4">222</span><span class="s2">, </span><span class="s4">3</span><span class="s1">: </span><span class="s4">333</span><span class="s1">}}</span>
        <span class="s1">)</span>

        <span class="s3"># this works, new column is created correctly</span>
        <span class="s1">df[</span><span class="s5">&quot;test&quot;</span><span class="s1">] = df[</span><span class="s5">&quot;a&quot;</span><span class="s1">].apply(</span><span class="s2">lambda </span><span class="s1">x: </span><span class="s5">&quot;_&quot; </span><span class="s2">if </span><span class="s1">x == </span><span class="s5">&quot;aaa&quot; </span><span class="s2">else </span><span class="s1">x)</span>

        <span class="s3"># this does not work, ie column test is not changed</span>
        <span class="s1">idx = df[</span><span class="s5">&quot;test&quot;</span><span class="s1">] == </span><span class="s5">&quot;_&quot;</span>
        <span class="s1">temp = df.loc[idx</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">].apply(</span><span class="s2">lambda </span><span class="s1">x: </span><span class="s5">&quot;-----&quot; </span><span class="s2">if </span><span class="s1">x == </span><span class="s5">&quot;aaa&quot; </span><span class="s2">else </span><span class="s1">x)</span>
        <span class="s1">df.loc[idx</span><span class="s2">, </span><span class="s5">&quot;test&quot;</span><span class="s1">] = temp</span>
        <span class="s2">assert </span><span class="s1">df.iloc[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">] == </span><span class="s5">&quot;-----&quot;</span>

    <span class="s2">def </span><span class="s1">test_multitype_list_index_access(self):</span>
        <span class="s3"># GH 10610</span>
        <span class="s1">df = DataFrame(np.random.random((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">5</span><span class="s1">))</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;a&quot;</span><span class="s1">] + [</span><span class="s4">20</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">22</span><span class="s2">, </span><span class="s4">23</span><span class="s1">])</span>

        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=re.escape(</span><span class="s5">&quot;'[26, -8] not in index'&quot;</span><span class="s1">)):</span>
            <span class="s1">df[[</span><span class="s4">22</span><span class="s2">, </span><span class="s4">26</span><span class="s2">, </span><span class="s1">-</span><span class="s4">8</span><span class="s1">]]</span>
        <span class="s2">assert </span><span class="s1">df[</span><span class="s4">21</span><span class="s1">].shape[</span><span class="s4">0</span><span class="s1">] == df.shape[</span><span class="s4">0</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">test_set_index_nan(self):</span>

        <span class="s3"># GH 3586</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;PRuid&quot;</span><span class="s1">: {</span>
                    <span class="s4">17</span><span class="s1">: </span><span class="s5">&quot;nonQC&quot;</span><span class="s2">,</span>
                    <span class="s4">18</span><span class="s1">: </span><span class="s5">&quot;nonQC&quot;</span><span class="s2">,</span>
                    <span class="s4">19</span><span class="s1">: </span><span class="s5">&quot;nonQC&quot;</span><span class="s2">,</span>
                    <span class="s4">20</span><span class="s1">: </span><span class="s5">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s4">21</span><span class="s1">: </span><span class="s5">&quot;11&quot;</span><span class="s2">,</span>
                    <span class="s4">22</span><span class="s1">: </span><span class="s5">&quot;12&quot;</span><span class="s2">,</span>
                    <span class="s4">23</span><span class="s1">: </span><span class="s5">&quot;13&quot;</span><span class="s2">,</span>
                    <span class="s4">24</span><span class="s1">: </span><span class="s5">&quot;24&quot;</span><span class="s2">,</span>
                    <span class="s4">25</span><span class="s1">: </span><span class="s5">&quot;35&quot;</span><span class="s2">,</span>
                    <span class="s4">26</span><span class="s1">: </span><span class="s5">&quot;46&quot;</span><span class="s2">,</span>
                    <span class="s4">27</span><span class="s1">: </span><span class="s5">&quot;47&quot;</span><span class="s2">,</span>
                    <span class="s4">28</span><span class="s1">: </span><span class="s5">&quot;48&quot;</span><span class="s2">,</span>
                    <span class="s4">29</span><span class="s1">: </span><span class="s5">&quot;59&quot;</span><span class="s2">,</span>
                    <span class="s4">30</span><span class="s1">: </span><span class="s5">&quot;10&quot;</span><span class="s2">,</span>
                <span class="s1">}</span><span class="s2">,</span>
                <span class="s5">&quot;QC&quot;</span><span class="s1">: {</span>
                    <span class="s4">17</span><span class="s1">: </span><span class="s4">0.0</span><span class="s2">,</span>
                    <span class="s4">18</span><span class="s1">: </span><span class="s4">0.0</span><span class="s2">,</span>
                    <span class="s4">19</span><span class="s1">: </span><span class="s4">0.0</span><span class="s2">,</span>
                    <span class="s4">20</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">21</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">22</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">23</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">24</span><span class="s1">: </span><span class="s4">1.0</span><span class="s2">,</span>
                    <span class="s4">25</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">26</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">27</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">28</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">29</span><span class="s1">: np.nan</span><span class="s2">,</span>
                    <span class="s4">30</span><span class="s1">: np.nan</span><span class="s2">,</span>
                <span class="s1">}</span><span class="s2">,</span>
                <span class="s5">&quot;data&quot;</span><span class="s1">: {</span>
                    <span class="s4">17</span><span class="s1">: </span><span class="s4">7.9544899999999998</span><span class="s2">,</span>
                    <span class="s4">18</span><span class="s1">: </span><span class="s4">8.0142609999999994</span><span class="s2">,</span>
                    <span class="s4">19</span><span class="s1">: </span><span class="s4">7.8591520000000008</span><span class="s2">,</span>
                    <span class="s4">20</span><span class="s1">: </span><span class="s4">0.86140349999999999</span><span class="s2">,</span>
                    <span class="s4">21</span><span class="s1">: </span><span class="s4">0.87853110000000001</span><span class="s2">,</span>
                    <span class="s4">22</span><span class="s1">: </span><span class="s4">0.8427041999999999</span><span class="s2">,</span>
                    <span class="s4">23</span><span class="s1">: </span><span class="s4">0.78587700000000005</span><span class="s2">,</span>
                    <span class="s4">24</span><span class="s1">: </span><span class="s4">0.73062459999999996</span><span class="s2">,</span>
                    <span class="s4">25</span><span class="s1">: </span><span class="s4">0.81668560000000001</span><span class="s2">,</span>
                    <span class="s4">26</span><span class="s1">: </span><span class="s4">0.81927080000000008</span><span class="s2">,</span>
                    <span class="s4">27</span><span class="s1">: </span><span class="s4">0.80705009999999999</span><span class="s2">,</span>
                    <span class="s4">28</span><span class="s1">: </span><span class="s4">0.81440240000000008</span><span class="s2">,</span>
                    <span class="s4">29</span><span class="s1">: </span><span class="s4">0.80140849999999997</span><span class="s2">,</span>
                    <span class="s4">30</span><span class="s1">: </span><span class="s4">0.81307740000000006</span><span class="s2">,</span>
                <span class="s1">}</span><span class="s2">,</span>
                <span class="s5">&quot;year&quot;</span><span class="s1">: {</span>
                    <span class="s4">17</span><span class="s1">: </span><span class="s4">2006</span><span class="s2">,</span>
                    <span class="s4">18</span><span class="s1">: </span><span class="s4">2007</span><span class="s2">,</span>
                    <span class="s4">19</span><span class="s1">: </span><span class="s4">2008</span><span class="s2">,</span>
                    <span class="s4">20</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">21</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">22</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">23</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">24</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">25</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">26</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">27</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">28</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">29</span><span class="s1">: </span><span class="s4">1985</span><span class="s2">,</span>
                    <span class="s4">30</span><span class="s1">: </span><span class="s4">1986</span><span class="s2">,</span>
                <span class="s1">}</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">).reset_index()</span>

        <span class="s1">result = (</span>
            <span class="s1">df.set_index([</span><span class="s5">&quot;year&quot;</span><span class="s2">, </span><span class="s5">&quot;PRuid&quot;</span><span class="s2">, </span><span class="s5">&quot;QC&quot;</span><span class="s1">])</span>
            <span class="s1">.reset_index()</span>
            <span class="s1">.reindex(columns=df.columns)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">df)</span>

    <span class="s2">def </span><span class="s1">test_multi_assign(self):</span>

        <span class="s3"># GH 3626, an assignment of a sub-df to a df</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;FC&quot;</span><span class="s1">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;PF&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;col1&quot;</span><span class="s1">: list(range(</span><span class="s4">6</span><span class="s1">))</span><span class="s2">,</span>
                <span class="s5">&quot;col2&quot;</span><span class="s1">: list(range(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">12</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df.iloc[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">] = np.nan</span>
        <span class="s1">df2 = df.copy()</span>

        <span class="s1">mask = ~df2.FC.isna()</span>
        <span class="s1">cols = [</span><span class="s5">&quot;col1&quot;</span><span class="s2">, </span><span class="s5">&quot;col2&quot;</span><span class="s1">]</span>

        <span class="s1">dft = df2 * </span><span class="s4">2</span>
        <span class="s1">dft.iloc[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">] = np.nan</span>

        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;FC&quot;</span><span class="s1">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;PF&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;col1&quot;</span><span class="s1">: Series([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">10</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s5">&quot;col2&quot;</span><span class="s1">: [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">22</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s3"># frame on rhs</span>
        <span class="s1">df2.loc[mask</span><span class="s2">, </span><span class="s1">cols] = dft.loc[mask</span><span class="s2">, </span><span class="s1">cols]</span>
        <span class="s1">tm.assert_frame_equal(df2</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># with an ndarray on rhs</span>
        <span class="s3"># coerces to float64 because values has float64 dtype</span>
        <span class="s3"># GH 14001</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;FC&quot;</span><span class="s1">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;PF&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;col1&quot;</span><span class="s1">: [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">8.0</span><span class="s2">, </span><span class="s4">10.0</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;col2&quot;</span><span class="s1">: [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s1">np.nan</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">22</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df2 = df.copy()</span>
        <span class="s1">df2.loc[mask</span><span class="s2">, </span><span class="s1">cols] = dft.loc[mask</span><span class="s2">, </span><span class="s1">cols].values</span>
        <span class="s1">tm.assert_frame_equal(df2</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_multi_assign_broadcasting_rhs(self):</span>
        <span class="s3"># broadcasting on the rhs is required</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;C&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;D&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = df.copy()</span>
        <span class="s1">mask = expected[</span><span class="s5">&quot;A&quot;</span><span class="s1">] == </span><span class="s4">0</span>
        <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]:</span>
            <span class="s1">expected.loc[mask</span><span class="s2">, </span><span class="s1">col] = df[</span><span class="s5">&quot;D&quot;</span><span class="s1">]</span>

        <span class="s1">df.loc[df[</span><span class="s5">&quot;A&quot;</span><span class="s1">] == </span><span class="s4">0</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]] = df[</span><span class="s5">&quot;D&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s3"># TODO(ArrayManager) setting single item with an iterable doesn't work yet</span>
    <span class="s3"># in the &quot;split&quot; path</span>
    <span class="s1">@td.skip_array_manager_not_yet_implemented</span>
    <span class="s2">def </span><span class="s1">test_setitem_list(self):</span>

        <span class="s3"># GH 6043</span>
        <span class="s3"># iloc with a list</span>
        <span class="s1">df = DataFrame(index=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">df.iloc[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">] = [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span>
        <span class="s1">df.iloc[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">] = [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span>

        <span class="s1">result = DataFrame(index=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">result.iloc[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">] = [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span>

        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">df)</span>

    <span class="s2">def </span><span class="s1">test_string_slice(self):</span>
        <span class="s3"># GH 14424</span>
        <span class="s3"># string indexing against datetimelike with object</span>
        <span class="s3"># dtype should properly raises KeyError</span>
        <span class="s1">df = DataFrame([</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">Index([pd.Timestamp(</span><span class="s5">&quot;2011-01-01&quot;</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">dtype=object))</span>
        <span class="s2">assert </span><span class="s1">df.index._is_all_dates</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;'2011'&quot;</span><span class="s1">):</span>
            <span class="s1">df[</span><span class="s5">&quot;2011&quot;</span><span class="s1">]</span>

        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;'2011'&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[</span><span class="s5">&quot;2011&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">test_string_slice_empty(self):</span>
        <span class="s3"># GH 14424</span>

        <span class="s1">df = DataFrame()</span>
        <span class="s2">assert not </span><span class="s1">df.index._is_all_dates</span>
        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;'2011'&quot;</span><span class="s1">):</span>
            <span class="s1">df[</span><span class="s5">&quot;2011&quot;</span><span class="s1">]</span>

        <span class="s2">with </span><span class="s1">pytest.raises(KeyError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;^0$&quot;</span><span class="s1">):</span>
            <span class="s1">df.loc[</span><span class="s5">&quot;2011&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">test_astype_assignment(self):</span>

        <span class="s3"># GH4312 (iloc)</span>
        <span class="s1">df_orig = DataFrame(</span>
            <span class="s1">[[</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;3&quot;</span><span class="s2">, </span><span class="s5">&quot;.4&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;ABCDEFG&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s1">df = df_orig.copy()</span>
        <span class="s1">df.iloc[:</span><span class="s2">, </span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">] = df.iloc[:</span><span class="s2">, </span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">].astype(np.int64)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;3&quot;</span><span class="s2">, </span><span class="s5">&quot;.4&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;ABCDEFG&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">df = df_orig.copy()</span>
        <span class="s1">df.iloc[:</span><span class="s2">, </span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">] = df.iloc[:</span><span class="s2">, </span><span class="s4">0</span><span class="s1">:</span><span class="s4">2</span><span class="s1">]._convert(datetime=</span><span class="s2">True, </span><span class="s1">numeric=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;3&quot;</span><span class="s2">, </span><span class="s5">&quot;.4&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;ABCDEFG&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># GH5702 (loc)</span>
        <span class="s1">df = df_orig.copy()</span>
        <span class="s1">df.loc[:</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">] = df.loc[:</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">].astype(np.int64)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">, </span><span class="s5">&quot;3&quot;</span><span class="s2">, </span><span class="s5">&quot;.4&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;ABCDEFG&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">df = df_orig.copy()</span>
        <span class="s1">df.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]] = df.loc[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s1">]].astype(np.int64)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;.4&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;ABCDEFG&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_astype_assignment_full_replacements(self):</span>
        <span class="s3"># full replacements / no nans</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s1">]})</span>
        <span class="s1">df.iloc[:</span><span class="s2">, </span><span class="s4">0</span><span class="s1">] = df[</span><span class="s5">&quot;A&quot;</span><span class="s1">].astype(np.int64)</span>
        <span class="s1">expected = DataFrame({</span><span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s1">]})</span>
        <span class="s1">df.loc[:</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s1">] = df[</span><span class="s5">&quot;A&quot;</span><span class="s1">].astype(np.int64)</span>
        <span class="s1">expected = DataFrame({</span><span class="s5">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;indexer&quot;</span><span class="s2">, </span><span class="s1">[tm.getitem</span><span class="s2">, </span><span class="s1">tm.loc])</span>
    <span class="s2">def </span><span class="s1">test_index_type_coercion(self</span><span class="s2">, </span><span class="s1">indexer):</span>

        <span class="s3"># GH 11836</span>
        <span class="s3"># if we have an index type and set it with something that looks</span>
        <span class="s3"># to numpy like the same, but is actually, not</span>
        <span class="s3"># (e.g. setting with a float or string '0')</span>
        <span class="s3"># then we need to coerce to object</span>

        <span class="s3"># integer indexes</span>
        <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">[Series(range(</span><span class="s4">5</span><span class="s1">))</span><span class="s2">, </span><span class="s1">Series(range(</span><span class="s4">5</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=range(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s1">))]:</span>

            <span class="s2">assert </span><span class="s1">s.index.is_integer()</span>

            <span class="s1">s2 = s.copy()</span>
            <span class="s1">indexer(s2)[</span><span class="s4">0.1</span><span class="s1">] = </span><span class="s4">0</span>
            <span class="s2">assert </span><span class="s1">s2.index.is_floating()</span>
            <span class="s2">assert </span><span class="s1">indexer(s2)[</span><span class="s4">0.1</span><span class="s1">] == </span><span class="s4">0</span>

            <span class="s1">s2 = s.copy()</span>
            <span class="s1">indexer(s2)[</span><span class="s4">0.0</span><span class="s1">] = </span><span class="s4">0</span>
            <span class="s1">exp = s.index</span>
            <span class="s2">if </span><span class="s4">0 </span><span class="s2">not in </span><span class="s1">s:</span>
                <span class="s1">exp = Index(s.index.tolist() + [</span><span class="s4">0</span><span class="s1">])</span>
            <span class="s1">tm.assert_index_equal(s2.index</span><span class="s2">, </span><span class="s1">exp)</span>

            <span class="s1">s2 = s.copy()</span>
            <span class="s1">indexer(s2)[</span><span class="s5">&quot;0&quot;</span><span class="s1">] = </span><span class="s4">0</span>
            <span class="s2">assert </span><span class="s1">s2.index.is_object()</span>

        <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">[Series(range(</span><span class="s4">5</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=np.arange(</span><span class="s4">5.0</span><span class="s1">))]:</span>

            <span class="s2">assert </span><span class="s1">s.index.is_floating()</span>

            <span class="s1">s2 = s.copy()</span>
            <span class="s1">indexer(s2)[</span><span class="s4">0.1</span><span class="s1">] = </span><span class="s4">0</span>
            <span class="s2">assert </span><span class="s1">s2.index.is_floating()</span>
            <span class="s2">assert </span><span class="s1">indexer(s2)[</span><span class="s4">0.1</span><span class="s1">] == </span><span class="s4">0</span>

            <span class="s1">s2 = s.copy()</span>
            <span class="s1">indexer(s2)[</span><span class="s4">0.0</span><span class="s1">] = </span><span class="s4">0</span>
            <span class="s1">tm.assert_index_equal(s2.index</span><span class="s2">, </span><span class="s1">s.index)</span>

            <span class="s1">s2 = s.copy()</span>
            <span class="s1">indexer(s2)[</span><span class="s5">&quot;0&quot;</span><span class="s1">] = </span><span class="s4">0</span>
            <span class="s2">assert </span><span class="s1">s2.index.is_object()</span>


<span class="s2">class </span><span class="s1">TestMisc:</span>
    <span class="s2">def </span><span class="s1">test_float_index_to_mixed(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s4">0.0</span><span class="s1">: np.random.rand(</span><span class="s4">10</span><span class="s1">)</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">: np.random.rand(</span><span class="s4">10</span><span class="s1">)})</span>
        <span class="s1">df[</span><span class="s5">&quot;a&quot;</span><span class="s1">] = </span><span class="s4">10</span>

        <span class="s1">expected = DataFrame({</span><span class="s4">0.0</span><span class="s1">: df[</span><span class="s4">0.0</span><span class="s1">]</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">: df[</span><span class="s4">1.0</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">10</span><span class="s1">] * </span><span class="s4">10</span><span class="s1">})</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">df)</span>

    <span class="s2">def </span><span class="s1">test_float_index_non_scalar_assignment(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s1">])</span>
        <span class="s1">df.loc[df.index[:</span><span class="s4">2</span><span class="s1">]] = </span><span class="s4">1</span>
        <span class="s1">expected = DataFrame({</span><span class="s5">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=df.index)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">df)</span>

    <span class="s2">def </span><span class="s1">test_loc_setitem_fullindex_views(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s1">])</span>
        <span class="s1">df2 = df.copy()</span>
        <span class="s1">df.loc[df.index] = df.loc[df.index]</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">df2)</span>

    <span class="s2">def </span><span class="s1">test_rhs_alignment(self):</span>
        <span class="s3"># GH8258, tests that both rows &amp; columns are aligned to what is</span>
        <span class="s3"># assigned to. covers both uniform data-type &amp; multi-type cases</span>
        <span class="s2">def </span><span class="s1">run_tests(df</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">right_loc</span><span class="s2">, </span><span class="s1">right_iloc):</span>
            <span class="s3"># label, index, slice</span>
            <span class="s1">lbl_one</span><span class="s2">, </span><span class="s1">idx_one</span><span class="s2">, </span><span class="s1">slice_one = list(</span><span class="s5">&quot;bcd&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s1">)</span>
            <span class="s1">lbl_two</span><span class="s2">, </span><span class="s1">idx_two</span><span class="s2">, </span><span class="s1">slice_two = [</span><span class="s5">&quot;joe&quot;</span><span class="s2">, </span><span class="s5">&quot;jolie&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>

            <span class="s1">left = df.copy()</span>
            <span class="s1">left.loc[lbl_one</span><span class="s2">, </span><span class="s1">lbl_two] = rhs</span>
            <span class="s1">tm.assert_frame_equal(left</span><span class="s2">, </span><span class="s1">right_loc)</span>

            <span class="s1">left = df.copy()</span>
            <span class="s1">left.iloc[idx_one</span><span class="s2">, </span><span class="s1">idx_two] = rhs</span>
            <span class="s1">tm.assert_frame_equal(left</span><span class="s2">, </span><span class="s1">right_iloc)</span>

            <span class="s1">left = df.copy()</span>
            <span class="s1">left.iloc[slice_one</span><span class="s2">, </span><span class="s1">slice_two] = rhs</span>
            <span class="s1">tm.assert_frame_equal(left</span><span class="s2">, </span><span class="s1">right_iloc)</span>

        <span class="s1">xs = np.arange(</span><span class="s4">20</span><span class="s1">).reshape(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">cols = [</span><span class="s5">&quot;jim&quot;</span><span class="s2">, </span><span class="s5">&quot;joe&quot;</span><span class="s2">, </span><span class="s5">&quot;jolie&quot;</span><span class="s2">, </span><span class="s5">&quot;joline&quot;</span><span class="s1">]</span>
        <span class="s1">df = DataFrame(xs</span><span class="s2">, </span><span class="s1">columns=cols</span><span class="s2">, </span><span class="s1">index=list(</span><span class="s5">&quot;abcde&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;int64&quot;</span><span class="s1">)</span>

        <span class="s3"># right hand side; permute the indices and multiplpy by -2</span>
        <span class="s1">rhs = -</span><span class="s4">2 </span><span class="s1">* df.iloc[</span><span class="s4">3</span><span class="s1">:</span><span class="s4">0</span><span class="s1">:-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">:</span><span class="s4">0</span><span class="s1">:-</span><span class="s4">1</span><span class="s1">]</span>

        <span class="s3"># expected `right` result; just multiply by -2</span>
        <span class="s1">right_iloc = df.copy()</span>
        <span class="s1">right_iloc[</span><span class="s5">&quot;joe&quot;</span><span class="s1">] = [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">14</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">17</span><span class="s1">]</span>
        <span class="s1">right_iloc[</span><span class="s5">&quot;jolie&quot;</span><span class="s1">] = [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">18</span><span class="s1">]</span>
        <span class="s1">right_iloc.iloc[</span><span class="s4">1</span><span class="s1">:</span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s1">:</span><span class="s4">3</span><span class="s1">] *= -</span><span class="s4">2</span>
        <span class="s1">right_loc = df.copy()</span>
        <span class="s1">right_loc.iloc[</span><span class="s4">1</span><span class="s1">:</span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s1">:</span><span class="s4">3</span><span class="s1">] *= -</span><span class="s4">2</span>

        <span class="s3"># run tests with uniform dtypes</span>
        <span class="s1">run_tests(df</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">right_loc</span><span class="s2">, </span><span class="s1">right_iloc)</span>

        <span class="s3"># make frames multi-type &amp; re-run tests</span>
        <span class="s2">for </span><span class="s1">frame </span><span class="s2">in </span><span class="s1">[df</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">right_loc</span><span class="s2">, </span><span class="s1">right_iloc]:</span>
            <span class="s1">frame[</span><span class="s5">&quot;joe&quot;</span><span class="s1">] = frame[</span><span class="s5">&quot;joe&quot;</span><span class="s1">].astype(</span><span class="s5">&quot;float64&quot;</span><span class="s1">)</span>
            <span class="s1">frame[</span><span class="s5">&quot;jolie&quot;</span><span class="s1">] = frame[</span><span class="s5">&quot;jolie&quot;</span><span class="s1">].map(</span><span class="s5">&quot;@{}&quot;</span><span class="s1">.format)</span>
        <span class="s1">right_iloc[</span><span class="s5">&quot;joe&quot;</span><span class="s1">] = [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s5">&quot;@-28&quot;</span><span class="s2">, </span><span class="s5">&quot;@-20&quot;</span><span class="s2">, </span><span class="s5">&quot;@-12&quot;</span><span class="s2">, </span><span class="s4">17.0</span><span class="s1">]</span>
        <span class="s1">right_iloc[</span><span class="s5">&quot;jolie&quot;</span><span class="s1">] = [</span><span class="s5">&quot;@2&quot;</span><span class="s2">, </span><span class="s1">-</span><span class="s4">26.0</span><span class="s2">, </span><span class="s1">-</span><span class="s4">18.0</span><span class="s2">, </span><span class="s1">-</span><span class="s4">10.0</span><span class="s2">, </span><span class="s5">&quot;@18&quot;</span><span class="s1">]</span>
        <span class="s1">run_tests(df</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">right_loc</span><span class="s2">, </span><span class="s1">right_iloc)</span>

    <span class="s2">def </span><span class="s1">test_str_label_slicing_with_negative_step(self):</span>
        <span class="s1">SLC = pd.IndexSlice</span>

        <span class="s2">for </span><span class="s1">idx </span><span class="s2">in </span><span class="s1">[_mklbl(</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.arange(</span><span class="s4">20</span><span class="s1">) + </span><span class="s4">100</span><span class="s2">, </span><span class="s1">np.linspace(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">150</span><span class="s2">, </span><span class="s4">20</span><span class="s1">)]:</span>
            <span class="s1">idx = Index(idx)</span>
            <span class="s1">ser = Series(np.arange(</span><span class="s4">20</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=idx)</span>
            <span class="s1">tm.assert_indexing_slices_equivalent(ser</span><span class="s2">, </span><span class="s1">SLC[idx[</span><span class="s4">9</span><span class="s1">] :: -</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">SLC[</span><span class="s4">9</span><span class="s1">::-</span><span class="s4">1</span><span class="s1">])</span>
            <span class="s1">tm.assert_indexing_slices_equivalent(ser</span><span class="s2">, </span><span class="s1">SLC[: idx[</span><span class="s4">9</span><span class="s1">] : -</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">SLC[:</span><span class="s4">8</span><span class="s1">:-</span><span class="s4">1</span><span class="s1">])</span>
            <span class="s1">tm.assert_indexing_slices_equivalent(</span>
                <span class="s1">ser</span><span class="s2">, </span><span class="s1">SLC[idx[</span><span class="s4">13</span><span class="s1">] : idx[</span><span class="s4">9</span><span class="s1">] : -</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">SLC[</span><span class="s4">13</span><span class="s1">:</span><span class="s4">8</span><span class="s1">:-</span><span class="s4">1</span><span class="s1">]</span>
            <span class="s1">)</span>
            <span class="s1">tm.assert_indexing_slices_equivalent(</span>
                <span class="s1">ser</span><span class="s2">, </span><span class="s1">SLC[idx[</span><span class="s4">9</span><span class="s1">] : idx[</span><span class="s4">13</span><span class="s1">] : -</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">SLC[:</span><span class="s4">0</span><span class="s1">]</span>
            <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_slice_with_zero_step_raises(self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">indexer_sl</span><span class="s2">, </span><span class="s1">frame_or_series):</span>
        <span class="s1">obj = frame_or_series(np.arange(len(index))</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;slice step cannot be zero&quot;</span><span class="s1">):</span>
            <span class="s1">indexer_sl(obj)[::</span><span class="s4">0</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">test_loc_setitem_indexing_assignment_dict_already_exists(self):</span>
        <span class="s1">index = Index([-</span><span class="s4">5</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;z&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;x&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">8</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">rhs = {</span><span class="s5">&quot;x&quot;</span><span class="s1">: </span><span class="s4">9</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s1">: </span><span class="s4">99</span><span class="s1">}</span>
        <span class="s1">df.loc[</span><span class="s4">5</span><span class="s1">] = rhs</span>
        <span class="s1">expected.loc[</span><span class="s4">5</span><span class="s1">] = [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">99</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s3"># GH#38335 same thing, mixed dtypes</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;x&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">8.0</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">df.loc[</span><span class="s4">5</span><span class="s1">] = rhs</span>
        <span class="s1">expected = DataFrame({</span><span class="s5">&quot;x&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">99.0</span><span class="s1">]}</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_iloc_getitem_indexing_dtypes_on_empty(self):</span>
        <span class="s3"># Check that .iloc returns correct dtypes GH9983</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b2&quot;</span><span class="s2">, </span><span class="s5">&quot;b3&quot;</span><span class="s1">]})</span>
        <span class="s1">df2 = df.iloc[[]</span><span class="s2">, </span><span class="s1">:]</span>

        <span class="s2">assert </span><span class="s1">df2.loc[:</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">].dtype == np.int64</span>
        <span class="s1">tm.assert_series_equal(df2.loc[:</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">df2.iloc[:</span><span class="s2">, </span><span class="s4">0</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;size&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">999999</span><span class="s2">, </span><span class="s4">1000000</span><span class="s1">])</span>
    <span class="s2">def </span><span class="s1">test_loc_range_in_series_indexing(self</span><span class="s2">, </span><span class="s1">size):</span>
        <span class="s3"># range can cause an indexing error</span>
        <span class="s3"># GH 11652</span>
        <span class="s1">s = Series(index=range(size)</span><span class="s2">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">s.loc[range(</span><span class="s4">1</span><span class="s1">)] = </span><span class="s4">42</span>
        <span class="s1">tm.assert_series_equal(s.loc[range(</span><span class="s4">1</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">Series(</span><span class="s4">42.0</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s1">]))</span>

        <span class="s1">s.loc[range(</span><span class="s4">2</span><span class="s1">)] = </span><span class="s4">43</span>
        <span class="s1">tm.assert_series_equal(s.loc[range(</span><span class="s4">2</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">Series(</span><span class="s4">43.0</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]))</span>

    <span class="s2">def </span><span class="s1">test_partial_boolean_frame_indexing(self):</span>
        <span class="s3"># GH 17170</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.arange(</span><span class="s4">9.0</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=list(</span><span class="s5">&quot;abc&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;ABC&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">index_df = DataFrame(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">index=list(</span><span class="s5">&quot;ab&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">columns=list(</span><span class="s5">&quot;AB&quot;</span><span class="s1">))</span>
        <span class="s1">result = df[index_df.notnull()]</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">np.array([[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">np.nan]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s1">np.nan]</span><span class="s2">, </span><span class="s1">[np.nan] * </span><span class="s4">3</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">index=list(</span><span class="s5">&quot;abc&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">columns=list(</span><span class="s5">&quot;ABC&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_no_reference_cycle(self):</span>
        <span class="s1">df = DataFrame({</span><span class="s5">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]})</span>
        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">(</span><span class="s5">&quot;loc&quot;</span><span class="s2">, </span><span class="s5">&quot;iloc&quot;</span><span class="s2">, </span><span class="s5">&quot;at&quot;</span><span class="s2">, </span><span class="s5">&quot;iat&quot;</span><span class="s1">):</span>
            <span class="s1">getattr(df</span><span class="s2">, </span><span class="s1">name)</span>
        <span class="s1">wr = weakref.ref(df)</span>
        <span class="s2">del </span><span class="s1">df</span>
        <span class="s2">assert </span><span class="s1">wr() </span><span class="s2">is None</span>

    <span class="s2">def </span><span class="s1">test_label_indexing_on_nan(self</span><span class="s2">, </span><span class="s1">nulls_fixture):</span>
        <span class="s3"># GH 32431</span>
        <span class="s1">df = Series([</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;{1,2}&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">nulls_fixture])</span>
        <span class="s1">vc = df.value_counts(dropna=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s1">result1 = vc.loc[nulls_fixture]</span>
        <span class="s1">result2 = vc[nulls_fixture]</span>

        <span class="s1">expected = </span><span class="s4">1</span>
        <span class="s2">assert </span><span class="s1">result1 == expected</span>
        <span class="s2">assert </span><span class="s1">result2 == expected</span>


<span class="s2">class </span><span class="s1">TestDataframeNoneCoercion:</span>
    <span class="s1">EXPECTED_SINGLE_ROW_RESULTS = [</span>
        <span class="s3"># For numeric series, we should coerce to NaN.</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[np.nan</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[np.nan</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s3"># For datetime series, we should coerce to NaT.</span>
        <span class="s1">(</span>
            <span class="s1">[datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s2">,</span>
            <span class="s1">[NaT</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s3"># For objects, we should preserve the None value.</span>
        <span class="s1">([</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s2">None, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s1">])</span><span class="s2">,</span>
    <span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;expected&quot;</span><span class="s2">, </span><span class="s1">EXPECTED_SINGLE_ROW_RESULTS)</span>
    <span class="s2">def </span><span class="s1">test_coercion_with_loc(self</span><span class="s2">, </span><span class="s1">expected):</span>
        <span class="s1">start_data</span><span class="s2">, </span><span class="s1">expected_result = expected</span>

        <span class="s1">start_dataframe = DataFrame({</span><span class="s5">&quot;foo&quot;</span><span class="s1">: start_data})</span>
        <span class="s1">start_dataframe.loc[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;foo&quot;</span><span class="s1">]] = </span><span class="s2">None</span>

        <span class="s1">expected_dataframe = DataFrame({</span><span class="s5">&quot;foo&quot;</span><span class="s1">: expected_result})</span>
        <span class="s1">tm.assert_frame_equal(start_dataframe</span><span class="s2">, </span><span class="s1">expected_dataframe)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;expected&quot;</span><span class="s2">, </span><span class="s1">EXPECTED_SINGLE_ROW_RESULTS)</span>
    <span class="s2">def </span><span class="s1">test_coercion_with_setitem_and_dataframe(self</span><span class="s2">, </span><span class="s1">expected):</span>
        <span class="s1">start_data</span><span class="s2">, </span><span class="s1">expected_result = expected</span>

        <span class="s1">start_dataframe = DataFrame({</span><span class="s5">&quot;foo&quot;</span><span class="s1">: start_data})</span>
        <span class="s1">start_dataframe[start_dataframe[</span><span class="s5">&quot;foo&quot;</span><span class="s1">] == start_dataframe[</span><span class="s5">&quot;foo&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]] = </span><span class="s2">None</span>

        <span class="s1">expected_dataframe = DataFrame({</span><span class="s5">&quot;foo&quot;</span><span class="s1">: expected_result})</span>
        <span class="s1">tm.assert_frame_equal(start_dataframe</span><span class="s2">, </span><span class="s1">expected_dataframe)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;expected&quot;</span><span class="s2">, </span><span class="s1">EXPECTED_SINGLE_ROW_RESULTS)</span>
    <span class="s2">def </span><span class="s1">test_none_coercion_loc_and_dataframe(self</span><span class="s2">, </span><span class="s1">expected):</span>
        <span class="s1">start_data</span><span class="s2">, </span><span class="s1">expected_result = expected</span>

        <span class="s1">start_dataframe = DataFrame({</span><span class="s5">&quot;foo&quot;</span><span class="s1">: start_data})</span>
        <span class="s1">start_dataframe.loc[start_dataframe[</span><span class="s5">&quot;foo&quot;</span><span class="s1">] == start_dataframe[</span><span class="s5">&quot;foo&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]] = </span><span class="s2">None</span>

        <span class="s1">expected_dataframe = DataFrame({</span><span class="s5">&quot;foo&quot;</span><span class="s1">: expected_result})</span>
        <span class="s1">tm.assert_frame_equal(start_dataframe</span><span class="s2">, </span><span class="s1">expected_dataframe)</span>

    <span class="s2">def </span><span class="s1">test_none_coercion_mixed_dtypes(self):</span>
        <span class="s1">start_dataframe = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;b&quot;</span><span class="s1">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;c&quot;</span><span class="s1">: [datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s2">,</span>
                <span class="s5">&quot;d&quot;</span><span class="s1">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">start_dataframe.iloc[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">None</span>

        <span class="s1">exp = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s5">&quot;a&quot;</span><span class="s1">: [np.nan</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;b&quot;</span><span class="s1">: [np.nan</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s5">&quot;c&quot;</span><span class="s1">: [NaT</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">datetime(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s2">,</span>
                <span class="s5">&quot;d&quot;</span><span class="s1">: [</span><span class="s2">None, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(start_dataframe</span><span class="s2">, </span><span class="s1">exp)</span>


<span class="s2">class </span><span class="s1">TestDatetimelikeCoercion:</span>
    <span class="s2">def </span><span class="s1">test_setitem_dt64_string_scalar(self</span><span class="s2">, </span><span class="s1">tz_naive_fixture</span><span class="s2">, </span><span class="s1">indexer_sli):</span>
        <span class="s3"># dispatching _can_hold_element to underlying DatetimeArray</span>
        <span class="s1">tz = tz_naive_fixture</span>

        <span class="s1">dti = date_range(</span><span class="s5">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz=tz)</span>
        <span class="s1">ser = Series(dti)</span>

        <span class="s1">values = ser._values</span>

        <span class="s1">newval = </span><span class="s5">&quot;2018-01-01&quot;</span>
        <span class="s1">values._validate_setitem_value(newval)</span>

        <span class="s1">indexer_sli(ser)[</span><span class="s4">0</span><span class="s1">] = newval</span>

        <span class="s2">if </span><span class="s1">tz </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s3"># TODO(EA2D): we can make this no-copy in tz-naive case too</span>
            <span class="s2">assert </span><span class="s1">ser.dtype == dti.dtype</span>
            <span class="s2">assert </span><span class="s1">ser._values._data </span><span class="s2">is </span><span class="s1">values._data</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">assert </span><span class="s1">ser._values </span><span class="s2">is </span><span class="s1">values</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;box&quot;</span><span class="s2">, </span><span class="s1">[list</span><span class="s2">, </span><span class="s1">np.array</span><span class="s2">, </span><span class="s1">pd.array</span><span class="s2">, </span><span class="s1">pd.Categorical</span><span class="s2">, </span><span class="s1">Index])</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s5">&quot;key&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s2">True, True, False</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s2">def </span><span class="s1">test_setitem_dt64_string_values(self</span><span class="s2">, </span><span class="s1">tz_naive_fixture</span><span class="s2">, </span><span class="s1">indexer_sli</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">box):</span>
        <span class="s3"># dispatching _can_hold_element to underling DatetimeArray</span>
        <span class="s1">tz = tz_naive_fixture</span>

        <span class="s2">if </span><span class="s1">isinstance(key</span><span class="s2">, </span><span class="s1">slice) </span><span class="s2">and </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.loc:</span>
            <span class="s1">key = slice(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>

        <span class="s1">dti = date_range(</span><span class="s5">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz=tz)</span>
        <span class="s1">ser = Series(dti)</span>

        <span class="s1">values = ser._values</span>

        <span class="s1">newvals = box([</span><span class="s5">&quot;2019-01-01&quot;</span><span class="s2">, </span><span class="s5">&quot;2010-01-02&quot;</span><span class="s1">])</span>
        <span class="s1">values._validate_setitem_value(newvals)</span>

        <span class="s1">indexer_sli(ser)[key] = newvals</span>

        <span class="s2">if </span><span class="s1">tz </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s3"># TODO(EA2D): we can make this no-copy in tz-naive case too</span>
            <span class="s2">assert </span><span class="s1">ser.dtype == dti.dtype</span>
            <span class="s2">assert </span><span class="s1">ser._values._data </span><span class="s2">is </span><span class="s1">values._data</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">assert </span><span class="s1">ser._values </span><span class="s2">is </span><span class="s1">values</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;scalar&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;3 Days&quot;</span><span class="s2">, </span><span class="s1">offsets.Hour(</span><span class="s4">4</span><span class="s1">)])</span>
    <span class="s2">def </span><span class="s1">test_setitem_td64_scalar(self</span><span class="s2">, </span><span class="s1">indexer_sli</span><span class="s2">, </span><span class="s1">scalar):</span>
        <span class="s3"># dispatching _can_hold_element to underling TimedeltaArray</span>
        <span class="s1">tdi = timedelta_range(</span><span class="s5">&quot;1 Day&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">ser = Series(tdi)</span>

        <span class="s1">values = ser._values</span>
        <span class="s1">values._validate_setitem_value(scalar)</span>

        <span class="s1">indexer_sli(ser)[</span><span class="s4">0</span><span class="s1">] = scalar</span>
        <span class="s2">assert </span><span class="s1">ser._values._data </span><span class="s2">is </span><span class="s1">values._data</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;box&quot;</span><span class="s2">, </span><span class="s1">[list</span><span class="s2">, </span><span class="s1">np.array</span><span class="s2">, </span><span class="s1">pd.array</span><span class="s2">, </span><span class="s1">pd.Categorical</span><span class="s2">, </span><span class="s1">Index])</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s5">&quot;key&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s2">True, True, False</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s2">def </span><span class="s1">test_setitem_td64_string_values(self</span><span class="s2">, </span><span class="s1">indexer_sli</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">box):</span>
        <span class="s3"># dispatching _can_hold_element to underling TimedeltaArray</span>
        <span class="s2">if </span><span class="s1">isinstance(key</span><span class="s2">, </span><span class="s1">slice) </span><span class="s2">and </span><span class="s1">indexer_sli </span><span class="s2">is </span><span class="s1">tm.loc:</span>
            <span class="s1">key = slice(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>

        <span class="s1">tdi = timedelta_range(</span><span class="s5">&quot;1 Day&quot;</span><span class="s2">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">ser = Series(tdi)</span>

        <span class="s1">values = ser._values</span>

        <span class="s1">newvals = box([</span><span class="s5">&quot;10 Days&quot;</span><span class="s2">, </span><span class="s5">&quot;44 hours&quot;</span><span class="s1">])</span>
        <span class="s1">values._validate_setitem_value(newvals)</span>

        <span class="s1">indexer_sli(ser)[key] = newvals</span>
        <span class="s2">assert </span><span class="s1">ser._values._data </span><span class="s2">is </span><span class="s1">values._data</span>


<span class="s2">def </span><span class="s1">test_extension_array_cross_section():</span>
    <span class="s3"># A cross-section of a homogeneous EA should be an EA</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s1">: pd.array([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;Int64&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s5">&quot;B&quot;</span><span class="s1">: pd.array([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;Int64&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s1">index=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">expected = Series(pd.array([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;Int64&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">result = df.loc[</span><span class="s5">&quot;a&quot;</span><span class="s1">]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.iloc[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_extension_array_cross_section_converts():</span>
    <span class="s3"># all numeric columns -&gt; numeric series</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s1">: pd.array([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;Int64&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s5">&quot;B&quot;</span><span class="s1">: np.array([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;int64&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s1">index=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[</span><span class="s5">&quot;a&quot;</span><span class="s1">]</span>
    <span class="s1">expected = Series([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;Int64&quot;</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.iloc[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s3"># mixed columns -&gt; object series</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s5">&quot;A&quot;</span><span class="s1">: pd.array([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s5">&quot;Int64&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">: np.array([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">])}</span><span class="s2">,</span>
        <span class="s1">index=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">result = df.loc[</span><span class="s5">&quot;a&quot;</span><span class="s1">]</span>
    <span class="s1">expected = Series([</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=object</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.iloc[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s2">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>