<html>
<head>
<title>html5parser.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
html5parser.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span><span class="s0">, </span><span class="s1">division</span><span class="s0">, </span><span class="s1">unicode_literals</span>
<span class="s0">from </span><span class="s1">pip._vendor.six </span><span class="s0">import </span><span class="s1">with_metaclass</span><span class="s0">, </span><span class="s1">viewkeys</span>

<span class="s0">import </span><span class="s1">types</span>

<span class="s0">from </span><span class="s1">. </span><span class="s0">import </span><span class="s1">_inputstream</span>
<span class="s0">from </span><span class="s1">. </span><span class="s0">import </span><span class="s1">_tokenizer</span>

<span class="s0">from </span><span class="s1">. </span><span class="s0">import </span><span class="s1">treebuilders</span>
<span class="s0">from </span><span class="s1">.treebuilders.base </span><span class="s0">import </span><span class="s1">Marker</span>

<span class="s0">from </span><span class="s1">. </span><span class="s0">import </span><span class="s1">_utils</span>
<span class="s0">from </span><span class="s1">.constants </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">spaceCharacters</span><span class="s0">, </span><span class="s1">asciiUpper2Lower</span><span class="s0">,</span>
    <span class="s1">specialElements</span><span class="s0">, </span><span class="s1">headingElements</span><span class="s0">, </span><span class="s1">cdataElements</span><span class="s0">, </span><span class="s1">rcdataElements</span><span class="s0">,</span>
    <span class="s1">tokenTypes</span><span class="s0">, </span><span class="s1">tagTokenTypes</span><span class="s0">,</span>
    <span class="s1">namespaces</span><span class="s0">,</span>
    <span class="s1">htmlIntegrationPointElements</span><span class="s0">, </span><span class="s1">mathmlTextIntegrationPointElements</span><span class="s0">,</span>
    <span class="s1">adjustForeignAttributes </span><span class="s0">as </span><span class="s1">adjustForeignAttributesMap</span><span class="s0">,</span>
    <span class="s1">adjustMathMLAttributes</span><span class="s0">, </span><span class="s1">adjustSVGAttributes</span><span class="s0">,</span>
    <span class="s1">E</span><span class="s0">,</span>
    <span class="s1">_ReparseException</span>
<span class="s1">)</span>


<span class="s0">def </span><span class="s1">parse(doc</span><span class="s0">, </span><span class="s1">treebuilder=</span><span class="s2">&quot;etree&quot;</span><span class="s0">, </span><span class="s1">namespaceHTMLElements=</span><span class="s0">True, </span><span class="s1">**kwargs):</span>
    <span class="s3">&quot;&quot;&quot;Parse an HTML document as a string or file-like object into a tree 
 
    :arg doc: the document to parse as a string or file-like object 
 
    :arg treebuilder: the treebuilder to use when parsing 
 
    :arg namespaceHTMLElements: whether or not to namespace HTML elements 
 
    :returns: parsed tree 
 
    Example: 
 
    &gt;&gt;&gt; from html5lib.html5parser import parse 
    &gt;&gt;&gt; parse('&lt;html&gt;&lt;body&gt;&lt;p&gt;This is a doc&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;') 
    &lt;Element u'{http://www.w3.org/1999/xhtml}html' at 0x7feac4909db0&gt; 
 
    &quot;&quot;&quot;</span>
    <span class="s1">tb = treebuilders.getTreeBuilder(treebuilder)</span>
    <span class="s1">p = HTMLParser(tb</span><span class="s0">, </span><span class="s1">namespaceHTMLElements=namespaceHTMLElements)</span>
    <span class="s0">return </span><span class="s1">p.parse(doc</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">def </span><span class="s1">parseFragment(doc</span><span class="s0">, </span><span class="s1">container=</span><span class="s2">&quot;div&quot;</span><span class="s0">, </span><span class="s1">treebuilder=</span><span class="s2">&quot;etree&quot;</span><span class="s0">, </span><span class="s1">namespaceHTMLElements=</span><span class="s0">True, </span><span class="s1">**kwargs):</span>
    <span class="s3">&quot;&quot;&quot;Parse an HTML fragment as a string or file-like object into a tree 
 
    :arg doc: the fragment to parse as a string or file-like object 
 
    :arg container: the container context to parse the fragment in 
 
    :arg treebuilder: the treebuilder to use when parsing 
 
    :arg namespaceHTMLElements: whether or not to namespace HTML elements 
 
    :returns: parsed tree 
 
    Example: 
 
    &gt;&gt;&gt; from html5lib.html5libparser import parseFragment 
    &gt;&gt;&gt; parseFragment('&lt;b&gt;this is a fragment&lt;/b&gt;') 
    &lt;Element u'DOCUMENT_FRAGMENT' at 0x7feac484b090&gt; 
 
    &quot;&quot;&quot;</span>
    <span class="s1">tb = treebuilders.getTreeBuilder(treebuilder)</span>
    <span class="s1">p = HTMLParser(tb</span><span class="s0">, </span><span class="s1">namespaceHTMLElements=namespaceHTMLElements)</span>
    <span class="s0">return </span><span class="s1">p.parseFragment(doc</span><span class="s0">, </span><span class="s1">container=container</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">def </span><span class="s1">method_decorator_metaclass(function):</span>
    <span class="s0">class </span><span class="s1">Decorated(type):</span>
        <span class="s0">def </span><span class="s1">__new__(meta</span><span class="s0">, </span><span class="s1">classname</span><span class="s0">, </span><span class="s1">bases</span><span class="s0">, </span><span class="s1">classDict):</span>
            <span class="s0">for </span><span class="s1">attributeName</span><span class="s0">, </span><span class="s1">attribute </span><span class="s0">in </span><span class="s1">classDict.items():</span>
                <span class="s0">if </span><span class="s1">isinstance(attribute</span><span class="s0">, </span><span class="s1">types.FunctionType):</span>
                    <span class="s1">attribute = function(attribute)</span>

                <span class="s1">classDict[attributeName] = attribute</span>
            <span class="s0">return </span><span class="s1">type.__new__(meta</span><span class="s0">, </span><span class="s1">classname</span><span class="s0">, </span><span class="s1">bases</span><span class="s0">, </span><span class="s1">classDict)</span>
    <span class="s0">return </span><span class="s1">Decorated</span>


<span class="s0">class </span><span class="s1">HTMLParser(object):</span>
    <span class="s3">&quot;&quot;&quot;HTML parser 
 
    Generates a tree structure from a stream of (possibly malformed) HTML. 
 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">tree=</span><span class="s0">None, </span><span class="s1">strict=</span><span class="s0">False, </span><span class="s1">namespaceHTMLElements=</span><span class="s0">True, </span><span class="s1">debug=</span><span class="s0">False</span><span class="s1">):</span>
        <span class="s3">&quot;&quot;&quot; 
        :arg tree: a treebuilder class controlling the type of tree that will be 
            returned. Built in treebuilders can be accessed through 
            html5lib.treebuilders.getTreeBuilder(treeType) 
 
        :arg strict: raise an exception when a parse error is encountered 
 
        :arg namespaceHTMLElements: whether or not to namespace HTML elements 
 
        :arg debug: whether or not to enable debug mode which logs things 
 
        Example: 
 
        &gt;&gt;&gt; from html5lib.html5parser import HTMLParser 
        &gt;&gt;&gt; parser = HTMLParser()                     # generates parser with etree builder 
        &gt;&gt;&gt; parser = HTMLParser('lxml', strict=True)  # generates parser with lxml builder which is strict 
 
        &quot;&quot;&quot;</span>

        <span class="s4"># Raise an exception on the first error encountered</span>
        <span class="s1">self.strict = strict</span>

        <span class="s0">if </span><span class="s1">tree </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">tree = treebuilders.getTreeBuilder(</span><span class="s2">&quot;etree&quot;</span><span class="s1">)</span>
        <span class="s1">self.tree = tree(namespaceHTMLElements)</span>
        <span class="s1">self.errors = []</span>

        <span class="s1">self.phases = {name: cls(self</span><span class="s0">, </span><span class="s1">self.tree) </span><span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">cls </span><span class="s0">in</span>
                       <span class="s1">getPhases(debug).items()}</span>

    <span class="s0">def </span><span class="s1">_parse(self</span><span class="s0">, </span><span class="s1">stream</span><span class="s0">, </span><span class="s1">innerHTML=</span><span class="s0">False, </span><span class="s1">container=</span><span class="s2">&quot;div&quot;</span><span class="s0">, </span><span class="s1">scripting=</span><span class="s0">False, </span><span class="s1">**kwargs):</span>

        <span class="s1">self.innerHTMLMode = innerHTML</span>
        <span class="s1">self.container = container</span>
        <span class="s1">self.scripting = scripting</span>
        <span class="s1">self.tokenizer = _tokenizer.HTMLTokenizer(stream</span><span class="s0">, </span><span class="s1">parser=self</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">self.reset()</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">self.mainLoop()</span>
        <span class="s0">except </span><span class="s1">_ReparseException:</span>
            <span class="s1">self.reset()</span>
            <span class="s1">self.mainLoop()</span>

    <span class="s0">def </span><span class="s1">reset(self):</span>
        <span class="s1">self.tree.reset()</span>
        <span class="s1">self.firstStartTag = </span><span class="s0">False</span>
        <span class="s1">self.errors = []</span>
        <span class="s1">self.log = []  </span><span class="s4"># only used with debug mode</span>
        <span class="s4"># &quot;quirks&quot; / &quot;limited quirks&quot; / &quot;no quirks&quot;</span>
        <span class="s1">self.compatMode = </span><span class="s2">&quot;no quirks&quot;</span>

        <span class="s0">if </span><span class="s1">self.innerHTMLMode:</span>
            <span class="s1">self.innerHTML = self.container.lower()</span>

            <span class="s0">if </span><span class="s1">self.innerHTML </span><span class="s0">in </span><span class="s1">cdataElements:</span>
                <span class="s1">self.tokenizer.state = self.tokenizer.rcdataState</span>
            <span class="s0">elif </span><span class="s1">self.innerHTML </span><span class="s0">in </span><span class="s1">rcdataElements:</span>
                <span class="s1">self.tokenizer.state = self.tokenizer.rawtextState</span>
            <span class="s0">elif </span><span class="s1">self.innerHTML == </span><span class="s2">'plaintext'</span><span class="s1">:</span>
                <span class="s1">self.tokenizer.state = self.tokenizer.plaintextState</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># state already is data state</span>
                <span class="s4"># self.tokenizer.state = self.tokenizer.dataState</span>
                <span class="s0">pass</span>
            <span class="s1">self.phase = self.phases[</span><span class="s2">&quot;beforeHtml&quot;</span><span class="s1">]</span>
            <span class="s1">self.phase.insertHtmlElement()</span>
            <span class="s1">self.resetInsertionMode()</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">self.innerHTML = </span><span class="s0">False  </span><span class="s4"># pylint:disable=redefined-variable-type</span>
            <span class="s1">self.phase = self.phases[</span><span class="s2">&quot;initial&quot;</span><span class="s1">]</span>

        <span class="s1">self.lastPhase = </span><span class="s0">None</span>

        <span class="s1">self.beforeRCDataPhase = </span><span class="s0">None</span>

        <span class="s1">self.framesetOK = </span><span class="s0">True</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">documentEncoding(self):</span>
        <span class="s3">&quot;&quot;&quot;Name of the character encoding that was used to decode the input stream, or 
        :obj:`None` if that is not determined yet 
 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">hasattr(self</span><span class="s0">, </span><span class="s2">'tokenizer'</span><span class="s1">):</span>
            <span class="s0">return None</span>
        <span class="s0">return </span><span class="s1">self.tokenizer.stream.charEncoding[</span><span class="s5">0</span><span class="s1">].name</span>

    <span class="s0">def </span><span class="s1">isHTMLIntegrationPoint(self</span><span class="s0">, </span><span class="s1">element):</span>
        <span class="s0">if </span><span class="s1">(element.name == </span><span class="s2">&quot;annotation-xml&quot; </span><span class="s0">and</span>
                <span class="s1">element.namespace == namespaces[</span><span class="s2">&quot;mathml&quot;</span><span class="s1">]):</span>
            <span class="s0">return </span><span class="s1">(</span><span class="s2">&quot;encoding&quot; </span><span class="s0">in </span><span class="s1">element.attributes </span><span class="s0">and</span>
                    <span class="s1">element.attributes[</span><span class="s2">&quot;encoding&quot;</span><span class="s1">].translate(</span>
                        <span class="s1">asciiUpper2Lower) </span><span class="s0">in</span>
                    <span class="s1">(</span><span class="s2">&quot;text/html&quot;</span><span class="s0">, </span><span class="s2">&quot;application/xhtml+xml&quot;</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s1">(element.namespace</span><span class="s0">, </span><span class="s1">element.name) </span><span class="s0">in </span><span class="s1">htmlIntegrationPointElements</span>

    <span class="s0">def </span><span class="s1">isMathMLTextIntegrationPoint(self</span><span class="s0">, </span><span class="s1">element):</span>
        <span class="s0">return </span><span class="s1">(element.namespace</span><span class="s0">, </span><span class="s1">element.name) </span><span class="s0">in </span><span class="s1">mathmlTextIntegrationPointElements</span>

    <span class="s0">def </span><span class="s1">mainLoop(self):</span>
        <span class="s1">CharactersToken = tokenTypes[</span><span class="s2">&quot;Characters&quot;</span><span class="s1">]</span>
        <span class="s1">SpaceCharactersToken = tokenTypes[</span><span class="s2">&quot;SpaceCharacters&quot;</span><span class="s1">]</span>
        <span class="s1">StartTagToken = tokenTypes[</span><span class="s2">&quot;StartTag&quot;</span><span class="s1">]</span>
        <span class="s1">EndTagToken = tokenTypes[</span><span class="s2">&quot;EndTag&quot;</span><span class="s1">]</span>
        <span class="s1">CommentToken = tokenTypes[</span><span class="s2">&quot;Comment&quot;</span><span class="s1">]</span>
        <span class="s1">DoctypeToken = tokenTypes[</span><span class="s2">&quot;Doctype&quot;</span><span class="s1">]</span>
        <span class="s1">ParseErrorToken = tokenTypes[</span><span class="s2">&quot;ParseError&quot;</span><span class="s1">]</span>

        <span class="s0">for </span><span class="s1">token </span><span class="s0">in </span><span class="s1">self.tokenizer:</span>
            <span class="s1">prev_token = </span><span class="s0">None</span>
            <span class="s1">new_token = token</span>
            <span class="s0">while </span><span class="s1">new_token </span><span class="s0">is not None</span><span class="s1">:</span>
                <span class="s1">prev_token = new_token</span>
                <span class="s1">currentNode = self.tree.openElements[-</span><span class="s5">1</span><span class="s1">] </span><span class="s0">if </span><span class="s1">self.tree.openElements </span><span class="s0">else None</span>
                <span class="s1">currentNodeNamespace = currentNode.namespace </span><span class="s0">if </span><span class="s1">currentNode </span><span class="s0">else None</span>
                <span class="s1">currentNodeName = currentNode.name </span><span class="s0">if </span><span class="s1">currentNode </span><span class="s0">else None</span>

                <span class="s1">type = new_token[</span><span class="s2">&quot;type&quot;</span><span class="s1">]</span>

                <span class="s0">if </span><span class="s1">type == ParseErrorToken:</span>
                    <span class="s1">self.parseError(new_token[</span><span class="s2">&quot;data&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">new_token.get(</span><span class="s2">&quot;datavars&quot;</span><span class="s0">, </span><span class="s1">{}))</span>
                    <span class="s1">new_token = </span><span class="s0">None</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s0">if </span><span class="s1">(len(self.tree.openElements) == </span><span class="s5">0 </span><span class="s0">or</span>
                        <span class="s1">currentNodeNamespace == self.tree.defaultNamespace </span><span class="s0">or</span>
                        <span class="s1">(self.isMathMLTextIntegrationPoint(currentNode) </span><span class="s0">and</span>
                         <span class="s1">((type == StartTagToken </span><span class="s0">and</span>
                           <span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] </span><span class="s0">not in </span><span class="s1">frozenset([</span><span class="s2">&quot;mglyph&quot;</span><span class="s0">, </span><span class="s2">&quot;malignmark&quot;</span><span class="s1">])) </span><span class="s0">or</span>
                          <span class="s1">type </span><span class="s0">in </span><span class="s1">(CharactersToken</span><span class="s0">, </span><span class="s1">SpaceCharactersToken))) </span><span class="s0">or</span>
                        <span class="s1">(currentNodeNamespace == namespaces[</span><span class="s2">&quot;mathml&quot;</span><span class="s1">] </span><span class="s0">and</span>
                         <span class="s1">currentNodeName == </span><span class="s2">&quot;annotation-xml&quot; </span><span class="s0">and</span>
                         <span class="s1">type == StartTagToken </span><span class="s0">and</span>
                         <span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] == </span><span class="s2">&quot;svg&quot;</span><span class="s1">) </span><span class="s0">or</span>
                        <span class="s1">(self.isHTMLIntegrationPoint(currentNode) </span><span class="s0">and</span>
                         <span class="s1">type </span><span class="s0">in </span><span class="s1">(StartTagToken</span><span class="s0">, </span><span class="s1">CharactersToken</span><span class="s0">, </span><span class="s1">SpaceCharactersToken))):</span>
                        <span class="s1">phase = self.phase</span>
                    <span class="s0">else</span><span class="s1">:</span>
                        <span class="s1">phase = self.phases[</span><span class="s2">&quot;inForeignContent&quot;</span><span class="s1">]</span>

                    <span class="s0">if </span><span class="s1">type == CharactersToken:</span>
                        <span class="s1">new_token = phase.processCharacters(new_token)</span>
                    <span class="s0">elif </span><span class="s1">type == SpaceCharactersToken:</span>
                        <span class="s1">new_token = phase.processSpaceCharacters(new_token)</span>
                    <span class="s0">elif </span><span class="s1">type == StartTagToken:</span>
                        <span class="s1">new_token = phase.processStartTag(new_token)</span>
                    <span class="s0">elif </span><span class="s1">type == EndTagToken:</span>
                        <span class="s1">new_token = phase.processEndTag(new_token)</span>
                    <span class="s0">elif </span><span class="s1">type == CommentToken:</span>
                        <span class="s1">new_token = phase.processComment(new_token)</span>
                    <span class="s0">elif </span><span class="s1">type == DoctypeToken:</span>
                        <span class="s1">new_token = phase.processDoctype(new_token)</span>

            <span class="s0">if </span><span class="s1">(type == StartTagToken </span><span class="s0">and </span><span class="s1">prev_token[</span><span class="s2">&quot;selfClosing&quot;</span><span class="s1">] </span><span class="s0">and</span>
                    <span class="s0">not </span><span class="s1">prev_token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">]):</span>
                <span class="s1">self.parseError(</span><span class="s2">&quot;non-void-element-with-trailing-solidus&quot;</span><span class="s0">,</span>
                                <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: prev_token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s4"># When the loop finishes it's EOF</span>
        <span class="s1">reprocess = </span><span class="s0">True</span>
        <span class="s1">phases = []</span>
        <span class="s0">while </span><span class="s1">reprocess:</span>
            <span class="s1">phases.append(self.phase)</span>
            <span class="s1">reprocess = self.phase.processEOF()</span>
            <span class="s0">if </span><span class="s1">reprocess:</span>
                <span class="s0">assert </span><span class="s1">self.phase </span><span class="s0">not in </span><span class="s1">phases</span>

    <span class="s0">def </span><span class="s1">parse(self</span><span class="s0">, </span><span class="s1">stream</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s3">&quot;&quot;&quot;Parse a HTML document into a well-formed tree 
 
        :arg stream: a file-like object or string containing the HTML to be parsed 
 
            The optional encoding parameter must be a string that indicates 
            the encoding.  If specified, that encoding will be used, 
            regardless of any BOM or later declaration (such as in a meta 
            element). 
 
        :arg scripting: treat noscript elements as if JavaScript was turned on 
 
        :returns: parsed tree 
 
        Example: 
 
        &gt;&gt;&gt; from html5lib.html5parser import HTMLParser 
        &gt;&gt;&gt; parser = HTMLParser() 
        &gt;&gt;&gt; parser.parse('&lt;html&gt;&lt;body&gt;&lt;p&gt;This is a doc&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;') 
        &lt;Element u'{http://www.w3.org/1999/xhtml}html' at 0x7feac4909db0&gt; 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self._parse(stream</span><span class="s0">, False, None, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">return </span><span class="s1">self.tree.getDocument()</span>

    <span class="s0">def </span><span class="s1">parseFragment(self</span><span class="s0">, </span><span class="s1">stream</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s3">&quot;&quot;&quot;Parse a HTML fragment into a well-formed tree fragment 
 
        :arg container: name of the element we're setting the innerHTML 
            property if set to None, default to 'div' 
 
        :arg stream: a file-like object or string containing the HTML to be parsed 
 
            The optional encoding parameter must be a string that indicates 
            the encoding.  If specified, that encoding will be used, 
            regardless of any BOM or later declaration (such as in a meta 
            element) 
 
        :arg scripting: treat noscript elements as if JavaScript was turned on 
 
        :returns: parsed tree 
 
        Example: 
 
        &gt;&gt;&gt; from html5lib.html5libparser import HTMLParser 
        &gt;&gt;&gt; parser = HTMLParser() 
        &gt;&gt;&gt; parser.parseFragment('&lt;b&gt;this is a fragment&lt;/b&gt;') 
        &lt;Element u'DOCUMENT_FRAGMENT' at 0x7feac484b090&gt; 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self._parse(stream</span><span class="s0">, True, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">return </span><span class="s1">self.tree.getFragment()</span>

    <span class="s0">def </span><span class="s1">parseError(self</span><span class="s0">, </span><span class="s1">errorcode=</span><span class="s2">&quot;XXX-undefined-error&quot;</span><span class="s0">, </span><span class="s1">datavars=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s4"># XXX The idea is to make errorcode mandatory.</span>
        <span class="s0">if </span><span class="s1">datavars </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">datavars = {}</span>
        <span class="s1">self.errors.append((self.tokenizer.stream.position()</span><span class="s0">, </span><span class="s1">errorcode</span><span class="s0">, </span><span class="s1">datavars))</span>
        <span class="s0">if </span><span class="s1">self.strict:</span>
            <span class="s0">raise </span><span class="s1">ParseError(E[errorcode] % datavars)</span>

    <span class="s0">def </span><span class="s1">adjustMathMLAttributes(self</span><span class="s0">, </span><span class="s1">token):</span>
        <span class="s1">adjust_attributes(token</span><span class="s0">, </span><span class="s1">adjustMathMLAttributes)</span>

    <span class="s0">def </span><span class="s1">adjustSVGAttributes(self</span><span class="s0">, </span><span class="s1">token):</span>
        <span class="s1">adjust_attributes(token</span><span class="s0">, </span><span class="s1">adjustSVGAttributes)</span>

    <span class="s0">def </span><span class="s1">adjustForeignAttributes(self</span><span class="s0">, </span><span class="s1">token):</span>
        <span class="s1">adjust_attributes(token</span><span class="s0">, </span><span class="s1">adjustForeignAttributesMap)</span>

    <span class="s0">def </span><span class="s1">reparseTokenNormal(self</span><span class="s0">, </span><span class="s1">token):</span>
        <span class="s4"># pylint:disable=unused-argument</span>
        <span class="s1">self.parser.phase()</span>

    <span class="s0">def </span><span class="s1">resetInsertionMode(self):</span>
        <span class="s4"># The name of this method is mostly historical. (It's also used in the</span>
        <span class="s4"># specification.)</span>
        <span class="s1">last = </span><span class="s0">False</span>
        <span class="s1">newModes = {</span>
            <span class="s2">&quot;select&quot;</span><span class="s1">: </span><span class="s2">&quot;inSelect&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;td&quot;</span><span class="s1">: </span><span class="s2">&quot;inCell&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;th&quot;</span><span class="s1">: </span><span class="s2">&quot;inCell&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;tr&quot;</span><span class="s1">: </span><span class="s2">&quot;inRow&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;tbody&quot;</span><span class="s1">: </span><span class="s2">&quot;inTableBody&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;thead&quot;</span><span class="s1">: </span><span class="s2">&quot;inTableBody&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;tfoot&quot;</span><span class="s1">: </span><span class="s2">&quot;inTableBody&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;caption&quot;</span><span class="s1">: </span><span class="s2">&quot;inCaption&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;colgroup&quot;</span><span class="s1">: </span><span class="s2">&quot;inColumnGroup&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;table&quot;</span><span class="s1">: </span><span class="s2">&quot;inTable&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;head&quot;</span><span class="s1">: </span><span class="s2">&quot;inBody&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;body&quot;</span><span class="s1">: </span><span class="s2">&quot;inBody&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;frameset&quot;</span><span class="s1">: </span><span class="s2">&quot;inFrameset&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;html&quot;</span><span class="s1">: </span><span class="s2">&quot;beforeHead&quot;</span>
        <span class="s1">}</span>
        <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self.tree.openElements[::-</span><span class="s5">1</span><span class="s1">]:</span>
            <span class="s1">nodeName = node.name</span>
            <span class="s1">new_phase = </span><span class="s0">None</span>
            <span class="s0">if </span><span class="s1">node == self.tree.openElements[</span><span class="s5">0</span><span class="s1">]:</span>
                <span class="s0">assert </span><span class="s1">self.innerHTML</span>
                <span class="s1">last = </span><span class="s0">True</span>
                <span class="s1">nodeName = self.innerHTML</span>
            <span class="s4"># Check for conditions that should only happen in the innerHTML</span>
            <span class="s4"># case</span>
            <span class="s0">if </span><span class="s1">nodeName </span><span class="s0">in </span><span class="s1">(</span><span class="s2">&quot;select&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">self.innerHTML</span>

            <span class="s0">if not </span><span class="s1">last </span><span class="s0">and </span><span class="s1">node.namespace != self.tree.defaultNamespace:</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">nodeName </span><span class="s0">in </span><span class="s1">newModes:</span>
                <span class="s1">new_phase = self.phases[newModes[nodeName]]</span>
                <span class="s0">break</span>
            <span class="s0">elif </span><span class="s1">last:</span>
                <span class="s1">new_phase = self.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
                <span class="s0">break</span>

        <span class="s1">self.phase = new_phase</span>

    <span class="s0">def </span><span class="s1">parseRCDataRawtext(self</span><span class="s0">, </span><span class="s1">token</span><span class="s0">, </span><span class="s1">contentType):</span>
        <span class="s4"># Generic RCDATA/RAWTEXT Parsing algorithm</span>
        <span class="s0">assert </span><span class="s1">contentType </span><span class="s0">in </span><span class="s1">(</span><span class="s2">&quot;RAWTEXT&quot;</span><span class="s0">, </span><span class="s2">&quot;RCDATA&quot;</span><span class="s1">)</span>

        <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">if </span><span class="s1">contentType == </span><span class="s2">&quot;RAWTEXT&quot;</span><span class="s1">:</span>
            <span class="s1">self.tokenizer.state = self.tokenizer.rawtextState</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">self.tokenizer.state = self.tokenizer.rcdataState</span>

        <span class="s1">self.originalPhase = self.phase</span>

        <span class="s1">self.phase = self.phases[</span><span class="s2">&quot;text&quot;</span><span class="s1">]</span>


<span class="s1">@_utils.memoize</span>
<span class="s0">def </span><span class="s1">getPhases(debug):</span>
    <span class="s0">def </span><span class="s1">log(function):</span>
        <span class="s3">&quot;&quot;&quot;Logger that records which phase processes each token&quot;&quot;&quot;</span>
        <span class="s1">type_names = {value: key </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">tokenTypes.items()}</span>

        <span class="s0">def </span><span class="s1">wrapped(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
            <span class="s0">if </span><span class="s1">function.__name__.startswith(</span><span class="s2">&quot;process&quot;</span><span class="s1">) </span><span class="s0">and </span><span class="s1">len(args) &gt; </span><span class="s5">0</span><span class="s1">:</span>
                <span class="s1">token = args[</span><span class="s5">0</span><span class="s1">]</span>
                <span class="s1">info = {</span><span class="s2">&quot;type&quot;</span><span class="s1">: type_names[token[</span><span class="s2">'type'</span><span class="s1">]]}</span>
                <span class="s0">if </span><span class="s1">token[</span><span class="s2">'type'</span><span class="s1">] </span><span class="s0">in </span><span class="s1">tagTokenTypes:</span>
                    <span class="s1">info[</span><span class="s2">&quot;name&quot;</span><span class="s1">] = token[</span><span class="s2">'name'</span><span class="s1">]</span>

                <span class="s1">self.parser.log.append((self.parser.tokenizer.state.__name__</span><span class="s0">,</span>
                                        <span class="s1">self.parser.phase.__class__.__name__</span><span class="s0">,</span>
                                        <span class="s1">self.__class__.__name__</span><span class="s0">,</span>
                                        <span class="s1">function.__name__</span><span class="s0">,</span>
                                        <span class="s1">info))</span>
                <span class="s0">return </span><span class="s1">function(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">return </span><span class="s1">function(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">return </span><span class="s1">wrapped</span>

    <span class="s0">def </span><span class="s1">getMetaclass(use_metaclass</span><span class="s0">, </span><span class="s1">metaclass_func):</span>
        <span class="s0">if </span><span class="s1">use_metaclass:</span>
            <span class="s0">return </span><span class="s1">method_decorator_metaclass(metaclass_func)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s1">type</span>

    <span class="s4"># pylint:disable=unused-argument</span>
    <span class="s0">class </span><span class="s1">Phase(with_metaclass(getMetaclass(debug</span><span class="s0">, </span><span class="s1">log))):</span>
        <span class="s3">&quot;&quot;&quot;Base class for helper object that implements each phase of processing 
        &quot;&quot;&quot;</span>
        <span class="s1">__slots__ = (</span><span class="s2">&quot;parser&quot;</span><span class="s0">, </span><span class="s2">&quot;tree&quot;</span><span class="s0">, </span><span class="s2">&quot;__startTagCache&quot;</span><span class="s0">, </span><span class="s2">&quot;__endTagCache&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">tree):</span>
            <span class="s1">self.parser = parser</span>
            <span class="s1">self.tree = tree</span>
            <span class="s1">self.__startTagCache = {}</span>
            <span class="s1">self.__endTagCache = {}</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># For most phases the following is correct. Where it's not it will be</span>
            <span class="s4"># overridden.</span>
            <span class="s1">self.tree.insertComment(token</span><span class="s0">, </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">processDoctype(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-doctype&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertText(token[</span><span class="s2">&quot;data&quot;</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertText(token[</span><span class="s2">&quot;data&quot;</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">processStartTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># Note the caching is done here rather than BoundMethodDispatcher as doing it there</span>
            <span class="s4"># requires a circular reference to the Phase, and this ends up with a significant</span>
            <span class="s4"># (CPython 2.7, 3.8) GC cost when parsing many short inputs</span>
            <span class="s1">name = token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span>
            <span class="s4"># In Py2, using `in` is quicker in general than try/except KeyError</span>
            <span class="s4"># In Py3, `in` is quicker when there are few cache hits (typically short inputs)</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self.__startTagCache:</span>
                <span class="s1">func = self.__startTagCache[name]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">func = self.__startTagCache[name] = self.startTagHandler[name]</span>
                <span class="s4"># bound the cache size in case we get loads of unknown tags</span>
                <span class="s0">while </span><span class="s1">len(self.__startTagCache) &gt; len(self.startTagHandler) * </span><span class="s5">1.1</span><span class="s1">:</span>
                    <span class="s4"># this makes the eviction policy random on Py &lt; 3.7 and FIFO &gt;= 3.7</span>
                    <span class="s1">self.__startTagCache.pop(next(iter(self.__startTagCache)))</span>
            <span class="s0">return </span><span class="s1">func(token)</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if not </span><span class="s1">self.parser.firstStartTag </span><span class="s0">and </span><span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] == </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;non-html-root&quot;</span><span class="s1">)</span>
            <span class="s4"># XXX Need a check here to see if the first start tag token emitted is</span>
            <span class="s4"># this token... If it's not, invoke self.parser.parseError().</span>
            <span class="s0">for </span><span class="s1">attr</span><span class="s0">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">].items():</span>
                <span class="s0">if </span><span class="s1">attr </span><span class="s0">not in </span><span class="s1">self.tree.openElements[</span><span class="s5">0</span><span class="s1">].attributes:</span>
                    <span class="s1">self.tree.openElements[</span><span class="s5">0</span><span class="s1">].attributes[attr] = value</span>
            <span class="s1">self.parser.firstStartTag = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">processEndTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># Note the caching is done here rather than BoundMethodDispatcher as doing it there</span>
            <span class="s4"># requires a circular reference to the Phase, and this ends up with a significant</span>
            <span class="s4"># (CPython 2.7, 3.8) GC cost when parsing many short inputs</span>
            <span class="s1">name = token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span>
            <span class="s4"># In Py2, using `in` is quicker in general than try/except KeyError</span>
            <span class="s4"># In Py3, `in` is quicker when there are few cache hits (typically short inputs)</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self.__endTagCache:</span>
                <span class="s1">func = self.__endTagCache[name]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">func = self.__endTagCache[name] = self.endTagHandler[name]</span>
                <span class="s4"># bound the cache size in case we get loads of unknown tags</span>
                <span class="s0">while </span><span class="s1">len(self.__endTagCache) &gt; len(self.endTagHandler) * </span><span class="s5">1.1</span><span class="s1">:</span>
                    <span class="s4"># this makes the eviction policy random on Py &lt; 3.7 and FIFO &gt;= 3.7</span>
                    <span class="s1">self.__endTagCache.pop(next(iter(self.__endTagCache)))</span>
            <span class="s0">return </span><span class="s1">func(token)</span>

    <span class="s0">class </span><span class="s1">InitialPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertComment(token</span><span class="s0">, </span><span class="s1">self.tree.document)</span>

        <span class="s0">def </span><span class="s1">processDoctype(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">name = token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span>
            <span class="s1">publicId = token[</span><span class="s2">&quot;publicId&quot;</span><span class="s1">]</span>
            <span class="s1">systemId = token[</span><span class="s2">&quot;systemId&quot;</span><span class="s1">]</span>
            <span class="s1">correct = token[</span><span class="s2">&quot;correct&quot;</span><span class="s1">]</span>

            <span class="s0">if </span><span class="s1">(name != </span><span class="s2">&quot;html&quot; </span><span class="s0">or </span><span class="s1">publicId </span><span class="s0">is not None or</span>
                    <span class="s1">systemId </span><span class="s0">is not None and </span><span class="s1">systemId != </span><span class="s2">&quot;about:legacy-compat&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unknown-doctype&quot;</span><span class="s1">)</span>

            <span class="s0">if </span><span class="s1">publicId </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s1">publicId = </span><span class="s2">&quot;&quot;</span>

            <span class="s1">self.tree.insertDoctype(token)</span>

            <span class="s0">if </span><span class="s1">publicId != </span><span class="s2">&quot;&quot;</span><span class="s1">:</span>
                <span class="s1">publicId = publicId.translate(asciiUpper2Lower)</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s0">not </span><span class="s1">correct </span><span class="s0">or </span><span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] != </span><span class="s2">&quot;html&quot; </span><span class="s0">or</span>
                    <span class="s1">publicId.startswith(</span>
                        <span class="s1">(</span><span class="s2">&quot;+//silmaril//dtd html pro v0r11 19970101//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//advasoft ltd//dtd html 3.0 aswedit + extensions//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//as//dtd html 3.0 aswedit + extensions//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 2.0 level 1//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 2.0 level 2//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 2.0 strict level 1//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 2.0 strict level 2//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 2.0 strict//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 2.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 2.1e//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 3.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 3.2 final//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 3.2//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html 3//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html level 0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html level 1//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html level 2//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html level 3//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html strict level 0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html strict level 1//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html strict level 2//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html strict level 3//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html strict//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//ietf//dtd html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//metrius//dtd metrius presentational//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//microsoft//dtd internet explorer 2.0 html strict//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//microsoft//dtd internet explorer 2.0 html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//microsoft//dtd internet explorer 2.0 tables//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//microsoft//dtd internet explorer 3.0 html strict//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//microsoft//dtd internet explorer 3.0 html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//microsoft//dtd internet explorer 3.0 tables//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//netscape comm. corp.//dtd html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//netscape comm. corp.//dtd strict html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//o'reilly and associates//dtd html 2.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//o'reilly and associates//dtd html extended 1.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//o'reilly and associates//dtd html extended relaxed 1.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//spyglass//dtd html 2.0 extended//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//sq//dtd html 2.0 hotmetal + extensions//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//sun microsystems corp.//dtd hotjava html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//sun microsystems corp.//dtd hotjava strict html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 3 1995-03-24//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 3.2 draft//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 3.2 final//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 3.2//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 3.2s draft//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 4.0 frameset//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 4.0 transitional//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html experimental 19960712//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html experimental 970421//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd w3 html//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3o//dtd w3 html 3.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//webtechs//dtd mozilla html 2.0//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//webtechs//dtd mozilla html//&quot;</span><span class="s1">)) </span><span class="s0">or</span>
                    <span class="s1">publicId </span><span class="s0">in </span><span class="s1">(</span><span class="s2">&quot;-//w3o//dtd w3 html strict 3.0//en//&quot;</span><span class="s0">,</span>
                                 <span class="s2">&quot;-/w3c/dtd html 4.0 transitional/en&quot;</span><span class="s0">,</span>
                                 <span class="s2">&quot;html&quot;</span><span class="s1">) </span><span class="s0">or</span>
                    <span class="s1">publicId.startswith(</span>
                        <span class="s1">(</span><span class="s2">&quot;-//w3c//dtd html 4.01 frameset//&quot;</span><span class="s0">,</span>
                         <span class="s2">&quot;-//w3c//dtd html 4.01 transitional//&quot;</span><span class="s1">)) </span><span class="s0">and</span>
                    <span class="s1">systemId </span><span class="s0">is None or</span>
                    <span class="s1">systemId </span><span class="s0">and </span><span class="s1">systemId.lower() == </span><span class="s2">&quot;http://www.ibm.com/data/dtd/v11/ibmxhtml1-transitional.dtd&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.compatMode = </span><span class="s2">&quot;quirks&quot;</span>
            <span class="s0">elif </span><span class="s1">(publicId.startswith(</span>
                    <span class="s1">(</span><span class="s2">&quot;-//w3c//dtd xhtml 1.0 frameset//&quot;</span><span class="s0">,</span>
                     <span class="s2">&quot;-//w3c//dtd xhtml 1.0 transitional//&quot;</span><span class="s1">)) </span><span class="s0">or</span>
                  <span class="s1">publicId.startswith(</span>
                      <span class="s1">(</span><span class="s2">&quot;-//w3c//dtd html 4.01 frameset//&quot;</span><span class="s0">,</span>
                       <span class="s2">&quot;-//w3c//dtd html 4.01 transitional//&quot;</span><span class="s1">)) </span><span class="s0">and</span>
                  <span class="s1">systemId </span><span class="s0">is not None</span><span class="s1">):</span>
                <span class="s1">self.parser.compatMode = </span><span class="s2">&quot;limited quirks&quot;</span>

            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;beforeHtml&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">anythingElse(self):</span>
            <span class="s1">self.parser.compatMode = </span><span class="s2">&quot;quirks&quot;</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;beforeHtml&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-doctype-but-got-chars&quot;</span><span class="s1">)</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processStartTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-doctype-but-got-start-tag&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-doctype-but-got-end-tag&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-doctype-but-got-eof&quot;</span><span class="s1">)</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return True</span>

    <span class="s0">class </span><span class="s1">BeforeHtmlPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s4"># helper methods</span>
        <span class="s0">def </span><span class="s1">insertHtmlElement(self):</span>
            <span class="s1">self.tree.insertRoot(impliedTagToken(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;beforeHead&quot;</span><span class="s1">]</span>

        <span class="s4"># other</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.insertHtmlElement()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertComment(token</span><span class="s0">, </span><span class="s1">self.tree.document)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.insertHtmlElement()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processStartTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] == </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s1">self.parser.firstStartTag = </span><span class="s0">True</span>
            <span class="s1">self.insertHtmlElement()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] </span><span class="s0">not in </span><span class="s1">(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;br&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-before-html&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.insertHtmlElement()</span>
                <span class="s0">return </span><span class="s1">token</span>

    <span class="s0">class </span><span class="s1">BeforeHeadPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.startTagHead(impliedTagToken(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.startTagHead(impliedTagToken(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagHead(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.headPointer = self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.startTagHead(impliedTagToken(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagImplyHead(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.startTagHead(impliedTagToken(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;end-tag-after-implied-root&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s1">startTagHead)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">((</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;br&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagImplyHead)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InHeadPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s4"># the real thing</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagHead(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;two-heads-are-not-better-than-one&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagBaseLinkCommand(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagMeta(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>

            <span class="s1">attributes = token[</span><span class="s2">&quot;data&quot;</span><span class="s1">]</span>
            <span class="s0">if </span><span class="s1">self.parser.tokenizer.stream.charEncoding[</span><span class="s5">1</span><span class="s1">] == </span><span class="s2">&quot;tentative&quot;</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s2">&quot;charset&quot; </span><span class="s0">in </span><span class="s1">attributes:</span>
                    <span class="s1">self.parser.tokenizer.stream.changeEncoding(attributes[</span><span class="s2">&quot;charset&quot;</span><span class="s1">])</span>
                <span class="s0">elif </span><span class="s1">(</span><span class="s2">&quot;content&quot; </span><span class="s0">in </span><span class="s1">attributes </span><span class="s0">and</span>
                      <span class="s2">&quot;http-equiv&quot; </span><span class="s0">in </span><span class="s1">attributes </span><span class="s0">and</span>
                      <span class="s1">attributes[</span><span class="s2">&quot;http-equiv&quot;</span><span class="s1">].lower() == </span><span class="s2">&quot;content-type&quot;</span><span class="s1">):</span>
                    <span class="s4"># Encoding it as UTF-8 here is a hack, as really we should pass</span>
                    <span class="s4"># the abstract Unicode string, and just use the</span>
                    <span class="s4"># ContentAttrParser on that, but using UTF-8 allows all chars</span>
                    <span class="s4"># to be encoded and as a ASCII-superset works.</span>
                    <span class="s1">data = _inputstream.EncodingBytes(attributes[</span><span class="s2">&quot;content&quot;</span><span class="s1">].encode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">))</span>
                    <span class="s1">parser = _inputstream.ContentAttrParser(data)</span>
                    <span class="s1">codec = parser.parse()</span>
                    <span class="s1">self.parser.tokenizer.stream.changeEncoding(codec)</span>

        <span class="s0">def </span><span class="s1">startTagTitle(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseRCDataRawtext(token</span><span class="s0">, </span><span class="s2">&quot;RCDATA&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagNoFramesStyle(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># Need to decide whether to implement the scripting-disabled case</span>
            <span class="s1">self.parser.parseRCDataRawtext(token</span><span class="s0">, </span><span class="s2">&quot;RAWTEXT&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagNoscript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.parser.scripting:</span>
                <span class="s1">self.parser.parseRCDataRawtext(token</span><span class="s0">, </span><span class="s2">&quot;RAWTEXT&quot;</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.tree.insertElement(token)</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inHeadNoscript&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagScript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.tokenizer.state = self.parser.tokenizer.scriptDataState</span>
            <span class="s1">self.parser.originalPhase = self.parser.phase</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;text&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagHead(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">node = self.parser.tree.openElements.pop()</span>
            <span class="s0">assert </span><span class="s1">node.name == </span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;Expected head got %s&quot; </span><span class="s1">% node.name</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;afterHead&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagHtmlBodyBr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">anythingElse(self):</span>
            <span class="s1">self.endTagHead(impliedTagToken(</span><span class="s2">&quot;head&quot;</span><span class="s1">))</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;title&quot;</span><span class="s0">, </span><span class="s1">startTagTitle)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;noframes&quot;</span><span class="s0">, </span><span class="s2">&quot;style&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagNoFramesStyle)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;noscript&quot;</span><span class="s0">, </span><span class="s1">startTagNoscript)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;script&quot;</span><span class="s0">, </span><span class="s1">startTagScript)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;base&quot;</span><span class="s0">, </span><span class="s2">&quot;basefont&quot;</span><span class="s0">, </span><span class="s2">&quot;bgsound&quot;</span><span class="s0">, </span><span class="s2">&quot;command&quot;</span><span class="s0">, </span><span class="s2">&quot;link&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">startTagBaseLinkCommand)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;meta&quot;</span><span class="s0">, </span><span class="s1">startTagMeta)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s1">startTagHead)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s1">endTagHead)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;br&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;body&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagHtmlBodyBr)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InHeadNoscriptPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;eof-in-head-noscript&quot;</span><span class="s1">)</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processComment(token)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;char-in-head-noscript&quot;</span><span class="s1">)</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processSpaceCharacters(token)</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagBaseLinkCommand(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagHeadNoscript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-inhead-noscript-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagNoscript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">node = self.parser.tree.openElements.pop()</span>
            <span class="s0">assert </span><span class="s1">node.name == </span><span class="s2">&quot;noscript&quot;</span><span class="s0">, </span><span class="s2">&quot;Expected noscript got %s&quot; </span><span class="s1">% node.name</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagBr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-inhead-noscript-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">anythingElse(self):</span>
            <span class="s4"># Caller must raise parse error first!</span>
            <span class="s1">self.endTagNoscript(impliedTagToken(</span><span class="s2">&quot;noscript&quot;</span><span class="s1">))</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">startTagHtml)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;basefont&quot;</span><span class="s0">, </span><span class="s2">&quot;bgsound&quot;</span><span class="s0">, </span><span class="s2">&quot;link&quot;</span><span class="s0">, </span><span class="s2">&quot;meta&quot;</span><span class="s0">, </span><span class="s2">&quot;noframes&quot;</span><span class="s0">, </span><span class="s2">&quot;style&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagBaseLinkCommand)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;noscript&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagHeadNoscript)</span><span class="s0">,</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;noscript&quot;</span><span class="s0">, </span><span class="s1">endTagNoscript)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;br&quot;</span><span class="s0">, </span><span class="s1">endTagBr)</span><span class="s0">,</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">AfterHeadPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagBody(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagFrameset(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inFrameset&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagFromHead(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-out-of-my-head&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.tree.openElements.append(self.tree.headPointer)</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processStartTag(token)</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self.tree.openElements[::-</span><span class="s5">1</span><span class="s1">]:</span>
                <span class="s0">if </span><span class="s1">node.name == </span><span class="s2">&quot;head&quot;</span><span class="s1">:</span>
                    <span class="s1">self.tree.openElements.remove(node)</span>
                    <span class="s0">break</span>

        <span class="s0">def </span><span class="s1">startTagHead(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagHtmlBodyBr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.anythingElse()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">anythingElse(self):</span>
            <span class="s1">self.tree.insertElement(impliedTagToken(</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">True</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s1">startTagBody)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;frameset&quot;</span><span class="s0">, </span><span class="s1">startTagFrameset)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;base&quot;</span><span class="s0">, </span><span class="s2">&quot;basefont&quot;</span><span class="s0">, </span><span class="s2">&quot;bgsound&quot;</span><span class="s0">, </span><span class="s2">&quot;link&quot;</span><span class="s0">, </span><span class="s2">&quot;meta&quot;</span><span class="s0">, </span><span class="s2">&quot;noframes&quot;</span><span class="s0">, </span><span class="s2">&quot;script&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;style&quot;</span><span class="s0">, </span><span class="s2">&quot;title&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">startTagFromHead)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s1">startTagHead)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>
        <span class="s1">endTagHandler = _utils.MethodDispatcher([((</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;br&quot;</span><span class="s1">)</span><span class="s0">,</span>
                                                  <span class="s1">endTagHtmlBodyBr)])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InBodyPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#parsing-main-inbody</span>
        <span class="s4"># the really-really-really-very crazy mode</span>
        <span class="s1">__slots__ = (</span><span class="s2">&quot;processSpaceCharacters&quot;</span><span class="s0">,</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
            <span class="s1">super(InBodyPhase</span><span class="s0">, </span><span class="s1">self).__init__(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
            <span class="s4"># Set this to the default handler</span>
            <span class="s1">self.processSpaceCharacters = self.processSpaceCharactersNonPre</span>

        <span class="s0">def </span><span class="s1">isMatchingFormattingElement(self</span><span class="s0">, </span><span class="s1">node1</span><span class="s0">, </span><span class="s1">node2):</span>
            <span class="s0">return </span><span class="s1">(node1.name == node2.name </span><span class="s0">and</span>
                    <span class="s1">node1.namespace == node2.namespace </span><span class="s0">and</span>
                    <span class="s1">node1.attributes == node2.attributes)</span>

        <span class="s4"># helper</span>
        <span class="s0">def </span><span class="s1">addFormattingElement(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">element = self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]</span>

            <span class="s1">matchingElements = []</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self.tree.activeFormattingElements[::-</span><span class="s5">1</span><span class="s1">]:</span>
                <span class="s0">if </span><span class="s1">node </span><span class="s0">is </span><span class="s1">Marker:</span>
                    <span class="s0">break</span>
                <span class="s0">elif </span><span class="s1">self.isMatchingFormattingElement(node</span><span class="s0">, </span><span class="s1">element):</span>
                    <span class="s1">matchingElements.append(node)</span>

            <span class="s0">assert </span><span class="s1">len(matchingElements) &lt;= </span><span class="s5">3</span>
            <span class="s0">if </span><span class="s1">len(matchingElements) == </span><span class="s5">3</span><span class="s1">:</span>
                <span class="s1">self.tree.activeFormattingElements.remove(matchingElements[-</span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">self.tree.activeFormattingElements.append(element)</span>

        <span class="s4"># the real deal</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">allowed_elements = frozenset((</span><span class="s2">&quot;dd&quot;</span><span class="s0">, </span><span class="s2">&quot;dt&quot;</span><span class="s0">, </span><span class="s2">&quot;li&quot;</span><span class="s0">, </span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">,</span>
                                          <span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s2">&quot;body&quot;</span><span class="s0">,</span>
                                          <span class="s2">&quot;html&quot;</span><span class="s1">))</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self.tree.openElements[::-</span><span class="s5">1</span><span class="s1">]:</span>
                <span class="s0">if </span><span class="s1">node.name </span><span class="s0">not in </span><span class="s1">allowed_elements:</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-closing-tag-but-got-eof&quot;</span><span class="s1">)</span>
                    <span class="s0">break</span>
            <span class="s4"># Stop parsing</span>

        <span class="s0">def </span><span class="s1">processSpaceCharactersDropNewline(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># Sometimes (start of &lt;pre&gt;, &lt;listing&gt;, and &lt;textarea&gt; blocks) we</span>
            <span class="s4"># want to drop leading newlines</span>
            <span class="s1">data = token[</span><span class="s2">&quot;data&quot;</span><span class="s1">]</span>
            <span class="s1">self.processSpaceCharacters = self.processSpaceCharactersNonPre</span>
            <span class="s0">if </span><span class="s1">(data.startswith(</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">) </span><span class="s0">and</span>
                <span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name </span><span class="s0">in </span><span class="s1">(</span><span class="s2">&quot;pre&quot;</span><span class="s0">, </span><span class="s2">&quot;listing&quot;</span><span class="s0">, </span><span class="s2">&quot;textarea&quot;</span><span class="s1">) </span><span class="s0">and</span>
                    <span class="s0">not </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].hasContent()):</span>
                <span class="s1">data = data[</span><span class="s5">1</span><span class="s1">:]</span>
            <span class="s0">if </span><span class="s1">data:</span>
                <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
                <span class="s1">self.tree.insertText(data)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">] == </span><span class="s2">&quot;</span><span class="s0">\u0000</span><span class="s2">&quot;</span><span class="s1">:</span>
                <span class="s4"># The tokenizer should always emit null on its own</span>
                <span class="s0">return</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.tree.insertText(token[</span><span class="s2">&quot;data&quot;</span><span class="s1">])</span>
            <span class="s4"># This must be bad for performance</span>
            <span class="s0">if </span><span class="s1">(self.parser.framesetOK </span><span class="s0">and</span>
                <span class="s1">any([char </span><span class="s0">not in </span><span class="s1">spaceCharacters</span>
                     <span class="s0">for </span><span class="s1">char </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">]])):</span>
                <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">processSpaceCharactersNonPre(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.tree.insertText(token[</span><span class="s2">&quot;data&quot;</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">startTagProcessInHead(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagBody(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;body&quot;</span><span class="s1">})</span>
            <span class="s0">if </span><span class="s1">(len(self.tree.openElements) == </span><span class="s5">1 </span><span class="s0">or</span>
                    <span class="s1">self.tree.openElements[</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;body&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
                <span class="s0">for </span><span class="s1">attr</span><span class="s0">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">].items():</span>
                    <span class="s0">if </span><span class="s1">attr </span><span class="s0">not in </span><span class="s1">self.tree.openElements[</span><span class="s5">1</span><span class="s1">].attributes:</span>
                        <span class="s1">self.tree.openElements[</span><span class="s5">1</span><span class="s1">].attributes[attr] = value</span>

        <span class="s0">def </span><span class="s1">startTagFrameset(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;frameset&quot;</span><span class="s1">})</span>
            <span class="s0">if </span><span class="s1">(len(self.tree.openElements) == </span><span class="s5">1 </span><span class="s0">or </span><span class="s1">self.tree.openElements[</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;body&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
            <span class="s0">elif not </span><span class="s1">self.parser.framesetOK:</span>
                <span class="s0">pass</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[</span><span class="s5">1</span><span class="s1">].parent:</span>
                    <span class="s1">self.tree.openElements[</span><span class="s5">1</span><span class="s1">].parent.removeChild(self.tree.openElements[</span><span class="s5">1</span><span class="s1">])</span>
                <span class="s0">while </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                    <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.tree.insertElement(token)</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inFrameset&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagCloseP(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagPreListing(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
            <span class="s1">self.processSpaceCharacters = self.processSpaceCharactersDropNewline</span>

        <span class="s0">def </span><span class="s1">startTagForm(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.formPointer:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;form&quot;</span><span class="s1">})</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                    <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
                <span class="s1">self.tree.insertElement(token)</span>
                <span class="s1">self.tree.formPointer = self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagListItem(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>

            <span class="s1">stopNamesMap = {</span><span class="s2">&quot;li&quot;</span><span class="s1">: [</span><span class="s2">&quot;li&quot;</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s2">&quot;dt&quot;</span><span class="s1">: [</span><span class="s2">&quot;dt&quot;</span><span class="s0">, </span><span class="s2">&quot;dd&quot;</span><span class="s1">]</span><span class="s0">,</span>
                            <span class="s2">&quot;dd&quot;</span><span class="s1">: [</span><span class="s2">&quot;dt&quot;</span><span class="s0">, </span><span class="s2">&quot;dd&quot;</span><span class="s1">]}</span>
            <span class="s1">stopNames = stopNamesMap[token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]]</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">reversed(self.tree.openElements):</span>
                <span class="s0">if </span><span class="s1">node.name </span><span class="s0">in </span><span class="s1">stopNames:</span>
                    <span class="s1">self.parser.phase.processEndTag(</span>
                        <span class="s1">impliedTagToken(node.name</span><span class="s0">, </span><span class="s2">&quot;EndTag&quot;</span><span class="s1">))</span>
                    <span class="s0">break</span>
                <span class="s0">if </span><span class="s1">(node.nameTuple </span><span class="s0">in </span><span class="s1">specialElements </span><span class="s0">and</span>
                        <span class="s1">node.name </span><span class="s0">not in </span><span class="s1">(</span><span class="s2">&quot;address&quot;</span><span class="s0">, </span><span class="s2">&quot;div&quot;</span><span class="s0">, </span><span class="s2">&quot;p&quot;</span><span class="s1">)):</span>
                    <span class="s0">break</span>

            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.phase.processEndTag(</span>
                    <span class="s1">impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s2">&quot;EndTag&quot;</span><span class="s1">))</span>

            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagPlaintext(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.tokenizer.state = self.parser.tokenizer.plaintextState</span>

        <span class="s0">def </span><span class="s1">startTagHeading(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name </span><span class="s0">in </span><span class="s1">headingElements:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagA(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">afeAElement = self.tree.elementInActiveFormattingElements(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">afeAElement:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;startName&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;endName&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s1">})</span>
                <span class="s1">self.endTagFormatting(impliedTagToken(</span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
                <span class="s0">if </span><span class="s1">afeAElement </span><span class="s0">in </span><span class="s1">self.tree.openElements:</span>
                    <span class="s1">self.tree.openElements.remove(afeAElement)</span>
                <span class="s0">if </span><span class="s1">afeAElement </span><span class="s0">in </span><span class="s1">self.tree.activeFormattingElements:</span>
                    <span class="s1">self.tree.activeFormattingElements.remove(afeAElement)</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.addFormattingElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagFormatting(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.addFormattingElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagNobr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;nobr&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;startName&quot;</span><span class="s1">: </span><span class="s2">&quot;nobr&quot;</span><span class="s0">, </span><span class="s2">&quot;endName&quot;</span><span class="s1">: </span><span class="s2">&quot;nobr&quot;</span><span class="s1">})</span>
                <span class="s1">self.processEndTag(impliedTagToken(</span><span class="s2">&quot;nobr&quot;</span><span class="s1">))</span>
                <span class="s4"># XXX Need tests that trigger the following</span>
                <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.addFormattingElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagButton(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;startName&quot;</span><span class="s1">: </span><span class="s2">&quot;button&quot;</span><span class="s0">, </span><span class="s2">&quot;endName&quot;</span><span class="s1">: </span><span class="s2">&quot;button&quot;</span><span class="s1">})</span>
                <span class="s1">self.processEndTag(impliedTagToken(</span><span class="s2">&quot;button&quot;</span><span class="s1">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
                <span class="s1">self.tree.insertElement(token)</span>
                <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagAppletMarqueeObject(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.activeFormattingElements.append(Marker)</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagXmp(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
            <span class="s1">self.parser.parseRCDataRawtext(token</span><span class="s0">, </span><span class="s2">&quot;RAWTEXT&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.parser.compatMode != </span><span class="s2">&quot;quirks&quot;</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                    <span class="s1">self.processEndTag(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagVoidFormatting(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagInput(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">framesetOK = self.parser.framesetOK</span>
            <span class="s1">self.startTagVoidFormatting(token)</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s2">&quot;type&quot; </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">] </span><span class="s0">and</span>
                    <span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">][</span><span class="s2">&quot;type&quot;</span><span class="s1">].translate(asciiUpper2Lower) == </span><span class="s2">&quot;hidden&quot;</span><span class="s1">):</span>
                <span class="s4"># input type=hidden doesn't change framesetOK</span>
                <span class="s1">self.parser.framesetOK = framesetOK</span>

        <span class="s0">def </span><span class="s1">startTagParamSource(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagHr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagImage(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># No really...</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-treated-as&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;originalName&quot;</span><span class="s1">: </span><span class="s2">&quot;image&quot;</span><span class="s0">, </span><span class="s2">&quot;newName&quot;</span><span class="s1">: </span><span class="s2">&quot;img&quot;</span><span class="s1">})</span>
            <span class="s1">self.processStartTag(impliedTagToken(</span><span class="s2">&quot;img&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s0">,</span>
                                                 <span class="s1">attributes=token[</span><span class="s2">&quot;data&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">selfClosing=token[</span><span class="s2">&quot;selfClosing&quot;</span><span class="s1">]))</span>

        <span class="s0">def </span><span class="s1">startTagIsIndex(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;deprecated-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;isindex&quot;</span><span class="s1">})</span>
            <span class="s0">if </span><span class="s1">self.tree.formPointer:</span>
                <span class="s0">return</span>
            <span class="s1">form_attrs = {}</span>
            <span class="s0">if </span><span class="s2">&quot;action&quot; </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">]:</span>
                <span class="s1">form_attrs[</span><span class="s2">&quot;action&quot;</span><span class="s1">] = token[</span><span class="s2">&quot;data&quot;</span><span class="s1">][</span><span class="s2">&quot;action&quot;</span><span class="s1">]</span>
            <span class="s1">self.processStartTag(impliedTagToken(</span><span class="s2">&quot;form&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s0">,</span>
                                                 <span class="s1">attributes=form_attrs))</span>
            <span class="s1">self.processStartTag(impliedTagToken(</span><span class="s2">&quot;hr&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s1">self.processStartTag(impliedTagToken(</span><span class="s2">&quot;label&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s4"># XXX Localization ...</span>
            <span class="s0">if </span><span class="s2">&quot;prompt&quot; </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">]:</span>
                <span class="s1">prompt = token[</span><span class="s2">&quot;data&quot;</span><span class="s1">][</span><span class="s2">&quot;prompt&quot;</span><span class="s1">]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">prompt = </span><span class="s2">&quot;This is a searchable index. Enter search keywords: &quot;</span>
            <span class="s1">self.processCharacters(</span>
                <span class="s1">{</span><span class="s2">&quot;type&quot;</span><span class="s1">: tokenTypes[</span><span class="s2">&quot;Characters&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s1">: prompt})</span>
            <span class="s1">attributes = token[</span><span class="s2">&quot;data&quot;</span><span class="s1">].copy()</span>
            <span class="s0">if </span><span class="s2">&quot;action&quot; </span><span class="s0">in </span><span class="s1">attributes:</span>
                <span class="s0">del </span><span class="s1">attributes[</span><span class="s2">&quot;action&quot;</span><span class="s1">]</span>
            <span class="s0">if </span><span class="s2">&quot;prompt&quot; </span><span class="s0">in </span><span class="s1">attributes:</span>
                <span class="s0">del </span><span class="s1">attributes[</span><span class="s2">&quot;prompt&quot;</span><span class="s1">]</span>
            <span class="s1">attributes[</span><span class="s2">&quot;name&quot;</span><span class="s1">] = </span><span class="s2">&quot;isindex&quot;</span>
            <span class="s1">self.processStartTag(impliedTagToken(</span><span class="s2">&quot;input&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s0">,</span>
                                                 <span class="s1">attributes=attributes</span><span class="s0">,</span>
                                                 <span class="s1">selfClosing=token[</span><span class="s2">&quot;selfClosing&quot;</span><span class="s1">]))</span>
            <span class="s1">self.processEndTag(impliedTagToken(</span><span class="s2">&quot;label&quot;</span><span class="s1">))</span>
            <span class="s1">self.processStartTag(impliedTagToken(</span><span class="s2">&quot;hr&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s1">self.processEndTag(impliedTagToken(</span><span class="s2">&quot;form&quot;</span><span class="s1">))</span>

        <span class="s0">def </span><span class="s1">startTagTextarea(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.tokenizer.state = self.parser.tokenizer.rcdataState</span>
            <span class="s1">self.processSpaceCharacters = self.processSpaceCharactersDropNewline</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagIFrame(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
            <span class="s1">self.startTagRawtext(token)</span>

        <span class="s0">def </span><span class="s1">startTagNoscript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.parser.scripting:</span>
                <span class="s1">self.startTagRawtext(token)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.startTagOther(token)</span>

        <span class="s0">def </span><span class="s1">startTagRawtext(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s3">&quot;&quot;&quot;iframe, noembed noframes, noscript(if scripting enabled)&quot;&quot;&quot;</span>
            <span class="s1">self.parser.parseRCDataRawtext(token</span><span class="s0">, </span><span class="s2">&quot;RAWTEXT&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagOpt(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;option&quot;</span><span class="s1">:</span>
                <span class="s1">self.parser.phase.processEndTag(impliedTagToken(</span><span class="s2">&quot;option&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.parser.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagSelect(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
            <span class="s0">if </span><span class="s1">self.parser.phase </span><span class="s0">in </span><span class="s1">(self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                     <span class="s1">self.parser.phases[</span><span class="s2">&quot;inCaption&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                     <span class="s1">self.parser.phases[</span><span class="s2">&quot;inColumnGroup&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                     <span class="s1">self.parser.phases[</span><span class="s2">&quot;inTableBody&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                     <span class="s1">self.parser.phases[</span><span class="s2">&quot;inRow&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                     <span class="s1">self.parser.phases[</span><span class="s2">&quot;inCell&quot;</span><span class="s1">]):</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inSelectInTable&quot;</span><span class="s1">]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inSelect&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagRpRt(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;ruby&quot;</span><span class="s1">):</span>
                <span class="s1">self.tree.generateImpliedEndTags()</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;ruby&quot;</span><span class="s1">:</span>
                    <span class="s1">self.parser.parseError()</span>
            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagMath(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.parser.adjustMathMLAttributes(token)</span>
            <span class="s1">self.parser.adjustForeignAttributes(token)</span>
            <span class="s1">token[</span><span class="s2">&quot;namespace&quot;</span><span class="s1">] = namespaces[</span><span class="s2">&quot;mathml&quot;</span><span class="s1">]</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s4"># Need to get the parse error right for the case where the token</span>
            <span class="s4"># has a namespace not equal to the xmlns attribute</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;selfClosing&quot;</span><span class="s1">]:</span>
                <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagSvg(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.parser.adjustSVGAttributes(token)</span>
            <span class="s1">self.parser.adjustForeignAttributes(token)</span>
            <span class="s1">token[</span><span class="s2">&quot;namespace&quot;</span><span class="s1">] = namespaces[</span><span class="s2">&quot;svg&quot;</span><span class="s1">]</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s4"># Need to get the parse error right for the case where the token</span>
            <span class="s4"># has a namespace not equal to the xmlns attribute</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;selfClosing&quot;</span><span class="s1">]:</span>
                <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagMisplaced(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s3">&quot;&quot;&quot; Elements that should be children of other elements that have a 
            different insertion mode; here they are ignored 
            &quot;caption&quot;, &quot;col&quot;, &quot;colgroup&quot;, &quot;frame&quot;, &quot;frameset&quot;, &quot;head&quot;, 
            &quot;option&quot;, &quot;optgroup&quot;, &quot;tbody&quot;, &quot;td&quot;, &quot;tfoot&quot;, &quot;th&quot;, &quot;thead&quot;, 
            &quot;tr&quot;, &quot;noscript&quot; 
            &quot;&quot;&quot;</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-ignored&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">endTagP(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if not </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;button&quot;</span><span class="s1">):</span>
                <span class="s1">self.startTagCloseP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;p&quot;</span><span class="s1">})</span>
                <span class="s1">self.endTagP(impliedTagToken(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s2">&quot;EndTag&quot;</span><span class="s1">))</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.tree.generateImpliedEndTags(</span><span class="s2">&quot;p&quot;</span><span class="s1">)</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;p&quot;</span><span class="s1">:</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;p&quot;</span><span class="s1">})</span>
                <span class="s1">node = self.tree.openElements.pop()</span>
                <span class="s0">while </span><span class="s1">node.name != </span><span class="s2">&quot;p&quot;</span><span class="s1">:</span>
                    <span class="s1">node = self.tree.openElements.pop()</span>

        <span class="s0">def </span><span class="s1">endTagBody(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if not </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;body&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.parseError()</span>
                <span class="s0">return</span>
            <span class="s0">elif </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;body&quot;</span><span class="s1">:</span>
                <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self.tree.openElements[</span><span class="s5">2</span><span class="s1">:]:</span>
                    <span class="s0">if </span><span class="s1">node.name </span><span class="s0">not in </span><span class="s1">frozenset((</span><span class="s2">&quot;dd&quot;</span><span class="s0">, </span><span class="s2">&quot;dt&quot;</span><span class="s0">, </span><span class="s2">&quot;li&quot;</span><span class="s0">, </span><span class="s2">&quot;optgroup&quot;</span><span class="s0">,</span>
                                                   <span class="s2">&quot;option&quot;</span><span class="s0">, </span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s2">&quot;rp&quot;</span><span class="s0">, </span><span class="s2">&quot;rt&quot;</span><span class="s0">,</span>
                                                   <span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">,</span>
                                                   <span class="s2">&quot;th&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s2">&quot;body&quot;</span><span class="s0">,</span>
                                                   <span class="s2">&quot;html&quot;</span><span class="s1">)):</span>
                        <span class="s4"># Not sure this is the correct name for the parse error</span>
                        <span class="s1">self.parser.parseError(</span>
                            <span class="s2">&quot;expected-one-end-tag-but-got-another&quot;</span><span class="s0">,</span>
                            <span class="s1">{</span><span class="s2">&quot;gotName&quot;</span><span class="s1">: </span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;expectedName&quot;</span><span class="s1">: node.name})</span>
                        <span class="s0">break</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;afterBody&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># We repeat the test for the body end tag token being ignored here</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;body&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagBody(impliedTagToken(</span><span class="s2">&quot;body&quot;</span><span class="s1">))</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagBlock(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># Put us back in the right whitespace handling mode</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] == </span><span class="s2">&quot;pre&quot;</span><span class="s1">:</span>
                <span class="s1">self.processSpaceCharacters = self.processSpaceCharactersNonPre</span>
            <span class="s1">inScope = self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">])</span>
            <span class="s0">if </span><span class="s1">inScope:</span>
                <span class="s1">self.tree.generateImpliedEndTags()</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;end-tag-too-early&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s0">if </span><span class="s1">inScope:</span>
                <span class="s1">node = self.tree.openElements.pop()</span>
                <span class="s0">while </span><span class="s1">node.name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                    <span class="s1">node = self.tree.openElements.pop()</span>

        <span class="s0">def </span><span class="s1">endTagForm(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">node = self.tree.formPointer</span>
            <span class="s1">self.tree.formPointer = </span><span class="s0">None</span>
            <span class="s0">if </span><span class="s1">node </span><span class="s0">is None or not </span><span class="s1">self.tree.elementInScope(node):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;form&quot;</span><span class="s1">})</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.tree.generateImpliedEndTags()</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">] != node:</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;end-tag-too-early-ignored&quot;</span><span class="s0">,</span>
                                           <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;form&quot;</span><span class="s1">})</span>
                <span class="s1">self.tree.openElements.remove(node)</span>

        <span class="s0">def </span><span class="s1">endTagListItem(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] == </span><span class="s2">&quot;li&quot;</span><span class="s1">:</span>
                <span class="s1">variant = </span><span class="s2">&quot;list&quot;</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">variant = </span><span class="s0">None</span>
            <span class="s0">if not </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">variant=variant):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.tree.generateImpliedEndTags(exclude=token[</span><span class="s2">&quot;name&quot;</span><span class="s1">])</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                    <span class="s1">self.parser.parseError(</span>
                        <span class="s2">&quot;end-tag-too-early&quot;</span><span class="s0">,</span>
                        <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                <span class="s1">node = self.tree.openElements.pop()</span>
                <span class="s0">while </span><span class="s1">node.name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                    <span class="s1">node = self.tree.openElements.pop()</span>

        <span class="s0">def </span><span class="s1">endTagHeading(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">headingElements:</span>
                <span class="s0">if </span><span class="s1">self.tree.elementInScope(item):</span>
                    <span class="s1">self.tree.generateImpliedEndTags()</span>
                    <span class="s0">break</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;end-tag-too-early&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

            <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">headingElements:</span>
                <span class="s0">if </span><span class="s1">self.tree.elementInScope(item):</span>
                    <span class="s1">item = self.tree.openElements.pop()</span>
                    <span class="s0">while </span><span class="s1">item.name </span><span class="s0">not in </span><span class="s1">headingElements:</span>
                        <span class="s1">item = self.tree.openElements.pop()</span>
                    <span class="s0">break</span>

        <span class="s0">def </span><span class="s1">endTagFormatting(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s3">&quot;&quot;&quot;The much-feared adoption agency algorithm&quot;&quot;&quot;</span>
            <span class="s4"># http://svn.whatwg.org/webapps/complete.html#adoptionAgency revision 7867</span>
            <span class="s4"># XXX Better parseError messages appreciated.</span>

            <span class="s4"># Step 1</span>
            <span class="s1">outerLoopCounter = </span><span class="s5">0</span>

            <span class="s4"># Step 2</span>
            <span class="s0">while </span><span class="s1">outerLoopCounter &lt; </span><span class="s5">8</span><span class="s1">:</span>

                <span class="s4"># Step 3</span>
                <span class="s1">outerLoopCounter += </span><span class="s5">1</span>

                <span class="s4"># Step 4:</span>

                <span class="s4"># Let the formatting element be the last element in</span>
                <span class="s4"># the list of active formatting elements that:</span>
                <span class="s4"># - is between the end of the list and the last scope</span>
                <span class="s4"># marker in the list, if any, or the start of the list</span>
                <span class="s4"># otherwise, and</span>
                <span class="s4"># - has the same tag name as the token.</span>
                <span class="s1">formattingElement = self.tree.elementInActiveFormattingElements(</span>
                    <span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">])</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s0">not </span><span class="s1">formattingElement </span><span class="s0">or</span>
                    <span class="s1">(formattingElement </span><span class="s0">in </span><span class="s1">self.tree.openElements </span><span class="s0">and</span>
                     <span class="s0">not </span><span class="s1">self.tree.elementInScope(formattingElement.name))):</span>
                    <span class="s4"># If there is no such node, then abort these steps</span>
                    <span class="s4"># and instead act as described in the &quot;any other</span>
                    <span class="s4"># end tag&quot; entry below.</span>
                    <span class="s1">self.endTagOther(token)</span>
                    <span class="s0">return</span>

                <span class="s4"># Otherwise, if there is such a node, but that node is</span>
                <span class="s4"># not in the stack of open elements, then this is a</span>
                <span class="s4"># parse error; remove the element from the list, and</span>
                <span class="s4"># abort these steps.</span>
                <span class="s0">elif </span><span class="s1">formattingElement </span><span class="s0">not in </span><span class="s1">self.tree.openElements:</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;adoption-agency-1.2&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                    <span class="s1">self.tree.activeFormattingElements.remove(formattingElement)</span>
                    <span class="s0">return</span>

                <span class="s4"># Otherwise, if there is such a node, and that node is</span>
                <span class="s4"># also in the stack of open elements, but the element</span>
                <span class="s4"># is not in scope, then this is a parse error; ignore</span>
                <span class="s4"># the token, and abort these steps.</span>
                <span class="s0">elif not </span><span class="s1">self.tree.elementInScope(formattingElement.name):</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;adoption-agency-4.4&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                    <span class="s0">return</span>

                <span class="s4"># Otherwise, there is a formatting element and that</span>
                <span class="s4"># element is in the stack and is in scope. If the</span>
                <span class="s4"># element is not the current node, this is a parse</span>
                <span class="s4"># error. In any case, proceed with the algorithm as</span>
                <span class="s4"># written in the following steps.</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s0">if </span><span class="s1">formattingElement != self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]:</span>
                        <span class="s1">self.parser.parseError(</span><span class="s2">&quot;adoption-agency-1.3&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

                <span class="s4"># Step 5:</span>

                <span class="s4"># Let the furthest block be the topmost node in the</span>
                <span class="s4"># stack of open elements that is lower in the stack</span>
                <span class="s4"># than the formatting element, and is an element in</span>
                <span class="s4"># the special category. There might not be one.</span>
                <span class="s1">afeIndex = self.tree.openElements.index(formattingElement)</span>
                <span class="s1">furthestBlock = </span><span class="s0">None</span>
                <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">self.tree.openElements[afeIndex:]:</span>
                    <span class="s0">if </span><span class="s1">element.nameTuple </span><span class="s0">in </span><span class="s1">specialElements:</span>
                        <span class="s1">furthestBlock = element</span>
                        <span class="s0">break</span>

                <span class="s4"># Step 6:</span>

                <span class="s4"># If there is no furthest block, then the UA must</span>
                <span class="s4"># first pop all the nodes from the bottom of the stack</span>
                <span class="s4"># of open elements, from the current node up to and</span>
                <span class="s4"># including the formatting element, then remove the</span>
                <span class="s4"># formatting element from the list of active</span>
                <span class="s4"># formatting elements, and finally abort these steps.</span>
                <span class="s0">if </span><span class="s1">furthestBlock </span><span class="s0">is None</span><span class="s1">:</span>
                    <span class="s1">element = self.tree.openElements.pop()</span>
                    <span class="s0">while </span><span class="s1">element != formattingElement:</span>
                        <span class="s1">element = self.tree.openElements.pop()</span>
                    <span class="s1">self.tree.activeFormattingElements.remove(element)</span>
                    <span class="s0">return</span>

                <span class="s4"># Step 7</span>
                <span class="s1">commonAncestor = self.tree.openElements[afeIndex - </span><span class="s5">1</span><span class="s1">]</span>

                <span class="s4"># Step 8:</span>
                <span class="s4"># The bookmark is supposed to help us identify where to reinsert</span>
                <span class="s4"># nodes in step 15. We have to ensure that we reinsert nodes after</span>
                <span class="s4"># the node before the active formatting element. Note the bookmark</span>
                <span class="s4"># can move in step 9.7</span>
                <span class="s1">bookmark = self.tree.activeFormattingElements.index(formattingElement)</span>

                <span class="s4"># Step 9</span>
                <span class="s1">lastNode = node = furthestBlock</span>
                <span class="s1">innerLoopCounter = </span><span class="s5">0</span>

                <span class="s1">index = self.tree.openElements.index(node)</span>
                <span class="s0">while </span><span class="s1">innerLoopCounter &lt; </span><span class="s5">3</span><span class="s1">:</span>
                    <span class="s1">innerLoopCounter += </span><span class="s5">1</span>
                    <span class="s4"># Node is element before node in open elements</span>
                    <span class="s1">index -= </span><span class="s5">1</span>
                    <span class="s1">node = self.tree.openElements[index]</span>
                    <span class="s0">if </span><span class="s1">node </span><span class="s0">not in </span><span class="s1">self.tree.activeFormattingElements:</span>
                        <span class="s1">self.tree.openElements.remove(node)</span>
                        <span class="s0">continue</span>
                    <span class="s4"># Step 9.6</span>
                    <span class="s0">if </span><span class="s1">node == formattingElement:</span>
                        <span class="s0">break</span>
                    <span class="s4"># Step 9.7</span>
                    <span class="s0">if </span><span class="s1">lastNode == furthestBlock:</span>
                        <span class="s1">bookmark = self.tree.activeFormattingElements.index(node) + </span><span class="s5">1</span>
                    <span class="s4"># Step 9.8</span>
                    <span class="s1">clone = node.cloneNode()</span>
                    <span class="s4"># Replace node with clone</span>
                    <span class="s1">self.tree.activeFormattingElements[</span>
                        <span class="s1">self.tree.activeFormattingElements.index(node)] = clone</span>
                    <span class="s1">self.tree.openElements[</span>
                        <span class="s1">self.tree.openElements.index(node)] = clone</span>
                    <span class="s1">node = clone</span>
                    <span class="s4"># Step 9.9</span>
                    <span class="s4"># Remove lastNode from its parents, if any</span>
                    <span class="s0">if </span><span class="s1">lastNode.parent:</span>
                        <span class="s1">lastNode.parent.removeChild(lastNode)</span>
                    <span class="s1">node.appendChild(lastNode)</span>
                    <span class="s4"># Step 9.10</span>
                    <span class="s1">lastNode = node</span>

                <span class="s4"># Step 10</span>
                <span class="s4"># Foster parent lastNode if commonAncestor is a</span>
                <span class="s4"># table, tbody, tfoot, thead, or tr we need to foster</span>
                <span class="s4"># parent the lastNode</span>
                <span class="s0">if </span><span class="s1">lastNode.parent:</span>
                    <span class="s1">lastNode.parent.removeChild(lastNode)</span>

                <span class="s0">if </span><span class="s1">commonAncestor.name </span><span class="s0">in </span><span class="s1">frozenset((</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s1">)):</span>
                    <span class="s1">parent</span><span class="s0">, </span><span class="s1">insertBefore = self.tree.getTableMisnestedNodePosition()</span>
                    <span class="s1">parent.insertBefore(lastNode</span><span class="s0">, </span><span class="s1">insertBefore)</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">commonAncestor.appendChild(lastNode)</span>

                <span class="s4"># Step 11</span>
                <span class="s1">clone = formattingElement.cloneNode()</span>

                <span class="s4"># Step 12</span>
                <span class="s1">furthestBlock.reparentChildren(clone)</span>

                <span class="s4"># Step 13</span>
                <span class="s1">furthestBlock.appendChild(clone)</span>

                <span class="s4"># Step 14</span>
                <span class="s1">self.tree.activeFormattingElements.remove(formattingElement)</span>
                <span class="s1">self.tree.activeFormattingElements.insert(bookmark</span><span class="s0">, </span><span class="s1">clone)</span>

                <span class="s4"># Step 15</span>
                <span class="s1">self.tree.openElements.remove(formattingElement)</span>
                <span class="s1">self.tree.openElements.insert(</span>
                    <span class="s1">self.tree.openElements.index(furthestBlock) + </span><span class="s5">1</span><span class="s0">, </span><span class="s1">clone)</span>

        <span class="s0">def </span><span class="s1">endTagAppletMarqueeObject(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]):</span>
                <span class="s1">self.tree.generateImpliedEndTags()</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;end-tag-too-early&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

            <span class="s0">if </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]):</span>
                <span class="s1">element = self.tree.openElements.pop()</span>
                <span class="s0">while </span><span class="s1">element.name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                    <span class="s1">element = self.tree.openElements.pop()</span>
                <span class="s1">self.tree.clearActiveFormattingElements()</span>

        <span class="s0">def </span><span class="s1">endTagBr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-treated-as&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;originalName&quot;</span><span class="s1">: </span><span class="s2">&quot;br&quot;</span><span class="s0">, </span><span class="s2">&quot;newName&quot;</span><span class="s1">: </span><span class="s2">&quot;br element&quot;</span><span class="s1">})</span>
            <span class="s1">self.tree.reconstructActiveFormattingElements()</span>
            <span class="s1">self.tree.insertElement(impliedTagToken(</span><span class="s2">&quot;br&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s1">self.tree.openElements.pop()</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self.tree.openElements[::-</span><span class="s5">1</span><span class="s1">]:</span>
                <span class="s0">if </span><span class="s1">node.name == token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                    <span class="s1">self.tree.generateImpliedEndTags(exclude=token[</span><span class="s2">&quot;name&quot;</span><span class="s1">])</span>
                    <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                        <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                    <span class="s0">while </span><span class="s1">self.tree.openElements.pop() != node:</span>
                        <span class="s0">pass</span>
                    <span class="s0">break</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s0">if </span><span class="s1">node.nameTuple </span><span class="s0">in </span><span class="s1">specialElements:</span>
                        <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                        <span class="s0">break</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;base&quot;</span><span class="s0">, </span><span class="s2">&quot;basefont&quot;</span><span class="s0">, </span><span class="s2">&quot;bgsound&quot;</span><span class="s0">, </span><span class="s2">&quot;command&quot;</span><span class="s0">, </span><span class="s2">&quot;link&quot;</span><span class="s0">, </span><span class="s2">&quot;meta&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;script&quot;</span><span class="s0">, </span><span class="s2">&quot;style&quot;</span><span class="s0">, </span><span class="s2">&quot;title&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">startTagProcessInHead)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s1">startTagBody)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;frameset&quot;</span><span class="s0">, </span><span class="s1">startTagFrameset)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;address&quot;</span><span class="s0">, </span><span class="s2">&quot;article&quot;</span><span class="s0">, </span><span class="s2">&quot;aside&quot;</span><span class="s0">, </span><span class="s2">&quot;blockquote&quot;</span><span class="s0">, </span><span class="s2">&quot;center&quot;</span><span class="s0">, </span><span class="s2">&quot;details&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;dir&quot;</span><span class="s0">, </span><span class="s2">&quot;div&quot;</span><span class="s0">, </span><span class="s2">&quot;dl&quot;</span><span class="s0">, </span><span class="s2">&quot;fieldset&quot;</span><span class="s0">, </span><span class="s2">&quot;figcaption&quot;</span><span class="s0">, </span><span class="s2">&quot;figure&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;footer&quot;</span><span class="s0">, </span><span class="s2">&quot;header&quot;</span><span class="s0">, </span><span class="s2">&quot;hgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;main&quot;</span><span class="s0">, </span><span class="s2">&quot;menu&quot;</span><span class="s0">, </span><span class="s2">&quot;nav&quot;</span><span class="s0">, </span><span class="s2">&quot;ol&quot;</span><span class="s0">, </span><span class="s2">&quot;p&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;section&quot;</span><span class="s0">, </span><span class="s2">&quot;summary&quot;</span><span class="s0">, </span><span class="s2">&quot;ul&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">startTagCloseP)</span><span class="s0">,</span>
            <span class="s1">(headingElements</span><span class="s0">, </span><span class="s1">startTagHeading)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;pre&quot;</span><span class="s0">, </span><span class="s2">&quot;listing&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagPreListing)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;form&quot;</span><span class="s0">, </span><span class="s1">startTagForm)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;li&quot;</span><span class="s0">, </span><span class="s2">&quot;dd&quot;</span><span class="s0">, </span><span class="s2">&quot;dt&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagListItem)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;plaintext&quot;</span><span class="s0">, </span><span class="s1">startTagPlaintext)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">startTagA)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;big&quot;</span><span class="s0">, </span><span class="s2">&quot;code&quot;</span><span class="s0">, </span><span class="s2">&quot;em&quot;</span><span class="s0">, </span><span class="s2">&quot;font&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s2">&quot;s&quot;</span><span class="s0">, </span><span class="s2">&quot;small&quot;</span><span class="s0">, </span><span class="s2">&quot;strike&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;strong&quot;</span><span class="s0">, </span><span class="s2">&quot;tt&quot;</span><span class="s0">, </span><span class="s2">&quot;u&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagFormatting)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;nobr&quot;</span><span class="s0">, </span><span class="s1">startTagNobr)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;button&quot;</span><span class="s0">, </span><span class="s1">startTagButton)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;applet&quot;</span><span class="s0">, </span><span class="s2">&quot;marquee&quot;</span><span class="s0">, </span><span class="s2">&quot;object&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagAppletMarqueeObject)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;xmp&quot;</span><span class="s0">, </span><span class="s1">startTagXmp)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">startTagTable)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;area&quot;</span><span class="s0">, </span><span class="s2">&quot;br&quot;</span><span class="s0">, </span><span class="s2">&quot;embed&quot;</span><span class="s0">, </span><span class="s2">&quot;img&quot;</span><span class="s0">, </span><span class="s2">&quot;keygen&quot;</span><span class="s0">, </span><span class="s2">&quot;wbr&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">startTagVoidFormatting)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;param&quot;</span><span class="s0">, </span><span class="s2">&quot;source&quot;</span><span class="s0">, </span><span class="s2">&quot;track&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagParamSource)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;input&quot;</span><span class="s0">, </span><span class="s1">startTagInput)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;hr&quot;</span><span class="s0">, </span><span class="s1">startTagHr)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;image&quot;</span><span class="s0">, </span><span class="s1">startTagImage)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;isindex&quot;</span><span class="s0">, </span><span class="s1">startTagIsIndex)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;textarea&quot;</span><span class="s0">, </span><span class="s1">startTagTextarea)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;iframe&quot;</span><span class="s0">, </span><span class="s1">startTagIFrame)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;noscript&quot;</span><span class="s0">, </span><span class="s1">startTagNoscript)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;noembed&quot;</span><span class="s0">, </span><span class="s2">&quot;noframes&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagRawtext)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;select&quot;</span><span class="s0">, </span><span class="s1">startTagSelect)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;rp&quot;</span><span class="s0">, </span><span class="s2">&quot;rt&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagRpRt)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;option&quot;</span><span class="s0">, </span><span class="s2">&quot;optgroup&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagOpt)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;math&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagMath)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;svg&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagSvg)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;frame&quot;</span><span class="s0">, </span><span class="s2">&quot;head&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagMisplaced)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s1">endTagBody)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">endTagHtml)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;address&quot;</span><span class="s0">, </span><span class="s2">&quot;article&quot;</span><span class="s0">, </span><span class="s2">&quot;aside&quot;</span><span class="s0">, </span><span class="s2">&quot;blockquote&quot;</span><span class="s0">, </span><span class="s2">&quot;button&quot;</span><span class="s0">, </span><span class="s2">&quot;center&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;details&quot;</span><span class="s0">, </span><span class="s2">&quot;dialog&quot;</span><span class="s0">, </span><span class="s2">&quot;dir&quot;</span><span class="s0">, </span><span class="s2">&quot;div&quot;</span><span class="s0">, </span><span class="s2">&quot;dl&quot;</span><span class="s0">, </span><span class="s2">&quot;fieldset&quot;</span><span class="s0">, </span><span class="s2">&quot;figcaption&quot;</span><span class="s0">, </span><span class="s2">&quot;figure&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;footer&quot;</span><span class="s0">, </span><span class="s2">&quot;header&quot;</span><span class="s0">, </span><span class="s2">&quot;hgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;listing&quot;</span><span class="s0">, </span><span class="s2">&quot;main&quot;</span><span class="s0">, </span><span class="s2">&quot;menu&quot;</span><span class="s0">, </span><span class="s2">&quot;nav&quot;</span><span class="s0">, </span><span class="s2">&quot;ol&quot;</span><span class="s0">, </span><span class="s2">&quot;pre&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;section&quot;</span><span class="s0">, </span><span class="s2">&quot;summary&quot;</span><span class="s0">, </span><span class="s2">&quot;ul&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagBlock)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;form&quot;</span><span class="s0">, </span><span class="s1">endTagForm)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s1">endTagP)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;dd&quot;</span><span class="s0">, </span><span class="s2">&quot;dt&quot;</span><span class="s0">, </span><span class="s2">&quot;li&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagListItem)</span><span class="s0">,</span>
            <span class="s1">(headingElements</span><span class="s0">, </span><span class="s1">endTagHeading)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;big&quot;</span><span class="s0">, </span><span class="s2">&quot;code&quot;</span><span class="s0">, </span><span class="s2">&quot;em&quot;</span><span class="s0">, </span><span class="s2">&quot;font&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s2">&quot;nobr&quot;</span><span class="s0">, </span><span class="s2">&quot;s&quot;</span><span class="s0">, </span><span class="s2">&quot;small&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;strike&quot;</span><span class="s0">, </span><span class="s2">&quot;strong&quot;</span><span class="s0">, </span><span class="s2">&quot;tt&quot;</span><span class="s0">, </span><span class="s2">&quot;u&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagFormatting)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;applet&quot;</span><span class="s0">, </span><span class="s2">&quot;marquee&quot;</span><span class="s0">, </span><span class="s2">&quot;object&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagAppletMarqueeObject)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;br&quot;</span><span class="s0">, </span><span class="s1">endTagBr)</span><span class="s0">,</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">TextPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertText(token[</span><span class="s2">&quot;data&quot;</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-named-closing-tag-but-got-eof&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name})</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">self.parser.phase = self.parser.originalPhase</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">assert False, </span><span class="s2">&quot;Tried to process start tag %s in RCDATA/RAWTEXT mode&quot; </span><span class="s1">% token[</span><span class="s2">'name'</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagScript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">node = self.tree.openElements.pop()</span>
            <span class="s0">assert </span><span class="s1">node.name == </span><span class="s2">&quot;script&quot;</span>
            <span class="s1">self.parser.phase = self.parser.originalPhase</span>
            <span class="s4"># The rest of this method is all stuff that only happens if</span>
            <span class="s4"># document.write works</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">self.parser.phase = self.parser.originalPhase</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>
        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;script&quot;</span><span class="s0">, </span><span class="s1">endTagScript)])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InTablePhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-table</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s4"># helper methods</span>
        <span class="s0">def </span><span class="s1">clearStackToTableContext(self):</span>
            <span class="s4"># &quot;clear the stack back to a table context&quot;</span>
            <span class="s0">while </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name </span><span class="s0">not in </span><span class="s1">(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s1">):</span>
                <span class="s4"># self.parser.parseError(&quot;unexpected-implied-end-tag-in-table&quot;,</span>
                <span class="s4">#  {&quot;name&quot;:  self.tree.openElements[-1].name})</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s4"># When the current node is &lt;html&gt; it's an innerHTML case</span>

        <span class="s4"># processing methods</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;eof-in-table&quot;</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
            <span class="s4"># Stop parsing</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">originalPhase = self.parser.phase</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTableText&quot;</span><span class="s1">]</span>
            <span class="s1">self.parser.phase.originalPhase = originalPhase</span>
            <span class="s1">self.parser.phase.processSpaceCharacters(token)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">originalPhase = self.parser.phase</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTableText&quot;</span><span class="s1">]</span>
            <span class="s1">self.parser.phase.originalPhase = originalPhase</span>
            <span class="s1">self.parser.phase.processCharacters(token)</span>

        <span class="s0">def </span><span class="s1">insertText(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># If we get here there must be at least one non-whitespace character</span>
            <span class="s4"># Do the table magic!</span>
            <span class="s1">self.tree.insertFromTable = </span><span class="s0">True</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processCharacters(token)</span>
            <span class="s1">self.tree.insertFromTable = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagCaption(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.clearStackToTableContext()</span>
            <span class="s1">self.tree.activeFormattingElements.append(Marker)</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inCaption&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagColgroup(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.clearStackToTableContext()</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inColumnGroup&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagCol(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.startTagColgroup(impliedTagToken(</span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagRowGroup(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.clearStackToTableContext()</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTableBody&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagImplyTbody(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.startTagRowGroup(impliedTagToken(</span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;startName&quot;</span><span class="s1">: </span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s2">&quot;endName&quot;</span><span class="s1">: </span><span class="s2">&quot;table&quot;</span><span class="s1">})</span>
            <span class="s1">self.parser.phase.processEndTag(impliedTagToken(</span><span class="s2">&quot;table&quot;</span><span class="s1">))</span>
            <span class="s0">if not </span><span class="s1">self.parser.innerHTML:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagStyleScript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagInput(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s2">&quot;type&quot; </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">] </span><span class="s0">and</span>
                    <span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">][</span><span class="s2">&quot;type&quot;</span><span class="s1">].translate(asciiUpper2Lower) == </span><span class="s2">&quot;hidden&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-hidden-input-in-table&quot;</span><span class="s1">)</span>
                <span class="s1">self.tree.insertElement(token)</span>
                <span class="s4"># XXX associate with form</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.startTagOther(token)</span>

        <span class="s0">def </span><span class="s1">startTagForm(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-form-in-table&quot;</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">self.tree.formPointer </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s1">self.tree.insertElement(token)</span>
                <span class="s1">self.tree.formPointer = self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]</span>
                <span class="s1">self.tree.openElements.pop()</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-implies-table-voodoo&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s4"># Do the table magic!</span>
            <span class="s1">self.tree.insertFromTable = </span><span class="s0">True</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>
            <span class="s1">self.tree.insertFromTable = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">endTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.tree.generateImpliedEndTags()</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;table&quot;</span><span class="s1">:</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;end-tag-too-early-named&quot;</span><span class="s0">,</span>
                                           <span class="s1">{</span><span class="s2">&quot;gotName&quot;</span><span class="s1">: </span><span class="s2">&quot;table&quot;</span><span class="s0">,</span>
                                            <span class="s2">&quot;expectedName&quot;</span><span class="s1">: self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name})</span>
                <span class="s0">while </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;table&quot;</span><span class="s1">:</span>
                    <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.parser.resetInsertionMode()</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">endTagIgnore(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-implies-table-voodoo&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s4"># Do the table magic!</span>
            <span class="s1">self.tree.insertFromTable = </span><span class="s0">True</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processEndTag(token)</span>
            <span class="s1">self.tree.insertFromTable = </span><span class="s0">False</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s1">startTagCaption)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s1">startTagColgroup)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s1">startTagCol)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagRowGroup)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagImplyTbody)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">startTagTable)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;style&quot;</span><span class="s0">, </span><span class="s2">&quot;script&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagStyleScript)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;input&quot;</span><span class="s0">, </span><span class="s1">startTagInput)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;form&quot;</span><span class="s0">, </span><span class="s1">startTagForm)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">endTagTable)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagIgnore)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InTableTextPhase(Phase):</span>
        <span class="s1">__slots__ = (</span><span class="s2">&quot;originalPhase&quot;</span><span class="s0">, </span><span class="s2">&quot;characterTokens&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
            <span class="s1">super(InTableTextPhase</span><span class="s0">, </span><span class="s1">self).__init__(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
            <span class="s1">self.originalPhase = </span><span class="s0">None</span>
            <span class="s1">self.characterTokens = []</span>

        <span class="s0">def </span><span class="s1">flushCharacters(self):</span>
            <span class="s1">data = </span><span class="s2">&quot;&quot;</span><span class="s1">.join([item[</span><span class="s2">&quot;data&quot;</span><span class="s1">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">self.characterTokens])</span>
            <span class="s0">if </span><span class="s1">any([item </span><span class="s0">not in </span><span class="s1">spaceCharacters </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data]):</span>
                <span class="s1">token = {</span><span class="s2">&quot;type&quot;</span><span class="s1">: tokenTypes[</span><span class="s2">&quot;Characters&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s1">: data}</span>
                <span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].insertText(token)</span>
            <span class="s0">elif </span><span class="s1">data:</span>
                <span class="s1">self.tree.insertText(data)</span>
            <span class="s1">self.characterTokens = []</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.flushCharacters()</span>
            <span class="s1">self.parser.phase = self.originalPhase</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.flushCharacters()</span>
            <span class="s1">self.parser.phase = self.originalPhase</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">] == </span><span class="s2">&quot;</span><span class="s0">\u0000</span><span class="s2">&quot;</span><span class="s1">:</span>
                <span class="s0">return</span>
            <span class="s1">self.characterTokens.append(token)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># pretty sure we should never reach here</span>
            <span class="s1">self.characterTokens.append(token)</span>
    <span class="s4">#        assert False</span>

        <span class="s0">def </span><span class="s1">processStartTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.flushCharacters()</span>
            <span class="s1">self.parser.phase = self.originalPhase</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.flushCharacters()</span>
            <span class="s1">self.parser.phase = self.originalPhase</span>
            <span class="s0">return </span><span class="s1">token</span>

    <span class="s0">class </span><span class="s1">InCaptionPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-caption</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">ignoreEndTagCaption(self):</span>
            <span class="s0">return not </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processEOF()</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processCharacters(token)</span>

        <span class="s0">def </span><span class="s1">startTagTableElement(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError()</span>
            <span class="s4"># XXX Have to duplicate logic here to find out if the tag is ignored</span>
            <span class="s1">ignoreEndTag = self.ignoreEndTagCaption()</span>
            <span class="s1">self.parser.phase.processEndTag(impliedTagToken(</span><span class="s2">&quot;caption&quot;</span><span class="s1">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">endTagCaption(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if not </span><span class="s1">self.ignoreEndTagCaption():</span>
                <span class="s4"># AT this code is quite similar to endTagTable in &quot;InTable&quot;</span>
                <span class="s1">self.tree.generateImpliedEndTags()</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;caption&quot;</span><span class="s1">:</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-one-end-tag-but-got-another&quot;</span><span class="s0">,</span>
                                           <span class="s1">{</span><span class="s2">&quot;gotName&quot;</span><span class="s1">: </span><span class="s2">&quot;caption&quot;</span><span class="s0">,</span>
                                            <span class="s2">&quot;expectedName&quot;</span><span class="s1">: self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name})</span>
                <span class="s0">while </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;caption&quot;</span><span class="s1">:</span>
                    <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.tree.clearActiveFormattingElements()</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">endTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError()</span>
            <span class="s1">ignoreEndTag = self.ignoreEndTagCaption()</span>
            <span class="s1">self.parser.phase.processEndTag(impliedTagToken(</span><span class="s2">&quot;caption&quot;</span><span class="s1">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagIgnore(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processEndTag(token)</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagTableElement)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s1">endTagCaption)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">endTagTable)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagIgnore)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InColumnGroupPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-column</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">ignoreEndTagColgroup(self):</span>
            <span class="s0">return </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;html&quot;</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s0">return</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">ignoreEndTag = self.ignoreEndTagColgroup()</span>
                <span class="s1">self.endTagColgroup(impliedTagToken(</span><span class="s2">&quot;colgroup&quot;</span><span class="s1">))</span>
                <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                    <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">ignoreEndTag = self.ignoreEndTagColgroup()</span>
            <span class="s1">self.endTagColgroup(impliedTagToken(</span><span class="s2">&quot;colgroup&quot;</span><span class="s1">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagCol(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">ignoreEndTag = self.ignoreEndTagColgroup()</span>
            <span class="s1">self.endTagColgroup(impliedTagToken(</span><span class="s2">&quot;colgroup&quot;</span><span class="s1">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagColgroup(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.ignoreEndTagColgroup():</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagCol(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;no-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;col&quot;</span><span class="s1">})</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">ignoreEndTag = self.ignoreEndTagColgroup()</span>
            <span class="s1">self.endTagColgroup(impliedTagToken(</span><span class="s2">&quot;colgroup&quot;</span><span class="s1">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s1">startTagCol)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s1">endTagColgroup)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s1">endTagCol)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InTableBodyPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-table0</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s4"># helper methods</span>
        <span class="s0">def </span><span class="s1">clearStackToTableBodyContext(self):</span>
            <span class="s0">while </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name </span><span class="s0">not in </span><span class="s1">(</span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">,</span>
                                                          <span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s1">):</span>
                <span class="s4"># self.parser.parseError(&quot;unexpected-implied-end-tag-in-table&quot;,</span>
                <span class="s4">#  {&quot;name&quot;: self.tree.openElements[-1].name})</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>

        <span class="s4"># the rest</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processEOF()</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processSpaceCharacters(token)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processCharacters(token)</span>

        <span class="s0">def </span><span class="s1">startTagTr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.clearStackToTableBodyContext()</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inRow&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">startTagTableCell(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-cell-in-table-body&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.startTagTr(impliedTagToken(</span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s2">&quot;StartTag&quot;</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagTableOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># XXX AT Any ideas on how to share this with endTagTable?</span>
            <span class="s0">if </span><span class="s1">(self.tree.elementInScope(</span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">) </span><span class="s0">or</span>
                <span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">) </span><span class="s0">or</span>
                    <span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">)):</span>
                <span class="s1">self.clearStackToTableBodyContext()</span>
                <span class="s1">self.endTagTableRowGroup(</span>
                    <span class="s1">impliedTagToken(self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">endTagTableRowGroup(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.clearStackToTableBodyContext()</span>
                <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-in-table-body&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">(self.tree.elementInScope(</span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">) </span><span class="s0">or</span>
                <span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">) </span><span class="s0">or</span>
                    <span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">)):</span>
                <span class="s1">self.clearStackToTableBodyContext()</span>
                <span class="s1">self.endTagTableRowGroup(</span>
                    <span class="s1">impliedTagToken(self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">endTagIgnore(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-in-table-body&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processEndTag(token)</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s1">startTagTr)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagTableCell)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">startTagTableOther)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">((</span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagTableRowGroup)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">endTagTable)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagIgnore)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InRowPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-row</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s4"># helper methods (XXX unify this with other table helper methods)</span>
        <span class="s0">def </span><span class="s1">clearStackToTableRowContext(self):</span>
            <span class="s0">while </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name </span><span class="s0">not in </span><span class="s1">(</span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s1">):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-implied-end-tag-in-table-row&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name})</span>
                <span class="s1">self.tree.openElements.pop()</span>

        <span class="s0">def </span><span class="s1">ignoreEndTagTr(self):</span>
            <span class="s0">return not </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">)</span>

        <span class="s4"># the rest</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processEOF()</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processSpaceCharacters(token)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processCharacters(token)</span>

        <span class="s0">def </span><span class="s1">startTagTableCell(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.clearStackToTableRowContext()</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inCell&quot;</span><span class="s1">]</span>
            <span class="s1">self.tree.activeFormattingElements.append(Marker)</span>

        <span class="s0">def </span><span class="s1">startTagTableOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">ignoreEndTag = self.ignoreEndTagTr()</span>
            <span class="s1">self.endTagTr(impliedTagToken(</span><span class="s2">&quot;tr&quot;</span><span class="s1">))</span>
            <span class="s4"># XXX how are we sure it's always ignored in the innerHTML case?</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">endTagTr(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if not </span><span class="s1">self.ignoreEndTagTr():</span>
                <span class="s1">self.clearStackToTableRowContext()</span>
                <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inTableBody&quot;</span><span class="s1">]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">endTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">ignoreEndTag = self.ignoreEndTagTr()</span>
            <span class="s1">self.endTagTr(impliedTagToken(</span><span class="s2">&quot;tr&quot;</span><span class="s1">))</span>
            <span class="s4"># Reprocess the current tag if the tr end tag was not ignored</span>
            <span class="s4"># XXX how are we sure it's always ignored in the innerHTML case?</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagTableRowGroup(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagTr(impliedTagToken(</span><span class="s2">&quot;tr&quot;</span><span class="s1">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">endTagIgnore(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-in-table-row&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inTable&quot;</span><span class="s1">].processEndTag(token)</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagTableCell)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagTableOther)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s1">endTagTr)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s1">endTagTable)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagTableRowGroup)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">endTagIgnore)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InCellPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-cell</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s4"># helper</span>
        <span class="s0">def </span><span class="s1">closeCell(self):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagTableCell(impliedTagToken(</span><span class="s2">&quot;td&quot;</span><span class="s1">))</span>
            <span class="s0">elif </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;th&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagTableCell(impliedTagToken(</span><span class="s2">&quot;th&quot;</span><span class="s1">))</span>

        <span class="s4"># the rest</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processEOF()</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processCharacters(token)</span>

        <span class="s0">def </span><span class="s1">startTagTableOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">(self.tree.elementInScope(</span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">) </span><span class="s0">or</span>
                    <span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;th&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">)):</span>
                <span class="s1">self.closeCell()</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">endTagTableCell(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.tree.generateImpliedEndTags(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">])</span>
                <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                    <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-cell-end-tag&quot;</span><span class="s0">,</span>
                                           <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                    <span class="s0">while True</span><span class="s1">:</span>
                        <span class="s1">node = self.tree.openElements.pop()</span>
                        <span class="s0">if </span><span class="s1">node.name == token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                            <span class="s0">break</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">self.tree.openElements.pop()</span>
                <span class="s1">self.tree.clearActiveFormattingElements()</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inRow&quot;</span><span class="s1">]</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagIgnore(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagImply(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.closeCell()</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># sometimes innerHTML case</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processEndTag(token)</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s0">,</span>
              <span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagTableOther)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">((</span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagTableCell)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;col&quot;</span><span class="s0">, </span><span class="s2">&quot;colgroup&quot;</span><span class="s0">, </span><span class="s2">&quot;html&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagIgnore)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">endTagImply)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InSelectPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-select</span>
        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;eof-in-select&quot;</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">] == </span><span class="s2">&quot;</span><span class="s0">\u0000</span><span class="s2">&quot;</span><span class="s1">:</span>
                <span class="s0">return</span>
            <span class="s1">self.tree.insertText(token[</span><span class="s2">&quot;data&quot;</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">startTagOption(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># We need to imply &lt;/option&gt; if &lt;option&gt; is the current node.</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;option&quot;</span><span class="s1">:</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagOptgroup(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;option&quot;</span><span class="s1">:</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;optgroup&quot;</span><span class="s1">:</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagSelect(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-select-in-select&quot;</span><span class="s1">)</span>
            <span class="s1">self.endTagSelect(impliedTagToken(</span><span class="s2">&quot;select&quot;</span><span class="s1">))</span>

        <span class="s0">def </span><span class="s1">startTagInput(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-input-in-select&quot;</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;select&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;select&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagSelect(impliedTagToken(</span><span class="s2">&quot;select&quot;</span><span class="s1">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>

        <span class="s0">def </span><span class="s1">startTagScript(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-in-select&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagOption(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;option&quot;</span><span class="s1">:</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-in-select&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;option&quot;</span><span class="s1">})</span>

        <span class="s0">def </span><span class="s1">endTagOptgroup(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># &lt;/optgroup&gt; implicitly closes &lt;option&gt;</span>
            <span class="s0">if </span><span class="s1">(self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;option&quot; </span><span class="s0">and</span>
                    <span class="s1">self.tree.openElements[-</span><span class="s5">2</span><span class="s1">].name == </span><span class="s2">&quot;optgroup&quot;</span><span class="s1">):</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s4"># It also closes &lt;/optgroup&gt;</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;optgroup&quot;</span><span class="s1">:</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s4"># But nothing else</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-in-select&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;optgroup&quot;</span><span class="s1">})</span>

        <span class="s0">def </span><span class="s1">endTagSelect(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(</span><span class="s2">&quot;select&quot;</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;select&quot;</span><span class="s1">):</span>
                <span class="s1">node = self.tree.openElements.pop()</span>
                <span class="s0">while </span><span class="s1">node.name != </span><span class="s2">&quot;select&quot;</span><span class="s1">:</span>
                    <span class="s1">node = self.tree.openElements.pop()</span>
                <span class="s1">self.parser.resetInsertionMode()</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>
                <span class="s1">self.parser.parseError()</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-in-select&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;option&quot;</span><span class="s0">, </span><span class="s1">startTagOption)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;optgroup&quot;</span><span class="s0">, </span><span class="s1">startTagOptgroup)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;select&quot;</span><span class="s0">, </span><span class="s1">startTagSelect)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s2">&quot;input&quot;</span><span class="s0">, </span><span class="s2">&quot;keygen&quot;</span><span class="s0">, </span><span class="s2">&quot;textarea&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">startTagInput)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;script&quot;</span><span class="s0">, </span><span class="s1">startTagScript)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;option&quot;</span><span class="s0">, </span><span class="s1">endTagOption)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;optgroup&quot;</span><span class="s0">, </span><span class="s1">endTagOptgroup)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;select&quot;</span><span class="s0">, </span><span class="s1">endTagSelect)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InSelectInTablePhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s1">self.parser.phases[</span><span class="s2">&quot;inSelect&quot;</span><span class="s1">].processEOF()</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inSelect&quot;</span><span class="s1">].processCharacters(token)</span>

        <span class="s0">def </span><span class="s1">startTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-table-element-start-tag-in-select-in-table&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.endTagOther(impliedTagToken(</span><span class="s2">&quot;select&quot;</span><span class="s1">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inSelect&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">endTagTable(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-table-element-end-tag-in-select-in-table&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s0">if </span><span class="s1">self.tree.elementInScope(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">variant=</span><span class="s2">&quot;table&quot;</span><span class="s1">):</span>
                <span class="s1">self.endTagOther(impliedTagToken(</span><span class="s2">&quot;select&quot;</span><span class="s1">))</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inSelect&quot;</span><span class="s1">].processEndTag(token)</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">((</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">startTagTable)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">((</span><span class="s2">&quot;caption&quot;</span><span class="s0">, </span><span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s2">&quot;tbody&quot;</span><span class="s0">, </span><span class="s2">&quot;tfoot&quot;</span><span class="s0">, </span><span class="s2">&quot;thead&quot;</span><span class="s0">, </span><span class="s2">&quot;tr&quot;</span><span class="s0">, </span><span class="s2">&quot;td&quot;</span><span class="s0">, </span><span class="s2">&quot;th&quot;</span><span class="s1">)</span><span class="s0">,</span>
             <span class="s1">endTagTable)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InForeignContentPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s1">breakoutElements = frozenset([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;big&quot;</span><span class="s0">, </span><span class="s2">&quot;blockquote&quot;</span><span class="s0">, </span><span class="s2">&quot;body&quot;</span><span class="s0">, </span><span class="s2">&quot;br&quot;</span><span class="s0">,</span>
                                      <span class="s2">&quot;center&quot;</span><span class="s0">, </span><span class="s2">&quot;code&quot;</span><span class="s0">, </span><span class="s2">&quot;dd&quot;</span><span class="s0">, </span><span class="s2">&quot;div&quot;</span><span class="s0">, </span><span class="s2">&quot;dl&quot;</span><span class="s0">, </span><span class="s2">&quot;dt&quot;</span><span class="s0">,</span>
                                      <span class="s2">&quot;em&quot;</span><span class="s0">, </span><span class="s2">&quot;embed&quot;</span><span class="s0">, </span><span class="s2">&quot;h1&quot;</span><span class="s0">, </span><span class="s2">&quot;h2&quot;</span><span class="s0">, </span><span class="s2">&quot;h3&quot;</span><span class="s0">,</span>
                                      <span class="s2">&quot;h4&quot;</span><span class="s0">, </span><span class="s2">&quot;h5&quot;</span><span class="s0">, </span><span class="s2">&quot;h6&quot;</span><span class="s0">, </span><span class="s2">&quot;head&quot;</span><span class="s0">, </span><span class="s2">&quot;hr&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s2">&quot;img&quot;</span><span class="s0">,</span>
                                      <span class="s2">&quot;li&quot;</span><span class="s0">, </span><span class="s2">&quot;listing&quot;</span><span class="s0">, </span><span class="s2">&quot;menu&quot;</span><span class="s0">, </span><span class="s2">&quot;meta&quot;</span><span class="s0">, </span><span class="s2">&quot;nobr&quot;</span><span class="s0">,</span>
                                      <span class="s2">&quot;ol&quot;</span><span class="s0">, </span><span class="s2">&quot;p&quot;</span><span class="s0">, </span><span class="s2">&quot;pre&quot;</span><span class="s0">, </span><span class="s2">&quot;ruby&quot;</span><span class="s0">, </span><span class="s2">&quot;s&quot;</span><span class="s0">, </span><span class="s2">&quot;small&quot;</span><span class="s0">,</span>
                                      <span class="s2">&quot;span&quot;</span><span class="s0">, </span><span class="s2">&quot;strong&quot;</span><span class="s0">, </span><span class="s2">&quot;strike&quot;</span><span class="s0">, </span><span class="s2">&quot;sub&quot;</span><span class="s0">, </span><span class="s2">&quot;sup&quot;</span><span class="s0">,</span>
                                      <span class="s2">&quot;table&quot;</span><span class="s0">, </span><span class="s2">&quot;tt&quot;</span><span class="s0">, </span><span class="s2">&quot;u&quot;</span><span class="s0">, </span><span class="s2">&quot;ul&quot;</span><span class="s0">, </span><span class="s2">&quot;var&quot;</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">adjustSVGTagNames(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">replacements = {</span><span class="s2">&quot;altglyph&quot;</span><span class="s1">: </span><span class="s2">&quot;altGlyph&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;altglyphdef&quot;</span><span class="s1">: </span><span class="s2">&quot;altGlyphDef&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;altglyphitem&quot;</span><span class="s1">: </span><span class="s2">&quot;altGlyphItem&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;animatecolor&quot;</span><span class="s1">: </span><span class="s2">&quot;animateColor&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;animatemotion&quot;</span><span class="s1">: </span><span class="s2">&quot;animateMotion&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;animatetransform&quot;</span><span class="s1">: </span><span class="s2">&quot;animateTransform&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;clippath&quot;</span><span class="s1">: </span><span class="s2">&quot;clipPath&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;feblend&quot;</span><span class="s1">: </span><span class="s2">&quot;feBlend&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fecolormatrix&quot;</span><span class="s1">: </span><span class="s2">&quot;feColorMatrix&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fecomponenttransfer&quot;</span><span class="s1">: </span><span class="s2">&quot;feComponentTransfer&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fecomposite&quot;</span><span class="s1">: </span><span class="s2">&quot;feComposite&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;feconvolvematrix&quot;</span><span class="s1">: </span><span class="s2">&quot;feConvolveMatrix&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fediffuselighting&quot;</span><span class="s1">: </span><span class="s2">&quot;feDiffuseLighting&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fedisplacementmap&quot;</span><span class="s1">: </span><span class="s2">&quot;feDisplacementMap&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fedistantlight&quot;</span><span class="s1">: </span><span class="s2">&quot;feDistantLight&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;feflood&quot;</span><span class="s1">: </span><span class="s2">&quot;feFlood&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fefunca&quot;</span><span class="s1">: </span><span class="s2">&quot;feFuncA&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fefuncb&quot;</span><span class="s1">: </span><span class="s2">&quot;feFuncB&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fefuncg&quot;</span><span class="s1">: </span><span class="s2">&quot;feFuncG&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fefuncr&quot;</span><span class="s1">: </span><span class="s2">&quot;feFuncR&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fegaussianblur&quot;</span><span class="s1">: </span><span class="s2">&quot;feGaussianBlur&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;feimage&quot;</span><span class="s1">: </span><span class="s2">&quot;feImage&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;femerge&quot;</span><span class="s1">: </span><span class="s2">&quot;feMerge&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;femergenode&quot;</span><span class="s1">: </span><span class="s2">&quot;feMergeNode&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;femorphology&quot;</span><span class="s1">: </span><span class="s2">&quot;feMorphology&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;feoffset&quot;</span><span class="s1">: </span><span class="s2">&quot;feOffset&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fepointlight&quot;</span><span class="s1">: </span><span class="s2">&quot;fePointLight&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fespecularlighting&quot;</span><span class="s1">: </span><span class="s2">&quot;feSpecularLighting&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fespotlight&quot;</span><span class="s1">: </span><span class="s2">&quot;feSpotLight&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;fetile&quot;</span><span class="s1">: </span><span class="s2">&quot;feTile&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;feturbulence&quot;</span><span class="s1">: </span><span class="s2">&quot;feTurbulence&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;foreignobject&quot;</span><span class="s1">: </span><span class="s2">&quot;foreignObject&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;glyphref&quot;</span><span class="s1">: </span><span class="s2">&quot;glyphRef&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;lineargradient&quot;</span><span class="s1">: </span><span class="s2">&quot;linearGradient&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;radialgradient&quot;</span><span class="s1">: </span><span class="s2">&quot;radialGradient&quot;</span><span class="s0">,</span>
                            <span class="s2">&quot;textpath&quot;</span><span class="s1">: </span><span class="s2">&quot;textPath&quot;</span><span class="s1">}</span>

            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] </span><span class="s0">in </span><span class="s1">replacements:</span>
                <span class="s1">token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] = replacements[token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]]</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">] == </span><span class="s2">&quot;</span><span class="s0">\u0000</span><span class="s2">&quot;</span><span class="s1">:</span>
                <span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">] = </span><span class="s2">&quot;</span><span class="s0">\uFFFD</span><span class="s2">&quot;</span>
            <span class="s0">elif </span><span class="s1">(self.parser.framesetOK </span><span class="s0">and</span>
                  <span class="s1">any(char </span><span class="s0">not in </span><span class="s1">spaceCharacters </span><span class="s0">for </span><span class="s1">char </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">&quot;data&quot;</span><span class="s1">])):</span>
                <span class="s1">self.parser.framesetOK = </span><span class="s0">False</span>
            <span class="s1">Phase.processCharacters(self</span><span class="s0">, </span><span class="s1">token)</span>

        <span class="s0">def </span><span class="s1">processStartTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">currentNode = self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s0">if </span><span class="s1">(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] </span><span class="s0">in </span><span class="s1">self.breakoutElements </span><span class="s0">or</span>
                <span class="s1">(token[</span><span class="s2">&quot;name&quot;</span><span class="s1">] == </span><span class="s2">&quot;font&quot; </span><span class="s0">and</span>
                 <span class="s1">set(token[</span><span class="s2">&quot;data&quot;</span><span class="s1">].keys()) &amp; {</span><span class="s2">&quot;color&quot;</span><span class="s0">, </span><span class="s2">&quot;face&quot;</span><span class="s0">, </span><span class="s2">&quot;size&quot;</span><span class="s1">})):</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-html-element-in-foreign-content&quot;</span><span class="s0">,</span>
                                       <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
                <span class="s0">while </span><span class="s1">(self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].namespace !=</span>
                       <span class="s1">self.tree.defaultNamespace </span><span class="s0">and</span>
                       <span class="s0">not </span><span class="s1">self.parser.isHTMLIntegrationPoint(self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]) </span><span class="s0">and</span>
                       <span class="s0">not </span><span class="s1">self.parser.isMathMLTextIntegrationPoint(self.tree.openElements[-</span><span class="s5">1</span><span class="s1">])):</span>
                    <span class="s1">self.tree.openElements.pop()</span>
                <span class="s0">return </span><span class="s1">token</span>

            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">currentNode.namespace == namespaces[</span><span class="s2">&quot;mathml&quot;</span><span class="s1">]:</span>
                    <span class="s1">self.parser.adjustMathMLAttributes(token)</span>
                <span class="s0">elif </span><span class="s1">currentNode.namespace == namespaces[</span><span class="s2">&quot;svg&quot;</span><span class="s1">]:</span>
                    <span class="s1">self.adjustSVGTagNames(token)</span>
                    <span class="s1">self.parser.adjustSVGAttributes(token)</span>
                <span class="s1">self.parser.adjustForeignAttributes(token)</span>
                <span class="s1">token[</span><span class="s2">&quot;namespace&quot;</span><span class="s1">] = currentNode.namespace</span>
                <span class="s1">self.tree.insertElement(token)</span>
                <span class="s0">if </span><span class="s1">token[</span><span class="s2">&quot;selfClosing&quot;</span><span class="s1">]:</span>
                    <span class="s1">self.tree.openElements.pop()</span>
                    <span class="s1">token[</span><span class="s2">&quot;selfClosingAcknowledged&quot;</span><span class="s1">] = </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">processEndTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">nodeIndex = len(self.tree.openElements) - </span><span class="s5">1</span>
            <span class="s1">node = self.tree.openElements[-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s0">if </span><span class="s1">node.name.translate(asciiUpper2Lower) != token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

            <span class="s0">while True</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">node.name.translate(asciiUpper2Lower) == token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]:</span>
                    <span class="s4"># XXX this isn't in the spec but it seems necessary</span>
                    <span class="s0">if </span><span class="s1">self.parser.phase == self.parser.phases[</span><span class="s2">&quot;inTableText&quot;</span><span class="s1">]:</span>
                        <span class="s1">self.parser.phase.flushCharacters()</span>
                        <span class="s1">self.parser.phase = self.parser.phase.originalPhase</span>
                    <span class="s0">while </span><span class="s1">self.tree.openElements.pop() != node:</span>
                        <span class="s0">assert </span><span class="s1">self.tree.openElements</span>
                    <span class="s1">new_token = </span><span class="s0">None</span>
                    <span class="s0">break</span>
                <span class="s1">nodeIndex -= </span><span class="s5">1</span>

                <span class="s1">node = self.tree.openElements[nodeIndex]</span>
                <span class="s0">if </span><span class="s1">node.namespace != self.tree.defaultNamespace:</span>
                    <span class="s0">continue</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">new_token = self.parser.phase.processEndTag(token)</span>
                    <span class="s0">break</span>
            <span class="s0">return </span><span class="s1">new_token</span>

    <span class="s0">class </span><span class="s1">AfterBodyPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s4"># Stop parsing</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s4"># This is needed because data is to be appended to the &lt;html&gt; element</span>
            <span class="s4"># here and not to whatever is currently open.</span>
            <span class="s1">self.tree.insertComment(token</span><span class="s0">, </span><span class="s1">self.tree.openElements[</span><span class="s5">0</span><span class="s1">])</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-char-after-body&quot;</span><span class="s1">)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-after-body&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagHtml(self</span><span class="s0">, </span><span class="s1">name):</span>
            <span class="s0">if </span><span class="s1">self.parser.innerHTML:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-after-body-innerhtml&quot;</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;afterAfterBody&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-after-body&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">startTagHtml)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">endTagHtml)])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">InFramesetPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#in-frameset</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;eof-in-frameset&quot;</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">self.parser.innerHTML</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-char-in-frameset&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagFrameset(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>

        <span class="s0">def </span><span class="s1">startTagFrame(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertElement(token)</span>
            <span class="s1">self.tree.openElements.pop()</span>

        <span class="s0">def </span><span class="s1">startTagNoframes(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-in-frameset&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagFrameset(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">if </span><span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name == </span><span class="s2">&quot;html&quot;</span><span class="s1">:</span>
                <span class="s4"># innerHTML case</span>
                <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-frameset-in-frameset-innerhtml&quot;</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.tree.openElements.pop()</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">not </span><span class="s1">self.parser.innerHTML </span><span class="s0">and</span>
                    <span class="s1">self.tree.openElements[-</span><span class="s5">1</span><span class="s1">].name != </span><span class="s2">&quot;frameset&quot;</span><span class="s1">):</span>
                <span class="s4"># If we're not in innerHTML mode and the current node is not a</span>
                <span class="s4"># &quot;frameset&quot; element (anymore) then switch.</span>
                <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;afterFrameset&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-in-frameset&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;frameset&quot;</span><span class="s0">, </span><span class="s1">startTagFrameset)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;frame&quot;</span><span class="s0">, </span><span class="s1">startTagFrame)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;noframes&quot;</span><span class="s0">, </span><span class="s1">startTagNoframes)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;frameset&quot;</span><span class="s0">, </span><span class="s1">endTagFrameset)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">AfterFramesetPhase(Phase):</span>
        <span class="s4"># http://www.whatwg.org/specs/web-apps/current-work/#after3</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s4"># Stop parsing</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-char-after-frameset&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagNoframes(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-start-tag-after-frameset&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">endTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;afterAfterFrameset&quot;</span><span class="s1">]</span>

        <span class="s0">def </span><span class="s1">endTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;unexpected-end-tag-after-frameset&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">Phase.startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;noframes&quot;</span><span class="s0">, </span><span class="s1">startTagNoframes)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

        <span class="s1">endTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">endTagHtml)</span>
        <span class="s1">])</span>
        <span class="s1">endTagHandler.default = endTagOther</span>

    <span class="s0">class </span><span class="s1">AfterAfterBodyPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertComment(token</span><span class="s0">, </span><span class="s1">self.tree.document)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processSpaceCharacters(token)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-eof-but-got-char&quot;</span><span class="s1">)</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-eof-but-got-start-tag&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-eof-but-got-end-tag&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>
            <span class="s1">self.parser.phase = self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">startTagHtml)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

    <span class="s0">class </span><span class="s1">AfterAfterFramesetPhase(Phase):</span>
        <span class="s1">__slots__ = tuple()</span>

        <span class="s0">def </span><span class="s1">processEOF(self):</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.tree.insertComment(token</span><span class="s0">, </span><span class="s1">self.tree.document)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processSpaceCharacters(token)</span>

        <span class="s0">def </span><span class="s1">processCharacters(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-eof-but-got-char&quot;</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">startTagHtml(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inBody&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagNoFrames(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s0">return </span><span class="s1">self.parser.phases[</span><span class="s2">&quot;inHead&quot;</span><span class="s1">].processStartTag(token)</span>

        <span class="s0">def </span><span class="s1">startTagOther(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-eof-but-got-start-tag&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s0">def </span><span class="s1">processEndTag(self</span><span class="s0">, </span><span class="s1">token):</span>
            <span class="s1">self.parser.parseError(</span><span class="s2">&quot;expected-eof-but-got-end-tag&quot;</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s2">&quot;name&quot;</span><span class="s1">: token[</span><span class="s2">&quot;name&quot;</span><span class="s1">]})</span>

        <span class="s1">startTagHandler = _utils.MethodDispatcher([</span>
            <span class="s1">(</span><span class="s2">&quot;html&quot;</span><span class="s0">, </span><span class="s1">startTagHtml)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;noframes&quot;</span><span class="s0">, </span><span class="s1">startTagNoFrames)</span>
        <span class="s1">])</span>
        <span class="s1">startTagHandler.default = startTagOther</span>

    <span class="s4"># pylint:enable=unused-argument</span>

    <span class="s0">return </span><span class="s1">{</span>
        <span class="s2">&quot;initial&quot;</span><span class="s1">: InitialPhase</span><span class="s0">,</span>
        <span class="s2">&quot;beforeHtml&quot;</span><span class="s1">: BeforeHtmlPhase</span><span class="s0">,</span>
        <span class="s2">&quot;beforeHead&quot;</span><span class="s1">: BeforeHeadPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inHead&quot;</span><span class="s1">: InHeadPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inHeadNoscript&quot;</span><span class="s1">: InHeadNoscriptPhase</span><span class="s0">,</span>
        <span class="s2">&quot;afterHead&quot;</span><span class="s1">: AfterHeadPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inBody&quot;</span><span class="s1">: InBodyPhase</span><span class="s0">,</span>
        <span class="s2">&quot;text&quot;</span><span class="s1">: TextPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inTable&quot;</span><span class="s1">: InTablePhase</span><span class="s0">,</span>
        <span class="s2">&quot;inTableText&quot;</span><span class="s1">: InTableTextPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inCaption&quot;</span><span class="s1">: InCaptionPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inColumnGroup&quot;</span><span class="s1">: InColumnGroupPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inTableBody&quot;</span><span class="s1">: InTableBodyPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inRow&quot;</span><span class="s1">: InRowPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inCell&quot;</span><span class="s1">: InCellPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inSelect&quot;</span><span class="s1">: InSelectPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inSelectInTable&quot;</span><span class="s1">: InSelectInTablePhase</span><span class="s0">,</span>
        <span class="s2">&quot;inForeignContent&quot;</span><span class="s1">: InForeignContentPhase</span><span class="s0">,</span>
        <span class="s2">&quot;afterBody&quot;</span><span class="s1">: AfterBodyPhase</span><span class="s0">,</span>
        <span class="s2">&quot;inFrameset&quot;</span><span class="s1">: InFramesetPhase</span><span class="s0">,</span>
        <span class="s2">&quot;afterFrameset&quot;</span><span class="s1">: AfterFramesetPhase</span><span class="s0">,</span>
        <span class="s2">&quot;afterAfterBody&quot;</span><span class="s1">: AfterAfterBodyPhase</span><span class="s0">,</span>
        <span class="s2">&quot;afterAfterFrameset&quot;</span><span class="s1">: AfterAfterFramesetPhase</span><span class="s0">,</span>
        <span class="s4"># XXX after after frameset</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">adjust_attributes(token</span><span class="s0">, </span><span class="s1">replacements):</span>
    <span class="s1">needs_adjustment = viewkeys(token[</span><span class="s2">'data'</span><span class="s1">]) &amp; viewkeys(replacements)</span>
    <span class="s0">if </span><span class="s1">needs_adjustment:</span>
        <span class="s1">token[</span><span class="s2">'data'</span><span class="s1">] = type(token[</span><span class="s2">'data'</span><span class="s1">])((replacements.get(k</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">v)</span>
                                            <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">token[</span><span class="s2">'data'</span><span class="s1">].items())</span>


<span class="s0">def </span><span class="s1">impliedTagToken(name</span><span class="s0">, </span><span class="s1">type=</span><span class="s2">&quot;EndTag&quot;</span><span class="s0">, </span><span class="s1">attributes=</span><span class="s0">None,</span>
                    <span class="s1">selfClosing=</span><span class="s0">False</span><span class="s1">):</span>
    <span class="s0">if </span><span class="s1">attributes </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">attributes = {}</span>
    <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;type&quot;</span><span class="s1">: tokenTypes[type]</span><span class="s0">, </span><span class="s2">&quot;name&quot;</span><span class="s1">: name</span><span class="s0">, </span><span class="s2">&quot;data&quot;</span><span class="s1">: attributes</span><span class="s0">,</span>
            <span class="s2">&quot;selfClosing&quot;</span><span class="s1">: selfClosing}</span>


<span class="s0">class </span><span class="s1">ParseError(Exception):</span>
    <span class="s3">&quot;&quot;&quot;Error in parsed document&quot;&quot;&quot;</span>
    <span class="s0">pass</span>
</pre>
</body>
</html>