<html>
<head>
<title>test_query_eval.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_query_eval.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">operator</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas.util._test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.computation.check </span><span class="s0">import </span><span class="s1">NUMEXPR_INSTALLED</span>

<span class="s1">PARSERS = </span><span class="s2">&quot;python&quot;</span><span class="s0">, </span><span class="s2">&quot;pandas&quot;</span>
<span class="s1">ENGINES = </span><span class="s2">&quot;python&quot;</span><span class="s0">, </span><span class="s1">pytest.param(</span><span class="s2">&quot;numexpr&quot;</span><span class="s0">, </span><span class="s1">marks=td.skip_if_no_ne)</span>


<span class="s1">@pytest.fixture(params=PARSERS</span><span class="s0">, </span><span class="s1">ids=</span><span class="s0">lambda </span><span class="s1">x: x)</span>
<span class="s0">def </span><span class="s1">parser(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s1">@pytest.fixture(params=ENGINES</span><span class="s0">, </span><span class="s1">ids=</span><span class="s0">lambda </span><span class="s1">x: x)</span>
<span class="s0">def </span><span class="s1">engine(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s0">def </span><span class="s1">skip_if_no_pandas_parser(parser):</span>
    <span class="s0">if </span><span class="s1">parser != </span><span class="s2">&quot;pandas&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.skip(</span><span class="s2">f&quot;cannot evaluate with parser </span><span class="s0">{</span><span class="s1">repr(parser)</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestCompat:</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s1">self.df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
        <span class="s1">self.expected1 = self.df[self.df.A &gt; </span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">self.expected2 = self.df.A + </span><span class="s3">1</span>

    <span class="s0">def </span><span class="s1">test_query_default(self):</span>

        <span class="s4"># GH 12749</span>
        <span class="s4"># this should always work, whether NUMEXPR_INSTALLED or not</span>
        <span class="s1">df = self.df</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;A&gt;0&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">self.expected1)</span>
        <span class="s1">result = df.eval(</span><span class="s2">&quot;A+1&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">self.expected2</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_query_None(self):</span>

        <span class="s1">df = self.df</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;A&gt;0&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">self.expected1)</span>
        <span class="s1">result = df.eval(</span><span class="s2">&quot;A+1&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">self.expected2</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_query_python(self):</span>

        <span class="s1">df = self.df</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;A&gt;0&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;python&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">self.expected1)</span>
        <span class="s1">result = df.eval(</span><span class="s2">&quot;A+1&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;python&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">self.expected2</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_query_numexpr(self):</span>

        <span class="s1">df = self.df</span>
        <span class="s0">if </span><span class="s1">NUMEXPR_INSTALLED:</span>
            <span class="s1">result = df.query(</span><span class="s2">&quot;A&gt;0&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;numexpr&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">self.expected1)</span>
            <span class="s1">result = df.eval(</span><span class="s2">&quot;A+1&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;numexpr&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">self.expected2</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">msg = (</span>
                <span class="s2">r&quot;'numexpr' is not installed or an unsupported version. &quot;</span>
                <span class="s2">r&quot;Cannot use engine='numexpr' for query/eval if 'numexpr' is &quot;</span>
                <span class="s2">r&quot;not installed&quot;</span>
            <span class="s1">)</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ImportError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">df.query(</span><span class="s2">&quot;A&gt;0&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;numexpr&quot;</span><span class="s1">)</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ImportError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">df.eval(</span><span class="s2">&quot;A+1&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;numexpr&quot;</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameEval:</span>

    <span class="s4"># smaller hits python, larger hits numexpr</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4000</span><span class="s1">])</span>
    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;op_str,op,rop&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;+&quot;</span><span class="s0">, </span><span class="s2">&quot;__add__&quot;</span><span class="s0">, </span><span class="s2">&quot;__radd__&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;-&quot;</span><span class="s0">, </span><span class="s2">&quot;__sub__&quot;</span><span class="s0">, </span><span class="s2">&quot;__rsub__&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;*&quot;</span><span class="s0">, </span><span class="s2">&quot;__mul__&quot;</span><span class="s0">, </span><span class="s2">&quot;__rmul__&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;/&quot;</span><span class="s0">, </span><span class="s2">&quot;__truediv__&quot;</span><span class="s0">, </span><span class="s2">&quot;__rtruediv__&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_ops(self</span><span class="s0">, </span><span class="s1">op_str</span><span class="s0">, </span><span class="s1">op</span><span class="s0">, </span><span class="s1">rop</span><span class="s0">, </span><span class="s1">n):</span>

        <span class="s4"># tst ops and reversed ops in evaluation</span>
        <span class="s4"># GH7198</span>

        <span class="s1">df = DataFrame(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">index=range(n)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abcd&quot;</span><span class="s1">))</span>
        <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">2</span>
        <span class="s1">m = df.mean()</span>

        <span class="s1">base = DataFrame(  </span><span class="s4"># noqa:F841</span>
            <span class="s1">np.tile(m.values</span><span class="s0">, </span><span class="s1">n).reshape(n</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abcd&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s1">expected = eval(</span><span class="s2">f&quot;base </span><span class="s0">{</span><span class="s1">op_str</span><span class="s0">} </span><span class="s2">df&quot;</span><span class="s1">)</span>

        <span class="s4"># ops as strings</span>
        <span class="s1">result = eval(</span><span class="s2">f&quot;m </span><span class="s0">{</span><span class="s1">op_str</span><span class="s0">} </span><span class="s2">df&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># these are commutative</span>
        <span class="s0">if </span><span class="s1">op </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;+&quot;</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">]:</span>
            <span class="s1">result = getattr(df</span><span class="s0">, </span><span class="s1">op)(m)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># these are not</span>
        <span class="s0">elif </span><span class="s1">op </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;-&quot;</span><span class="s0">, </span><span class="s2">&quot;/&quot;</span><span class="s1">]:</span>
            <span class="s1">result = getattr(df</span><span class="s0">, </span><span class="s1">rop)(m)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_dataframe_sub_numexpr_path(self):</span>
        <span class="s4"># GH7192: Note we need a large number of rows to ensure this</span>
        <span class="s4">#  goes through the numexpr path</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: np.random.randn(</span><span class="s3">25000</span><span class="s1">)})</span>
        <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">5</span><span class="s1">] = np.nan</span>
        <span class="s1">expected = </span><span class="s3">1 </span><span class="s1">- np.isnan(df.iloc[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">25</span><span class="s1">])</span>
        <span class="s1">result = (</span><span class="s3">1 </span><span class="s1">- np.isnan(df)).iloc[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">25</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_query_non_str(self):</span>
        <span class="s4"># GH 11485</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]})</span>

        <span class="s1">msg = </span><span class="s2">&quot;expr must be a string to be evaluated&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s0">lambda </span><span class="s1">x: x.B == </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s3">111</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_query_empty_string(self):</span>
        <span class="s4"># GH 13139</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>

        <span class="s1">msg = </span><span class="s2">&quot;expr cannot be an empty string&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_eval_resolvers_as_list(self):</span>
        <span class="s4"># GH 14095</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;ab&quot;</span><span class="s1">))</span>
        <span class="s1">dict1 = {</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span>
        <span class="s1">dict2 = {</span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span>
        <span class="s0">assert </span><span class="s1">df.eval(</span><span class="s2">&quot;a + b&quot;</span><span class="s0">, </span><span class="s1">resolvers=[dict1</span><span class="s0">, </span><span class="s1">dict2]) == dict1[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + dict2[</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">pd.eval(</span><span class="s2">&quot;a + b&quot;</span><span class="s0">, </span><span class="s1">resolvers=[dict1</span><span class="s0">, </span><span class="s1">dict2]) == dict1[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + dict2[</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_eval_resolvers_combined(self):</span>
        <span class="s4"># GH 34966</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;ab&quot;</span><span class="s1">))</span>
        <span class="s1">dict1 = {</span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span>

        <span class="s4"># Both input and default index/column resolvers should be usable</span>
        <span class="s1">result = df.eval(</span><span class="s2">&quot;a + b * c&quot;</span><span class="s0">, </span><span class="s1">resolvers=[dict1])</span>

        <span class="s1">expected = df[</span><span class="s2">&quot;a&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;b&quot;</span><span class="s1">] * dict1[</span><span class="s2">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_eval_object_dtype_binop(self):</span>
        <span class="s4"># GH#24883</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a1&quot;</span><span class="s1">: [</span><span class="s2">&quot;Y&quot;</span><span class="s0">, </span><span class="s2">&quot;N&quot;</span><span class="s1">]})</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;c = ((a1 == 'Y') &amp; True)&quot;</span><span class="s1">)</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a1&quot;</span><span class="s1">: [</span><span class="s2">&quot;Y&quot;</span><span class="s0">, </span><span class="s2">&quot;N&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s0">True, False</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryWithMultiIndex:</span>
    <span class="s0">def </span><span class="s1">test_query_with_named_multiindex(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">a = np.random.choice([</span><span class="s2">&quot;red&quot;</span><span class="s0">, </span><span class="s2">&quot;green&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">b = np.random.choice([</span><span class="s2">&quot;eggs&quot;</span><span class="s0">, </span><span class="s2">&quot;ham&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">index = MultiIndex.from_arrays([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;color&quot;</span><span class="s0">, </span><span class="s2">&quot;food&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">ind = Series(</span>
            <span class="s1">df.index.get_level_values(</span><span class="s2">&quot;color&quot;</span><span class="s1">).values</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;color&quot;</span>
        <span class="s1">)</span>

        <span class="s4"># equality</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'color == &quot;red&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; == color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind == </span><span class="s2">&quot;red&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># inequality</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'color != &quot;red&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; != color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind != </span><span class="s2">&quot;red&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># list equality (really just set membership)</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'color == [&quot;red&quot;]'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'[&quot;red&quot;] == color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res1 = df.query(</span><span class="s2">'color != [&quot;red&quot;]'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'[&quot;red&quot;] != color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[~ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># in/not in ops</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'[&quot;red&quot;] in color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; in color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res1 = df.query(</span><span class="s2">'[&quot;red&quot;] not in color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; not in color'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[~ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_query_with_unnamed_multiindex(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">a = np.random.choice([</span><span class="s2">&quot;red&quot;</span><span class="s0">, </span><span class="s2">&quot;green&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">b = np.random.choice([</span><span class="s2">&quot;eggs&quot;</span><span class="s0">, </span><span class="s2">&quot;ham&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">index = MultiIndex.from_arrays([a</span><span class="s0">, </span><span class="s1">b])</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">ind = Series(df.index.get_level_values(</span><span class="s3">0</span><span class="s1">).values</span><span class="s0">, </span><span class="s1">index=index)</span>

        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_0 == &quot;red&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; == ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind == </span><span class="s2">&quot;red&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># inequality</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_0 != &quot;red&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; != ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind != </span><span class="s2">&quot;red&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># list equality (really just set membership)</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_0 == [&quot;red&quot;]'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'[&quot;red&quot;] == ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_0 != [&quot;red&quot;]'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'[&quot;red&quot;] != ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[~ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># in/not in ops</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'[&quot;red&quot;] in ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; in ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res1 = df.query(</span><span class="s2">'[&quot;red&quot;] not in ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;red&quot; not in ilevel_0'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[~ind.isin([</span><span class="s2">&quot;red&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># ## LEVEL 1</span>
        <span class="s1">ind = Series(df.index.get_level_values(</span><span class="s3">1</span><span class="s1">).values</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_1 == &quot;eggs&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;eggs&quot; == ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind == </span><span class="s2">&quot;eggs&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># inequality</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_1 != &quot;eggs&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;eggs&quot; != ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind != </span><span class="s2">&quot;eggs&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># list equality (really just set membership)</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_1 == [&quot;eggs&quot;]'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'[&quot;eggs&quot;] == ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind.isin([</span><span class="s2">&quot;eggs&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res1 = df.query(</span><span class="s2">'ilevel_1 != [&quot;eggs&quot;]'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'[&quot;eggs&quot;] != ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[~ind.isin([</span><span class="s2">&quot;eggs&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s4"># in/not in ops</span>
        <span class="s1">res1 = df.query(</span><span class="s2">'[&quot;eggs&quot;] in ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;eggs&quot; in ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[ind.isin([</span><span class="s2">&quot;eggs&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res1 = df.query(</span><span class="s2">'[&quot;eggs&quot;] not in ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">res2 = df.query(</span><span class="s2">'&quot;eggs&quot; not in ilevel_1'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[~ind.isin([</span><span class="s2">&quot;eggs&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res1</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_frame_equal(res2</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_query_with_partially_named_multiindex(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">a = np.random.choice([</span><span class="s2">&quot;red&quot;</span><span class="s0">, </span><span class="s2">&quot;green&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">b = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">index = MultiIndex.from_arrays([a</span><span class="s0">, </span><span class="s1">b])</span>
        <span class="s1">index.names = [</span><span class="s0">None, </span><span class="s2">&quot;rating&quot;</span><span class="s1">]</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;rating == 1&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">ind = Series(</span>
            <span class="s1">df.index.get_level_values(</span><span class="s2">&quot;rating&quot;</span><span class="s1">).values</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;rating&quot;</span>
        <span class="s1">)</span>
        <span class="s1">exp = df[ind == </span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res = df.query(</span><span class="s2">&quot;rating != 1&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">ind = Series(</span>
            <span class="s1">df.index.get_level_values(</span><span class="s2">&quot;rating&quot;</span><span class="s1">).values</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;rating&quot;</span>
        <span class="s1">)</span>
        <span class="s1">exp = df[ind != </span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res = df.query(</span><span class="s2">'ilevel_0 == &quot;red&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">ind = Series(df.index.get_level_values(</span><span class="s3">0</span><span class="s1">).values</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">exp = df[ind == </span><span class="s2">&quot;red&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res = df.query(</span><span class="s2">'ilevel_0 != &quot;red&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">ind = Series(df.index.get_level_values(</span><span class="s3">0</span><span class="s1">).values</span><span class="s0">, </span><span class="s1">index=index)</span>
        <span class="s1">exp = df[ind != </span><span class="s2">&quot;red&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_query_multiindex_get_index_resolvers(self):</span>
        <span class="s1">df = tm.makeCustomDataframe(</span>
            <span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">r_idx_nlevels=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">r_idx_names=[</span><span class="s2">&quot;spam&quot;</span><span class="s0">, </span><span class="s2">&quot;eggs&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">resolvers = df._get_index_resolvers()</span>

        <span class="s0">def </span><span class="s1">to_series(mi</span><span class="s0">, </span><span class="s1">level):</span>
            <span class="s1">level_values = mi.get_level_values(level)</span>
            <span class="s1">s = level_values.to_series()</span>
            <span class="s1">s.index = mi</span>
            <span class="s0">return </span><span class="s1">s</span>

        <span class="s1">col_series = df.columns.to_series()</span>
        <span class="s1">expected = {</span>
            <span class="s2">&quot;index&quot;</span><span class="s1">: df.index</span><span class="s0">,</span>
            <span class="s2">&quot;columns&quot;</span><span class="s1">: col_series</span><span class="s0">,</span>
            <span class="s2">&quot;spam&quot;</span><span class="s1">: to_series(df.index</span><span class="s0">, </span><span class="s2">&quot;spam&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;eggs&quot;</span><span class="s1">: to_series(df.index</span><span class="s0">, </span><span class="s2">&quot;eggs&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;C0&quot;</span><span class="s1">: col_series</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">resolvers.items():</span>
            <span class="s0">if </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">Index):</span>
                <span class="s0">assert </span><span class="s1">v.is_(expected[k])</span>
            <span class="s0">elif </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">Series):</span>
                <span class="s1">tm.assert_series_equal(v</span><span class="s0">, </span><span class="s1">expected[k])</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError(</span><span class="s2">&quot;object must be a Series or Index&quot;</span><span class="s1">)</span>


<span class="s1">@td.skip_if_no_ne</span>
<span class="s0">class </span><span class="s1">TestDataFrameQueryNumExprPandas:</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.engine = </span><span class="s2">&quot;numexpr&quot;</span>
        <span class="s1">cls.parser = </span><span class="s2">&quot;pandas&quot;</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">teardown_class(cls):</span>
        <span class="s0">del </span><span class="s1">cls.engine</span><span class="s0">, </span><span class="s1">cls.parser</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_attribute_access(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates2&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2013&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">res = df.query(</span>
            <span class="s2">&quot;@df.dates1 &lt; 20130101 &lt; @df.dates3&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">expec = df[(df.dates1 &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_query_no_attribute_access(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates2&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2013&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;dates1 &lt; 20130101 &lt; dates3&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[(df.dates1 &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_NaT(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randn(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates2&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2013&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df.loc[np.random.rand(n) &gt; </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = pd.NaT</span>
        <span class="s1">df.loc[np.random.rand(n) &gt; </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = pd.NaT</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;dates1 &lt; 20130101 &lt; dates3&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[(df.dates1 &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randn(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">return_value = df.set_index(</span><span class="s2">&quot;dates1&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True, </span><span class="s1">drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;index &lt; 20130101 &lt; dates3&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[(df.index &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randn(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = pd.NaT</span>
        <span class="s1">return_value = df.set_index(</span><span class="s2">&quot;dates1&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True, </span><span class="s1">drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;index &lt; 20130101 &lt; dates3&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[(df.index &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT_duplicates(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">d = {}</span>
        <span class="s1">d[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">d[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df = DataFrame(d)</span>
        <span class="s1">df.loc[np.random.rand(n) &gt; </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = pd.NaT</span>
        <span class="s1">return_value = df.set_index(</span><span class="s2">&quot;dates1&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True, </span><span class="s1">drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;dates1 &lt; 20130101 &lt; dates3&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[(df.index.to_series() &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_non_date(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>

        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span><span class="s2">&quot;dates&quot;</span><span class="s1">: date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span><span class="s0">, </span><span class="s2">&quot;nondate&quot;</span><span class="s1">: np.arange(n)}</span>
        <span class="s1">)</span>

        <span class="s1">result = df.query(</span><span class="s2">&quot;dates == nondate&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s0">assert </span><span class="s1">len(result) == </span><span class="s3">0</span>

        <span class="s1">result = df.query(</span><span class="s2">&quot;dates != nondate&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">msg = </span><span class="s2">r&quot;Invalid comparison between dtype=datetime64\[ns\] and ndarray&quot;</span>
        <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;&lt;&quot;</span><span class="s0">, </span><span class="s2">&quot;&gt;&quot;</span><span class="s0">, </span><span class="s2">&quot;&lt;=&quot;</span><span class="s0">, </span><span class="s2">&quot;&gt;=&quot;</span><span class="s1">]:</span>
            <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">df.query(</span><span class="s2">f&quot;dates </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s2">nondate&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>

    <span class="s0">def </span><span class="s1">test_query_syntax_error(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;i&quot;</span><span class="s1">: range(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;+&quot;</span><span class="s1">: range(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;r&quot;</span><span class="s1">: range(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">14</span><span class="s1">)})</span>
        <span class="s1">msg = </span><span class="s2">&quot;invalid syntax&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(SyntaxError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;i - +&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">def </span><span class="s1">test_query_scope(self):</span>
        <span class="s0">from </span><span class="s1">pandas.core.computation.ops </span><span class="s0">import </span><span class="s1">UndefinedVariableError</span>

        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>

        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;ab&quot;</span><span class="s1">))</span>

        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2  </span><span class="s4"># noqa:F841</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;a &gt; b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expected = df[df.a &gt; df.b]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">res = df.query(</span><span class="s2">&quot;@a &gt; b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expected = df[a &gt; df.b]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># no local variable c</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">UndefinedVariableError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;local variable 'c' is not defined&quot;</span>
        <span class="s1">):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;@a &gt; b &gt; @c&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

        <span class="s4"># no column named 'c'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(UndefinedVariableError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;name 'c' is not defined&quot;</span><span class="s1">):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;@a &gt; b &gt; c&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">def </span><span class="s1">test_query_doesnt_pickup_local(self):</span>
        <span class="s0">from </span><span class="s1">pandas.core.computation.ops </span><span class="s0">import </span><span class="s1">UndefinedVariableError</span>

        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = m = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randint(m</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span>

        <span class="s4"># we don't pick up the local 'sin'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(UndefinedVariableError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;name 'sin' is not defined&quot;</span><span class="s1">):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;sin &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">def </span><span class="s1">test_query_builtin(self):</span>
        <span class="s0">from </span><span class="s1">pandas.core.computation.engines </span><span class="s0">import </span><span class="s1">NumExprClobberingError</span>

        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>

        <span class="s1">n = m = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randint(m</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span>

        <span class="s1">df.index.name = </span><span class="s2">&quot;sin&quot;</span>
        <span class="s1">msg = </span><span class="s2">&quot;Variables in expression.+&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(NumExprClobberingError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;sin &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">def </span><span class="s1">test_query(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>

        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df.query(</span><span class="s2">&quot;a &lt; b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span><span class="s0">, </span><span class="s1">df[df.a &lt; df.b]</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(</span>
            <span class="s1">df.query(</span><span class="s2">&quot;a + b &gt; b * c&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span><span class="s0">,</span>
            <span class="s1">df[df.a + df.b &gt; df.b * df.c]</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_query_index_with_name(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randint(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">index=Index(range(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;blob&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;(blob &lt; 5) &amp; (a &lt; b)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[(df.index &lt; </span><span class="s3">5</span><span class="s1">) &amp; (df.a &lt; df.b)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

        <span class="s1">res = df.query(</span><span class="s2">&quot;blob &lt; b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[df.index &lt; df.b]</span>

        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_query_index_without_name(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">np.random.randint(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">index=range(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s4"># &quot;index&quot; should refer to the index</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;index &lt; b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[df.index &lt; df.b]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

        <span class="s4"># test against a scalar</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;index &lt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expec = df[df.index &lt; </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_nested_scope(self):</span>
        <span class="s1">engine = self.engine</span>
        <span class="s1">parser = self.parser</span>

        <span class="s1">skip_if_no_pandas_parser(parser)</span>

        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df2 = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">expected = df[(df &gt; </span><span class="s3">0</span><span class="s1">) &amp; (df2 &gt; </span><span class="s3">0</span><span class="s1">)]</span>

        <span class="s1">result = df.query(</span><span class="s2">&quot;(@df &gt; 0) &amp; (@df2 &gt; 0)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pd.eval(</span><span class="s2">&quot;df[df &gt; 0 and df2 &gt; 0]&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pd.eval(</span>
            <span class="s2">&quot;df[df &gt; 0 and df2 &gt; 0 and df[df &gt; 0] &gt; 0]&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">expected = df[(df &gt; </span><span class="s3">0</span><span class="s1">) &amp; (df2 &gt; </span><span class="s3">0</span><span class="s1">) &amp; (df[df &gt; </span><span class="s3">0</span><span class="s1">] &gt; </span><span class="s3">0</span><span class="s1">)]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = pd.eval(</span><span class="s2">&quot;df[(df&gt;0) &amp; (df2&gt;0)]&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expected = df.query(</span><span class="s2">&quot;(@df&gt;0) &amp; (@df2&gt;0)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_nested_raises_on_local_self_reference(self):</span>
        <span class="s0">from </span><span class="s1">pandas.core.computation.ops </span><span class="s0">import </span><span class="s1">UndefinedVariableError</span>

        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

        <span class="s4"># can't reference ourself b/c we're a local so @ is necessary</span>
        <span class="s0">with </span><span class="s1">pytest.raises(UndefinedVariableError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;name 'df' is not defined&quot;</span><span class="s1">):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;df &gt; 0&quot;</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser)</span>

    <span class="s0">def </span><span class="s1">test_local_syntax(self):</span>
        <span class="s1">skip_if_no_pandas_parser(self.parser)</span>

        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="s1">))</span>
        <span class="s1">b = </span><span class="s3">1</span>
        <span class="s1">expect = df[df.a &lt; b]</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;a &lt; @b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expect)</span>

        <span class="s1">expect = df[df.a &lt; df.b]</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;a &lt; b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_chained_cmp_and_in(self):</span>
        <span class="s1">skip_if_no_pandas_parser(self.parser)</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">cols = list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">len(cols))</span><span class="s0">, </span><span class="s1">columns=cols)</span>
        <span class="s1">res = df.query(</span>
            <span class="s2">&quot;a &lt; b &lt; c and a not in b not in c&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">ind = (df.a &lt; df.b) &amp; (df.b &lt; df.c) &amp; ~df.b.isin(df.a) &amp; ~df.c.isin(df.b)</span>
        <span class="s1">expec = df[ind]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_local_variable_with_in(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">a = Series(np.random.randint(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">b = Series(np.random.randint(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: a</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: b})</span>

        <span class="s1">expected = df.loc[(df.b - </span><span class="s3">1</span><span class="s1">).isin(a)]</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;b - 1 in a&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">b = Series(np.random.randint(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
        <span class="s1">expected = df.loc[(b - </span><span class="s3">1</span><span class="s1">).isin(a)]</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;@b - 1 in a&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s0">def </span><span class="s1">test_at_inside_string(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">c = </span><span class="s3">1  </span><span class="s4"># noqa:F841</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;@c&quot;</span><span class="s0">, </span><span class="s2">&quot;@c&quot;</span><span class="s1">]})</span>
        <span class="s1">result = df.query(</span><span class="s2">'a == &quot;@c&quot;'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expected = df[df.a == </span><span class="s2">&quot;@c&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_query_undefined_local(self):</span>
        <span class="s0">from </span><span class="s1">pandas.core.computation.ops </span><span class="s0">import </span><span class="s1">UndefinedVariableError</span>

        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>

        <span class="s1">df = DataFrame(np.random.rand(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;ab&quot;</span><span class="s1">))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">UndefinedVariableError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;local variable 'c' is not defined&quot;</span>
        <span class="s1">):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;a == @c&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">def </span><span class="s1">test_index_resolvers_come_after_columns_with_the_same_name(self):</span>
        <span class="s1">n = </span><span class="s3">1  </span><span class="s4"># noqa:F841</span>
        <span class="s1">a = np.r_[</span><span class="s3">20</span><span class="s1">:</span><span class="s3">101</span><span class="s1">:</span><span class="s3">20</span><span class="s1">]</span>

        <span class="s1">df = DataFrame({</span><span class="s2">&quot;index&quot;</span><span class="s1">: a</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.random.randn(a.size)})</span>
        <span class="s1">df.index.name = </span><span class="s2">&quot;index&quot;</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;index &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser)</span>
        <span class="s1">expected = df[df[</span><span class="s2">&quot;index&quot;</span><span class="s1">] &gt; </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s2">&quot;index&quot;</span><span class="s1">: a</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.random.randn(a.size)})</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;ilevel_0 &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser)</span>
        <span class="s1">expected = df.loc[df.index[df.index &gt; </span><span class="s3">5</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: a</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.random.randn(a.size)})</span>
        <span class="s1">df.index.name = </span><span class="s2">&quot;a&quot;</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;a &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser)</span>
        <span class="s1">expected = df[df.a &gt; </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = df.query(</span><span class="s2">&quot;index &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser)</span>
        <span class="s1">expected = df.loc[df.index[df.index &gt; </span><span class="s3">5</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_inf(self):</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: np.random.rand(n)</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.random.rand(n)})</span>
        <span class="s1">df.loc[::</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = np.inf</span>
        <span class="s1">d = {</span><span class="s2">&quot;==&quot;</span><span class="s1">: operator.eq</span><span class="s0">, </span><span class="s2">&quot;!=&quot;</span><span class="s1">: operator.ne}</span>
        <span class="s0">for </span><span class="s1">op</span><span class="s0">, </span><span class="s1">f </span><span class="s0">in </span><span class="s1">d.items():</span>
            <span class="s1">q = </span><span class="s2">f&quot;a </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s2">inf&quot;</span>
            <span class="s1">expected = df[f(df.a</span><span class="s0">, </span><span class="s1">np.inf)]</span>
            <span class="s1">result = df.query(q</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_check_tz_aware_index_query(self</span><span class="s0">, </span><span class="s1">tz_aware_fixture):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/29463</span>
        <span class="s1">tz = tz_aware_fixture</span>
        <span class="s1">df_index = date_range(</span>
            <span class="s1">start=</span><span class="s2">&quot;2019-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1d&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">tz=tz</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;time&quot;</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(index=df_index)</span>
        <span class="s1">df = DataFrame(index=df_index)</span>
        <span class="s1">result = df.query(</span><span class="s2">'&quot;2018-01-03 00:00:00+00&quot; &lt; time'</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">expected = DataFrame(df_index)</span>
        <span class="s1">result = df.reset_index().query(</span><span class="s2">'&quot;2018-01-03 00:00:00+00&quot; &lt; time'</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_method_calls_in_query(self):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/22435</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s3">2 </span><span class="s1">* np.random.rand(n)</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.random.rand(n)})</span>
        <span class="s1">expected = df[df[</span><span class="s2">&quot;a&quot;</span><span class="s1">].astype(</span><span class="s2">&quot;int&quot;</span><span class="s1">) == </span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">result = df.query(</span>
            <span class="s2">&quot;a.astype('int') == 0&quot;</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: np.where(np.random.rand(n) &lt; </span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.random.randn(n))</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: np.random.randn(n)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">expected = df[df[</span><span class="s2">&quot;a&quot;</span><span class="s1">].notnull()]</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;a.notnull()&quot;</span><span class="s0">, </span><span class="s1">engine=self.engine</span><span class="s0">, </span><span class="s1">parser=self.parser)</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@td.skip_if_no_ne</span>
<span class="s0">class </span><span class="s1">TestDataFrameQueryNumExprPython(TestDataFrameQueryNumExprPandas):</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">super().setup_class()</span>
        <span class="s1">cls.engine = </span><span class="s2">&quot;numexpr&quot;</span>
        <span class="s1">cls.parser = </span><span class="s2">&quot;python&quot;</span>

    <span class="s0">def </span><span class="s1">test_date_query_no_attribute_access(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates2&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2013&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">res = df.query(</span>
            <span class="s2">&quot;(dates1 &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">expec = df[(df.dates1 &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_NaT(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randn(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates2&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2013&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df.loc[np.random.rand(n) &gt; </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = pd.NaT</span>
        <span class="s1">df.loc[np.random.rand(n) &gt; </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = pd.NaT</span>
        <span class="s1">res = df.query(</span>
            <span class="s2">&quot;(dates1 &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">expec = df[(df.dates1 &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randn(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">return_value = df.set_index(</span><span class="s2">&quot;dates1&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True, </span><span class="s1">drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res = df.query(</span>
            <span class="s2">&quot;(index &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">expec = df[(df.index &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randn(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = pd.NaT</span>
        <span class="s1">return_value = df.set_index(</span><span class="s2">&quot;dates1&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True, </span><span class="s1">drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res = df.query(</span>
            <span class="s2">&quot;(index &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">expec = df[(df.index &lt; </span><span class="s2">&quot;20130101&quot;</span><span class="s1">) &amp; (</span><span class="s2">&quot;20130101&quot; </span><span class="s1">&lt; df.dates3)]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT_duplicates(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>
        <span class="s1">n = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randn(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df[</span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2012&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df[</span><span class="s2">&quot;dates3&quot;</span><span class="s1">] = date_range(</span><span class="s2">&quot;1/1/2014&quot;</span><span class="s0">, </span><span class="s1">periods=n)</span>
        <span class="s1">df.loc[np.random.rand(n) &gt; </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;dates1&quot;</span><span class="s1">] = pd.NaT</span>
        <span class="s1">return_value = df.set_index(</span><span class="s2">&quot;dates1&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True, </span><span class="s1">drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">msg = </span><span class="s2">r&quot;'BoolOp' nodes are not implemented&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;index &lt; 20130101 &lt; dates3&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

    <span class="s0">def </span><span class="s1">test_nested_scope(self):</span>
        <span class="s0">from </span><span class="s1">pandas.core.computation.ops </span><span class="s0">import </span><span class="s1">UndefinedVariableError</span>

        <span class="s1">engine = self.engine</span>
        <span class="s1">parser = self.parser</span>
        <span class="s4"># smoke test</span>
        <span class="s1">x = </span><span class="s3">1  </span><span class="s4"># noqa:F841</span>
        <span class="s1">result = pd.eval(</span><span class="s2">&quot;x + 1&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s0">assert </span><span class="s1">result == </span><span class="s3">2</span>

        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">df2 = DataFrame(np.random.randn(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

        <span class="s4"># don't have the pandas parser</span>
        <span class="s1">msg = </span><span class="s2">r&quot;The '@' prefix is only supported by the pandas parser&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(SyntaxError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;(@df&gt;0) &amp; (@df2&gt;0)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(UndefinedVariableError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;name 'df' is not defined&quot;</span><span class="s1">):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;(df&gt;0) &amp; (df2&gt;0)&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>

        <span class="s1">expected = df[(df &gt; </span><span class="s3">0</span><span class="s1">) &amp; (df2 &gt; </span><span class="s3">0</span><span class="s1">)]</span>
        <span class="s1">result = pd.eval(</span><span class="s2">&quot;df[(df &gt; 0) &amp; (df2 &gt; 0)]&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">expected = df[(df &gt; </span><span class="s3">0</span><span class="s1">) &amp; (df2 &gt; </span><span class="s3">0</span><span class="s1">) &amp; (df[df &gt; </span><span class="s3">0</span><span class="s1">] &gt; </span><span class="s3">0</span><span class="s1">)]</span>
        <span class="s1">result = pd.eval(</span>
            <span class="s2">&quot;df[(df &gt; 0) &amp; (df2 &gt; 0) &amp; (df[df &gt; 0] &gt; 0)]&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryPythonPandas(TestDataFrameQueryNumExprPandas):</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">super().setup_class()</span>
        <span class="s1">cls.engine = </span><span class="s2">&quot;python&quot;</span>
        <span class="s1">cls.parser = </span><span class="s2">&quot;pandas&quot;</span>

    <span class="s0">def </span><span class="s1">test_query_builtin(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>

        <span class="s1">n = m = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randint(m</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span>

        <span class="s1">df.index.name = </span><span class="s2">&quot;sin&quot;</span>
        <span class="s1">expected = df[df.index &gt; </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;sin &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryPythonPython(TestDataFrameQueryNumExprPython):</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">super().setup_class()</span>
        <span class="s1">cls.engine = cls.parser = </span><span class="s2">&quot;python&quot;</span>

    <span class="s0">def </span><span class="s1">test_query_builtin(self):</span>
        <span class="s1">engine</span><span class="s0">, </span><span class="s1">parser = self.engine</span><span class="s0">, </span><span class="s1">self.parser</span>

        <span class="s1">n = m = </span><span class="s3">10</span>
        <span class="s1">df = DataFrame(np.random.randint(m</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span>

        <span class="s1">df.index.name = </span><span class="s2">&quot;sin&quot;</span>
        <span class="s1">expected = df[df.index &gt; </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">result = df.query(</span><span class="s2">&quot;sin &gt; 5&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryStrings:</span>
    <span class="s0">def </span><span class="s1">test_str_query_method(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">df[</span><span class="s2">&quot;strings&quot;</span><span class="s1">] = Series(list(</span><span class="s2">&quot;aabbccddee&quot;</span><span class="s1">))</span>
        <span class="s1">expect = df[df.strings == </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>

        <span class="s0">if </span><span class="s1">parser != </span><span class="s2">&quot;pandas&quot;</span><span class="s1">:</span>
            <span class="s1">col = </span><span class="s2">&quot;strings&quot;</span>
            <span class="s1">lst = </span><span class="s2">'&quot;a&quot;'</span>

            <span class="s1">lhs = [col] * </span><span class="s3">2 </span><span class="s1">+ [lst] * </span><span class="s3">2</span>
            <span class="s1">rhs = lhs[::-</span><span class="s3">1</span><span class="s1">]</span>

            <span class="s1">eq</span><span class="s0">, </span><span class="s1">ne = </span><span class="s2">&quot;==&quot;</span><span class="s0">, </span><span class="s2">&quot;!=&quot;</span>
            <span class="s1">ops = </span><span class="s3">2 </span><span class="s1">* ([eq] + [ne])</span>
            <span class="s1">msg = </span><span class="s2">r&quot;'(Not)?In' nodes are not implemented&quot;</span>

            <span class="s0">for </span><span class="s1">lhs</span><span class="s0">, </span><span class="s1">op</span><span class="s0">, </span><span class="s1">rhs </span><span class="s0">in </span><span class="s1">zip(lhs</span><span class="s0">, </span><span class="s1">ops</span><span class="s0">, </span><span class="s1">rhs):</span>
                <span class="s1">ex = </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">lhs</span><span class="s0">} {</span><span class="s1">op</span><span class="s0">} {</span><span class="s1">rhs</span><span class="s0">}</span><span class="s2">&quot;</span>
                <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                    <span class="s1">df.query(</span>
                        <span class="s1">ex</span><span class="s0">,</span>
                        <span class="s1">engine=engine</span><span class="s0">,</span>
                        <span class="s1">parser=parser</span><span class="s0">,</span>
                        <span class="s1">local_dict={</span><span class="s2">&quot;strings&quot;</span><span class="s1">: df.strings}</span><span class="s0">,</span>
                    <span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">res = df.query(</span><span class="s2">'&quot;a&quot; == strings'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

            <span class="s1">res = df.query(</span><span class="s2">'strings == &quot;a&quot;'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">df[df.strings.isin([</span><span class="s2">&quot;a&quot;</span><span class="s1">])])</span>

            <span class="s1">expect = df[df.strings != </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
            <span class="s1">res = df.query(</span><span class="s2">'strings != &quot;a&quot;'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

            <span class="s1">res = df.query(</span><span class="s2">'&quot;a&quot; != strings'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">df[~df.strings.isin([</span><span class="s2">&quot;a&quot;</span><span class="s1">])])</span>

    <span class="s0">def </span><span class="s1">test_str_list_query_method(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">df = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">df[</span><span class="s2">&quot;strings&quot;</span><span class="s1">] = Series(list(</span><span class="s2">&quot;aabbccddee&quot;</span><span class="s1">))</span>
        <span class="s1">expect = df[df.strings.isin([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])]</span>

        <span class="s0">if </span><span class="s1">parser != </span><span class="s2">&quot;pandas&quot;</span><span class="s1">:</span>
            <span class="s1">col = </span><span class="s2">&quot;strings&quot;</span>
            <span class="s1">lst = </span><span class="s2">'[&quot;a&quot;, &quot;b&quot;]'</span>

            <span class="s1">lhs = [col] * </span><span class="s3">2 </span><span class="s1">+ [lst] * </span><span class="s3">2</span>
            <span class="s1">rhs = lhs[::-</span><span class="s3">1</span><span class="s1">]</span>

            <span class="s1">eq</span><span class="s0">, </span><span class="s1">ne = </span><span class="s2">&quot;==&quot;</span><span class="s0">, </span><span class="s2">&quot;!=&quot;</span>
            <span class="s1">ops = </span><span class="s3">2 </span><span class="s1">* ([eq] + [ne])</span>
            <span class="s1">msg = </span><span class="s2">r&quot;'(Not)?In' nodes are not implemented&quot;</span>

            <span class="s0">for </span><span class="s1">lhs</span><span class="s0">, </span><span class="s1">op</span><span class="s0">, </span><span class="s1">rhs </span><span class="s0">in </span><span class="s1">zip(lhs</span><span class="s0">, </span><span class="s1">ops</span><span class="s0">, </span><span class="s1">rhs):</span>
                <span class="s1">ex = </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">lhs</span><span class="s0">} {</span><span class="s1">op</span><span class="s0">} {</span><span class="s1">rhs</span><span class="s0">}</span><span class="s2">&quot;</span>
                <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                    <span class="s1">df.query(ex</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">res = df.query(</span><span class="s2">'strings == [&quot;a&quot;, &quot;b&quot;]'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

            <span class="s1">res = df.query(</span><span class="s2">'[&quot;a&quot;, &quot;b&quot;] == strings'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

            <span class="s1">expect = df[~df.strings.isin([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])]</span>

            <span class="s1">res = df.query(</span><span class="s2">'strings != [&quot;a&quot;, &quot;b&quot;]'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

            <span class="s1">res = df.query(</span><span class="s2">'[&quot;a&quot;, &quot;b&quot;] != strings'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_query_with_string_columns(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aaaabbbbcccc&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aabbccddeeff&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;c&quot;</span><span class="s1">: np.random.randint(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">12</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;d&quot;</span><span class="s1">: np.random.randint(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">12</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">parser == </span><span class="s2">&quot;pandas&quot;</span><span class="s1">:</span>
            <span class="s1">res = df.query(</span><span class="s2">&quot;a in b&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
            <span class="s1">expec = df[df.a.isin(df.b)]</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

            <span class="s1">res = df.query(</span><span class="s2">&quot;a in b and c &lt; d&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
            <span class="s1">expec = df[df.a.isin(df.b) &amp; (df.c &lt; df.d)]</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s2">r&quot;'(Not)?In' nodes are not implemented&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">df.query(</span><span class="s2">&quot;a in b&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>

            <span class="s1">msg = </span><span class="s2">r&quot;'BoolOp' nodes are not implemented&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">df.query(</span><span class="s2">&quot;a in b and c &lt; d&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>

    <span class="s0">def </span><span class="s1">test_object_array_eq_ne(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;a&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aaaabbbbcccc&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s1">: list(</span><span class="s2">&quot;aabbccddeeff&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;c&quot;</span><span class="s1">: np.random.randint(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">12</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;d&quot;</span><span class="s1">: np.random.randint(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">12</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;a == b&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[df.a == df.b]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">res = df.query(</span><span class="s2">&quot;a != b&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">exp = df[df.a != df.b]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

    <span class="s0">def </span><span class="s1">test_query_with_nested_strings(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">events = [</span>
            <span class="s2">f&quot;page </span><span class="s0">{</span><span class="s1">n</span><span class="s0">} {</span><span class="s1">act</span><span class="s0">}</span><span class="s2">&quot; </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">) </span><span class="s0">for </span><span class="s1">act </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;load&quot;</span><span class="s0">, </span><span class="s2">&quot;exit&quot;</span><span class="s1">]</span>
        <span class="s1">] * </span><span class="s3">2</span>
        <span class="s1">stamps1 = date_range(</span><span class="s2">&quot;2014-01-01 0:00:01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;30s&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">6</span><span class="s1">)</span>
        <span class="s1">stamps2 = date_range(</span><span class="s2">&quot;2014-02-01 1:00:01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;30s&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">6</span><span class="s1">)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;id&quot;</span><span class="s1">: np.arange(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">).repeat(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;event&quot;</span><span class="s1">: events</span><span class="s0">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="s1">: stamps1.append(stamps2)</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

        <span class="s1">expected = df[df.event == </span><span class="s2">'&quot;page 1 load&quot;'</span><span class="s1">]</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;&quot;&quot;'&quot;page 1 load&quot;' in event&quot;&quot;&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">tm.assert_frame_equal(expected</span><span class="s0">, </span><span class="s1">res)</span>

    <span class="s0">def </span><span class="s1">test_query_with_nested_special_character(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;test &amp; test&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
        <span class="s1">res = df.query(</span><span class="s2">'a == &quot;test &amp; test&quot;'</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">expec = df[df.a == </span><span class="s2">&quot;test &amp; test&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expec)</span>

    <span class="s0">def </span><span class="s1">test_query_lex_compare_strings(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>

        <span class="s1">a = Series(np.random.choice(list(</span><span class="s2">&quot;abcde&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
        <span class="s1">b = Series(np.arange(a.size))</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;X&quot;</span><span class="s1">: a</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">: b})</span>

        <span class="s1">ops = {</span><span class="s2">&quot;&lt;&quot;</span><span class="s1">: operator.lt</span><span class="s0">, </span><span class="s2">&quot;&gt;&quot;</span><span class="s1">: operator.gt</span><span class="s0">, </span><span class="s2">&quot;&lt;=&quot;</span><span class="s1">: operator.le</span><span class="s0">, </span><span class="s2">&quot;&gt;=&quot;</span><span class="s1">: operator.ge}</span>

        <span class="s0">for </span><span class="s1">op</span><span class="s0">, </span><span class="s1">func </span><span class="s0">in </span><span class="s1">ops.items():</span>
            <span class="s1">res = df.query(</span><span class="s2">f'X </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s2">&quot;d&quot;'</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
            <span class="s1">expected = df[func(df.X</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">)]</span>
            <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_query_single_element_booleans(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">columns = </span><span class="s2">&quot;bid&quot;</span><span class="s0">, </span><span class="s2">&quot;bidsize&quot;</span><span class="s0">, </span><span class="s2">&quot;ask&quot;</span><span class="s0">, </span><span class="s2">&quot;asksize&quot;</span>
        <span class="s1">data = np.random.randint(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">len(columns))).astype(bool)</span>
        <span class="s1">df = DataFrame(data</span><span class="s0">, </span><span class="s1">columns=columns)</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;bid &amp; ask&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expected = df[df.bid &amp; df.ask]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_query_string_scalar_variable(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">skip_if_no_pandas_parser(parser)</span>
        <span class="s1">df = DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;Symbol&quot;</span><span class="s1">: [</span><span class="s2">&quot;BUD US&quot;</span><span class="s0">, </span><span class="s2">&quot;BUD US&quot;</span><span class="s0">, </span><span class="s2">&quot;IBM US&quot;</span><span class="s0">, </span><span class="s2">&quot;IBM US&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;Price&quot;</span><span class="s1">: [</span><span class="s3">109.70</span><span class="s0">, </span><span class="s3">109.72</span><span class="s0">, </span><span class="s3">183.30</span><span class="s0">, </span><span class="s3">183.35</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">e = df[df.Symbol == </span><span class="s2">&quot;BUD US&quot;</span><span class="s1">]</span>
        <span class="s1">symb = </span><span class="s2">&quot;BUD US&quot;  </span><span class="s4"># noqa:F841</span>
        <span class="s1">r = df.query(</span><span class="s2">&quot;Symbol == @symb&quot;</span><span class="s0">, </span><span class="s1">parser=parser</span><span class="s0">, </span><span class="s1">engine=engine)</span>
        <span class="s1">tm.assert_frame_equal(e</span><span class="s0">, </span><span class="s1">r)</span>


<span class="s0">class </span><span class="s1">TestDataFrameEvalWithFrame:</span>
    <span class="s0">def </span><span class="s1">setup_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s1">self.frame = DataFrame(np.random.randn(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">teardown_method(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s0">del </span><span class="s1">self.frame</span>

    <span class="s0">def </span><span class="s1">test_simple_expr(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">res = self.frame.eval(</span><span class="s2">&quot;a + b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expect = self.frame.a + self.frame.b</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_bool_arith_expr(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine):</span>
        <span class="s1">res = self.frame.eval(</span><span class="s2">&quot;a[a &lt; 1] + b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>
        <span class="s1">expect = self.frame.a[self.frame.a &lt; </span><span class="s3">1</span><span class="s1">] + self.frame.b</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;op&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;+&quot;</span><span class="s0">, </span><span class="s2">&quot;-&quot;</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s0">, </span><span class="s2">&quot;/&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_type_for_operator_raises(self</span><span class="s0">, </span><span class="s1">parser</span><span class="s0">, </span><span class="s1">engine</span><span class="s0">, </span><span class="s1">op):</span>
        <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]})</span>
        <span class="s1">msg = </span><span class="s2">r&quot;unsupported operand type\(s\) for .+: '.+' and '.+'&quot;</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.eval(</span><span class="s2">f&quot;a </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s2">b&quot;</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">parser=parser)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryBacktickQuoting:</span>
    <span class="s1">@pytest.fixture(scope=</span><span class="s2">&quot;class&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">df(self):</span>
        <span class="s5">&quot;&quot;&quot; 
        Yields a dataframe with strings that may or may not need escaping 
        by backticks. The last two columns cannot be escaped by backticks 
        and should raise a ValueError. 
        &quot;&quot;&quot;</span>
        <span class="s0">yield </span><span class="s1">DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;B B&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;C C&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;C  C&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;C_C&quot;</span><span class="s1">: [</span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;D_D D&quot;</span><span class="s1">: [</span><span class="s3">11</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">101</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;E.E&quot;</span><span class="s1">: [</span><span class="s3">6</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;F-F&quot;</span><span class="s1">: [</span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;1e1&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;def&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;A (x)&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;B(x)&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;B (x)&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;  &amp;^ :!€$?(} &gt;    &lt;++*''  &quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot; A&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;  &quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;it's&quot;</span><span class="s1">: [</span><span class="s3">6</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;that's&quot;</span><span class="s1">: [</span><span class="s3">9</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;☺&quot;</span><span class="s1">: [</span><span class="s3">8</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;foo#bar&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s3">1</span><span class="s1">: [</span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_single_backtick_variable_query(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;1 &lt; `B B`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s3">1 </span><span class="s1">&lt; df[</span><span class="s2">&quot;B B&quot;</span><span class="s1">]]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_two_backtick_variables_query(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;1 &lt; `B B` and 4 &lt; `C C`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[(</span><span class="s3">1 </span><span class="s1">&lt; df[</span><span class="s2">&quot;B B&quot;</span><span class="s1">]) &amp; (</span><span class="s3">4 </span><span class="s1">&lt; df[</span><span class="s2">&quot;C C&quot;</span><span class="s1">])]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_single_backtick_variable_expr(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;A + `B B`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;A&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;B B&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_two_backtick_variables_expr(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;`B B` + `C C`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;B B&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;C C&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_already_underscore_variable(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;`C_C` + A&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;C_C&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_same_name_but_underscores(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;C_C + `C C`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;C_C&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;C C&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_mixed_underscores_and_spaces(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;A + `D_D D`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;A&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;D_D D&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_backtick_quote_name_with_no_spaces(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;A + `C_C`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;A&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;C_C&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_special_characters(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;`E.E` + `F-F` - A&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;E.E&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;F-F&quot;</span><span class="s1">] - df[</span><span class="s2">&quot;A&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_start_with_digit(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;A + `1e1`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;A&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;1e1&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_keyword(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;A + `def`&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot;A&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;def&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_unneeded_quoting(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;`A` &gt; 2&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[df[</span><span class="s2">&quot;A&quot;</span><span class="s1">] &gt; </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_parenthesis(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;`A (x)` &gt; 2&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[df[</span><span class="s2">&quot;A (x)&quot;</span><span class="s1">] &gt; </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_empty_string(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;`` &gt; 5&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[df[</span><span class="s2">&quot;&quot;</span><span class="s1">] &gt; </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_multiple_spaces(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;`C  C` &gt; 5&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[df[</span><span class="s2">&quot;C  C&quot;</span><span class="s1">] &gt; </span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_start_with_spaces(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.eval(</span><span class="s2">&quot;` A` + `  `&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[</span><span class="s2">&quot; A&quot;</span><span class="s1">] + df[</span><span class="s2">&quot;  &quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_lots_of_operators_string(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">res = df.query(</span><span class="s2">&quot;`  &amp;^ :!€$?(} &gt;    &lt;++*''  ` &gt; 4&quot;</span><span class="s1">)</span>
        <span class="s1">expect = df[df[</span><span class="s2">&quot;  &amp;^ :!€$?(} &gt;    &lt;++*''  &quot;</span><span class="s1">] &gt; </span><span class="s3">4</span><span class="s1">]</span>
        <span class="s1">tm.assert_frame_equal(res</span><span class="s0">, </span><span class="s1">expect)</span>

    <span class="s0">def </span><span class="s1">test_missing_attribute(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">message = </span><span class="s2">&quot;module 'pandas' has no attribute 'thing'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(AttributeError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">df.eval(</span><span class="s2">&quot;@pd.thing&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_failing_quote(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">msg = </span><span class="s2">r&quot;(Could not convert ).*( to a valid Python identifier.)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(SyntaxError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;`it's` &gt; `that's`&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_failing_character_outside_range(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">msg = </span><span class="s2">r&quot;(Could not convert ).*( to a valid Python identifier.)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(SyntaxError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;`☺` &gt; 4&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_failing_hashtag(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s1">msg = </span><span class="s2">&quot;Failed to parse backticks&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(SyntaxError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df.query(</span><span class="s2">&quot;`foo#bar` &gt; 4&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_call_non_named_expression(self</span><span class="s0">, </span><span class="s1">df):</span>
        <span class="s5">&quot;&quot;&quot; 
        Only attributes and variables ('named functions') can be called. 
        .__call__() is not an allowed attribute because that would allow 
        calling anything. 
        https://github.com/pandas-dev/pandas/pull/32460 
        &quot;&quot;&quot;</span>

        <span class="s0">def </span><span class="s1">func(*_):</span>
            <span class="s0">return </span><span class="s3">1</span>

        <span class="s1">funcs = [func]  </span><span class="s4"># noqa:F841</span>

        <span class="s1">df.eval(</span><span class="s2">&quot;@func()&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Only named functions are supported&quot;</span><span class="s1">):</span>
            <span class="s1">df.eval(</span><span class="s2">&quot;@funcs[0]()&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Only named functions are supported&quot;</span><span class="s1">):</span>
            <span class="s1">df.eval(</span><span class="s2">&quot;@funcs[0].__call__()&quot;</span><span class="s1">)</span>
</pre>
</body>
</html>