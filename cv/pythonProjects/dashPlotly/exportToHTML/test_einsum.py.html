<html>
<head>
<title>test_einsum.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_einsum.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_array_equal</span><span class="s0">, </span><span class="s1">assert_almost_equal</span><span class="s0">,</span>
    <span class="s1">assert_raises</span><span class="s0">, </span><span class="s1">suppress_warnings</span><span class="s0">, </span><span class="s1">assert_raises_regex</span><span class="s0">, </span><span class="s1">assert_allclose</span>
    <span class="s1">)</span>

<span class="s2"># Setup for optimize einsum</span>
<span class="s1">chars = </span><span class="s3">'abcdefghij'</span>
<span class="s1">sizes = np.array([</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
<span class="s1">global_size_dict = dict(zip(chars</span><span class="s0">, </span><span class="s1">sizes))</span>


<span class="s0">class </span><span class="s1">TestEinsum:</span>
    <span class="s0">def </span><span class="s1">test_einsum_errors(self):</span>
        <span class="s0">for </span><span class="s1">do_opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s2"># Need enough arguments</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># subscripts must be a string</span>
            <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># out parameter must be an array</span>
            <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">out=</span><span class="s3">'test'</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>

            <span class="s2"># order parameter must be a valid order</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'W'</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>

            <span class="s2"># casting parameter must be a valid casting</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'blah'</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>

            <span class="s2"># dtype parameter must be a valid dtype</span>
            <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'bad_data_type'</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>

            <span class="s2"># other keyword arguments are rejected</span>
            <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">bad_arg=</span><span class="s4">0</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>

            <span class="s2"># issue 4528 revealed a segfault with this call</span>
            <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s1">*(</span><span class="s0">None,</span><span class="s1">)*</span><span class="s4">63</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># number of operands must match count in subscripts string</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;,&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># can't have more subscripts than dimensions in the operand</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;...i&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i...j&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i...&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;ij...&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># invalid ellipsis</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i..&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;.i...&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;j-&gt;..j&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;j-&gt;.j...&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># invalid subscript character</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i%...&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;...j$&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i-&gt;&amp;&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># output subscripts must appear in input</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i-&gt;ij&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># output subscripts may only be specified once</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;ij-&gt;jij&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>

            <span class="s2"># dimensions much match when being collapsed</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;ii&quot;</span><span class="s0">,</span>
                          <span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;ii-&gt;i&quot;</span><span class="s0">,</span>
                          <span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>

            <span class="s2"># broadcasting to new dimensions must be enabled explicitly</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i&quot;</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i-&gt;i&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                          <span class="s1">out=np.arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s0">with </span><span class="s1">assert_raises_regex(ValueError</span><span class="s0">, </span><span class="s3">&quot;'b'&quot;</span><span class="s1">):</span>
                <span class="s2"># gh-11221 - 'c' erroneously appeared in the error message</span>
                <span class="s1">a = np.ones((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">))</span>
                <span class="s1">b = np.ones((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
                <span class="s1">np.einsum(</span><span class="s3">'aabcb,abc'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>

            <span class="s2"># Check order kwarg, asanyarray allows 1d to pass through</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.einsum</span><span class="s0">, </span><span class="s3">&quot;i-&gt;i&quot;</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s4">6</span><span class="s1">).reshape(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'d'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_views(self):</span>
        <span class="s2"># pass-through</span>
        <span class="s0">for </span><span class="s1">do_opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
            <span class="s1">a.shape = (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">a)</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">a)</span>

            <span class="s2"># output is writeable whenever input is writeable</span>
            <span class="s1">b = np.einsum(</span><span class="s3">&quot;...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.flags[</span><span class="s3">'WRITEABLE'</span><span class="s1">])</span>
            <span class="s1">a.flags[</span><span class="s3">'WRITEABLE'</span><span class="s1">] = </span><span class="s0">False</span>
            <span class="s1">b = np.einsum(</span><span class="s3">&quot;...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">b.flags[</span><span class="s3">'WRITEABLE'</span><span class="s1">])</span>

            <span class="s2"># transpose</span>
            <span class="s1">a = np.arange(</span><span class="s4">6</span><span class="s1">)</span>
            <span class="s1">a.shape = (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;ji&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">a.T)</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">a.T)</span>

            <span class="s2"># diagonal</span>
            <span class="s1">a = np.arange(</span><span class="s4">9</span><span class="s1">)</span>
            <span class="s1">a.shape = (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;ii-&gt;i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s2"># diagonal with various ways of broadcasting an additional dimension</span>
            <span class="s1">a = np.arange(</span><span class="s4">27</span><span class="s1">)</span>
            <span class="s1">a.shape = (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;...ii-&gt;...i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[[x[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[[x[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a])</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;ii...-&gt;...i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[[x[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a.transpose(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[[x[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a.transpose(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;...ii-&gt;i...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;jii-&gt;ij&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;ii...-&gt;i...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a.transpose(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a.transpose(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;i...i-&gt;i...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a.transpose(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a.transpose(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;i...i-&gt;...i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[[x[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a.transpose(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[[x[i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a.transpose(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>

            <span class="s2"># triple diagonal</span>
            <span class="s1">a = np.arange(</span><span class="s4">27</span><span class="s1">)</span>
            <span class="s1">a.shape = (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;iii-&gt;i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[i</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[a[i</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>

            <span class="s2"># swap axes</span>
            <span class="s1">a = np.arange(</span><span class="s4">24</span><span class="s1">)</span>
            <span class="s1">a.shape = (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>

            <span class="s1">b = np.einsum(</span><span class="s3">&quot;ijk-&gt;jik&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">a.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>

            <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">assert_(b.base </span><span class="s0">is </span><span class="s1">a)</span>
            <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">a.swapaxes(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">check_einsum_sums(self</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">do_opt=</span><span class="s0">False</span><span class="s1">):</span>
        <span class="s2"># Check various sums.  Does many sizes to exercise unrolled loops.</span>

        <span class="s2"># sum(a, axis=-1)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(n</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i-&gt;&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s4">1</span><span class="s1">).astype(dtype))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s4">1</span><span class="s1">).astype(dtype))</span>

        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(</span><span class="s4">2</span><span class="s1">*</span><span class="s4">3</span><span class="s1">*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;...i-&gt;...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s4">1</span><span class="s1">).astype(dtype))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s4">1</span><span class="s1">).astype(dtype))</span>

        <span class="s2"># sum(a, axis=0)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(</span><span class="s4">2</span><span class="s1">*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i...-&gt;...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">).astype(dtype))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">[Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">).astype(dtype))</span>

        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(</span><span class="s4">2</span><span class="s1">*</span><span class="s4">3</span><span class="s1">*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i...-&gt;...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">).astype(dtype))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">[Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.sum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">).astype(dtype))</span>

        <span class="s2"># trace(a)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(n*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(n</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;ii&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.trace(a).astype(dtype))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.trace(a).astype(dtype))</span>

            <span class="s2"># gh-15961: should accept numpy int64 type in subscript list</span>
            <span class="s1">np_array = np.asarray([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">np_array</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.trace(a).astype(dtype))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">list(np_array)</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.trace(a).astype(dtype))</span>

        <span class="s2"># multiply(a, b)</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;..., ...&quot;</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)  </span><span class="s2"># scalar case</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(</span><span class="s4">3 </span><span class="s1">* n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">b = np.arange(</span><span class="s4">2 </span><span class="s1">* </span><span class="s4">3 </span><span class="s1">* n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;..., ...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.multiply(a</span><span class="s0">, </span><span class="s1">b))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[Ellipsis]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.multiply(a</span><span class="s0">, </span><span class="s1">b))</span>

        <span class="s2"># inner(a,b)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(</span><span class="s4">2 </span><span class="s1">* </span><span class="s4">3 </span><span class="s1">* n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">b = np.arange(n</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;...i, ...i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s1">np.inner(a</span><span class="s0">, </span><span class="s1">b))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.inner(a</span><span class="s0">, </span><span class="s1">b))</span>

        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">11</span><span class="s1">):</span>
            <span class="s1">a = np.arange(n * </span><span class="s4">3 </span><span class="s1">* </span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(n</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">b = np.arange(n</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i..., i...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.inner(a.T</span><span class="s0">, </span><span class="s1">b.T).T)</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">Ellipsis]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.inner(a.T</span><span class="s0">, </span><span class="s1">b.T).T)</span>

        <span class="s2"># outer(a,b)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
            <span class="s1">a = np.arange(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">dtype=dtype)+</span><span class="s4">1</span>
            <span class="s1">b = np.arange(n</span><span class="s0">, </span><span class="s1">dtype=dtype)+</span><span class="s4">1</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,j&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.outer(a</span><span class="s0">, </span><span class="s1">b))</span>
            <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                         <span class="s1">np.outer(a</span><span class="s0">, </span><span class="s1">b))</span>

        <span class="s2"># Suppress the complex warnings for the 'as f8' tests</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(np.ComplexWarning)</span>

            <span class="s2"># matvec(a,b) / a.dot(b) where a is matrix, b is vector</span>
            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
                <span class="s1">a = np.arange(</span><span class="s4">4</span><span class="s1">*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">n)</span>
                <span class="s1">b = np.arange(n</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;ij, j&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">np.dot(a</span><span class="s0">, </span><span class="s1">b))</span>
                <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">np.dot(a</span><span class="s0">, </span><span class="s1">b))</span>

                <span class="s1">c = np.arange(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
                <span class="s1">np.einsum(</span><span class="s3">&quot;ij,j&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">,</span>
                          <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">,</span>
                             <span class="s1">np.dot(a.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">b.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype))</span>
                <span class="s1">c[...] = </span><span class="s4">0</span>
                <span class="s1">np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">,</span>
                          <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">,</span>
                             <span class="s1">np.dot(a.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">b.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype))</span>

            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
                <span class="s1">a = np.arange(</span><span class="s4">4</span><span class="s1">*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">n)</span>
                <span class="s1">b = np.arange(n</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;ji,j&quot;</span><span class="s0">, </span><span class="s1">a.T</span><span class="s0">, </span><span class="s1">b.T</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">np.dot(b.T</span><span class="s0">, </span><span class="s1">a.T))</span>
                <span class="s1">assert_equal(np.einsum(a.T</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b.T</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">np.dot(b.T</span><span class="s0">, </span><span class="s1">a.T))</span>

                <span class="s1">c = np.arange(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
                <span class="s1">np.einsum(</span><span class="s3">&quot;ji,j&quot;</span><span class="s0">, </span><span class="s1">a.T</span><span class="s0">, </span><span class="s1">b.T</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">,</span>
                          <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">,</span>
                             <span class="s1">np.dot(b.T.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">a.T.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype))</span>
                <span class="s1">c[...] = </span><span class="s4">0</span>
                <span class="s1">np.einsum(a.T</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b.T</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">,</span>
                          <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">,</span>
                             <span class="s1">np.dot(b.T.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">a.T.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype))</span>

            <span class="s2"># matmat(a,b) / a.dot(b) where a is matrix, b is matrix</span>
            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
                <span class="s0">if </span><span class="s1">n &lt; </span><span class="s4">8 </span><span class="s0">or </span><span class="s1">dtype != </span><span class="s3">'f2'</span><span class="s1">:</span>
                    <span class="s1">a = np.arange(</span><span class="s4">4</span><span class="s1">*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">n)</span>
                    <span class="s1">b = np.arange(n*</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(n</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
                    <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;ij,jk&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                                 <span class="s1">np.dot(a</span><span class="s0">, </span><span class="s1">b))</span>
                    <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                                 <span class="s1">np.dot(a</span><span class="s0">, </span><span class="s1">b))</span>

            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">17</span><span class="s1">):</span>
                <span class="s1">a = np.arange(</span><span class="s4">4</span><span class="s1">*n</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">n)</span>
                <span class="s1">b = np.arange(n*</span><span class="s4">6</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(n</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
                <span class="s1">c = np.arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
                <span class="s1">np.einsum(</span><span class="s3">&quot;ij,jk&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">,</span>
                          <span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">,</span>
                             <span class="s1">np.dot(a.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">b.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype))</span>
                <span class="s1">c[...] = </span><span class="s4">0</span>
                <span class="s1">np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">,</span>
                          <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">,</span>
                             <span class="s1">np.dot(a.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s1">b.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype))</span>

            <span class="s2"># matrix triple product (note this is not currently an efficient</span>
            <span class="s2"># way to multiply 3 matrices)</span>
            <span class="s1">a = np.arange(</span><span class="s4">12</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
            <span class="s1">b = np.arange(</span><span class="s4">20</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">c = np.arange(</span><span class="s4">30</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">dtype != </span><span class="s3">'f2'</span><span class="s1">:</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;ij,jk,kl&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">a.dot(b).dot(c))</span>
                <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
                                       <span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s1">a.dot(b).dot(c))</span>

            <span class="s1">d = np.arange(</span><span class="s4">18</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
            <span class="s1">np.einsum(</span><span class="s3">&quot;ij,jk,kl&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">out=d</span><span class="s0">,</span>
                      <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">tgt = a.astype(</span><span class="s3">'f8'</span><span class="s1">).dot(b.astype(</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">tgt = tgt.dot(c.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype)</span>
            <span class="s1">assert_equal(d</span><span class="s0">, </span><span class="s1">tgt)</span>

            <span class="s1">d[...] = </span><span class="s4">0</span>
            <span class="s1">np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">out=d</span><span class="s0">,</span>
                      <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
            <span class="s1">tgt = a.astype(</span><span class="s3">'f8'</span><span class="s1">).dot(b.astype(</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">tgt = tgt.dot(c.astype(</span><span class="s3">'f8'</span><span class="s1">)).astype(dtype)</span>
            <span class="s1">assert_equal(d</span><span class="s0">, </span><span class="s1">tgt)</span>

            <span class="s2"># tensordot(a, b)</span>
            <span class="s0">if </span><span class="s1">np.dtype(dtype) != np.dtype(</span><span class="s3">'f2'</span><span class="s1">):</span>
                <span class="s1">a = np.arange(</span><span class="s4">60</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
                <span class="s1">b = np.arange(</span><span class="s4">24</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;ijk, jil -&gt; kl&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">,</span>
                             <span class="s1">np.tensordot(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])))</span>
                <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span><span class="s0">,</span>
                             <span class="s1">np.tensordot(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])))</span>

                <span class="s1">c = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
                <span class="s1">np.einsum(</span><span class="s3">&quot;ijk,jil-&gt;kl&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">,</span>
                          <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">, </span><span class="s1">np.tensordot(a.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">b.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">axes=([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])).astype(dtype))</span>
                <span class="s1">c[...] = </span><span class="s4">0</span>
                <span class="s1">np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">out=c</span><span class="s0">,</span>
                          <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span>
                <span class="s1">assert_equal(c</span><span class="s0">, </span><span class="s1">np.tensordot(a.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">b.astype(</span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">axes=([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])).astype(dtype))</span>

        <span class="s2"># logical_and(logical_and(a!=0, b!=0), c!=0)</span>
        <span class="s1">a = np.array([</span><span class="s4">1</span><span class="s0">,   </span><span class="s4">3</span><span class="s0">,   </span><span class="s1">-</span><span class="s4">2</span><span class="s0">,   </span><span class="s4">0</span><span class="s0">,   </span><span class="s4">12</span><span class="s0">,  </span><span class="s4">13</span><span class="s0">,   </span><span class="s4">0</span><span class="s0">,   </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">b = np.array([</span><span class="s4">0</span><span class="s0">,   </span><span class="s4">3.5</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">,   </span><span class="s1">-</span><span class="s4">2</span><span class="s0">,  </span><span class="s4">0</span><span class="s0">,   </span><span class="s4">1</span><span class="s0">,    </span><span class="s4">3</span><span class="s0">,   </span><span class="s4">12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">c = np.array([</span><span class="s0">True, True, False, True, True, False, True, True</span><span class="s1">])</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,i,i-&gt;i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">,</span>
                     <span class="s1">dtype=</span><span class="s3">'?'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                     <span class="s1">np.logical_and(np.logical_and(a != </span><span class="s4">0</span><span class="s0">, </span><span class="s1">b != </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">c != </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">dtype=</span><span class="s3">'?'</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s1">)</span><span class="s0">,</span>
                     <span class="s1">np.logical_and(np.logical_and(a != </span><span class="s4">0</span><span class="s0">, </span><span class="s1">b != </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">c != </span><span class="s4">0</span><span class="s1">))</span>

        <span class="s1">a = np.arange(</span><span class="s4">9</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;,i-&gt;&quot;</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">, </span><span class="s4">3</span><span class="s1">*np.sum(a))</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">*np.sum(a))</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,-&gt;&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s4">3</span><span class="s1">*np.sum(a))</span>
        <span class="s1">assert_equal(np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">*np.sum(a))</span>

        <span class="s2"># Various stride0, contiguous, and SSE aligned variants</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">25</span><span class="s1">):</span>
            <span class="s1">a = np.arange(n</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
            <span class="s0">if </span><span class="s1">np.dtype(dtype).itemsize &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;...,...&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">np.multiply(a</span><span class="s0">, </span><span class="s1">a))</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s1">np.dot(a</span><span class="s0">, </span><span class="s1">a))</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,-&gt;i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*a)</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;,i-&gt;i&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*a)</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,-&gt;&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.sum(a))</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;,i-&gt;&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*np.sum(a))</span>

                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;...,...&quot;</span><span class="s0">, </span><span class="s1">a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">a[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">np.multiply(a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">a[:-</span><span class="s4">1</span><span class="s1">]))</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,i&quot;</span><span class="s0">, </span><span class="s1">a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">a[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s1">np.dot(a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">a[:-</span><span class="s4">1</span><span class="s1">]))</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,-&gt;i&quot;</span><span class="s0">, </span><span class="s1">a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*a[</span><span class="s4">1</span><span class="s1">:])</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;,i-&gt;i&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">*a[</span><span class="s4">1</span><span class="s1">:])</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;i,-&gt;&quot;</span><span class="s0">, </span><span class="s1">a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s4">2</span><span class="s1">*np.sum(a[</span><span class="s4">1</span><span class="s1">:]))</span>
                <span class="s1">assert_equal(np.einsum(</span><span class="s3">&quot;,i-&gt;&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">optimize=do_opt)</span><span class="s0">,</span>
                             <span class="s4">2</span><span class="s1">*np.sum(a[</span><span class="s4">1</span><span class="s1">:]))</span>

        <span class="s2"># An object array, summed as the data type</span>
        <span class="s1">a = np.arange(</span><span class="s4">9</span><span class="s0">, </span><span class="s1">dtype=object)</span>

        <span class="s1">b = np.einsum(</span><span class="s3">&quot;i-&gt;&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">np.sum(a))</span>
        <span class="s1">assert_equal(b.dtype</span><span class="s0">, </span><span class="s1">np.dtype(dtype))</span>

        <span class="s1">b = np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">casting=</span><span class="s3">'unsafe'</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">np.sum(a))</span>
        <span class="s1">assert_equal(b.dtype</span><span class="s0">, </span><span class="s1">np.dtype(dtype))</span>

        <span class="s2"># A case which was failing (ticket #1885)</span>
        <span class="s1">p = np.arange(</span><span class="s4">2</span><span class="s1">) + </span><span class="s4">1</span>
        <span class="s1">q = np.arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">) + </span><span class="s4">3</span>
        <span class="s1">r = np.arange(</span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">) + </span><span class="s4">7</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'z,mz,zm-&gt;'</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">q</span><span class="s0">, </span><span class="s1">r)</span><span class="s0">, </span><span class="s4">253</span><span class="s1">)</span>

        <span class="s2"># singleton dimensions broadcast (gh-10343)</span>
        <span class="s1">p = np.ones((</span><span class="s4">10</span><span class="s0">,</span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">q = np.ones((</span><span class="s4">1</span><span class="s0">,</span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">'ij,ij-&gt;j'</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">q</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
                           <span class="s1">np.einsum(</span><span class="s3">'ij,ij-&gt;j'</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">q</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">'ij,ij-&gt;j'</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">q</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
                           <span class="s1">[</span><span class="s4">10.</span><span class="s1">] * </span><span class="s4">2</span><span class="s1">)</span>

        <span class="s2"># a blas-compatible contraction broadcasting case which was failing</span>
        <span class="s2"># for optimize=True (ticket #10930)</span>
        <span class="s1">x = np.array([</span><span class="s4">2.</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">])</span>
        <span class="s1">y = np.array([</span><span class="s4">4.</span><span class="s1">])</span>
        <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">&quot;i, i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">, </span><span class="s4">20.</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">&quot;i, i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s4">20.</span><span class="s1">)</span>

        <span class="s2"># all-ones array was bypassing bug (ticket #10930)</span>
        <span class="s1">p = np.ones((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)) / </span><span class="s4">2</span>
        <span class="s1">q = np.ones((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)) / </span><span class="s4">2</span>
        <span class="s0">for </span><span class="s1">optimize </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
            <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">&quot;...ij,...jk-&gt;...ik&quot;</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">p</span><span class="s0">,</span>
                                         <span class="s1">optimize=optimize)</span><span class="s0">,</span>
                               <span class="s1">np.einsum(</span><span class="s3">&quot;...ij,...jk-&gt;...ik&quot;</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">q</span><span class="s0">,</span>
                                         <span class="s1">optimize=optimize))</span>
            <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">&quot;...ij,...jk-&gt;...ik&quot;</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">q</span><span class="s0">,</span>
                                         <span class="s1">optimize=optimize)</span><span class="s0">,</span>
                               <span class="s1">np.full((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.25</span><span class="s1">))</span>

        <span class="s2"># Cases which were failing (gh-10899)</span>
        <span class="s1">x = np.eye(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">y = np.ones(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">&quot;ji,i-&gt;&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">optimize=optimize)</span><span class="s0">,</span>
                           <span class="s1">[</span><span class="s4">2.</span><span class="s1">])  </span><span class="s2"># contig_contig_outstride0_two</span>
        <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">&quot;i,ij-&gt;&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">optimize=optimize)</span><span class="s0">,</span>
                           <span class="s1">[</span><span class="s4">2.</span><span class="s1">])  </span><span class="s2"># stride0_contig_outstride0_two</span>
        <span class="s1">assert_array_equal(np.einsum(</span><span class="s3">&quot;ij,i-&gt;&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">optimize=optimize)</span><span class="s0">,</span>
                           <span class="s1">[</span><span class="s4">2.</span><span class="s1">])  </span><span class="s2"># contig_stride0_outstride0_two</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int8(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'i1'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint8(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'u1'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int16(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'i2'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint16(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'u2'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int32(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'i4'</span><span class="s1">)</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'i4'</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint32(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'u4'</span><span class="s1">)</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'u4'</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int64(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'i8'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint64(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'u8'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_float16(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'f2'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_float32(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'f4'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_float64(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'f8'</span><span class="s1">)</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'f8'</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_longdouble(self):</span>
        <span class="s1">self.check_einsum_sums(np.longdouble)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_cfloat64(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'c8'</span><span class="s1">)</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'c8'</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_cfloat128(self):</span>
        <span class="s1">self.check_einsum_sums(</span><span class="s3">'c16'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_clongdouble(self):</span>
        <span class="s1">self.check_einsum_sums(np.clongdouble)</span>

    <span class="s0">def </span><span class="s1">test_einsum_misc(self):</span>
        <span class="s2"># This call used to crash because of a bug in</span>
        <span class="s2"># PyArray_AssignZero</span>
        <span class="s1">a = np.ones((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">b = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ij...,j...-&gt;i...'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">[[[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]])</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ij...,j...-&gt;i...'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[[[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]])</span>

        <span class="s2"># Regression test for issue #10369 (test unicode inputs with Python 2)</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">u'ij...,j...-&gt;i...'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">[[[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]])</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'...i,...i'</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">u'...i,...i'</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'...i,...i'</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
                               <span class="s1">optimize=</span><span class="s3">u'greedy'</span><span class="s1">)</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span>

        <span class="s2"># The iterator had an issue with buffering this reduction</span>
        <span class="s1">a = np.ones((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int64)</span>
        <span class="s1">b = np.ones((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int64)</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ijklm,ijn,ijn-&gt;'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">,</span>
                     <span class="s1">np.einsum(</span><span class="s3">'ijklm,ijn-&gt;'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b))</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ijklm,ijn,ijn-&gt;'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
                     <span class="s1">np.einsum(</span><span class="s3">'ijklm,ijn-&gt;'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">))</span>

        <span class="s2"># Issue #2027, was a problem in the contiguous 3-argument</span>
        <span class="s2"># inner loop implementation</span>
        <span class="s1">a = np.arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">b = np.arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">c = np.arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">9</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'x,yx,zx-&gt;xzy'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">,</span>
                     <span class="s1">[[[</span><span class="s4">1</span><span class="s0">,  </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">,  </span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">21</span><span class="s1">]]</span><span class="s0">,</span>
                     <span class="s1">[[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">16</span><span class="s0">, </span><span class="s4">32</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">24</span><span class="s0">, </span><span class="s4">48</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">32</span><span class="s0">, </span><span class="s4">64</span><span class="s1">]]])</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'x,yx,zx-&gt;xzy'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
                     <span class="s1">[[[</span><span class="s4">1</span><span class="s0">,  </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">,  </span><span class="s4">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">15</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">21</span><span class="s1">]]</span><span class="s0">,</span>
                     <span class="s1">[[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">16</span><span class="s0">, </span><span class="s4">32</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">24</span><span class="s0">, </span><span class="s4">48</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">32</span><span class="s0">, </span><span class="s4">64</span><span class="s1">]]])</span>

        <span class="s2"># Ensure explicitly setting out=None does not cause an error</span>
        <span class="s2"># see issue gh-15776 and issue gh-15256</span>
        <span class="s1">assert_equal(np.einsum(</span><span class="s3">'i,j'</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">out=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">2</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_subscript_range(self):</span>
        <span class="s2"># Issue #7741, make sure that all letters of Latin alphabet (both uppercase &amp; lowercase) can be used</span>
        <span class="s2"># when creating a subscript from arrays</span>
        <span class="s1">a = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">b = np.ones((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">20</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">27</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">27</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">51</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">51</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: np.einsum(a</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">52</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">52</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">))</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: np.einsum(a</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_einsum_broadcast(self):</span>
        <span class="s2"># Issue #2455 change in handling ellipsis</span>
        <span class="s2"># remove the 'middle broadcast' error</span>
        <span class="s2"># only use the 'RIGHT' iteration in prepare_op_axes</span>
        <span class="s2"># adds auto broadcast on left where it belongs</span>
        <span class="s2"># broadcast on right has to be explicit</span>
        <span class="s2"># We need to test the optimized parsing as well</span>

        <span class="s1">A = np.arange(</span><span class="s4">2 </span><span class="s1">* </span><span class="s4">3 </span><span class="s1">* </span><span class="s4">4</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">B = np.arange(</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">ref = np.einsum(</span><span class="s3">'ijk,j-&gt;ijk'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ij...,j...-&gt;ij...'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ij...,...j-&gt;ij...'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ij...,j-&gt;ij...'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)  </span><span class="s2"># used to raise error</span>

        <span class="s1">A = np.arange(</span><span class="s4">12</span><span class="s1">).reshape((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">B = np.arange(</span><span class="s4">6</span><span class="s1">).reshape((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">ref = np.einsum(</span><span class="s3">'ik,kj-&gt;ij'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ik...,k...-&gt;i...'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ik...,...kj-&gt;i...j'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'...k,kj'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)  </span><span class="s2"># used to raise error</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ik,k...-&gt;i...'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)  </span><span class="s2"># used to raise error</span>

        <span class="s1">dims = [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span>
        <span class="s1">a = np.arange(np.prod(dims)).reshape(dims)</span>
        <span class="s1">v = np.arange(dims[</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">ref = np.einsum(</span><span class="s3">'ijkl,k-&gt;ijl'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'ijkl,k'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'...kl,k'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)  </span><span class="s2"># used to raise error</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'...kl,k...'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)</span>

        <span class="s1">J</span><span class="s0">, </span><span class="s1">K</span><span class="s0">, </span><span class="s1">M = </span><span class="s4">160</span><span class="s0">, </span><span class="s4">160</span><span class="s0">, </span><span class="s4">120</span>
        <span class="s1">A = np.arange(J * K * M).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">J</span><span class="s0">, </span><span class="s1">K</span><span class="s0">, </span><span class="s1">M)</span>
        <span class="s1">B = np.arange(J * K * M * </span><span class="s4">3</span><span class="s1">).reshape(J</span><span class="s0">, </span><span class="s1">K</span><span class="s0">, </span><span class="s1">M</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">ref = np.einsum(</span><span class="s3">'...lmn,...lmno-&gt;...o'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">assert_equal(np.einsum(</span><span class="s3">'...lmn,lmno-&gt;...o'</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">,</span>
                                   <span class="s1">optimize=opt)</span><span class="s0">, </span><span class="s1">ref)  </span><span class="s2"># used to raise error</span>

    <span class="s0">def </span><span class="s1">test_einsum_fixedstridebug(self):</span>
        <span class="s2"># Issue #4485 obscure einsum bug</span>
        <span class="s2"># This case revealed a bug in nditer where it reported a stride</span>
        <span class="s2"># as 'fixed' (0) when it was in fact not fixed during processing</span>
        <span class="s2"># (0 or 4). The reason for the bug was that the check for a fixed</span>
        <span class="s2"># stride was using the information from the 2D inner loop reuse</span>
        <span class="s2"># to restrict the iteration dimensions it had to validate to be</span>
        <span class="s2"># the same, but that 2D inner loop reuse logic is only triggered</span>
        <span class="s2"># during the buffer copying step, and hence it was invalid to</span>
        <span class="s2"># rely on those values. The fix is to check all the dimensions</span>
        <span class="s2"># of the stride in question, which in the test case reveals that</span>
        <span class="s2"># the stride is not fixed.</span>
        <span class="s2">#</span>
        <span class="s2"># NOTE: This test is triggered by the fact that the default buffersize,</span>
        <span class="s2">#       used by einsum, is 8192, and 3*2731 = 8193, is larger than that</span>
        <span class="s2">#       and results in a mismatch between the buffering and the</span>
        <span class="s2">#       striding for operand A.</span>
        <span class="s1">A = np.arange(</span><span class="s4">2 </span><span class="s1">* </span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).astype(np.float32)</span>
        <span class="s1">B = np.arange(</span><span class="s4">2 </span><span class="s1">* </span><span class="s4">3 </span><span class="s1">* </span><span class="s4">2731</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2731</span><span class="s1">).astype(np.int16)</span>
        <span class="s1">es = np.einsum(</span><span class="s3">'cl, cpx-&gt;lpx'</span><span class="s0">,  </span><span class="s1">A</span><span class="s0">,  </span><span class="s1">B)</span>
        <span class="s1">tp = np.tensordot(A</span><span class="s0">,  </span><span class="s1">B</span><span class="s0">,  </span><span class="s1">axes=(</span><span class="s4">0</span><span class="s0">,  </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(es</span><span class="s0">,  </span><span class="s1">tp)</span>
        <span class="s2"># The following is the original test case from the bug report,</span>
        <span class="s2"># made repeatable by changing random arrays to aranges.</span>
        <span class="s1">A = np.arange(</span><span class="s4">3 </span><span class="s1">* </span><span class="s4">3</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">).astype(np.float64)</span>
        <span class="s1">B = np.arange(</span><span class="s4">3 </span><span class="s1">* </span><span class="s4">3 </span><span class="s1">* </span><span class="s4">64 </span><span class="s1">* </span><span class="s4">64</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">64</span><span class="s0">, </span><span class="s4">64</span><span class="s1">).astype(np.float32)</span>
        <span class="s1">es = np.einsum(</span><span class="s3">'cl, cpxy-&gt;lpxy'</span><span class="s0">,  </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">tp = np.tensordot(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">,  </span><span class="s1">axes=(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(es</span><span class="s0">, </span><span class="s1">tp)</span>

    <span class="s0">def </span><span class="s1">test_einsum_fixed_collapsingbug(self):</span>
        <span class="s2"># Issue #5147.</span>
        <span class="s2"># The bug only occurred when output argument of einssum was used.</span>
        <span class="s1">x = np.random.normal(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">y1 = np.zeros((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">np.einsum(</span><span class="s3">'aabb-&gt;ab'</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">out=y1)</span>
        <span class="s1">idx = np.arange(</span><span class="s4">5</span><span class="s1">)</span>
        <span class="s1">y2 = x[idx[:</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">idx[:</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">idx]</span>
        <span class="s1">assert_equal(y1</span><span class="s0">, </span><span class="s1">y2)</span>

    <span class="s0">def </span><span class="s1">test_einsum_failed_on_p9_and_s390x(self):</span>
        <span class="s2"># Issues gh-14692 and gh-12689</span>
        <span class="s2"># Bug with signed vs unsigned char errored on power9 and s390x Linux</span>
        <span class="s1">tensor = np.random.random_sample((</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
        <span class="s1">x = np.einsum(</span><span class="s3">'ijij-&gt;'</span><span class="s0">, </span><span class="s1">tensor)</span>
        <span class="s1">y = tensor.trace(axis1=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s4">2</span><span class="s1">).trace()</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s0">def </span><span class="s1">test_einsum_all_contig_non_contig_output(self):</span>
        <span class="s2"># Issue gh-5907, tests that the all contiguous special case</span>
        <span class="s2"># actually checks the contiguity of the output</span>
        <span class="s1">x = np.ones((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">out = np.ones(</span><span class="s4">10</span><span class="s1">)[::</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">correct_base = np.ones(</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s1">correct_base[::</span><span class="s4">2</span><span class="s1">] = </span><span class="s4">5</span>
        <span class="s2"># Always worked (inner iteration is done with 0-stride):</span>
        <span class="s1">np.einsum(</span><span class="s3">'mi,mi,mi-&gt;m'</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">out=out)</span>
        <span class="s1">assert_array_equal(out.base</span><span class="s0">, </span><span class="s1">correct_base)</span>
        <span class="s2"># Example 1:</span>
        <span class="s1">out = np.ones(</span><span class="s4">10</span><span class="s1">)[::</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">np.einsum(</span><span class="s3">'im,im,im-&gt;m'</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">out=out)</span>
        <span class="s1">assert_array_equal(out.base</span><span class="s0">, </span><span class="s1">correct_base)</span>
        <span class="s2"># Example 2, buffering causes x to be contiguous but</span>
        <span class="s2"># special cases do not catch the operation before:</span>
        <span class="s1">out = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))[...</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">correct_base = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">correct_base[...</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = </span><span class="s4">2</span>
        <span class="s1">x = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.float32)</span>
        <span class="s1">np.einsum(</span><span class="s3">'ij,jk-&gt;ik'</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">out=out)</span>
        <span class="s1">assert_array_equal(out.base</span><span class="s0">, </span><span class="s1">correct_base)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">,</span>
             <span class="s1">np.typecodes[</span><span class="s3">&quot;AllFloat&quot;</span><span class="s1">] + np.typecodes[</span><span class="s3">&quot;AllInteger&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_different_paths(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s2"># Test originally added to cover broken float16 path: gh-20305</span>
        <span class="s2"># Likely most are covered elsewhere, at least partially.</span>
        <span class="s1">dtype = np.dtype(dtype)</span>
        <span class="s2"># Simple test, designed to excersize most specialized code paths,</span>
        <span class="s2"># note the +0.5 for floats.  This makes sure we use a float value</span>
        <span class="s2"># where the results must be exact.</span>
        <span class="s1">arr = (np.arange(</span><span class="s4">7</span><span class="s1">) + </span><span class="s4">0.5</span><span class="s1">).astype(dtype)</span>
        <span class="s1">scalar = np.array(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

        <span class="s2"># contig -&gt; scalar:</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'i-&gt;'</span><span class="s0">, </span><span class="s1">arr)</span>
        <span class="s0">assert </span><span class="s1">res == arr.sum()</span>
        <span class="s2"># contig, contig -&gt; contig:</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'i,i-&gt;i'</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">arr)</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">arr * arr)</span>
        <span class="s2"># noncontig, noncontig -&gt; contig:</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'i,i-&gt;i'</span><span class="s0">, </span><span class="s1">arr.repeat(</span><span class="s4">2</span><span class="s1">)[::</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">arr.repeat(</span><span class="s4">2</span><span class="s1">)[::</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">arr * arr)</span>
        <span class="s2"># contig + contig -&gt; scalar</span>
        <span class="s0">assert </span><span class="s1">np.einsum(</span><span class="s3">'i,i-&gt;'</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">arr) == (arr * arr).sum()</span>
        <span class="s2"># contig + scalar -&gt; contig (with out)</span>
        <span class="s1">out = np.ones(</span><span class="s4">7</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'i,-&gt;i'</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">dtype.type(</span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">out=out)</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">arr * dtype.type(</span><span class="s4">2</span><span class="s1">))</span>
        <span class="s2"># scalar + contig -&gt; contig (with out)</span>
        <span class="s1">res = np.einsum(</span><span class="s3">',i-&gt;i'</span><span class="s0">, </span><span class="s1">scalar</span><span class="s0">, </span><span class="s1">arr)</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">arr * dtype.type(</span><span class="s4">2</span><span class="s1">))</span>
        <span class="s2"># scalar + contig -&gt; scalar</span>
        <span class="s1">res = np.einsum(</span><span class="s3">',i-&gt;'</span><span class="s0">, </span><span class="s1">scalar</span><span class="s0">, </span><span class="s1">arr)</span>
        <span class="s2"># Use einsum to compare to not have difference due to sum round-offs:</span>
        <span class="s0">assert </span><span class="s1">res == np.einsum(</span><span class="s3">'i-&gt;'</span><span class="s0">, </span><span class="s1">scalar * arr)</span>
        <span class="s2"># contig + scalar -&gt; scalar</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'i,-&gt;'</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">scalar)</span>
        <span class="s2"># Use einsum to compare to not have difference due to sum round-offs:</span>
        <span class="s0">assert </span><span class="s1">res == np.einsum(</span><span class="s3">'i-&gt;'</span><span class="s0">, </span><span class="s1">scalar * arr)</span>
        <span class="s2"># contig + contig + contig -&gt; scalar</span>
        <span class="s1">arr = np.array([</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">4.5</span><span class="s0">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'i,i,i-&gt;'</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">arr)</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">(arr * arr * arr).sum())</span>
        <span class="s2"># four arrays:</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'i,i,i,i-&gt;'</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">arr)</span>
        <span class="s1">assert_array_equal(res</span><span class="s0">, </span><span class="s1">(arr * arr * arr * arr).sum())</span>

    <span class="s0">def </span><span class="s1">test_small_boolean_arrays(self):</span>
        <span class="s2"># See gh-5946.</span>
        <span class="s2"># Use array of True embedded in False.</span>
        <span class="s1">a = np.zeros((</span><span class="s4">16</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.bool_)[:</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">a[...] = </span><span class="s0">True</span>
        <span class="s1">out = np.zeros((</span><span class="s4">16</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.bool_)[:</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">tgt = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.bool_)</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'...ij,...jk-&gt;...ik'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">out=out)</span>
        <span class="s1">assert_equal(res</span><span class="s0">, </span><span class="s1">tgt)</span>

    <span class="s0">def </span><span class="s1">test_out_is_res(self):</span>
        <span class="s1">a = np.arange(</span><span class="s4">9</span><span class="s1">).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">res = np.einsum(</span><span class="s3">'...ij,...jk-&gt;...ik'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">out=a)</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s0">is </span><span class="s1">a</span>

    <span class="s0">def </span><span class="s1">optimize_compare(self</span><span class="s0">, </span><span class="s1">subscripts</span><span class="s0">, </span><span class="s1">operands=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s2"># Tests all paths of the optimization function against</span>
        <span class="s2"># conventional einsum</span>
        <span class="s0">if </span><span class="s1">operands </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">args = [subscripts]</span>
            <span class="s1">terms = subscripts.split(</span><span class="s3">'-&gt;'</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">].split(</span><span class="s3">','</span><span class="s1">)</span>
            <span class="s0">for </span><span class="s1">term </span><span class="s0">in </span><span class="s1">terms:</span>
                <span class="s1">dims = [global_size_dict[x] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">term]</span>
                <span class="s1">args.append(np.random.rand(*dims))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">args = [subscripts] + operands</span>

        <span class="s1">noopt = np.einsum(*args</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">opt = np.einsum(*args</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(opt</span><span class="s0">, </span><span class="s1">noopt)</span>
        <span class="s1">opt = np.einsum(*args</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(opt</span><span class="s0">, </span><span class="s1">noopt)</span>

    <span class="s0">def </span><span class="s1">test_hadamard_like_products(self):</span>
        <span class="s2"># Hadamard outer products</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'a,ab,abc-&gt;abc'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'a,b,ab-&gt;ab'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_index_transformations(self):</span>
        <span class="s2"># Simple index transformation cases</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ea,fb,gc,hd,abcd-&gt;efgh'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ea,fb,abcd,gc,hd-&gt;efgh'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abcd,ea,fb,gc,hd-&gt;efgh'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_complex(self):</span>
        <span class="s2"># Long test cases</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'acdf,jbje,gihb,hfac,gfac,gifabc,hfac'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'acdf,jbje,gihb,hfac,gfac,gifabc,hfac'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'cd,bdhe,aidb,hgca,gc,hgibcd,hgac'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abhe,hidj,jgba,hiab,gab'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bde,cdh,agdb,hica,ibd,hgicd,hiac'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'chd,bde,agbc,hiad,hgc,hgi,hiad'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'chd,bde,agbc,hiad,bdi,cgh,agdb'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bdhe,acad,hiab,agac,hibd'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_collapse(self):</span>
        <span class="s2"># Inner products</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ab,c-&gt;'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ab,c-&gt;c'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ab,cd,cd-&gt;'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ab,cd,cd-&gt;ac'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ab,cd,cd-&gt;cd'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ab,cd,cd,ef,ef-&gt;'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_expand(self):</span>
        <span class="s2"># Outer products</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,cd,ef-&gt;abcdef'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,cd,ef-&gt;acdf'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,cd,de-&gt;abcde'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,cd,de-&gt;be'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,bcd,cd-&gt;abcd'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,bcd,cd-&gt;abd'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_edge_cases(self):</span>
        <span class="s2"># Difficult edge cases for optimization</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'eb,cb,fb-&gt;cef'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'dd,fb,be,cdb-&gt;cef'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bca,cdb,dbf,afc-&gt;'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'dcc,fce,ea,dbf-&gt;ab'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'fdf,cdd,ccd,afe-&gt;ae'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abcd,ad'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ed,fcd,ff,bcf-&gt;be'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'baa,dcf,af,cde-&gt;be'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bd,db,eac-&gt;ace'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'fff,fae,bef,def-&gt;abd'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'efc,dbc,acf,fd-&gt;abe'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ba,ac,da-&gt;bcd'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_inner_product(self):</span>
        <span class="s2"># Inner products</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ab'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ab,ba'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abc,abc'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abc,bac'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abc,cba'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_random_cases(self):</span>
        <span class="s2"># Randomly built test cases</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'aab,fa,df,ecc-&gt;bde'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ecb,fef,bad,ed-&gt;ac'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bcf,bbb,fbf,fc-&gt;'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bb,ff,be-&gt;e'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bcb,bb,fc,fff-&gt;'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'fbb,dfd,fc,fc-&gt;'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'afd,ba,cc,dc-&gt;bf'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'adb,bc,fa,cfc-&gt;d'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'bbd,bda,fc,db-&gt;acf'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'dba,ead,cad-&gt;bce'</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'aef,fbc,dca-&gt;bde'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_combined_views_mapping(self):</span>
        <span class="s2"># gh-10792</span>
        <span class="s1">a = np.arange(</span><span class="s4">9</span><span class="s1">).reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">b = np.einsum(</span><span class="s3">'bbcdc-&gt;d'</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s1">[</span><span class="s4">12</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_broadcasting_dot_cases(self):</span>
        <span class="s2"># Ensures broadcasting cases are not mistaken for GEMM</span>

        <span class="s1">a = np.random.rand(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">b = np.random.rand(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
        <span class="s1">c = np.random.rand(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
        <span class="s1">d = np.random.rand(</span><span class="s4">10</span><span class="s1">)</span>

        <span class="s1">self.optimize_compare(</span><span class="s3">'ijk,kl,jl'</span><span class="s0">, </span><span class="s1">operands=[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c])</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'ijk,kl,jl,i-&gt;i'</span><span class="s0">, </span><span class="s1">operands=[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d])</span>

        <span class="s1">e = np.random.rand(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">f = np.random.rand(</span><span class="s4">7</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abjk,kl,jl'</span><span class="s0">, </span><span class="s1">operands=[e</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c])</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'abjk,kl,jl,ab-&gt;ab'</span><span class="s0">, </span><span class="s1">operands=[e</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f])</span>

        <span class="s2"># Edge case found in gh-11308</span>
        <span class="s1">g = np.arange(</span><span class="s4">64</span><span class="s1">).reshape(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)</span>
        <span class="s1">self.optimize_compare(</span><span class="s3">'obk,ijk-&gt;ioj'</span><span class="s0">, </span><span class="s1">operands=[g</span><span class="s0">, </span><span class="s1">g])</span>

    <span class="s0">def </span><span class="s1">test_output_order(self):</span>
        <span class="s2"># Ensure output order is respected for optimize cases, the below</span>
        <span class="s2"># conraction should yield a reshaped tensor view</span>
        <span class="s2"># gh-16415</span>

        <span class="s1">a = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">b = np.ones((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">tmp = np.einsum(</span><span class="s3">'...ft,mf-&gt;...mt'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">optimize=opt)</span>
            <span class="s1">assert_(tmp.flags.f_contiguous)</span>

            <span class="s1">tmp = np.einsum(</span><span class="s3">'...ft,mf-&gt;...mt'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'f'</span><span class="s0">, </span><span class="s1">optimize=opt)</span>
            <span class="s1">assert_(tmp.flags.f_contiguous)</span>

            <span class="s1">tmp = np.einsum(</span><span class="s3">'...ft,mf-&gt;...mt'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'c'</span><span class="s0">, </span><span class="s1">optimize=opt)</span>
            <span class="s1">assert_(tmp.flags.c_contiguous)</span>

            <span class="s1">tmp = np.einsum(</span><span class="s3">'...ft,mf-&gt;...mt'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'k'</span><span class="s0">, </span><span class="s1">optimize=opt)</span>
            <span class="s1">assert_(tmp.flags.c_contiguous </span><span class="s0">is False</span><span class="s1">)</span>
            <span class="s1">assert_(tmp.flags.f_contiguous </span><span class="s0">is False</span><span class="s1">)</span>

            <span class="s1">tmp = np.einsum(</span><span class="s3">'...ft,mf-&gt;...mt'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">optimize=opt)</span>
            <span class="s1">assert_(tmp.flags.c_contiguous </span><span class="s0">is False</span><span class="s1">)</span>
            <span class="s1">assert_(tmp.flags.f_contiguous </span><span class="s0">is False</span><span class="s1">)</span>

        <span class="s1">c = np.ones((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'C'</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">tmp = np.einsum(</span><span class="s3">'...ft,mf-&gt;...mt'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">optimize=opt)</span>
            <span class="s1">assert_(tmp.flags.c_contiguous)</span>

        <span class="s1">d = np.ones((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'C'</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]:</span>
            <span class="s1">tmp = np.einsum(</span><span class="s3">'...ft,mf-&gt;...mt'</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">optimize=opt)</span>
            <span class="s1">assert_(tmp.flags.c_contiguous)</span>

<span class="s0">class </span><span class="s1">TestEinsumPath:</span>
    <span class="s0">def </span><span class="s1">build_operands(self</span><span class="s0">, </span><span class="s1">string</span><span class="s0">, </span><span class="s1">size_dict=global_size_dict):</span>

        <span class="s2"># Builds views based off initial operands</span>
        <span class="s1">operands = [string]</span>
        <span class="s1">terms = string.split(</span><span class="s3">'-&gt;'</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">].split(</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">term </span><span class="s0">in </span><span class="s1">terms:</span>
            <span class="s1">dims = [size_dict[x] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">term]</span>
            <span class="s1">operands.append(np.random.rand(*dims))</span>

        <span class="s0">return </span><span class="s1">operands</span>

    <span class="s0">def </span><span class="s1">assert_path_equal(self</span><span class="s0">, </span><span class="s1">comp</span><span class="s0">, </span><span class="s1">benchmark):</span>
        <span class="s2"># Checks if list of tuples are equivalent</span>
        <span class="s1">ret = (len(comp) == len(benchmark))</span>
        <span class="s1">assert_(ret)</span>
        <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">range(len(comp) - </span><span class="s4">1</span><span class="s1">):</span>
            <span class="s1">ret &amp;= isinstance(comp[pos + </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">tuple)</span>
            <span class="s1">ret &amp;= (comp[pos + </span><span class="s4">1</span><span class="s1">] == benchmark[pos + </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_(ret)</span>

    <span class="s0">def </span><span class="s1">test_memory_contraints(self):</span>
        <span class="s2"># Ensure memory constraints are satisfied</span>

        <span class="s1">outer_test = self.build_operands(</span><span class="s3">'a,b,c-&gt;abc'</span><span class="s1">)</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*outer_test</span><span class="s0">, </span><span class="s1">optimize=(</span><span class="s3">'greedy'</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*outer_test</span><span class="s0">, </span><span class="s1">optimize=(</span><span class="s3">'optimal'</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)])</span>

        <span class="s1">long_test = self.build_operands(</span><span class="s3">'acdf,jbje,gihb,hfac'</span><span class="s1">)</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*long_test</span><span class="s0">, </span><span class="s1">optimize=(</span><span class="s3">'greedy'</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*long_test</span><span class="s0">, </span><span class="s1">optimize=(</span><span class="s3">'optimal'</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_long_paths(self):</span>
        <span class="s2"># Long complex cases</span>

        <span class="s2"># Long test 1</span>
        <span class="s1">long_test1 = self.build_operands(</span><span class="s3">'acdf,jbje,gihb,hfac,gfac,gifabc,hfac'</span><span class="s1">)</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*long_test1</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">,</span>
                                      <span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*long_test1</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">,</span>
                                      <span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s2"># Long test 2</span>
        <span class="s1">long_test2 = self.build_operands(</span><span class="s3">'chd,bde,agbc,hiad,bdi,cgh,agdb'</span><span class="s1">)</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*long_test2</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">print(path)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">,</span>
                                      <span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*long_test2</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">print(path)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">,</span>
                                      <span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_edge_paths(self):</span>
        <span class="s2"># Difficult edge cases</span>

        <span class="s2"># Edge test1</span>
        <span class="s1">edge_test1 = self.build_operands(</span><span class="s3">'eb,cb,fb-&gt;cef'</span><span class="s1">)</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test1</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test1</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s2"># Edge test2</span>
        <span class="s1">edge_test2 = self.build_operands(</span><span class="s3">'dd,fb,be,cdb-&gt;cef'</span><span class="s1">)</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test2</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test2</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s2"># Edge test3</span>
        <span class="s1">edge_test3 = self.build_operands(</span><span class="s3">'bca,cdb,dbf,afc-&gt;'</span><span class="s1">)</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test3</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test3</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s2"># Edge test4</span>
        <span class="s1">edge_test4 = self.build_operands(</span><span class="s3">'dcc,fce,ea,dbf-&gt;ab'</span><span class="s1">)</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test4</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test4</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s2"># Edge test5</span>
        <span class="s1">edge_test4 = self.build_operands(</span><span class="s3">'a,ac,ab,ad,cd,bd,bc-&gt;'</span><span class="s0">,</span>
                                         <span class="s1">size_dict={</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">20</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">20</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s4">20</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s4">20</span><span class="s1">})</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test4</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'greedy'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*edge_test4</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s3">'optimal'</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_path_type_input(self):</span>
        <span class="s2"># Test explicit path handling</span>
        <span class="s1">path_test = self.build_operands(</span><span class="s3">'dcc,fce,ea,dbf-&gt;ab'</span><span class="s1">)</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*path_test</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)])</span>

        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*path_test</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])</span>

        <span class="s1">exp_path = [</span><span class="s3">'einsum_path'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span>
        <span class="s1">path</span><span class="s0">, </span><span class="s1">path_str = np.einsum_path(*path_test</span><span class="s0">, </span><span class="s1">optimize=exp_path)</span>
        <span class="s1">self.assert_path_equal(path</span><span class="s0">, </span><span class="s1">exp_path)</span>

        <span class="s2"># Double check einsum works on the input path</span>
        <span class="s1">noopt = np.einsum(*path_test</span><span class="s0">, </span><span class="s1">optimize=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">opt = np.einsum(*path_test</span><span class="s0">, </span><span class="s1">optimize=exp_path)</span>
        <span class="s1">assert_almost_equal(noopt</span><span class="s0">, </span><span class="s1">opt)</span>

    <span class="s0">def </span><span class="s1">test_spaces(self):</span>
        <span class="s2">#gh-10794</span>
        <span class="s1">arr = np.array([[</span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s0">for </span><span class="s1">sp </span><span class="s0">in </span><span class="s1">itertools.product([</span><span class="s3">''</span><span class="s0">, </span><span class="s3">' '</span><span class="s1">]</span><span class="s0">, </span><span class="s1">repeat=</span><span class="s4">4</span><span class="s1">):</span>
            <span class="s2"># no error for any spacing</span>
            <span class="s1">np.einsum(</span><span class="s3">'{}...a{}-&gt;{}...a{}'</span><span class="s1">.format(*sp)</span><span class="s0">, </span><span class="s1">arr)</span>

<span class="s0">def </span><span class="s1">test_overlap():</span>
    <span class="s1">a = np.arange(</span><span class="s4">9</span><span class="s0">, </span><span class="s1">dtype=int).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">b = np.arange(</span><span class="s4">9</span><span class="s0">, </span><span class="s1">dtype=int).reshape(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">d = np.dot(a</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s2"># sanity check</span>
    <span class="s1">c = np.einsum(</span><span class="s3">'ij,jk-&gt;ik'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s1">assert_equal(c</span><span class="s0">, </span><span class="s1">d)</span>
    <span class="s2">#gh-10080, out overlaps one of the operands</span>
    <span class="s1">c = np.einsum(</span><span class="s3">'ij,jk-&gt;ik'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">out=b)</span>
    <span class="s1">assert_equal(c</span><span class="s0">, </span><span class="s1">d)</span>
</pre>
</body>
</html>