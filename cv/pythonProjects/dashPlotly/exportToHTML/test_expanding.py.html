<html>
<head>
<title>test_expanding.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_expanding.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.errors </span><span class="s0">import </span><span class="s1">UnsupportedFunctionCall</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">DatetimeIndex</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">isna</span><span class="s0">,</span>
    <span class="s1">notna</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.core.window </span><span class="s0">import </span><span class="s1">Expanding</span>


<span class="s0">def </span><span class="s1">test_doc_string():</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]})</span>
    <span class="s1">df</span>
    <span class="s1">df.expanding(</span><span class="s3">2</span><span class="s1">).sum()</span>


<span class="s1">@pytest.mark.filterwarnings(</span>
    <span class="s2">&quot;ignore:The `center` argument on `expanding` will be removed in the future&quot;</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_constructor(frame_or_series):</span>
    <span class="s4"># GH 12669</span>

    <span class="s1">c = frame_or_series(range(</span><span class="s3">5</span><span class="s1">)).expanding</span>

    <span class="s4"># valid</span>
    <span class="s1">c(min_periods=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">c(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">c(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">2</span><span class="s1">])])</span>
<span class="s1">@pytest.mark.filterwarnings(</span>
    <span class="s2">&quot;ignore:The `center` argument on `expanding` will be removed in the future&quot;</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_constructor_invalid(frame_or_series</span><span class="s0">, </span><span class="s1">w):</span>
    <span class="s4"># not valid</span>

    <span class="s1">c = frame_or_series(range(</span><span class="s3">5</span><span class="s1">)).expanding</span>
    <span class="s1">msg = </span><span class="s2">&quot;min_periods must be an integer&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">c(min_periods=w)</span>

    <span class="s1">msg = </span><span class="s2">&quot;center must be a boolean&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">c(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">center=w)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;std&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;var&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_numpy_compat(method):</span>
    <span class="s4"># see gh-12811</span>
    <span class="s1">e = Expanding(Series([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]))</span>

    <span class="s1">msg = </span><span class="s2">&quot;numpy operations are not valid with window objects&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(UnsupportedFunctionCall</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">getattr(e</span><span class="s0">, </span><span class="s1">method)(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(UnsupportedFunctionCall</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">getattr(e</span><span class="s0">, </span><span class="s1">method)(dtype=np.float64)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;expander&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s2">&quot;ls&quot;</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.xfail(</span>
                <span class="s1">reason=</span><span class="s2">&quot;GH#16425 expanding with offset not supported&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_empty_df_expanding(expander):</span>
    <span class="s4"># GH 15819 Verifies that datetime and integer expanding windows can be</span>
    <span class="s4"># applied to empty DataFrames</span>

    <span class="s1">expected = DataFrame()</span>
    <span class="s1">result = DataFrame().expanding(expander).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># Verifies that datetime and integer expanding windows can be applied</span>
    <span class="s4"># to empty DataFrames with datetime index</span>
    <span class="s1">expected = DataFrame(index=DatetimeIndex([]))</span>
    <span class="s1">result = DataFrame(index=DatetimeIndex([])).expanding(expander).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_missing_minp_zero():</span>
    <span class="s4"># https://github.com/pandas-dev/pandas/pull/18921</span>
    <span class="s4"># minp=0</span>
    <span class="s1">x = Series([np.nan])</span>
    <span class="s1">result = x.expanding(min_periods=</span><span class="s3">0</span><span class="s1">).sum()</span>
    <span class="s1">expected = Series([</span><span class="s3">0.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># minp=1</span>
    <span class="s1">result = x.expanding(min_periods=</span><span class="s3">1</span><span class="s1">).sum()</span>
    <span class="s1">expected = Series([np.nan])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_axis(axis_frame):</span>
    <span class="s4"># see gh-23372.</span>
    <span class="s1">df = DataFrame(np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)))</span>
    <span class="s1">axis = df._get_axis_number(axis_frame)</span>

    <span class="s0">if </span><span class="s1">axis == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">{i: [np.nan] * </span><span class="s3">2 </span><span class="s1">+ [float(j) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">20</span><span class="s1">)}</span>
        <span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># axis == 1</span>
        <span class="s1">expected = DataFrame([[np.nan] * </span><span class="s3">2 </span><span class="s1">+ [float(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">21</span><span class="s1">)]] * </span><span class="s3">10</span><span class="s1">)</span>

    <span class="s1">result = df.expanding(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis=axis_frame).sum()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_count_with_min_periods(frame_or_series):</span>
    <span class="s4"># GH 26996</span>
    <span class="s1">result = frame_or_series(range(</span><span class="s3">5</span><span class="s1">)).expanding(min_periods=</span><span class="s3">3</span><span class="s1">).count()</span>
    <span class="s1">expected = frame_or_series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_count_default_min_periods_with_null_values(frame_or_series):</span>
    <span class="s4"># GH 26996</span>
    <span class="s1">values = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span>
    <span class="s1">expected_counts = [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">]</span>

    <span class="s1">result = frame_or_series(values).expanding().count()</span>
    <span class="s1">expected = frame_or_series(expected_counts)</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_count_with_min_periods_exceeding_series_length(frame_or_series):</span>
    <span class="s4"># GH 25857</span>
    <span class="s1">result = frame_or_series(range(</span><span class="s3">5</span><span class="s1">)).expanding(min_periods=</span><span class="s3">6</span><span class="s1">).count()</span>
    <span class="s1">expected = frame_or_series([np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;df,expected,min_periods&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s1">]})</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(DataFrame()</span><span class="s0">, </span><span class="s1">[({}</span><span class="s0">, </span><span class="s1">[])]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">3</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_expanding_dataframe(df</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">min_periods):</span>
    <span class="s4"># GH 11704</span>
    <span class="s1">expected = [DataFrame(values</span><span class="s0">, </span><span class="s1">index=index) </span><span class="s0">for </span><span class="s1">(values</span><span class="s0">, </span><span class="s1">index) </span><span class="s0">in </span><span class="s1">expected]</span>

    <span class="s0">for </span><span class="s1">(expected</span><span class="s0">, </span><span class="s1">actual) </span><span class="s0">in </span><span class="s1">zip(expected</span><span class="s0">, </span><span class="s1">df.expanding(min_periods)):</span>
        <span class="s1">tm.assert_frame_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;ser,expected,min_periods&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[([np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">([np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(Series([]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_iter_expanding_series(ser</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">min_periods):</span>
    <span class="s4"># GH 11704</span>
    <span class="s1">expected = [Series(values</span><span class="s0">, </span><span class="s1">index=index) </span><span class="s0">for </span><span class="s1">(values</span><span class="s0">, </span><span class="s1">index) </span><span class="s0">in </span><span class="s1">expected]</span>

    <span class="s0">for </span><span class="s1">(expected</span><span class="s0">, </span><span class="s1">actual) </span><span class="s0">in </span><span class="s1">zip(expected</span><span class="s0">, </span><span class="s1">ser.expanding(min_periods)):</span>
        <span class="s1">tm.assert_series_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_center_deprecate_warning():</span>
    <span class="s4"># GH 20647</span>
    <span class="s1">df = DataFrame()</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
        <span class="s1">df.expanding(center=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning):</span>
        <span class="s1">df.expanding(center=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">df.expanding()</span>


<span class="s0">def </span><span class="s1">test_expanding_sem(frame_or_series):</span>
    <span class="s4"># GH: 26476</span>
    <span class="s1">obj = frame_or_series([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">result = obj.expanding().sem()</span>
    <span class="s0">if </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">DataFrame):</span>
        <span class="s1">result = Series(result[</span><span class="s3">0</span><span class="s1">].values)</span>
    <span class="s1">expected = Series([np.nan] + [</span><span class="s3">0.707107</span><span class="s1">] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;skew&quot;</span><span class="s0">, </span><span class="s2">&quot;kurt&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_expanding_skew_kurt_numerical_stability(method):</span>
    <span class="s4"># GH: 6929</span>
    <span class="s1">s = Series(np.random.rand(</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">expected = getattr(s.expanding(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">s = s + </span><span class="s3">5000</span>
    <span class="s1">result = getattr(s.expanding(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;window&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;average&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;pct&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;ascending&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;test_data&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;default&quot;</span><span class="s0">, </span><span class="s2">&quot;duplicates&quot;</span><span class="s0">, </span><span class="s2">&quot;nans&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rank(window</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">pct</span><span class="s0">, </span><span class="s1">ascending</span><span class="s0">, </span><span class="s1">test_data):</span>
    <span class="s1">length = </span><span class="s3">20</span>
    <span class="s0">if </span><span class="s1">test_data == </span><span class="s2">&quot;default&quot;</span><span class="s1">:</span>
        <span class="s1">ser = Series(data=np.random.rand(length))</span>
    <span class="s0">elif </span><span class="s1">test_data == </span><span class="s2">&quot;duplicates&quot;</span><span class="s1">:</span>
        <span class="s1">ser = Series(data=np.random.choice(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">length))</span>
    <span class="s0">elif </span><span class="s1">test_data == </span><span class="s2">&quot;nans&quot;</span><span class="s1">:</span>
        <span class="s1">ser = Series(</span>
            <span class="s1">data=np.random.choice([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.75</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">)</span>

    <span class="s1">expected = ser.expanding(window).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.rank(method=method</span><span class="s0">, </span><span class="s1">pct=pct</span><span class="s0">, </span><span class="s1">ascending=ascending).iloc[-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result = ser.expanding(window).rank(method=method</span><span class="s0">, </span><span class="s1">pct=pct</span><span class="s0">, </span><span class="s1">ascending=ascending)</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_corr(series):</span>
    <span class="s1">A = series.dropna()</span>
    <span class="s1">B = (A + np.random.randn(len(A)))[:-</span><span class="s3">5</span><span class="s1">]</span>

    <span class="s1">result = A.expanding().corr(B)</span>

    <span class="s1">rolling_result = A.rolling(window=len(A)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).corr(B)</span>

    <span class="s1">tm.assert_almost_equal(rolling_result</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_expanding_count(series):</span>
    <span class="s1">result = series.expanding(min_periods=</span><span class="s3">0</span><span class="s1">).count()</span>
    <span class="s1">tm.assert_almost_equal(</span>
        <span class="s1">result</span><span class="s0">, </span><span class="s1">series.rolling(window=len(series)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">0</span><span class="s1">).count()</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_expanding_quantile(series):</span>
    <span class="s1">result = series.expanding().quantile(</span><span class="s3">0.5</span><span class="s1">)</span>

    <span class="s1">rolling_result = series.rolling(window=len(series)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).quantile(</span><span class="s3">0.5</span><span class="s1">)</span>

    <span class="s1">tm.assert_almost_equal(result</span><span class="s0">, </span><span class="s1">rolling_result)</span>


<span class="s0">def </span><span class="s1">test_expanding_cov(series):</span>
    <span class="s1">A = series</span>
    <span class="s1">B = (A + np.random.randn(len(A)))[:-</span><span class="s3">5</span><span class="s1">]</span>

    <span class="s1">result = A.expanding().cov(B)</span>

    <span class="s1">rolling_result = A.rolling(window=len(A)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).cov(B)</span>

    <span class="s1">tm.assert_almost_equal(rolling_result</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_expanding_cov_pairwise(frame):</span>
    <span class="s1">result = frame.expanding().cov()</span>

    <span class="s1">rolling_result = frame.rolling(window=len(frame)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).cov()</span>

    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">rolling_result)</span>


<span class="s0">def </span><span class="s1">test_expanding_corr_pairwise(frame):</span>
    <span class="s1">result = frame.expanding().corr()</span>

    <span class="s1">rolling_result = frame.rolling(window=len(frame)</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).corr()</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">rolling_result)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func,static_comp&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">np.sum)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean&quot;</span><span class="s0">, lambda </span><span class="s1">x: np.mean(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, lambda </span><span class="s1">x: np.max(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, lambda </span><span class="s1">x: np.min(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">ids=[</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_expanding_func(func</span><span class="s0">, </span><span class="s1">static_comp</span><span class="s0">, </span><span class="s1">frame_or_series):</span>
    <span class="s1">data = frame_or_series(np.array(list(range(</span><span class="s3">10</span><span class="s1">)) + [np.nan] * </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">result = getattr(data.expanding(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">frame_or_series)</span>

    <span class="s1">expected = static_comp(data[:</span><span class="s3">11</span><span class="s1">])</span>
    <span class="s0">if </span><span class="s1">frame_or_series </span><span class="s0">is </span><span class="s1">Series:</span>
        <span class="s1">tm.assert_almost_equal(result[</span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">tm.assert_series_equal(result.iloc[</span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func,static_comp&quot;</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s1">np.sum)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">np.mean)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s1">np.max)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s1">np.min)]</span><span class="s0">,</span>
    <span class="s1">ids=[</span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;max&quot;</span><span class="s0">, </span><span class="s2">&quot;min&quot;</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_expanding_min_periods(func</span><span class="s0">, </span><span class="s1">static_comp):</span>
    <span class="s1">ser = Series(np.random.randn(</span><span class="s3">50</span><span class="s1">))</span>

    <span class="s1">result = getattr(ser.expanding(min_periods=</span><span class="s3">30</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s0">assert </span><span class="s1">result[:</span><span class="s3">29</span><span class="s1">].isna().all()</span>
    <span class="s1">tm.assert_almost_equal(result.iloc[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">static_comp(ser[:</span><span class="s3">50</span><span class="s1">]))</span>

    <span class="s4"># min_periods is working correctly</span>
    <span class="s1">result = getattr(ser.expanding(min_periods=</span><span class="s3">15</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s0">assert </span><span class="s1">isna(result.iloc[</span><span class="s3">13</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">notna(result.iloc[</span><span class="s3">14</span><span class="s1">])</span>

    <span class="s1">ser2 = Series(np.random.randn(</span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">result = getattr(ser2.expanding(min_periods=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s0">assert </span><span class="s1">isna(result[</span><span class="s3">3</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">notna(result[</span><span class="s3">4</span><span class="s1">])</span>

    <span class="s4"># min_periods=0</span>
    <span class="s1">result0 = getattr(ser.expanding(min_periods=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">result1 = getattr(ser.expanding(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">tm.assert_almost_equal(result0</span><span class="s0">, </span><span class="s1">result1)</span>

    <span class="s1">result = getattr(ser.expanding(min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">tm.assert_almost_equal(result.iloc[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">static_comp(ser[:</span><span class="s3">50</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_expanding_apply(engine_and_raw</span><span class="s0">, </span><span class="s1">frame_or_series):</span>
    <span class="s1">engine</span><span class="s0">, </span><span class="s1">raw = engine_and_raw</span>
    <span class="s1">data = frame_or_series(np.array(list(range(</span><span class="s3">10</span><span class="s1">)) + [np.nan] * </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">result = data.expanding(min_periods=</span><span class="s3">1</span><span class="s1">).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">frame_or_series)</span>

    <span class="s0">if </span><span class="s1">frame_or_series </span><span class="s0">is </span><span class="s1">Series:</span>
        <span class="s1">tm.assert_almost_equal(result[</span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.mean(data[:</span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">tm.assert_series_equal(</span>
            <span class="s1">result.iloc[</span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.mean(data[:</span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">check_names=</span><span class="s0">False</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_expanding_min_periods_apply(engine_and_raw):</span>
    <span class="s1">engine</span><span class="s0">, </span><span class="s1">raw = engine_and_raw</span>
    <span class="s1">ser = Series(np.random.randn(</span><span class="s3">50</span><span class="s1">))</span>

    <span class="s1">result = ser.expanding(min_periods=</span><span class="s3">30</span><span class="s1">).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">result[:</span><span class="s3">29</span><span class="s1">].isna().all()</span>
    <span class="s1">tm.assert_almost_equal(result.iloc[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.mean(ser[:</span><span class="s3">50</span><span class="s1">]))</span>

    <span class="s4"># min_periods is working correctly</span>
    <span class="s1">result = ser.expanding(min_periods=</span><span class="s3">15</span><span class="s1">).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isna(result.iloc[</span><span class="s3">13</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">notna(result.iloc[</span><span class="s3">14</span><span class="s1">])</span>

    <span class="s1">ser2 = Series(np.random.randn(</span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">result = ser2.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isna(result[</span><span class="s3">3</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">notna(result[</span><span class="s3">4</span><span class="s1">])</span>

    <span class="s4"># min_periods=0</span>
    <span class="s1">result0 = ser.expanding(min_periods=</span><span class="s3">0</span><span class="s1">).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine</span>
    <span class="s1">)</span>
    <span class="s1">result1 = ser.expanding(min_periods=</span><span class="s3">1</span><span class="s1">).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_almost_equal(result0</span><span class="s0">, </span><span class="s1">result1)</span>

    <span class="s1">result = ser.expanding(min_periods=</span><span class="s3">1</span><span class="s1">).apply(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_almost_equal(result.iloc[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.mean(ser[:</span><span class="s3">50</span><span class="s1">]))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;f&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">x: (x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).cov(x</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: (x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).corr(x</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_moment_functions_zero_length_pairwise(f):</span>

    <span class="s1">df1 = DataFrame()</span>
    <span class="s1">df2 = DataFrame(columns=Index([</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=Index([]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;bar&quot;</span><span class="s1">))</span>
    <span class="s1">df2[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = df2[</span><span class="s2">&quot;a&quot;</span><span class="s1">].astype(</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>

    <span class="s1">df1_expected = DataFrame(</span>
        <span class="s1">index=MultiIndex.from_product([df1.index</span><span class="s0">, </span><span class="s1">df1.columns])</span><span class="s0">, </span><span class="s1">columns=Index([])</span>
    <span class="s1">)</span>
    <span class="s1">df2_expected = DataFrame(</span>
        <span class="s1">index=MultiIndex.from_product([df2.index</span><span class="s0">, </span><span class="s1">df2.columns]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">columns=Index([</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">df1_result = f(df1)</span>
    <span class="s1">tm.assert_frame_equal(df1_result</span><span class="s0">, </span><span class="s1">df1_expected)</span>

    <span class="s1">df2_result = f(df2)</span>
    <span class="s1">tm.assert_frame_equal(df2_result</span><span class="s0">, </span><span class="s1">df2_expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;f&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding().count()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).cov(x</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).corr(x</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).max()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).min()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).sum()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).mean()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).std()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).var()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).skew()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).kurt()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).quantile(</span><span class="s3">0.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).median()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).apply(sum</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: x.expanding(min_periods=</span><span class="s3">5</span><span class="s1">).apply(sum</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_moment_functions_zero_length(f):</span>
    <span class="s4"># GH 8056</span>
    <span class="s1">s = Series(dtype=np.float64)</span>
    <span class="s1">s_expected = s</span>
    <span class="s1">df1 = DataFrame()</span>
    <span class="s1">df1_expected = df1</span>
    <span class="s1">df2 = DataFrame(columns=[</span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">df2[</span><span class="s2">&quot;a&quot;</span><span class="s1">] = df2[</span><span class="s2">&quot;a&quot;</span><span class="s1">].astype(</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s1">df2_expected = df2</span>

    <span class="s1">s_result = f(s)</span>
    <span class="s1">tm.assert_series_equal(s_result</span><span class="s0">, </span><span class="s1">s_expected)</span>

    <span class="s1">df1_result = f(df1)</span>
    <span class="s1">tm.assert_frame_equal(df1_result</span><span class="s0">, </span><span class="s1">df1_expected)</span>

    <span class="s1">df2_result = f(df2)</span>
    <span class="s1">tm.assert_frame_equal(df2_result</span><span class="s0">, </span><span class="s1">df2_expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_apply_empty_series(engine_and_raw):</span>
    <span class="s1">engine</span><span class="s0">, </span><span class="s1">raw = engine_and_raw</span>
    <span class="s1">ser = Series([]</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">tm.assert_series_equal(</span>
        <span class="s1">ser</span><span class="s0">, </span><span class="s1">ser.expanding().apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine)</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_expanding_apply_min_periods_0(engine_and_raw):</span>
    <span class="s4"># GH 8080</span>
    <span class="s1">engine</span><span class="s0">, </span><span class="s1">raw = engine_and_raw</span>
    <span class="s1">s = Series([</span><span class="s0">None, None, None</span><span class="s1">])</span>
    <span class="s1">result = s.expanding(min_periods=</span><span class="s3">0</span><span class="s1">).apply(</span><span class="s0">lambda </span><span class="s1">x: len(x)</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">engine=engine)</span>
    <span class="s1">expected = Series([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_cov_diff_index():</span>
    <span class="s4"># GH 7512</span>
    <span class="s1">s1 = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">s2 = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">result = s1.expanding().cov(s2)</span>
    <span class="s1">expected = Series([</span><span class="s0">None, None, </span><span class="s3">2.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">s2a = Series([</span><span class="s3">1</span><span class="s0">, None, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">result = s1.expanding().cov(s2a)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">s1 = Series([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">s2 = Series([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">result = s1.expanding().cov(s2)</span>
    <span class="s1">expected = Series([</span><span class="s0">None, None, None, </span><span class="s3">4.5</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_corr_diff_index():</span>
    <span class="s4"># GH 7512</span>
    <span class="s1">s1 = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">s2 = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">result = s1.expanding().corr(s2)</span>
    <span class="s1">expected = Series([</span><span class="s0">None, None, </span><span class="s3">1.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">s2a = Series([</span><span class="s3">1</span><span class="s0">, None, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">result = s1.expanding().corr(s2a)</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">s1 = Series([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">s2 = Series([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">result = s1.expanding().corr(s2)</span>
    <span class="s1">expected = Series([</span><span class="s0">None, None, None, </span><span class="s3">1.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_cov_pairwise_diff_length():</span>
    <span class="s4"># GH 7512</span>
    <span class="s1">df1 = DataFrame([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=Index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">))</span>
    <span class="s1">df1a = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=Index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=Index([</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">df2a = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">columns=Index([</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s4"># TODO: xref gh-15826</span>
    <span class="s4"># .loc is not preserving the names</span>
    <span class="s1">result1 = df1.expanding().cov(df2</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">result2 = df1.expanding().cov(df2a</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">result3 = df1a.expanding().cov(df2</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">result4 = df1a.expanding().cov(df2a</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[-</span><span class="s3">3.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">6.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">5.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">10.0</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=Index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">index=Index([</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result3</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result4</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_corr_pairwise_diff_length():</span>
    <span class="s4"># GH 7512</span>
    <span class="s1">df1 = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=Index(range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;bar&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">df1a = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;bar&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">df2 = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">index=Index(range(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;bar&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df2a = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;bar&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result1 = df1.expanding().corr(df2</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">result2 = df1.expanding().corr(df2a</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">result3 = df1a.expanding().corr(df2</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">result4 = df1a.expanding().corr(df2a</span><span class="s0">, </span><span class="s1">pairwise=</span><span class="s0">True</span><span class="s1">).loc[</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">[[-</span><span class="s3">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s2">&quot;Y&quot;</span><span class="s1">])</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(result1</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result3</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(result4</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_expanding_apply_args_kwargs(engine_and_raw):</span>
    <span class="s0">def </span><span class="s1">mean_w_arg(x</span><span class="s0">, </span><span class="s1">const):</span>
        <span class="s0">return </span><span class="s1">np.mean(x) + const</span>

    <span class="s1">engine</span><span class="s0">, </span><span class="s1">raw = engine_and_raw</span>

    <span class="s1">df = DataFrame(np.random.rand(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">expected = df.expanding().apply(np.mean</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">raw=raw) + </span><span class="s3">20.0</span>

    <span class="s1">result = df.expanding().apply(mean_w_arg</span><span class="s0">, </span><span class="s1">engine=engine</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">args=(</span><span class="s3">20</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = df.expanding().apply(mean_w_arg</span><span class="s0">, </span><span class="s1">raw=raw</span><span class="s0">, </span><span class="s1">kwargs={</span><span class="s2">&quot;const&quot;</span><span class="s1">: </span><span class="s3">20</span><span class="s1">})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>