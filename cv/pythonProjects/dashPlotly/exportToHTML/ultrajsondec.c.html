<html>
<head>
<title>ultrajsondec.c</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #ab51ba;}
.s6 { color: #0f9795;}
.s7 { color: #4646f1;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ultrajsondec.c</font>
</center></td></tr></table>
<pre><span class="s0">/* 
Copyright (c) 2011-2013, ESN Social Software AB and Jonas Tarnstrom 
All rights reserved. 
 
Redistribution and use in source and binary forms, with or without 
modification, are permitted provided that the following conditions are met: 
* Redistributions of source code must retain the above copyright 
notice, this list of conditions and the following disclaimer. 
* Redistributions in binary form must reproduce the above copyright 
notice, this list of conditions and the following disclaimer in the 
documentation and/or other materials provided with the distribution. 
* Neither the name of the ESN Social Software AB nor the 
names of its contributors may be used to endorse or promote products 
derived from this software without specific prior written permission. 
 
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND 
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE 
DISCLAIMED. IN NO EVENT SHALL ESN SOCIAL SOFTWARE AB OR JONAS TARNSTROM BE 
LIABLE 
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
DAMAGES 
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND 
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT 
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS 
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
 
 
Portions of code from MODP_ASCII - Ascii transformations (upper/lower, etc) 
https://github.com/client9/stringencoders 
Copyright (c) 2007  Nick Galbreath -- nickg [at] modp [dot] com. All rights 
reserved. 
 
Numeric decoder derived from from TCL library 
https://www.opensource.apple.com/source/tcl/tcl-14/tcl/license.terms 
* Copyright (c) 1988-1993 The Regents of the University of California. 
* Copyright (c) 1994 Sun Microsystems, Inc. 
*/</span>

<span class="s2">#include </span><span class="s1">&lt;assert.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;errno.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;limits.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;locale.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;math.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;stdlib.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;string.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;wchar.h&gt;</span>
<span class="s2">#include </span><span class="s3">&quot;ultrajson.h&quot;</span>

<span class="s2">#ifndef </span><span class="s1">TRUE</span>
<span class="s2">#define </span><span class="s1">TRUE </span><span class="s4">1</span>
<span class="s2">#define </span><span class="s1">FALSE </span><span class="s4">0</span>
<span class="s2">#endif</span>
<span class="s2">#ifndef </span><span class="s1">NULL</span>
<span class="s2">#define </span><span class="s1">NULL </span><span class="s4">0</span>
<span class="s2">#endif</span>

<span class="s2">struct </span><span class="s1">DecoderState {</span>
    <span class="s2">char </span><span class="s1">*start;</span>
    <span class="s2">char </span><span class="s1">*end;</span>
    <span class="s5">wchar_t </span><span class="s1">*escStart;</span>
    <span class="s5">wchar_t </span><span class="s1">*escEnd;</span>
    <span class="s2">int </span><span class="s1">escHeap;</span>
    <span class="s2">int </span><span class="s1">lastType;</span>
    <span class="s1">JSUINT32 objDepth;</span>
    <span class="s2">void </span><span class="s1">*prv;</span>
    <span class="s1">JSONObjectDecoder *dec;</span>
<span class="s1">};</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_any(</span><span class="s2">struct </span><span class="s1">DecoderState *ds);</span>
<span class="s2">typedef </span><span class="s1">JSOBJ (*PFN_DECODER)(</span><span class="s2">struct </span><span class="s1">DecoderState *ds);</span>

<span class="s2">static </span><span class="s1">JSOBJ SetError(</span><span class="s2">struct </span><span class="s1">DecoderState *ds, </span><span class="s2">int </span><span class="s1">offset,</span>
                      <span class="s2">const char </span><span class="s1">*message) {</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">errorOffset = ds</span><span class="s6">-&gt;</span><span class="s1">start + offset;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">errorStr = (</span><span class="s2">char </span><span class="s1">*)message;</span>
    <span class="s2">return </span><span class="s1">NULL;</span>
<span class="s1">}</span>

<span class="s2">double </span><span class="s1">createDouble(</span><span class="s2">double </span><span class="s1">intNeg, </span><span class="s2">double </span><span class="s1">intValue, </span><span class="s2">double </span><span class="s1">frcValue,</span>
                    <span class="s2">int </span><span class="s1">frcDecimalCount) {</span>
    <span class="s2">static const double </span><span class="s1">g_pow10[] = {</span><span class="s4">1.0</span><span class="s1">,</span>
                                     <span class="s4">0.1</span><span class="s1">,</span>
                                     <span class="s4">0.01</span><span class="s1">,</span>
                                     <span class="s4">0.001</span><span class="s1">,</span>
                                     <span class="s4">0.0001</span><span class="s1">,</span>
                                     <span class="s4">0.00001</span><span class="s1">,</span>
                                     <span class="s4">0.000001</span><span class="s1">,</span>
                                     <span class="s4">0.0000001</span><span class="s1">,</span>
                                     <span class="s4">0.00000001</span><span class="s1">,</span>
                                     <span class="s4">0.000000001</span><span class="s1">,</span>
                                     <span class="s4">0.0000000001</span><span class="s1">,</span>
                                     <span class="s4">0.00000000001</span><span class="s1">,</span>
                                     <span class="s4">0.000000000001</span><span class="s1">,</span>
                                     <span class="s4">0.0000000000001</span><span class="s1">,</span>
                                     <span class="s4">0.00000000000001</span><span class="s1">,</span>
                                     <span class="s4">0.000000000000001</span><span class="s1">};</span>
    <span class="s2">return </span><span class="s1">(intValue + (frcValue * g_pow10[frcDecimalCount])) * intNeg;</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decodePreciseFloat(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s2">char </span><span class="s1">*end;</span>
    <span class="s2">double </span><span class="s1">value;</span>
    <span class="s1">errno = </span><span class="s4">0</span><span class="s1">;</span>

    <span class="s1">value = strtod(ds</span><span class="s6">-&gt;</span><span class="s1">start, &amp;end);</span>

    <span class="s2">if </span><span class="s1">(errno == ERANGE) {</span>
        <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Range error when decoding numeric as double&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = end;</span>
    <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newDouble(ds</span><span class="s6">-&gt;</span><span class="s1">prv, value);</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_numeric(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s2">int </span><span class="s1">intNeg = </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">JSUINT64 intValue;</span>
    <span class="s1">JSUINT64 prevIntValue;</span>
    <span class="s2">int </span><span class="s1">chr;</span>
    <span class="s2">int </span><span class="s1">decimalCount = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">double </span><span class="s1">frcValue = </span><span class="s4">0.0</span><span class="s1">;</span>
    <span class="s2">double </span><span class="s1">expNeg;</span>
    <span class="s2">double </span><span class="s1">expValue;</span>
    <span class="s2">char </span><span class="s1">*offset = ds</span><span class="s6">-&gt;</span><span class="s1">start;</span>

    <span class="s1">JSUINT64 overflowLimit = LLONG_MAX;</span>

    <span class="s2">if </span><span class="s1">(*(offset) == </span><span class="s3">'I'</span><span class="s1">) {</span>
      <span class="s2">goto </span><span class="s1">DECODE_INF;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(*(offset) == </span><span class="s3">'N'</span><span class="s1">) {</span>
      <span class="s2">goto </span><span class="s1">DECODE_NAN;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(*(offset) == </span><span class="s3">'-'</span><span class="s1">) {</span>
        <span class="s1">offset++;</span>
        <span class="s1">intNeg = -</span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">overflowLimit  = LLONG_MIN;</span>
        <span class="s2">if </span><span class="s1">(*(offset) == </span><span class="s3">'I'</span><span class="s1">) {</span>
          <span class="s2">goto </span><span class="s1">DECODE_INF;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">// Scan integer part</span>
    <span class="s1">intValue = </span><span class="s4">0</span><span class="s1">;</span>

    <span class="s2">while </span><span class="s1">(</span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s1">chr = (</span><span class="s2">int</span><span class="s1">)(</span><span class="s2">unsigned char</span><span class="s1">)*(offset);</span>

        <span class="s2">switch </span><span class="s1">(chr) {</span>
            <span class="s2">case </span><span class="s3">'0'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'1'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'2'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'3'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'4'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'5'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'6'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'7'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'8'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'9'</span><span class="s1">: {</span>
                <span class="s0">// PERF: Don't do 64-bit arithmetic here unless we have to</span>
                <span class="s1">prevIntValue = intValue;</span>
                <span class="s1">intValue = intValue * </span><span class="s4">10</span><span class="s1">ULL + (JSLONG) (chr - </span><span class="s4">48</span><span class="s1">);</span>

                <span class="s2">if </span><span class="s1">(intNeg == </span><span class="s4">1 </span><span class="s1">&amp;&amp; prevIntValue &gt; intValue) {</span>
                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Value is too big!&quot;</span><span class="s1">);</span>
                <span class="s1">} </span><span class="s2">else if </span><span class="s1">(intNeg == -</span><span class="s4">1 </span><span class="s1">&amp;&amp; intValue &gt; overflowLimit) {</span>
                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, overflowLimit == LLONG_MAX ?</span>
                                    <span class="s3">&quot;Value is too big!&quot; </span><span class="s1">: </span><span class="s3">&quot;Value is too small&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>

                <span class="s1">offset++;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s3">'.'</span><span class="s1">: {</span>
                <span class="s1">offset++;</span>
                <span class="s2">goto </span><span class="s1">DECODE_FRACTION;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s3">'e'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'E'</span><span class="s1">: {</span>
                <span class="s1">offset++;</span>
                <span class="s2">goto </span><span class="s1">DECODE_EXPONENT;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">default</span><span class="s1">: {</span>
                <span class="s2">goto </span><span class="s1">BREAK_INT_LOOP;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

<span class="s1">BREAK_INT_LOOP:</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_INT;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>

    <span class="s2">if </span><span class="s1">(intNeg == </span><span class="s4">1 </span><span class="s1">&amp;&amp; (intValue &amp; </span><span class="s4">0x8000000000000000</span><span class="s1">ULL) != </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newUnsignedLong(ds</span><span class="s6">-&gt;</span><span class="s1">prv, intValue);</span>
    <span class="s2">else if </span><span class="s1">((intValue &gt;&gt; </span><span class="s4">31</span><span class="s1">))</span>
        <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newLong(ds</span><span class="s6">-&gt;</span><span class="s1">prv, (JSINT64)(intValue * (JSINT64)intNeg));</span>
    <span class="s2">else</span>
        <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newInt(ds</span><span class="s6">-&gt;</span><span class="s1">prv, (JSINT32)(intValue * intNeg));</span>

<span class="s1">DECODE_FRACTION:</span>

    <span class="s2">if </span><span class="s1">(ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">preciseFloat) {</span>
        <span class="s2">return </span><span class="s1">decodePreciseFloat(ds);</span>
    <span class="s1">}</span>

    <span class="s0">// Scan fraction part</span>
    <span class="s1">frcValue = </span><span class="s4">0.0</span><span class="s1">;</span>
    <span class="s2">for </span><span class="s1">(;;) {</span>
        <span class="s1">chr = (</span><span class="s2">int</span><span class="s1">)(</span><span class="s2">unsigned char</span><span class="s1">)*(offset);</span>

        <span class="s2">switch </span><span class="s1">(chr) {</span>
            <span class="s2">case </span><span class="s3">'0'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'1'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'2'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'3'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'4'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'5'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'6'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'7'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'8'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'9'</span><span class="s1">: {</span>
                <span class="s2">if </span><span class="s1">(decimalCount &lt; JSON_DOUBLE_MAX_DECIMALS) {</span>
                    <span class="s1">frcValue = frcValue * </span><span class="s4">10.0 </span><span class="s1">+ (</span><span class="s2">double</span><span class="s1">)(chr - </span><span class="s4">48</span><span class="s1">);</span>
                    <span class="s1">decimalCount++;</span>
                <span class="s1">}</span>
                <span class="s1">offset++;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s3">'e'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'E'</span><span class="s1">: {</span>
                <span class="s1">offset++;</span>
                <span class="s2">goto </span><span class="s1">DECODE_EXPONENT;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">default</span><span class="s1">: { </span><span class="s2">goto </span><span class="s1">BREAK_FRC_LOOP; }</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

<span class="s1">BREAK_FRC_LOOP:</span>
    <span class="s0">// FIXME: Check for arithmetic overflow here</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_DOUBLE;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>
    <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newDouble(</span>
        <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">prv,</span>
        <span class="s1">createDouble((</span><span class="s2">double</span><span class="s1">)intNeg, (</span><span class="s2">double</span><span class="s1">)intValue, frcValue, decimalCount));</span>

<span class="s1">DECODE_EXPONENT:</span>
    <span class="s2">if </span><span class="s1">(ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">preciseFloat) {</span>
        <span class="s2">return </span><span class="s1">decodePreciseFloat(ds);</span>
    <span class="s1">}</span>

    <span class="s1">expNeg = </span><span class="s4">1.0</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(*(offset) == </span><span class="s3">'-'</span><span class="s1">) {</span>
        <span class="s1">expNeg = -</span><span class="s4">1.0</span><span class="s1">;</span>
        <span class="s1">offset++;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(*(offset) == </span><span class="s3">'+'</span><span class="s1">) {</span>
        <span class="s1">expNeg = +</span><span class="s4">1.0</span><span class="s1">;</span>
        <span class="s1">offset++;</span>
    <span class="s1">}</span>

    <span class="s1">expValue = </span><span class="s4">0.0</span><span class="s1">;</span>

    <span class="s2">for </span><span class="s1">(;;) {</span>
        <span class="s1">chr = (</span><span class="s2">int</span><span class="s1">)(</span><span class="s2">unsigned char</span><span class="s1">)*(offset);</span>

        <span class="s2">switch </span><span class="s1">(chr) {</span>
            <span class="s2">case </span><span class="s3">'0'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'1'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'2'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'3'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'4'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'5'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'6'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'7'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'8'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'9'</span><span class="s1">: {</span>
                <span class="s1">expValue = expValue * </span><span class="s4">10.0 </span><span class="s1">+ (</span><span class="s2">double</span><span class="s1">)(chr - </span><span class="s4">48</span><span class="s1">);</span>
                <span class="s1">offset++;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">default</span><span class="s1">: { </span><span class="s2">goto </span><span class="s1">BREAK_EXP_LOOP; }</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

<span class="s1">DECODE_NAN:</span>
    <span class="s1">offset++;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'a'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_NAN_ERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'N'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_NAN_ERROR;</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_NULL;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>
    <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newNull(ds</span><span class="s6">-&gt;</span><span class="s1">prv);</span>

<span class="s1">SET_NAN_ERROR:</span>
    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Unexpected character found when decoding 'NaN'&quot;</span><span class="s1">);</span>

<span class="s1">DECODE_INF:</span>
    <span class="s1">offset++;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'n'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_INF_ERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'f'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_INF_ERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'i'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_INF_ERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'n'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_INF_ERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'i'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_INF_ERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'t'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_INF_ERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'y'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SET_INF_ERROR;</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>

    <span class="s2">if </span><span class="s1">(intNeg == </span><span class="s4">1</span><span class="s1">) {</span>
      <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_POS_INF;</span>
      <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newPosInf(ds</span><span class="s6">-&gt;</span><span class="s1">prv);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_NEG_INF;</span>
      <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newNegInf(ds</span><span class="s6">-&gt;</span><span class="s1">prv);</span>
    <span class="s1">}</span>

<span class="s1">SET_INF_ERROR:</span>
    <span class="s2">if </span><span class="s1">(intNeg == </span><span class="s4">1</span><span class="s1">) {</span>
      <span class="s2">const char </span><span class="s1">*msg = </span><span class="s3">&quot;Unexpected character found when decoding 'Infinity'&quot;</span><span class="s1">;</span>
      <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, msg);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">const char </span><span class="s1">*msg = </span><span class="s3">&quot;Unexpected character found when decoding '-Infinity'&quot;</span><span class="s1">;</span>
      <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, msg);</span>
    <span class="s1">}</span>


<span class="s1">BREAK_EXP_LOOP:</span>
    <span class="s0">// FIXME: Check for arithmetic overflow here</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_DOUBLE;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>
    <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newDouble(</span>
        <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">prv,</span>
        <span class="s1">createDouble((</span><span class="s2">double</span><span class="s1">)intNeg, (</span><span class="s2">double</span><span class="s1">)intValue, frcValue, decimalCount) *</span>
            <span class="s1">pow(</span><span class="s4">10.0</span><span class="s1">, expValue * expNeg));</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_true(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s2">char </span><span class="s1">*offset = ds</span><span class="s6">-&gt;</span><span class="s1">start;</span>
    <span class="s1">offset++;</span>

    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'r'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'u'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'e'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_TRUE;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>
    <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newTrue(ds</span><span class="s6">-&gt;</span><span class="s1">prv);</span>

<span class="s1">SETERROR:</span>
    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Unexpected character found when decoding 'true'&quot;</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_false(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s2">char </span><span class="s1">*offset = ds</span><span class="s6">-&gt;</span><span class="s1">start;</span>
    <span class="s1">offset++;</span>

    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'a'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'l'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'s'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'e'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_FALSE;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>
    <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newFalse(ds</span><span class="s6">-&gt;</span><span class="s1">prv);</span>

<span class="s1">SETERROR:</span>
    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Unexpected character found when decoding 'false'&quot;</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_null(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s2">char </span><span class="s1">*offset = ds</span><span class="s6">-&gt;</span><span class="s1">start;</span>
    <span class="s1">offset++;</span>

    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'u'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'l'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>
    <span class="s2">if </span><span class="s1">(*(offset++) != </span><span class="s3">'l'</span><span class="s1">) </span><span class="s2">goto </span><span class="s1">SETERROR;</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_NULL;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>
    <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newNull(ds</span><span class="s6">-&gt;</span><span class="s1">prv);</span>

<span class="s1">SETERROR:</span>
    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Unexpected character found when decoding 'null'&quot;</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">void </span><span class="s1">FASTCALL_MSVC SkipWhitespace(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s2">char </span><span class="s1">*offset;</span>

    <span class="s2">for </span><span class="s1">(offset = ds</span><span class="s6">-&gt;</span><span class="s1">start; (ds</span><span class="s6">-&gt;</span><span class="s1">end - offset) &gt; </span><span class="s4">0</span><span class="s1">; offset++) {</span>
        <span class="s2">switch </span><span class="s1">(*offset) {</span>
            <span class="s2">case </span><span class="s3">' '</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'</span><span class="s7">\t</span><span class="s3">'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'</span><span class="s7">\r</span><span class="s3">'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'</span><span class="s7">\n</span><span class="s3">'</span><span class="s1">:</span>
                <span class="s2">break</span><span class="s1">;</span>

            <span class="s2">default</span><span class="s1">:</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = offset;</span>
                <span class="s2">return</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(offset == ds</span><span class="s6">-&gt;</span><span class="s1">end) {</span>
        <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start = ds</span><span class="s6">-&gt;</span><span class="s1">end;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">enum </span><span class="s1">DECODESTRINGSTATE {</span>
    <span class="s1">DS_ISNULL = </span><span class="s4">0x32</span><span class="s1">,</span>
    <span class="s1">DS_ISQUOTE,</span>
    <span class="s1">DS_ISESCAPE,</span>
    <span class="s1">DS_UTFLENERROR,</span>
<span class="s1">};</span>

<span class="s2">static const </span><span class="s1">JSUINT8 g_decoderLookup[</span><span class="s4">256</span><span class="s1">] = {</span>
    <span class="s0">/* 0x00 */ </span><span class="s1">DS_ISNULL,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x10 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x20 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s1">DS_ISQUOTE,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x30 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x40 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x50 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s1">DS_ISESCAPE,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x60 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x70 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x80 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0x90 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0xa0 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0xb0 */ </span><span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s4">1</span><span class="s1">,</span>
    <span class="s0">/* 0xc0 */ </span><span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s0">/* 0xd0 */ </span><span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s4">2</span><span class="s1">,</span>
    <span class="s0">/* 0xe0 */ </span><span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s4">3</span><span class="s1">,</span>
    <span class="s0">/* 0xf0 */ </span><span class="s4">4</span><span class="s1">,</span>
    <span class="s4">4</span><span class="s1">,</span>
    <span class="s4">4</span><span class="s1">,</span>
    <span class="s4">4</span><span class="s1">,</span>
    <span class="s4">4</span><span class="s1">,</span>
    <span class="s4">4</span><span class="s1">,</span>
    <span class="s4">4</span><span class="s1">,</span>
    <span class="s4">4</span><span class="s1">,</span>
    <span class="s1">DS_UTFLENERROR,</span>
    <span class="s1">DS_UTFLENERROR,</span>
    <span class="s1">DS_UTFLENERROR,</span>
    <span class="s1">DS_UTFLENERROR,</span>
    <span class="s1">DS_UTFLENERROR,</span>
    <span class="s1">DS_UTFLENERROR,</span>
    <span class="s1">DS_UTFLENERROR,</span>
    <span class="s1">DS_UTFLENERROR,</span>
<span class="s1">};</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_string(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s1">JSUTF16 sur[</span><span class="s4">2</span><span class="s1">] = {</span><span class="s4">0</span><span class="s1">};</span>
    <span class="s2">int </span><span class="s1">iSur = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">int </span><span class="s1">index;</span>
    <span class="s5">wchar_t </span><span class="s1">*escOffset;</span>
    <span class="s5">wchar_t </span><span class="s1">*escStart;</span>
    <span class="s1">size_t escLen = (ds</span><span class="s6">-&gt;</span><span class="s1">escEnd - ds</span><span class="s6">-&gt;</span><span class="s1">escStart);</span>
    <span class="s1">JSUINT8 *inputOffset;</span>
    <span class="s1">JSUINT8 oct;</span>
    <span class="s1">JSUTF32 ucs;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_INVALID;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start++;</span>

    <span class="s2">if </span><span class="s1">((size_t)(ds</span><span class="s6">-&gt;</span><span class="s1">end - ds</span><span class="s6">-&gt;</span><span class="s1">start) &gt; escLen) {</span>
        <span class="s1">size_t newSize = (ds</span><span class="s6">-&gt;</span><span class="s1">end - ds</span><span class="s6">-&gt;</span><span class="s1">start);</span>

        <span class="s2">if </span><span class="s1">(ds</span><span class="s6">-&gt;</span><span class="s1">escHeap) {</span>
            <span class="s2">if </span><span class="s1">(newSize &gt; (SIZE_MAX / </span><span class="s2">sizeof</span><span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">))) {</span>
                <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Could not reserve memory block&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s1">escStart = (</span><span class="s5">wchar_t </span><span class="s1">*)ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">realloc(ds</span><span class="s6">-&gt;</span><span class="s1">escStart,</span>
                                                   <span class="s1">newSize * </span><span class="s2">sizeof</span><span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">));</span>
            <span class="s2">if </span><span class="s1">(!escStart) {</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">free(ds</span><span class="s6">-&gt;</span><span class="s1">escStart);</span>
                <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Could not reserve memory block&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">escStart = escStart;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s5">wchar_t </span><span class="s1">*oldStart = ds</span><span class="s6">-&gt;</span><span class="s1">escStart;</span>
            <span class="s2">if </span><span class="s1">(newSize &gt; (SIZE_MAX / </span><span class="s2">sizeof</span><span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">))) {</span>
                <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Could not reserve memory block&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">escStart =</span>
                <span class="s1">(</span><span class="s5">wchar_t </span><span class="s1">*)ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">malloc(newSize * </span><span class="s2">sizeof</span><span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">));</span>
            <span class="s2">if </span><span class="s1">(!ds</span><span class="s6">-&gt;</span><span class="s1">escStart) {</span>
                <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Could not reserve memory block&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">escHeap = </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">memcpy(ds</span><span class="s6">-&gt;</span><span class="s1">escStart, oldStart, escLen * </span><span class="s2">sizeof</span><span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">escEnd = ds</span><span class="s6">-&gt;</span><span class="s1">escStart + newSize;</span>
    <span class="s1">}</span>

    <span class="s1">escOffset = ds</span><span class="s6">-&gt;</span><span class="s1">escStart;</span>
    <span class="s1">inputOffset = (JSUINT8 *)ds</span><span class="s6">-&gt;</span><span class="s1">start;</span>

    <span class="s2">for </span><span class="s1">(;;) {</span>
        <span class="s2">switch </span><span class="s1">(g_decoderLookup[(JSUINT8)(*inputOffset)]) {</span>
            <span class="s2">case </span><span class="s1">DS_ISNULL: {</span>
                <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                <span class="s3">&quot;Unmatched ''</span><span class="s7">\&quot;</span><span class="s3">' when when decoding 'string'&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s1">DS_ISQUOTE: {</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_UTF8;</span>
                <span class="s1">inputOffset++;</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start += ((</span><span class="s2">char </span><span class="s1">*)inputOffset - (ds</span><span class="s6">-&gt;</span><span class="s1">start));</span>
                <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newString(ds</span><span class="s6">-&gt;</span><span class="s1">prv, ds</span><span class="s6">-&gt;</span><span class="s1">escStart, escOffset);</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s1">DS_UTFLENERROR: {</span>
                <span class="s2">return </span><span class="s1">SetError(</span>
                    <span class="s1">ds, -</span><span class="s4">1</span><span class="s1">,</span>
                    <span class="s3">&quot;Invalid UTF-8 sequence length when decoding 'string'&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s1">DS_ISESCAPE:</span>
                <span class="s1">inputOffset++;</span>
                <span class="s2">switch </span><span class="s1">(*inputOffset) {</span>
                    <span class="s2">case </span><span class="s3">'</span><span class="s7">\\</span><span class="s3">'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'</span><span class="s7">\\</span><span class="s3">'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s2">case </span><span class="s3">'</span><span class="s7">\&quot;</span><span class="s3">'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'</span><span class="s7">\&quot;</span><span class="s3">'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s2">case </span><span class="s3">'/'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'/'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s2">case </span><span class="s3">'b'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'</span><span class="s7">\b</span><span class="s3">'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s2">case </span><span class="s3">'f'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'</span><span class="s7">\f</span><span class="s3">'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s2">case </span><span class="s3">'n'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'</span><span class="s7">\n</span><span class="s3">'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s2">case </span><span class="s3">'r'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'</span><span class="s7">\r</span><span class="s3">'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s2">case </span><span class="s3">'t'</span><span class="s1">:</span>
                        <span class="s1">*(escOffset++) = L</span><span class="s3">'</span><span class="s7">\t</span><span class="s3">'</span><span class="s1">;</span>
                        <span class="s1">inputOffset++;</span>
                        <span class="s2">continue</span><span class="s1">;</span>

                    <span class="s2">case </span><span class="s3">'u'</span><span class="s1">: {</span>
                        <span class="s2">int </span><span class="s1">index;</span>
                        <span class="s1">inputOffset++;</span>

                        <span class="s2">for </span><span class="s1">(index = </span><span class="s4">0</span><span class="s1">; index &lt; </span><span class="s4">4</span><span class="s1">; index++) {</span>
                            <span class="s2">switch </span><span class="s1">(*inputOffset) {</span>
                                <span class="s2">case </span><span class="s3">'</span><span class="s7">\0</span><span class="s3">'</span><span class="s1">:</span>
                                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                                    <span class="s3">&quot;Unterminated unicode &quot;</span>
                                                    <span class="s3">&quot;escape sequence when &quot;</span>
                                                    <span class="s3">&quot;decoding 'string'&quot;</span><span class="s1">);</span>
                                <span class="s2">default</span><span class="s1">:</span>
                                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                                    <span class="s3">&quot;Unexpected character in &quot;</span>
                                                    <span class="s3">&quot;unicode escape sequence &quot;</span>
                                                    <span class="s3">&quot;when decoding 'string'&quot;</span><span class="s1">);</span>

                                <span class="s2">case </span><span class="s3">'0'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'1'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'2'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'3'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'4'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'5'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'6'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'7'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'8'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'9'</span><span class="s1">:</span>
                                    <span class="s1">sur[iSur] = (sur[iSur] &lt;&lt; </span><span class="s4">4</span><span class="s1">) +</span>
                                                <span class="s1">(JSUTF16)(*inputOffset - </span><span class="s3">'0'</span><span class="s1">);</span>
                                    <span class="s2">break</span><span class="s1">;</span>

                                <span class="s2">case </span><span class="s3">'a'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'b'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'c'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'d'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'e'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'f'</span><span class="s1">:</span>
                                    <span class="s1">sur[iSur] = (sur[iSur] &lt;&lt; </span><span class="s4">4</span><span class="s1">) + </span><span class="s4">10 </span><span class="s1">+</span>
                                                <span class="s1">(JSUTF16)(*inputOffset - </span><span class="s3">'a'</span><span class="s1">);</span>
                                    <span class="s2">break</span><span class="s1">;</span>

                                <span class="s2">case </span><span class="s3">'A'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'B'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'C'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'D'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'E'</span><span class="s1">:</span>
                                <span class="s2">case </span><span class="s3">'F'</span><span class="s1">:</span>
                                    <span class="s1">sur[iSur] = (sur[iSur] &lt;&lt; </span><span class="s4">4</span><span class="s1">) + </span><span class="s4">10 </span><span class="s1">+</span>
                                                <span class="s1">(JSUTF16)(*inputOffset - </span><span class="s3">'A'</span><span class="s1">);</span>
                                    <span class="s2">break</span><span class="s1">;</span>
                            <span class="s1">}</span>

                            <span class="s1">inputOffset++;</span>
                        <span class="s1">}</span>

                        <span class="s2">if </span><span class="s1">(iSur == </span><span class="s4">0</span><span class="s1">) {</span>
                            <span class="s2">if </span><span class="s1">((sur[iSur] &amp; </span><span class="s4">0xfc00</span><span class="s1">) == </span><span class="s4">0xd800</span><span class="s1">) {</span>
                                <span class="s0">// First of a surrogate pair, continue parsing</span>
                                <span class="s1">iSur++;</span>
                                <span class="s2">break</span><span class="s1">;</span>
                            <span class="s1">}</span>
                            <span class="s1">(*escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)sur[iSur];</span>
                            <span class="s1">iSur = </span><span class="s4">0</span><span class="s1">;</span>
                        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                            <span class="s0">// Decode pair</span>
                            <span class="s2">if </span><span class="s1">((sur[</span><span class="s4">1</span><span class="s1">] &amp; </span><span class="s4">0xfc00</span><span class="s1">) != </span><span class="s4">0xdc00</span><span class="s1">) {</span>
                                <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                                <span class="s3">&quot;Unpaired high surrogate when &quot;</span>
                                                <span class="s3">&quot;decoding 'string'&quot;</span><span class="s1">);</span>
                            <span class="s1">}</span>
<span class="s2">#if </span><span class="s1">WCHAR_MAX == </span><span class="s4">0xffff</span>
                            <span class="s1">(*escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)sur[</span><span class="s4">0</span><span class="s1">];</span>
                            <span class="s1">(*escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)sur[</span><span class="s4">1</span><span class="s1">];</span>
<span class="s2">#else</span>
                            <span class="s1">(*escOffset++) =</span>
                                <span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">)</span><span class="s4">0x10000 </span><span class="s1">+</span>
                                <span class="s1">(((sur[</span><span class="s4">0</span><span class="s1">] - </span><span class="s4">0xd800</span><span class="s1">) &lt;&lt; </span><span class="s4">10</span><span class="s1">) | (sur[</span><span class="s4">1</span><span class="s1">] - </span><span class="s4">0xdc00</span><span class="s1">));</span>
<span class="s2">#endif</span>
                            <span class="s1">iSur = </span><span class="s4">0</span><span class="s1">;</span>
                        <span class="s1">}</span>
                        <span class="s2">break</span><span class="s1">;</span>
                    <span class="s1">}</span>

                    <span class="s2">case </span><span class="s3">'</span><span class="s7">\0</span><span class="s3">'</span><span class="s1">:</span>
                        <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                        <span class="s3">&quot;Unterminated escape sequence when &quot;</span>
                                        <span class="s3">&quot;decoding 'string'&quot;</span><span class="s1">);</span>
                    <span class="s2">default</span><span class="s1">:</span>
                        <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                        <span class="s3">&quot;Unrecognized escape sequence when &quot;</span>
                                        <span class="s3">&quot;decoding 'string'&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s2">break</span><span class="s1">;</span>

            <span class="s2">case </span><span class="s4">1</span><span class="s1">: {</span>
                <span class="s1">*(escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)(*inputOffset++);</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">case </span><span class="s4">2</span><span class="s1">: {</span>
                <span class="s1">ucs = (*inputOffset++) &amp; </span><span class="s4">0x1f</span><span class="s1">;</span>
                <span class="s1">ucs &lt;&lt;= </span><span class="s4">6</span><span class="s1">;</span>
                <span class="s2">if </span><span class="s1">(((*inputOffset) &amp; </span><span class="s4">0x80</span><span class="s1">) != </span><span class="s4">0x80</span><span class="s1">) {</span>
                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                    <span class="s3">&quot;Invalid octet in UTF-8 sequence when &quot;</span>
                                    <span class="s3">&quot;decoding 'string'&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s1">ucs |= (*inputOffset++) &amp; </span><span class="s4">0x3f</span><span class="s1">;</span>
                <span class="s2">if </span><span class="s1">(ucs &lt; </span><span class="s4">0x80</span><span class="s1">)</span>
                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                    <span class="s3">&quot;Overlong 2 byte UTF-8 sequence detected &quot;</span>
                                    <span class="s3">&quot;when decoding 'string'&quot;</span><span class="s1">);</span>
                <span class="s1">*(escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)ucs;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">case </span><span class="s4">3</span><span class="s1">: {</span>
                <span class="s1">JSUTF32 ucs = </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s1">ucs |= (*inputOffset++) &amp; </span><span class="s4">0x0f</span><span class="s1">;</span>

                <span class="s2">for </span><span class="s1">(index = </span><span class="s4">0</span><span class="s1">; index &lt; </span><span class="s4">2</span><span class="s1">; index++) {</span>
                    <span class="s1">ucs &lt;&lt;= </span><span class="s4">6</span><span class="s1">;</span>
                    <span class="s1">oct = (*inputOffset++);</span>

                    <span class="s2">if </span><span class="s1">((oct &amp; </span><span class="s4">0x80</span><span class="s1">) != </span><span class="s4">0x80</span><span class="s1">) {</span>
                        <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                        <span class="s3">&quot;Invalid octet in UTF-8 sequence when &quot;</span>
                                        <span class="s3">&quot;decoding 'string'&quot;</span><span class="s1">);</span>
                    <span class="s1">}</span>

                    <span class="s1">ucs |= oct &amp; </span><span class="s4">0x3f</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(ucs &lt; </span><span class="s4">0x800</span><span class="s1">)</span>
                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                    <span class="s3">&quot;Overlong 3 byte UTF-8 sequence detected &quot;</span>
                                    <span class="s3">&quot;when encoding string&quot;</span><span class="s1">);</span>
                <span class="s1">*(escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)ucs;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">case </span><span class="s4">4</span><span class="s1">: {</span>
                <span class="s1">JSUTF32 ucs = </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s1">ucs |= (*inputOffset++) &amp; </span><span class="s4">0x07</span><span class="s1">;</span>

                <span class="s2">for </span><span class="s1">(index = </span><span class="s4">0</span><span class="s1">; index &lt; </span><span class="s4">3</span><span class="s1">; index++) {</span>
                    <span class="s1">ucs &lt;&lt;= </span><span class="s4">6</span><span class="s1">;</span>
                    <span class="s1">oct = (*inputOffset++);</span>

                    <span class="s2">if </span><span class="s1">((oct &amp; </span><span class="s4">0x80</span><span class="s1">) != </span><span class="s4">0x80</span><span class="s1">) {</span>
                        <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                        <span class="s3">&quot;Invalid octet in UTF-8 sequence when &quot;</span>
                                        <span class="s3">&quot;decoding 'string'&quot;</span><span class="s1">);</span>
                    <span class="s1">}</span>

                    <span class="s1">ucs |= oct &amp; </span><span class="s4">0x3f</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(ucs &lt; </span><span class="s4">0x10000</span><span class="s1">)</span>
                    <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">,</span>
                                    <span class="s3">&quot;Overlong 4 byte UTF-8 sequence detected &quot;</span>
                                    <span class="s3">&quot;when decoding 'string'&quot;</span><span class="s1">);</span>

<span class="s2">#if </span><span class="s1">WCHAR_MAX == </span><span class="s4">0xffff</span>
                <span class="s2">if </span><span class="s1">(ucs &gt;= </span><span class="s4">0x10000</span><span class="s1">) {</span>
                    <span class="s1">ucs -= </span><span class="s4">0x10000</span><span class="s1">;</span>
                    <span class="s1">*(escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)(ucs &gt;&gt; </span><span class="s4">10</span><span class="s1">) + </span><span class="s4">0xd800</span><span class="s1">;</span>
                    <span class="s1">*(escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)(ucs &amp; </span><span class="s4">0x3ff</span><span class="s1">) + </span><span class="s4">0xdc00</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s1">*(escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)ucs;</span>
                <span class="s1">}</span>
<span class="s2">#else</span>
                <span class="s1">*(escOffset++) = (</span><span class="s5">wchar_t</span><span class="s1">)ucs;</span>
<span class="s2">#endif</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_array(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s1">JSOBJ itemValue;</span>
    <span class="s1">JSOBJ newObj;</span>
    <span class="s2">int </span><span class="s1">len;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">objDepth++;</span>
    <span class="s2">if </span><span class="s1">(ds</span><span class="s6">-&gt;</span><span class="s1">objDepth &gt; JSON_MAX_OBJECT_DEPTH) {</span>
        <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Reached object decoding depth limit&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s1">newObj = ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newArray(ds</span><span class="s6">-&gt;</span><span class="s1">prv, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
    <span class="s1">len = </span><span class="s4">0</span><span class="s1">;</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_INVALID;</span>
    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start++;</span>

    <span class="s2">for </span><span class="s1">(;;) {</span>
        <span class="s1">SkipWhitespace(ds);</span>

        <span class="s2">if </span><span class="s1">((*ds</span><span class="s6">-&gt;</span><span class="s1">start) == </span><span class="s3">']'</span><span class="s1">) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">objDepth--;</span>
            <span class="s2">if </span><span class="s1">(len == </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start++;</span>
                <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">endArray(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj);</span>
            <span class="s1">}</span>

            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">SetError(</span>
                <span class="s1">ds, -</span><span class="s4">1</span><span class="s1">,</span>
                <span class="s3">&quot;Unexpected character found when decoding array value (1)&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s1">itemValue = decode_any(ds);</span>

        <span class="s2">if </span><span class="s1">(itemValue == NULL) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">NULL;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(!ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">arrayAddItem(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, itemValue)) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">NULL;</span>
        <span class="s1">}</span>

        <span class="s1">SkipWhitespace(ds);</span>

        <span class="s2">switch </span><span class="s1">(*(ds</span><span class="s6">-&gt;</span><span class="s1">start++)) {</span>
            <span class="s2">case </span><span class="s3">']'</span><span class="s1">: {</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">objDepth--;</span>
                <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">endArray(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj);</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s3">','</span><span class="s1">:</span>
                <span class="s2">break</span><span class="s1">;</span>

            <span class="s2">default</span><span class="s1">:</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
                <span class="s2">return </span><span class="s1">SetError(</span>
                    <span class="s1">ds, -</span><span class="s4">1</span><span class="s1">,</span>
                    <span class="s3">&quot;Unexpected character found when decoding array value (2)&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s1">len++;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_object(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s1">JSOBJ itemName;</span>
    <span class="s1">JSOBJ itemValue;</span>
    <span class="s1">JSOBJ newObj;</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">objDepth++;</span>
    <span class="s2">if </span><span class="s1">(ds</span><span class="s6">-&gt;</span><span class="s1">objDepth &gt; JSON_MAX_OBJECT_DEPTH) {</span>
        <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Reached object decoding depth limit&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s1">newObj = ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">newObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>

    <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start++;</span>

    <span class="s2">for </span><span class="s1">(;;) {</span>
        <span class="s1">SkipWhitespace(ds);</span>

        <span class="s2">if </span><span class="s1">((*ds</span><span class="s6">-&gt;</span><span class="s1">start) == </span><span class="s3">'}'</span><span class="s1">) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">objDepth--;</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start++;</span>
            <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">endObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj);</span>
        <span class="s1">}</span>

        <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">lastType = JT_INVALID;</span>
        <span class="s1">itemName = decode_any(ds);</span>

        <span class="s2">if </span><span class="s1">(itemName == NULL) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">NULL;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(ds</span><span class="s6">-&gt;</span><span class="s1">lastType != JT_UTF8) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, itemName, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">SetError(</span>
                <span class="s1">ds, -</span><span class="s4">1</span><span class="s1">,</span>
                <span class="s3">&quot;Key name of object must be 'string' when decoding 'object'&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s1">SkipWhitespace(ds);</span>

        <span class="s2">if </span><span class="s1">(*(ds</span><span class="s6">-&gt;</span><span class="s1">start++) != </span><span class="s3">':'</span><span class="s1">) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, itemName, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;No ':' found when decoding object value&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s1">SkipWhitespace(ds);</span>

        <span class="s1">itemValue = decode_any(ds);</span>

        <span class="s2">if </span><span class="s1">(itemValue == NULL) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, itemName, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">NULL;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(!ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">objectAddKey(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, itemName, itemValue)) {</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, itemName, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, itemValue, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
            <span class="s2">return </span><span class="s1">NULL;</span>
        <span class="s1">}</span>

        <span class="s1">SkipWhitespace(ds);</span>

        <span class="s2">switch </span><span class="s1">(*(ds</span><span class="s6">-&gt;</span><span class="s1">start++)) {</span>
            <span class="s2">case </span><span class="s3">'}'</span><span class="s1">: {</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">objDepth--;</span>
                <span class="s2">return </span><span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">endObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj);</span>
            <span class="s1">}</span>
            <span class="s2">case </span><span class="s3">','</span><span class="s1">:</span>
                <span class="s2">break</span><span class="s1">;</span>

            <span class="s2">default</span><span class="s1">:</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds</span><span class="s6">-&gt;</span><span class="s1">prv, newObj, ds</span><span class="s6">-&gt;</span><span class="s1">dec);</span>
                <span class="s2">return </span><span class="s1">SetError(</span>
                    <span class="s1">ds, -</span><span class="s4">1</span><span class="s1">,</span>
                    <span class="s3">&quot;Unexpected character found when decoding object value&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">JSOBJ FASTCALL_MSVC decode_any(</span><span class="s2">struct </span><span class="s1">DecoderState *ds) {</span>
    <span class="s2">for </span><span class="s1">(;;) {</span>
        <span class="s2">switch </span><span class="s1">(*ds</span><span class="s6">-&gt;</span><span class="s1">start) {</span>
            <span class="s2">case </span><span class="s3">'</span><span class="s7">\&quot;</span><span class="s3">'</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">decode_string(ds);</span>
            <span class="s2">case </span><span class="s3">'0'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'1'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'2'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'3'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'4'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'5'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'6'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'7'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'8'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'9'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'I'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'N'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'-'</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">decode_numeric(ds);</span>

            <span class="s2">case </span><span class="s3">'['</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">decode_array(ds);</span>
            <span class="s2">case </span><span class="s3">'{'</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">decode_object(ds);</span>
            <span class="s2">case </span><span class="s3">'t'</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">decode_true(ds);</span>
            <span class="s2">case </span><span class="s3">'f'</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">decode_false(ds);</span>
            <span class="s2">case </span><span class="s3">'n'</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">decode_null(ds);</span>

            <span class="s2">case </span><span class="s3">' '</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'</span><span class="s7">\t</span><span class="s3">'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'</span><span class="s7">\r</span><span class="s3">'</span><span class="s1">:</span>
            <span class="s2">case </span><span class="s3">'</span><span class="s7">\n</span><span class="s3">'</span><span class="s1">:</span>
                <span class="s0">// White space</span>
                <span class="s1">ds</span><span class="s6">-&gt;</span><span class="s1">start++;</span>
                <span class="s2">break</span><span class="s1">;</span>

            <span class="s2">default</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s1">SetError(ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Expected object or value&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">JSOBJ JSON_DecodeObject(JSONObjectDecoder *dec, </span><span class="s2">const char </span><span class="s1">*buffer,</span>
                        <span class="s1">size_t cbBuffer) {</span>
    <span class="s0">/* 
    FIXME: Base the size of escBuffer of that of cbBuffer so that the unicode 
    escaping doesn't run into the wall each time */</span>
    <span class="s2">char </span><span class="s1">*locale;</span>
    <span class="s2">struct </span><span class="s1">DecoderState ds;</span>
    <span class="s5">wchar_t </span><span class="s1">escBuffer[(JSON_MAX_STACK_BUFFER_SIZE / </span><span class="s2">sizeof</span><span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">))];</span>
    <span class="s1">JSOBJ ret;</span>

    <span class="s1">ds.start = (</span><span class="s2">char </span><span class="s1">*)buffer;</span>
    <span class="s1">ds.end = ds.start + cbBuffer;</span>

    <span class="s1">ds.escStart = escBuffer;</span>
    <span class="s1">ds.escEnd = ds.escStart + (JSON_MAX_STACK_BUFFER_SIZE / </span><span class="s2">sizeof</span><span class="s1">(</span><span class="s5">wchar_t</span><span class="s1">));</span>
    <span class="s1">ds.escHeap = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s1">ds.prv = dec</span><span class="s6">-&gt;</span><span class="s1">prv;</span>
    <span class="s1">ds.dec = dec;</span>
    <span class="s1">ds.dec</span><span class="s6">-&gt;</span><span class="s1">errorStr = NULL;</span>
    <span class="s1">ds.dec</span><span class="s6">-&gt;</span><span class="s1">errorOffset = NULL;</span>
    <span class="s1">ds.objDepth = </span><span class="s4">0</span><span class="s1">;</span>

    <span class="s1">ds.dec = dec;</span>

    <span class="s1">locale = setlocale(LC_NUMERIC, NULL);</span>
    <span class="s2">if </span><span class="s1">(strcmp(locale, </span><span class="s3">&quot;C&quot;</span><span class="s1">)) {</span>
        <span class="s1">locale = strdup(locale);</span>
        <span class="s2">if </span><span class="s1">(!locale) {</span>
            <span class="s2">return </span><span class="s1">SetError(&amp;ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Could not reserve memory block&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s1">setlocale(LC_NUMERIC, </span><span class="s3">&quot;C&quot;</span><span class="s1">);</span>
        <span class="s1">ret = decode_any(&amp;ds);</span>
        <span class="s1">setlocale(LC_NUMERIC, locale);</span>
        <span class="s1">free(locale);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s1">ret = decode_any(&amp;ds);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(ds.escHeap) {</span>
        <span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">free(ds.escStart);</span>
    <span class="s1">}</span>

    <span class="s1">SkipWhitespace(&amp;ds);</span>

    <span class="s2">if </span><span class="s1">(ds.start != ds.end &amp;&amp; ret) {</span>
        <span class="s1">dec</span><span class="s6">-&gt;</span><span class="s1">releaseObject(ds.prv, ret, ds.dec);</span>
        <span class="s2">return </span><span class="s1">SetError(&amp;ds, -</span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Trailing data&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s1">ret;</span>
<span class="s1">}</span>
</pre>
</body>
</html>