<html>
<head>
<title>io.c</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #0f9795;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
io.c</font>
</center></td></tr></table>
<pre><span class="s0">/* 
Copyright (c) 2016, PyData Development Team 
All rights reserved. 
 
Distributed under the terms of the BSD Simplified License. 
 
The full license is in the LICENSE file, distributed with this software. 
*/</span>

<span class="s2">#include </span><span class="s3">&quot;io.h&quot;</span>

<span class="s0">/* 
  On-disk FILE, uncompressed 
*/</span>

<span class="s2">void </span><span class="s1">*new_rd_source(PyObject *obj) {</span>
    <span class="s1">rd_source *rds = (rd_source *)malloc(</span><span class="s2">sizeof</span><span class="s1">(rd_source));</span>

    <span class="s2">if </span><span class="s1">(rds == NULL) {</span>
        <span class="s1">PyErr_NoMemory();</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">}</span>
    <span class="s0">/* hold on to this object */</span>
    <span class="s1">Py_INCREF(obj);</span>
    <span class="s1">rds</span><span class="s4">-&gt;</span><span class="s1">obj = obj;</span>
    <span class="s1">rds</span><span class="s4">-&gt;</span><span class="s1">buffer = NULL;</span>
    <span class="s1">rds</span><span class="s4">-&gt;</span><span class="s1">position = </span><span class="s5">0</span><span class="s1">;</span>

    <span class="s2">return </span><span class="s1">(</span><span class="s2">void </span><span class="s1">*)rds;</span>
<span class="s1">}</span>

<span class="s0">/* 
 
  Cleanup callbacks 
 
 */</span>

<span class="s2">int </span><span class="s1">del_rd_source(</span><span class="s2">void </span><span class="s1">*rds) {</span>
    <span class="s1">Py_XDECREF(RDS(rds)</span><span class="s4">-&gt;</span><span class="s1">obj);</span>
    <span class="s1">Py_XDECREF(RDS(rds)</span><span class="s4">-&gt;</span><span class="s1">buffer);</span>
    <span class="s1">free(rds);</span>

    <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">/* 
 
  IO callbacks 
 
 */</span>

<span class="s2">void </span><span class="s1">*buffer_rd_bytes(</span><span class="s2">void </span><span class="s1">*source, size_t nbytes, size_t *bytes_read,</span>
                      <span class="s2">int </span><span class="s1">*status, </span><span class="s2">const char </span><span class="s1">*encoding_errors) {</span>
    <span class="s1">PyGILState_STATE state;</span>
    <span class="s1">PyObject *result, *func, *args, *tmp;</span>

    <span class="s2">void </span><span class="s1">*retval;</span>

    <span class="s1">size_t length;</span>
    <span class="s1">rd_source *src = RDS(source);</span>
    <span class="s1">state = PyGILState_Ensure();</span>

    <span class="s0">/* delete old object */</span>
    <span class="s1">Py_XDECREF(src</span><span class="s4">-&gt;</span><span class="s1">buffer);</span>
    <span class="s1">src</span><span class="s4">-&gt;</span><span class="s1">buffer = NULL;</span>
    <span class="s1">args = Py_BuildValue(</span><span class="s3">&quot;(i)&quot;</span><span class="s1">, nbytes);</span>

    <span class="s1">func = PyObject_GetAttrString(src</span><span class="s4">-&gt;</span><span class="s1">obj, </span><span class="s3">&quot;read&quot;</span><span class="s1">);</span>

    <span class="s0">/* TODO: does this release the GIL? */</span>
    <span class="s1">result = PyObject_CallObject(func, args);</span>
    <span class="s1">Py_XDECREF(args);</span>
    <span class="s1">Py_XDECREF(func);</span>

    <span class="s2">if </span><span class="s1">(result == NULL) {</span>
        <span class="s1">PyGILState_Release(state);</span>
        <span class="s1">*bytes_read = </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s1">*status = CALLING_READ_FAILED;</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!PyBytes_Check(result)) {</span>
        <span class="s1">tmp = PyUnicode_AsEncodedString(result, </span><span class="s3">&quot;utf-8&quot;</span><span class="s1">, encoding_errors);</span>
        <span class="s1">Py_DECREF(result);</span>
        <span class="s2">if </span><span class="s1">(tmp == NULL) {</span>
            <span class="s1">PyGILState_Release(state);</span>
            <span class="s2">return </span><span class="s1">NULL;</span>
        <span class="s1">}</span>
        <span class="s1">result = tmp;</span>
    <span class="s1">}</span>

    <span class="s1">length = PySequence_Length(result);</span>

    <span class="s2">if </span><span class="s1">(length == </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">*status = REACHED_EOF;</span>
    <span class="s2">else</span>
        <span class="s1">*status = </span><span class="s5">0</span><span class="s1">;</span>

    <span class="s0">/* hang on to the Python object */</span>
    <span class="s1">src</span><span class="s4">-&gt;</span><span class="s1">buffer = result;</span>
    <span class="s1">retval = (</span><span class="s2">void </span><span class="s1">*)PyBytes_AsString(result);</span>

    <span class="s1">PyGILState_Release(state);</span>

    <span class="s0">/* TODO: more error handling */</span>
    <span class="s1">*bytes_read = length;</span>

    <span class="s2">return </span><span class="s1">retval;</span>
<span class="s1">}</span>
</pre>
</body>
</html>