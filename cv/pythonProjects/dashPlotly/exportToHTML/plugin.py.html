<html>
<head>
<title>plugin.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
plugin.py</font>
</center></td></tr></table>
<pre><span class="s0"># pylint: disable=missing-docstring,redefined-outer-name</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">.consts </span><span class="s2">import </span><span class="s1">SELENIUM_GRID_DEFAULT</span>


<span class="s2">try</span><span class="s1">:</span>
    <span class="s2">from </span><span class="s1">dash.testing.application_runners </span><span class="s2">import </span><span class="s1">(</span>
        <span class="s1">ThreadedRunner</span><span class="s2">,</span>
        <span class="s1">ProcessRunner</span><span class="s2">,</span>
        <span class="s1">RRunner</span><span class="s2">,</span>
        <span class="s1">JuliaRunner</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">from </span><span class="s1">dash.testing.browser </span><span class="s2">import </span><span class="s1">Browser</span>
    <span class="s2">from </span><span class="s1">dash.testing.composite </span><span class="s2">import </span><span class="s1">DashComposite</span><span class="s2">, </span><span class="s1">DashRComposite</span><span class="s2">, </span><span class="s1">DashJuliaComposite</span>
<span class="s2">except </span><span class="s1">ImportError:</span>
    <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">pytest_addoption(parser):</span>
    <span class="s1">dash = parser.getgroup(</span><span class="s3">&quot;Dash&quot;</span><span class="s2">, </span><span class="s3">&quot;Dash Integration Tests&quot;</span><span class="s1">)</span>

    <span class="s1">dash.addoption(</span>
        <span class="s3">&quot;--webdriver&quot;</span><span class="s2">,</span>
        <span class="s1">choices=(</span><span class="s3">&quot;Chrome&quot;</span><span class="s2">, </span><span class="s3">&quot;Firefox&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">default=</span><span class="s3">&quot;Chrome&quot;</span><span class="s2">,</span>
        <span class="s1">help=</span><span class="s3">&quot;Name of the selenium driver to use&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">dash.addoption(</span>
        <span class="s3">&quot;--remote&quot;</span><span class="s2">, </span><span class="s1">action=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">, </span><span class="s1">help=</span><span class="s3">&quot;instruct pytest to use selenium grid&quot;</span>
    <span class="s1">)</span>

    <span class="s1">dash.addoption(</span>
        <span class="s3">&quot;--remote-url&quot;</span><span class="s2">,</span>
        <span class="s1">action=</span><span class="s3">&quot;store&quot;</span><span class="s2">,</span>
        <span class="s1">default=SELENIUM_GRID_DEFAULT</span><span class="s2">,</span>
        <span class="s1">help=</span><span class="s3">&quot;set a different selenium grid remote url if other than default&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">dash.addoption(</span>
        <span class="s3">&quot;--headless&quot;</span><span class="s2">, </span><span class="s1">action=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">, </span><span class="s1">help=</span><span class="s3">&quot;set this flag to run in headless mode&quot;</span>
    <span class="s1">)</span>

    <span class="s1">dash.addoption(</span>
        <span class="s3">&quot;--percy-assets&quot;</span><span class="s2">,</span>
        <span class="s1">action=</span><span class="s3">&quot;store&quot;</span><span class="s2">,</span>
        <span class="s1">default=</span><span class="s3">&quot;tests/assets&quot;</span><span class="s2">,</span>
        <span class="s1">help=</span><span class="s3">&quot;configure how Percy will discover your app's assets&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">dash.addoption(</span>
        <span class="s3">&quot;--nopercyfinalize&quot;</span><span class="s2">,</span>
        <span class="s1">action=</span><span class="s3">&quot;store_false&quot;</span><span class="s2">,</span>
        <span class="s1">help=</span><span class="s3">&quot;set this flag to control percy finalize at CI level&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">dash.addoption(</span>
        <span class="s3">&quot;--pause&quot;</span><span class="s2">,</span>
        <span class="s1">action=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">,</span>
        <span class="s1">help=</span><span class="s3">&quot;pause using pdb after opening the test app, so you can interact with it&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.tryfirst</span>
<span class="s2">def </span><span class="s1">pytest_addhooks(pluginmanager):</span>
    <span class="s0"># https://github.com/pytest-dev/pytest-xdist/blob/974bd566c599dc6a9ea291838c6f226197208b46/xdist/plugin.py#L67</span>
    <span class="s0"># avoid warnings with pytest-2.8</span>
    <span class="s2">from </span><span class="s1">dash.testing </span><span class="s2">import </span><span class="s1">newhooks  </span><span class="s0"># pylint: disable=import-outside-toplevel</span>

    <span class="s1">method = getattr(pluginmanager</span><span class="s2">, </span><span class="s3">&quot;add_hookspecs&quot;</span><span class="s2">, None</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">method </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s1">method = pluginmanager.addhooks  </span><span class="s0"># pragma: no cover</span>
    <span class="s1">method(newhooks)</span>


<span class="s1">@pytest.hookimpl(tryfirst=</span><span class="s2">True, </span><span class="s1">hookwrapper=</span><span class="s2">True</span><span class="s1">)</span>
<span class="s2">def </span><span class="s1">pytest_runtest_makereport(item</span><span class="s2">, </span><span class="s1">call):  </span><span class="s0"># pylint: disable=unused-argument</span>
    <span class="s0"># execute all other hooks to obtain the report object</span>
    <span class="s1">outcome = </span><span class="s2">yield</span>
    <span class="s1">rep = outcome.get_result()</span>

    <span class="s0"># we only look at actual failing test calls, not setup/teardown</span>
    <span class="s2">if </span><span class="s1">rep.when == </span><span class="s3">&quot;call&quot; </span><span class="s2">and </span><span class="s1">rep.failed </span><span class="s2">and </span><span class="s1">hasattr(item</span><span class="s2">, </span><span class="s3">&quot;funcargs&quot;</span><span class="s1">):</span>
        <span class="s2">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">fixture </span><span class="s2">in </span><span class="s1">item.funcargs.items():</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">{</span><span class="s3">&quot;dash_duo&quot;</span><span class="s2">, </span><span class="s3">&quot;dash_br&quot;</span><span class="s2">, </span><span class="s3">&quot;dashr&quot;</span><span class="s2">, </span><span class="s3">&quot;dashjl&quot;</span><span class="s1">}:</span>
                    <span class="s1">fixture.take_snapshot(item.name)</span>
            <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e:  </span><span class="s0"># pylint: disable=broad-except</span>
                <span class="s1">print(e)</span>


<span class="s0">###############################################################################</span>
<span class="s0"># Fixtures</span>
<span class="s0">###############################################################################</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dash_thread_server():</span>
    <span class="s4">&quot;&quot;&quot;Start a local dash server in a new thread.&quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">ThreadedRunner() </span><span class="s2">as </span><span class="s1">starter:</span>
        <span class="s2">yield </span><span class="s1">starter</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dash_process_server():</span>
    <span class="s4">&quot;&quot;&quot;Start a Dash server with subprocess.Popen and waitress-serve.&quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">ProcessRunner() </span><span class="s2">as </span><span class="s1">starter:</span>
        <span class="s2">yield </span><span class="s1">starter</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dashr_server():</span>
    <span class="s2">with </span><span class="s1">RRunner() </span><span class="s2">as </span><span class="s1">starter:</span>
        <span class="s2">yield </span><span class="s1">starter</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dashjl_server():</span>
    <span class="s2">with </span><span class="s1">JuliaRunner() </span><span class="s2">as </span><span class="s1">starter:</span>
        <span class="s2">yield </span><span class="s1">starter</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dash_br(request</span><span class="s2">, </span><span class="s1">tmpdir):</span>
    <span class="s2">with </span><span class="s1">Browser(</span>
        <span class="s1">browser=request.config.getoption(</span><span class="s3">&quot;webdriver&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote=request.config.getoption(</span><span class="s3">&quot;remote&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote_url=request.config.getoption(</span><span class="s3">&quot;remote_url&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">headless=request.config.getoption(</span><span class="s3">&quot;headless&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">options=request.config.hook.pytest_setup_options()</span><span class="s2">,</span>
        <span class="s1">download_path=tmpdir.mkdir(</span><span class="s3">&quot;download&quot;</span><span class="s1">).strpath</span><span class="s2">,</span>
        <span class="s1">percy_assets_root=request.config.getoption(</span><span class="s3">&quot;percy_assets&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">percy_finalize=request.config.getoption(</span><span class="s3">&quot;nopercyfinalize&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">pause=request.config.getoption(</span><span class="s3">&quot;pause&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">) </span><span class="s2">as </span><span class="s1">browser:</span>
        <span class="s2">yield </span><span class="s1">browser</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dash_duo(request</span><span class="s2">, </span><span class="s1">dash_thread_server</span><span class="s2">, </span><span class="s1">tmpdir):</span>
    <span class="s2">with </span><span class="s1">DashComposite(</span>
        <span class="s1">dash_thread_server</span><span class="s2">,</span>
        <span class="s1">browser=request.config.getoption(</span><span class="s3">&quot;webdriver&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote=request.config.getoption(</span><span class="s3">&quot;remote&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote_url=request.config.getoption(</span><span class="s3">&quot;remote_url&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">headless=request.config.getoption(</span><span class="s3">&quot;headless&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">options=request.config.hook.pytest_setup_options()</span><span class="s2">,</span>
        <span class="s1">download_path=tmpdir.mkdir(</span><span class="s3">&quot;download&quot;</span><span class="s1">).strpath</span><span class="s2">,</span>
        <span class="s1">percy_assets_root=request.config.getoption(</span><span class="s3">&quot;percy_assets&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">percy_finalize=request.config.getoption(</span><span class="s3">&quot;nopercyfinalize&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">pause=request.config.getoption(</span><span class="s3">&quot;pause&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">) </span><span class="s2">as </span><span class="s1">dc:</span>
        <span class="s2">yield </span><span class="s1">dc</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dashr(request</span><span class="s2">, </span><span class="s1">dashr_server</span><span class="s2">, </span><span class="s1">tmpdir):</span>
    <span class="s2">with </span><span class="s1">DashRComposite(</span>
        <span class="s1">dashr_server</span><span class="s2">,</span>
        <span class="s1">browser=request.config.getoption(</span><span class="s3">&quot;webdriver&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote=request.config.getoption(</span><span class="s3">&quot;remote&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote_url=request.config.getoption(</span><span class="s3">&quot;remote_url&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">headless=request.config.getoption(</span><span class="s3">&quot;headless&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">options=request.config.hook.pytest_setup_options()</span><span class="s2">,</span>
        <span class="s1">download_path=tmpdir.mkdir(</span><span class="s3">&quot;download&quot;</span><span class="s1">).strpath</span><span class="s2">,</span>
        <span class="s1">percy_assets_root=request.config.getoption(</span><span class="s3">&quot;percy_assets&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">percy_finalize=request.config.getoption(</span><span class="s3">&quot;nopercyfinalize&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">pause=request.config.getoption(</span><span class="s3">&quot;pause&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">) </span><span class="s2">as </span><span class="s1">dc:</span>
        <span class="s2">yield </span><span class="s1">dc</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">dashjl(request</span><span class="s2">, </span><span class="s1">dashjl_server</span><span class="s2">, </span><span class="s1">tmpdir):</span>
    <span class="s2">with </span><span class="s1">DashJuliaComposite(</span>
        <span class="s1">dashjl_server</span><span class="s2">,</span>
        <span class="s1">browser=request.config.getoption(</span><span class="s3">&quot;webdriver&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote=request.config.getoption(</span><span class="s3">&quot;remote&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">remote_url=request.config.getoption(</span><span class="s3">&quot;remote_url&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">headless=request.config.getoption(</span><span class="s3">&quot;headless&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">options=request.config.hook.pytest_setup_options()</span><span class="s2">,</span>
        <span class="s1">download_path=tmpdir.mkdir(</span><span class="s3">&quot;download&quot;</span><span class="s1">).strpath</span><span class="s2">,</span>
        <span class="s1">percy_assets_root=request.config.getoption(</span><span class="s3">&quot;percy_assets&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">percy_finalize=request.config.getoption(</span><span class="s3">&quot;nopercyfinalize&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">pause=request.config.getoption(</span><span class="s3">&quot;pause&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">) </span><span class="s2">as </span><span class="s1">dc:</span>
        <span class="s2">yield </span><span class="s1">dc</span>


<span class="s1">@pytest.fixture</span>
<span class="s2">def </span><span class="s1">diskcache_manager():</span>
    <span class="s2">from </span><span class="s1">dash.long_callback </span><span class="s2">import </span><span class="s1">(  </span><span class="s0"># pylint: disable=import-outside-toplevel</span>
        <span class="s1">DiskcacheLongCallbackManager</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s2">return </span><span class="s1">DiskcacheLongCallbackManager()</span>
</pre>
</body>
</html>