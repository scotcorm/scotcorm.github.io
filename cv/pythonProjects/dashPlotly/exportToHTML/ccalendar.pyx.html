<html>
<head>
<title>ccalendar.pyx</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ccalendar.pyx</font>
</center></td></tr></table>
<pre><span class="s0"># cython: boundscheck=False</span>
<span class="s0">&quot;&quot;&quot;</span>
<span class="s0">Cython implementations of functions resembling the stdlib calendar module</span>
<span class="s0">&quot;&quot;&quot;</span>

<span class="s0">import cython</span>

<span class="s0">from numpy cimport (</span>
    <span class="s0">int32_t,</span>
    <span class="s0">int64_t,</span>
<span class="s0">)</span>

<span class="s0"># ----------------------------------------------------------------------</span>
<span class="s0"># Constants</span>

<span class="s0"># Slightly more performant cython lookups than a 2D table</span>
<span class="s0"># The first 12 entries correspond to month lengths for non-leap years.</span>
<span class="s0"># The remaining 12 entries give month lengths for leap years</span>
<span class="s0">cdef int32_t* days_per_month_array = [</span>
    <span class="s0">31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31,</span>
    <span class="s0">31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]</span>

<span class="s0">cdef int* sakamoto_arr = [0, 3, 2, 5, 0, 3, 5, 1, 4, 6, 2, 4]</span>

<span class="s0"># The first 13 entries give the month days elapsed as of the first of month N</span>
<span class="s0"># (or the total number of days in the year for N=13) in non-leap years.</span>
<span class="s0"># The remaining 13 entries give the days elapsed in leap years.</span>
<span class="s0">cdef int32_t* month_offset = [</span>
    <span class="s0">0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365,</span>
    <span class="s0">0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366]</span>

<span class="s0"># Canonical location for other modules to find name constants</span>
<span class="s0">MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL',</span>
          <span class="s0">'AUG', 'SEP', 'OCT', 'NOV', 'DEC']</span>
<span class="s0"># The first blank line is consistent with calendar.month_name in the calendar</span>
<span class="s0"># standard library</span>
<span class="s0">MONTHS_FULL = ['', 'January', 'February', 'March', 'April', 'May', 'June',</span>
               <span class="s0">'July', 'August', 'September', 'October', 'November',</span>
               <span class="s0">'December']</span>
<span class="s0">MONTH_NUMBERS = {name: num for num, name in enumerate(MONTHS)}</span>
<span class="s0">cdef dict c_MONTH_NUMBERS = MONTH_NUMBERS</span>
<span class="s0">MONTH_ALIASES = {(num + 1): name for num, name in enumerate(MONTHS)}</span>
<span class="s0">MONTH_TO_CAL_NUM = {name: num + 1 for num, name in enumerate(MONTHS)}</span>

<span class="s0">DAYS = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN']</span>
<span class="s0">DAYS_FULL = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday',</span>
             <span class="s0">'Saturday', 'Sunday']</span>
<span class="s0">int_to_weekday = {num: name for num, name in enumerate(DAYS)}</span>
<span class="s0">weekday_to_int = {int_to_weekday[key]: key for key in int_to_weekday}</span>

<span class="s0">DAY_SECONDS = 86400</span>
<span class="s0">HOUR_SECONDS = 3600</span>

<span class="s0">cdef int64_t DAY_NANOS = DAY_SECONDS * 1_000_000_000</span>
<span class="s0">cdef int64_t HOUR_NANOS = HOUR_SECONDS * 1_000_000_000</span>

<span class="s0"># ----------------------------------------------------------------------</span>


<span class="s0">@cython.wraparound(False)</span>
<span class="s0">@cython.boundscheck(False)</span>
<span class="s0">cpdef int32_t get_days_in_month(int year, Py_ssize_t month) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Return the number of days in the given month of the given year.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">year : int</span>
    <span class="s0">month : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">days_in_month : int</span>

    <span class="s0">Notes</span>
    <span class="s0">-----</span>
    <span class="s0">Assumes that the arguments are valid.  Passing a month not between 1 and 12</span>
    <span class="s0">risks a segfault.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">return days_per_month_array[12 * is_leapyear(year) + month - 1]</span>


<span class="s0">@cython.wraparound(False)</span>
<span class="s0">@cython.boundscheck(False)</span>
<span class="s0">@cython.cdivision</span>
<span class="s0">cdef int dayofweek(int y, int m, int d) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Find the day of week for the date described by the Y/M/D triple y, m, d</span>
    <span class="s0">using Sakamoto's method, from wikipedia.</span>

    <span class="s0">0 represents Monday.  See [1]_.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">y : int</span>
    <span class="s0">m : int</span>
    <span class="s0">d : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">weekday : int</span>

    <span class="s0">Notes</span>
    <span class="s0">-----</span>
    <span class="s0">Assumes that y, m, d, represents a valid date.</span>

    <span class="s0">See Also</span>
    <span class="s0">--------</span>
    <span class="s0">[1] https://docs.python.org/3/library/calendar.html#calendar.weekday</span>

    <span class="s0">[2] https://en.wikipedia.org/wiki/\</span>
    <span class="s0">Determination_of_the_day_of_the_week#Sakamoto.27s_methods</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">cdef:</span>
        <span class="s0">int day</span>

    <span class="s0">y -= m &lt; 3</span>
    <span class="s0">day = (y + y / 4 - y / 100 + y / 400 + sakamoto_arr[m - 1] + d) % 7</span>
    <span class="s0"># convert to python day</span>
    <span class="s0">return (day + 6) % 7</span>


<span class="s0">cdef bint is_leapyear(int64_t year) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Returns 1 if the given year is a leap year, 0 otherwise.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">year : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">is_leap : bool</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">return ((year &amp; 0x3) == 0 and  # year % 4 == 0</span>
            <span class="s0">((year % 100) != 0 or (year % 400) == 0))</span>


<span class="s0">@cython.wraparound(False)</span>
<span class="s0">@cython.boundscheck(False)</span>
<span class="s0">cpdef int32_t get_week_of_year(int year, int month, int day) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Return the ordinal week-of-year for the given day.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">year : int</span>
    <span class="s0">month : int</span>
    <span class="s0">day : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">week_of_year : int32_t</span>

    <span class="s0">Notes</span>
    <span class="s0">-----</span>
    <span class="s0">Assumes the inputs describe a valid date.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">return get_iso_calendar(year, month, day)[1]</span>


<span class="s0">@cython.wraparound(False)</span>
<span class="s0">@cython.boundscheck(False)</span>
<span class="s0">cpdef iso_calendar_t get_iso_calendar(int year, int month, int day) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Return the year, week, and day of year corresponding to ISO 8601</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">year : int</span>
    <span class="s0">month : int</span>
    <span class="s0">day : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">year : int32_t</span>
    <span class="s0">week : int32_t</span>
    <span class="s0">day : int32_t</span>

    <span class="s0">Notes</span>
    <span class="s0">-----</span>
    <span class="s0">Assumes the inputs describe a valid date.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">cdef:</span>
        <span class="s0">int32_t doy, dow</span>
        <span class="s0">int32_t iso_year, iso_week</span>

    <span class="s0">doy = get_day_of_year(year, month, day)</span>
    <span class="s0">dow = dayofweek(year, month, day)</span>

    <span class="s0"># estimate</span>
    <span class="s0">iso_week = (doy - 1) - dow + 3</span>
    <span class="s0">if iso_week &gt;= 0:</span>
        <span class="s0">iso_week = iso_week // 7 + 1</span>

    <span class="s0"># verify</span>
    <span class="s0">if iso_week &lt; 0:</span>
        <span class="s0">if (iso_week &gt; -2) or (iso_week == -2 and is_leapyear(year - 1)):</span>
            <span class="s0">iso_week = 53</span>
        <span class="s0">else:</span>
            <span class="s0">iso_week = 52</span>
    <span class="s0">elif iso_week == 53:</span>
        <span class="s0">if 31 - day + dow &lt; 3:</span>
            <span class="s0">iso_week = 1</span>

    <span class="s0">iso_year = year</span>
    <span class="s0">if iso_week == 1 and month == 12:</span>
        <span class="s0">iso_year += 1</span>

    <span class="s0">elif iso_week &gt;= 52 and month == 1:</span>
        <span class="s0">iso_year -= 1</span>

    <span class="s0">return iso_year, iso_week, dow + 1</span>


<span class="s0">@cython.wraparound(False)</span>
<span class="s0">@cython.boundscheck(False)</span>
<span class="s0">cpdef int32_t get_day_of_year(int year, int month, int day) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Return the ordinal day-of-year for the given day.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">year : int</span>
    <span class="s0">month : int</span>
    <span class="s0">day : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">day_of_year : int32_t</span>

    <span class="s0">Notes</span>
    <span class="s0">-----</span>
    <span class="s0">Assumes the inputs describe a valid date.</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">cdef:</span>
        <span class="s0">bint isleap</span>
        <span class="s0">int32_t mo_off</span>
        <span class="s0">int day_of_year</span>

    <span class="s0">isleap = is_leapyear(year)</span>

    <span class="s0">mo_off = month_offset[isleap * 13 + month - 1]</span>

    <span class="s0">day_of_year = mo_off + day</span>
    <span class="s0">return day_of_year</span>


<span class="s0"># ---------------------------------------------------------------------</span>
<span class="s0"># Business Helpers</span>

<span class="s0">cpdef int get_lastbday(int year, int month) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Find the last day of the month that is a business day.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">year : int</span>
    <span class="s0">month : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">last_bday : int</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">cdef:</span>
        <span class="s0">int wkday, days_in_month</span>

    <span class="s0">wkday = dayofweek(year, month, 1)</span>
    <span class="s0">days_in_month = get_days_in_month(year, month)</span>
    <span class="s0">return days_in_month - max(((wkday + days_in_month - 1) % 7) - 4, 0)</span>


<span class="s0">cpdef int get_firstbday(int year, int month) nogil:</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">Find the first day of the month that is a business day.</span>

    <span class="s0">Parameters</span>
    <span class="s0">----------</span>
    <span class="s0">year : int</span>
    <span class="s0">month : int</span>

    <span class="s0">Returns</span>
    <span class="s0">-------</span>
    <span class="s0">first_bday : int</span>
    <span class="s0">&quot;&quot;&quot;</span>
    <span class="s0">cdef:</span>
        <span class="s0">int first, wkday</span>

    <span class="s0">wkday = dayofweek(year, month, 1)</span>
    <span class="s0">first = 1</span>
    <span class="s0">if wkday == 5:  # on Saturday</span>
        <span class="s0">first = 3</span>
    <span class="s0">elif wkday == 6:  # on Sunday</span>
        <span class="s0">first = 2</span>
    <span class="s0">return first</span>
</pre>
</body>
</html>