<html>
<head>
<title>test_operators.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_operators.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Categorical</span><span class="s0">,</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.tests.arrays.categorical.common </span><span class="s0">import </span><span class="s1">TestCategorical</span>


<span class="s0">class </span><span class="s1">TestCategoricalOpsWithFactor(TestCategorical):</span>
    <span class="s0">def </span><span class="s1">test_categories_none_comparisons(self):</span>
        <span class="s1">factor = Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_categorical_equal(factor</span><span class="s0">, </span><span class="s1">self.factor)</span>

    <span class="s0">def </span><span class="s1">test_comparisons(self):</span>
        <span class="s1">result = self.factor[self.factor == </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">expected = self.factor[np.asarray(self.factor) == </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_categorical_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = self.factor[self.factor != </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">expected = self.factor[np.asarray(self.factor) != </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_categorical_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = self.factor[self.factor &lt; </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">expected = self.factor[np.asarray(self.factor) &lt; </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_categorical_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = self.factor[self.factor &gt; </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">expected = self.factor[np.asarray(self.factor) &gt; </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_categorical_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = self.factor[self.factor &gt;= </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s1">expected = self.factor[np.asarray(self.factor) &gt;= </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_categorical_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = self.factor[self.factor &lt;= </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s1">expected = self.factor[np.asarray(self.factor) &lt;= </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>
        <span class="s1">tm.assert_categorical_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">n = len(self.factor)</span>

        <span class="s1">other = self.factor[np.random.permutation(n)]</span>
        <span class="s1">result = self.factor == other</span>
        <span class="s1">expected = np.asarray(self.factor) == np.asarray(other)</span>
        <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = self.factor == </span><span class="s2">&quot;d&quot;</span>
        <span class="s1">expected = np.zeros(len(self.factor)</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s3"># comparisons with categoricals</span>
        <span class="s1">cat_rev = Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">cat_rev_base = Categorical(</span>
            <span class="s1">[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s1">cat = Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">cat_base = Categorical([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=cat.categories</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s3"># comparisons need to take categories ordering into account</span>
        <span class="s1">res_rev = cat_rev &gt; cat_rev_base</span>
        <span class="s1">exp_rev = np.array([</span><span class="s0">True, False, False</span><span class="s1">])</span>
        <span class="s1">tm.assert_numpy_array_equal(res_rev</span><span class="s0">, </span><span class="s1">exp_rev)</span>

        <span class="s1">res_rev = cat_rev &lt; cat_rev_base</span>
        <span class="s1">exp_rev = np.array([</span><span class="s0">False, False, True</span><span class="s1">])</span>
        <span class="s1">tm.assert_numpy_array_equal(res_rev</span><span class="s0">, </span><span class="s1">exp_rev)</span>

        <span class="s1">res = cat &gt; cat_base</span>
        <span class="s1">exp = np.array([</span><span class="s0">False, False, True</span><span class="s1">])</span>
        <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s3"># Only categories with same categories can be compared</span>
        <span class="s1">msg = </span><span class="s2">&quot;Categoricals can only be compared if 'categories' are the same&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; cat_rev</span>

        <span class="s1">cat_rev_base2 = Categorical([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">])</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat_rev &gt; cat_rev_base2</span>

        <span class="s3"># Only categories with same ordering information can be compared</span>
        <span class="s1">cat_unorderd = cat.set_ordered(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert not </span><span class="s1">(cat &gt; cat).any()</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; cat_unorderd</span>

        <span class="s3"># comparison (in both directions) with Series will raise</span>
        <span class="s1">s = Series([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">msg = (</span>
            <span class="s2">&quot;Cannot compare a Categorical for op __gt__ with type &quot;</span>
            <span class="s2">r&quot;&lt;class 'numpy\.ndarray'&gt;&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; s</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat_rev &gt; s</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">s &lt; cat</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">s &lt; cat_rev</span>

        <span class="s3"># comparison with numpy.array will raise in both direction, but only on</span>
        <span class="s3"># newer numpy versions</span>
        <span class="s1">a = np.array([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; a</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat_rev &gt; a</span>

        <span class="s3"># Make sure that unequal comparison take the categories order in</span>
        <span class="s3"># account</span>
        <span class="s1">cat_rev = Categorical(list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">categories=list(</span><span class="s2">&quot;cba&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">exp = np.array([</span><span class="s0">True, False, False</span><span class="s1">])</span>
        <span class="s1">res = cat_rev &gt; </span><span class="s2">&quot;b&quot;</span>
        <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s3"># check that zero-dim array gets unboxed</span>
        <span class="s1">res = cat_rev &gt; np.array(</span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_numpy_array_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>


<span class="s0">class </span><span class="s1">TestCategoricalOps:</span>
    <span class="s0">def </span><span class="s1">test_compare_frame(self):</span>
        <span class="s3"># GH#24282 check that Categorical.__cmp__(DataFrame) defers to frame</span>
        <span class="s1">data = [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span>
        <span class="s1">cat = Categorical(data)</span>

        <span class="s1">df = DataFrame(cat)</span>

        <span class="s1">result = cat == df.T</span>
        <span class="s1">expected = DataFrame([[</span><span class="s0">True, True, True, True</span><span class="s1">]])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = cat[::-</span><span class="s4">1</span><span class="s1">] != df.T</span>
        <span class="s1">expected = DataFrame([[</span><span class="s0">False, True, True, False</span><span class="s1">]])</span>
        <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_compare_frame_raises(self</span><span class="s0">, </span><span class="s1">comparison_op):</span>
        <span class="s3"># alignment raises unless we transpose</span>
        <span class="s1">op = comparison_op</span>
        <span class="s1">cat = Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s1">df = DataFrame(cat)</span>
        <span class="s1">msg = </span><span class="s2">&quot;Unable to coerce to Series, length must be 1: given 4&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">op(cat</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s0">def </span><span class="s1">test_datetime_categorical_comparison(self):</span>
        <span class="s1">dt_cat = Categorical(date_range(</span><span class="s2">&quot;2014-01-01&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_numpy_array_equal(dt_cat &gt; dt_cat[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">False, True, True</span><span class="s1">]))</span>
        <span class="s1">tm.assert_numpy_array_equal(dt_cat[</span><span class="s4">0</span><span class="s1">] &lt; dt_cat</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">False, True, True</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_reflected_comparison_with_scalars(self):</span>
        <span class="s3"># GH8658</span>
        <span class="s1">cat = Categorical([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_numpy_array_equal(cat &gt; cat[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">False, True, True</span><span class="s1">]))</span>
        <span class="s1">tm.assert_numpy_array_equal(cat[</span><span class="s4">0</span><span class="s1">] &lt; cat</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">False, True, True</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_comparison_with_unknown_scalars(self):</span>
        <span class="s3"># https://github.com/pandas-dev/pandas/issues/9836#issuecomment-92123057</span>
        <span class="s3"># and following comparisons with scalars not in categories should raise</span>
        <span class="s3"># for unequal comps, but not for equal/not equal</span>
        <span class="s1">cat = Categorical([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">msg = </span><span class="s2">&quot;Invalid comparison between dtype=category and int&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &lt; </span><span class="s4">4</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; </span><span class="s4">4</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s4">4 </span><span class="s1">&lt; cat</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s4">4 </span><span class="s1">&gt; cat</span>

        <span class="s1">tm.assert_numpy_array_equal(cat == </span><span class="s4">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">False, False, False</span><span class="s1">]))</span>
        <span class="s1">tm.assert_numpy_array_equal(cat != </span><span class="s4">4</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">True, True, True</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_comparison_with_tuple(self):</span>
        <span class="s1">cat = Categorical(np.array([</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=object))</span>

        <span class="s1">result = cat == </span><span class="s2">&quot;foo&quot;</span>
        <span class="s1">expected = np.array([</span><span class="s0">True, False, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = cat == (</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">expected = np.array([</span><span class="s0">False, True, False, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
        <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">result = cat != (</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">tm.assert_numpy_array_equal(result</span><span class="s0">, </span><span class="s1">~expected)</span>

    <span class="s0">def </span><span class="s1">test_comparison_of_ordered_categorical_with_nan_to_scalar(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">compare_operators_no_eq_ne</span>
    <span class="s1">):</span>
        <span class="s3"># https://github.com/pandas-dev/pandas/issues/26504</span>
        <span class="s3"># BUG: fix ordered categorical comparison with missing values (#26504 )</span>
        <span class="s3"># and following comparisons with scalars in categories with missing</span>
        <span class="s3"># values should be evaluated as False</span>

        <span class="s1">cat = Categorical([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">scalar = </span><span class="s4">2</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
            <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">RuntimeWarning)</span>
            <span class="s1">expected = getattr(np.array(cat)</span><span class="s0">, </span><span class="s1">compare_operators_no_eq_ne)(scalar)</span>
        <span class="s1">actual = getattr(cat</span><span class="s0">, </span><span class="s1">compare_operators_no_eq_ne)(scalar)</span>
        <span class="s1">tm.assert_numpy_array_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_comparison_of_ordered_categorical_with_nan_to_listlike(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">compare_operators_no_eq_ne</span>
    <span class="s1">):</span>
        <span class="s3"># https://github.com/pandas-dev/pandas/issues/26504</span>
        <span class="s3"># and following comparisons of missing values in ordered Categorical</span>
        <span class="s3"># with listlike should be evaluated as False</span>

        <span class="s1">cat = Categorical([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">other = Categorical([</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
            <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">RuntimeWarning)</span>
            <span class="s1">expected = getattr(np.array(cat)</span><span class="s0">, </span><span class="s1">compare_operators_no_eq_ne)(</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">actual = getattr(cat</span><span class="s0">, </span><span class="s1">compare_operators_no_eq_ne)(other)</span>
        <span class="s1">tm.assert_numpy_array_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;data,reverse,base&quot;</span><span class="s0">,</span>
        <span class="s1">[(list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(</span><span class="s2">&quot;cba&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(</span><span class="s2">&quot;bbb&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_comparisons(self</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">reverse</span><span class="s0">, </span><span class="s1">base):</span>
        <span class="s1">cat_rev = Series(Categorical(data</span><span class="s0">, </span><span class="s1">categories=reverse</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">))</span>
        <span class="s1">cat_rev_base = Series(Categorical(base</span><span class="s0">, </span><span class="s1">categories=reverse</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">))</span>
        <span class="s1">cat = Series(Categorical(data</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">))</span>
        <span class="s1">cat_base = Series(</span>
            <span class="s1">Categorical(base</span><span class="s0">, </span><span class="s1">categories=cat.cat.categories</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">s = Series(base)</span>
        <span class="s1">a = np.array(base)</span>

        <span class="s3"># comparisons need to take categories ordering into account</span>
        <span class="s1">res_rev = cat_rev &gt; cat_rev_base</span>
        <span class="s1">exp_rev = Series([</span><span class="s0">True, False, False</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(res_rev</span><span class="s0">, </span><span class="s1">exp_rev)</span>

        <span class="s1">res_rev = cat_rev &lt; cat_rev_base</span>
        <span class="s1">exp_rev = Series([</span><span class="s0">False, False, True</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(res_rev</span><span class="s0">, </span><span class="s1">exp_rev)</span>

        <span class="s1">res = cat &gt; cat_base</span>
        <span class="s1">exp = Series([</span><span class="s0">False, False, True</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>

        <span class="s1">scalar = base[</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">res = cat &gt; scalar</span>
        <span class="s1">exp = Series([</span><span class="s0">False, False, True</span><span class="s1">])</span>
        <span class="s1">exp2 = cat.values &gt; scalar</span>
        <span class="s1">tm.assert_series_equal(res</span><span class="s0">, </span><span class="s1">exp)</span>
        <span class="s1">tm.assert_numpy_array_equal(res.values</span><span class="s0">, </span><span class="s1">exp2)</span>
        <span class="s1">res_rev = cat_rev &gt; scalar</span>
        <span class="s1">exp_rev = Series([</span><span class="s0">True, False, False</span><span class="s1">])</span>
        <span class="s1">exp_rev2 = cat_rev.values &gt; scalar</span>
        <span class="s1">tm.assert_series_equal(res_rev</span><span class="s0">, </span><span class="s1">exp_rev)</span>
        <span class="s1">tm.assert_numpy_array_equal(res_rev.values</span><span class="s0">, </span><span class="s1">exp_rev2)</span>

        <span class="s3"># Only categories with same categories can be compared</span>
        <span class="s1">msg = </span><span class="s2">&quot;Categoricals can only be compared if 'categories' are the same&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; cat_rev</span>

        <span class="s3"># categorical cannot be compared to Series or numpy array, and also</span>
        <span class="s3"># not the other way around</span>
        <span class="s1">msg = (</span>
            <span class="s2">&quot;Cannot compare a Categorical for op __gt__ with type &quot;</span>
            <span class="s2">r&quot;&lt;class 'numpy\.ndarray'&gt;&quot;</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; s</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat_rev &gt; s</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat &gt; a</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">cat_rev &gt; a</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">s &lt; cat</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">s &lt; cat_rev</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">a &lt; cat</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">a &lt; cat_rev</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s2">&quot;ctor&quot;</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s0">lambda </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs: Categorical(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs: Series(Categorical(*args</span><span class="s0">, </span><span class="s1">**kwargs))</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_unordered_different_order_equal(self</span><span class="s0">, </span><span class="s1">ctor):</span>
        <span class="s3"># https://github.com/pandas-dev/pandas/issues/16014</span>
        <span class="s1">c1 = ctor([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">c2 = ctor([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(c1 == c2).all()</span>

        <span class="s1">c1 = ctor([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">c2 = ctor([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(c1 != c2).all()</span>

        <span class="s1">c1 = ctor([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">c2 = ctor([</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(c1 != c2).all()</span>

        <span class="s1">c1 = ctor([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">c2 = ctor([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">result = c1 == c2</span>
        <span class="s1">tm.assert_numpy_array_equal(np.array(result)</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">True, False</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_unordered_different_categories_raises(self):</span>
        <span class="s1">c1 = Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">c2 = Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=(</span><span class="s2">&quot;Categoricals can only be compared&quot;</span><span class="s1">)):</span>
            <span class="s1">c1 == c2</span>

    <span class="s0">def </span><span class="s1">test_compare_different_lengths(self):</span>
        <span class="s1">c1 = Categorical([]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">c2 = Categorical([]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>

        <span class="s1">msg = </span><span class="s2">&quot;Categoricals can only be compared if 'categories' are the same.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">c1 == c2</span>

    <span class="s0">def </span><span class="s1">test_compare_unordered_different_order(self):</span>
        <span class="s3"># https://github.com/pandas-dev/pandas/issues/16603#issuecomment-</span>
        <span class="s3"># 349290078</span>
        <span class="s1">a = Categorical([</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
        <span class="s1">b = Categorical([</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
        <span class="s0">assert not </span><span class="s1">a.equals(b)</span>

    <span class="s0">def </span><span class="s1">test_numeric_like_ops(self):</span>

        <span class="s1">df = DataFrame({</span><span class="s2">&quot;value&quot;</span><span class="s1">: np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10000</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)})</span>
        <span class="s1">labels = [</span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">i</span><span class="s0">} </span><span class="s2">- </span><span class="s0">{</span><span class="s1">i + </span><span class="s4">499</span><span class="s0">}</span><span class="s2">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10000</span><span class="s0">, </span><span class="s4">500</span><span class="s1">)]</span>
        <span class="s1">cat_labels = Categorical(labels</span><span class="s0">, </span><span class="s1">labels)</span>

        <span class="s1">df = df.sort_values(by=[</span><span class="s2">&quot;value&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ascending=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;value_group&quot;</span><span class="s1">] = pd.cut(</span>
            <span class="s1">df.value</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10500</span><span class="s0">, </span><span class="s4">500</span><span class="s1">)</span><span class="s0">, </span><span class="s1">right=</span><span class="s0">False, </span><span class="s1">labels=cat_labels</span>
        <span class="s1">)</span>

        <span class="s3"># numeric ops should not succeed</span>
        <span class="s0">for </span><span class="s1">op</span><span class="s0">, </span><span class="s1">str_rep </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;__add__&quot;</span><span class="s0">, </span><span class="s2">r&quot;\+&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;__sub__&quot;</span><span class="s0">, </span><span class="s2">&quot;-&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;__mul__&quot;</span><span class="s0">, </span><span class="s2">r&quot;\*&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;__truediv__&quot;</span><span class="s0">, </span><span class="s2">&quot;/&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]:</span>
            <span class="s1">msg = </span><span class="s2">f&quot;Series cannot perform the operation </span><span class="s0">{</span><span class="s1">str_rep</span><span class="s0">}</span><span class="s2">|unsupported operand&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">getattr(df</span><span class="s0">, </span><span class="s1">op)(df)</span>

        <span class="s3"># reduction ops should not succeed (unless specifically defined, e.g.</span>
        <span class="s3"># min/max)</span>
        <span class="s1">s = df[</span><span class="s2">&quot;value_group&quot;</span><span class="s1">]</span>
        <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;kurt&quot;</span><span class="s0">, </span><span class="s2">&quot;skew&quot;</span><span class="s0">, </span><span class="s2">&quot;var&quot;</span><span class="s0">, </span><span class="s2">&quot;std&quot;</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;median&quot;</span><span class="s1">]:</span>
            <span class="s1">msg = </span><span class="s2">f&quot;does not support reduction '</span><span class="s0">{</span><span class="s1">op</span><span class="s0">}</span><span class="s2">'&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">getattr(s</span><span class="s0">, </span><span class="s1">op)(numeric_only=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s3"># mad technically works because it takes always the numeric data</span>

        <span class="s3"># numpy ops</span>
        <span class="s1">s = Series(Categorical([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]))</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;does not support reduction 'sum'&quot;</span><span class="s1">):</span>
            <span class="s1">np.sum(s)</span>

        <span class="s3"># numeric ops on a Series</span>
        <span class="s0">for </span><span class="s1">op</span><span class="s0">, </span><span class="s1">str_rep </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;__add__&quot;</span><span class="s0">, </span><span class="s2">r&quot;\+&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;__sub__&quot;</span><span class="s0">, </span><span class="s2">&quot;-&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;__mul__&quot;</span><span class="s0">, </span><span class="s2">r&quot;\*&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;__truediv__&quot;</span><span class="s0">, </span><span class="s2">&quot;/&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]:</span>
            <span class="s1">msg = </span><span class="s2">f&quot;Series cannot perform the operation </span><span class="s0">{</span><span class="s1">str_rep</span><span class="s0">}</span><span class="s2">|unsupported operand&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
                <span class="s1">getattr(s</span><span class="s0">, </span><span class="s1">op)(</span><span class="s4">2</span><span class="s1">)</span>

        <span class="s3"># invalid ufunc</span>
        <span class="s1">msg = </span><span class="s2">&quot;Object with dtype category cannot perform the numpy op log&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">np.log(s)</span>
</pre>
</body>
</html>