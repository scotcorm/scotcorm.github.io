<html>
<head>
<title>np_datetime_strings.c</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #4646f1;}
.s6 { color: #0f9795;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
np_datetime_strings.c</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 
Copyright (c) 2016, PyData Development Team 
All rights reserved. 
 
Distributed under the terms of the BSD Simplified License. 
 
The full license is in the LICENSE file, distributed with this software. 
 
Written by Mark Wiebe (mwwiebe@gmail.com) 
Copyright (c) 2011 by Enthought, Inc. 
 
Copyright (c) 2005-2011, NumPy Developers 
All rights reserved. 
 
See NUMPY_LICENSE.txt for the license. 
 
This file implements string parsing and creation for NumPy datetime. 
 
*/</span>

<span class="s2">#define </span><span class="s1">PY_SSIZE_T_CLEAN</span>
<span class="s2">#define </span><span class="s1">NO_IMPORT</span>

<span class="s2">#ifndef </span><span class="s1">NPY_NO_DEPRECATED_API</span>
<span class="s2">#define </span><span class="s1">NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION</span>
<span class="s2">#endif  </span><span class="s0">// NPY_NO_DEPRECATED_API</span>

<span class="s2">#include </span><span class="s1">&lt;Python.h&gt;</span>

<span class="s2">#include </span><span class="s1">&lt;time.h&gt;</span>

<span class="s2">#include </span><span class="s1">&lt;numpy/arrayobject.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;numpy/arrayscalars.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;numpy/ndarraytypes.h&gt;</span>

<span class="s2">#include </span><span class="s3">&quot;np_datetime.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;np_datetime_strings.h&quot;</span>


<span class="s0">/* 
 * Parses (almost) standard ISO 8601 date strings. The differences are: 
 * 
 * + Only seconds may have a decimal point, with up to 18 digits after it 
 *   (maximum attoseconds precision). 
 * + Either a 'T' as in ISO 8601 or a ' ' may be used to separate 
 *   the date and the time. Both are treated equivalently. 
 * + Doesn't (yet) handle the &quot;YYYY-DDD&quot; or &quot;YYYY-Www&quot; formats. 
 * + Doesn't handle leap seconds (seconds value has 60 in these cases). 
 * + Doesn't handle 24:00:00 as synonym for midnight (00:00:00) tomorrow 
 * + Accepts special values &quot;NaT&quot; (not a time), &quot;Today&quot;, (current 
 *   day according to local time) and &quot;Now&quot; (current time in UTC). 
 * + ':' separator between hours, minutes, and seconds is optional. When 
 *   omitted, each component must be 2 digits if it appears. (GH-10041) 
 * 
 * 'str' must be a NULL-terminated string, and 'len' must be its length. 
 * 
 * 'out' gets filled with the parsed date-time. 
 * 'out_local' gets set to 1 if the parsed time contains timezone, 
 *      to 0 otherwise. 
 * 'out_tzoffset' gets set to timezone offset by minutes 
 *      if the parsed time was in local time, 
 *      to 0 otherwise. The values 'now' and 'today' don't get counted 
 *      as local, and neither do UTC +/-#### timezone offsets, because 
 *      they aren't using the computer's local timezone offset. 
 * 
 * Returns 0 on success, -1 on failure. 
 */</span>
<span class="s2">int </span><span class="s1">parse_iso_8601_datetime(</span><span class="s2">const char </span><span class="s1">*str, </span><span class="s2">int </span><span class="s1">len, </span><span class="s2">int </span><span class="s1">want_exc,</span>
                            <span class="s1">npy_datetimestruct *out,</span>
                            <span class="s2">int </span><span class="s1">*out_local, </span><span class="s2">int </span><span class="s1">*out_tzoffset) {</span>
    <span class="s2">int </span><span class="s1">year_leap = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">int </span><span class="s1">i, numdigits;</span>
    <span class="s2">const char </span><span class="s1">*substr;</span>
    <span class="s2">int </span><span class="s1">sublen;</span>

    <span class="s0">/* If year-month-day are separated by a valid separator, 
     * months/days without leading zeroes will be parsed 
     * (though not iso8601). If the components aren't separated, 
     * 4 (YYYY) or 8 (YYYYMMDD) digits are expected. 6 digits are 
     * forbidden here (but parsed as YYMMDD elsewhere). 
    */</span>
    <span class="s2">int </span><span class="s1">has_ymd_sep = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">char </span><span class="s1">ymd_sep = </span><span class="s3">'</span><span class="s5">\0</span><span class="s3">'</span><span class="s1">;</span>
    <span class="s2">char </span><span class="s1">valid_ymd_sep[] = {</span><span class="s3">'-'</span><span class="s1">, </span><span class="s3">'.'</span><span class="s1">, </span><span class="s3">'/'</span><span class="s1">, </span><span class="s3">'</span><span class="s5">\\</span><span class="s3">'</span><span class="s1">, </span><span class="s3">' '</span><span class="s1">};</span>
    <span class="s2">int </span><span class="s1">valid_ymd_sep_len = </span><span class="s2">sizeof</span><span class="s1">(valid_ymd_sep);</span>

    <span class="s0">/* hour-minute-second may or may not separated by ':'. If not, then 
     * each component must be 2 digits. */</span>
    <span class="s2">int </span><span class="s1">has_hms_sep = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">int </span><span class="s1">hour_was_2_digits = </span><span class="s4">0</span><span class="s1">;</span>

    <span class="s0">/* Initialize the output to all zeros */</span>
    <span class="s1">memset(out, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">sizeof</span><span class="s1">(npy_datetimestruct));</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">month = </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">day = </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s1">substr = str;</span>
    <span class="s1">sublen = len;</span>

    <span class="s0">/* Skip leading whitespace */</span>
    <span class="s2">while </span><span class="s1">(sublen &gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; isspace(*substr)) {</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">}</span>

    <span class="s0">/* Leading '-' sign for negative year */</span>
    <span class="s2">if </span><span class="s1">(*substr == </span><span class="s3">'-'</span><span class="s1">) {</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE YEAR (4 digits) */</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">year = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(sublen &gt;= </span><span class="s4">4 </span><span class="s1">&amp;&amp; isdigit(substr[</span><span class="s4">0</span><span class="s1">]) &amp;&amp; isdigit(substr[</span><span class="s4">1</span><span class="s1">]) &amp;&amp;</span>
        <span class="s1">isdigit(substr[</span><span class="s4">2</span><span class="s1">]) &amp;&amp; isdigit(substr[</span><span class="s4">3</span><span class="s1">])) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">year = </span><span class="s4">1000 </span><span class="s1">* (substr[</span><span class="s4">0</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">) + </span><span class="s4">100 </span><span class="s1">* (substr[</span><span class="s4">1</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">) +</span>
                    <span class="s4">10 </span><span class="s1">* (substr[</span><span class="s4">2</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">) + (substr[</span><span class="s4">3</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">);</span>

        <span class="s1">substr += </span><span class="s4">4</span><span class="s1">;</span>
        <span class="s1">sublen -= </span><span class="s4">4</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">/* Negate the year if necessary */</span>
    <span class="s2">if </span><span class="s1">(str[</span><span class="s4">0</span><span class="s1">] == </span><span class="s3">'-'</span><span class="s1">) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">year = -out</span><span class="s6">-&gt;</span><span class="s1">year;</span>
    <span class="s1">}</span>
    <span class="s0">/* Check whether it's a leap-year */</span>
    <span class="s1">year_leap = is_leapyear(out</span><span class="s6">-&gt;</span><span class="s1">year);</span>

    <span class="s0">/* Next character must be a separator, start of month, or end of string */</span>
    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(out_local != NULL) {</span>
            <span class="s1">*out_local = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">goto </span><span class="s1">finish;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(!isdigit(*substr)) {</span>
        <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">; i &lt; valid_ymd_sep_len; ++i) {</span>
            <span class="s2">if </span><span class="s1">(*substr == valid_ymd_sep[i]) {</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(i == valid_ymd_sep_len) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
        <span class="s1">has_ymd_sep = </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">ymd_sep = valid_ymd_sep[i];</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
        <span class="s0">/* Cannot have trailing separator */</span>
        <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0 </span><span class="s1">|| !isdigit(*substr)) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE MONTH */</span>
    <span class="s0">/* First digit required */</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">month = (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">++substr;</span>
    <span class="s1">--sublen;</span>
    <span class="s0">/* Second digit optional if there was a separator */</span>
    <span class="s2">if </span><span class="s1">(isdigit(*substr)) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">month = </span><span class="s4">10 </span><span class="s1">* out</span><span class="s6">-&gt;</span><span class="s1">month + (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!has_ymd_sep) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(out</span><span class="s6">-&gt;</span><span class="s1">month &lt; </span><span class="s4">1 </span><span class="s1">|| out</span><span class="s6">-&gt;</span><span class="s1">month &gt; </span><span class="s4">12</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(want_exc) {</span>
            <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                        <span class="s3">&quot;Month out of range in datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot;</span><span class="s3">&quot;</span><span class="s1">, str);</span>
        <span class="s1">}</span>
        <span class="s2">goto </span><span class="s1">error;</span>
    <span class="s1">}</span>

    <span class="s0">/* Next character must be the separator, start of day, or end of string */</span>
    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s0">/* Forbid YYYYMM. Parsed instead as YYMMDD by someone else. */</span>
        <span class="s2">if </span><span class="s1">(!has_ymd_sep) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(out_local != NULL) {</span>
            <span class="s1">*out_local = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">goto </span><span class="s1">finish;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(has_ymd_sep) {</span>
        <span class="s0">/* Must have separator, but cannot be trailing */</span>
        <span class="s2">if </span><span class="s1">(*substr != ymd_sep || sublen == </span><span class="s4">1</span><span class="s1">) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE DAY */</span>
    <span class="s0">/* First digit required */</span>
    <span class="s2">if </span><span class="s1">(!isdigit(*substr)) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">day = (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">++substr;</span>
    <span class="s1">--sublen;</span>
    <span class="s0">/* Second digit optional if there was a separator */</span>
    <span class="s2">if </span><span class="s1">(isdigit(*substr)) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">day = </span><span class="s4">10 </span><span class="s1">* out</span><span class="s6">-&gt;</span><span class="s1">day + (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!has_ymd_sep) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(out</span><span class="s6">-&gt;</span><span class="s1">day &lt; </span><span class="s4">1 </span><span class="s1">||</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">day &gt; days_per_month_table[year_leap][out</span><span class="s6">-&gt;</span><span class="s1">month - </span><span class="s4">1</span><span class="s1">]) {</span>
        <span class="s2">if </span><span class="s1">(want_exc) {</span>
            <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                        <span class="s3">&quot;Day out of range in datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot;</span><span class="s3">&quot;</span><span class="s1">, str);</span>
        <span class="s1">}</span>
        <span class="s2">goto </span><span class="s1">error;</span>
    <span class="s1">}</span>

    <span class="s0">/* Next character must be a 'T', ' ', or end of string */</span>
    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(out_local != NULL) {</span>
            <span class="s1">*out_local = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">goto </span><span class="s1">finish;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">((*substr != </span><span class="s3">'T' </span><span class="s1">&amp;&amp; *substr != </span><span class="s3">' '</span><span class="s1">) || sublen == </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>
    <span class="s1">++substr;</span>
    <span class="s1">--sublen;</span>

    <span class="s0">/* PARSE THE HOURS */</span>
    <span class="s0">/* First digit required */</span>
    <span class="s2">if </span><span class="s1">(!isdigit(*substr)) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">hour = (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">++substr;</span>
    <span class="s1">--sublen;</span>
    <span class="s0">/* Second digit optional */</span>
    <span class="s2">if </span><span class="s1">(isdigit(*substr)) {</span>
        <span class="s1">hour_was_2_digits = </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">hour = </span><span class="s4">10 </span><span class="s1">* out</span><span class="s6">-&gt;</span><span class="s1">hour + (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
        <span class="s2">if </span><span class="s1">(out</span><span class="s6">-&gt;</span><span class="s1">hour &gt;= </span><span class="s4">24</span><span class="s1">) {</span>
            <span class="s2">if </span><span class="s1">(want_exc) {</span>
                <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                             <span class="s3">&quot;Hours out of range in datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
                             <span class="s1">str);</span>
            <span class="s1">}</span>
            <span class="s2">goto </span><span class="s1">error;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">/* Next character must be a ':' or the end of the string */</span>
    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(!hour_was_2_digits) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
        <span class="s2">goto </span><span class="s1">finish;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(*substr == </span><span class="s3">':'</span><span class="s1">) {</span>
        <span class="s1">has_hms_sep = </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
        <span class="s0">/* Cannot have a trailing separator */</span>
        <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0 </span><span class="s1">|| !isdigit(*substr)) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!isdigit(*substr)) {</span>
        <span class="s2">if </span><span class="s1">(!hour_was_2_digits) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
        <span class="s2">goto </span><span class="s1">parse_timezone;</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE MINUTES */</span>
    <span class="s0">/* First digit required */</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">min = (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">++substr;</span>
    <span class="s1">--sublen;</span>
    <span class="s0">/* Second digit optional if there was a separator */</span>
    <span class="s2">if </span><span class="s1">(isdigit(*substr)) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">min = </span><span class="s4">10 </span><span class="s1">* out</span><span class="s6">-&gt;</span><span class="s1">min + (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
        <span class="s2">if </span><span class="s1">(out</span><span class="s6">-&gt;</span><span class="s1">min &gt;= </span><span class="s4">60</span><span class="s1">) {</span>
            <span class="s2">if </span><span class="s1">(want_exc) {</span>
                <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                             <span class="s3">&quot;Minutes out of range in datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
                             <span class="s1">str);</span>
            <span class="s1">}</span>
            <span class="s2">goto </span><span class="s1">error;</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!has_hms_sep) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">finish;</span>
    <span class="s1">}</span>

    <span class="s0">/* If we make it through this condition block, then the next 
     * character is a digit. */</span>
    <span class="s2">if </span><span class="s1">(has_hms_sep &amp;&amp; *substr == </span><span class="s3">':'</span><span class="s1">) {</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
        <span class="s0">/* Cannot have a trailing ':' */</span>
        <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0 </span><span class="s1">|| !isdigit(*substr)) {</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!has_hms_sep &amp;&amp; isdigit(*substr)) {</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s2">goto </span><span class="s1">parse_timezone;</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE SECONDS */</span>
    <span class="s0">/* First digit required */</span>
    <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">sec = (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">++substr;</span>
    <span class="s1">--sublen;</span>
    <span class="s0">/* Second digit optional if there was a separator */</span>
    <span class="s2">if </span><span class="s1">(isdigit(*substr)) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">sec = </span><span class="s4">10 </span><span class="s1">* out</span><span class="s6">-&gt;</span><span class="s1">sec + (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
        <span class="s2">if </span><span class="s1">(out</span><span class="s6">-&gt;</span><span class="s1">sec &gt;= </span><span class="s4">60</span><span class="s1">) {</span>
            <span class="s2">if </span><span class="s1">(want_exc) {</span>
                <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                             <span class="s3">&quot;Seconds out of range in datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
                             <span class="s1">str);</span>
            <span class="s1">}</span>
            <span class="s2">goto </span><span class="s1">error;</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!has_hms_sep) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>

    <span class="s0">/* Next character may be a '.' indicating fractional seconds */</span>
    <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; *substr == </span><span class="s3">'.'</span><span class="s1">) {</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s2">goto </span><span class="s1">parse_timezone;</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE MICROSECONDS (0 to 6 digits) */</span>
    <span class="s1">numdigits = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">; i &lt; </span><span class="s4">6</span><span class="s1">; ++i) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">us *= </span><span class="s4">10</span><span class="s1">;</span>
        <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; isdigit(*substr)) {</span>
            <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">us += (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
            <span class="s1">++substr;</span>
            <span class="s1">--sublen;</span>
            <span class="s1">++numdigits;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0 </span><span class="s1">|| !isdigit(*substr)) {</span>
        <span class="s2">goto </span><span class="s1">parse_timezone;</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE PICOSECONDS (0 to 6 digits) */</span>
    <span class="s1">numdigits = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">; i &lt; </span><span class="s4">6</span><span class="s1">; ++i) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">ps *= </span><span class="s4">10</span><span class="s1">;</span>
        <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; isdigit(*substr)) {</span>
            <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">ps += (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
            <span class="s1">++substr;</span>
            <span class="s1">--sublen;</span>
            <span class="s1">++numdigits;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0 </span><span class="s1">|| !isdigit(*substr)) {</span>
        <span class="s2">goto </span><span class="s1">parse_timezone;</span>
    <span class="s1">}</span>

    <span class="s0">/* PARSE THE ATTOSECONDS (0 to 6 digits) */</span>
    <span class="s1">numdigits = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">; i &lt; </span><span class="s4">6</span><span class="s1">; ++i) {</span>
        <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">as *= </span><span class="s4">10</span><span class="s1">;</span>
        <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; isdigit(*substr)) {</span>
            <span class="s1">out</span><span class="s6">-&gt;</span><span class="s1">as += (*substr - </span><span class="s3">'0'</span><span class="s1">);</span>
            <span class="s1">++substr;</span>
            <span class="s1">--sublen;</span>
            <span class="s1">++numdigits;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

<span class="s1">parse_timezone:</span>
    <span class="s0">/* trim any whitespace between time/timeezone */</span>
    <span class="s2">while </span><span class="s1">(sublen &gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; isspace(*substr)) {</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s0">// Unlike NumPy, treating no time zone as naive</span>
        <span class="s2">goto </span><span class="s1">finish;</span>
    <span class="s1">}</span>

    <span class="s0">/* UTC specifier */</span>
    <span class="s2">if </span><span class="s1">(*substr == </span><span class="s3">'Z'</span><span class="s1">) {</span>
        <span class="s0">/* &quot;Z&quot; should be equivalent to tz offset &quot;+00:00&quot; */</span>
        <span class="s2">if </span><span class="s1">(out_local != NULL) {</span>
            <span class="s1">*out_local = </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(out_tzoffset != NULL) {</span>
            <span class="s1">*out_tzoffset = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(sublen == </span><span class="s4">1</span><span class="s1">) {</span>
            <span class="s2">goto </span><span class="s1">finish;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">++substr;</span>
            <span class="s1">--sublen;</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(*substr == </span><span class="s3">'-' </span><span class="s1">|| *substr == </span><span class="s3">'+'</span><span class="s1">) {</span>
        <span class="s0">/* Time zone offset */</span>
        <span class="s2">int </span><span class="s1">offset_neg = </span><span class="s4">0</span><span class="s1">, offset_hour = </span><span class="s4">0</span><span class="s1">, offset_minute = </span><span class="s4">0</span><span class="s1">;</span>

        <span class="s0">/* 
         * Since &quot;local&quot; means local with respect to the current 
         * machine, we say this is non-local. 
         */</span>

        <span class="s2">if </span><span class="s1">(*substr == </span><span class="s3">'-'</span><span class="s1">) {</span>
            <span class="s1">offset_neg = </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>

        <span class="s0">/* The hours offset */</span>
        <span class="s2">if </span><span class="s1">(sublen &gt;= </span><span class="s4">2 </span><span class="s1">&amp;&amp; isdigit(substr[</span><span class="s4">0</span><span class="s1">]) &amp;&amp; isdigit(substr[</span><span class="s4">1</span><span class="s1">])) {</span>
            <span class="s1">offset_hour = </span><span class="s4">10 </span><span class="s1">* (substr[</span><span class="s4">0</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">) + (substr[</span><span class="s4">1</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">);</span>
            <span class="s1">substr += </span><span class="s4">2</span><span class="s1">;</span>
            <span class="s1">sublen -= </span><span class="s4">2</span><span class="s1">;</span>
            <span class="s2">if </span><span class="s1">(offset_hour &gt;= </span><span class="s4">24</span><span class="s1">) {</span>
                <span class="s2">if </span><span class="s1">(want_exc) {</span>
                    <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                                <span class="s3">&quot;Timezone hours offset out of range &quot;</span>
                                <span class="s3">&quot;in datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
                                <span class="s1">str);</span>
                <span class="s1">}</span>
                <span class="s2">goto </span><span class="s1">error;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(sublen &gt;= </span><span class="s4">1 </span><span class="s1">&amp;&amp; isdigit(substr[</span><span class="s4">0</span><span class="s1">])) {</span>
            <span class="s1">offset_hour = substr[</span><span class="s4">0</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">;</span>
            <span class="s1">++substr;</span>
            <span class="s1">--sublen;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s2">goto </span><span class="s1">parse_error;</span>
        <span class="s1">}</span>

        <span class="s0">/* The minutes offset is optional */</span>
        <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s0">/* Optional ':' */</span>
            <span class="s2">if </span><span class="s1">(*substr == </span><span class="s3">':'</span><span class="s1">) {</span>
                <span class="s1">++substr;</span>
                <span class="s1">--sublen;</span>
            <span class="s1">}</span>

            <span class="s0">/* The minutes offset (at the end of the string) */</span>
            <span class="s2">if </span><span class="s1">(sublen &gt;= </span><span class="s4">2 </span><span class="s1">&amp;&amp; isdigit(substr[</span><span class="s4">0</span><span class="s1">]) &amp;&amp; isdigit(substr[</span><span class="s4">1</span><span class="s1">])) {</span>
                <span class="s1">offset_minute = </span><span class="s4">10 </span><span class="s1">* (substr[</span><span class="s4">0</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">) + (substr[</span><span class="s4">1</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">);</span>
                <span class="s1">substr += </span><span class="s4">2</span><span class="s1">;</span>
                <span class="s1">sublen -= </span><span class="s4">2</span><span class="s1">;</span>
                <span class="s2">if </span><span class="s1">(offset_minute &gt;= </span><span class="s4">60</span><span class="s1">) {</span>
                    <span class="s2">if </span><span class="s1">(want_exc) {</span>
                        <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                                    <span class="s3">&quot;Timezone minutes offset out of range &quot;</span>
                                    <span class="s3">&quot;in datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
                                    <span class="s1">str);</span>
                    <span class="s1">}</span>
                    <span class="s2">goto </span><span class="s1">error;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s2">else if </span><span class="s1">(sublen &gt;= </span><span class="s4">1 </span><span class="s1">&amp;&amp; isdigit(substr[</span><span class="s4">0</span><span class="s1">])) {</span>
                <span class="s1">offset_minute = substr[</span><span class="s4">0</span><span class="s1">] - </span><span class="s3">'0'</span><span class="s1">;</span>
                <span class="s1">++substr;</span>
                <span class="s1">--sublen;</span>
            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s2">goto </span><span class="s1">parse_error;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">/* Apply the time zone offset */</span>
        <span class="s2">if </span><span class="s1">(offset_neg) {</span>
            <span class="s1">offset_hour = -offset_hour;</span>
            <span class="s1">offset_minute = -offset_minute;</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(out_local != NULL) {</span>
            <span class="s1">*out_local = </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s0">// Unlike NumPy, do not change internal value to local time</span>
            <span class="s1">*out_tzoffset = </span><span class="s4">60 </span><span class="s1">* offset_hour + offset_minute;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">/* Skip trailing whitespace */</span>
    <span class="s2">while </span><span class="s1">(sublen &gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; isspace(*substr)) {</span>
        <span class="s1">++substr;</span>
        <span class="s1">--sublen;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(sublen != </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">parse_error;</span>
    <span class="s1">}</span>

<span class="s1">finish:</span>
    <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>

<span class="s1">parse_error:</span>
    <span class="s2">if </span><span class="s1">(want_exc) {</span>
        <span class="s1">PyErr_Format(PyExc_ValueError,</span>
                    <span class="s3">&quot;Error parsing datetime string </span><span class="s5">\&quot;</span><span class="s3">%s</span><span class="s5">\&quot; </span><span class="s3">at position %d&quot;</span><span class="s1">, str,</span>
                    <span class="s1">(</span><span class="s2">int</span><span class="s1">)(substr - str));</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>

<span class="s1">error:</span>
    <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Provides a string length to use for converting datetime 
 * objects with the given local and unit settings. 
 */</span>
<span class="s2">int </span><span class="s1">get_datetime_iso_8601_strlen(</span><span class="s2">int </span><span class="s1">local, NPY_DATETIMEUNIT base) {</span>
    <span class="s2">int </span><span class="s1">len = </span><span class="s4">0</span><span class="s1">;</span>

    <span class="s2">switch </span><span class="s1">(base) {</span>
        <span class="s0">/* Generic units can only be used to represent NaT */</span>
        <span class="s0">/*    return 4;*/</span>
        <span class="s2">case </span><span class="s1">NPY_FR_as:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;###&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_fs:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;###&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_ps:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;###&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_ns:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;###&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_us:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;###&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_ms:</span>
            <span class="s1">len += </span><span class="s4">4</span><span class="s1">; </span><span class="s0">/* &quot;.###&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_s:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;:##&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_m:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;:##&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_h:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;T##&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_D:</span>
        <span class="s2">case </span><span class="s1">NPY_FR_W:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;-##&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_M:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* &quot;-##&quot; */</span>
        <span class="s2">case </span><span class="s1">NPY_FR_Y:</span>
            <span class="s1">len += </span><span class="s4">21</span><span class="s1">; </span><span class="s0">/* 64-bit year */</span>
            <span class="s2">break</span><span class="s1">;</span>
        <span class="s2">default</span><span class="s1">:</span>
            <span class="s1">len += </span><span class="s4">3</span><span class="s1">; </span><span class="s0">/* handle the now defunct NPY_FR_B */</span>
            <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(base &gt;= NPY_FR_h) {</span>
        <span class="s2">if </span><span class="s1">(local) {</span>
            <span class="s1">len += </span><span class="s4">5</span><span class="s1">; </span><span class="s0">/* &quot;+####&quot; or &quot;-####&quot; */</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">len += </span><span class="s4">1</span><span class="s1">; </span><span class="s0">/* &quot;Z&quot; */</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">len += </span><span class="s4">1</span><span class="s1">; </span><span class="s0">/* NULL terminator */</span>

    <span class="s2">return </span><span class="s1">len;</span>
<span class="s1">}</span>


<span class="s0">/* 
 * Converts an npy_datetimestruct to an (almost) ISO 8601 
 * NULL-terminated string using timezone Z (UTC). If the string fits in 
 * the space exactly, it leaves out the NULL terminator and returns success. 
 * 
 * The differences from ISO 8601 are the 'NaT' string, and 
 * the number of year digits is &gt;= 4 instead of strictly 4. 
 * 
 * 'base' restricts the output to that unit. Set 'base' to 
 * -1 to auto-detect a base after which all the values are zero. 
 * 
 *  Returns 0 on success, -1 on failure (for example if the output 
 *  string was too short). 
 */</span>
<span class="s2">int </span><span class="s1">make_iso_8601_datetime(npy_datetimestruct *dts, </span><span class="s2">char </span><span class="s1">*outstr, </span><span class="s2">int </span><span class="s1">outlen,</span>
                           <span class="s1">NPY_DATETIMEUNIT base) {</span>
    <span class="s2">char </span><span class="s1">*substr = outstr;</span>
    <span class="s2">int </span><span class="s1">sublen = outlen;</span>
    <span class="s2">int </span><span class="s1">tmplen;</span>

    <span class="s0">/* 
     * Print weeks with the same precision as days. 
     * 
     * TODO: Could print weeks with YYYY-Www format if the week 
     *       epoch is a Monday. 
     */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_W) {</span>
        <span class="s1">base = NPY_FR_D;</span>
    <span class="s1">}</span>

<span class="s0">/* YEAR */</span>
<span class="s0">/* 
 * Can't use PyOS_snprintf, because it always produces a '\0' 
 * character at the end, and NumPy string types are permitted 
 * to have data all the way to the end of the buffer. 
 */</span>
<span class="s2">#ifdef </span><span class="s1">_WIN32</span>
    <span class="s1">tmplen = _snprintf(substr, sublen, </span><span class="s3">&quot;%04&quot; </span><span class="s1">NPY_INT64_FMT, dts</span><span class="s6">-&gt;</span><span class="s1">year);</span>
<span class="s2">#else</span>
    <span class="s1">tmplen = snprintf(substr, sublen, </span><span class="s3">&quot;%04&quot; </span><span class="s1">NPY_INT64_FMT, dts</span><span class="s6">-&gt;</span><span class="s1">year);</span>
<span class="s2">#endif  </span><span class="s0">// _WIN32</span>
    <span class="s0">/* If it ran out of space or there isn't space for the NULL terminator */</span>
    <span class="s2">if </span><span class="s1">(tmplen &lt; </span><span class="s4">0 </span><span class="s1">|| tmplen &gt; sublen) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr += tmplen;</span>
    <span class="s1">sublen -= tmplen;</span>

    <span class="s0">/* Stop if the unit is years */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_Y) {</span>
        <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">*substr = </span><span class="s3">'</span><span class="s5">\0</span><span class="s3">'</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">/* MONTH */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">'-'</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">month / </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">month % </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is months */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_M) {</span>
        <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">*substr = </span><span class="s3">'</span><span class="s5">\0</span><span class="s3">'</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">/* DAY */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">'-'</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">day / </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">day % </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is days */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_D) {</span>
        <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">*substr = </span><span class="s3">'</span><span class="s5">\0</span><span class="s3">'</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">/* HOUR */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">'T'</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">hour / </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">hour % </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is hours */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_h) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* MINUTE */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">':'</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">min / </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">min % </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is minutes */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_m) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* SECOND */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">':'</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">sec / </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">sec % </span><span class="s4">10</span><span class="s1">) + </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is seconds */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_s) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* MILLISECOND */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">'.'</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">us / </span><span class="s4">100000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">us / </span><span class="s4">10000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">4</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">3</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">us / </span><span class="s4">1000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">4</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">4</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is milliseconds */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_ms) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* MICROSECOND */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">us / </span><span class="s4">100</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">us / </span><span class="s4">10</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)(dts</span><span class="s6">-&gt;</span><span class="s1">us % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is microseconds */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_us) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* NANOSECOND */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">ps / </span><span class="s4">100000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">ps / </span><span class="s4">10000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">ps / </span><span class="s4">1000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is nanoseconds */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_ns) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* PICOSECOND */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">ps / </span><span class="s4">100</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">ps / </span><span class="s4">10</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)(dts</span><span class="s6">-&gt;</span><span class="s1">ps % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is picoseconds */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_ps) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* FEMTOSECOND */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">as / </span><span class="s4">100000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">as / </span><span class="s4">10000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">as / </span><span class="s4">1000</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

    <span class="s0">/* Stop if the unit is femtoseconds */</span>
    <span class="s2">if </span><span class="s1">(base == NPY_FR_fs) {</span>
        <span class="s2">goto </span><span class="s1">add_time_zone;</span>
    <span class="s1">}</span>

    <span class="s0">/* ATTOSECOND */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">as / </span><span class="s4">100</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">2</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">1</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)((dts</span><span class="s6">-&gt;</span><span class="s1">as / </span><span class="s4">10</span><span class="s1">) % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">3</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">2</span><span class="s1">] = (</span><span class="s2">char</span><span class="s1">)(dts</span><span class="s6">-&gt;</span><span class="s1">as % </span><span class="s4">10 </span><span class="s1">+ </span><span class="s3">'0'</span><span class="s1">);</span>
    <span class="s1">substr += </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">3</span><span class="s1">;</span>

<span class="s1">add_time_zone:</span>
    <span class="s0">/* UTC &quot;Zulu&quot; time */</span>
    <span class="s2">if </span><span class="s1">(sublen &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s2">goto </span><span class="s1">string_too_short;</span>
    <span class="s1">}</span>
    <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">'Z'</span><span class="s1">;</span>
    <span class="s1">substr += </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">sublen -= </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s0">/* Add a NULL terminator, and return */</span>
    <span class="s2">if </span><span class="s1">(sublen &gt; </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s1">substr[</span><span class="s4">0</span><span class="s1">] = </span><span class="s3">'</span><span class="s5">\0</span><span class="s3">'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>

<span class="s1">string_too_short:</span>
    <span class="s1">PyErr_Format(PyExc_RuntimeError,</span>
                 <span class="s3">&quot;The string provided for NumPy ISO datetime formatting &quot;</span>
                 <span class="s3">&quot;was too short, with length %d&quot;</span><span class="s1">,</span>
                 <span class="s1">outlen);</span>
    <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s2">int </span><span class="s1">make_iso_8601_timedelta(pandas_timedeltastruct *tds,</span>
                            <span class="s2">char </span><span class="s1">*outstr, size_t *outlen) {</span>
  <span class="s1">*outlen = </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s1">*outlen += snprintf(outstr, </span><span class="s4">60</span><span class="s1">,  </span><span class="s0">// NOLINT</span>
                     <span class="s3">&quot;P%&quot; </span><span class="s1">NPY_INT64_FMT</span>
                     <span class="s3">&quot;DT%&quot; </span><span class="s1">NPY_INT32_FMT</span>
                     <span class="s3">&quot;H%&quot; </span><span class="s1">NPY_INT32_FMT</span>
                     <span class="s3">&quot;M%&quot; </span><span class="s1">NPY_INT32_FMT,</span>
                     <span class="s1">tds</span><span class="s6">-&gt;</span><span class="s1">days, tds</span><span class="s6">-&gt;</span><span class="s1">hrs, tds</span><span class="s6">-&gt;</span><span class="s1">min, tds</span><span class="s6">-&gt;</span><span class="s1">sec);</span>
  <span class="s1">outstr += *outlen;</span>

  <span class="s2">if </span><span class="s1">(tds</span><span class="s6">-&gt;</span><span class="s1">ns != </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s1">*outlen += snprintf(outstr, </span><span class="s4">12</span><span class="s1">,  </span><span class="s0">// NOLINT</span>
                       <span class="s3">&quot;.%03&quot; </span><span class="s1">NPY_INT32_FMT</span>
                       <span class="s3">&quot;%03&quot; </span><span class="s1">NPY_INT32_FMT</span>
                       <span class="s3">&quot;%03&quot; </span><span class="s1">NPY_INT32_FMT</span>
                       <span class="s3">&quot;S&quot;</span><span class="s1">, tds</span><span class="s6">-&gt;</span><span class="s1">ms, tds</span><span class="s6">-&gt;</span><span class="s1">us, tds</span><span class="s6">-&gt;</span><span class="s1">ns);</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(tds</span><span class="s6">-&gt;</span><span class="s1">us != </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s1">*outlen += snprintf(outstr, </span><span class="s4">9</span><span class="s1">,  </span><span class="s0">// NOLINT</span>
                       <span class="s3">&quot;.%03&quot; </span><span class="s1">NPY_INT32_FMT</span>
                       <span class="s3">&quot;%03&quot; </span><span class="s1">NPY_INT32_FMT</span>
                       <span class="s3">&quot;S&quot;</span><span class="s1">, tds</span><span class="s6">-&gt;</span><span class="s1">ms, tds</span><span class="s6">-&gt;</span><span class="s1">us);</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(tds</span><span class="s6">-&gt;</span><span class="s1">ms != </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s1">*outlen += snprintf(outstr, </span><span class="s4">6</span><span class="s1">,  </span><span class="s0">// NOLINT</span>
                        <span class="s3">&quot;.%03&quot; </span><span class="s1">NPY_INT32_FMT </span><span class="s3">&quot;S&quot;</span><span class="s1">, tds</span><span class="s6">-&gt;</span><span class="s1">ms);</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s1">*outlen += snprintf(outstr, </span><span class="s4">2</span><span class="s1">,  </span><span class="s0">// NOLINT</span>
                        <span class="s3">&quot;%s&quot;</span><span class="s1">, </span><span class="s3">&quot;S&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>
<span class="s1">}</span>
</pre>
</body>
</html>