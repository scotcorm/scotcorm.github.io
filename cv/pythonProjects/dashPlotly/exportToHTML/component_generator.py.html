<html>
<head>
<title>component_generator.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
component_generator.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">OrderedDict</span>

<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">shlex</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">argparse</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">pkg_resources</span>
<span class="s0">import </span><span class="s1">yaml</span>

<span class="s0">from </span><span class="s1">._r_components_generation </span><span class="s0">import </span><span class="s1">write_class_file</span>
<span class="s0">from </span><span class="s1">._r_components_generation </span><span class="s0">import </span><span class="s1">generate_exports</span>
<span class="s0">from </span><span class="s1">._py_components_generation </span><span class="s0">import </span><span class="s1">generate_class_file</span>
<span class="s0">from </span><span class="s1">._py_components_generation </span><span class="s0">import </span><span class="s1">generate_imports</span>
<span class="s0">from </span><span class="s1">._py_components_generation </span><span class="s0">import </span><span class="s1">generate_classes_files</span>
<span class="s0">from </span><span class="s1">._jl_components_generation </span><span class="s0">import </span><span class="s1">generate_struct_file</span>
<span class="s0">from </span><span class="s1">._jl_components_generation </span><span class="s0">import </span><span class="s1">generate_module</span>

<span class="s1">reserved_words = [</span>
    <span class="s2">&quot;UNDEFINED&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;REQUIRED&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;to_plotly_json&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;available_properties&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;available_wildcard_properties&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;_.*&quot;</span><span class="s0">,</span>
<span class="s1">]</span>


<span class="s0">class </span><span class="s1">_CombinedFormatter(</span>
    <span class="s1">argparse.ArgumentDefaultsHelpFormatter</span><span class="s0">, </span><span class="s1">argparse.RawDescriptionHelpFormatter</span>
<span class="s1">):</span>
    <span class="s0">pass</span>


<span class="s3"># pylint: disable=too-many-locals, too-many-arguments, too-many-branches</span>
<span class="s0">def </span><span class="s1">generate_components(</span>
    <span class="s1">components_source</span><span class="s0">,</span>
    <span class="s1">project_shortname</span><span class="s0">,</span>
    <span class="s1">package_info_filename=</span><span class="s2">&quot;package.json&quot;</span><span class="s0">,</span>
    <span class="s1">ignore=</span><span class="s2">&quot;^_&quot;</span><span class="s0">,</span>
    <span class="s1">rprefix=</span><span class="s0">None,</span>
    <span class="s1">rdepends=</span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
    <span class="s1">rimports=</span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
    <span class="s1">rsuggests=</span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
    <span class="s1">jlprefix=</span><span class="s0">None,</span>
    <span class="s1">metadata=</span><span class="s0">None,</span>
    <span class="s1">keep_prop_order=</span><span class="s0">None,</span>
<span class="s1">):</span>

    <span class="s1">project_shortname = project_shortname.replace(</span><span class="s2">&quot;-&quot;</span><span class="s0">, </span><span class="s2">&quot;_&quot;</span><span class="s1">).rstrip(</span><span class="s2">&quot;/</span><span class="s0">\\</span><span class="s2">&quot;</span><span class="s1">)</span>

    <span class="s1">is_windows = sys.platform == </span><span class="s2">&quot;win32&quot;</span>

    <span class="s1">extract_path = pkg_resources.resource_filename(</span><span class="s2">&quot;dash&quot;</span><span class="s0">, </span><span class="s2">&quot;extract-meta.js&quot;</span><span class="s1">)</span>

    <span class="s1">reserved_patterns = </span><span class="s2">&quot;|&quot;</span><span class="s1">.join(</span><span class="s2">&quot;^{}$&quot;</span><span class="s1">.format(p) </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">reserved_words)</span>

    <span class="s1">os.environ[</span><span class="s2">&quot;NODE_PATH&quot;</span><span class="s1">] = </span><span class="s2">&quot;node_modules&quot;</span>

    <span class="s1">shutil.copyfile(</span>
        <span class="s2">&quot;package.json&quot;</span><span class="s0">, </span><span class="s1">os.path.join(project_shortname</span><span class="s0">, </span><span class="s1">package_info_filename)</span>
    <span class="s1">)</span>

    <span class="s0">if not </span><span class="s1">metadata:</span>
        <span class="s1">cmd = shlex.split(</span>
            <span class="s2">'node {} &quot;{}&quot; &quot;{}&quot; {}'</span><span class="s1">.format(</span>
                <span class="s1">extract_path</span><span class="s0">, </span><span class="s1">ignore</span><span class="s0">, </span><span class="s1">reserved_patterns</span><span class="s0">, </span><span class="s1">components_source</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">posix=</span><span class="s0">not </span><span class="s1">is_windows</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">proc = subprocess.Popen(  </span><span class="s3"># pylint: disable=consider-using-with</span>
            <span class="s1">cmd</span><span class="s0">, </span><span class="s1">stdout=subprocess.PIPE</span><span class="s0">, </span><span class="s1">stderr=subprocess.PIPE</span><span class="s0">, </span><span class="s1">shell=is_windows</span>
        <span class="s1">)</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">err = proc.communicate()</span>
        <span class="s1">status = proc.poll()</span>

        <span class="s0">if </span><span class="s1">err:</span>
            <span class="s1">print(err.decode()</span><span class="s0">, </span><span class="s1">file=sys.stderr)</span>

        <span class="s0">if not </span><span class="s1">out:</span>
            <span class="s1">print(</span>
                <span class="s2">&quot;Error generating metadata in {} (status={})&quot;</span><span class="s1">.format(</span>
                    <span class="s1">project_shortname</span><span class="s0">, </span><span class="s1">status</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">file=sys.stderr</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">sys.exit(</span><span class="s4">1</span><span class="s1">)</span>

        <span class="s1">metadata = safe_json_loads(out.decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">))</span>

    <span class="s1">generator_methods = [generate_class_file]</span>

    <span class="s0">if </span><span class="s1">rprefix </span><span class="s0">is not None or </span><span class="s1">jlprefix </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">open(</span><span class="s2">&quot;package.json&quot;</span><span class="s0">, </span><span class="s2">&quot;r&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">pkg_data = safe_json_loads(f.read())</span>

    <span class="s0">if </span><span class="s1">rprefix </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s0">if not </span><span class="s1">os.path.exists(</span><span class="s2">&quot;man&quot;</span><span class="s1">):</span>
            <span class="s1">os.makedirs(</span><span class="s2">&quot;man&quot;</span><span class="s1">)</span>
        <span class="s0">if not </span><span class="s1">os.path.exists(</span><span class="s2">&quot;R&quot;</span><span class="s1">):</span>
            <span class="s1">os.makedirs(</span><span class="s2">&quot;R&quot;</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">os.path.isfile(</span><span class="s2">&quot;dash-info.yaml&quot;</span><span class="s1">):</span>
            <span class="s0">with </span><span class="s1">open(</span><span class="s2">&quot;dash-info.yaml&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">yamldata:</span>
                <span class="s1">rpkg_data = yaml.safe_load(yamldata)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">rpkg_data = </span><span class="s0">None</span>
        <span class="s1">generator_methods.append(</span>
            <span class="s1">functools.partial(write_class_file</span><span class="s0">, </span><span class="s1">prefix=rprefix</span><span class="s0">, </span><span class="s1">rpkg_data=rpkg_data)</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">jlprefix </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">generator_methods.append(</span>
            <span class="s1">functools.partial(generate_struct_file</span><span class="s0">, </span><span class="s1">prefix=jlprefix)</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">keep_prop_order </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">keep_prop_order = [</span>
            <span class="s1">component.strip(</span><span class="s2">&quot; &quot;</span><span class="s1">) </span><span class="s0">for </span><span class="s1">component </span><span class="s0">in </span><span class="s1">keep_prop_order.split(</span><span class="s2">&quot;,&quot;</span><span class="s1">)</span>
        <span class="s1">]</span>
        <span class="s1">generator_methods[</span><span class="s4">0</span><span class="s1">] = functools.partial(</span>
            <span class="s1">generate_class_file</span><span class="s0">, </span><span class="s1">prop_reorder_exceptions=keep_prop_order</span>
        <span class="s1">)</span>

    <span class="s1">components = generate_classes_files(project_shortname</span><span class="s0">, </span><span class="s1">metadata</span><span class="s0">, </span><span class="s1">*generator_methods)</span>

    <span class="s0">with </span><span class="s1">open(os.path.join(project_shortname</span><span class="s0">, </span><span class="s2">&quot;metadata.json&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">json.dump(metadata</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">indent=</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s1">generate_imports(project_shortname</span><span class="s0">, </span><span class="s1">components)</span>

    <span class="s0">if </span><span class="s1">rprefix </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">generate_exports(</span>
            <span class="s1">project_shortname</span><span class="s0">,</span>
            <span class="s1">components</span><span class="s0">,</span>
            <span class="s1">metadata</span><span class="s0">,</span>
            <span class="s1">pkg_data</span><span class="s0">,</span>
            <span class="s1">rpkg_data</span><span class="s0">,</span>
            <span class="s1">rprefix</span><span class="s0">,</span>
            <span class="s1">rdepends</span><span class="s0">,</span>
            <span class="s1">rimports</span><span class="s0">,</span>
            <span class="s1">rsuggests</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">jlprefix </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">generate_module(project_shortname</span><span class="s0">, </span><span class="s1">components</span><span class="s0">, </span><span class="s1">metadata</span><span class="s0">, </span><span class="s1">pkg_data</span><span class="s0">, </span><span class="s1">jlprefix)</span>


<span class="s0">def </span><span class="s1">safe_json_loads(s):</span>
    <span class="s1">jsondata_unicode = json.loads(s</span><span class="s0">, </span><span class="s1">object_pairs_hook=OrderedDict)</span>
    <span class="s0">if </span><span class="s1">sys.version_info[</span><span class="s4">0</span><span class="s1">] &gt;= </span><span class="s4">3</span><span class="s1">:</span>
        <span class="s0">return </span><span class="s1">jsondata_unicode</span>
    <span class="s0">return </span><span class="s1">byteify(jsondata_unicode)</span>


<span class="s0">def </span><span class="s1">component_build_arg_parser():</span>
    <span class="s1">parser = argparse.ArgumentParser(</span>
        <span class="s1">prog=</span><span class="s2">&quot;dash-generate-components&quot;</span><span class="s0">,</span>
        <span class="s1">formatter_class=_CombinedFormatter</span><span class="s0">,</span>
        <span class="s1">description=</span><span class="s2">&quot;Generate dash components by extracting the metadata &quot;</span>
        <span class="s2">&quot;using react-docgen. Then map the metadata to Python classes.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span><span class="s2">&quot;components_source&quot;</span><span class="s0">, </span><span class="s1">help=</span><span class="s2">&quot;React components source directory.&quot;</span><span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;project_shortname&quot;</span><span class="s0">, </span><span class="s1">help=</span><span class="s2">&quot;Name of the project to export the classes files.&quot;</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;-p&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;--package-info-filename&quot;</span><span class="s0">,</span>
        <span class="s1">default=</span><span class="s2">&quot;package.json&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;The filename of the copied `package.json` to `project_shortname`&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;-i&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;--ignore&quot;</span><span class="s0">,</span>
        <span class="s1">default=</span><span class="s2">&quot;^_&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;Files/directories matching the pattern will be ignored&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;--r-prefix&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;Specify a prefix for Dash for R component names, write &quot;</span>
        <span class="s2">&quot;components to R dir, create R package.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;--r-depends&quot;</span><span class="s0">,</span>
        <span class="s1">default=</span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;Specify a comma-separated list of R packages to be &quot;</span>
        <span class="s2">&quot;inserted into the Depends field of the DESCRIPTION file.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;--r-imports&quot;</span><span class="s0">,</span>
        <span class="s1">default=</span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;Specify a comma-separated list of R packages to be &quot;</span>
        <span class="s2">&quot;inserted into the Imports field of the DESCRIPTION file.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;--r-suggests&quot;</span><span class="s0">,</span>
        <span class="s1">default=</span><span class="s2">&quot;&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;Specify a comma-separated list of R packages to be &quot;</span>
        <span class="s2">&quot;inserted into the Suggests field of the DESCRIPTION file.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;--jl-prefix&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;Specify a prefix for Dash for R component names, write &quot;</span>
        <span class="s2">&quot;components to R dir, create R package.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;-k&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;--keep-prop-order&quot;</span><span class="s0">,</span>
        <span class="s1">default=</span><span class="s0">None,</span>
        <span class="s1">help=</span><span class="s2">&quot;Specify a comma-separated list of components which will use the prop &quot;</span>
        <span class="s2">&quot;order described in the component proptypes instead of alphabetically reordered &quot;</span>
        <span class="s2">&quot;props. Pass the 'ALL' keyword to have every component retain &quot;</span>
        <span class="s2">&quot;its original prop order.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">return </span><span class="s1">parser</span>


<span class="s0">def </span><span class="s1">cli():</span>
    <span class="s1">args = component_build_arg_parser().parse_args()</span>
    <span class="s1">generate_components(</span>
        <span class="s1">args.components_source</span><span class="s0">,</span>
        <span class="s1">args.project_shortname</span><span class="s0">,</span>
        <span class="s1">package_info_filename=args.package_info_filename</span><span class="s0">,</span>
        <span class="s1">ignore=args.ignore</span><span class="s0">,</span>
        <span class="s1">rprefix=args.r_prefix</span><span class="s0">,</span>
        <span class="s1">rdepends=args.r_depends</span><span class="s0">,</span>
        <span class="s1">rimports=args.r_imports</span><span class="s0">,</span>
        <span class="s1">rsuggests=args.r_suggests</span><span class="s0">,</span>
        <span class="s1">jlprefix=args.jl_prefix</span><span class="s0">,</span>
        <span class="s1">keep_prop_order=args.keep_prop_order</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s3"># pylint: disable=undefined-variable</span>
<span class="s0">def </span><span class="s1">byteify(input_object):</span>
    <span class="s0">if </span><span class="s1">isinstance(input_object</span><span class="s0">, </span><span class="s1">dict):</span>
        <span class="s0">return </span><span class="s1">OrderedDict(</span>
            <span class="s1">[(byteify(key)</span><span class="s0">, </span><span class="s1">byteify(value)) </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">input_object.iteritems()]</span>
        <span class="s1">)</span>
    <span class="s0">if </span><span class="s1">isinstance(input_object</span><span class="s0">, </span><span class="s1">list):</span>
        <span class="s0">return </span><span class="s1">[byteify(element) </span><span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">input_object]</span>
    <span class="s0">if </span><span class="s1">isinstance(input_object</span><span class="s0">, </span><span class="s1">unicode):  </span><span class="s3"># noqa:F821</span>
        <span class="s0">return </span><span class="s1">input_object.encode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">input_object</span>


<span class="s0">if </span><span class="s1">__name__ == </span><span class="s2">&quot;__main__&quot;</span><span class="s1">:</span>
    <span class="s1">cli()</span>
</pre>
</body>
</html>