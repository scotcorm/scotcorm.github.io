<html>
<head>
<title>capi_maps.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
capi_maps.py</font>
</center></td></tr></table>
<pre><span class="s0">#!/usr/bin/env python3</span>
<span class="s2">&quot;&quot;&quot; 
 
Copyright 1999,2000 Pearu Peterson all rights reserved, 
Pearu Peterson &lt;pearu@ioc.ee&gt; 
Permission to use, modify, and distribute this software is given under the 
terms of the NumPy License. 
 
NO WARRANTY IS EXPRESSED OR IMPLIED.  USE AT YOUR OWN RISK. 
$Date: 2005/05/06 10:57:33 $ 
Pearu Peterson 
 
&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">__version__</span>
<span class="s1">f2py_version = __version__.version</span>

<span class="s3">import </span><span class="s1">copy</span>
<span class="s3">import </span><span class="s1">re</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">from </span><span class="s1">.crackfortran </span><span class="s3">import </span><span class="s1">markoutercomma</span>
<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">cb_rules</span>

<span class="s0"># The environment provided by auxfuncs.py is needed for some calls to eval.</span>
<span class="s0"># As the needed functions cannot be determined by static inspection of the</span>
<span class="s0"># code, it is safest to use import * pending a major refactoring of f2py.</span>
<span class="s3">from </span><span class="s1">.auxfuncs </span><span class="s3">import </span><span class="s1">*</span>

<span class="s1">__all__ = [</span>
    <span class="s4">'getctype'</span><span class="s3">, </span><span class="s4">'getstrlength'</span><span class="s3">, </span><span class="s4">'getarrdims'</span><span class="s3">, </span><span class="s4">'getpydocsign'</span><span class="s3">,</span>
    <span class="s4">'getarrdocsign'</span><span class="s3">, </span><span class="s4">'getinit'</span><span class="s3">, </span><span class="s4">'sign2map'</span><span class="s3">, </span><span class="s4">'routsign2map'</span><span class="s3">, </span><span class="s4">'modsign2map'</span><span class="s3">,</span>
    <span class="s4">'cb_sign2map'</span><span class="s3">, </span><span class="s4">'cb_routsign2map'</span><span class="s3">, </span><span class="s4">'common_sign2map'</span>
<span class="s1">]</span>


<span class="s0"># Numarray and Numeric users should set this False</span>
<span class="s1">using_newcore = </span><span class="s3">True</span>

<span class="s1">depargs = []</span>
<span class="s1">lcb_map = {}</span>
<span class="s1">lcb2_map = {}</span>
<span class="s0"># forced casting: mainly caused by the fact that Python or Numeric</span>
<span class="s0">#                 C/APIs do not support the corresponding C types.</span>
<span class="s1">c2py_map = {</span><span class="s4">'double'</span><span class="s1">: </span><span class="s4">'float'</span><span class="s3">,</span>
            <span class="s4">'float'</span><span class="s1">: </span><span class="s4">'float'</span><span class="s3">,                          </span><span class="s0"># forced casting</span>
            <span class="s4">'long_double'</span><span class="s1">: </span><span class="s4">'float'</span><span class="s3">,                    </span><span class="s0"># forced casting</span>
            <span class="s4">'char'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,                             </span><span class="s0"># forced casting</span>
            <span class="s4">'signed_char'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,                      </span><span class="s0"># forced casting</span>
            <span class="s4">'unsigned_char'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,                    </span><span class="s0"># forced casting</span>
            <span class="s4">'short'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,                            </span><span class="s0"># forced casting</span>
            <span class="s4">'unsigned_short'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,                   </span><span class="s0"># forced casting</span>
            <span class="s4">'int'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,                              </span><span class="s0"># forced casting</span>
            <span class="s4">'long'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,</span>
            <span class="s4">'long_long'</span><span class="s1">: </span><span class="s4">'long'</span><span class="s3">,</span>
            <span class="s4">'unsigned'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,                         </span><span class="s0"># forced casting</span>
            <span class="s4">'complex_float'</span><span class="s1">: </span><span class="s4">'complex'</span><span class="s3">,                </span><span class="s0"># forced casting</span>
            <span class="s4">'complex_double'</span><span class="s1">: </span><span class="s4">'complex'</span><span class="s3">,</span>
            <span class="s4">'complex_long_double'</span><span class="s1">: </span><span class="s4">'complex'</span><span class="s3">,          </span><span class="s0"># forced casting</span>
            <span class="s4">'string'</span><span class="s1">: </span><span class="s4">'string'</span><span class="s3">,</span>
            <span class="s1">}</span>
<span class="s1">c2capi_map = {</span><span class="s4">'double'</span><span class="s1">: </span><span class="s4">'NPY_DOUBLE'</span><span class="s3">,</span>
              <span class="s4">'float'</span><span class="s1">: </span><span class="s4">'NPY_FLOAT'</span><span class="s3">,</span>
              <span class="s4">'long_double'</span><span class="s1">: </span><span class="s4">'NPY_DOUBLE'</span><span class="s3">,           </span><span class="s0"># forced casting</span>
              <span class="s4">'char'</span><span class="s1">: </span><span class="s4">'NPY_STRING'</span><span class="s3">,</span>
              <span class="s4">'unsigned_char'</span><span class="s1">: </span><span class="s4">'NPY_UBYTE'</span><span class="s3">,</span>
              <span class="s4">'signed_char'</span><span class="s1">: </span><span class="s4">'NPY_BYTE'</span><span class="s3">,</span>
              <span class="s4">'short'</span><span class="s1">: </span><span class="s4">'NPY_SHORT'</span><span class="s3">,</span>
              <span class="s4">'unsigned_short'</span><span class="s1">: </span><span class="s4">'NPY_USHORT'</span><span class="s3">,</span>
              <span class="s4">'int'</span><span class="s1">: </span><span class="s4">'NPY_INT'</span><span class="s3">,</span>
              <span class="s4">'unsigned'</span><span class="s1">: </span><span class="s4">'NPY_UINT'</span><span class="s3">,</span>
              <span class="s4">'long'</span><span class="s1">: </span><span class="s4">'NPY_LONG'</span><span class="s3">,</span>
              <span class="s4">'long_long'</span><span class="s1">: </span><span class="s4">'NPY_LONG'</span><span class="s3">,                </span><span class="s0"># forced casting</span>
              <span class="s4">'complex_float'</span><span class="s1">: </span><span class="s4">'NPY_CFLOAT'</span><span class="s3">,</span>
              <span class="s4">'complex_double'</span><span class="s1">: </span><span class="s4">'NPY_CDOUBLE'</span><span class="s3">,</span>
              <span class="s4">'complex_long_double'</span><span class="s1">: </span><span class="s4">'NPY_CDOUBLE'</span><span class="s3">,   </span><span class="s0"># forced casting</span>
              <span class="s4">'string'</span><span class="s1">: </span><span class="s4">'NPY_STRING'</span><span class="s1">}</span>

<span class="s0"># These new maps aren't used anywhere yet, but should be by default</span>
<span class="s0">#  unless building numeric or numarray extensions.</span>
<span class="s3">if </span><span class="s1">using_newcore:</span>
    <span class="s1">c2capi_map = {</span><span class="s4">'double'</span><span class="s1">: </span><span class="s4">'NPY_DOUBLE'</span><span class="s3">,</span>
                  <span class="s4">'float'</span><span class="s1">: </span><span class="s4">'NPY_FLOAT'</span><span class="s3">,</span>
                  <span class="s4">'long_double'</span><span class="s1">: </span><span class="s4">'NPY_LONGDOUBLE'</span><span class="s3">,</span>
                  <span class="s4">'char'</span><span class="s1">: </span><span class="s4">'NPY_BYTE'</span><span class="s3">,</span>
                  <span class="s4">'unsigned_char'</span><span class="s1">: </span><span class="s4">'NPY_UBYTE'</span><span class="s3">,</span>
                  <span class="s4">'signed_char'</span><span class="s1">: </span><span class="s4">'NPY_BYTE'</span><span class="s3">,</span>
                  <span class="s4">'short'</span><span class="s1">: </span><span class="s4">'NPY_SHORT'</span><span class="s3">,</span>
                  <span class="s4">'unsigned_short'</span><span class="s1">: </span><span class="s4">'NPY_USHORT'</span><span class="s3">,</span>
                  <span class="s4">'int'</span><span class="s1">: </span><span class="s4">'NPY_INT'</span><span class="s3">,</span>
                  <span class="s4">'unsigned'</span><span class="s1">: </span><span class="s4">'NPY_UINT'</span><span class="s3">,</span>
                  <span class="s4">'long'</span><span class="s1">: </span><span class="s4">'NPY_LONG'</span><span class="s3">,</span>
                  <span class="s4">'unsigned_long'</span><span class="s1">: </span><span class="s4">'NPY_ULONG'</span><span class="s3">,</span>
                  <span class="s4">'long_long'</span><span class="s1">: </span><span class="s4">'NPY_LONGLONG'</span><span class="s3">,</span>
                  <span class="s4">'unsigned_long_long'</span><span class="s1">: </span><span class="s4">'NPY_ULONGLONG'</span><span class="s3">,</span>
                  <span class="s4">'complex_float'</span><span class="s1">: </span><span class="s4">'NPY_CFLOAT'</span><span class="s3">,</span>
                  <span class="s4">'complex_double'</span><span class="s1">: </span><span class="s4">'NPY_CDOUBLE'</span><span class="s3">,</span>
                  <span class="s4">'complex_long_double'</span><span class="s1">: </span><span class="s4">'NPY_CDOUBLE'</span><span class="s3">,</span>
                  <span class="s4">'string'</span><span class="s1">:</span><span class="s4">'NPY_STRING'</span>
                  <span class="s1">}</span>

<span class="s1">c2pycode_map = {</span><span class="s4">'double'</span><span class="s1">: </span><span class="s4">'d'</span><span class="s3">,</span>
                <span class="s4">'float'</span><span class="s1">: </span><span class="s4">'f'</span><span class="s3">,</span>
                <span class="s4">'long_double'</span><span class="s1">: </span><span class="s4">'d'</span><span class="s3">,                       </span><span class="s0"># forced casting</span>
                <span class="s4">'char'</span><span class="s1">: </span><span class="s4">'1'</span><span class="s3">,</span>
                <span class="s4">'signed_char'</span><span class="s1">: </span><span class="s4">'1'</span><span class="s3">,</span>
                <span class="s4">'unsigned_char'</span><span class="s1">: </span><span class="s4">'b'</span><span class="s3">,</span>
                <span class="s4">'short'</span><span class="s1">: </span><span class="s4">'s'</span><span class="s3">,</span>
                <span class="s4">'unsigned_short'</span><span class="s1">: </span><span class="s4">'w'</span><span class="s3">,</span>
                <span class="s4">'int'</span><span class="s1">: </span><span class="s4">'i'</span><span class="s3">,</span>
                <span class="s4">'unsigned'</span><span class="s1">: </span><span class="s4">'u'</span><span class="s3">,</span>
                <span class="s4">'long'</span><span class="s1">: </span><span class="s4">'l'</span><span class="s3">,</span>
                <span class="s4">'long_long'</span><span class="s1">: </span><span class="s4">'L'</span><span class="s3">,</span>
                <span class="s4">'complex_float'</span><span class="s1">: </span><span class="s4">'F'</span><span class="s3">,</span>
                <span class="s4">'complex_double'</span><span class="s1">: </span><span class="s4">'D'</span><span class="s3">,</span>
                <span class="s4">'complex_long_double'</span><span class="s1">: </span><span class="s4">'D'</span><span class="s3">,               </span><span class="s0"># forced casting</span>
                <span class="s4">'string'</span><span class="s1">: </span><span class="s4">'c'</span>
                <span class="s1">}</span>

<span class="s3">if </span><span class="s1">using_newcore:</span>
    <span class="s1">c2pycode_map = {</span><span class="s4">'double'</span><span class="s1">: </span><span class="s4">'d'</span><span class="s3">,</span>
                    <span class="s4">'float'</span><span class="s1">: </span><span class="s4">'f'</span><span class="s3">,</span>
                    <span class="s4">'long_double'</span><span class="s1">: </span><span class="s4">'g'</span><span class="s3">,</span>
                    <span class="s4">'char'</span><span class="s1">: </span><span class="s4">'b'</span><span class="s3">,</span>
                    <span class="s4">'unsigned_char'</span><span class="s1">: </span><span class="s4">'B'</span><span class="s3">,</span>
                    <span class="s4">'signed_char'</span><span class="s1">: </span><span class="s4">'b'</span><span class="s3">,</span>
                    <span class="s4">'short'</span><span class="s1">: </span><span class="s4">'h'</span><span class="s3">,</span>
                    <span class="s4">'unsigned_short'</span><span class="s1">: </span><span class="s4">'H'</span><span class="s3">,</span>
                    <span class="s4">'int'</span><span class="s1">: </span><span class="s4">'i'</span><span class="s3">,</span>
                    <span class="s4">'unsigned'</span><span class="s1">: </span><span class="s4">'I'</span><span class="s3">,</span>
                    <span class="s4">'long'</span><span class="s1">: </span><span class="s4">'l'</span><span class="s3">,</span>
                    <span class="s4">'unsigned_long'</span><span class="s1">: </span><span class="s4">'L'</span><span class="s3">,</span>
                    <span class="s4">'long_long'</span><span class="s1">: </span><span class="s4">'q'</span><span class="s3">,</span>
                    <span class="s4">'unsigned_long_long'</span><span class="s1">: </span><span class="s4">'Q'</span><span class="s3">,</span>
                    <span class="s4">'complex_float'</span><span class="s1">: </span><span class="s4">'F'</span><span class="s3">,</span>
                    <span class="s4">'complex_double'</span><span class="s1">: </span><span class="s4">'D'</span><span class="s3">,</span>
                    <span class="s4">'complex_long_double'</span><span class="s1">: </span><span class="s4">'G'</span><span class="s3">,</span>
                    <span class="s4">'string'</span><span class="s1">: </span><span class="s4">'S'</span><span class="s1">}</span>

<span class="s1">c2buildvalue_map = {</span><span class="s4">'double'</span><span class="s1">: </span><span class="s4">'d'</span><span class="s3">,</span>
                    <span class="s4">'float'</span><span class="s1">: </span><span class="s4">'f'</span><span class="s3">,</span>
                    <span class="s4">'char'</span><span class="s1">: </span><span class="s4">'b'</span><span class="s3">,</span>
                    <span class="s4">'signed_char'</span><span class="s1">: </span><span class="s4">'b'</span><span class="s3">,</span>
                    <span class="s4">'short'</span><span class="s1">: </span><span class="s4">'h'</span><span class="s3">,</span>
                    <span class="s4">'int'</span><span class="s1">: </span><span class="s4">'i'</span><span class="s3">,</span>
                    <span class="s4">'long'</span><span class="s1">: </span><span class="s4">'l'</span><span class="s3">,</span>
                    <span class="s4">'long_long'</span><span class="s1">: </span><span class="s4">'L'</span><span class="s3">,</span>
                    <span class="s4">'complex_float'</span><span class="s1">: </span><span class="s4">'N'</span><span class="s3">,</span>
                    <span class="s4">'complex_double'</span><span class="s1">: </span><span class="s4">'N'</span><span class="s3">,</span>
                    <span class="s4">'complex_long_double'</span><span class="s1">: </span><span class="s4">'N'</span><span class="s3">,</span>
                    <span class="s4">'string'</span><span class="s1">: </span><span class="s4">'y'</span><span class="s1">}</span>

<span class="s1">f2cmap_all = {</span><span class="s4">'real'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'float'</span><span class="s3">, </span><span class="s4">'4'</span><span class="s1">: </span><span class="s4">'float'</span><span class="s3">, </span><span class="s4">'8'</span><span class="s1">: </span><span class="s4">'double'</span><span class="s3">,</span>
                       <span class="s4">'12'</span><span class="s1">: </span><span class="s4">'long_double'</span><span class="s3">, </span><span class="s4">'16'</span><span class="s1">: </span><span class="s4">'long_double'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'integer'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">, </span><span class="s4">'1'</span><span class="s1">: </span><span class="s4">'signed_char'</span><span class="s3">, </span><span class="s4">'2'</span><span class="s1">: </span><span class="s4">'short'</span><span class="s3">,</span>
                          <span class="s4">'4'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">, </span><span class="s4">'8'</span><span class="s1">: </span><span class="s4">'long_long'</span><span class="s3">,</span>
                          <span class="s4">'-1'</span><span class="s1">: </span><span class="s4">'unsigned_char'</span><span class="s3">, </span><span class="s4">'-2'</span><span class="s1">: </span><span class="s4">'unsigned_short'</span><span class="s3">,</span>
                          <span class="s4">'-4'</span><span class="s1">: </span><span class="s4">'unsigned'</span><span class="s3">, </span><span class="s4">'-8'</span><span class="s1">: </span><span class="s4">'unsigned_long_long'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'complex'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'complex_float'</span><span class="s3">, </span><span class="s4">'8'</span><span class="s1">: </span><span class="s4">'complex_float'</span><span class="s3">,</span>
                          <span class="s4">'16'</span><span class="s1">: </span><span class="s4">'complex_double'</span><span class="s3">, </span><span class="s4">'24'</span><span class="s1">: </span><span class="s4">'complex_long_double'</span><span class="s3">,</span>
                          <span class="s4">'32'</span><span class="s1">: </span><span class="s4">'complex_long_double'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'complexkind'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'complex_float'</span><span class="s3">, </span><span class="s4">'4'</span><span class="s1">: </span><span class="s4">'complex_float'</span><span class="s3">,</span>
                              <span class="s4">'8'</span><span class="s1">: </span><span class="s4">'complex_double'</span><span class="s3">, </span><span class="s4">'12'</span><span class="s1">: </span><span class="s4">'complex_long_double'</span><span class="s3">,</span>
                              <span class="s4">'16'</span><span class="s1">: </span><span class="s4">'complex_long_double'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'logical'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">, </span><span class="s4">'1'</span><span class="s1">: </span><span class="s4">'char'</span><span class="s3">, </span><span class="s4">'2'</span><span class="s1">: </span><span class="s4">'short'</span><span class="s3">, </span><span class="s4">'4'</span><span class="s1">: </span><span class="s4">'int'</span><span class="s3">,</span>
                          <span class="s4">'8'</span><span class="s1">: </span><span class="s4">'long_long'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'double complex'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'complex_double'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'double precision'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'double'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'byte'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'char'</span><span class="s1">}</span><span class="s3">,</span>
              <span class="s4">'character'</span><span class="s1">: {</span><span class="s4">''</span><span class="s1">: </span><span class="s4">'string'</span><span class="s1">}</span>
              <span class="s1">}</span>

<span class="s1">f2cmap_default = copy.deepcopy(f2cmap_all)</span>


<span class="s3">def </span><span class="s1">load_f2cmap_file(f2cmap_file):</span>
    <span class="s3">global </span><span class="s1">f2cmap_all</span>

    <span class="s1">f2cmap_all = copy.deepcopy(f2cmap_default)</span>

    <span class="s3">if </span><span class="s1">f2cmap_file </span><span class="s3">is None</span><span class="s1">:</span>
        <span class="s0"># Default value</span>
        <span class="s1">f2cmap_file = </span><span class="s4">'.f2py_f2cmap'</span>
        <span class="s3">if not </span><span class="s1">os.path.isfile(f2cmap_file):</span>
            <span class="s3">return</span>

    <span class="s0"># User defined additions to f2cmap_all.</span>
    <span class="s0"># f2cmap_file must contain a dictionary of dictionaries, only. For</span>
    <span class="s0"># example, {'real':{'low':'float'}} means that Fortran 'real(low)' is</span>
    <span class="s0"># interpreted as C 'float'. This feature is useful for F90/95 users if</span>
    <span class="s0"># they use PARAMETERS in type specifications.</span>
    <span class="s3">try</span><span class="s1">:</span>
        <span class="s1">outmess(</span><span class="s4">'Reading f2cmap from {!r} ...</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">.format(f2cmap_file))</span>
        <span class="s3">with </span><span class="s1">open(f2cmap_file</span><span class="s3">, </span><span class="s4">'r'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s1">d = eval(f.read()</span><span class="s3">, </span><span class="s1">{}</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s3">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">d1 </span><span class="s3">in </span><span class="s1">d.items():</span>
            <span class="s3">for </span><span class="s1">k1 </span><span class="s3">in </span><span class="s1">d1.keys():</span>
                <span class="s1">d1[k1.lower()] = d1[k1]</span>
            <span class="s1">d[k.lower()] = d[k]</span>
        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">d.keys():</span>
            <span class="s3">if </span><span class="s1">k </span><span class="s3">not in </span><span class="s1">f2cmap_all:</span>
                <span class="s1">f2cmap_all[k] = {}</span>
            <span class="s3">for </span><span class="s1">k1 </span><span class="s3">in </span><span class="s1">d[k].keys():</span>
                <span class="s3">if </span><span class="s1">d[k][k1] </span><span class="s3">in </span><span class="s1">c2py_map:</span>
                    <span class="s3">if </span><span class="s1">k1 </span><span class="s3">in </span><span class="s1">f2cmap_all[k]:</span>
                        <span class="s1">outmess(</span>
                            <span class="s4">&quot;</span><span class="s3">\t</span><span class="s4">Warning: redefinition of {'%s':{'%s':'%s'-&gt;'%s'}}</span><span class="s3">\n</span><span class="s4">&quot; </span><span class="s1">% (k</span><span class="s3">, </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">f2cmap_all[k][k1]</span><span class="s3">, </span><span class="s1">d[k][k1]))</span>
                    <span class="s1">f2cmap_all[k][k1] = d[k][k1]</span>
                    <span class="s1">outmess(</span><span class="s4">'</span><span class="s3">\t</span><span class="s4">Mapping &quot;%s(kind=%s)&quot; to &quot;%s&quot;</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">%</span>
                            <span class="s1">(k</span><span class="s3">, </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">d[k][k1]))</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s1">errmess(</span><span class="s4">&quot;</span><span class="s3">\t</span><span class="s4">Ignoring map {'%s':{'%s':'%s'}}: '%s' must be in %s</span><span class="s3">\n</span><span class="s4">&quot; </span><span class="s1">% (</span>
                        <span class="s1">k</span><span class="s3">, </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">d[k][k1]</span><span class="s3">, </span><span class="s1">d[k][k1]</span><span class="s3">, </span><span class="s1">list(c2py_map.keys())))</span>
        <span class="s1">outmess(</span><span class="s4">'Successfully applied user defined f2cmap changes</span><span class="s3">\n</span><span class="s4">'</span><span class="s1">)</span>
    <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">msg:</span>
        <span class="s1">errmess(</span>
            <span class="s4">'Failed to apply user defined f2cmap changes: %s. Skipping.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (msg))</span>

<span class="s1">cformat_map = {</span><span class="s4">'double'</span><span class="s1">: </span><span class="s4">'%g'</span><span class="s3">,</span>
               <span class="s4">'float'</span><span class="s1">: </span><span class="s4">'%g'</span><span class="s3">,</span>
               <span class="s4">'long_double'</span><span class="s1">: </span><span class="s4">'%Lg'</span><span class="s3">,</span>
               <span class="s4">'char'</span><span class="s1">: </span><span class="s4">'%d'</span><span class="s3">,</span>
               <span class="s4">'signed_char'</span><span class="s1">: </span><span class="s4">'%d'</span><span class="s3">,</span>
               <span class="s4">'unsigned_char'</span><span class="s1">: </span><span class="s4">'%hhu'</span><span class="s3">,</span>
               <span class="s4">'short'</span><span class="s1">: </span><span class="s4">'%hd'</span><span class="s3">,</span>
               <span class="s4">'unsigned_short'</span><span class="s1">: </span><span class="s4">'%hu'</span><span class="s3">,</span>
               <span class="s4">'int'</span><span class="s1">: </span><span class="s4">'%d'</span><span class="s3">,</span>
               <span class="s4">'unsigned'</span><span class="s1">: </span><span class="s4">'%u'</span><span class="s3">,</span>
               <span class="s4">'long'</span><span class="s1">: </span><span class="s4">'%ld'</span><span class="s3">,</span>
               <span class="s4">'unsigned_long'</span><span class="s1">: </span><span class="s4">'%lu'</span><span class="s3">,</span>
               <span class="s4">'long_long'</span><span class="s1">: </span><span class="s4">'%ld'</span><span class="s3">,</span>
               <span class="s4">'complex_float'</span><span class="s1">: </span><span class="s4">'(%g,%g)'</span><span class="s3">,</span>
               <span class="s4">'complex_double'</span><span class="s1">: </span><span class="s4">'(%g,%g)'</span><span class="s3">,</span>
               <span class="s4">'complex_long_double'</span><span class="s1">: </span><span class="s4">'(%Lg,%Lg)'</span><span class="s3">,</span>
               <span class="s4">'string'</span><span class="s1">: </span><span class="s4">'%s'</span><span class="s3">,</span>
               <span class="s1">}</span>

<span class="s0"># Auxiliary functions</span>


<span class="s3">def </span><span class="s1">getctype(var):</span>
    <span class="s2">&quot;&quot;&quot; 
    Determines C type 
    &quot;&quot;&quot;</span>
    <span class="s1">ctype = </span><span class="s4">'void'</span>
    <span class="s3">if </span><span class="s1">isfunction(var):</span>
        <span class="s3">if </span><span class="s4">'result' </span><span class="s3">in </span><span class="s1">var:</span>
            <span class="s1">a = var[</span><span class="s4">'result'</span><span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">a = var[</span><span class="s4">'name'</span><span class="s1">]</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'vars'</span><span class="s1">]:</span>
            <span class="s3">return </span><span class="s1">getctype(var[</span><span class="s4">'vars'</span><span class="s1">][a])</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">errmess(</span><span class="s4">'getctype: function %s has no return value?!</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% a)</span>
    <span class="s3">elif </span><span class="s1">issubroutine(var):</span>
        <span class="s3">return </span><span class="s1">ctype</span>
    <span class="s3">elif </span><span class="s4">'typespec' </span><span class="s3">in </span><span class="s1">var </span><span class="s3">and </span><span class="s1">var[</span><span class="s4">'typespec'</span><span class="s1">].lower() </span><span class="s3">in </span><span class="s1">f2cmap_all:</span>
        <span class="s1">typespec = var[</span><span class="s4">'typespec'</span><span class="s1">].lower()</span>
        <span class="s1">f2cmap = f2cmap_all[typespec]</span>
        <span class="s1">ctype = f2cmap[</span><span class="s4">''</span><span class="s1">]  </span><span class="s0"># default type</span>
        <span class="s3">if </span><span class="s4">'kindselector' </span><span class="s3">in </span><span class="s1">var:</span>
            <span class="s3">if </span><span class="s4">'*' </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'kindselector'</span><span class="s1">]:</span>
                <span class="s3">try</span><span class="s1">:</span>
                    <span class="s1">ctype = f2cmap[var[</span><span class="s4">'kindselector'</span><span class="s1">][</span><span class="s4">'*'</span><span class="s1">]]</span>
                <span class="s3">except </span><span class="s1">KeyError:</span>
                    <span class="s1">errmess(</span><span class="s4">'getctype: &quot;%s %s %s&quot; not supported.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">%</span>
                            <span class="s1">(var[</span><span class="s4">'typespec'</span><span class="s1">]</span><span class="s3">, </span><span class="s4">'*'</span><span class="s3">, </span><span class="s1">var[</span><span class="s4">'kindselector'</span><span class="s1">][</span><span class="s4">'*'</span><span class="s1">]))</span>
            <span class="s3">elif </span><span class="s4">'kind' </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'kindselector'</span><span class="s1">]:</span>
                <span class="s3">if </span><span class="s1">typespec + </span><span class="s4">'kind' </span><span class="s3">in </span><span class="s1">f2cmap_all:</span>
                    <span class="s1">f2cmap = f2cmap_all[typespec + </span><span class="s4">'kind'</span><span class="s1">]</span>
                <span class="s3">try</span><span class="s1">:</span>
                    <span class="s1">ctype = f2cmap[var[</span><span class="s4">'kindselector'</span><span class="s1">][</span><span class="s4">'kind'</span><span class="s1">]]</span>
                <span class="s3">except </span><span class="s1">KeyError:</span>
                    <span class="s3">if </span><span class="s1">typespec </span><span class="s3">in </span><span class="s1">f2cmap_all:</span>
                        <span class="s1">f2cmap = f2cmap_all[typespec]</span>
                    <span class="s3">try</span><span class="s1">:</span>
                        <span class="s1">ctype = f2cmap[str(var[</span><span class="s4">'kindselector'</span><span class="s1">][</span><span class="s4">'kind'</span><span class="s1">])]</span>
                    <span class="s3">except </span><span class="s1">KeyError:</span>
                        <span class="s1">errmess(</span><span class="s4">'getctype: &quot;%s(kind=%s)&quot; is mapped to C &quot;%s&quot; (to override define dict(%s = dict(%s=&quot;&lt;C typespec&gt;&quot;)) in %s/.f2py_f2cmap file).</span><span class="s3">\n</span><span class="s4">'</span>
                                <span class="s1">% (typespec</span><span class="s3">, </span><span class="s1">var[</span><span class="s4">'kindselector'</span><span class="s1">][</span><span class="s4">'kind'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ctype</span><span class="s3">,</span>
                                   <span class="s1">typespec</span><span class="s3">, </span><span class="s1">var[</span><span class="s4">'kindselector'</span><span class="s1">][</span><span class="s4">'kind'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">os.getcwd()))</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">if not </span><span class="s1">isexternal(var):</span>
            <span class="s1">errmess(</span><span class="s4">'getctype: No C-type found in &quot;%s&quot;, assuming void.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% var)</span>
    <span class="s3">return </span><span class="s1">ctype</span>


<span class="s3">def </span><span class="s1">getstrlength(var):</span>
    <span class="s3">if </span><span class="s1">isstringfunction(var):</span>
        <span class="s3">if </span><span class="s4">'result' </span><span class="s3">in </span><span class="s1">var:</span>
            <span class="s1">a = var[</span><span class="s4">'result'</span><span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">a = var[</span><span class="s4">'name'</span><span class="s1">]</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'vars'</span><span class="s1">]:</span>
            <span class="s3">return </span><span class="s1">getstrlength(var[</span><span class="s4">'vars'</span><span class="s1">][a])</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">errmess(</span><span class="s4">'getstrlength: function %s has no return value?!</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% a)</span>
    <span class="s3">if not </span><span class="s1">isstring(var):</span>
        <span class="s1">errmess(</span>
            <span class="s4">'getstrlength: expected a signature of a string but got: %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (repr(var)))</span>
    <span class="s1">len = </span><span class="s4">'1'</span>
    <span class="s3">if </span><span class="s4">'charselector' </span><span class="s3">in </span><span class="s1">var:</span>
        <span class="s1">a = var[</span><span class="s4">'charselector'</span><span class="s1">]</span>
        <span class="s3">if </span><span class="s4">'*' </span><span class="s3">in </span><span class="s1">a:</span>
            <span class="s1">len = a[</span><span class="s4">'*'</span><span class="s1">]</span>
        <span class="s3">elif </span><span class="s4">'len' </span><span class="s3">in </span><span class="s1">a:</span>
            <span class="s1">len = a[</span><span class="s4">'len'</span><span class="s1">]</span>
    <span class="s3">if </span><span class="s1">re.match(</span><span class="s4">r'\(\s*(\*|:)\s*\)'</span><span class="s3">, </span><span class="s1">len) </span><span class="s3">or </span><span class="s1">re.match(</span><span class="s4">r'(\*|:)'</span><span class="s3">, </span><span class="s1">len):</span>
        <span class="s3">if </span><span class="s1">isintent_hide(var):</span>
            <span class="s1">errmess(</span><span class="s4">'getstrlength:intent(hide): expected a string with defined length but got: %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (</span>
                <span class="s1">repr(var)))</span>
        <span class="s1">len = </span><span class="s4">'-1'</span>
    <span class="s3">return </span><span class="s1">len</span>


<span class="s3">def </span><span class="s1">getarrdims(a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">, </span><span class="s1">verbose=</span><span class="s5">0</span><span class="s1">):</span>
    <span class="s1">ret = {}</span>
    <span class="s3">if </span><span class="s1">isstring(var) </span><span class="s3">and not </span><span class="s1">isarray(var):</span>
        <span class="s1">ret[</span><span class="s4">'dims'</span><span class="s1">] = getstrlength(var)</span>
        <span class="s1">ret[</span><span class="s4">'size'</span><span class="s1">] = ret[</span><span class="s4">'dims'</span><span class="s1">]</span>
        <span class="s1">ret[</span><span class="s4">'rank'</span><span class="s1">] = </span><span class="s4">'1'</span>
    <span class="s3">elif </span><span class="s1">isscalar(var):</span>
        <span class="s1">ret[</span><span class="s4">'size'</span><span class="s1">] = </span><span class="s4">'1'</span>
        <span class="s1">ret[</span><span class="s4">'rank'</span><span class="s1">] = </span><span class="s4">'0'</span>
        <span class="s1">ret[</span><span class="s4">'dims'</span><span class="s1">] = </span><span class="s4">''</span>
    <span class="s3">elif </span><span class="s1">isarray(var):</span>
        <span class="s1">dim = copy.copy(var[</span><span class="s4">'dimension'</span><span class="s1">])</span>
        <span class="s1">ret[</span><span class="s4">'size'</span><span class="s1">] = </span><span class="s4">'*'</span><span class="s1">.join(dim)</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s1">ret[</span><span class="s4">'size'</span><span class="s1">] = repr(eval(ret[</span><span class="s4">'size'</span><span class="s1">]))</span>
        <span class="s3">except </span><span class="s1">Exception:</span>
            <span class="s3">pass</span>
        <span class="s1">ret[</span><span class="s4">'dims'</span><span class="s1">] = </span><span class="s4">','</span><span class="s1">.join(dim)</span>
        <span class="s1">ret[</span><span class="s4">'rank'</span><span class="s1">] = repr(len(dim))</span>
        <span class="s1">ret[</span><span class="s4">'rank*[-1]'</span><span class="s1">] = repr(len(dim) * [-</span><span class="s5">1</span><span class="s1">])[</span><span class="s5">1</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(len(dim)):  </span><span class="s0"># solve dim for dependencies</span>
            <span class="s1">v = []</span>
            <span class="s3">if </span><span class="s1">dim[i] </span><span class="s3">in </span><span class="s1">depargs:</span>
                <span class="s1">v = [dim[i]]</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s3">for </span><span class="s1">va </span><span class="s3">in </span><span class="s1">depargs:</span>
                    <span class="s3">if </span><span class="s1">re.match(</span><span class="s4">r'.*?\b%s\b.*' </span><span class="s1">% va</span><span class="s3">, </span><span class="s1">dim[i]):</span>
                        <span class="s1">v.append(va)</span>
            <span class="s3">for </span><span class="s1">va </span><span class="s3">in </span><span class="s1">v:</span>
                <span class="s3">if </span><span class="s1">depargs.index(va) &gt; depargs.index(a):</span>
                    <span class="s1">dim[i] = </span><span class="s4">'*'</span>
                    <span class="s3">break</span>
        <span class="s1">ret[</span><span class="s4">'setdims'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">i = </span><span class="s4">''</span><span class="s3">, </span><span class="s1">-</span><span class="s5">1</span>
        <span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">dim:</span>
            <span class="s1">i = i + </span><span class="s5">1</span>
            <span class="s3">if </span><span class="s1">d </span><span class="s3">not in </span><span class="s1">[</span><span class="s4">'*'</span><span class="s3">, </span><span class="s4">':'</span><span class="s3">, </span><span class="s4">'(*)'</span><span class="s3">, </span><span class="s4">'(:)'</span><span class="s1">]:</span>
                <span class="s1">ret[</span><span class="s4">'setdims'</span><span class="s1">] = </span><span class="s4">'%s#varname#_Dims[%d]=%s,' </span><span class="s1">% (</span>
                    <span class="s1">ret[</span><span class="s4">'setdims'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'setdims'</span><span class="s1">]:</span>
            <span class="s1">ret[</span><span class="s4">'setdims'</span><span class="s1">] = ret[</span><span class="s4">'setdims'</span><span class="s1">][:-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">ret[</span><span class="s4">'cbsetdims'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">i = </span><span class="s4">''</span><span class="s3">, </span><span class="s1">-</span><span class="s5">1</span>
        <span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'dimension'</span><span class="s1">]:</span>
            <span class="s1">i = i + </span><span class="s5">1</span>
            <span class="s3">if </span><span class="s1">d </span><span class="s3">not in </span><span class="s1">[</span><span class="s4">'*'</span><span class="s3">, </span><span class="s4">':'</span><span class="s3">, </span><span class="s4">'(*)'</span><span class="s3">, </span><span class="s4">'(:)'</span><span class="s1">]:</span>
                <span class="s1">ret[</span><span class="s4">'cbsetdims'</span><span class="s1">] = </span><span class="s4">'%s#varname#_Dims[%d]=%s,' </span><span class="s1">% (</span>
                    <span class="s1">ret[</span><span class="s4">'cbsetdims'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">d)</span>
            <span class="s3">elif </span><span class="s1">isintent_in(var):</span>
                <span class="s1">outmess(</span><span class="s4">'getarrdims:warning: assumed shape array, using 0 instead of %r</span><span class="s3">\n</span><span class="s4">'</span>
                        <span class="s1">% (d))</span>
                <span class="s1">ret[</span><span class="s4">'cbsetdims'</span><span class="s1">] = </span><span class="s4">'%s#varname#_Dims[%d]=%s,' </span><span class="s1">% (</span>
                    <span class="s1">ret[</span><span class="s4">'cbsetdims'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s3">elif </span><span class="s1">verbose:</span>
                <span class="s1">errmess(</span>
                    <span class="s4">'getarrdims: If in call-back function: array argument %s must have bounded dimensions: got %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (repr(a)</span><span class="s3">, </span><span class="s1">repr(d)))</span>
        <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'cbsetdims'</span><span class="s1">]:</span>
            <span class="s1">ret[</span><span class="s4">'cbsetdims'</span><span class="s1">] = ret[</span><span class="s4">'cbsetdims'</span><span class="s1">][:-</span><span class="s5">1</span><span class="s1">]</span>
<span class="s0">#         if not isintent_c(var):</span>
<span class="s0">#             var['dimension'].reverse()</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">getpydocsign(a</span><span class="s3">, </span><span class="s1">var):</span>
    <span class="s3">global </span><span class="s1">lcb_map</span>
    <span class="s3">if </span><span class="s1">isfunction(var):</span>
        <span class="s3">if </span><span class="s4">'result' </span><span class="s3">in </span><span class="s1">var:</span>
            <span class="s1">af = var[</span><span class="s4">'result'</span><span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">af = var[</span><span class="s4">'name'</span><span class="s1">]</span>
        <span class="s3">if </span><span class="s1">af </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'vars'</span><span class="s1">]:</span>
            <span class="s3">return </span><span class="s1">getpydocsign(af</span><span class="s3">, </span><span class="s1">var[</span><span class="s4">'vars'</span><span class="s1">][af])</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">errmess(</span><span class="s4">'getctype: function %s has no return value?!</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% af)</span>
        <span class="s3">return </span><span class="s4">''</span><span class="s3">, </span><span class="s4">''</span>
    <span class="s1">sig</span><span class="s3">, </span><span class="s1">sigout = a</span><span class="s3">, </span><span class="s1">a</span>
    <span class="s1">opt = </span><span class="s4">''</span>
    <span class="s3">if </span><span class="s1">isintent_in(var):</span>
        <span class="s1">opt = </span><span class="s4">'input'</span>
    <span class="s3">elif </span><span class="s1">isintent_inout(var):</span>
        <span class="s1">opt = </span><span class="s4">'in/output'</span>
    <span class="s1">out_a = a</span>
    <span class="s3">if </span><span class="s1">isintent_out(var):</span>
        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'intent'</span><span class="s1">]:</span>
            <span class="s3">if </span><span class="s1">k[:</span><span class="s5">4</span><span class="s1">] == </span><span class="s4">'out='</span><span class="s1">:</span>
                <span class="s1">out_a = k[</span><span class="s5">4</span><span class="s1">:]</span>
                <span class="s3">break</span>
    <span class="s1">init = </span><span class="s4">''</span>
    <span class="s1">ctype = getctype(var)</span>

    <span class="s3">if </span><span class="s1">hasinitvalue(var):</span>
        <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit = getinit(a</span><span class="s3">, </span><span class="s1">var)</span>
        <span class="s1">init = </span><span class="s4">', optional</span><span class="s3">\\</span><span class="s4">n    Default: %s' </span><span class="s1">% showinit</span>
    <span class="s3">if </span><span class="s1">isscalar(var):</span>
        <span class="s3">if </span><span class="s1">isintent_inout(var):</span>
            <span class="s1">sig = </span><span class="s4">'%s : %s rank-0 array(%s,</span><span class="s3">\'</span><span class="s4">%s</span><span class="s3">\'</span><span class="s4">)%s' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">c2py_map[ctype]</span><span class="s3">,</span>
                                                         <span class="s1">c2pycode_map[ctype]</span><span class="s3">, </span><span class="s1">init)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">sig = </span><span class="s4">'%s : %s %s%s' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">c2py_map[ctype]</span><span class="s3">, </span><span class="s1">init)</span>
        <span class="s1">sigout = </span><span class="s4">'%s : %s' </span><span class="s1">% (out_a</span><span class="s3">, </span><span class="s1">c2py_map[ctype])</span>
    <span class="s3">elif </span><span class="s1">isstring(var):</span>
        <span class="s3">if </span><span class="s1">isintent_inout(var):</span>
            <span class="s1">sig = </span><span class="s4">'%s : %s rank-0 array(string(len=%s),</span><span class="s3">\'</span><span class="s4">c</span><span class="s3">\'</span><span class="s4">)%s' </span><span class="s1">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">getstrlength(var)</span><span class="s3">, </span><span class="s1">init)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">sig = </span><span class="s4">'%s : %s string(len=%s)%s' </span><span class="s1">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">getstrlength(var)</span><span class="s3">, </span><span class="s1">init)</span>
        <span class="s1">sigout = </span><span class="s4">'%s : string(len=%s)' </span><span class="s1">% (out_a</span><span class="s3">, </span><span class="s1">getstrlength(var))</span>
    <span class="s3">elif </span><span class="s1">isarray(var):</span>
        <span class="s1">dim = var[</span><span class="s4">'dimension'</span><span class="s1">]</span>
        <span class="s1">rank = repr(len(dim))</span>
        <span class="s1">sig = </span><span class="s4">'%s : %s rank-%s array(</span><span class="s3">\'</span><span class="s4">%s</span><span class="s3">\'</span><span class="s4">) with bounds (%s)%s' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">,</span>
                                                                    <span class="s1">c2pycode_map[</span>
                                                                        <span class="s1">ctype]</span><span class="s3">,</span>
                                                                    <span class="s4">','</span><span class="s1">.join(dim)</span><span class="s3">, </span><span class="s1">init)</span>
        <span class="s3">if </span><span class="s1">a == out_a:</span>
            <span class="s1">sigout = </span><span class="s4">'%s : rank-%s array(</span><span class="s3">\'</span><span class="s4">%s</span><span class="s3">\'</span><span class="s4">) with bounds (%s)'</span><span class="s1">\</span>
                <span class="s1">% (a</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">, </span><span class="s1">c2pycode_map[ctype]</span><span class="s3">, </span><span class="s4">','</span><span class="s1">.join(dim))</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">sigout = </span><span class="s4">'%s : rank-%s array(</span><span class="s3">\'</span><span class="s4">%s</span><span class="s3">\'</span><span class="s4">) with bounds (%s) and %s storage'</span><span class="s1">\</span>
                <span class="s1">% (out_a</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">, </span><span class="s1">c2pycode_map[ctype]</span><span class="s3">, </span><span class="s4">','</span><span class="s1">.join(dim)</span><span class="s3">, </span><span class="s1">a)</span>
    <span class="s3">elif </span><span class="s1">isexternal(var):</span>
        <span class="s1">ua = </span><span class="s4">''</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">lcb_map </span><span class="s3">and </span><span class="s1">lcb_map[a] </span><span class="s3">in </span><span class="s1">lcb2_map </span><span class="s3">and </span><span class="s4">'argname' </span><span class="s3">in </span><span class="s1">lcb2_map[lcb_map[a]]:</span>
            <span class="s1">ua = lcb2_map[lcb_map[a]][</span><span class="s4">'argname'</span><span class="s1">]</span>
            <span class="s3">if not </span><span class="s1">ua == a:</span>
                <span class="s1">ua = </span><span class="s4">' =&gt; %s' </span><span class="s1">% ua</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">ua = </span><span class="s4">''</span>
        <span class="s1">sig = </span><span class="s4">'%s : call-back function%s' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">ua)</span>
        <span class="s1">sigout = sig</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">errmess(</span>
            <span class="s4">'getpydocsign: Could not resolve docsignature for &quot;%s&quot;.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% a)</span>
    <span class="s3">return </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">sigout</span>


<span class="s3">def </span><span class="s1">getarrdocsign(a</span><span class="s3">, </span><span class="s1">var):</span>
    <span class="s1">ctype = getctype(var)</span>
    <span class="s3">if </span><span class="s1">isstring(var) </span><span class="s3">and </span><span class="s1">(</span><span class="s3">not </span><span class="s1">isarray(var)):</span>
        <span class="s1">sig = </span><span class="s4">'%s : rank-0 array(string(len=%s),</span><span class="s3">\'</span><span class="s4">c</span><span class="s3">\'</span><span class="s4">)' </span><span class="s1">% (a</span><span class="s3">,</span>
                                                           <span class="s1">getstrlength(var))</span>
    <span class="s3">elif </span><span class="s1">isscalar(var):</span>
        <span class="s1">sig = </span><span class="s4">'%s : rank-0 array(%s,</span><span class="s3">\'</span><span class="s4">%s</span><span class="s3">\'</span><span class="s4">)' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">c2py_map[ctype]</span><span class="s3">,</span>
                                                <span class="s1">c2pycode_map[ctype]</span><span class="s3">,</span><span class="s1">)</span>
    <span class="s3">elif </span><span class="s1">isarray(var):</span>
        <span class="s1">dim = var[</span><span class="s4">'dimension'</span><span class="s1">]</span>
        <span class="s1">rank = repr(len(dim))</span>
        <span class="s1">sig = </span><span class="s4">'%s : rank-%s array(</span><span class="s3">\'</span><span class="s4">%s</span><span class="s3">\'</span><span class="s4">) with bounds (%s)' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">,</span>
                                                               <span class="s1">c2pycode_map[</span>
                                                                   <span class="s1">ctype]</span><span class="s3">,</span>
                                                               <span class="s4">','</span><span class="s1">.join(dim))</span>
    <span class="s3">return </span><span class="s1">sig</span>


<span class="s3">def </span><span class="s1">getinit(a</span><span class="s3">, </span><span class="s1">var):</span>
    <span class="s3">if </span><span class="s1">isstring(var):</span>
        <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit = </span><span class="s4">'&quot;&quot;'</span><span class="s3">, </span><span class="s4">&quot;''&quot;</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit = </span><span class="s4">''</span><span class="s3">, </span><span class="s4">''</span>
    <span class="s3">if </span><span class="s1">hasinitvalue(var):</span>
        <span class="s1">init = var[</span><span class="s4">'='</span><span class="s1">]</span>
        <span class="s1">showinit = init</span>
        <span class="s3">if </span><span class="s1">iscomplex(var) </span><span class="s3">or </span><span class="s1">iscomplexarray(var):</span>
            <span class="s1">ret = {}</span>

            <span class="s3">try</span><span class="s1">:</span>
                <span class="s1">v = var[</span><span class="s4">&quot;=&quot;</span><span class="s1">]</span>
                <span class="s3">if </span><span class="s4">',' </span><span class="s3">in </span><span class="s1">v:</span>
                    <span class="s1">ret[</span><span class="s4">'init.r'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'init.i'</span><span class="s1">] = markoutercomma(</span>
                        <span class="s1">v[</span><span class="s5">1</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]).split(</span><span class="s4">'@,@'</span><span class="s1">)</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s1">v = eval(v</span><span class="s3">, </span><span class="s1">{}</span><span class="s3">, </span><span class="s1">{})</span>
                    <span class="s1">ret[</span><span class="s4">'init.r'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'init.i'</span><span class="s1">] = str(v.real)</span><span class="s3">, </span><span class="s1">str(v.imag)</span>
            <span class="s3">except </span><span class="s1">Exception:</span>
                <span class="s3">raise </span><span class="s1">ValueError(</span>
                    <span class="s4">'getinit: expected complex number `(r,i)</span><span class="s3">\' </span><span class="s4">but got `%s</span><span class="s3">\' </span><span class="s4">as initial value of %r.' </span><span class="s1">% (init</span><span class="s3">, </span><span class="s1">a))</span>
            <span class="s3">if </span><span class="s1">isarray(var):</span>
                <span class="s1">init = </span><span class="s4">'(capi_c.r=%s,capi_c.i=%s,capi_c)' </span><span class="s1">% (</span>
                    <span class="s1">ret[</span><span class="s4">'init.r'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'init.i'</span><span class="s1">])</span>
        <span class="s3">elif </span><span class="s1">isstring(var):</span>
            <span class="s3">if not </span><span class="s1">init:</span>
                <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit = </span><span class="s4">'&quot;&quot;'</span><span class="s3">, </span><span class="s4">&quot;''&quot;</span>
            <span class="s3">if </span><span class="s1">init[</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;'&quot;</span><span class="s1">:</span>
                <span class="s1">init = </span><span class="s4">'&quot;%s&quot;' </span><span class="s1">% (init[</span><span class="s5">1</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">].replace(</span><span class="s4">'&quot;'</span><span class="s3">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">&quot;'</span><span class="s1">))</span>
            <span class="s3">if </span><span class="s1">init[</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">'&quot;'</span><span class="s1">:</span>
                <span class="s1">showinit = </span><span class="s4">&quot;'%s'&quot; </span><span class="s1">% (init[</span><span class="s5">1</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">])</span>
    <span class="s3">return </span><span class="s1">init</span><span class="s3">, </span><span class="s1">showinit</span>


<span class="s3">def </span><span class="s1">sign2map(a</span><span class="s3">, </span><span class="s1">var):</span>
    <span class="s2">&quot;&quot;&quot; 
    varname,ctype,atype 
    init,init.r,init.i,pytype 
    vardebuginfo,vardebugshowvalue,varshowvalue 
    varrfromat 
    intent 
    &quot;&quot;&quot;</span>
    <span class="s1">out_a = a</span>
    <span class="s3">if </span><span class="s1">isintent_out(var):</span>
        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">var[</span><span class="s4">'intent'</span><span class="s1">]:</span>
            <span class="s3">if </span><span class="s1">k[:</span><span class="s5">4</span><span class="s1">] == </span><span class="s4">'out='</span><span class="s1">:</span>
                <span class="s1">out_a = k[</span><span class="s5">4</span><span class="s1">:]</span>
                <span class="s3">break</span>
    <span class="s1">ret = {</span><span class="s4">'varname'</span><span class="s1">: a</span><span class="s3">, </span><span class="s4">'outvarname'</span><span class="s1">: out_a</span><span class="s3">, </span><span class="s4">'ctype'</span><span class="s1">: getctype(var)}</span>
    <span class="s1">intent_flags = []</span>
    <span class="s3">for </span><span class="s1">f</span><span class="s3">, </span><span class="s1">s </span><span class="s3">in </span><span class="s1">isintent_dict.items():</span>
        <span class="s3">if </span><span class="s1">f(var):</span>
            <span class="s1">intent_flags.append(</span><span class="s4">'F2PY_%s' </span><span class="s1">% s)</span>
    <span class="s3">if </span><span class="s1">intent_flags:</span>
        <span class="s0"># TODO: Evaluate intent_flags here.</span>
        <span class="s1">ret[</span><span class="s4">'intent'</span><span class="s1">] = </span><span class="s4">'|'</span><span class="s1">.join(intent_flags)</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'intent'</span><span class="s1">] = </span><span class="s4">'F2PY_INTENT_IN'</span>
    <span class="s3">if </span><span class="s1">isarray(var):</span>
        <span class="s1">ret[</span><span class="s4">'varrformat'</span><span class="s1">] = </span><span class="s4">'N'</span>
    <span class="s3">elif </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">c2buildvalue_map:</span>
        <span class="s1">ret[</span><span class="s4">'varrformat'</span><span class="s1">] = c2buildvalue_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]]</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'varrformat'</span><span class="s1">] = </span><span class="s4">'O'</span>
    <span class="s1">ret[</span><span class="s4">'init'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'showinit'</span><span class="s1">] = getinit(a</span><span class="s3">, </span><span class="s1">var)</span>
    <span class="s3">if </span><span class="s1">hasinitvalue(var) </span><span class="s3">and </span><span class="s1">iscomplex(var) </span><span class="s3">and not </span><span class="s1">isarray(var):</span>
        <span class="s1">ret[</span><span class="s4">'init.r'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'init.i'</span><span class="s1">] = markoutercomma(</span>
            <span class="s1">ret[</span><span class="s4">'init'</span><span class="s1">][</span><span class="s5">1</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]).split(</span><span class="s4">'@,@'</span><span class="s1">)</span>
    <span class="s3">if </span><span class="s1">isexternal(var):</span>
        <span class="s1">ret[</span><span class="s4">'cbnamekey'</span><span class="s1">] = a</span>
        <span class="s3">if </span><span class="s1">a </span><span class="s3">in </span><span class="s1">lcb_map:</span>
            <span class="s1">ret[</span><span class="s4">'cbname'</span><span class="s1">] = lcb_map[a]</span>
            <span class="s1">ret[</span><span class="s4">'maxnofargs'</span><span class="s1">] = lcb2_map[lcb_map[a]][</span><span class="s4">'maxnofargs'</span><span class="s1">]</span>
            <span class="s1">ret[</span><span class="s4">'nofoptargs'</span><span class="s1">] = lcb2_map[lcb_map[a]][</span><span class="s4">'nofoptargs'</span><span class="s1">]</span>
            <span class="s1">ret[</span><span class="s4">'cbdocstr'</span><span class="s1">] = lcb2_map[lcb_map[a]][</span><span class="s4">'docstr'</span><span class="s1">]</span>
            <span class="s1">ret[</span><span class="s4">'cblatexdocstr'</span><span class="s1">] = lcb2_map[lcb_map[a]][</span><span class="s4">'latexdocstr'</span><span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">ret[</span><span class="s4">'cbname'</span><span class="s1">] = a</span>
            <span class="s1">errmess(</span><span class="s4">'sign2map: Confused: external %s is not in lcb_map%s.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">list(lcb_map.keys())))</span>
    <span class="s3">if </span><span class="s1">isstring(var):</span>
        <span class="s1">ret[</span><span class="s4">'length'</span><span class="s1">] = getstrlength(var)</span>
    <span class="s3">if </span><span class="s1">isarray(var):</span>
        <span class="s1">ret = dictappend(ret</span><span class="s3">, </span><span class="s1">getarrdims(a</span><span class="s3">, </span><span class="s1">var))</span>
        <span class="s1">dim = copy.copy(var[</span><span class="s4">'dimension'</span><span class="s1">])</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">c2capi_map:</span>
        <span class="s1">ret[</span><span class="s4">'atype'</span><span class="s1">] = c2capi_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]]</span>
    <span class="s0"># Debug info</span>
    <span class="s3">if </span><span class="s1">debugcapi(var):</span>
        <span class="s1">il = [isintent_in</span><span class="s3">, </span><span class="s4">'input'</span><span class="s3">, </span><span class="s1">isintent_out</span><span class="s3">, </span><span class="s4">'output'</span><span class="s3">,</span>
              <span class="s1">isintent_inout</span><span class="s3">, </span><span class="s4">'inoutput'</span><span class="s3">, </span><span class="s1">isrequired</span><span class="s3">, </span><span class="s4">'required'</span><span class="s3">,</span>
              <span class="s1">isoptional</span><span class="s3">, </span><span class="s4">'optional'</span><span class="s3">, </span><span class="s1">isintent_hide</span><span class="s3">, </span><span class="s4">'hidden'</span><span class="s3">,</span>
              <span class="s1">iscomplex</span><span class="s3">, </span><span class="s4">'complex scalar'</span><span class="s3">,</span>
              <span class="s1">l_and(isscalar</span><span class="s3">, </span><span class="s1">l_not(iscomplex))</span><span class="s3">, </span><span class="s4">'scalar'</span><span class="s3">,</span>
              <span class="s1">isstring</span><span class="s3">, </span><span class="s4">'string'</span><span class="s3">, </span><span class="s1">isarray</span><span class="s3">, </span><span class="s4">'array'</span><span class="s3">,</span>
              <span class="s1">iscomplexarray</span><span class="s3">, </span><span class="s4">'complex array'</span><span class="s3">, </span><span class="s1">isstringarray</span><span class="s3">, </span><span class="s4">'string array'</span><span class="s3">,</span>
              <span class="s1">iscomplexfunction</span><span class="s3">, </span><span class="s4">'complex function'</span><span class="s3">,</span>
              <span class="s1">l_and(isfunction</span><span class="s3">, </span><span class="s1">l_not(iscomplexfunction))</span><span class="s3">, </span><span class="s4">'function'</span><span class="s3">,</span>
              <span class="s1">isexternal</span><span class="s3">, </span><span class="s4">'callback'</span><span class="s3">,</span>
              <span class="s1">isintent_callback</span><span class="s3">, </span><span class="s4">'callback'</span><span class="s3">,</span>
              <span class="s1">isintent_aux</span><span class="s3">, </span><span class="s4">'auxiliary'</span><span class="s3">,</span>
              <span class="s1">]</span>
        <span class="s1">rl = []</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">len(il)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">):</span>
            <span class="s3">if </span><span class="s1">il[i](var):</span>
                <span class="s1">rl.append(il[i + </span><span class="s5">1</span><span class="s1">])</span>
        <span class="s3">if </span><span class="s1">isstring(var):</span>
            <span class="s1">rl.append(</span><span class="s4">'slen(%s)=%s' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'length'</span><span class="s1">]))</span>
        <span class="s3">if </span><span class="s1">isarray(var):</span>
            <span class="s1">ddim = </span><span class="s4">','</span><span class="s1">.join(</span>
                <span class="s1">map(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y: </span><span class="s4">'%s|%s' </span><span class="s1">% (x</span><span class="s3">, </span><span class="s1">y)</span><span class="s3">, </span><span class="s1">var[</span><span class="s4">'dimension'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">dim))</span>
            <span class="s1">rl.append(</span><span class="s4">'dims(%s)' </span><span class="s1">% ddim)</span>
        <span class="s3">if </span><span class="s1">isexternal(var):</span>
            <span class="s1">ret[</span><span class="s4">'vardebuginfo'</span><span class="s1">] = </span><span class="s4">'debug-capi:%s=&gt;%s:%s' </span><span class="s1">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'cbname'</span><span class="s1">]</span><span class="s3">, </span><span class="s4">','</span><span class="s1">.join(rl))</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">ret[</span><span class="s4">'vardebuginfo'</span><span class="s1">] = </span><span class="s4">'debug-capi:%s %s=%s:%s' </span><span class="s1">% (</span>
                <span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'showinit'</span><span class="s1">]</span><span class="s3">, </span><span class="s4">','</span><span class="s1">.join(rl))</span>
        <span class="s3">if </span><span class="s1">isscalar(var):</span>
            <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">cformat_map:</span>
                <span class="s1">ret[</span><span class="s4">'vardebugshowvalue'</span><span class="s1">] = </span><span class="s4">'debug-capi:%s=%s' </span><span class="s1">% (</span>
                    <span class="s1">a</span><span class="s3">, </span><span class="s1">cformat_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]])</span>
        <span class="s3">if </span><span class="s1">isstring(var):</span>
            <span class="s1">ret[</span><span class="s4">'vardebugshowvalue'</span><span class="s1">] = </span><span class="s4">'debug-capi:slen(%s)=%%d %s=</span><span class="s3">\\</span><span class="s4">&quot;%%s</span><span class="s3">\\</span><span class="s4">&quot;' </span><span class="s1">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">a)</span>
        <span class="s3">if </span><span class="s1">isexternal(var):</span>
            <span class="s1">ret[</span><span class="s4">'vardebugshowvalue'</span><span class="s1">] = </span><span class="s4">'debug-capi:%s=%%p' </span><span class="s1">% (a)</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">cformat_map:</span>
        <span class="s1">ret[</span><span class="s4">'varshowvalue'</span><span class="s1">] = </span><span class="s4">'#name#:%s=%s' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">cformat_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]])</span>
        <span class="s1">ret[</span><span class="s4">'showvalueformat'</span><span class="s1">] = </span><span class="s4">'%s' </span><span class="s1">% (cformat_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]])</span>
    <span class="s3">if </span><span class="s1">isstring(var):</span>
        <span class="s1">ret[</span><span class="s4">'varshowvalue'</span><span class="s1">] = </span><span class="s4">'#name#:slen(%s)=%%d %s=</span><span class="s3">\\</span><span class="s4">&quot;%%s</span><span class="s3">\\</span><span class="s4">&quot;' </span><span class="s1">% (a</span><span class="s3">, </span><span class="s1">a)</span>
    <span class="s1">ret[</span><span class="s4">'pydocsign'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'pydocsignout'</span><span class="s1">] = getpydocsign(a</span><span class="s3">, </span><span class="s1">var)</span>
    <span class="s3">if </span><span class="s1">hasnote(var):</span>
        <span class="s1">ret[</span><span class="s4">'note'</span><span class="s1">] = var[</span><span class="s4">'note'</span><span class="s1">]</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">routsign2map(rout):</span>
    <span class="s2">&quot;&quot;&quot; 
    name,NAME,begintitle,endtitle 
    rname,ctype,rformat 
    routdebugshowvalue 
    &quot;&quot;&quot;</span>
    <span class="s3">global </span><span class="s1">lcb_map</span>
    <span class="s1">name = rout[</span><span class="s4">'name'</span><span class="s1">]</span>
    <span class="s1">fname = getfortranname(rout)</span>
    <span class="s1">ret = {</span><span class="s4">'name'</span><span class="s1">: name</span><span class="s3">,</span>
           <span class="s4">'texname'</span><span class="s1">: name.replace(</span><span class="s4">'_'</span><span class="s3">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">_'</span><span class="s1">)</span><span class="s3">,</span>
           <span class="s4">'name_lower'</span><span class="s1">: name.lower()</span><span class="s3">,</span>
           <span class="s4">'NAME'</span><span class="s1">: name.upper()</span><span class="s3">,</span>
           <span class="s4">'begintitle'</span><span class="s1">: gentitle(name)</span><span class="s3">,</span>
           <span class="s4">'endtitle'</span><span class="s1">: gentitle(</span><span class="s4">'end of %s' </span><span class="s1">% name)</span><span class="s3">,</span>
           <span class="s4">'fortranname'</span><span class="s1">: fname</span><span class="s3">,</span>
           <span class="s4">'FORTRANNAME'</span><span class="s1">: fname.upper()</span><span class="s3">,</span>
           <span class="s4">'callstatement'</span><span class="s1">: getcallstatement(rout) </span><span class="s3">or </span><span class="s4">''</span><span class="s3">,</span>
           <span class="s4">'usercode'</span><span class="s1">: getusercode(rout) </span><span class="s3">or </span><span class="s4">''</span><span class="s3">,</span>
           <span class="s4">'usercode1'</span><span class="s1">: getusercode1(rout) </span><span class="s3">or </span><span class="s4">''</span><span class="s3">,</span>
           <span class="s1">}</span>
    <span class="s3">if </span><span class="s4">'_' </span><span class="s3">in </span><span class="s1">fname:</span>
        <span class="s1">ret[</span><span class="s4">'F_FUNC'</span><span class="s1">] = </span><span class="s4">'F_FUNC_US'</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'F_FUNC'</span><span class="s1">] = </span><span class="s4">'F_FUNC'</span>
    <span class="s3">if </span><span class="s4">'_' </span><span class="s3">in </span><span class="s1">name:</span>
        <span class="s1">ret[</span><span class="s4">'F_WRAPPEDFUNC'</span><span class="s1">] = </span><span class="s4">'F_WRAPPEDFUNC_US'</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'F_WRAPPEDFUNC'</span><span class="s1">] = </span><span class="s4">'F_WRAPPEDFUNC'</span>
    <span class="s1">lcb_map = {}</span>
    <span class="s3">if </span><span class="s4">'use' </span><span class="s3">in </span><span class="s1">rout:</span>
        <span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">rout[</span><span class="s4">'use'</span><span class="s1">].keys():</span>
            <span class="s3">if </span><span class="s1">u </span><span class="s3">in </span><span class="s1">cb_rules.cb_map:</span>
                <span class="s3">for </span><span class="s1">un </span><span class="s3">in </span><span class="s1">cb_rules.cb_map[u]:</span>
                    <span class="s1">ln = un[</span><span class="s5">0</span><span class="s1">]</span>
                    <span class="s3">if </span><span class="s4">'map' </span><span class="s3">in </span><span class="s1">rout[</span><span class="s4">'use'</span><span class="s1">][u]:</span>
                        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">rout[</span><span class="s4">'use'</span><span class="s1">][u][</span><span class="s4">'map'</span><span class="s1">].keys():</span>
                            <span class="s3">if </span><span class="s1">rout[</span><span class="s4">'use'</span><span class="s1">][u][</span><span class="s4">'map'</span><span class="s1">][k] == un[</span><span class="s5">0</span><span class="s1">]:</span>
                                <span class="s1">ln = k</span>
                                <span class="s3">break</span>
                    <span class="s1">lcb_map[ln] = un[</span><span class="s5">1</span><span class="s1">]</span>
    <span class="s3">elif </span><span class="s4">'externals' </span><span class="s3">in </span><span class="s1">rout </span><span class="s3">and </span><span class="s1">rout[</span><span class="s4">'externals'</span><span class="s1">]:</span>
        <span class="s1">errmess(</span><span class="s4">'routsign2map: Confused: function %s has externals %s but no &quot;use&quot; statement.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (</span>
            <span class="s1">ret[</span><span class="s4">'name'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">repr(rout[</span><span class="s4">'externals'</span><span class="s1">])))</span>
    <span class="s1">ret[</span><span class="s4">'callprotoargument'</span><span class="s1">] = getcallprotoargument(rout</span><span class="s3">, </span><span class="s1">lcb_map) </span><span class="s3">or </span><span class="s4">''</span>
    <span class="s3">if </span><span class="s1">isfunction(rout):</span>
        <span class="s3">if </span><span class="s4">'result' </span><span class="s3">in </span><span class="s1">rout:</span>
            <span class="s1">a = rout[</span><span class="s4">'result'</span><span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">a = rout[</span><span class="s4">'name'</span><span class="s1">]</span>
        <span class="s1">ret[</span><span class="s4">'rname'</span><span class="s1">] = a</span>
        <span class="s1">ret[</span><span class="s4">'pydocsign'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'pydocsignout'</span><span class="s1">] = getpydocsign(a</span><span class="s3">, </span><span class="s1">rout)</span>
        <span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] = getctype(rout[</span><span class="s4">'vars'</span><span class="s1">][a])</span>
        <span class="s3">if </span><span class="s1">hasresultnote(rout):</span>
            <span class="s1">ret[</span><span class="s4">'resultnote'</span><span class="s1">] = rout[</span><span class="s4">'vars'</span><span class="s1">][a][</span><span class="s4">'note'</span><span class="s1">]</span>
            <span class="s1">rout[</span><span class="s4">'vars'</span><span class="s1">][a][</span><span class="s4">'note'</span><span class="s1">] = [</span><span class="s4">'See elsewhere.'</span><span class="s1">]</span>
        <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">c2buildvalue_map:</span>
            <span class="s1">ret[</span><span class="s4">'rformat'</span><span class="s1">] = c2buildvalue_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">ret[</span><span class="s4">'rformat'</span><span class="s1">] = </span><span class="s4">'O'</span>
            <span class="s1">errmess(</span><span class="s4">'routsign2map: no c2buildvalue key for type %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">%</span>
                    <span class="s1">(repr(ret[</span><span class="s4">'ctype'</span><span class="s1">])))</span>
        <span class="s3">if </span><span class="s1">debugcapi(rout):</span>
            <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">cformat_map:</span>
                <span class="s1">ret[</span><span class="s4">'routdebugshowvalue'</span><span class="s1">] = </span><span class="s4">'debug-capi:%s=%s' </span><span class="s1">% (</span>
                    <span class="s1">a</span><span class="s3">, </span><span class="s1">cformat_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]])</span>
            <span class="s3">if </span><span class="s1">isstringfunction(rout):</span>
                <span class="s1">ret[</span><span class="s4">'routdebugshowvalue'</span><span class="s1">] = </span><span class="s4">'debug-capi:slen(%s)=%%d %s=</span><span class="s3">\\</span><span class="s4">&quot;%%s</span><span class="s3">\\</span><span class="s4">&quot;' </span><span class="s1">% (</span>
                    <span class="s1">a</span><span class="s3">, </span><span class="s1">a)</span>
        <span class="s3">if </span><span class="s1">isstringfunction(rout):</span>
            <span class="s1">ret[</span><span class="s4">'rlength'</span><span class="s1">] = getstrlength(rout[</span><span class="s4">'vars'</span><span class="s1">][a])</span>
            <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'rlength'</span><span class="s1">] == </span><span class="s4">'-1'</span><span class="s1">:</span>
                <span class="s1">errmess(</span><span class="s4">'routsign2map: expected explicit specification of the length of the string returned by the fortran function %s; taking 10.</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (</span>
                    <span class="s1">repr(rout[</span><span class="s4">'name'</span><span class="s1">])))</span>
                <span class="s1">ret[</span><span class="s4">'rlength'</span><span class="s1">] = </span><span class="s4">'10'</span>
    <span class="s3">if </span><span class="s1">hasnote(rout):</span>
        <span class="s1">ret[</span><span class="s4">'note'</span><span class="s1">] = rout[</span><span class="s4">'note'</span><span class="s1">]</span>
        <span class="s1">rout[</span><span class="s4">'note'</span><span class="s1">] = [</span><span class="s4">'See elsewhere.'</span><span class="s1">]</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">modsign2map(m):</span>
    <span class="s2">&quot;&quot;&quot; 
    modulename 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">ismodule(m):</span>
        <span class="s1">ret = {</span><span class="s4">'f90modulename'</span><span class="s1">: m[</span><span class="s4">'name'</span><span class="s1">]</span><span class="s3">,</span>
               <span class="s4">'F90MODULENAME'</span><span class="s1">: m[</span><span class="s4">'name'</span><span class="s1">].upper()</span><span class="s3">,</span>
               <span class="s4">'texf90modulename'</span><span class="s1">: m[</span><span class="s4">'name'</span><span class="s1">].replace(</span><span class="s4">'_'</span><span class="s3">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">_'</span><span class="s1">)}</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret = {</span><span class="s4">'modulename'</span><span class="s1">: m[</span><span class="s4">'name'</span><span class="s1">]</span><span class="s3">,</span>
               <span class="s4">'MODULENAME'</span><span class="s1">: m[</span><span class="s4">'name'</span><span class="s1">].upper()</span><span class="s3">,</span>
               <span class="s4">'texmodulename'</span><span class="s1">: m[</span><span class="s4">'name'</span><span class="s1">].replace(</span><span class="s4">'_'</span><span class="s3">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">_'</span><span class="s1">)}</span>
    <span class="s1">ret[</span><span class="s4">'restdoc'</span><span class="s1">] = getrestdoc(m) </span><span class="s3">or </span><span class="s1">[]</span>
    <span class="s3">if </span><span class="s1">hasnote(m):</span>
        <span class="s1">ret[</span><span class="s4">'note'</span><span class="s1">] = m[</span><span class="s4">'note'</span><span class="s1">]</span>
    <span class="s1">ret[</span><span class="s4">'usercode'</span><span class="s1">] = getusercode(m) </span><span class="s3">or </span><span class="s4">''</span>
    <span class="s1">ret[</span><span class="s4">'usercode1'</span><span class="s1">] = getusercode1(m) </span><span class="s3">or </span><span class="s4">''</span>
    <span class="s3">if </span><span class="s1">m[</span><span class="s4">'body'</span><span class="s1">]:</span>
        <span class="s1">ret[</span><span class="s4">'interface_usercode'</span><span class="s1">] = getusercode(m[</span><span class="s4">'body'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]) </span><span class="s3">or </span><span class="s4">''</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'interface_usercode'</span><span class="s1">] = </span><span class="s4">''</span>
    <span class="s1">ret[</span><span class="s4">'pymethoddef'</span><span class="s1">] = getpymethoddef(m) </span><span class="s3">or </span><span class="s4">''</span>
    <span class="s3">if </span><span class="s4">'coutput' </span><span class="s3">in </span><span class="s1">m:</span>
        <span class="s1">ret[</span><span class="s4">'coutput'</span><span class="s1">] = m[</span><span class="s4">'coutput'</span><span class="s1">]</span>
    <span class="s3">if </span><span class="s4">'f2py_wrapper_output' </span><span class="s3">in </span><span class="s1">m:</span>
        <span class="s1">ret[</span><span class="s4">'f2py_wrapper_output'</span><span class="s1">] = m[</span><span class="s4">'f2py_wrapper_output'</span><span class="s1">]</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">cb_sign2map(a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">, </span><span class="s1">index=</span><span class="s3">None</span><span class="s1">):</span>
    <span class="s1">ret = {</span><span class="s4">'varname'</span><span class="s1">: a}</span>
    <span class="s1">ret[</span><span class="s4">'varname_i'</span><span class="s1">] = ret[</span><span class="s4">'varname'</span><span class="s1">]</span>
    <span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] = getctype(var)</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">c2capi_map:</span>
        <span class="s1">ret[</span><span class="s4">'atype'</span><span class="s1">] = c2capi_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]]</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">cformat_map:</span>
        <span class="s1">ret[</span><span class="s4">'showvalueformat'</span><span class="s1">] = </span><span class="s4">'%s' </span><span class="s1">% (cformat_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]])</span>
    <span class="s3">if </span><span class="s1">isarray(var):</span>
        <span class="s1">ret = dictappend(ret</span><span class="s3">, </span><span class="s1">getarrdims(a</span><span class="s3">, </span><span class="s1">var))</span>
    <span class="s1">ret[</span><span class="s4">'pydocsign'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'pydocsignout'</span><span class="s1">] = getpydocsign(a</span><span class="s3">, </span><span class="s1">var)</span>
    <span class="s3">if </span><span class="s1">hasnote(var):</span>
        <span class="s1">ret[</span><span class="s4">'note'</span><span class="s1">] = var[</span><span class="s4">'note'</span><span class="s1">]</span>
        <span class="s1">var[</span><span class="s4">'note'</span><span class="s1">] = [</span><span class="s4">'See elsewhere.'</span><span class="s1">]</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">cb_routsign2map(rout</span><span class="s3">, </span><span class="s1">um):</span>
    <span class="s2">&quot;&quot;&quot; 
    name,begintitle,endtitle,argname 
    ctype,rctype,maxnofargs,nofoptargs,returncptr 
    &quot;&quot;&quot;</span>
    <span class="s1">ret = {</span><span class="s4">'name'</span><span class="s1">: </span><span class="s4">'cb_%s_in_%s' </span><span class="s1">% (rout[</span><span class="s4">'name'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">um)</span><span class="s3">,</span>
           <span class="s4">'returncptr'</span><span class="s1">: </span><span class="s4">''</span><span class="s1">}</span>
    <span class="s3">if </span><span class="s1">isintent_callback(rout):</span>
        <span class="s3">if </span><span class="s4">'_' </span><span class="s3">in </span><span class="s1">rout[</span><span class="s4">'name'</span><span class="s1">]:</span>
            <span class="s1">F_FUNC = </span><span class="s4">'F_FUNC_US'</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">F_FUNC = </span><span class="s4">'F_FUNC'</span>
        <span class="s1">ret[</span><span class="s4">'callbackname'</span><span class="s1">] = </span><span class="s4">'%s(%s,%s)' </span><span class="s1">\</span>
                              <span class="s1">% (F_FUNC</span><span class="s3">,</span>
                                 <span class="s1">rout[</span><span class="s4">'name'</span><span class="s1">].lower()</span><span class="s3">,</span>
                                 <span class="s1">rout[</span><span class="s4">'name'</span><span class="s1">].upper()</span><span class="s3">,</span>
                                 <span class="s1">)</span>
        <span class="s1">ret[</span><span class="s4">'static'</span><span class="s1">] = </span><span class="s4">'extern'</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'callbackname'</span><span class="s1">] = ret[</span><span class="s4">'name'</span><span class="s1">]</span>
        <span class="s1">ret[</span><span class="s4">'static'</span><span class="s1">] = </span><span class="s4">'static'</span>
    <span class="s1">ret[</span><span class="s4">'argname'</span><span class="s1">] = rout[</span><span class="s4">'name'</span><span class="s1">]</span>
    <span class="s1">ret[</span><span class="s4">'begintitle'</span><span class="s1">] = gentitle(ret[</span><span class="s4">'name'</span><span class="s1">])</span>
    <span class="s1">ret[</span><span class="s4">'endtitle'</span><span class="s1">] = gentitle(</span><span class="s4">'end of %s' </span><span class="s1">% ret[</span><span class="s4">'name'</span><span class="s1">])</span>
    <span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] = getctype(rout)</span>
    <span class="s1">ret[</span><span class="s4">'rctype'</span><span class="s1">] = </span><span class="s4">'void'</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] == </span><span class="s4">'string'</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'rctype'</span><span class="s1">] = </span><span class="s4">'void'</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">ret[</span><span class="s4">'rctype'</span><span class="s1">] = ret[</span><span class="s4">'ctype'</span><span class="s1">]</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'rctype'</span><span class="s1">] != </span><span class="s4">'void'</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">iscomplexfunction(rout):</span>
            <span class="s1">ret[</span><span class="s4">'returncptr'</span><span class="s1">] = </span><span class="s4">&quot;&quot;&quot; 
#ifdef F2PY_CB_RETURNCOMPLEX 
return_value= 
#endif 
&quot;&quot;&quot;</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">ret[</span><span class="s4">'returncptr'</span><span class="s1">] = </span><span class="s4">'return_value='</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">cformat_map:</span>
        <span class="s1">ret[</span><span class="s4">'showvalueformat'</span><span class="s1">] = </span><span class="s4">'%s' </span><span class="s1">% (cformat_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]])</span>
    <span class="s3">if </span><span class="s1">isstringfunction(rout):</span>
        <span class="s1">ret[</span><span class="s4">'strlength'</span><span class="s1">] = getstrlength(rout)</span>
    <span class="s3">if </span><span class="s1">isfunction(rout):</span>
        <span class="s3">if </span><span class="s4">'result' </span><span class="s3">in </span><span class="s1">rout:</span>
            <span class="s1">a = rout[</span><span class="s4">'result'</span><span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">a = rout[</span><span class="s4">'name'</span><span class="s1">]</span>
        <span class="s3">if </span><span class="s1">hasnote(rout[</span><span class="s4">'vars'</span><span class="s1">][a]):</span>
            <span class="s1">ret[</span><span class="s4">'note'</span><span class="s1">] = rout[</span><span class="s4">'vars'</span><span class="s1">][a][</span><span class="s4">'note'</span><span class="s1">]</span>
            <span class="s1">rout[</span><span class="s4">'vars'</span><span class="s1">][a][</span><span class="s4">'note'</span><span class="s1">] = [</span><span class="s4">'See elsewhere.'</span><span class="s1">]</span>
        <span class="s1">ret[</span><span class="s4">'rname'</span><span class="s1">] = a</span>
        <span class="s1">ret[</span><span class="s4">'pydocsign'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'pydocsignout'</span><span class="s1">] = getpydocsign(a</span><span class="s3">, </span><span class="s1">rout)</span>
        <span class="s3">if </span><span class="s1">iscomplexfunction(rout):</span>
            <span class="s1">ret[</span><span class="s4">'rctype'</span><span class="s1">] = </span><span class="s4">&quot;&quot;&quot; 
#ifdef F2PY_CB_RETURNCOMPLEX 
#ctype# 
#else 
void 
#endif 
&quot;&quot;&quot;</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">hasnote(rout):</span>
            <span class="s1">ret[</span><span class="s4">'note'</span><span class="s1">] = rout[</span><span class="s4">'note'</span><span class="s1">]</span>
            <span class="s1">rout[</span><span class="s4">'note'</span><span class="s1">] = [</span><span class="s4">'See elsewhere.'</span><span class="s1">]</span>
    <span class="s1">nofargs = </span><span class="s5">0</span>
    <span class="s1">nofoptargs = </span><span class="s5">0</span>
    <span class="s3">if </span><span class="s4">'args' </span><span class="s3">in </span><span class="s1">rout </span><span class="s3">and </span><span class="s4">'vars' </span><span class="s3">in </span><span class="s1">rout:</span>
        <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">rout[</span><span class="s4">'args'</span><span class="s1">]:</span>
            <span class="s1">var = rout[</span><span class="s4">'vars'</span><span class="s1">][a]</span>
            <span class="s3">if </span><span class="s1">l_or(isintent_in</span><span class="s3">, </span><span class="s1">isintent_inout)(var):</span>
                <span class="s1">nofargs = nofargs + </span><span class="s5">1</span>
                <span class="s3">if </span><span class="s1">isoptional(var):</span>
                    <span class="s1">nofoptargs = nofoptargs + </span><span class="s5">1</span>
    <span class="s1">ret[</span><span class="s4">'maxnofargs'</span><span class="s1">] = repr(nofargs)</span>
    <span class="s1">ret[</span><span class="s4">'nofoptargs'</span><span class="s1">] = repr(nofoptargs)</span>
    <span class="s3">if </span><span class="s1">hasnote(rout) </span><span class="s3">and </span><span class="s1">isfunction(rout) </span><span class="s3">and </span><span class="s4">'result' </span><span class="s3">in </span><span class="s1">rout:</span>
        <span class="s1">ret[</span><span class="s4">'routnote'</span><span class="s1">] = rout[</span><span class="s4">'note'</span><span class="s1">]</span>
        <span class="s1">rout[</span><span class="s4">'note'</span><span class="s1">] = [</span><span class="s4">'See elsewhere.'</span><span class="s1">]</span>
    <span class="s3">return </span><span class="s1">ret</span>


<span class="s3">def </span><span class="s1">common_sign2map(a</span><span class="s3">, </span><span class="s1">var):  </span><span class="s0"># obsolute</span>
    <span class="s1">ret = {</span><span class="s4">'varname'</span><span class="s1">: a</span><span class="s3">, </span><span class="s4">'ctype'</span><span class="s1">: getctype(var)}</span>
    <span class="s3">if </span><span class="s1">isstringarray(var):</span>
        <span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] = </span><span class="s4">'char'</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">c2capi_map:</span>
        <span class="s1">ret[</span><span class="s4">'atype'</span><span class="s1">] = c2capi_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]]</span>
    <span class="s3">if </span><span class="s1">ret[</span><span class="s4">'ctype'</span><span class="s1">] </span><span class="s3">in </span><span class="s1">cformat_map:</span>
        <span class="s1">ret[</span><span class="s4">'showvalueformat'</span><span class="s1">] = </span><span class="s4">'%s' </span><span class="s1">% (cformat_map[ret[</span><span class="s4">'ctype'</span><span class="s1">]])</span>
    <span class="s3">if </span><span class="s1">isarray(var):</span>
        <span class="s1">ret = dictappend(ret</span><span class="s3">, </span><span class="s1">getarrdims(a</span><span class="s3">, </span><span class="s1">var))</span>
    <span class="s3">elif </span><span class="s1">isstring(var):</span>
        <span class="s1">ret[</span><span class="s4">'size'</span><span class="s1">] = getstrlength(var)</span>
        <span class="s1">ret[</span><span class="s4">'rank'</span><span class="s1">] = </span><span class="s4">'1'</span>
    <span class="s1">ret[</span><span class="s4">'pydocsign'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ret[</span><span class="s4">'pydocsignout'</span><span class="s1">] = getpydocsign(a</span><span class="s3">, </span><span class="s1">var)</span>
    <span class="s3">if </span><span class="s1">hasnote(var):</span>
        <span class="s1">ret[</span><span class="s4">'note'</span><span class="s1">] = var[</span><span class="s4">'note'</span><span class="s1">]</span>
        <span class="s1">var[</span><span class="s4">'note'</span><span class="s1">] = [</span><span class="s4">'See elsewhere.'</span><span class="s1">]</span>
    <span class="s0"># for strings this returns 0-rank but actually is 1-rank</span>
    <span class="s1">ret[</span><span class="s4">'arrdocstr'</span><span class="s1">] = getarrdocsign(a</span><span class="s3">, </span><span class="s1">var)</span>
    <span class="s3">return </span><span class="s1">ret</span>
</pre>
</body>
</html>