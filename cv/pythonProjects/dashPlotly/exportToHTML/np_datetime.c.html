<html>
<head>
<title>np_datetime.c</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #0f9795;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
np_datetime.c</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 
Copyright (c) 2016, PyData Development Team 
All rights reserved. 
 
Distributed under the terms of the BSD Simplified License. 
 
The full license is in the LICENSE file, distributed with this software. 
 
Copyright (c) 2005-2011, NumPy Developers 
All rights reserved. 
 
This file is derived from NumPy 1.7. See NUMPY_LICENSE.txt 
 
*/</span>

<span class="s2">#define </span><span class="s1">NO_IMPORT</span>

<span class="s2">#ifndef </span><span class="s1">NPY_NO_DEPRECATED_API</span>
<span class="s2">#define </span><span class="s1">NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION</span>
<span class="s2">#endif  </span><span class="s0">// NPY_NO_DEPRECATED_API</span>

<span class="s2">#include </span><span class="s1">&lt;Python.h&gt;</span>

<span class="s2">#include </span><span class="s1">&lt;numpy/arrayobject.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;numpy/arrayscalars.h&gt;</span>
<span class="s2">#include </span><span class="s1">&lt;numpy/ndarraytypes.h&gt;</span>
<span class="s2">#include </span><span class="s3">&quot;np_datetime.h&quot;</span>

<span class="s2">#if </span><span class="s1">PY_MAJOR_VERSION &gt;= </span><span class="s4">3</span>
<span class="s2">#define </span><span class="s1">PyInt_AsLong PyLong_AsLong</span>
<span class="s2">#endif  </span><span class="s0">// PyInt_AsLong</span>

<span class="s2">const </span><span class="s1">npy_datetimestruct _NS_MIN_DTS = {</span>
    <span class="s4">1677</span><span class="s1">, </span><span class="s4">9</span><span class="s1">, </span><span class="s4">21</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">12</span><span class="s1">, </span><span class="s4">43</span><span class="s1">, </span><span class="s4">145224</span><span class="s1">, </span><span class="s4">193000</span><span class="s1">, </span><span class="s4">0</span><span class="s1">};</span>
<span class="s2">const </span><span class="s1">npy_datetimestruct _NS_MAX_DTS = {</span>
    <span class="s4">2262</span><span class="s1">, </span><span class="s4">4</span><span class="s1">, </span><span class="s4">11</span><span class="s1">, </span><span class="s4">23</span><span class="s1">, </span><span class="s4">47</span><span class="s1">, </span><span class="s4">16</span><span class="s1">, </span><span class="s4">854775</span><span class="s1">, </span><span class="s4">807000</span><span class="s1">, </span><span class="s4">0</span><span class="s1">};</span>


<span class="s2">const int </span><span class="s1">days_per_month_table[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">12</span><span class="s1">] = {</span>
    <span class="s1">{</span><span class="s4">31</span><span class="s1">, </span><span class="s4">28</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">},</span>
    <span class="s1">{</span><span class="s4">31</span><span class="s1">, </span><span class="s4">29</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">31</span><span class="s1">}};</span>

<span class="s0">/* 
 * Returns 1 if the given year is a leap year, 0 otherwise. 
 */</span>
<span class="s2">int </span><span class="s1">is_leapyear(npy_int64 year) {</span>
    <span class="s2">return </span><span class="s1">(year &amp; </span><span class="s4">0x3</span><span class="s1">) == </span><span class="s4">0 </span><span class="s1">&amp;&amp; </span><span class="s0">/* year % 4 == 0 */</span>
           <span class="s1">((year % </span><span class="s4">100</span><span class="s1">) != </span><span class="s4">0 </span><span class="s1">|| (year % </span><span class="s4">400</span><span class="s1">) == </span><span class="s4">0</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Adjusts a datetimestruct based on a minutes offset. Assumes 
 * the current values are valid.g 
 */</span>
<span class="s2">void </span><span class="s1">add_minutes_to_datetimestruct(npy_datetimestruct *dts, </span><span class="s2">int </span><span class="s1">minutes) {</span>
    <span class="s2">int </span><span class="s1">isleap;</span>

    <span class="s0">/* MINUTES */</span>
    <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">min += minutes;</span>
    <span class="s2">while </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">min &lt; </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">min += </span><span class="s4">60</span><span class="s1">;</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">hour--;</span>
    <span class="s1">}</span>
    <span class="s2">while </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">min &gt;= </span><span class="s4">60</span><span class="s1">) {</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">min -= </span><span class="s4">60</span><span class="s1">;</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">hour++;</span>
    <span class="s1">}</span>

    <span class="s0">/* HOURS */</span>
    <span class="s2">while </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">hour &lt; </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">hour += </span><span class="s4">24</span><span class="s1">;</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">day--;</span>
    <span class="s1">}</span>
    <span class="s2">while </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">hour &gt;= </span><span class="s4">24</span><span class="s1">) {</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">hour -= </span><span class="s4">24</span><span class="s1">;</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">day++;</span>
    <span class="s1">}</span>

    <span class="s0">/* DAYS */</span>
    <span class="s2">if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">day &lt; </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">month--;</span>
        <span class="s2">if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">month &lt; </span><span class="s4">1</span><span class="s1">) {</span>
            <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">year--;</span>
            <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">month = </span><span class="s4">12</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s1">isleap = is_leapyear(dts</span><span class="s5">-&gt;</span><span class="s1">year);</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">day += days_per_month_table[isleap][dts</span><span class="s5">-&gt;</span><span class="s1">month - </span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">day &gt; </span><span class="s4">28</span><span class="s1">) {</span>
        <span class="s1">isleap = is_leapyear(dts</span><span class="s5">-&gt;</span><span class="s1">year);</span>
        <span class="s2">if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">day &gt; days_per_month_table[isleap][dts</span><span class="s5">-&gt;</span><span class="s1">month - </span><span class="s4">1</span><span class="s1">]) {</span>
            <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">day -= days_per_month_table[isleap][dts</span><span class="s5">-&gt;</span><span class="s1">month - </span><span class="s4">1</span><span class="s1">];</span>
            <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">month++;</span>
            <span class="s2">if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">month &gt; </span><span class="s4">12</span><span class="s1">) {</span>
                <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">year++;</span>
                <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">month = </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Calculates the days offset from the 1970 epoch. 
 */</span>
<span class="s1">npy_int64 get_datetimestruct_days(</span><span class="s2">const </span><span class="s1">npy_datetimestruct *dts) {</span>
    <span class="s2">int </span><span class="s1">i, month;</span>
    <span class="s1">npy_int64 year, days = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s2">const int </span><span class="s1">*month_lengths;</span>

    <span class="s1">year = dts</span><span class="s5">-&gt;</span><span class="s1">year - </span><span class="s4">1970</span><span class="s1">;</span>
    <span class="s1">days = year * </span><span class="s4">365</span><span class="s1">;</span>

    <span class="s0">/* Adjust for leap years */</span>
    <span class="s2">if </span><span class="s1">(days &gt;= </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s0">/* 
         * 1968 is the closest leap year before 1970. 
         * Exclude the current year, so add 1. 
         */</span>
        <span class="s1">year += </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s0">/* Add one day for each 4 years */</span>
        <span class="s1">days += year / </span><span class="s4">4</span><span class="s1">;</span>
        <span class="s0">/* 1900 is the closest previous year divisible by 100 */</span>
        <span class="s1">year += </span><span class="s4">68</span><span class="s1">;</span>
        <span class="s0">/* Subtract one day for each 100 years */</span>
        <span class="s1">days -= year / </span><span class="s4">100</span><span class="s1">;</span>
        <span class="s0">/* 1600 is the closest previous year divisible by 400 */</span>
        <span class="s1">year += </span><span class="s4">300</span><span class="s1">;</span>
        <span class="s0">/* Add one day for each 400 years */</span>
        <span class="s1">days += year / </span><span class="s4">400</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s0">/* 
         * 1972 is the closest later year after 1970. 
         * Include the current year, so subtract 2. 
         */</span>
        <span class="s1">year -= </span><span class="s4">2</span><span class="s1">;</span>
        <span class="s0">/* Subtract one day for each 4 years */</span>
        <span class="s1">days += year / </span><span class="s4">4</span><span class="s1">;</span>
        <span class="s0">/* 2000 is the closest later year divisible by 100 */</span>
        <span class="s1">year -= </span><span class="s4">28</span><span class="s1">;</span>
        <span class="s0">/* Add one day for each 100 years */</span>
        <span class="s1">days -= year / </span><span class="s4">100</span><span class="s1">;</span>
        <span class="s0">/* 2000 is also the closest later year divisible by 400 */</span>
        <span class="s0">/* Subtract one day for each 400 years */</span>
        <span class="s1">days += year / </span><span class="s4">400</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s1">month_lengths = days_per_month_table[is_leapyear(dts</span><span class="s5">-&gt;</span><span class="s1">year)];</span>
    <span class="s1">month = dts</span><span class="s5">-&gt;</span><span class="s1">month - </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s0">/* Add the months */</span>
    <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">; i &lt; month; ++i) {</span>
        <span class="s1">days += month_lengths[i];</span>
    <span class="s1">}</span>

    <span class="s0">/* Add the days */</span>
    <span class="s1">days += dts</span><span class="s5">-&gt;</span><span class="s1">day - </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s2">return </span><span class="s1">days;</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Modifies '*days_' to be the day offset within the year, 
 * and returns the year. 
 */</span>
<span class="s2">static </span><span class="s1">npy_int64 days_to_yearsdays(npy_int64 *days_) {</span>
    <span class="s2">const </span><span class="s1">npy_int64 days_per_400years = (</span><span class="s4">400 </span><span class="s1">* </span><span class="s4">365 </span><span class="s1">+ </span><span class="s4">100 </span><span class="s1">- </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">);</span>
    <span class="s0">/* Adjust so it's relative to the year 2000 (divisible by 400) */</span>
    <span class="s1">npy_int64 days = (*days_) - (</span><span class="s4">365 </span><span class="s1">* </span><span class="s4">30 </span><span class="s1">+ </span><span class="s4">7</span><span class="s1">);</span>
    <span class="s1">npy_int64 year;</span>

    <span class="s0">/* Break down the 400 year cycle to get the year and day within the year */</span>
    <span class="s2">if </span><span class="s1">(days &gt;= </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s1">year = </span><span class="s4">400 </span><span class="s1">* (days / days_per_400years);</span>
        <span class="s1">days = days % days_per_400years;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s1">year = </span><span class="s4">400 </span><span class="s1">* ((days - (days_per_400years - </span><span class="s4">1</span><span class="s1">)) / days_per_400years);</span>
        <span class="s1">days = days % days_per_400years;</span>
        <span class="s2">if </span><span class="s1">(days &lt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">days += days_per_400years;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">/* Work out the year/day within the 400 year cycle */</span>
    <span class="s2">if </span><span class="s1">(days &gt;= </span><span class="s4">366</span><span class="s1">) {</span>
        <span class="s1">year += </span><span class="s4">100 </span><span class="s1">* ((days - </span><span class="s4">1</span><span class="s1">) / (</span><span class="s4">100 </span><span class="s1">* </span><span class="s4">365 </span><span class="s1">+ </span><span class="s4">25 </span><span class="s1">- </span><span class="s4">1</span><span class="s1">));</span>
        <span class="s1">days = (days - </span><span class="s4">1</span><span class="s1">) % (</span><span class="s4">100 </span><span class="s1">* </span><span class="s4">365 </span><span class="s1">+ </span><span class="s4">25 </span><span class="s1">- </span><span class="s4">1</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(days &gt;= </span><span class="s4">365</span><span class="s1">) {</span>
            <span class="s1">year += </span><span class="s4">4 </span><span class="s1">* ((days + </span><span class="s4">1</span><span class="s1">) / (</span><span class="s4">4 </span><span class="s1">* </span><span class="s4">365 </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">));</span>
            <span class="s1">days = (days + </span><span class="s4">1</span><span class="s1">) % (</span><span class="s4">4 </span><span class="s1">* </span><span class="s4">365 </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">);</span>
            <span class="s2">if </span><span class="s1">(days &gt;= </span><span class="s4">366</span><span class="s1">) {</span>
                <span class="s1">year += (days - </span><span class="s4">1</span><span class="s1">) / </span><span class="s4">365</span><span class="s1">;</span>
                <span class="s1">days = (days - </span><span class="s4">1</span><span class="s1">) % </span><span class="s4">365</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">*days_ = days;</span>
    <span class="s2">return </span><span class="s1">year + </span><span class="s4">2000</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Adjusts a datetimestruct based on a seconds offset. Assumes 
 * the current values are valid. 
 */</span>
<span class="s1">NPY_NO_EXPORT </span><span class="s2">void </span><span class="s1">add_seconds_to_datetimestruct(npy_datetimestruct *dts,</span>
                                                 <span class="s2">int </span><span class="s1">seconds) {</span>
    <span class="s2">int </span><span class="s1">minutes;</span>

    <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec += seconds;</span>
    <span class="s2">if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">sec &lt; </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s1">minutes = dts</span><span class="s5">-&gt;</span><span class="s1">sec / </span><span class="s4">60</span><span class="s1">;</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec = dts</span><span class="s5">-&gt;</span><span class="s1">sec % </span><span class="s4">60</span><span class="s1">;</span>
        <span class="s2">if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">sec &lt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">--minutes;</span>
            <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec += </span><span class="s4">60</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s1">add_minutes_to_datetimestruct(dts, minutes);</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(dts</span><span class="s5">-&gt;</span><span class="s1">sec &gt;= </span><span class="s4">60</span><span class="s1">) {</span>
        <span class="s1">minutes = dts</span><span class="s5">-&gt;</span><span class="s1">sec / </span><span class="s4">60</span><span class="s1">;</span>
        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec = dts</span><span class="s5">-&gt;</span><span class="s1">sec % </span><span class="s4">60</span><span class="s1">;</span>
        <span class="s1">add_minutes_to_datetimestruct(dts, minutes);</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Fills in the year, month, day in 'dts' based on the days 
 * offset from 1970. 
 */</span>
<span class="s2">static void </span><span class="s1">set_datetimestruct_days(npy_int64 days, npy_datetimestruct *dts) {</span>
    <span class="s2">const int </span><span class="s1">*month_lengths;</span>
    <span class="s2">int </span><span class="s1">i;</span>

    <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">year = days_to_yearsdays(&amp;days);</span>
    <span class="s1">month_lengths = days_per_month_table[is_leapyear(dts</span><span class="s5">-&gt;</span><span class="s1">year)];</span>

    <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">; i &lt; </span><span class="s4">12</span><span class="s1">; ++i) {</span>
        <span class="s2">if </span><span class="s1">(days &lt; month_lengths[i]) {</span>
            <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">month = i + </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">day = days + </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s2">return</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">days -= month_lengths[i];</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Compares two npy_datetimestruct objects chronologically 
 */</span>
<span class="s2">int </span><span class="s1">cmp_npy_datetimestruct(</span><span class="s2">const </span><span class="s1">npy_datetimestruct *a,</span>
                           <span class="s2">const </span><span class="s1">npy_datetimestruct *b) {</span>
    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">year &gt; b</span><span class="s5">-&gt;</span><span class="s1">year) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">year &lt; b</span><span class="s5">-&gt;</span><span class="s1">year) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">month &gt; b</span><span class="s5">-&gt;</span><span class="s1">month) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">month &lt; b</span><span class="s5">-&gt;</span><span class="s1">month) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">day &gt; b</span><span class="s5">-&gt;</span><span class="s1">day) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">day &lt; b</span><span class="s5">-&gt;</span><span class="s1">day) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">hour &gt; b</span><span class="s5">-&gt;</span><span class="s1">hour) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">hour &lt; b</span><span class="s5">-&gt;</span><span class="s1">hour) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">min &gt; b</span><span class="s5">-&gt;</span><span class="s1">min) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">min &lt; b</span><span class="s5">-&gt;</span><span class="s1">min) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">sec &gt; b</span><span class="s5">-&gt;</span><span class="s1">sec) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">sec &lt; b</span><span class="s5">-&gt;</span><span class="s1">sec) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">us &gt; b</span><span class="s5">-&gt;</span><span class="s1">us) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">us &lt; b</span><span class="s5">-&gt;</span><span class="s1">us) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">ps &gt; b</span><span class="s5">-&gt;</span><span class="s1">ps) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">ps &lt; b</span><span class="s5">-&gt;</span><span class="s1">ps) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">as &gt; b</span><span class="s5">-&gt;</span><span class="s1">as) {</span>
        <span class="s2">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(a</span><span class="s5">-&gt;</span><span class="s1">as &lt; b</span><span class="s5">-&gt;</span><span class="s1">as) {</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">/* 
 * 
 * Converts a Python datetime.datetime or datetime.date 
 * object into a NumPy npy_datetimestruct.  Uses tzinfo (if present) 
 * to convert to UTC time. 
 * 
 * The following implementation just asks for attributes, and thus 
 * supports datetime duck typing. The tzinfo time zone conversion 
 * requires this style of access as well. 
 * 
 * Returns -1 on error, 0 on success, and 1 (with no error set) 
 * if obj doesn't have the needed date or datetime attributes. 
 */</span>
<span class="s2">int </span><span class="s1">convert_pydatetime_to_datetimestruct(PyObject *dtobj,</span>
                                         <span class="s1">npy_datetimestruct *out) {</span>
    <span class="s0">// Assumes that obj is a valid datetime object</span>
    <span class="s1">PyObject *tmp;</span>
    <span class="s1">PyObject *obj = (PyObject*)dtobj;</span>

    <span class="s0">/* Initialize the output to all zeros */</span>
    <span class="s1">memset(out, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">sizeof</span><span class="s1">(npy_datetimestruct));</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">month = </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">day = </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">year = PyInt_AsLong(PyObject_GetAttrString(obj, </span><span class="s3">&quot;year&quot;</span><span class="s1">));</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">month = PyInt_AsLong(PyObject_GetAttrString(obj, </span><span class="s3">&quot;month&quot;</span><span class="s1">));</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">day = PyInt_AsLong(PyObject_GetAttrString(obj, </span><span class="s3">&quot;day&quot;</span><span class="s1">));</span>

    <span class="s0">// TODO(anyone): If we can get PyDateTime_IMPORT to work, we could use</span>
    <span class="s0">// PyDateTime_Check here, and less verbose attribute lookups.</span>

    <span class="s0">/* Check for time attributes (if not there, return success as a date) */</span>
    <span class="s2">if </span><span class="s1">(!PyObject_HasAttrString(obj, </span><span class="s3">&quot;hour&quot;</span><span class="s1">) ||</span>
        <span class="s1">!PyObject_HasAttrString(obj, </span><span class="s3">&quot;minute&quot;</span><span class="s1">) ||</span>
        <span class="s1">!PyObject_HasAttrString(obj, </span><span class="s3">&quot;second&quot;</span><span class="s1">) ||</span>
        <span class="s1">!PyObject_HasAttrString(obj, </span><span class="s3">&quot;microsecond&quot;</span><span class="s1">)) {</span>
        <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = PyInt_AsLong(PyObject_GetAttrString(obj, </span><span class="s3">&quot;hour&quot;</span><span class="s1">));</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min = PyInt_AsLong(PyObject_GetAttrString(obj, </span><span class="s3">&quot;minute&quot;</span><span class="s1">));</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec = PyInt_AsLong(PyObject_GetAttrString(obj, </span><span class="s3">&quot;second&quot;</span><span class="s1">));</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us = PyInt_AsLong(PyObject_GetAttrString(obj, </span><span class="s3">&quot;microsecond&quot;</span><span class="s1">));</span>

    <span class="s0">/* Apply the time zone offset if datetime obj is tz-aware */</span>
    <span class="s2">if </span><span class="s1">(PyObject_HasAttrString((PyObject*)obj, </span><span class="s3">&quot;tzinfo&quot;</span><span class="s1">)) {</span>
        <span class="s1">tmp = PyObject_GetAttrString(obj, </span><span class="s3">&quot;tzinfo&quot;</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(tmp == NULL) {</span>
            <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(tmp == Py_None) {</span>
            <span class="s1">Py_DECREF(tmp);</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">PyObject *offset;</span>
            <span class="s2">int </span><span class="s1">seconds_offset, minutes_offset;</span>

            <span class="s0">/* The utcoffset function should return a timedelta */</span>
            <span class="s1">offset = PyObject_CallMethod(tmp, </span><span class="s3">&quot;utcoffset&quot;</span><span class="s1">, </span><span class="s3">&quot;O&quot;</span><span class="s1">, obj);</span>
            <span class="s2">if </span><span class="s1">(offset == NULL) {</span>
                <span class="s1">Py_DECREF(tmp);</span>
                <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s1">Py_DECREF(tmp);</span>

            <span class="s0">/* 
             * The timedelta should have a function &quot;total_seconds&quot; 
             * which contains the value we want. 
             */</span>
            <span class="s1">tmp = PyObject_CallMethod(offset, </span><span class="s3">&quot;total_seconds&quot;</span><span class="s1">, </span><span class="s3">&quot;&quot;</span><span class="s1">);</span>
            <span class="s2">if </span><span class="s1">(tmp == NULL) {</span>
                <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s1">seconds_offset = PyInt_AsLong(tmp);</span>
            <span class="s2">if </span><span class="s1">(seconds_offset == -</span><span class="s4">1 </span><span class="s1">&amp;&amp; PyErr_Occurred()) {</span>
                <span class="s1">Py_DECREF(tmp);</span>
                <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s1">Py_DECREF(tmp);</span>

            <span class="s0">/* Convert to a minutes offset and apply it */</span>
            <span class="s1">minutes_offset = seconds_offset / </span><span class="s4">60</span><span class="s1">;</span>

            <span class="s1">add_minutes_to_datetimestruct(out, -minutes_offset);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s4">0</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s0">/* 
 * Converts a datetime from a datetimestruct to a datetime based 
 * on a metadata unit. The date is assumed to be valid. 
 */</span>
<span class="s1">npy_datetime npy_datetimestruct_to_datetime(NPY_DATETIMEUNIT base,</span>
                                            <span class="s2">const </span><span class="s1">npy_datetimestruct *dts) {</span>
    <span class="s1">npy_datetime ret;</span>

    <span class="s2">if </span><span class="s1">(base == NPY_FR_Y) {</span>
        <span class="s0">/* Truncate to the year */</span>
        <span class="s1">ret = dts</span><span class="s5">-&gt;</span><span class="s1">year - </span><span class="s4">1970</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(base == NPY_FR_M) {</span>
        <span class="s0">/* Truncate to the month */</span>
        <span class="s1">ret = </span><span class="s4">12 </span><span class="s1">* (dts</span><span class="s5">-&gt;</span><span class="s1">year - </span><span class="s4">1970</span><span class="s1">) + (dts</span><span class="s5">-&gt;</span><span class="s1">month - </span><span class="s4">1</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s0">/* Otherwise calculate the number of days to start */</span>
        <span class="s1">npy_int64 days = get_datetimestruct_days(dts);</span>

        <span class="s2">switch </span><span class="s1">(base) {</span>
            <span class="s2">case </span><span class="s1">NPY_FR_W:</span>
                <span class="s0">/* Truncate to weeks */</span>
                <span class="s2">if </span><span class="s1">(days &gt;= </span><span class="s4">0</span><span class="s1">) {</span>
                    <span class="s1">ret = days / </span><span class="s4">7</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s1">ret = (days - </span><span class="s4">6</span><span class="s1">) / </span><span class="s4">7</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_D:</span>
                <span class="s1">ret = days;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_h:</span>
                <span class="s1">ret = days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_m:</span>
                <span class="s1">ret = (days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_s:</span>
                <span class="s1">ret = ((days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">sec;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_ms:</span>
                <span class="s1">ret = (((days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min) * </span><span class="s4">60 </span><span class="s1">+</span>
                       <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec) *</span>
                          <span class="s4">1000 </span><span class="s1">+</span>
                      <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">us / </span><span class="s4">1000</span><span class="s1">;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_us:</span>
                <span class="s1">ret = (((days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min) * </span><span class="s4">60 </span><span class="s1">+</span>
                       <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec) *</span>
                          <span class="s4">1000000 </span><span class="s1">+</span>
                      <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">us;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_ns:</span>
                <span class="s1">ret = ((((days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min) * </span><span class="s4">60 </span><span class="s1">+</span>
                        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec) *</span>
                           <span class="s4">1000000 </span><span class="s1">+</span>
                       <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">us) *</span>
                          <span class="s4">1000 </span><span class="s1">+</span>
                      <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">ps / </span><span class="s4">1000</span><span class="s1">;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_ps:</span>
                <span class="s1">ret = ((((days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min) * </span><span class="s4">60 </span><span class="s1">+</span>
                        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec) *</span>
                           <span class="s4">1000000 </span><span class="s1">+</span>
                       <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">us) *</span>
                          <span class="s4">1000000 </span><span class="s1">+</span>
                      <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">ps;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_fs:</span>
                <span class="s0">/* only 2.6 hours */</span>
                <span class="s1">ret = (((((days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min) * </span><span class="s4">60 </span><span class="s1">+</span>
                         <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec) *</span>
                            <span class="s4">1000000 </span><span class="s1">+</span>
                        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">us) *</span>
                           <span class="s4">1000000 </span><span class="s1">+</span>
                       <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">ps) *</span>
                          <span class="s4">1000 </span><span class="s1">+</span>
                      <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">as / </span><span class="s4">1000</span><span class="s1">;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">case </span><span class="s1">NPY_FR_as:</span>
                <span class="s0">/* only 9.2 secs */</span>
                <span class="s1">ret = (((((days * </span><span class="s4">24 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">hour) * </span><span class="s4">60 </span><span class="s1">+ dts</span><span class="s5">-&gt;</span><span class="s1">min) * </span><span class="s4">60 </span><span class="s1">+</span>
                         <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">sec) *</span>
                            <span class="s4">1000000 </span><span class="s1">+</span>
                        <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">us) *</span>
                           <span class="s4">1000000 </span><span class="s1">+</span>
                       <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">ps) *</span>
                          <span class="s4">1000000 </span><span class="s1">+</span>
                      <span class="s1">dts</span><span class="s5">-&gt;</span><span class="s1">as;</span>
                <span class="s2">break</span><span class="s1">;</span>
            <span class="s2">default</span><span class="s1">:</span>
                <span class="s0">/* Something got corrupted */</span>
                <span class="s1">PyErr_SetString(</span>
                    <span class="s1">PyExc_ValueError,</span>
                    <span class="s3">&quot;NumPy datetime metadata with corrupt unit value&quot;</span><span class="s1">);</span>
                <span class="s2">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">ret;</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Port numpy#13188 https://github.com/numpy/numpy/pull/13188/ 
 * 
 * Computes the python `ret, d = divmod(d, unit)`. 
 * 
 * Note that GCC is smart enough at -O2 to eliminate the `if(*d &lt; 0)` branch 
 * for subsequent calls to this command - it is able to deduce that `*d &gt;= 0`. 
 */</span>
<span class="s1">npy_int64 extract_unit(npy_datetime *d, npy_datetime unit) {</span>
    <span class="s1">assert(unit &gt; </span><span class="s4">0</span><span class="s1">);</span>
    <span class="s1">npy_int64 div = *d / unit;</span>
    <span class="s1">npy_int64 mod = *d % unit;</span>
    <span class="s2">if </span><span class="s1">(mod &lt; </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s1">mod += unit;</span>
        <span class="s1">div -= </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s1">assert(mod &gt;= </span><span class="s4">0</span><span class="s1">);</span>
    <span class="s1">*d = mod;</span>
    <span class="s2">return </span><span class="s1">div;</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Converts a datetime based on the given metadata into a datetimestruct 
 */</span>
<span class="s2">void </span><span class="s1">pandas_datetime_to_datetimestruct(npy_datetime dt,</span>
                                       <span class="s1">NPY_DATETIMEUNIT base,</span>
                                       <span class="s1">npy_datetimestruct *out) {</span>
    <span class="s1">npy_int64 perday;</span>

    <span class="s0">/* Initialize the output to all zeros */</span>
    <span class="s1">memset(out, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">sizeof</span><span class="s1">(npy_datetimestruct));</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">year = </span><span class="s4">1970</span><span class="s1">;</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">month = </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">day = </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s0">/* 
     * Note that care must be taken with the / and % operators 
     * for negative values. 
     */</span>
    <span class="s2">switch </span><span class="s1">(base) {</span>
        <span class="s2">case </span><span class="s1">NPY_FR_Y:</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">year = </span><span class="s4">1970 </span><span class="s1">+ dt;</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_M:</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">year  = </span><span class="s4">1970 </span><span class="s1">+ extract_unit(&amp;dt, </span><span class="s4">12</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">month = dt + </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_W:</span>
            <span class="s0">/* A week is 7 days */</span>
            <span class="s1">set_datetimestruct_days(dt * </span><span class="s4">7</span><span class="s1">, out);</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_D:</span>
            <span class="s1">set_datetimestruct_days(dt, out);</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_h:</span>
            <span class="s1">perday = </span><span class="s4">24</span><span class="s1">LL;</span>

            <span class="s1">set_datetimestruct_days(extract_unit(&amp;dt, perday), out);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = dt;</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_m:</span>
            <span class="s1">perday = </span><span class="s4">24</span><span class="s1">LL * </span><span class="s4">60</span><span class="s1">;</span>

            <span class="s1">set_datetimestruct_days(extract_unit(&amp;dt, perday), out);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min = (</span><span class="s2">int</span><span class="s1">)dt;</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_s:</span>
            <span class="s1">perday = </span><span class="s4">24</span><span class="s1">LL * </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">;</span>

            <span class="s1">set_datetimestruct_days(extract_unit(&amp;dt, perday), out);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec  = (</span><span class="s2">int</span><span class="s1">)dt;</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_ms:</span>
            <span class="s1">perday = </span><span class="s4">24</span><span class="s1">LL * </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">;</span>

            <span class="s1">set_datetimestruct_days(extract_unit(&amp;dt, perday), out);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us   = (</span><span class="s2">int</span><span class="s1">)(dt * </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_us:</span>
            <span class="s1">perday = </span><span class="s4">24</span><span class="s1">LL * </span><span class="s4">60</span><span class="s1">LL * </span><span class="s4">60</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL;</span>

            <span class="s1">set_datetimestruct_days(extract_unit(&amp;dt, perday), out);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us   = (</span><span class="s2">int</span><span class="s1">)dt;</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_ns:</span>
            <span class="s1">perday = </span><span class="s4">24</span><span class="s1">LL * </span><span class="s4">60</span><span class="s1">LL * </span><span class="s4">60</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL;</span>

            <span class="s1">set_datetimestruct_days(extract_unit(&amp;dt, perday), out);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us   = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ps   = (</span><span class="s2">int</span><span class="s1">)(dt * </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_ps:</span>
            <span class="s1">perday = </span><span class="s4">24</span><span class="s1">LL * </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">;</span>

            <span class="s1">set_datetimestruct_days(extract_unit(&amp;dt, perday), out);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us   = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ps   = (</span><span class="s2">int</span><span class="s1">)(dt * </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_fs:</span>
            <span class="s0">/* entire range is only +- 2.6 hours */</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">*</span>
                                        <span class="s4">1000 </span><span class="s1">* </span><span class="s4">60 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s2">if </span><span class="s1">(out</span><span class="s5">-&gt;</span><span class="s1">hour &lt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">year  = </span><span class="s4">1969</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">month = </span><span class="s4">12</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">day   = </span><span class="s4">31</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour  += </span><span class="s4">24</span><span class="s1">;</span>
                <span class="s1">assert(out</span><span class="s5">-&gt;</span><span class="s1">hour &gt;= </span><span class="s4">0</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">*</span>
                                        <span class="s4">1000 </span><span class="s1">* </span><span class="s4">60</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec  = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">*</span>
                                        <span class="s4">1000</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us   = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ps   = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">as   = (</span><span class="s2">int</span><span class="s1">)(dt * </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">case </span><span class="s1">NPY_FR_as:</span>
            <span class="s0">/* entire range is only +- 9.2 seconds */</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">*</span>
                                        <span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s2">if </span><span class="s1">(out</span><span class="s5">-&gt;</span><span class="s1">sec &lt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">year  = </span><span class="s4">1969</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">month = </span><span class="s4">12</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">day   = </span><span class="s4">31</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hour  = </span><span class="s4">23</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min   = </span><span class="s4">59</span><span class="s1">;</span>
                <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec   += </span><span class="s4">60</span><span class="s1">;</span>
                <span class="s1">assert(out</span><span class="s5">-&gt;</span><span class="s1">sec &gt;= </span><span class="s4">0</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us   = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ps   = (</span><span class="s2">int</span><span class="s1">)extract_unit(&amp;dt, </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">);</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">as   = (</span><span class="s2">int</span><span class="s1">)dt;</span>
            <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">default</span><span class="s1">:</span>
            <span class="s1">PyErr_SetString(PyExc_RuntimeError,</span>
                            <span class="s3">&quot;NumPy datetime metadata is corrupted with invalid &quot;</span>
                            <span class="s3">&quot;base unit&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Converts a timedelta from a timedeltastruct to a timedelta based 
 * on a metadata unit. The timedelta is assumed to be valid. 
 * 
 * Returns 0 on success, -1 on failure. 
 */</span>
<span class="s2">void </span><span class="s1">pandas_timedelta_to_timedeltastruct(npy_timedelta td,</span>
                                         <span class="s1">NPY_DATETIMEUNIT base,</span>
                                         <span class="s1">pandas_timedeltastruct *out) {</span>
    <span class="s1">npy_int64 frac;</span>
    <span class="s1">npy_int64 sfrac;</span>
    <span class="s1">npy_int64 ifrac;</span>
    <span class="s2">int </span><span class="s1">sign;</span>
    <span class="s1">npy_int64 DAY_NS = </span><span class="s4">86400000000000</span><span class="s1">LL;</span>

    <span class="s0">/* Initialize the output to all zeros */</span>
    <span class="s1">memset(out, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">sizeof</span><span class="s1">(pandas_timedeltastruct));</span>

    <span class="s2">switch </span><span class="s1">(base) {</span>
        <span class="s2">case </span><span class="s1">NPY_FR_ns:</span>

        <span class="s0">// put frac in seconds</span>
        <span class="s2">if </span><span class="s1">(td &lt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; td % (</span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL) != </span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">frac = td / (</span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL) - </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s2">else</span>
            <span class="s1">frac = td / (</span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL);</span>

        <span class="s2">if </span><span class="s1">(frac &lt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">sign = -</span><span class="s4">1</span><span class="s1">;</span>

            <span class="s0">// even fraction</span>
            <span class="s2">if </span><span class="s1">((-frac % </span><span class="s4">86400</span><span class="s1">LL) != </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">days = -frac / </span><span class="s4">86400</span><span class="s1">LL + </span><span class="s4">1</span><span class="s1">;</span>
              <span class="s1">frac += </span><span class="s4">86400</span><span class="s1">LL * out</span><span class="s5">-&gt;</span><span class="s1">days;</span>
            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
              <span class="s1">frac = -frac;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">sign = </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">days = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(frac &gt;= </span><span class="s4">86400</span><span class="s1">) {</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">days += frac / </span><span class="s4">86400</span><span class="s1">LL;</span>
            <span class="s1">frac -= out</span><span class="s5">-&gt;</span><span class="s1">days * </span><span class="s4">86400</span><span class="s1">LL;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(frac &gt;= </span><span class="s4">3600</span><span class="s1">) {</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hrs = frac / </span><span class="s4">3600</span><span class="s1">LL;</span>
            <span class="s1">frac -= out</span><span class="s5">-&gt;</span><span class="s1">hrs * </span><span class="s4">3600</span><span class="s1">LL;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">hrs = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(frac &gt;= </span><span class="s4">60</span><span class="s1">) {</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min = frac / </span><span class="s4">60</span><span class="s1">LL;</span>
            <span class="s1">frac -= out</span><span class="s5">-&gt;</span><span class="s1">min * </span><span class="s4">60</span><span class="s1">LL;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">min = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(frac &gt;= </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec = frac;</span>
            <span class="s1">frac -= out</span><span class="s5">-&gt;</span><span class="s1">sec;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">sec = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s1">sfrac = (out</span><span class="s5">-&gt;</span><span class="s1">hrs * </span><span class="s4">3600</span><span class="s1">LL + out</span><span class="s5">-&gt;</span><span class="s1">min * </span><span class="s4">60</span><span class="s1">LL</span>
                 <span class="s1">+ out</span><span class="s5">-&gt;</span><span class="s1">sec) * (</span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL);</span>

        <span class="s2">if </span><span class="s1">(sign &lt; </span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">days = -out</span><span class="s5">-&gt;</span><span class="s1">days;</span>

        <span class="s1">ifrac = td - (out</span><span class="s5">-&gt;</span><span class="s1">days * DAY_NS + sfrac);</span>

        <span class="s2">if </span><span class="s1">(ifrac != </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ms = ifrac / (</span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL);</span>
            <span class="s1">ifrac -= out</span><span class="s5">-&gt;</span><span class="s1">ms * </span><span class="s4">1000</span><span class="s1">LL * </span><span class="s4">1000</span><span class="s1">LL;</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us = ifrac / </span><span class="s4">1000</span><span class="s1">LL;</span>
            <span class="s1">ifrac -= out</span><span class="s5">-&gt;</span><span class="s1">us * </span><span class="s4">1000</span><span class="s1">LL;</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ns = ifrac;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ms = </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">us = </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">ns = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">seconds = out</span><span class="s5">-&gt;</span><span class="s1">hrs * </span><span class="s4">3600 </span><span class="s1">+ out</span><span class="s5">-&gt;</span><span class="s1">min * </span><span class="s4">60 </span><span class="s1">+ out</span><span class="s5">-&gt;</span><span class="s1">sec;</span>
        <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">microseconds = out</span><span class="s5">-&gt;</span><span class="s1">ms * </span><span class="s4">1000 </span><span class="s1">+ out</span><span class="s5">-&gt;</span><span class="s1">us;</span>
        <span class="s1">out</span><span class="s5">-&gt;</span><span class="s1">nanoseconds = out</span><span class="s5">-&gt;</span><span class="s1">ns;</span>
        <span class="s2">break</span><span class="s1">;</span>

        <span class="s2">default</span><span class="s1">:</span>
            <span class="s1">PyErr_SetString(PyExc_RuntimeError,</span>
                            <span class="s3">&quot;NumPy timedelta metadata is corrupted with &quot;</span>
                            <span class="s3">&quot;invalid base unit&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>