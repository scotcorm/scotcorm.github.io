<html>
<head>
<title>_orca.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_orca.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span>

<span class="s0">import </span><span class="s1">atexit</span>
<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">socket</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">contextmanager</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>

<span class="s0">import </span><span class="s1">tenacity</span>
<span class="s0">from </span><span class="s1">six </span><span class="s0">import </span><span class="s1">string_types</span>

<span class="s0">import </span><span class="s1">_plotly_utils.utils</span>
<span class="s0">import </span><span class="s1">plotly</span>
<span class="s0">from </span><span class="s1">plotly.files </span><span class="s0">import </span><span class="s1">PLOTLY_DIR</span><span class="s0">, </span><span class="s1">ensure_writable_plotly_dir</span>
<span class="s0">from </span><span class="s1">plotly.io._utils </span><span class="s0">import </span><span class="s1">validate_coerce_fig_to_dict</span>
<span class="s0">from </span><span class="s1">plotly.optional_imports </span><span class="s0">import </span><span class="s1">get_module</span>

<span class="s1">psutil = get_module(</span><span class="s2">&quot;psutil&quot;</span><span class="s1">)</span>

<span class="s3"># Valid image format constants</span>
<span class="s3"># ----------------------------</span>
<span class="s1">valid_formats = (</span><span class="s2">&quot;png&quot;</span><span class="s0">, </span><span class="s2">&quot;jpeg&quot;</span><span class="s0">, </span><span class="s2">&quot;webp&quot;</span><span class="s0">, </span><span class="s2">&quot;svg&quot;</span><span class="s0">, </span><span class="s2">&quot;pdf&quot;</span><span class="s0">, </span><span class="s2">&quot;eps&quot;</span><span class="s1">)</span>
<span class="s1">format_conversions = {fmt: fmt </span><span class="s0">for </span><span class="s1">fmt </span><span class="s0">in </span><span class="s1">valid_formats}</span>
<span class="s1">format_conversions.update({</span><span class="s2">&quot;jpg&quot;</span><span class="s1">: </span><span class="s2">&quot;jpeg&quot;</span><span class="s1">})</span>


<span class="s3"># Utility functions</span>
<span class="s3"># -----------------</span>
<span class="s0">def </span><span class="s1">raise_format_value_error(val):</span>
    <span class="s0">raise </span><span class="s1">ValueError(</span>
        <span class="s2">&quot;&quot;&quot; 
Invalid value of type {typ} receive as an image format specification. 
    Received value: {v} 
 
An image format must be specified as one of the following string values: 
    {valid_formats}&quot;&quot;&quot;</span><span class="s1">.format(</span>
            <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">v=val</span><span class="s0">, </span><span class="s1">valid_formats=sorted(format_conversions.keys())</span>
        <span class="s1">)</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">validate_coerce_format(fmt):</span>
    <span class="s4">&quot;&quot;&quot; 
    Validate / coerce a user specified image format, and raise an informative 
    exception if format is invalid. 
 
    Parameters 
    ---------- 
    fmt 
        A value that may or may not be a valid image format string. 
 
    Returns 
    ------- 
    str or None 
        A valid image format string as supported by orca. This may not 
        be identical to the input image designation. For example, 
        the resulting string will always be lower case and  'jpg' is 
        converted to 'jpeg'. 
 
        If the input format value is None, then no exception is raised and 
        None is returned. 
 
    Raises 
    ------ 
    ValueError 
        if the input `fmt` cannot be interpreted as a valid image format. 
    &quot;&quot;&quot;</span>

    <span class="s3"># Let None pass through</span>
    <span class="s0">if </span><span class="s1">fmt </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">return None</span>

    <span class="s3"># Check format type</span>
    <span class="s0">if not </span><span class="s1">isinstance(fmt</span><span class="s0">, </span><span class="s1">string_types) </span><span class="s0">or not </span><span class="s1">fmt:</span>
        <span class="s1">raise_format_value_error(fmt)</span>

    <span class="s3"># Make lower case</span>
    <span class="s1">fmt = fmt.lower()</span>

    <span class="s3"># Remove leading period, if any.</span>
    <span class="s3"># For example '.png' is accepted and converted to 'png'</span>
    <span class="s0">if </span><span class="s1">fmt[</span><span class="s5">0</span><span class="s1">] == </span><span class="s2">&quot;.&quot;</span><span class="s1">:</span>
        <span class="s1">fmt = fmt[</span><span class="s5">1</span><span class="s1">:]</span>

    <span class="s3"># Check string value</span>
    <span class="s0">if </span><span class="s1">fmt </span><span class="s0">not in </span><span class="s1">format_conversions:</span>
        <span class="s1">raise_format_value_error(fmt)</span>

    <span class="s3"># Return converted string specification</span>
    <span class="s0">return </span><span class="s1">format_conversions[fmt]</span>


<span class="s0">def </span><span class="s1">find_open_port():</span>
    <span class="s4">&quot;&quot;&quot; 
    Use the socket module to find an open port. 
 
    Returns 
    ------- 
    int 
        An open port 
    &quot;&quot;&quot;</span>
    <span class="s1">s = socket.socket()</span>
    <span class="s1">s.setsockopt(socket.SOL_SOCKET</span><span class="s0">, </span><span class="s1">socket.SO_REUSEADDR</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">s.bind((</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">port = s.getsockname()</span>
    <span class="s1">s.close()</span>

    <span class="s0">return </span><span class="s1">port</span>


<span class="s0">def </span><span class="s1">which_py2(cmd</span><span class="s0">, </span><span class="s1">mode=os.F_OK | os.X_OK</span><span class="s0">, </span><span class="s1">path=</span><span class="s0">None</span><span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Backport (unmodified) of shutil.which command from Python 3.6 
    Remove this when Python 2 support is dropped 
 
    Given a command, mode, and a PATH string, return the path which 
    conforms to the given mode on the PATH, or None if there is no such 
    file. 
 
    `mode` defaults to os.F_OK | os.X_OK. `path` defaults to the result 
    of os.environ.get(&quot;PATH&quot;), or can be overridden with a custom search 
    path. 
    &quot;&quot;&quot;</span>
    <span class="s3"># Check that a given file can be accessed with the correct mode.</span>
    <span class="s3"># Additionally check that `file` is not a directory, as on Windows</span>
    <span class="s3"># directories pass the os.access check.</span>
    <span class="s0">def </span><span class="s1">_access_check(fn</span><span class="s0">, </span><span class="s1">mode):</span>
        <span class="s0">return </span><span class="s1">os.path.exists(fn) </span><span class="s0">and </span><span class="s1">os.access(fn</span><span class="s0">, </span><span class="s1">mode) </span><span class="s0">and not </span><span class="s1">os.path.isdir(fn)</span>

    <span class="s3"># If we're given a path with a directory part, look it up directly rather</span>
    <span class="s3"># than referring to PATH directories. This includes checking relative to</span>
    <span class="s3"># the current directory, e.g. ./script</span>
    <span class="s0">if </span><span class="s1">os.path.dirname(cmd):</span>
        <span class="s0">if </span><span class="s1">_access_check(cmd</span><span class="s0">, </span><span class="s1">mode):</span>
            <span class="s0">return </span><span class="s1">cmd</span>
        <span class="s0">return None</span>

    <span class="s0">if </span><span class="s1">path </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">path = os.environ.get(</span><span class="s2">&quot;PATH&quot;</span><span class="s0">, </span><span class="s1">os.defpath)</span>
    <span class="s0">if not </span><span class="s1">path:</span>
        <span class="s0">return None</span>
    <span class="s1">path = path.split(os.pathsep)</span>

    <span class="s0">if </span><span class="s1">sys.platform == </span><span class="s2">&quot;win32&quot;</span><span class="s1">:</span>
        <span class="s3"># The current directory takes precedence on Windows.</span>
        <span class="s0">if not </span><span class="s1">os.curdir </span><span class="s0">in </span><span class="s1">path:</span>
            <span class="s1">path.insert(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">os.curdir)</span>

        <span class="s3"># PATHEXT is necessary to check on Windows.</span>
        <span class="s1">pathext = os.environ.get(</span><span class="s2">&quot;PATHEXT&quot;</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s1">).split(os.pathsep)</span>
        <span class="s3"># See if the given file matches any of the expected path extensions.</span>
        <span class="s3"># This will allow us to short circuit when given &quot;python.exe&quot;.</span>
        <span class="s3"># If it does match, only test that one, otherwise we have to try</span>
        <span class="s3"># others.</span>
        <span class="s0">if </span><span class="s1">any(cmd.lower().endswith(ext.lower()) </span><span class="s0">for </span><span class="s1">ext </span><span class="s0">in </span><span class="s1">pathext):</span>
            <span class="s1">files = [cmd]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">files = [cmd + ext </span><span class="s0">for </span><span class="s1">ext </span><span class="s0">in </span><span class="s1">pathext]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s3"># On other platforms you don't have things like PATHEXT to tell you</span>
        <span class="s3"># what file suffixes are executable, so just pass on cmd as-is.</span>
        <span class="s1">files = [cmd]</span>

    <span class="s1">seen = set()</span>
    <span class="s0">for </span><span class="s1">dir </span><span class="s0">in </span><span class="s1">path:</span>
        <span class="s1">normdir = os.path.normcase(dir)</span>
        <span class="s0">if not </span><span class="s1">normdir </span><span class="s0">in </span><span class="s1">seen:</span>
            <span class="s1">seen.add(normdir)</span>
            <span class="s0">for </span><span class="s1">thefile </span><span class="s0">in </span><span class="s1">files:</span>
                <span class="s1">name = os.path.join(dir</span><span class="s0">, </span><span class="s1">thefile)</span>
                <span class="s0">if </span><span class="s1">_access_check(name</span><span class="s0">, </span><span class="s1">mode):</span>
                    <span class="s0">return </span><span class="s1">name</span>
    <span class="s0">return None</span>


<span class="s0">def </span><span class="s1">which(cmd):</span>
    <span class="s4">&quot;&quot;&quot; 
    Return the absolute path of the input executable string, based on the 
    user's current PATH variable. 
 
    This is a wrapper for shutil.which that is compatible with Python 2. 
 
    Parameters 
    ---------- 
    cmd: str 
        String containing the name of an executable on the user's path. 
 
    Returns 
    ------- 
    str or None 
        String containing the absolute path of the executable, or None if 
        the executable was not found. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">sys.version_info &gt; (</span><span class="s5">3</span><span class="s0">, </span><span class="s5">0</span><span class="s1">):</span>
        <span class="s0">import </span><span class="s1">shutil</span>

        <span class="s0">return </span><span class="s1">shutil.which(cmd)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">return </span><span class="s1">which_py2(cmd)</span>


<span class="s3"># Orca configuration class</span>
<span class="s3"># ------------------------</span>
<span class="s0">class </span><span class="s1">OrcaConfig(object):</span>
    <span class="s4">&quot;&quot;&quot; 
    Singleton object containing the current user defined configuration 
    properties for orca. 
 
    These parameters may optionally be saved to the user's ~/.plotly 
    directory using the `save` method, in which case they are automatically 
    restored in future sessions. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self):</span>

        <span class="s3"># Initialize properties dict</span>
        <span class="s1">self._props = {}</span>

        <span class="s3"># Compute absolute path to the 'plotly/package_data/' directory</span>
        <span class="s1">root_dir = os.path.dirname(os.path.abspath(plotly.__file__))</span>
        <span class="s1">self.package_dir = os.path.join(root_dir</span><span class="s0">, </span><span class="s2">&quot;package_data&quot;</span><span class="s1">)</span>

        <span class="s3"># Load pre-existing configuration</span>
        <span class="s1">self.reload(warn=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s3"># Compute constants</span>
        <span class="s1">plotlyjs = os.path.join(self.package_dir</span><span class="s0">, </span><span class="s2">&quot;plotly.min.js&quot;</span><span class="s1">)</span>
        <span class="s1">self._constants = {</span>
            <span class="s2">&quot;plotlyjs&quot;</span><span class="s1">: plotlyjs</span><span class="s0">,</span>
            <span class="s2">&quot;config_file&quot;</span><span class="s1">: os.path.join(PLOTLY_DIR</span><span class="s0">, </span><span class="s2">&quot;.orca&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>

    <span class="s0">def </span><span class="s1">restore_defaults(self</span><span class="s0">, </span><span class="s1">reset_server=</span><span class="s0">True</span><span class="s1">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Reset all orca configuration properties to their default values 
        &quot;&quot;&quot;</span>
        <span class="s1">self._props = {}</span>

        <span class="s0">if </span><span class="s1">reset_server:</span>
            <span class="s3"># Server must restart before setting is active</span>
            <span class="s1">reset_status()</span>

    <span class="s0">def </span><span class="s1">update(self</span><span class="s0">, </span><span class="s1">d={}</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s4">&quot;&quot;&quot; 
        Update one or more properties from a dict or from input keyword 
        arguments. 
 
        Parameters 
        ---------- 
        d: dict 
            Dictionary from property names to new property values. 
 
        kwargs 
            Named argument value pairs where the name is a configuration 
            property name and the value is the new property value. 
 
        Returns 
        ------- 
        None 
 
        Examples 
        -------- 
        Update configuration properties using a dictionary 
 
        &gt;&gt;&gt; import plotly.io as pio 
        &gt;&gt;&gt; pio.orca.config.update({'timeout': 30, 'default_format': 'svg'}) 
 
        Update configuration properties using keyword arguments 
 
        &gt;&gt;&gt; pio.orca.config.update(timeout=30, default_format='svg'}) 
        &quot;&quot;&quot;</span>
        <span class="s3"># Combine d and kwargs</span>
        <span class="s0">if not </span><span class="s1">isinstance(d</span><span class="s0">, </span><span class="s1">dict):</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
The first argument to update must be a dict, </span><span class="s0">\ 
</span><span class="s2">but received value of type {typ}l 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">typ=type(d)</span><span class="s0">, </span><span class="s1">val=d</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

        <span class="s1">updates = copy(d)</span>
        <span class="s1">updates.update(kwargs)</span>

        <span class="s3"># Validate keys</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">updates:</span>
            <span class="s0">if </span><span class="s1">k </span><span class="s0">not in </span><span class="s1">self._props:</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">&quot;Invalid property name: {k}&quot;</span><span class="s1">.format(k=k))</span>

        <span class="s3"># Apply keys</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">updates.items():</span>
            <span class="s1">setattr(self</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v)</span>

    <span class="s0">def </span><span class="s1">reload(self</span><span class="s0">, </span><span class="s1">warn=</span><span class="s0">True</span><span class="s1">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Reload orca settings from ~/.plotly/.orca, if any. 
 
        Note: Settings are loaded automatically when plotly is imported. 
        This method is only needed if the setting are changed by some outside 
        process (e.g. a text editor) during an interactive session. 
 
        Parameters 
        ---------- 
        warn: bool 
            If True, raise informative warnings if settings cannot be restored. 
            If False, do not raise warnings if setting cannot be restored. 
 
        Returns 
        ------- 
        None 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">os.path.exists(self.config_file):</span>

            <span class="s3"># ### Load file into a string ###</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s0">with </span><span class="s1">open(self.config_file</span><span class="s0">, </span><span class="s2">&quot;r&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                    <span class="s1">orca_str = f.read()</span>
            <span class="s0">except</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">warn:</span>
                    <span class="s1">warnings.warn(</span>
                        <span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">Unable to read orca configuration file at {path}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                            <span class="s1">path=self.config_file</span>
                        <span class="s1">)</span>
                    <span class="s1">)</span>
                <span class="s0">return</span>

            <span class="s3"># ### Parse as JSON ###</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">orca_props = json.loads(orca_str)</span>
            <span class="s0">except </span><span class="s1">ValueError:</span>
                <span class="s0">if </span><span class="s1">warn:</span>
                    <span class="s1">warnings.warn(</span>
                        <span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">Orca configuration file at {path} is not valid JSON&quot;&quot;&quot;</span><span class="s1">.format(</span>
                            <span class="s1">path=self.config_file</span>
                        <span class="s1">)</span>
                    <span class="s1">)</span>
                <span class="s0">return</span>

            <span class="s3"># ### Update _props ###</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">orca_props.items():</span>
                <span class="s1">self._props[k] = v</span>

        <span class="s0">elif </span><span class="s1">warn:</span>
            <span class="s1">warnings.warn(</span>
                <span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">Orca configuration file at {path} not found&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">path=self.config_file</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">save(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Attempt to save current settings to disk, so that they are 
        automatically restored for future sessions. 
 
        This operation requires write access to the path returned by 
        in the `config_file` property. 
 
        Returns 
        ------- 
        None 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">ensure_writable_plotly_dir():</span>
            <span class="s0">with </span><span class="s1">open(self.config_file</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
                <span class="s1">json.dump(self._props</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">indent=</span><span class="s5">4</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">warnings.warn(</span>
                <span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">Failed to write orca configuration file at '{path}'&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">path=self.config_file</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">server_url(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The server URL to use for an external orca server, or None if orca 
        should be managed locally 
 
        Overrides executable, port, timeout, mathjax, topojson, 
        and mapbox_access_token 
 
        Returns 
        ------- 
        str or None 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;server_url&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@server_url.setter</span>
    <span class="s0">def </span><span class="s1">server_url(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;server_url&quot;</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">str):</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
The server_url property must be a string, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

        <span class="s0">if not </span><span class="s1">val.startswith(</span><span class="s2">&quot;http://&quot;</span><span class="s1">) </span><span class="s0">and not </span><span class="s1">val.startswith(</span><span class="s2">&quot;https://&quot;</span><span class="s1">):</span>
            <span class="s1">val = </span><span class="s2">&quot;http://&quot; </span><span class="s1">+ val</span>

        <span class="s1">shutdown_server()</span>
        <span class="s1">self.executable = </span><span class="s0">None</span>
        <span class="s1">self.port = </span><span class="s0">None</span>
        <span class="s1">self.timeout = </span><span class="s0">None</span>
        <span class="s1">self.mathjax = </span><span class="s0">None</span>
        <span class="s1">self.topojson = </span><span class="s0">None</span>
        <span class="s1">self.mapbox_access_token = </span><span class="s0">None</span>
        <span class="s1">self._props[</span><span class="s2">&quot;server_url&quot;</span><span class="s1">] = val</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">port(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The specific port to use to communicate with the orca server, or 
        None if the port is to be chosen automatically. 
 
        If an orca server is active, the port in use is stored in the 
        plotly.io.orca.status.port property. 
 
        Returns 
        ------- 
        int or None 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;port&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@port.setter</span>
    <span class="s0">def </span><span class="s1">port(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;port&quot;</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">int):</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
The port property must be an integer, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

        <span class="s1">self._props[</span><span class="s2">&quot;port&quot;</span><span class="s1">] = val</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">executable(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The name or full path of the orca executable. 
 
         - If a name (e.g. 'orca'), then it should be the name of an orca 
           executable on the PATH. The directories on the PATH can be 
           displayed by running the following command: 
 
           &gt;&gt;&gt; import os 
           &gt;&gt;&gt; print(os.environ.get('PATH').replace(os.pathsep, os.linesep)) 
 
         - If a full path (e.g. '/path/to/orca'), then 
           it should be the full path to an orca executable. In this case 
           the executable does not need to reside on the PATH. 
 
        If an orca server has been validated, then the full path to the 
        validated orca executable is stored in the 
        plotly.io.orca.status.executable property. 
 
        Returns 
        ------- 
        str 
        &quot;&quot;&quot;</span>
        <span class="s1">executable_list = self._props.get(</span><span class="s2">&quot;executable_list&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;orca&quot;</span><span class="s1">])</span>
        <span class="s0">if </span><span class="s1">executable_list </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">return None</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s2">&quot; &quot;</span><span class="s1">.join(executable_list)</span>

    <span class="s1">@executable.setter</span>
    <span class="s0">def </span><span class="s1">executable(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;executable&quot;</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">string_types):</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
The executable property must be a string, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
            <span class="s0">if </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">string_types):</span>
                <span class="s1">val = [val]</span>
            <span class="s1">self._props[</span><span class="s2">&quot;executable_list&quot;</span><span class="s1">] = val</span>

        <span class="s3"># Server and validation must restart before setting is active</span>
        <span class="s1">reset_status()</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">timeout(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The number of seconds of inactivity required before the orca server 
        is shut down. 
 
        For example, if timeout is set to 20, then the orca 
        server will shutdown once is has not been used for at least 
        20 seconds. If timeout is set to None, then the server will not be 
        automatically shut down due to inactivity. 
 
        Regardless of the value of timeout, a running orca server may be 
        manually shut down like this: 
 
        &gt;&gt;&gt; import plotly.io as pio 
        &gt;&gt;&gt; pio.orca.shutdown_server() 
 
        Returns 
        ------- 
        int or float or None 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;timeout&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@timeout.setter</span>
    <span class="s0">def </span><span class="s1">timeout(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;timeout&quot;</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">(int</span><span class="s0">, </span><span class="s1">float)):</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
The timeout property must be a number, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
            <span class="s1">self._props[</span><span class="s2">&quot;timeout&quot;</span><span class="s1">] = val</span>

        <span class="s3"># Server must restart before setting is active</span>
        <span class="s1">shutdown_server()</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">default_width(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The default width to use on image export. This value is only 
        applied if no width value is supplied to the plotly.io 
        to_image or write_image functions. 
 
        Returns 
        ------- 
        int or None 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;default_width&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@default_width.setter</span>
    <span class="s0">def </span><span class="s1">default_width(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;default_width&quot;</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">int):</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
The default_width property must be an int, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                <span class="s1">)</span>
            <span class="s1">)</span>
        <span class="s1">self._props[</span><span class="s2">&quot;default_width&quot;</span><span class="s1">] = val</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">default_height(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The default height to use on image export. This value is only 
        applied if no height value is supplied to the plotly.io 
        to_image or write_image functions. 
 
        Returns 
        ------- 
        int or None 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;default_height&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@default_height.setter</span>
    <span class="s0">def </span><span class="s1">default_height(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;default_height&quot;</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">int):</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
The default_height property must be an int, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                <span class="s1">)</span>
            <span class="s1">)</span>
        <span class="s1">self._props[</span><span class="s2">&quot;default_height&quot;</span><span class="s1">] = val</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">default_format(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The default image format to use on image export. 
 
        Valid image formats strings are: 
          - 'png' 
          - 'jpg' or 'jpeg' 
          - 'webp' 
          - 'svg' 
          - 'pdf' 
          - 'eps' (Requires the poppler library to be installed) 
 
        This value is only applied if no format value is supplied to the 
        plotly.io to_image or write_image functions. 
 
        Returns 
        ------- 
        str or None 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;default_format&quot;</span><span class="s0">, </span><span class="s2">&quot;png&quot;</span><span class="s1">)</span>

    <span class="s1">@default_format.setter</span>
    <span class="s0">def </span><span class="s1">default_format(self</span><span class="s0">, </span><span class="s1">val):</span>
        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;default_format&quot;</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s0">return</span>

        <span class="s1">val = validate_coerce_format(val)</span>
        <span class="s1">self._props[</span><span class="s2">&quot;default_format&quot;</span><span class="s1">] = val</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">default_scale(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The default image scaling factor to use on image export. 
        This value is only applied if no scale value is supplied to the 
        plotly.io to_image or write_image functions. 
 
        Returns 
        ------- 
        int or None 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;default_scale&quot;</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>

    <span class="s1">@default_scale.setter</span>
    <span class="s0">def </span><span class="s1">default_scale(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;default_scale&quot;</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">(int</span><span class="s0">, </span><span class="s1">float)):</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
The default_scale property must be a number, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                <span class="s1">)</span>
            <span class="s1">)</span>
        <span class="s1">self._props[</span><span class="s2">&quot;default_scale&quot;</span><span class="s1">] = val</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">topojson(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Path to the topojson files needed to render choropleth traces. 
 
        If None, topojson files from the plot.ly CDN are used. 
 
        Returns 
        ------- 
        str 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;topojson&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@topojson.setter</span>
    <span class="s0">def </span><span class="s1">topojson(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;topojson&quot;</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">string_types):</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
The topojson property must be a string, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
            <span class="s1">self._props[</span><span class="s2">&quot;topojson&quot;</span><span class="s1">] = val</span>

        <span class="s3"># Server must restart before setting is active</span>
        <span class="s1">shutdown_server()</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">mathjax(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Path to the MathJax bundle needed to render LaTeX characters 
 
        Returns 
        ------- 
        str 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span>
            <span class="s2">&quot;mathjax&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;https://cdnjs.cloudflare.com&quot; &quot;/ajax/libs/mathjax/2.7.5/MathJax.js&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s1">@mathjax.setter</span>
    <span class="s0">def </span><span class="s1">mathjax(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;mathjax&quot;</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">string_types):</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
The mathjax property must be a string, but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
            <span class="s1">self._props[</span><span class="s2">&quot;mathjax&quot;</span><span class="s1">] = val</span>

        <span class="s3"># Server must restart before setting is active</span>
        <span class="s1">shutdown_server()</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">mapbox_access_token(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Mapbox access token required to render mapbox traces. 
 
        Returns 
        ------- 
        str 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;mapbox_access_token&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@mapbox_access_token.setter</span>
    <span class="s0">def </span><span class="s1">mapbox_access_token(self</span><span class="s0">, </span><span class="s1">val):</span>

        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;mapbox_access_token&quot;</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">isinstance(val</span><span class="s0">, </span><span class="s1">string_types):</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
The mapbox_access_token property must be a string, </span><span class="s0">\ 
</span><span class="s2">but received value of type {typ}. 
    Received value: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=val</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
            <span class="s1">self._props[</span><span class="s2">&quot;mapbox_access_token&quot;</span><span class="s1">] = val</span>

        <span class="s3"># Server must restart before setting is active</span>
        <span class="s1">shutdown_server()</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">use_xvfb(self):</span>
        <span class="s1">dflt = </span><span class="s2">&quot;auto&quot;</span>
        <span class="s0">return </span><span class="s1">self._props.get(</span><span class="s2">&quot;use_xvfb&quot;</span><span class="s0">, </span><span class="s1">dflt)</span>

    <span class="s1">@use_xvfb.setter</span>
    <span class="s0">def </span><span class="s1">use_xvfb(self</span><span class="s0">, </span><span class="s1">val):</span>
        <span class="s1">valid_vals = [</span><span class="s0">True, False, </span><span class="s2">&quot;auto&quot;</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">val </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._props.pop(</span><span class="s2">&quot;use_xvfb&quot;</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">val </span><span class="s0">not in </span><span class="s1">valid_vals:</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
The use_xvfb property must be one of {valid_vals} 
    Received value of type {typ}: {val}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">valid_vals=valid_vals</span><span class="s0">, </span><span class="s1">typ=type(val)</span><span class="s0">, </span><span class="s1">val=repr(val)</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>

            <span class="s1">self._props[</span><span class="s2">&quot;use_xvfb&quot;</span><span class="s1">] = val</span>

        <span class="s3"># Server and validation must restart before setting is active</span>
        <span class="s1">reset_status()</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">plotlyjs(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The plotly.js bundle being used for image rendering. 
 
        Returns 
        ------- 
        str 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._constants.get(</span><span class="s2">&quot;plotlyjs&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">config_file(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Path to orca configuration file 
 
        Using the `plotly.io.config.save()` method will save the current 
        configuration settings to this file. Settings in this file are 
        restored at the beginning of each sessions. 
 
        Returns 
        ------- 
        str 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">os.path.join(PLOTLY_DIR</span><span class="s0">, </span><span class="s2">&quot;.orca&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">__repr__(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Display a nice representation of the current orca configuration. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">orca configuration 
------------------ 
    server_url: {server_url} 
    executable: {executable} 
    port: {port} 
    timeout: {timeout} 
    default_width: {default_width} 
    default_height: {default_height} 
    default_scale: {default_scale} 
    default_format: {default_format} 
    mathjax: {mathjax} 
    topojson: {topojson} 
    mapbox_access_token: {mapbox_access_token} 
    use_xvfb: {use_xvfb} 
 
constants 
--------- 
    plotlyjs: {plotlyjs} 
    config_file: {config_file} 
 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
            <span class="s1">server_url=self.server_url</span><span class="s0">,</span>
            <span class="s1">port=self.port</span><span class="s0">,</span>
            <span class="s1">executable=self.executable</span><span class="s0">,</span>
            <span class="s1">timeout=self.timeout</span><span class="s0">,</span>
            <span class="s1">default_width=self.default_width</span><span class="s0">,</span>
            <span class="s1">default_height=self.default_height</span><span class="s0">,</span>
            <span class="s1">default_scale=self.default_scale</span><span class="s0">,</span>
            <span class="s1">default_format=self.default_format</span><span class="s0">,</span>
            <span class="s1">mathjax=self.mathjax</span><span class="s0">,</span>
            <span class="s1">topojson=self.topojson</span><span class="s0">,</span>
            <span class="s1">mapbox_access_token=self.mapbox_access_token</span><span class="s0">,</span>
            <span class="s1">plotlyjs=self.plotlyjs</span><span class="s0">,</span>
            <span class="s1">config_file=self.config_file</span><span class="s0">,</span>
            <span class="s1">use_xvfb=self.use_xvfb</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s3"># Make config a singleton object</span>
<span class="s3"># ------------------------------</span>
<span class="s1">config = OrcaConfig()</span>
<span class="s0">del </span><span class="s1">OrcaConfig</span>


<span class="s3"># Orca status class</span>
<span class="s3"># ------------------------</span>
<span class="s0">class </span><span class="s1">OrcaStatus(object):</span>
    <span class="s4">&quot;&quot;&quot; 
    Class to store information about the current status of the orca server. 
    &quot;&quot;&quot;</span>

    <span class="s1">_props = {</span>
        <span class="s2">&quot;state&quot;</span><span class="s1">: </span><span class="s2">&quot;unvalidated&quot;</span><span class="s0">,  </span><span class="s3"># or 'validated' or 'running'</span>
        <span class="s2">&quot;executable_list&quot;</span><span class="s1">: </span><span class="s0">None,</span>
        <span class="s2">&quot;version&quot;</span><span class="s1">: </span><span class="s0">None,</span>
        <span class="s2">&quot;pid&quot;</span><span class="s1">: </span><span class="s0">None,</span>
        <span class="s2">&quot;port&quot;</span><span class="s1">: </span><span class="s0">None,</span>
        <span class="s2">&quot;command&quot;</span><span class="s1">: </span><span class="s0">None,</span>
    <span class="s1">}</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">state(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        A string representing the state of the orca server process 
 
        One of: 
          - unvalidated: The orca executable has not yet been searched for or 
            tested to make sure its valid. 
          - validated: The orca executable has been located and tested for 
            validity, but it is not running. 
          - running: The orca server process is currently running. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props[</span><span class="s2">&quot;state&quot;</span><span class="s1">]</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">executable(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        If the `state` property is 'validated' or 'running', this property 
        contains the full path to the orca executable. 
 
        This path can be specified explicitly by setting the `executable` 
        property of the `plotly.io.orca.config` object. 
 
        This property will be None if the `state` is 'unvalidated'. 
        &quot;&quot;&quot;</span>
        <span class="s1">executable_list = self._props[</span><span class="s2">&quot;executable_list&quot;</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">executable_list </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">return None</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s2">&quot; &quot;</span><span class="s1">.join(executable_list)</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">version(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        If the `state` property is 'validated' or 'running', this property 
        contains the version of the validated orca executable. 
 
        This property will be None if the `state` is 'unvalidated'. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props[</span><span class="s2">&quot;version&quot;</span><span class="s1">]</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">pid(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The process id of the orca server process, if any. This property 
        will be None if the `state` is not 'running'. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props[</span><span class="s2">&quot;pid&quot;</span><span class="s1">]</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">port(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The port number that the orca server process is listening to, if any. 
        This property will be None if the `state` is not 'running'. 
 
        This port can be specified explicitly by setting the `port` 
        property of the `plotly.io.orca.config` object. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props[</span><span class="s2">&quot;port&quot;</span><span class="s1">]</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">command(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        The command arguments used to launch the running orca server, if any. 
        This property will be None if the `state` is not 'running'. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._props[</span><span class="s2">&quot;command&quot;</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">__repr__(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Display a nice representation of the current orca server status. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">orca status 
----------- 
    state: {state} 
    executable: {executable} 
    version: {version} 
    port: {port} 
    pid: {pid} 
    command: {command} 
 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
            <span class="s1">executable=self.executable</span><span class="s0">,</span>
            <span class="s1">version=self.version</span><span class="s0">,</span>
            <span class="s1">port=self.port</span><span class="s0">,</span>
            <span class="s1">pid=self.pid</span><span class="s0">,</span>
            <span class="s1">state=self.state</span><span class="s0">,</span>
            <span class="s1">command=self.command</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s3"># Make status a singleton object</span>
<span class="s3"># ------------------------------</span>
<span class="s1">status = OrcaStatus()</span>
<span class="s0">del </span><span class="s1">OrcaStatus</span>


<span class="s1">@contextmanager</span>
<span class="s0">def </span><span class="s1">orca_env():</span>
    <span class="s4">&quot;&quot;&quot; 
    Context manager to clear and restore environment variables that are 
    problematic for orca to function properly 
 
    NODE_OPTIONS: When this variable is set, orca &lt;v1.2 will have a 
    segmentation fault due to an electron bug. 
    See: https://github.com/electron/electron/issues/12695 
 
    ELECTRON_RUN_AS_NODE: When this environment variable is set the call 
    to orca is transformed into a call to nodejs. 
    See https://github.com/plotly/orca/issues/149#issuecomment-443506732 
    &quot;&quot;&quot;</span>
    <span class="s1">clear_env_vars = [</span><span class="s2">&quot;NODE_OPTIONS&quot;</span><span class="s0">, </span><span class="s2">&quot;ELECTRON_RUN_AS_NODE&quot;</span><span class="s0">, </span><span class="s2">&quot;LD_PRELOAD&quot;</span><span class="s1">]</span>
    <span class="s1">orig_env_vars = {}</span>

    <span class="s0">try</span><span class="s1">:</span>
        <span class="s3"># Clear and save</span>
        <span class="s1">orig_env_vars.update(</span>
            <span class="s1">{var: os.environ.pop(var) </span><span class="s0">for </span><span class="s1">var </span><span class="s0">in </span><span class="s1">clear_env_vars </span><span class="s0">if </span><span class="s1">var </span><span class="s0">in </span><span class="s1">os.environ}</span>
        <span class="s1">)</span>
        <span class="s0">yield</span>
    <span class="s0">finally</span><span class="s1">:</span>
        <span class="s3"># Restore</span>
        <span class="s0">for </span><span class="s1">var</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">orig_env_vars.items():</span>
            <span class="s1">os.environ[var] = val</span>


<span class="s3"># Public orca server interaction functions</span>
<span class="s3"># ----------------------------------------</span>
<span class="s0">def </span><span class="s1">validate_executable():</span>
    <span class="s4">&quot;&quot;&quot; 
    Attempt to find and validate the orca executable specified by the 
    `plotly.io.orca.config.executable` property. 
 
    If the `plotly.io.orca.status.state` property is 'validated' or 'running' 
    then this function does nothing. 
 
    How it works: 
      - First, it searches the system PATH for an executable that matches the 
      name or path specified in the `plotly.io.orca.config.executable` 
      property. 
      - Then it runs the executable with the `--help` flag to make sure 
      it's the plotly orca executable 
      - Then it runs the executable with the `--version` flag to check the 
      orca version. 
 
    If all of these steps are successful then the `status.state` property 
    is set to 'validated' and the `status.executable` and `status.version` 
    properties are populated 
 
    Returns 
    ------- 
    None 
    &quot;&quot;&quot;</span>
    <span class="s3"># Check state</span>
    <span class="s3"># -----------</span>
    <span class="s0">if </span><span class="s1">status.state != </span><span class="s2">&quot;unvalidated&quot;</span><span class="s1">:</span>
        <span class="s3"># Nothing more to do</span>
        <span class="s0">return</span>

    <span class="s3"># Initialize error messages</span>
    <span class="s3"># -------------------------</span>
    <span class="s1">install_location_instructions = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">If you haven't installed orca yet, you can do so using conda as follows: 
 
    $ conda install -c plotly plotly-orca 
 
Alternatively, see other installation methods in the orca project README at 
https://github.com/plotly/orca 
 
After installation is complete, no further configuration should be needed. 
 
If you have installed orca, then for some reason plotly.py was unable to 
locate it. In this case, set the `plotly.io.orca.config.executable` 
property to the full path of your orca executable. For example: 
 
    &gt;&gt;&gt; plotly.io.orca.config.executable = '/path/to/orca' 
 
After updating this executable property, try the export operation again. 
If it is successful then you may want to save this configuration so that it 
will be applied automatically in future sessions. You can do this as follows: 
 
    &gt;&gt;&gt; plotly.io.orca.config.save() 
 
If you're still having trouble, feel free to ask for help on the forums at 
https://community.plot.ly/c/api/python 
&quot;&quot;&quot;</span>

    <span class="s3"># Try to find an executable</span>
    <span class="s3"># -------------------------</span>
    <span class="s3"># Search for executable name or path in config.executable</span>
    <span class="s1">executable = which(config.executable)</span>
    <span class="s1">path = os.environ.get(</span><span class="s2">&quot;PATH&quot;</span><span class="s0">, </span><span class="s1">os.defpath)</span>
    <span class="s1">formatted_path = path.replace(os.pathsep</span><span class="s0">, </span><span class="s2">&quot;</span><span class="s0">\n    </span><span class="s2">&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">executable </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s2">&quot;&quot;&quot; 
The orca executable is required to export figures as static images, 
but it could not be found on the system path. 
 
Searched for executable '{executable}' on the following path: 
    {formatted_path} 
 
{instructions}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">executable=config.executable</span><span class="s0">,</span>
                <span class="s1">formatted_path=formatted_path</span><span class="s0">,</span>
                <span class="s1">instructions=install_location_instructions</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s3"># Check if we should run with Xvfb</span>
    <span class="s3"># --------------------------------</span>
    <span class="s1">xvfb_args = [</span>
        <span class="s2">&quot;--auto-servernum&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;--server-args&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;-screen 0 640x480x24 +extension RANDR +extension GLX&quot;</span><span class="s0">,</span>
        <span class="s1">executable</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">if </span><span class="s1">config.use_xvfb == </span><span class="s0">True</span><span class="s1">:</span>
        <span class="s3"># Use xvfb</span>
        <span class="s1">xvfb_run_executable = which(</span><span class="s2">&quot;xvfb-run&quot;</span><span class="s1">)</span>
        <span class="s0">if not </span><span class="s1">xvfb_run_executable:</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
The plotly.io.orca.config.use_xvfb property is set to True, but the 
xvfb-run executable could not be found on the system path. 
 
Searched for the executable 'xvfb-run' on the following path: 
    {formatted_path}&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">formatted_path=formatted_path</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

        <span class="s1">executable_list = [xvfb_run_executable] + xvfb_args</span>
    <span class="s0">elif </span><span class="s1">(</span>
        <span class="s1">config.use_xvfb == </span><span class="s2">&quot;auto&quot;</span>
        <span class="s0">and </span><span class="s1">sys.platform.startswith(</span><span class="s2">&quot;linux&quot;</span><span class="s1">)</span>
        <span class="s0">and not </span><span class="s1">os.environ.get(</span><span class="s2">&quot;DISPLAY&quot;</span><span class="s1">)</span>
        <span class="s0">and </span><span class="s1">which(</span><span class="s2">&quot;xvfb-run&quot;</span><span class="s1">)</span>
    <span class="s1">):</span>
        <span class="s3"># use_xvfb is 'auto', we're on linux without a display server,</span>
        <span class="s3"># and xvfb-run is available. Use it.</span>
        <span class="s1">xvfb_run_executable = which(</span><span class="s2">&quot;xvfb-run&quot;</span><span class="s1">)</span>
        <span class="s1">executable_list = [xvfb_run_executable] + xvfb_args</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s3"># Do not use xvfb</span>
        <span class="s1">executable_list = [executable]</span>

    <span class="s3"># Run executable with --help and see if it's our orca</span>
    <span class="s3"># ---------------------------------------------------</span>
    <span class="s1">invalid_executable_msg = </span><span class="s2">&quot;&quot;&quot; 
The orca executable is required in order to export figures as static images, 
but the executable that was found at '{executable}' 
does not seem to be a valid plotly orca executable. Please refer to the end of 
this message for details on what went wrong. 
 
{instructions}&quot;&quot;&quot;</span><span class="s1">.format(</span>
        <span class="s1">executable=executable</span><span class="s0">, </span><span class="s1">instructions=install_location_instructions</span>
    <span class="s1">)</span>

    <span class="s3"># ### Run with Popen so we get access to stdout and stderr</span>
    <span class="s0">with </span><span class="s1">orca_env():</span>
        <span class="s1">p = subprocess.Popen(</span>
            <span class="s1">executable_list + [</span><span class="s2">&quot;--help&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">stdout=subprocess.PIPE</span><span class="s0">, </span><span class="s1">stderr=subprocess.PIPE</span>
        <span class="s1">)</span>

        <span class="s1">help_result</span><span class="s0">, </span><span class="s1">help_error = p.communicate()</span>

    <span class="s0">if </span><span class="s1">p.returncode != </span><span class="s5">0</span><span class="s1">:</span>
        <span class="s1">err_msg = (</span>
            <span class="s1">invalid_executable_msg</span>
            <span class="s1">+ </span><span class="s2">&quot;&quot;&quot; 
Here is the error that was returned by the command 
    $ {executable} --help 
 
[Return code: {returncode}] 
{err_msg} 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">executable=</span><span class="s2">&quot; &quot;</span><span class="s1">.join(executable_list)</span><span class="s0">,</span>
                <span class="s1">err_msg=help_error.decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">returncode=p.returncode</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s3"># Check for Linux without X installed.</span>
        <span class="s0">if </span><span class="s1">sys.platform.startswith(</span><span class="s2">&quot;linux&quot;</span><span class="s1">) </span><span class="s0">and not </span><span class="s1">os.environ.get(</span><span class="s2">&quot;DISPLAY&quot;</span><span class="s1">):</span>

            <span class="s1">err_msg += </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">Note: When used on Linux, orca requires an X11 display server, but none was 
detected. Please install Xvfb and configure plotly.py to run orca using Xvfb 
as follows: 
 
    &gt;&gt;&gt; import plotly.io as pio 
    &gt;&gt;&gt; pio.orca.config.use_xvfb = True 
 
You can save this configuration for use in future sessions as follows: 
 
    &gt;&gt;&gt; pio.orca.config.save() 
 
See https://www.x.org/releases/X11R7.6/doc/man/man1/Xvfb.1.xhtml 
for more info on Xvfb 
&quot;&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">ValueError(err_msg)</span>

    <span class="s0">if not </span><span class="s1">help_result:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s1">invalid_executable_msg</span>
            <span class="s1">+ </span><span class="s2">&quot;&quot;&quot; 
The error encountered is that no output was returned by the command 
    $ {executable} --help 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">executable=</span><span class="s2">&quot; &quot;</span><span class="s1">.join(executable_list)</span>
            <span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s0">if </span><span class="s2">&quot;Plotly's image-exporting utilities&quot; </span><span class="s0">not in </span><span class="s1">help_result.decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">):</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s1">invalid_executable_msg</span>
            <span class="s1">+ </span><span class="s2">&quot;&quot;&quot; 
The error encountered is that unexpected output was returned by the command 
    $ {executable} --help 
 
{help_result} 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">executable=</span><span class="s2">&quot; &quot;</span><span class="s1">.join(executable_list)</span><span class="s0">, </span><span class="s1">help_result=help_result</span>
            <span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s3"># Get orca version</span>
    <span class="s3"># ----------------</span>
    <span class="s3"># ### Run with Popen so we get access to stdout and stderr</span>
    <span class="s0">with </span><span class="s1">orca_env():</span>
        <span class="s1">p = subprocess.Popen(</span>
            <span class="s1">executable_list + [</span><span class="s2">&quot;--version&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">stdout=subprocess.PIPE</span><span class="s0">,</span>
            <span class="s1">stderr=subprocess.PIPE</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">version_result</span><span class="s0">, </span><span class="s1">version_error = p.communicate()</span>

    <span class="s0">if </span><span class="s1">p.returncode != </span><span class="s5">0</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s1">invalid_executable_msg</span>
            <span class="s1">+ </span><span class="s2">&quot;&quot;&quot; 
An error occurred while trying to get the version of the orca executable. 
Here is the command that plotly.py ran to request the version 
    $ {executable} --version 
 
This command returned the following error: 
 
[Return code: {returncode}] 
{err_msg} 
        &quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">executable=</span><span class="s2">&quot; &quot;</span><span class="s1">.join(executable_list)</span><span class="s0">,</span>
                <span class="s1">err_msg=version_error.decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">returncode=p.returncode</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s0">if not </span><span class="s1">version_result:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s1">invalid_executable_msg</span>
            <span class="s1">+ </span><span class="s2">&quot;&quot;&quot; 
The error encountered is that no version was reported by the orca executable. 
Here is the command that plotly.py ran to request the version: 
 
    $ {executable} --version 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">executable=</span><span class="s2">&quot; &quot;</span><span class="s1">.join(executable_list)</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">version_result = version_result.decode()</span>

    <span class="s1">status._props[</span><span class="s2">&quot;executable_list&quot;</span><span class="s1">] = executable_list</span>
    <span class="s1">status._props[</span><span class="s2">&quot;version&quot;</span><span class="s1">] = version_result.strip()</span>
    <span class="s1">status._props[</span><span class="s2">&quot;state&quot;</span><span class="s1">] = </span><span class="s2">&quot;validated&quot;</span>


<span class="s0">def </span><span class="s1">reset_status():</span>
    <span class="s4">&quot;&quot;&quot; 
    Shutdown the running orca server, if any, and reset the orca status 
    to unvalidated. 
 
    This command is only needed if the desired orca executable is changed 
    during an interactive session. 
 
    Returns 
    ------- 
    None 
    &quot;&quot;&quot;</span>
    <span class="s1">shutdown_server()</span>
    <span class="s1">status._props[</span><span class="s2">&quot;executable_list&quot;</span><span class="s1">] = </span><span class="s0">None</span>
    <span class="s1">status._props[</span><span class="s2">&quot;version&quot;</span><span class="s1">] = </span><span class="s0">None</span>
    <span class="s1">status._props[</span><span class="s2">&quot;state&quot;</span><span class="s1">] = </span><span class="s2">&quot;unvalidated&quot;</span>


<span class="s3"># Initialze process control variables</span>
<span class="s3"># -----------------------------------</span>
<span class="s1">orca_lock = threading.Lock()</span>
<span class="s1">orca_state = {</span><span class="s2">&quot;proc&quot;</span><span class="s1">: </span><span class="s0">None, </span><span class="s2">&quot;shutdown_timer&quot;</span><span class="s1">: </span><span class="s0">None</span><span class="s1">}</span>


<span class="s3"># Shutdown</span>
<span class="s3"># --------</span>
<span class="s3"># The @atexit.register annotation ensures that the shutdown function is</span>
<span class="s3"># is run when the Python process is terminated</span>
<span class="s1">@atexit.register</span>
<span class="s0">def </span><span class="s1">cleanup():</span>
    <span class="s1">shutdown_server()</span>


<span class="s0">def </span><span class="s1">shutdown_server():</span>
    <span class="s4">&quot;&quot;&quot; 
    Shutdown the running orca server process, if any 
 
    Returns 
    ------- 
    None 
    &quot;&quot;&quot;</span>
    <span class="s3"># Use double-check locking to make sure the properties of orca_state</span>
    <span class="s3"># are updated consistently across threads.</span>
    <span class="s0">if </span><span class="s1">orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">] </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">orca_lock:</span>
            <span class="s0">if </span><span class="s1">orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">] </span><span class="s0">is not None</span><span class="s1">:</span>

                <span class="s3"># We use psutil to kill all child processes of the main orca</span>
                <span class="s3"># process. This prevents any zombie processes from being</span>
                <span class="s3"># left over, and it saves us from needing to write</span>
                <span class="s3"># OS-specific process management code here.</span>

                <span class="s1">parent = psutil.Process(orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">].pid)</span>
                <span class="s0">for </span><span class="s1">child </span><span class="s0">in </span><span class="s1">parent.children(recursive=</span><span class="s0">True</span><span class="s1">):</span>
                    <span class="s0">try</span><span class="s1">:</span>
                        <span class="s1">child.terminate()</span>
                    <span class="s0">except</span><span class="s1">:</span>
                        <span class="s3"># We tried, move on</span>
                        <span class="s0">pass</span>

                <span class="s0">try</span><span class="s1">:</span>
                    <span class="s3"># Kill parent process</span>
                    <span class="s1">orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">].terminate()</span>

                    <span class="s3"># Wait for the process to shutdown</span>
                    <span class="s1">child_status = orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">].wait()</span>
                <span class="s0">except</span><span class="s1">:</span>
                    <span class="s3"># We tried, move on</span>
                    <span class="s0">pass</span>

                <span class="s3"># Update our internal process management state</span>
                <span class="s1">orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">] = </span><span class="s0">None</span>

                <span class="s0">if </span><span class="s1">orca_state[</span><span class="s2">&quot;shutdown_timer&quot;</span><span class="s1">] </span><span class="s0">is not None</span><span class="s1">:</span>
                    <span class="s1">orca_state[</span><span class="s2">&quot;shutdown_timer&quot;</span><span class="s1">].cancel()</span>
                    <span class="s1">orca_state[</span><span class="s2">&quot;shutdown_timer&quot;</span><span class="s1">] = </span><span class="s0">None</span>

                <span class="s1">orca_state[</span><span class="s2">&quot;port&quot;</span><span class="s1">] = </span><span class="s0">None</span>

                <span class="s3"># Update orca.status so the user has an accurate view</span>
                <span class="s3"># of the state of the orca server</span>
                <span class="s1">status._props[</span><span class="s2">&quot;state&quot;</span><span class="s1">] = </span><span class="s2">&quot;validated&quot;</span>
                <span class="s1">status._props[</span><span class="s2">&quot;pid&quot;</span><span class="s1">] = </span><span class="s0">None</span>
                <span class="s1">status._props[</span><span class="s2">&quot;port&quot;</span><span class="s1">] = </span><span class="s0">None</span>
                <span class="s1">status._props[</span><span class="s2">&quot;command&quot;</span><span class="s1">] = </span><span class="s0">None</span>


<span class="s3"># Launch or get server</span>
<span class="s0">def </span><span class="s1">ensure_server():</span>
    <span class="s4">&quot;&quot;&quot; 
    Start an orca server if none is running. If a server is already running, 
    then reset the timeout countdown 
 
    Returns 
    ------- 
    None 
    &quot;&quot;&quot;</span>

    <span class="s3"># Validate psutil</span>
    <span class="s0">if </span><span class="s1">psutil </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">Image generation requires the psutil package. 
 
Install using pip: 
    $ pip install psutil 
 
Install using conda: 
    $ conda install psutil 
&quot;&quot;&quot;</span>
        <span class="s1">)</span>

    <span class="s3"># Validate requests</span>
    <span class="s0">if not </span><span class="s1">get_module(</span><span class="s2">&quot;requests&quot;</span><span class="s1">):</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">Image generation requires the requests package. 
 
Install using pip: 
    $ pip install requests 
 
Install using conda: 
    $ conda install requests 
&quot;&quot;&quot;</span>
        <span class="s1">)</span>

    <span class="s0">if not </span><span class="s1">config.server_url:</span>
        <span class="s3"># Validate orca executable only if server_url is not provided</span>
        <span class="s0">if </span><span class="s1">status.state == </span><span class="s2">&quot;unvalidated&quot;</span><span class="s1">:</span>
            <span class="s1">validate_executable()</span>
        <span class="s3"># Acquire lock to make sure that we keep the properties of orca_state</span>
        <span class="s3"># consistent across threads</span>
        <span class="s0">with </span><span class="s1">orca_lock:</span>
            <span class="s3"># Cancel the current shutdown timer, if any</span>
            <span class="s0">if </span><span class="s1">orca_state[</span><span class="s2">&quot;shutdown_timer&quot;</span><span class="s1">] </span><span class="s0">is not None</span><span class="s1">:</span>
                <span class="s1">orca_state[</span><span class="s2">&quot;shutdown_timer&quot;</span><span class="s1">].cancel()</span>

            <span class="s3"># Start a new server process if none is active</span>
            <span class="s0">if </span><span class="s1">orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">] </span><span class="s0">is None</span><span class="s1">:</span>

                <span class="s3"># Determine server port</span>
                <span class="s0">if </span><span class="s1">config.port </span><span class="s0">is None</span><span class="s1">:</span>
                    <span class="s1">orca_state[</span><span class="s2">&quot;port&quot;</span><span class="s1">] = find_open_port()</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">orca_state[</span><span class="s2">&quot;port&quot;</span><span class="s1">] = config.port</span>

                <span class="s3"># Build orca command list</span>
                <span class="s1">cmd_list = status._props[</span><span class="s2">&quot;executable_list&quot;</span><span class="s1">] + [</span>
                    <span class="s2">&quot;serve&quot;</span><span class="s0">,</span>
                    <span class="s2">&quot;-p&quot;</span><span class="s0">,</span>
                    <span class="s1">str(orca_state[</span><span class="s2">&quot;port&quot;</span><span class="s1">])</span><span class="s0">,</span>
                    <span class="s2">&quot;--plotly&quot;</span><span class="s0">,</span>
                    <span class="s1">config.plotlyjs</span><span class="s0">,</span>
                    <span class="s2">&quot;--graph-only&quot;</span><span class="s0">,</span>
                <span class="s1">]</span>

                <span class="s0">if </span><span class="s1">config.topojson:</span>
                    <span class="s1">cmd_list.extend([</span><span class="s2">&quot;--topojson&quot;</span><span class="s0">, </span><span class="s1">config.topojson])</span>

                <span class="s0">if </span><span class="s1">config.mathjax:</span>
                    <span class="s1">cmd_list.extend([</span><span class="s2">&quot;--mathjax&quot;</span><span class="s0">, </span><span class="s1">config.mathjax])</span>

                <span class="s0">if </span><span class="s1">config.mapbox_access_token:</span>
                    <span class="s1">cmd_list.extend(</span>
                        <span class="s1">[</span><span class="s2">&quot;--mapbox-access-token&quot;</span><span class="s0">, </span><span class="s1">config.mapbox_access_token]</span>
                    <span class="s1">)</span>

                <span class="s3"># Create subprocess that launches the orca server on the</span>
                <span class="s3"># specified port.</span>
                <span class="s1">DEVNULL = open(os.devnull</span><span class="s0">, </span><span class="s2">&quot;wb&quot;</span><span class="s1">)</span>
                <span class="s0">with </span><span class="s1">orca_env():</span>
                    <span class="s1">stderr = DEVNULL </span><span class="s0">if </span><span class="s2">&quot;CI&quot; </span><span class="s0">in </span><span class="s1">os.environ </span><span class="s0">else None  </span><span class="s3"># fix for CI</span>
                    <span class="s1">orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">] = subprocess.Popen(</span>
                        <span class="s1">cmd_list</span><span class="s0">, </span><span class="s1">stdout=DEVNULL</span><span class="s0">, </span><span class="s1">stderr=stderr</span>
                    <span class="s1">)</span>

                <span class="s3"># Update orca.status so the user has an accurate view</span>
                <span class="s3"># of the state of the orca server</span>
                <span class="s1">status._props[</span><span class="s2">&quot;state&quot;</span><span class="s1">] = </span><span class="s2">&quot;running&quot;</span>
                <span class="s1">status._props[</span><span class="s2">&quot;pid&quot;</span><span class="s1">] = orca_state[</span><span class="s2">&quot;proc&quot;</span><span class="s1">].pid</span>
                <span class="s1">status._props[</span><span class="s2">&quot;port&quot;</span><span class="s1">] = orca_state[</span><span class="s2">&quot;port&quot;</span><span class="s1">]</span>
                <span class="s1">status._props[</span><span class="s2">&quot;command&quot;</span><span class="s1">] = cmd_list</span>

            <span class="s3"># Create new shutdown timer if a timeout was specified</span>
            <span class="s0">if </span><span class="s1">config.timeout </span><span class="s0">is not None</span><span class="s1">:</span>
                <span class="s1">t = threading.Timer(config.timeout</span><span class="s0">, </span><span class="s1">shutdown_server)</span>
                <span class="s3"># Make it a daemon thread so that exit won't wait for timer to</span>
                <span class="s3"># complete</span>
                <span class="s1">t.daemon = </span><span class="s0">True</span>
                <span class="s1">t.start()</span>
                <span class="s1">orca_state[</span><span class="s2">&quot;shutdown_timer&quot;</span><span class="s1">] = t</span>


<span class="s1">@tenacity.retry(</span>
    <span class="s1">wait=tenacity.wait_random(min=</span><span class="s5">5</span><span class="s0">, </span><span class="s1">max=</span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">stop=tenacity.stop_after_delay(</span><span class="s5">60000</span><span class="s1">)</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">request_image_with_retrying(**kwargs):</span>
    <span class="s4">&quot;&quot;&quot; 
    Helper method to perform an image request to a running orca server process 
    with retrying logic. 
    &quot;&quot;&quot;</span>
    <span class="s0">from </span><span class="s1">requests </span><span class="s0">import </span><span class="s1">post</span>
    <span class="s0">from </span><span class="s1">plotly.io.json </span><span class="s0">import </span><span class="s1">to_json_plotly</span>

    <span class="s0">if </span><span class="s1">config.server_url:</span>
        <span class="s1">server_url = config.server_url</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">server_url = </span><span class="s2">&quot;http://{hostname}:{port}&quot;</span><span class="s1">.format(</span>
            <span class="s1">hostname=</span><span class="s2">&quot;localhost&quot;</span><span class="s0">, </span><span class="s1">port=orca_state[</span><span class="s2">&quot;port&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>

    <span class="s1">request_params = {k: v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, in </span><span class="s1">kwargs.items() </span><span class="s0">if </span><span class="s1">v </span><span class="s0">is not None</span><span class="s1">}</span>
    <span class="s1">json_str = to_json_plotly(request_params)</span>
    <span class="s1">response = post(server_url + </span><span class="s2">&quot;/&quot;</span><span class="s0">, </span><span class="s1">data=json_str)</span>

    <span class="s0">if </span><span class="s1">response.status_code == </span><span class="s5">522</span><span class="s1">:</span>
        <span class="s3"># On &quot;522: client socket timeout&quot;, return server and keep trying</span>
        <span class="s1">shutdown_server()</span>
        <span class="s1">ensure_server()</span>
        <span class="s0">raise </span><span class="s1">OSError(</span><span class="s2">&quot;522: client socket timeout&quot;</span><span class="s1">)</span>

    <span class="s0">return </span><span class="s1">response</span>


<span class="s0">def </span><span class="s1">to_image(fig</span><span class="s0">, </span><span class="s1">format=</span><span class="s0">None, </span><span class="s1">width=</span><span class="s0">None, </span><span class="s1">height=</span><span class="s0">None, </span><span class="s1">scale=</span><span class="s0">None, </span><span class="s1">validate=</span><span class="s0">True</span><span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Convert a figure to a static image bytes string 
 
    Parameters 
    ---------- 
    fig: 
        Figure object or dict representing a figure 
 
    format: str or None 
        The desired image format. One of 
          - 'png' 
          - 'jpg' or 'jpeg' 
          - 'webp' 
          - 'svg' 
          - 'pdf' 
          - 'eps' (Requires the poppler library to be installed) 
 
        If not specified, will default to `plotly.io.config.default_format` 
 
    width: int or None 
        The width of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the width of the exported image 
        in physical pixels. 
 
        If not specified, will default to `plotly.io.config.default_width` 
 
    height: int or None 
        The height of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the height of the exported image 
        in physical pixels. 
 
        If not specified, will default to `plotly.io.config.default_height` 
 
    scale: int or float or None 
        The scale factor to use when exporting the figure. A scale factor 
        larger than 1.0 will increase the image resolution with respect 
        to the figure's layout pixel dimensions. Whereas as scale factor of 
        less than 1.0 will decrease the image resolution. 
 
        If not specified, will default to `plotly.io.config.default_scale` 
 
    validate: bool 
        True if the figure should be validated before being converted to 
        an image, False otherwise. 
 
    Returns 
    ------- 
    bytes 
        The image data 
    &quot;&quot;&quot;</span>
    <span class="s3"># Make sure orca sever is running</span>
    <span class="s3"># -------------------------------</span>
    <span class="s1">ensure_server()</span>

    <span class="s3"># Handle defaults</span>
    <span class="s3"># ---------------</span>
    <span class="s3"># Apply configuration defaults to unspecified arguments</span>
    <span class="s0">if </span><span class="s1">format </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">format = config.default_format</span>

    <span class="s1">format = validate_coerce_format(format)</span>

    <span class="s0">if </span><span class="s1">scale </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">scale = config.default_scale</span>

    <span class="s0">if </span><span class="s1">width </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">width = config.default_width</span>

    <span class="s0">if </span><span class="s1">height </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">height = config.default_height</span>

    <span class="s3"># Validate figure</span>
    <span class="s3"># ---------------</span>
    <span class="s1">fig_dict = validate_coerce_fig_to_dict(fig</span><span class="s0">, </span><span class="s1">validate)</span>

    <span class="s3"># Request image from server</span>
    <span class="s3"># -------------------------</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">response = request_image_with_retrying(</span>
            <span class="s1">figure=fig_dict</span><span class="s0">, </span><span class="s1">format=format</span><span class="s0">, </span><span class="s1">scale=scale</span><span class="s0">, </span><span class="s1">width=width</span><span class="s0">, </span><span class="s1">height=height</span>
        <span class="s1">)</span>
    <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">err:</span>
        <span class="s3"># Get current status string</span>
        <span class="s1">status_str = repr(status)</span>

        <span class="s0">if </span><span class="s1">config.server_url:</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
Plotly.py was unable to communicate with the orca server at {server_url} 
 
Please check that the server is running and accessible. 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">server_url=config.server_url</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

        <span class="s0">else</span><span class="s1">:</span>
            <span class="s3"># Check if the orca server process exists</span>
            <span class="s1">pid_exists = psutil.pid_exists(status.pid)</span>

            <span class="s3"># Raise error message based on whether the server process existed</span>
            <span class="s0">if </span><span class="s1">pid_exists:</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
For some reason plotly.py was unable to communicate with the 
local orca server process, even though the server process seems to be running. 
 
Please review the process and connection information below: 
 
{info} 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">info=status_str</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s3"># Reset the status so that if the user tries again, we'll try to</span>
                <span class="s3"># start the server again</span>
                <span class="s1">reset_status()</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;&quot;&quot; 
For some reason the orca server process is no longer running. 
 
Please review the process and connection information below: 
 
{info} 
plotly.py will attempt to start the local server process again the next time 
an image export operation is performed. 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                        <span class="s1">info=status_str</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>

    <span class="s3"># Check response</span>
    <span class="s3"># --------------</span>
    <span class="s0">if </span><span class="s1">response.status_code == </span><span class="s5">200</span><span class="s1">:</span>
        <span class="s3"># All good</span>
        <span class="s0">return </span><span class="s1">response.content</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s3"># ### Something went wrong ###</span>
        <span class="s1">err_message = </span><span class="s2">&quot;&quot;&quot; 
The image request was rejected by the orca conversion utility 
with the following error: 
   {status}: {msg} 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
            <span class="s1">status=response.status_code</span><span class="s0">, </span><span class="s1">msg=response.content.decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s3"># ### Try to be helpful ###</span>
        <span class="s3"># Status codes from /src/component/plotly-graph/constants.js in the</span>
        <span class="s3"># orca code base.</span>
        <span class="s3"># statusMsg: {</span>
        <span class="s3">#     400: 'invalid or malformed request syntax',</span>
        <span class="s3">#     522: client socket timeout</span>
        <span class="s3">#     525: 'plotly.js error',</span>
        <span class="s3">#     526: 'plotly.js version 1.11.0 or up required',</span>
        <span class="s3">#     530: 'image conversion error'</span>
        <span class="s3"># }</span>
        <span class="s0">if </span><span class="s1">response.status_code == </span><span class="s5">400 </span><span class="s0">and </span><span class="s1">isinstance(fig</span><span class="s0">, </span><span class="s1">dict) </span><span class="s0">and not </span><span class="s1">validate:</span>
            <span class="s1">err_message += </span><span class="s2">&quot;&quot;&quot; 
Try setting the `validate` argument to True to check for errors in the 
figure specification&quot;&quot;&quot;</span>
        <span class="s0">elif </span><span class="s1">response.status_code == </span><span class="s5">525</span><span class="s1">:</span>
            <span class="s1">any_mapbox = any(</span>
                <span class="s1">[</span>
                    <span class="s1">trace.get(</span><span class="s2">&quot;type&quot;</span><span class="s0">, None</span><span class="s1">) == </span><span class="s2">&quot;scattermapbox&quot;</span>
                    <span class="s0">for </span><span class="s1">trace </span><span class="s0">in </span><span class="s1">fig_dict.get(</span><span class="s2">&quot;data&quot;</span><span class="s0">, </span><span class="s1">[])</span>
                <span class="s1">]</span>
            <span class="s1">)</span>
            <span class="s0">if </span><span class="s1">any_mapbox </span><span class="s0">and </span><span class="s1">config.mapbox_access_token </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s1">err_message += </span><span class="s2">&quot;&quot;&quot; 
Exporting scattermapbox traces requires a mapbox access token. 
Create a token in your mapbox account and then set it using: 
 
&gt;&gt;&gt; plotly.io.orca.config.mapbox_access_token = 'pk.abc...' 
 
If you would like this token to be applied automatically in 
future sessions, then save your orca configuration as follows: 
 
&gt;&gt;&gt; plotly.io.orca.config.save() 
&quot;&quot;&quot;</span>
        <span class="s0">elif </span><span class="s1">response.status_code == </span><span class="s5">530 </span><span class="s0">and </span><span class="s1">format == </span><span class="s2">&quot;eps&quot;</span><span class="s1">:</span>
            <span class="s1">err_message += </span><span class="s2">&quot;&quot;&quot; 
Exporting to EPS format requires the poppler library.  You can install 
poppler on MacOS or Linux with: 
 
    $ conda install poppler 
 
Or, you can install it on MacOS using homebrew with: 
 
    $ brew install poppler 
 
Or, you can install it on Linux using your distribution's package manager to 
install the 'poppler-utils' package. 
 
Unfortunately, we don't yet know of an easy way to install poppler on Windows. 
&quot;&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">ValueError(err_message)</span>


<span class="s0">def </span><span class="s1">write_image(</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">file</span><span class="s0">, </span><span class="s1">format=</span><span class="s0">None, </span><span class="s1">scale=</span><span class="s0">None, </span><span class="s1">width=</span><span class="s0">None, </span><span class="s1">height=</span><span class="s0">None, </span><span class="s1">validate=</span><span class="s0">True</span>
<span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Convert a figure to a static image and write it to a file or writeable 
    object 
 
    Parameters 
    ---------- 
    fig: 
        Figure object or dict representing a figure 
 
    file: str or writeable 
        A string representing a local file path or a writeable object 
        (e.g. a pathlib.Path object or an open file descriptor) 
 
    format: str or None 
        The desired image format. One of 
          - 'png' 
          - 'jpg' or 'jpeg' 
          - 'webp' 
          - 'svg' 
          - 'pdf' 
          - 'eps' (Requires the poppler library to be installed) 
 
        If not specified and `file` is a string then this will default to the 
        file extension. If not specified and `file` is not a string then this 
        will default to `plotly.io.config.default_format` 
 
    width: int or None 
        The width of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the width of the exported image 
        in physical pixels. 
 
        If not specified, will default to `plotly.io.config.default_width` 
 
    height: int or None 
        The height of the exported image in layout pixels. If the `scale` 
        property is 1.0, this will also be the height of the exported image 
        in physical pixels. 
 
        If not specified, will default to `plotly.io.config.default_height` 
 
    scale: int or float or None 
        The scale factor to use when exporting the figure. A scale factor 
        larger than 1.0 will increase the image resolution with respect 
        to the figure's layout pixel dimensions. Whereas as scale factor of 
        less than 1.0 will decrease the image resolution. 
 
        If not specified, will default to `plotly.io.config.default_scale` 
 
    validate: bool 
        True if the figure should be validated before being converted to 
        an image, False otherwise. 
 
    Returns 
    ------- 
    None 
    &quot;&quot;&quot;</span>

    <span class="s3"># Try to cast `file` as a pathlib object `path`.</span>
    <span class="s3"># ----------------------------------------------</span>
    <span class="s0">if </span><span class="s1">isinstance(file</span><span class="s0">, </span><span class="s1">string_types):</span>
        <span class="s3"># Use the standard Path constructor to make a pathlib object.</span>
        <span class="s1">path = Path(file)</span>
    <span class="s0">elif </span><span class="s1">isinstance(file</span><span class="s0">, </span><span class="s1">Path):</span>
        <span class="s3"># `file` is already a Path object.</span>
        <span class="s1">path = file</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s3"># We could not make a Path object out of file. Either `file` is an open file</span>
        <span class="s3"># descriptor with a `write()` method or it's an invalid object.</span>
        <span class="s1">path = </span><span class="s0">None</span>

    <span class="s3"># Infer format if not specified</span>
    <span class="s3"># -----------------------------</span>
    <span class="s0">if </span><span class="s1">path </span><span class="s0">is not None and </span><span class="s1">format </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">ext = path.suffix</span>
        <span class="s0">if </span><span class="s1">ext:</span>
            <span class="s1">format = ext.lstrip(</span><span class="s2">&quot;.&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span>
                <span class="s2">&quot;&quot;&quot; 
Cannot infer image type from output path '{file}'. 
Please add a file extension or specify the type using the format parameter. 
For example: 
 
    &gt;&gt;&gt; import plotly.io as pio 
    &gt;&gt;&gt; pio.write_image(fig, file_path, format='png') 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">file=file</span>
                <span class="s1">)</span>
            <span class="s1">)</span>

    <span class="s3"># Request image</span>
    <span class="s3"># -------------</span>
    <span class="s3"># Do this first so we don't create a file if image conversion fails</span>
    <span class="s1">img_data = to_image(</span>
        <span class="s1">fig</span><span class="s0">, </span><span class="s1">format=format</span><span class="s0">, </span><span class="s1">scale=scale</span><span class="s0">, </span><span class="s1">width=width</span><span class="s0">, </span><span class="s1">height=height</span><span class="s0">, </span><span class="s1">validate=validate</span>
    <span class="s1">)</span>

    <span class="s3"># Open file</span>
    <span class="s3"># ---------</span>
    <span class="s0">if </span><span class="s1">path </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s3"># We previously failed to make sense of `file` as a pathlib object.</span>
        <span class="s3"># Attempt to write to `file` as an open file descriptor.</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">file.write(img_data)</span>
            <span class="s0">return</span>
        <span class="s0">except </span><span class="s1">AttributeError:</span>
            <span class="s0">pass</span>
        <span class="s0">raise </span><span class="s1">ValueError(</span>
            <span class="s2">&quot;&quot;&quot; 
The 'file' argument '{file}' is not a string, pathlib.Path object, or file descriptor. 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
                <span class="s1">file=file</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s3"># We previously succeeded in interpreting `file` as a pathlib object.</span>
        <span class="s3"># Now we can use `write_bytes()`.</span>
        <span class="s1">path.write_bytes(img_data)</span>
</pre>
</body>
</html>