<html>
<head>
<title>test_base_indexer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_base_indexer.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">concat</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.api.indexers </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">BaseIndexer</span><span class="s0">,</span>
    <span class="s1">FixedForwardWindowIndexer</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">pandas.core.indexers.objects </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">ExpandingIndexer</span><span class="s0">,</span>
    <span class="s1">FixedWindowIndexer</span><span class="s0">,</span>
    <span class="s1">VariableOffsetWindowIndexer</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s0">from </span><span class="s1">pandas.tseries.offsets </span><span class="s0">import </span><span class="s1">BusinessDay</span>


<span class="s0">def </span><span class="s1">test_bad_get_window_bounds_signature():</span>
    <span class="s0">class </span><span class="s1">BadIndexer(BaseIndexer):</span>
        <span class="s0">def </span><span class="s1">get_window_bounds(self):</span>
            <span class="s0">return None</span>

    <span class="s1">indexer = BadIndexer()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;BadIndexer does not implement&quot;</span><span class="s1">):</span>
        <span class="s1">Series(range(</span><span class="s3">5</span><span class="s1">)).rolling(indexer)</span>


<span class="s0">def </span><span class="s1">test_expanding_indexer():</span>
    <span class="s1">s = Series(range(</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">indexer = ExpandingIndexer()</span>
    <span class="s1">result = s.rolling(indexer).mean()</span>
    <span class="s1">expected = s.expanding().mean()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_indexer_constructor_arg():</span>
    <span class="s4"># Example found in computation.rst</span>
    <span class="s1">use_expanding = [</span><span class="s0">True, False, True, False, True</span><span class="s1">]</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: range(</span><span class="s3">5</span><span class="s1">)})</span>

    <span class="s0">class </span><span class="s1">CustomIndexer(BaseIndexer):</span>
        <span class="s0">def </span><span class="s1">get_window_bounds(self</span><span class="s0">, </span><span class="s1">num_values</span><span class="s0">, </span><span class="s1">min_periods</span><span class="s0">, </span><span class="s1">center</span><span class="s0">, </span><span class="s1">closed):</span>
            <span class="s1">start = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s1">end = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(num_values):</span>
                <span class="s0">if </span><span class="s1">self.use_expanding[i]:</span>
                    <span class="s1">start[i] = </span><span class="s3">0</span>
                    <span class="s1">end[i] = i + </span><span class="s3">1</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">start[i] = i</span>
                    <span class="s1">end[i] = i + self.window_size</span>
            <span class="s0">return </span><span class="s1">start</span><span class="s0">, </span><span class="s1">end</span>

    <span class="s1">indexer = CustomIndexer(window_size=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">use_expanding=use_expanding)</span>
    <span class="s1">result = df.rolling(indexer).sum()</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">10.0</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_indexer_accepts_rolling_args():</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: range(</span><span class="s3">5</span><span class="s1">)})</span>

    <span class="s0">class </span><span class="s1">CustomIndexer(BaseIndexer):</span>
        <span class="s0">def </span><span class="s1">get_window_bounds(self</span><span class="s0">, </span><span class="s1">num_values</span><span class="s0">, </span><span class="s1">min_periods</span><span class="s0">, </span><span class="s1">center</span><span class="s0">, </span><span class="s1">closed):</span>
            <span class="s1">start = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s1">end = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(num_values):</span>
                <span class="s0">if </span><span class="s1">center </span><span class="s0">and </span><span class="s1">min_periods == </span><span class="s3">1 </span><span class="s0">and </span><span class="s1">closed == </span><span class="s2">&quot;both&quot; </span><span class="s0">and </span><span class="s1">i == </span><span class="s3">2</span><span class="s1">:</span>
                    <span class="s1">start[i] = </span><span class="s3">0</span>
                    <span class="s1">end[i] = num_values</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">start[i] = i</span>
                    <span class="s1">end[i] = i + self.window_size</span>
            <span class="s0">return </span><span class="s1">start</span><span class="s0">, </span><span class="s1">end</span>

    <span class="s1">indexer = CustomIndexer(window_size=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">result = df.rolling(indexer</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;both&quot;</span><span class="s1">).sum()</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">10.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;constructor&quot;</span><span class="s0">, </span><span class="s1">[Series</span><span class="s0">, </span><span class="s1">DataFrame])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func,np_func,expected,np_kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;count&quot;</span><span class="s0">, </span><span class="s1">len</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;min&quot;</span><span class="s0">, </span><span class="s1">np.min</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">8.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;max&quot;</span><span class="s0">,</span>
            <span class="s1">np.max</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">100.0</span><span class="s0">, </span><span class="s3">100.0</span><span class="s0">, </span><span class="s3">100.0</span><span class="s0">, </span><span class="s3">8.0</span><span class="s0">, </span><span class="s3">9.0</span><span class="s0">, </span><span class="s3">9.0</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">{}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;std&quot;</span><span class="s0">,</span>
            <span class="s1">np.std</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">55.71654452</span><span class="s0">,</span>
                <span class="s3">54.85739087</span><span class="s0">,</span>
                <span class="s3">53.9845657</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">0.70710678</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;ddof&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;var&quot;</span><span class="s0">,</span>
            <span class="s1">np.var</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">3104.333333</span><span class="s0">,</span>
                <span class="s3">3009.333333</span><span class="s0">,</span>
                <span class="s3">2914.333333</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">0.500000</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;ddof&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;median&quot;</span><span class="s0">,</span>
            <span class="s1">np.median</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">8.0</span><span class="s0">, </span><span class="s3">8.5</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">{}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore:min_periods:FutureWarning&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_forward_window(constructor</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">np_func</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">np_kwargs):</span>
    <span class="s4"># GH 32865</span>
    <span class="s1">values = np.arange(</span><span class="s3">10.0</span><span class="s1">)</span>
    <span class="s1">values[</span><span class="s3">5</span><span class="s1">] = </span><span class="s3">100.0</span>

    <span class="s1">indexer = FixedForwardWindowIndexer(window_size=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">match = </span><span class="s2">&quot;Forward-looking windows can't have center=True&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">rolling = constructor(values).rolling(window=indexer</span><span class="s0">, </span><span class="s1">center=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">getattr(rolling</span><span class="s0">, </span><span class="s1">func)()</span>

    <span class="s1">match = </span><span class="s2">&quot;Forward-looking windows don't support setting the closed argument&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">rolling = constructor(values).rolling(window=indexer</span><span class="s0">, </span><span class="s1">closed=</span><span class="s2">&quot;right&quot;</span><span class="s1">)</span>
        <span class="s1">getattr(rolling</span><span class="s0">, </span><span class="s1">func)()</span>

    <span class="s1">rolling = constructor(values).rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">result = getattr(rolling</span><span class="s0">, </span><span class="s1">func)()</span>

    <span class="s4"># Check that the function output matches the explicitly provided array</span>
    <span class="s1">expected = constructor(expected)</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># Check that the rolling function output matches applying an alternative</span>
    <span class="s4"># function to the rolling window object</span>
    <span class="s1">expected2 = constructor(rolling.apply(</span><span class="s0">lambda </span><span class="s1">x: np_func(x</span><span class="s0">, </span><span class="s1">**np_kwargs)))</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected2)</span>

    <span class="s4"># Check that the function output matches applying an alternative function</span>
    <span class="s4"># if min_periods isn't specified</span>
    <span class="s4"># GH 39604: After count-min_periods deprecation, apply(lambda x: len(x))</span>
    <span class="s4"># is equivalent to count after setting min_periods=0</span>
    <span class="s1">min_periods = </span><span class="s3">0 </span><span class="s0">if </span><span class="s1">func == </span><span class="s2">&quot;count&quot; </span><span class="s0">else None</span>
    <span class="s1">rolling3 = constructor(values).rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=min_periods)</span>
    <span class="s1">result3 = getattr(rolling3</span><span class="s0">, </span><span class="s1">func)()</span>
    <span class="s1">expected3 = constructor(rolling3.apply(</span><span class="s0">lambda </span><span class="s1">x: np_func(x</span><span class="s0">, </span><span class="s1">**np_kwargs)))</span>
    <span class="s1">tm.assert_equal(result3</span><span class="s0">, </span><span class="s1">expected3)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;constructor&quot;</span><span class="s0">, </span><span class="s1">[Series</span><span class="s0">, </span><span class="s1">DataFrame])</span>
<span class="s0">def </span><span class="s1">test_rolling_forward_skewness(constructor):</span>
    <span class="s1">values = np.arange(</span><span class="s3">10.0</span><span class="s1">)</span>
    <span class="s1">values[</span><span class="s3">5</span><span class="s1">] = </span><span class="s3">100.0</span>

    <span class="s1">indexer = FixedForwardWindowIndexer(window_size=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">rolling = constructor(values).rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">result = rolling.skew()</span>

    <span class="s1">expected = constructor(</span>
        <span class="s1">[</span>
            <span class="s3">0.0</span><span class="s0">,</span>
            <span class="s3">2.232396</span><span class="s0">,</span>
            <span class="s3">2.229508</span><span class="s0">,</span>
            <span class="s3">2.228340</span><span class="s0">,</span>
            <span class="s3">2.229091</span><span class="s0">,</span>
            <span class="s3">2.231989</span><span class="s0">,</span>
            <span class="s3">0.0</span><span class="s0">,</span>
            <span class="s3">0.0</span><span class="s0">,</span>
            <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">np.nan</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;cov&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">97.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">93.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;corr&quot;</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">0.8704775290207161</span><span class="s0">,</span>
                <span class="s3">0.018229084250926637</span><span class="s0">,</span>
                <span class="s1">-</span><span class="s3">0.861357304646493</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s3">1.0</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
                <span class="s1">np.nan</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_forward_cov_corr(func</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">values1 = np.arange(</span><span class="s3">10</span><span class="s1">).reshape(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">values2 = values1 * </span><span class="s3">2</span>
    <span class="s1">values1[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">values = np.concatenate([values1</span><span class="s0">, </span><span class="s1">values2]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">indexer = FixedForwardWindowIndexer(window_size=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">rolling = DataFrame(values).rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s4"># We are interested in checking only pairwise covariance / correlation</span>
    <span class="s1">result = getattr(rolling</span><span class="s0">, </span><span class="s1">func)().loc[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">result = result.reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected = Series(expected)</span>
    <span class="s1">expected.name = result.name</span>
    <span class="s1">tm.assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;closed,expected_data&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s2">&quot;right&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">12.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">8.0</span><span class="s0">, </span><span class="s3">9.0</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">9.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">7.0</span><span class="s0">, </span><span class="s3">8.0</span><span class="s1">]]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_non_fixed_variable_window_indexer(closed</span><span class="s0">, </span><span class="s1">expected_data):</span>
    <span class="s1">index = date_range(</span><span class="s2">&quot;2020&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">df = DataFrame(range(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">offset = BusinessDay(</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">indexer = VariableOffsetWindowIndexer(index=index</span><span class="s0">, </span><span class="s1">offset=offset)</span>
    <span class="s1">result = df.rolling(indexer</span><span class="s0">, </span><span class="s1">closed=closed).sum()</span>
    <span class="s1">expected = DataFrame(expected_data</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_fixed_forward_indexer_count():</span>
    <span class="s4"># GH: 35579</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s0">None, None, None, </span><span class="s3">7</span><span class="s1">]})</span>
    <span class="s1">indexer = FixedForwardWindowIndexer(window_size=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">result = df.rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">0</span><span class="s1">).count()</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">(</span><span class="s2">&quot;end_value&quot;</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize((</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s2">&quot;args&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;median&quot;</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;quantile&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s1">])])</span>
<span class="s0">def </span><span class="s1">test_indexer_quantile_sum(end_value</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">args):</span>
    <span class="s4"># GH 37153</span>
    <span class="s0">class </span><span class="s1">CustomIndexer(BaseIndexer):</span>
        <span class="s0">def </span><span class="s1">get_window_bounds(self</span><span class="s0">, </span><span class="s1">num_values</span><span class="s0">, </span><span class="s1">min_periods</span><span class="s0">, </span><span class="s1">center</span><span class="s0">, </span><span class="s1">closed):</span>
            <span class="s1">start = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s1">end = np.empty(num_values</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(num_values):</span>
                <span class="s0">if </span><span class="s1">self.use_expanding[i]:</span>
                    <span class="s1">start[i] = </span><span class="s3">0</span>
                    <span class="s1">end[i] = max(i + end_value</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">start[i] = i</span>
                    <span class="s1">end[i] = i + self.window_size</span>
            <span class="s0">return </span><span class="s1">start</span><span class="s0">, </span><span class="s1">end</span>

    <span class="s1">use_expanding = [</span><span class="s0">True, False, True, False, True</span><span class="s1">]</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: range(</span><span class="s3">5</span><span class="s1">)})</span>

    <span class="s1">indexer = CustomIndexer(window_size=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">use_expanding=use_expanding)</span>
    <span class="s1">result = getattr(df.rolling(indexer)</span><span class="s0">, </span><span class="s1">func)(*args)</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;values&quot;</span><span class="s1">: values})</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;indexer_class&quot;</span><span class="s0">, </span><span class="s1">[FixedWindowIndexer</span><span class="s0">, </span><span class="s1">FixedForwardWindowIndexer</span><span class="s0">, </span><span class="s1">ExpandingIndexer]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;window_size&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">12</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;df_data&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">16</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan] + list(range(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))}</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_indexers_are_reusable_after_groupby_rolling(</span>
    <span class="s1">indexer_class</span><span class="s0">, </span><span class="s1">window_size</span><span class="s0">, </span><span class="s1">df_data</span>
<span class="s1">):</span>
    <span class="s4"># GH 43267</span>
    <span class="s1">df = DataFrame(df_data)</span>
    <span class="s1">num_trials = </span><span class="s3">3</span>
    <span class="s1">indexer = indexer_class(window_size=window_size)</span>
    <span class="s1">original_window_size = indexer.window_size</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(num_trials):</span>
        <span class="s1">df.groupby(</span><span class="s2">&quot;a&quot;</span><span class="s1">)[</span><span class="s2">&quot;b&quot;</span><span class="s1">].rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).mean()</span>
        <span class="s0">assert </span><span class="s1">indexer.window_size == original_window_size</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;window_size, num_values, expected_start, expected_end&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">list(range(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)) + [</span><span class="s3">12</span><span class="s1">] * </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">12</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">] * </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.array([])</span><span class="s0">, </span><span class="s1">np.array([]))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.array([])</span><span class="s0">, </span><span class="s1">np.array([]))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_fixed_forward_indexer_bounds(</span>
    <span class="s1">window_size</span><span class="s0">, </span><span class="s1">num_values</span><span class="s0">, </span><span class="s1">expected_start</span><span class="s0">, </span><span class="s1">expected_end</span>
<span class="s1">):</span>
    <span class="s4"># GH 43267</span>
    <span class="s1">indexer = FixedForwardWindowIndexer(window_size=window_size)</span>
    <span class="s1">start</span><span class="s0">, </span><span class="s1">end = indexer.get_window_bounds(num_values=num_values)</span>

    <span class="s1">tm.assert_numpy_array_equal(start</span><span class="s0">, </span><span class="s1">np.array(expected_start)</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">tm.assert_numpy_array_equal(end</span><span class="s0">, </span><span class="s1">np.array(expected_end)</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(start) == len(end)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;df, window_size, expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
            <span class="s1">Series(</span>
                <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">index=MultiIndex.from_arrays([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, None</span><span class="s1">])</span><span class="s0">,</span>
                <span class="s1">name=</span><span class="s2">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s1">dtype=np.float64</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">DataFrame(</span>
                <span class="s1">{</span>
                    <span class="s2">&quot;b&quot;</span><span class="s1">: [np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan] + list(range(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">18</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">7 </span><span class="s1">+ [</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">11</span><span class="s0">,</span>
                    <span class="s2">&quot;c&quot;</span><span class="s1">: range(</span><span class="s3">18</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">}</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">12</span><span class="s0">,</span>
            <span class="s1">Series(</span>
                <span class="s1">[</span>
                    <span class="s3">3.6</span><span class="s0">,</span>
                    <span class="s3">3.6</span><span class="s0">,</span>
                    <span class="s3">4.25</span><span class="s0">,</span>
                    <span class="s3">5.0</span><span class="s0">,</span>
                    <span class="s3">5.0</span><span class="s0">,</span>
                    <span class="s3">5.5</span><span class="s0">,</span>
                    <span class="s3">6.0</span><span class="s0">,</span>
                    <span class="s3">12.0</span><span class="s0">,</span>
                    <span class="s3">12.5</span><span class="s0">,</span>
                    <span class="s3">13.0</span><span class="s0">,</span>
                    <span class="s3">13.5</span><span class="s0">,</span>
                    <span class="s3">14.0</span><span class="s0">,</span>
                    <span class="s3">14.5</span><span class="s0">,</span>
                    <span class="s3">15.0</span><span class="s0">,</span>
                    <span class="s3">15.5</span><span class="s0">,</span>
                    <span class="s3">16.0</span><span class="s0">,</span>
                    <span class="s3">16.5</span><span class="s0">,</span>
                    <span class="s3">17.0</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">index=MultiIndex.from_arrays(</span>
                    <span class="s1">[[</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">7 </span><span class="s1">+ [</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">11</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">18</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, None</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">name=</span><span class="s2">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s1">dtype=np.float64</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rolling_groupby_with_fixed_forward_specific(df</span><span class="s0">, </span><span class="s1">window_size</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s4"># GH 43267</span>
    <span class="s1">indexer = FixedForwardWindowIndexer(window_size=window_size)</span>
    <span class="s1">result = df.groupby(</span><span class="s2">&quot;a&quot;</span><span class="s1">)[</span><span class="s2">&quot;b&quot;</span><span class="s1">].rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).mean()</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;group_keys&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">) * </span><span class="s3">4</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">) * </span><span class="s3">5</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;window_size&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">20</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rolling_groupby_with_fixed_forward_many(group_keys</span><span class="s0">, </span><span class="s1">window_size):</span>
    <span class="s4"># GH 43267</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: np.array(list(group_keys))</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: np.arange(len(group_keys)</span><span class="s0">, </span><span class="s1">dtype=np.float64) + </span><span class="s3">17</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: np.arange(len(group_keys)</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">indexer = FixedForwardWindowIndexer(window_size=window_size)</span>
    <span class="s1">result = df.groupby(</span><span class="s2">&quot;a&quot;</span><span class="s1">)[</span><span class="s2">&quot;b&quot;</span><span class="s1">].rolling(window=indexer</span><span class="s0">, </span><span class="s1">min_periods=</span><span class="s3">1</span><span class="s1">).sum()</span>
    <span class="s1">result.index.names = [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span>

    <span class="s1">groups = df.groupby(</span><span class="s2">&quot;a&quot;</span><span class="s1">)[[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]]</span>
    <span class="s1">manual = concat(</span>
        <span class="s1">[</span>
            <span class="s1">g.assign(</span>
                <span class="s1">b=[</span>
                    <span class="s1">g[</span><span class="s2">&quot;b&quot;</span><span class="s1">].iloc[i : i + window_size].sum(min_count=</span><span class="s3">1</span><span class="s1">)</span>
                    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(g))</span>
                <span class="s1">]</span>
            <span class="s1">)</span>
            <span class="s0">for </span><span class="s1">_</span><span class="s0">, </span><span class="s1">g </span><span class="s0">in </span><span class="s1">groups</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">manual = manual.set_index([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])[</span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>

    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">manual)</span>


<span class="s0">def </span><span class="s1">test_unequal_start_end_bounds():</span>
    <span class="s0">class </span><span class="s1">CustomIndexer(BaseIndexer):</span>
        <span class="s0">def </span><span class="s1">get_window_bounds(self</span><span class="s0">, </span><span class="s1">num_values</span><span class="s0">, </span><span class="s1">min_periods</span><span class="s0">, </span><span class="s1">center</span><span class="s0">, </span><span class="s1">closed):</span>
            <span class="s0">return </span><span class="s1">np.array([</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">indexer = CustomIndexer()</span>
    <span class="s1">roll = Series(</span><span class="s3">1</span><span class="s1">).rolling(indexer)</span>
    <span class="s1">match = </span><span class="s2">&quot;start&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">roll.mean()</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">next(iter(roll))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">roll.corr(pairwise=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">roll.cov(pairwise=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_unequal_bounds_to_object():</span>
    <span class="s4"># GH 44470</span>
    <span class="s0">class </span><span class="s1">CustomIndexer(BaseIndexer):</span>
        <span class="s0">def </span><span class="s1">get_window_bounds(self</span><span class="s0">, </span><span class="s1">num_values</span><span class="s0">, </span><span class="s1">min_periods</span><span class="s0">, </span><span class="s1">center</span><span class="s0">, </span><span class="s1">closed):</span>
            <span class="s0">return </span><span class="s1">np.array([</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">indexer = CustomIndexer()</span>
    <span class="s1">roll = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]).rolling(indexer)</span>
    <span class="s1">match = </span><span class="s2">&quot;start and end&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">roll.mean()</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">next(iter(roll))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">roll.corr(pairwise=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">roll.cov(pairwise=</span><span class="s0">True</span><span class="s1">)</span>
</pre>
</body>
</html>