<html>
<head>
<title>shapeannotation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
shapeannotation.py</font>
</center></td></tr></table>
<pre><span class="s0"># some functions defined here to avoid numpy import</span>


<span class="s2">def </span><span class="s1">_mean(x):</span>
    <span class="s2">if </span><span class="s1">len(x) == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">&quot;x must have positive length&quot;</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">float(sum(x)) / len(x)</span>


<span class="s2">def </span><span class="s1">_argmin(x):</span>
    <span class="s2">return </span><span class="s1">sorted(enumerate(x)</span><span class="s2">, </span><span class="s1">key=</span><span class="s2">lambda </span><span class="s1">t: t[</span><span class="s3">1</span><span class="s1">])[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span>


<span class="s2">def </span><span class="s1">_argmax(x):</span>
    <span class="s2">return </span><span class="s1">sorted(enumerate(x)</span><span class="s2">, </span><span class="s1">key=</span><span class="s2">lambda </span><span class="s1">t: t[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">reverse=</span><span class="s2">True</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span>


<span class="s2">def </span><span class="s1">_df_anno(xanchor</span><span class="s2">, </span><span class="s1">yanchor</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y):</span>
    <span class="s5">&quot;&quot;&quot; Default annotation parameters &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">dict(xanchor=xanchor</span><span class="s2">, </span><span class="s1">yanchor=yanchor</span><span class="s2">, </span><span class="s1">x=x</span><span class="s2">, </span><span class="s1">y=y</span><span class="s2">, </span><span class="s1">showarrow=</span><span class="s2">False</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">_add_inside_to_position(pos):</span>
    <span class="s2">if not </span><span class="s1">(</span><span class="s4">&quot;inside&quot; </span><span class="s2">in </span><span class="s1">pos </span><span class="s2">or </span><span class="s4">&quot;outside&quot; </span><span class="s2">in </span><span class="s1">pos):</span>
        <span class="s1">pos.add(</span><span class="s4">&quot;inside&quot;</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">pos</span>


<span class="s2">def </span><span class="s1">_prepare_position(position</span><span class="s2">, </span><span class="s1">prepend_inside=</span><span class="s2">False</span><span class="s1">):</span>
    <span class="s2">if </span><span class="s1">position </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s1">position = </span><span class="s4">&quot;top right&quot;</span>
    <span class="s1">pos_str = position</span>
    <span class="s1">position = set(position.split(</span><span class="s4">&quot; &quot;</span><span class="s1">))</span>
    <span class="s2">if </span><span class="s1">prepend_inside:</span>
        <span class="s1">position = _add_inside_to_position(position)</span>
    <span class="s2">return </span><span class="s1">position</span><span class="s2">, </span><span class="s1">pos_str</span>


<span class="s2">def </span><span class="s1">annotation_params_for_line(shape_type</span><span class="s2">, </span><span class="s1">shape_args</span><span class="s2">, </span><span class="s1">position):</span>
    <span class="s0"># all x0, x1, y0, y1 are used to place the annotation, that way it could</span>
    <span class="s0"># work with a slanted line</span>
    <span class="s0"># even with a slanted line, there are the horizontal and vertical</span>
    <span class="s0"># conventions of placing a shape</span>
    <span class="s1">x0 = shape_args[</span><span class="s4">&quot;x0&quot;</span><span class="s1">]</span>
    <span class="s1">x1 = shape_args[</span><span class="s4">&quot;x1&quot;</span><span class="s1">]</span>
    <span class="s1">y0 = shape_args[</span><span class="s4">&quot;y0&quot;</span><span class="s1">]</span>
    <span class="s1">y1 = shape_args[</span><span class="s4">&quot;y1&quot;</span><span class="s1">]</span>
    <span class="s1">X = [x0</span><span class="s2">, </span><span class="s1">x1]</span>
    <span class="s1">Y = [y0</span><span class="s2">, </span><span class="s1">y1]</span>
    <span class="s1">R = </span><span class="s4">&quot;right&quot;</span>
    <span class="s1">T = </span><span class="s4">&quot;top&quot;</span>
    <span class="s1">L = </span><span class="s4">&quot;left&quot;</span>
    <span class="s1">C = </span><span class="s4">&quot;center&quot;</span>
    <span class="s1">B = </span><span class="s4">&quot;bottom&quot;</span>
    <span class="s1">M = </span><span class="s4">&quot;middle&quot;</span>
    <span class="s1">aY = max(Y)</span>
    <span class="s1">iY = min(Y)</span>
    <span class="s1">eY = _mean(Y)</span>
    <span class="s1">aaY = _argmax(Y)</span>
    <span class="s1">aiY = _argmin(Y)</span>
    <span class="s1">aX = max(X)</span>
    <span class="s1">iX = min(X)</span>
    <span class="s1">eX = _mean(X)</span>
    <span class="s1">aaX = _argmax(X)</span>
    <span class="s1">aiX = _argmin(X)</span>
    <span class="s1">position</span><span class="s2">, </span><span class="s1">pos_str = _prepare_position(position)</span>
    <span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;vline&quot;</span><span class="s1">:</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(R</span><span class="s2">, </span><span class="s1">T</span><span class="s2">, </span><span class="s1">X[aaY]</span><span class="s2">, </span><span class="s1">aY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(L</span><span class="s2">, </span><span class="s1">T</span><span class="s2">, </span><span class="s1">X[aaY]</span><span class="s2">, </span><span class="s1">aY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;top&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(C</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">X[aaY]</span><span class="s2">, </span><span class="s1">aY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(R</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">X[aiY]</span><span class="s2">, </span><span class="s1">iY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(L</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">X[aiY]</span><span class="s2">, </span><span class="s1">iY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;bottom&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(C</span><span class="s2">, </span><span class="s1">T</span><span class="s2">, </span><span class="s1">X[aiY]</span><span class="s2">, </span><span class="s1">iY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(R</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">eX</span><span class="s2">, </span><span class="s1">eY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(L</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">eX</span><span class="s2">, </span><span class="s1">eY)</span>
    <span class="s2">elif </span><span class="s1">shape_type == </span><span class="s4">&quot;hline&quot;</span><span class="s1">:</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(L</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">iX</span><span class="s2">, </span><span class="s1">Y[aiX])</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(R</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">aX</span><span class="s2">, </span><span class="s1">Y[aaX])</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;top&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(C</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">eX</span><span class="s2">, </span><span class="s1">eY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(L</span><span class="s2">, </span><span class="s1">T</span><span class="s2">, </span><span class="s1">iX</span><span class="s2">, </span><span class="s1">Y[aiX])</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(R</span><span class="s2">, </span><span class="s1">T</span><span class="s2">, </span><span class="s1">aX</span><span class="s2">, </span><span class="s1">Y[aaX])</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;bottom&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(C</span><span class="s2">, </span><span class="s1">T</span><span class="s2">, </span><span class="s1">eX</span><span class="s2">, </span><span class="s1">eY)</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(R</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">iX</span><span class="s2">, </span><span class="s1">Y[aiX])</span>
        <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
            <span class="s2">return </span><span class="s1">_df_anno(L</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">aX</span><span class="s2">, </span><span class="s1">Y[aaX])</span>
    <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">'Invalid annotation position &quot;%s&quot;' </span><span class="s1">% (pos_str</span><span class="s2">,</span><span class="s1">))</span>


<span class="s2">def </span><span class="s1">annotation_params_for_rect(shape_type</span><span class="s2">, </span><span class="s1">shape_args</span><span class="s2">, </span><span class="s1">position):</span>
    <span class="s1">x0 = shape_args[</span><span class="s4">&quot;x0&quot;</span><span class="s1">]</span>
    <span class="s1">x1 = shape_args[</span><span class="s4">&quot;x1&quot;</span><span class="s1">]</span>
    <span class="s1">y0 = shape_args[</span><span class="s4">&quot;y0&quot;</span><span class="s1">]</span>
    <span class="s1">y1 = shape_args[</span><span class="s4">&quot;y1&quot;</span><span class="s1">]</span>

    <span class="s1">position</span><span class="s2">, </span><span class="s1">pos_str = _prepare_position(position</span><span class="s2">, </span><span class="s1">prepend_inside=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;left&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s1">min([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">max([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s1">max([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">max([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;center&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s1">_mean([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">max([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;left&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s1">min([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">min([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s1">max([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">min([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;center&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s1">_mean([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">min([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;left&quot;</span><span class="s2">, </span><span class="s4">&quot;middle&quot;</span><span class="s2">, </span><span class="s1">min([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">_mean([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s4">&quot;middle&quot;</span><span class="s2">, </span><span class="s1">max([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">_mean([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;inside&quot;</span><span class="s1">]):</span>
        <span class="s0"># TODO: Do we want this?</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;center&quot;</span><span class="s2">, </span><span class="s4">&quot;middle&quot;</span><span class="s2">, </span><span class="s1">_mean([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">_mean([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span>
            <span class="s4">&quot;right&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;vrect&quot; </span><span class="s2">else </span><span class="s4">&quot;left&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;bottom&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;hrect&quot; </span><span class="s2">else </span><span class="s4">&quot;top&quot;</span><span class="s2">,</span>
            <span class="s1">min([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">,</span>
            <span class="s1">max([y0</span><span class="s2">, </span><span class="s1">y1])</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span>
            <span class="s4">&quot;left&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;vrect&quot; </span><span class="s2">else </span><span class="s4">&quot;right&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;bottom&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;hrect&quot; </span><span class="s2">else </span><span class="s4">&quot;top&quot;</span><span class="s2">,</span>
            <span class="s1">max([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">,</span>
            <span class="s1">max([y0</span><span class="s2">, </span><span class="s1">y1])</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;center&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s1">_mean([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">max([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span>
            <span class="s4">&quot;right&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;vrect&quot; </span><span class="s2">else </span><span class="s4">&quot;left&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;top&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;hrect&quot; </span><span class="s2">else </span><span class="s4">&quot;bottom&quot;</span><span class="s2">,</span>
            <span class="s1">min([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">,</span>
            <span class="s1">min([y0</span><span class="s2">, </span><span class="s1">y1])</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span>
            <span class="s4">&quot;left&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;vrect&quot; </span><span class="s2">else </span><span class="s4">&quot;right&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;top&quot; </span><span class="s2">if </span><span class="s1">shape_type == </span><span class="s4">&quot;hrect&quot; </span><span class="s2">else </span><span class="s4">&quot;bottom&quot;</span><span class="s2">,</span>
            <span class="s1">max([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">,</span>
            <span class="s1">min([y0</span><span class="s2">, </span><span class="s1">y1])</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;center&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s1">_mean([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">min([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s4">&quot;middle&quot;</span><span class="s2">, </span><span class="s1">min([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">_mean([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">if </span><span class="s1">position == set([</span><span class="s4">&quot;outside&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s1">]):</span>
        <span class="s2">return </span><span class="s1">_df_anno(</span><span class="s4">&quot;left&quot;</span><span class="s2">, </span><span class="s4">&quot;middle&quot;</span><span class="s2">, </span><span class="s1">max([x0</span><span class="s2">, </span><span class="s1">x1])</span><span class="s2">, </span><span class="s1">_mean([y0</span><span class="s2">, </span><span class="s1">y1]))</span>
    <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">&quot;Invalid annotation position %s&quot; </span><span class="s1">% (pos_str</span><span class="s2">,</span><span class="s1">))</span>


<span class="s2">def </span><span class="s1">axis_spanning_shape_annotation(annotation</span><span class="s2">, </span><span class="s1">shape_type</span><span class="s2">, </span><span class="s1">shape_args</span><span class="s2">, </span><span class="s1">kwargs):</span>
    <span class="s5">&quot;&quot;&quot; 
    annotation: a go.layout.Annotation object, a dict describing an annotation, or None 
    shape_type: one of 'vline', 'hline', 'vrect', 'hrect' and determines how the 
                x, y, xanchor, and yanchor values are set. 
    shape_args: the parameters used to draw the shape, which are used to place the annotation 
    kwargs:     a dictionary that was the kwargs of a 
                _process_multiple_axis_spanning_shapes spanning shapes call. Items in this 
                dict whose keys start with 'annotation_' will be extracted and the keys with 
                the 'annotation_' part stripped off will be used to assign properties of the 
                new annotation. 
 
    Property precedence: 
    The annotation's x, y, xanchor, and yanchor properties are set based on the 
    shape_type argument. Each property already specified in the annotation or 
    through kwargs will be left as is (not replaced by the value computed using 
    shape_type). Note that the xref and yref properties will in general get 
    overwritten if the result of this function is passed to an add_annotation 
    called with the row and col parameters specified. 
 
    Returns an annotation populated with fields based on the 
    annotation_position, annotation_ prefixed kwargs or the original annotation 
    passed in to this function. 
    &quot;&quot;&quot;</span>
    <span class="s0"># set properties based on annotation_ prefixed kwargs</span>
    <span class="s1">prefix = </span><span class="s4">&quot;annotation_&quot;</span>
    <span class="s1">len_prefix = len(prefix)</span>
    <span class="s1">annotation_keys = list(filter(</span><span class="s2">lambda </span><span class="s1">k: k.startswith(prefix)</span><span class="s2">, </span><span class="s1">kwargs.keys()))</span>
    <span class="s0"># If no annotation or annotation-key is specified, return None as we don't</span>
    <span class="s0"># want an annotation in this case</span>
    <span class="s2">if </span><span class="s1">annotation </span><span class="s2">is None and </span><span class="s1">len(annotation_keys) == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s2">return None</span>
    <span class="s0"># TODO: Would it be better if annotation were initialized to an instance of</span>
    <span class="s0"># go.layout.Annotation ?</span>
    <span class="s2">if </span><span class="s1">annotation </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s1">annotation = dict()</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">annotation_keys:</span>
        <span class="s2">if </span><span class="s1">k == </span><span class="s4">&quot;annotation_position&quot;</span><span class="s1">:</span>
            <span class="s0"># don't set so that Annotation constructor doesn't complain</span>
            <span class="s2">continue</span>
        <span class="s1">subk = k[len_prefix:]</span>
        <span class="s1">annotation[subk] = kwargs[k]</span>
    <span class="s0"># set x, y, xanchor, yanchor based on shape_type and position</span>
    <span class="s1">annotation_position = </span><span class="s2">None</span>
    <span class="s2">if </span><span class="s4">&quot;annotation_position&quot; </span><span class="s2">in </span><span class="s1">kwargs.keys():</span>
        <span class="s1">annotation_position = kwargs[</span><span class="s4">&quot;annotation_position&quot;</span><span class="s1">]</span>
    <span class="s2">if </span><span class="s1">shape_type.endswith(</span><span class="s4">&quot;line&quot;</span><span class="s1">):</span>
        <span class="s1">shape_dict = annotation_params_for_line(</span>
            <span class="s1">shape_type</span><span class="s2">, </span><span class="s1">shape_args</span><span class="s2">, </span><span class="s1">annotation_position</span>
        <span class="s1">)</span>
    <span class="s2">elif </span><span class="s1">shape_type.endswith(</span><span class="s4">&quot;rect&quot;</span><span class="s1">):</span>
        <span class="s1">shape_dict = annotation_params_for_rect(</span>
            <span class="s1">shape_type</span><span class="s2">, </span><span class="s1">shape_args</span><span class="s2">, </span><span class="s1">annotation_position</span>
        <span class="s1">)</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">shape_dict.keys():</span>
        <span class="s0"># only set property derived from annotation_position if it hasn't already been set</span>
        <span class="s0"># see above: this would be better as a go.layout.Annotation then the key</span>
        <span class="s0"># would be checked for validity here (otherwise it is checked later,</span>
        <span class="s0"># which I guess is ok too)</span>
        <span class="s2">if </span><span class="s1">(k </span><span class="s2">not in </span><span class="s1">annotation) </span><span class="s2">or </span><span class="s1">(annotation[k] </span><span class="s2">is None</span><span class="s1">):</span>
            <span class="s1">annotation[k] = shape_dict[k]</span>
    <span class="s2">return </span><span class="s1">annotation</span>


<span class="s2">def </span><span class="s1">split_dict_by_key_prefix(d</span><span class="s2">, </span><span class="s1">prefix):</span>
    <span class="s5">&quot;&quot;&quot; 
    Returns two dictionaries, one containing all the items whose keys do not 
    start with a prefix and another containing all the items whose keys do start 
    with the prefix. Note that the prefix is not removed from the keys. 
    &quot;&quot;&quot;</span>
    <span class="s1">no_prefix = dict()</span>
    <span class="s1">with_prefix = dict()</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">d.keys():</span>
        <span class="s2">if </span><span class="s1">k.startswith(prefix):</span>
            <span class="s1">with_prefix[k] = d[k]</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">no_prefix[k] = d[k]</span>
    <span class="s2">return </span><span class="s1">(no_prefix</span><span class="s2">, </span><span class="s1">with_prefix)</span>
</pre>
</body>
</html>