<html>
<head>
<title>test_numerictypes.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #a5c261;}
.s6 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_numerictypes.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">itertools</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_raises</span><span class="s0">, </span><span class="s1">IS_PYPY</span>

<span class="s2"># This is the structure of the table used for plain objects:</span>
<span class="s2">#</span>
<span class="s2"># +-+-+-+</span>
<span class="s2"># |x|y|z|</span>
<span class="s2"># +-+-+-+</span>

<span class="s2"># Structure of a plain array description:</span>
<span class="s1">Pdescr = [</span>
    <span class="s1">(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">'z'</span><span class="s0">, </span><span class="s3">'u1'</span><span class="s1">)]</span>

<span class="s2"># A plain list of tuples with values for testing:</span>
<span class="s1">PbufferT = [</span>
    <span class="s2"># x     y                  z</span>
    <span class="s1">([</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">6.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]]</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">7.</span><span class="s0">, </span><span class="s4">5.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7.</span><span class="s0">, </span><span class="s4">5.</span><span class="s1">]]</span><span class="s0">, </span><span class="s4">9</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>


<span class="s2"># This is the structure of the table used for nested objects (DON'T PANIC!):</span>
<span class="s2">#</span>
<span class="s2"># +-+---------------------------------+-----+----------+-+-+</span>
<span class="s2"># |x|Info                             |color|info      |y|z|</span>
<span class="s2"># | +-----+--+----------------+----+--+     +----+-----+ | |</span>
<span class="s2"># | |value|y2|Info2           |name|z2|     |Name|Value| | |</span>
<span class="s2"># | |     |  +----+-----+--+--+    |  |     |    |     | | |</span>
<span class="s2"># | |     |  |name|value|y3|z3|    |  |     |    |     | | |</span>
<span class="s2"># +-+-----+--+----+-----+--+--+----+--+-----+----+-----+-+-+</span>
<span class="s2">#</span>

<span class="s2"># The corresponding nested array description:</span>
<span class="s1">Ndescr = [</span>
    <span class="s1">(</span><span class="s3">'x'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">'Info'</span><span class="s0">, </span><span class="s1">[</span>
        <span class="s1">(</span><span class="s3">'value'</span><span class="s0">, </span><span class="s3">'c16'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">'y2'</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">'Info2'</span><span class="s0">, </span><span class="s1">[</span>
            <span class="s1">(</span><span class="s3">'name'</span><span class="s0">, </span><span class="s3">'S2'</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">'value'</span><span class="s0">, </span><span class="s3">'c16'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">'y3'</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">'z3'</span><span class="s0">, </span><span class="s3">'u4'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">'name'</span><span class="s0">, </span><span class="s3">'S2'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">'z2'</span><span class="s0">, </span><span class="s3">'b1'</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">'color'</span><span class="s0">, </span><span class="s3">'S2'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">'info'</span><span class="s0">, </span><span class="s1">[</span>
        <span class="s1">(</span><span class="s3">'Name'</span><span class="s0">, </span><span class="s3">'U8'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">'Value'</span><span class="s0">, </span><span class="s3">'c16'</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">'y'</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">'z'</span><span class="s0">, </span><span class="s3">'u1'</span><span class="s1">)]</span>

<span class="s1">NbufferT = [</span>
    <span class="s2"># x     Info                                                color info        y                  z</span>
    <span class="s2">#       value y2 Info2                            name z2         Name Value</span>
    <span class="s2">#                name   value    y3       z3</span>
    <span class="s1">([</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s4">6j</span><span class="s0">, </span><span class="s4">6.</span><span class="s0">, </span><span class="s1">(</span><span class="s5">b'nn'</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6j</span><span class="s0">, </span><span class="s4">4j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s5">b'NN'</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'cc'</span><span class="s0">, </span><span class="s1">(</span><span class="s3">u'NN'</span><span class="s0">, </span><span class="s4">6j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">6.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">6.</span><span class="s0">, </span><span class="s4">4.</span><span class="s1">]]</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s4">7j</span><span class="s0">, </span><span class="s4">7.</span><span class="s0">, </span><span class="s1">(</span><span class="s5">b'oo'</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7j</span><span class="s0">, </span><span class="s4">5j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7.</span><span class="s0">, </span><span class="s4">5.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s5">b'OO'</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'dd'</span><span class="s0">, </span><span class="s1">(</span><span class="s3">u'OO'</span><span class="s0">, </span><span class="s4">7j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">7.</span><span class="s0">, </span><span class="s4">5.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">7.</span><span class="s0">, </span><span class="s4">5.</span><span class="s1">]]</span><span class="s0">, </span><span class="s4">9</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>


<span class="s1">byteorder = {</span><span class="s3">'little'</span><span class="s1">:</span><span class="s3">'&lt;'</span><span class="s0">, </span><span class="s3">'big'</span><span class="s1">:</span><span class="s3">'&gt;'</span><span class="s1">}[sys.byteorder]</span>

<span class="s0">def </span><span class="s1">normalize_descr(descr):</span>
    <span class="s6">&quot;Normalize a description adding the platform byteorder.&quot;</span>

    <span class="s1">out = []</span>
    <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">descr:</span>
        <span class="s1">dtype = item[</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">isinstance(dtype</span><span class="s0">, </span><span class="s1">str):</span>
            <span class="s0">if </span><span class="s1">dtype[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">not in </span><span class="s1">[</span><span class="s3">'|'</span><span class="s0">, </span><span class="s3">'&lt;'</span><span class="s0">, </span><span class="s3">'&gt;'</span><span class="s1">]:</span>
                <span class="s1">onebyte = dtype[</span><span class="s4">1</span><span class="s1">:] == </span><span class="s3">&quot;1&quot;</span>
                <span class="s0">if </span><span class="s1">onebyte </span><span class="s0">or </span><span class="s1">dtype[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'S'</span><span class="s0">, </span><span class="s3">'V'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s1">]:</span>
                    <span class="s1">dtype = </span><span class="s3">&quot;|&quot; </span><span class="s1">+ dtype</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">dtype = byteorder + dtype</span>
            <span class="s0">if </span><span class="s1">len(item) &gt; </span><span class="s4">2 </span><span class="s0">and </span><span class="s1">np.prod(item[</span><span class="s4">2</span><span class="s1">]) &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">nitem = (item[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">item[</span><span class="s4">2</span><span class="s1">])</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">nitem = (item[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype)</span>
            <span class="s1">out.append(nitem)</span>
        <span class="s0">elif </span><span class="s1">isinstance(dtype</span><span class="s0">, </span><span class="s1">list):</span>
            <span class="s1">l = normalize_descr(dtype)</span>
            <span class="s1">out.append((item[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">l))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s3">&quot;Expected a str or list and got %s&quot; </span><span class="s1">%</span>
                             <span class="s1">(type(item)))</span>
    <span class="s0">return </span><span class="s1">out</span>


<span class="s2">############################################################</span>
<span class="s2">#    Creation tests</span>
<span class="s2">############################################################</span>

<span class="s0">class </span><span class="s1">CreateZeros:</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays zero-valued&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_zeros0D(self):</span>
        <span class="s6">&quot;&quot;&quot;Check creation of 0-dimensional objects&quot;&quot;&quot;</span>
        <span class="s1">h = np.zeros(()</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(normalize_descr(self._descr) == h.dtype.descr)</span>
        <span class="s1">assert_(h.dtype.fields[</span><span class="s3">'x'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">].name[:</span><span class="s4">4</span><span class="s1">] == </span><span class="s3">'void'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype.fields[</span><span class="s3">'x'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">].char == </span><span class="s3">'V'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype.fields[</span><span class="s3">'x'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">].type == np.void)</span>
        <span class="s2"># A small check that data is ok</span>
        <span class="s1">assert_equal(h[</span><span class="s3">'z'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.zeros(()</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_zerosSD(self):</span>
        <span class="s6">&quot;&quot;&quot;Check creation of single-dimensional objects&quot;&quot;&quot;</span>
        <span class="s1">h = np.zeros((</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(normalize_descr(self._descr) == h.dtype.descr)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'y'</span><span class="s1">].name[:</span><span class="s4">4</span><span class="s1">] == </span><span class="s3">'void'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'y'</span><span class="s1">].char == </span><span class="s3">'V'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'y'</span><span class="s1">].type == np.void)</span>
        <span class="s2"># A small check that data is ok</span>
        <span class="s1">assert_equal(h[</span><span class="s3">'z'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_zerosMD(self):</span>
        <span class="s6">&quot;&quot;&quot;Check creation of multi-dimensional objects&quot;&quot;&quot;</span>
        <span class="s1">h = np.zeros((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(normalize_descr(self._descr) == h.dtype.descr)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'z'</span><span class="s1">].name == </span><span class="s3">'uint8'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'z'</span><span class="s1">].char == </span><span class="s3">'B'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'z'</span><span class="s1">].type == np.uint8)</span>
        <span class="s2"># A small check that data is ok</span>
        <span class="s1">assert_equal(h[</span><span class="s3">'z'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestCreateZerosPlain(CreateZeros):</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays zero-valued (plain)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Pdescr</span>

<span class="s0">class </span><span class="s1">TestCreateZerosNested(CreateZeros):</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays zero-valued (nested)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Ndescr</span>


<span class="s0">class </span><span class="s1">CreateValues:</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays with values&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_tuple(self):</span>
        <span class="s6">&quot;&quot;&quot;Check creation from tuples&quot;&quot;&quot;</span>
        <span class="s1">h = np.array(self._buffer</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(normalize_descr(self._descr) == h.dtype.descr)</span>
        <span class="s0">if </span><span class="s1">self.multiple_rows:</span>
            <span class="s1">assert_(h.shape == (</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_(h.shape == ())</span>

    <span class="s0">def </span><span class="s1">test_list_of_tuple(self):</span>
        <span class="s6">&quot;&quot;&quot;Check creation from list of tuples&quot;&quot;&quot;</span>
        <span class="s1">h = np.array([self._buffer]</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(normalize_descr(self._descr) == h.dtype.descr)</span>
        <span class="s0">if </span><span class="s1">self.multiple_rows:</span>
            <span class="s1">assert_(h.shape == (</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_(h.shape == (</span><span class="s4">1</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_list_of_list_of_tuple(self):</span>
        <span class="s6">&quot;&quot;&quot;Check creation from list of list of tuples&quot;&quot;&quot;</span>
        <span class="s1">h = np.array([[self._buffer]]</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(normalize_descr(self._descr) == h.dtype.descr)</span>
        <span class="s0">if </span><span class="s1">self.multiple_rows:</span>
            <span class="s1">assert_(h.shape == (</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_(h.shape == (</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestCreateValuesPlainSingle(CreateValues):</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays (plain, single row)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Pdescr</span>
    <span class="s1">multiple_rows = </span><span class="s4">0</span>
    <span class="s1">_buffer = PbufferT[</span><span class="s4">0</span><span class="s1">]</span>

<span class="s0">class </span><span class="s1">TestCreateValuesPlainMultiple(CreateValues):</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays (plain, multiple rows)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Pdescr</span>
    <span class="s1">multiple_rows = </span><span class="s4">1</span>
    <span class="s1">_buffer = PbufferT</span>

<span class="s0">class </span><span class="s1">TestCreateValuesNestedSingle(CreateValues):</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays (nested, single row)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Ndescr</span>
    <span class="s1">multiple_rows = </span><span class="s4">0</span>
    <span class="s1">_buffer = NbufferT[</span><span class="s4">0</span><span class="s1">]</span>

<span class="s0">class </span><span class="s1">TestCreateValuesNestedMultiple(CreateValues):</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays (nested, multiple rows)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Ndescr</span>
    <span class="s1">multiple_rows = </span><span class="s4">1</span>
    <span class="s1">_buffer = NbufferT</span>


<span class="s2">############################################################</span>
<span class="s2">#    Reading tests</span>
<span class="s2">############################################################</span>

<span class="s0">class </span><span class="s1">ReadValuesPlain:</span>
    <span class="s6">&quot;&quot;&quot;Check the reading of values in heterogeneous arrays (plain)&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_access_fields(self):</span>
        <span class="s1">h = np.array(self._buffer</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s0">if not </span><span class="s1">self.multiple_rows:</span>
            <span class="s1">assert_(h.shape == ())</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'x'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array(self._buffer[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i4'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'y'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array(self._buffer[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'z'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array(self._buffer[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_(len(h) == </span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'x'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                                             <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i4'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'y'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                             <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'z'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                                             <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestReadValuesPlainSingle(ReadValuesPlain):</span>
    <span class="s6">&quot;&quot;&quot;Check the creation of heterogeneous arrays (plain, single row)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Pdescr</span>
    <span class="s1">multiple_rows = </span><span class="s4">0</span>
    <span class="s1">_buffer = PbufferT[</span><span class="s4">0</span><span class="s1">]</span>

<span class="s0">class </span><span class="s1">TestReadValuesPlainMultiple(ReadValuesPlain):</span>
    <span class="s6">&quot;&quot;&quot;Check the values of heterogeneous arrays (plain, multiple rows)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Pdescr</span>
    <span class="s1">multiple_rows = </span><span class="s4">1</span>
    <span class="s1">_buffer = PbufferT</span>

<span class="s0">class </span><span class="s1">ReadValuesNested:</span>
    <span class="s6">&quot;&quot;&quot;Check the reading of values in heterogeneous arrays (nested)&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_access_top_fields(self):</span>
        <span class="s6">&quot;&quot;&quot;Check reading the top fields of a nested array&quot;&quot;&quot;</span>
        <span class="s1">h = np.array(self._buffer</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s0">if not </span><span class="s1">self.multiple_rows:</span>
            <span class="s1">assert_(h.shape == ())</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'x'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array(self._buffer[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i4'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'y'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array(self._buffer[</span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'z'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array(self._buffer[</span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_(len(h) == </span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'x'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                                           <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i4'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'y'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">4</span><span class="s1">]</span><span class="s0">,</span>
                                           <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'z'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">5</span><span class="s1">]</span><span class="s0">,</span>
                                           <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_nested1_acessors(self):</span>
        <span class="s6">&quot;&quot;&quot;Check reading the nested fields of a nested array (1st level)&quot;&quot;&quot;</span>
        <span class="s1">h = np.array(self._buffer</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s0">if not </span><span class="s1">self.multiple_rows:</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array(self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'c16'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'y2'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array(self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'info'</span><span class="s1">][</span><span class="s3">'Name'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array(self._buffer[</span><span class="s4">3</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'U2'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'info'</span><span class="s1">][</span><span class="s3">'Value'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array(self._buffer[</span><span class="s4">3</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'c16'</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]]</span><span class="s0">,</span>
                                <span class="s1">dtype=</span><span class="s3">'c16'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'y2'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                                <span class="s1">dtype=</span><span class="s3">'f8'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'info'</span><span class="s1">][</span><span class="s3">'Name'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">3</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">3</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]]</span><span class="s0">,</span>
                               <span class="s1">dtype=</span><span class="s3">'U2'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'info'</span><span class="s1">][</span><span class="s3">'Value'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">3</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">3</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                               <span class="s1">dtype=</span><span class="s3">'c16'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_nested2_acessors(self):</span>
        <span class="s6">&quot;&quot;&quot;Check reading the nested fields of a nested array (2nd level)&quot;&quot;&quot;</span>
        <span class="s1">h = np.array(self._buffer</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s0">if not </span><span class="s1">self.multiple_rows:</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'Info2'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array(self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">2</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'c16'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'Info2'</span><span class="s1">][</span><span class="s3">'z3'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array(self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">2</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u4'</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'Info2'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">2</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">2</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
                               <span class="s1">dtype=</span><span class="s3">'c16'</span><span class="s1">))</span>
            <span class="s1">assert_equal(h[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'Info2'</span><span class="s1">][</span><span class="s3">'z3'</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">np.array([self._buffer[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">2</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">self._buffer[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">2</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]]</span><span class="s0">,</span>
                               <span class="s1">dtype=</span><span class="s3">'u4'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_nested1_descriptor(self):</span>
        <span class="s6">&quot;&quot;&quot;Check access nested descriptors of a nested array (1st level)&quot;&quot;&quot;</span>
        <span class="s1">h = np.array(self._buffer</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">].name == </span><span class="s3">'complex128'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'y2'</span><span class="s1">].name == </span><span class="s3">'float64'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'info'</span><span class="s1">][</span><span class="s3">'Name'</span><span class="s1">].name == </span><span class="s3">'str256'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'info'</span><span class="s1">][</span><span class="s3">'Value'</span><span class="s1">].name == </span><span class="s3">'complex128'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_nested2_descriptor(self):</span>
        <span class="s6">&quot;&quot;&quot;Check access nested descriptors of a nested array (2nd level)&quot;&quot;&quot;</span>
        <span class="s1">h = np.array(self._buffer</span><span class="s0">, </span><span class="s1">dtype=self._descr)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'Info2'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">].name == </span><span class="s3">'void256'</span><span class="s1">)</span>
        <span class="s1">assert_(h.dtype[</span><span class="s3">'Info'</span><span class="s1">][</span><span class="s3">'Info2'</span><span class="s1">][</span><span class="s3">'z3'</span><span class="s1">].name == </span><span class="s3">'void64'</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestReadValuesNestedSingle(ReadValuesNested):</span>
    <span class="s6">&quot;&quot;&quot;Check the values of heterogeneous arrays (nested, single row)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Ndescr</span>
    <span class="s1">multiple_rows = </span><span class="s0">False</span>
    <span class="s1">_buffer = NbufferT[</span><span class="s4">0</span><span class="s1">]</span>

<span class="s0">class </span><span class="s1">TestReadValuesNestedMultiple(ReadValuesNested):</span>
    <span class="s6">&quot;&quot;&quot;Check the values of heterogeneous arrays (nested, multiple rows)&quot;&quot;&quot;</span>
    <span class="s1">_descr = Ndescr</span>
    <span class="s1">multiple_rows = </span><span class="s0">True</span>
    <span class="s1">_buffer = NbufferT</span>

<span class="s0">class </span><span class="s1">TestEmptyField:</span>
    <span class="s0">def </span><span class="s1">test_assign(self):</span>
        <span class="s1">a = np.arange(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
        <span class="s1">a.dtype = [(</span><span class="s3">&quot;int&quot;</span><span class="s0">,   </span><span class="s3">&quot;&lt;0i4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;float&quot;</span><span class="s0">, </span><span class="s3">&quot;&lt;2f4&quot;</span><span class="s1">)]</span>
        <span class="s1">assert_(a[</span><span class="s3">'int'</span><span class="s1">].shape == (</span><span class="s4">5</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">assert_(a[</span><span class="s3">'float'</span><span class="s1">].shape == (</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

<span class="s0">class </span><span class="s1">TestCommonType:</span>
    <span class="s0">def </span><span class="s1">test_scalar_loses1(self):</span>
        <span class="s1">res = np.find_common_type([</span><span class="s3">'f4'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s0">, </span><span class="s3">'i2'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'f8'</span><span class="s1">])</span>
        <span class="s1">assert_(res == </span><span class="s3">'f4'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_scalar_loses2(self):</span>
        <span class="s1">res = np.find_common_type([</span><span class="s3">'f4'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'i8'</span><span class="s1">])</span>
        <span class="s1">assert_(res == </span><span class="s3">'f4'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_scalar_wins(self):</span>
        <span class="s1">res = np.find_common_type([</span><span class="s3">'f4'</span><span class="s0">, </span><span class="s3">'f4'</span><span class="s0">, </span><span class="s3">'i2'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'c8'</span><span class="s1">])</span>
        <span class="s1">assert_(res == </span><span class="s3">'c8'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_scalar_wins2(self):</span>
        <span class="s1">res = np.find_common_type([</span><span class="s3">'u4'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s0">, </span><span class="s3">'i4'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'f4'</span><span class="s1">])</span>
        <span class="s1">assert_(res == </span><span class="s3">'f8'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_scalar_wins3(self):  </span><span class="s2"># doesn't go up to 'f16' on purpose</span>
        <span class="s1">res = np.find_common_type([</span><span class="s3">'u8'</span><span class="s0">, </span><span class="s3">'i8'</span><span class="s0">, </span><span class="s3">'i8'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'f8'</span><span class="s1">])</span>
        <span class="s1">assert_(res == </span><span class="s3">'f8'</span><span class="s1">)</span>

<span class="s0">class </span><span class="s1">TestMultipleFields:</span>
    <span class="s0">def </span><span class="s1">setup(self):</span>
        <span class="s1">self.ary = np.array([(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i4,f4,i2,c8'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">_bad_call(self):</span>
        <span class="s0">return </span><span class="s1">self.ary[</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'f1'</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_no_tuple(self):</span>
        <span class="s1">assert_raises(IndexError</span><span class="s0">, </span><span class="s1">self._bad_call)</span>

    <span class="s0">def </span><span class="s1">test_return(self):</span>
        <span class="s1">res = self.ary[[</span><span class="s3">'f0'</span><span class="s0">, </span><span class="s3">'f2'</span><span class="s1">]].tolist()</span>
        <span class="s1">assert_(res == [(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)])</span>


<span class="s0">class </span><span class="s1">TestIsSubDType:</span>
    <span class="s2"># scalar types can be promoted into dtypes</span>
    <span class="s1">wrappers = [np.dtype</span><span class="s0">, lambda </span><span class="s1">x: x]</span>

    <span class="s0">def </span><span class="s1">test_both_abstract(self):</span>
        <span class="s1">assert_(np.issubdtype(np.floating</span><span class="s0">, </span><span class="s1">np.inexact))</span>
        <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.issubdtype(np.inexact</span><span class="s0">, </span><span class="s1">np.floating))</span>

    <span class="s0">def </span><span class="s1">test_same(self):</span>
        <span class="s0">for </span><span class="s1">cls </span><span class="s0">in </span><span class="s1">(np.float32</span><span class="s0">, </span><span class="s1">np.int32):</span>
            <span class="s0">for </span><span class="s1">w1</span><span class="s0">, </span><span class="s1">w2 </span><span class="s0">in </span><span class="s1">itertools.product(self.wrappers</span><span class="s0">, </span><span class="s1">repeat=</span><span class="s4">2</span><span class="s1">):</span>
                <span class="s1">assert_(np.issubdtype(w1(cls)</span><span class="s0">, </span><span class="s1">w2(cls)))</span>

    <span class="s0">def </span><span class="s1">test_subclass(self):</span>
        <span class="s2"># note we cannot promote floating to a dtype, as it would turn into a</span>
        <span class="s2"># concrete type</span>
        <span class="s0">for </span><span class="s1">w </span><span class="s0">in </span><span class="s1">self.wrappers:</span>
            <span class="s1">assert_(np.issubdtype(w(np.float32)</span><span class="s0">, </span><span class="s1">np.floating))</span>
            <span class="s1">assert_(np.issubdtype(w(np.float64)</span><span class="s0">, </span><span class="s1">np.floating))</span>

    <span class="s0">def </span><span class="s1">test_subclass_backwards(self):</span>
        <span class="s0">for </span><span class="s1">w </span><span class="s0">in </span><span class="s1">self.wrappers:</span>
            <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.issubdtype(np.floating</span><span class="s0">, </span><span class="s1">w(np.float32)))</span>
            <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.issubdtype(np.floating</span><span class="s0">, </span><span class="s1">w(np.float64)))</span>

    <span class="s0">def </span><span class="s1">test_sibling_class(self):</span>
        <span class="s0">for </span><span class="s1">w1</span><span class="s0">, </span><span class="s1">w2 </span><span class="s0">in </span><span class="s1">itertools.product(self.wrappers</span><span class="s0">, </span><span class="s1">repeat=</span><span class="s4">2</span><span class="s1">):</span>
            <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.issubdtype(w1(np.float32)</span><span class="s0">, </span><span class="s1">w2(np.float64)))</span>
            <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.issubdtype(w1(np.float64)</span><span class="s0">, </span><span class="s1">w2(np.float32)))</span>

    <span class="s0">def </span><span class="s1">test_nondtype_nonscalartype(self):</span>
        <span class="s2"># See gh-14619 and gh-9505 which introduced the deprecation to fix</span>
        <span class="s2"># this. These tests are directly taken from gh-9505</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.float32</span><span class="s0">, </span><span class="s3">'float64'</span><span class="s1">)</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.float32</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s1">)</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.int32</span><span class="s0">, </span><span class="s1">str)</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.int32</span><span class="s0">, </span><span class="s3">'int64'</span><span class="s1">)</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.str_</span><span class="s0">, </span><span class="s3">'void'</span><span class="s1">)</span>
        <span class="s2"># for the following the correct spellings are</span>
        <span class="s2"># np.integer, np.floating, or np.complexfloating respectively:</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.int8</span><span class="s0">, </span><span class="s1">int)  </span><span class="s2"># np.int8 is never np.int_</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.float32</span><span class="s0">, </span><span class="s1">float)</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.complex64</span><span class="s0">, </span><span class="s1">complex)</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.float32</span><span class="s0">, </span><span class="s3">&quot;float&quot;</span><span class="s1">)</span>
        <span class="s0">assert not </span><span class="s1">np.issubdtype(np.float64</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">)</span>

        <span class="s2"># Test the same for the correct first datatype and abstract one</span>
        <span class="s2"># in the case of int, float, complex:</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.float64</span><span class="s0">, </span><span class="s3">'float64'</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.float64</span><span class="s0">, </span><span class="s3">'f8'</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.str_</span><span class="s0">, </span><span class="s1">str)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.int64</span><span class="s0">, </span><span class="s3">'int64'</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.void</span><span class="s0">, </span><span class="s3">'void'</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.int8</span><span class="s0">, </span><span class="s1">np.integer)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.float32</span><span class="s0">, </span><span class="s1">np.floating)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.complex64</span><span class="s0">, </span><span class="s1">np.complexfloating)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.float64</span><span class="s0">, </span><span class="s3">&quot;float&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.issubdtype(np.float32</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestSctypeDict:</span>
    <span class="s0">def </span><span class="s1">test_longdouble(self):</span>
        <span class="s1">assert_(np.sctypeDict[</span><span class="s3">'f8'</span><span class="s1">] </span><span class="s0">is not </span><span class="s1">np.longdouble)</span>
        <span class="s1">assert_(np.sctypeDict[</span><span class="s3">'c16'</span><span class="s1">] </span><span class="s0">is not </span><span class="s1">np.clongdouble)</span>


<span class="s0">class </span><span class="s1">TestBitName:</span>
    <span class="s0">def </span><span class="s1">test_abstract(self):</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.core.numerictypes.bitname</span><span class="s0">, </span><span class="s1">np.floating)</span>


<span class="s0">class </span><span class="s1">TestMaximumSctype:</span>

    <span class="s2"># note that parametrizing with sctype['int'] and similar would skip types</span>
    <span class="s2"># with the same size (gh-11923)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">[np.byte</span><span class="s0">, </span><span class="s1">np.short</span><span class="s0">, </span><span class="s1">np.intc</span><span class="s0">, </span><span class="s1">np.int_</span><span class="s0">, </span><span class="s1">np.longlong])</span>
    <span class="s0">def </span><span class="s1">test_int(self</span><span class="s0">, </span><span class="s1">t):</span>
        <span class="s1">assert_equal(np.maximum_sctype(t)</span><span class="s0">, </span><span class="s1">np.sctypes[</span><span class="s3">'int'</span><span class="s1">][-</span><span class="s4">1</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">[np.ubyte</span><span class="s0">, </span><span class="s1">np.ushort</span><span class="s0">, </span><span class="s1">np.uintc</span><span class="s0">, </span><span class="s1">np.uint</span><span class="s0">, </span><span class="s1">np.ulonglong])</span>
    <span class="s0">def </span><span class="s1">test_uint(self</span><span class="s0">, </span><span class="s1">t):</span>
        <span class="s1">assert_equal(np.maximum_sctype(t)</span><span class="s0">, </span><span class="s1">np.sctypes[</span><span class="s3">'uint'</span><span class="s1">][-</span><span class="s4">1</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">[np.half</span><span class="s0">, </span><span class="s1">np.single</span><span class="s0">, </span><span class="s1">np.double</span><span class="s0">, </span><span class="s1">np.longdouble])</span>
    <span class="s0">def </span><span class="s1">test_float(self</span><span class="s0">, </span><span class="s1">t):</span>
        <span class="s1">assert_equal(np.maximum_sctype(t)</span><span class="s0">, </span><span class="s1">np.sctypes[</span><span class="s3">'float'</span><span class="s1">][-</span><span class="s4">1</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">[np.csingle</span><span class="s0">, </span><span class="s1">np.cdouble</span><span class="s0">, </span><span class="s1">np.clongdouble])</span>
    <span class="s0">def </span><span class="s1">test_complex(self</span><span class="s0">, </span><span class="s1">t):</span>
        <span class="s1">assert_equal(np.maximum_sctype(t)</span><span class="s0">, </span><span class="s1">np.sctypes[</span><span class="s3">'complex'</span><span class="s1">][-</span><span class="s4">1</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">[np.bool_</span><span class="s0">, </span><span class="s1">np.object_</span><span class="s0">, </span><span class="s1">np.unicode_</span><span class="s0">, </span><span class="s1">np.bytes_</span><span class="s0">, </span><span class="s1">np.void])</span>
    <span class="s0">def </span><span class="s1">test_other(self</span><span class="s0">, </span><span class="s1">t):</span>
        <span class="s1">assert_equal(np.maximum_sctype(t)</span><span class="s0">, </span><span class="s1">t)</span>


<span class="s0">class </span><span class="s1">Test_sctype2char:</span>
    <span class="s2"># This function is old enough that we're really just documenting the quirks</span>
    <span class="s2"># at this point.</span>

    <span class="s0">def </span><span class="s1">test_scalar_type(self):</span>
        <span class="s1">assert_equal(np.sctype2char(np.double)</span><span class="s0">, </span><span class="s3">'d'</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.sctype2char(np.int_)</span><span class="s0">, </span><span class="s3">'l'</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.sctype2char(np.unicode_)</span><span class="s0">, </span><span class="s3">'U'</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.sctype2char(np.bytes_)</span><span class="s0">, </span><span class="s3">'S'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_other_type(self):</span>
        <span class="s1">assert_equal(np.sctype2char(float)</span><span class="s0">, </span><span class="s3">'d'</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.sctype2char(list)</span><span class="s0">, </span><span class="s3">'O'</span><span class="s1">)</span>
        <span class="s1">assert_equal(np.sctype2char(np.ndarray)</span><span class="s0">, </span><span class="s3">'O'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_third_party_scalar_type(self):</span>
        <span class="s0">from </span><span class="s1">numpy.core._rational_tests </span><span class="s0">import </span><span class="s1">rational</span>
        <span class="s1">assert_raises(KeyError</span><span class="s0">, </span><span class="s1">np.sctype2char</span><span class="s0">, </span><span class="s1">rational)</span>
        <span class="s1">assert_raises(KeyError</span><span class="s0">, </span><span class="s1">np.sctype2char</span><span class="s0">, </span><span class="s1">rational(</span><span class="s4">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_array_instance(self):</span>
        <span class="s1">assert_equal(np.sctype2char(np.array([</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s1">]))</span><span class="s0">, </span><span class="s3">'d'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_abstract_type(self):</span>
        <span class="s1">assert_raises(KeyError</span><span class="s0">, </span><span class="s1">np.sctype2char</span><span class="s0">, </span><span class="s1">np.floating)</span>

    <span class="s0">def </span><span class="s1">test_non_type(self):</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.sctype2char</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;rep, expected&quot;</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">(np.int32</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(list</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s4">1.1</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(str</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(np.dtype(np.float64)</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(np.dtype((np.int16</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)))</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(np.dtype([(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">np.int8)])</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_issctype(rep</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s2"># ensure proper identification of scalar</span>
    <span class="s2"># data-types by issctype()</span>
    <span class="s1">actual = np.issctype(rep)</span>
    <span class="s1">assert_equal(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.skipif(sys.flags.optimize &gt; </span><span class="s4">1</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s3">&quot;no docstrings present to inspect when PYTHONOPTIMIZE/Py_OptimizeFlag &gt; 1&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.xfail(IS_PYPY</span><span class="s0">,</span>
                   <span class="s1">reason=</span><span class="s3">&quot;PyPy cannot modify tp_doc after PyType_Ready&quot;</span><span class="s1">)</span>
<span class="s0">class </span><span class="s1">TestDocStrings:</span>
    <span class="s0">def </span><span class="s1">test_platform_dependent_aliases(self):</span>
        <span class="s0">if </span><span class="s1">np.int64 </span><span class="s0">is </span><span class="s1">np.int_:</span>
            <span class="s1">assert_(</span><span class="s3">'int64' </span><span class="s0">in </span><span class="s1">np.int_.__doc__)</span>
        <span class="s0">elif </span><span class="s1">np.int64 </span><span class="s0">is </span><span class="s1">np.longlong:</span>
            <span class="s1">assert_(</span><span class="s3">'int64' </span><span class="s0">in </span><span class="s1">np.longlong.__doc__)</span>


<span class="s0">class </span><span class="s1">TestScalarTypeNames:</span>
    <span class="s2"># gh-9799</span>

    <span class="s1">numeric_types = [</span>
        <span class="s1">np.byte</span><span class="s0">, </span><span class="s1">np.short</span><span class="s0">, </span><span class="s1">np.intc</span><span class="s0">, </span><span class="s1">np.int_</span><span class="s0">, </span><span class="s1">np.longlong</span><span class="s0">,</span>
        <span class="s1">np.ubyte</span><span class="s0">, </span><span class="s1">np.ushort</span><span class="s0">, </span><span class="s1">np.uintc</span><span class="s0">, </span><span class="s1">np.uint</span><span class="s0">, </span><span class="s1">np.ulonglong</span><span class="s0">,</span>
        <span class="s1">np.half</span><span class="s0">, </span><span class="s1">np.single</span><span class="s0">, </span><span class="s1">np.double</span><span class="s0">, </span><span class="s1">np.longdouble</span><span class="s0">,</span>
        <span class="s1">np.csingle</span><span class="s0">, </span><span class="s1">np.cdouble</span><span class="s0">, </span><span class="s1">np.clongdouble</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_names_are_unique(self):</span>
        <span class="s2"># none of the above may be aliases for each other</span>
        <span class="s0">assert </span><span class="s1">len(set(self.numeric_types)) == len(self.numeric_types)</span>

        <span class="s2"># names must be unique</span>
        <span class="s1">names = [t.__name__ </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">self.numeric_types]</span>
        <span class="s0">assert </span><span class="s1">len(set(names)) == len(names)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">numeric_types)</span>
    <span class="s0">def </span><span class="s1">test_names_reflect_attributes(self</span><span class="s0">, </span><span class="s1">t):</span>
        <span class="s6">&quot;&quot;&quot; Test that names correspond to where the type is under ``np.`` &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">getattr(np</span><span class="s0">, </span><span class="s1">t.__name__) </span><span class="s0">is </span><span class="s1">t</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'t'</span><span class="s0">, </span><span class="s1">numeric_types)</span>
    <span class="s0">def </span><span class="s1">test_names_are_undersood_by_dtype(self</span><span class="s0">, </span><span class="s1">t):</span>
        <span class="s6">&quot;&quot;&quot; Test the dtype constructor maps names back to the type &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">np.dtype(t.__name__).type </span><span class="s0">is </span><span class="s1">t</span>
</pre>
</body>
</html>