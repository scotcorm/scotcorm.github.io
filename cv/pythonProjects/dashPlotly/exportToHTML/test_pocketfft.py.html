<html>
<head>
<title>test_pocketfft.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pocketfft.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy.random </span><span class="s0">import </span><span class="s1">random</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(</span>
        <span class="s1">assert_array_equal</span><span class="s0">, </span><span class="s1">assert_raises</span><span class="s0">, </span><span class="s1">assert_allclose</span>
        <span class="s1">)</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">queue</span>


<span class="s0">def </span><span class="s1">fft1(x):</span>
    <span class="s1">L = len(x)</span>
    <span class="s1">phase = -</span><span class="s2">2j </span><span class="s1">* np.pi * (np.arange(L) / L)</span>
    <span class="s1">phase = np.arange(L).reshape(-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">) * phase</span>
    <span class="s0">return </span><span class="s1">np.sum(x*np.exp(phase)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestFFTShift:</span>

    <span class="s0">def </span><span class="s1">test_fft_n(self):</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">np.fft.fft</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestFFT1D:</span>

    <span class="s0">def </span><span class="s1">test_identity(self):</span>
        <span class="s1">maxlen = </span><span class="s2">512</span>
        <span class="s1">x = random(maxlen) + </span><span class="s2">1j</span><span class="s1">*random(maxlen)</span>
        <span class="s1">xr = random(maxlen)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s1">maxlen):</span>
            <span class="s1">assert_allclose(np.fft.ifft(np.fft.fft(x[</span><span class="s2">0</span><span class="s1">:i]))</span><span class="s0">, </span><span class="s1">x[</span><span class="s2">0</span><span class="s1">:i]</span><span class="s0">,</span>
                            <span class="s1">atol=</span><span class="s2">1e-12</span><span class="s1">)</span>
            <span class="s1">assert_allclose(np.fft.irfft(np.fft.rfft(xr[</span><span class="s2">0</span><span class="s1">:i])</span><span class="s0">, </span><span class="s1">i)</span><span class="s0">,</span>
                            <span class="s1">xr[</span><span class="s2">0</span><span class="s1">:i]</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-12</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_fft(self):</span>
        <span class="s1">x = random(</span><span class="s2">30</span><span class="s1">) + </span><span class="s2">1j</span><span class="s1">*random(</span><span class="s2">30</span><span class="s1">)</span>
        <span class="s1">assert_allclose(fft1(x)</span><span class="s0">, </span><span class="s1">np.fft.fft(x)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(fft1(x)</span><span class="s0">, </span><span class="s1">np.fft.fft(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(fft1(x) / np.sqrt(</span><span class="s2">30</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fft(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(fft1(x) / </span><span class="s2">30.</span><span class="s0">,</span>
                        <span class="s1">np.fft.fft(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'norm'</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s3">'backward'</span><span class="s0">, </span><span class="s3">'ortho'</span><span class="s0">, </span><span class="s3">'forward'</span><span class="s1">))</span>
    <span class="s0">def </span><span class="s1">test_ifft(self</span><span class="s0">, </span><span class="s1">norm):</span>
        <span class="s1">x = random(</span><span class="s2">30</span><span class="s1">) + </span><span class="s2">1j</span><span class="s1">*random(</span><span class="s2">30</span><span class="s1">)</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">np.fft.ifft(np.fft.fft(x</span><span class="s0">, </span><span class="s1">norm=norm)</span><span class="s0">, </span><span class="s1">norm=norm)</span><span class="s0">,</span>
            <span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s4"># Ensure we get the correct error message</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">,</span>
                           <span class="s1">match=</span><span class="s3">'Invalid number of FFT data points'</span><span class="s1">):</span>
            <span class="s1">np.fft.ifft([]</span><span class="s0">, </span><span class="s1">norm=norm)</span>

    <span class="s0">def </span><span class="s1">test_fft2(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s1">)) + </span><span class="s2">1j</span><span class="s1">*random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s1">))</span>
        <span class="s1">assert_allclose(np.fft.fft(np.fft.fft(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fft2(x)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.fft2(x)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.fft2(x) / np.sqrt(</span><span class="s2">30 </span><span class="s1">* </span><span class="s2">20</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.fft2(x) / (</span><span class="s2">30. </span><span class="s1">* </span><span class="s2">20.</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_ifft2(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s1">)) + </span><span class="s2">1j</span><span class="s1">*random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s1">))</span>
        <span class="s1">assert_allclose(np.fft.ifft(np.fft.ifft(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.ifft2(x)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.ifft2(x)</span><span class="s0">,</span>
                        <span class="s1">np.fft.ifft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.ifft2(x) * np.sqrt(</span><span class="s2">30 </span><span class="s1">* </span><span class="s2">20</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.ifft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.ifft2(x) * (</span><span class="s2">30. </span><span class="s1">* </span><span class="s2">20.</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.ifft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_fftn(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)) + </span><span class="s2">1j</span><span class="s1">*random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">np.fft.fft(np.fft.fft(np.fft.fft(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.fft.fftn(x)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.fftn(x)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.fftn(x) / np.sqrt(</span><span class="s2">30 </span><span class="s1">* </span><span class="s2">20 </span><span class="s1">* </span><span class="s2">10</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.fftn(x) / (</span><span class="s2">30. </span><span class="s1">* </span><span class="s2">20. </span><span class="s1">* </span><span class="s2">10.</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.fftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_ifftn(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)) + </span><span class="s2">1j</span><span class="s1">*random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">np.fft.ifft(np.fft.ifft(np.fft.ifft(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.fft.ifftn(x)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.ifftn(x)</span><span class="s0">,</span>
                        <span class="s1">np.fft.ifftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.ifftn(x) * np.sqrt(</span><span class="s2">30 </span><span class="s1">* </span><span class="s2">20 </span><span class="s1">* </span><span class="s2">10</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.ifftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.ifftn(x) * (</span><span class="s2">30. </span><span class="s1">* </span><span class="s2">20. </span><span class="s1">* </span><span class="s2">10.</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.ifftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_rfft(self):</span>
        <span class="s1">x = random(</span><span class="s2">30</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">[x.size</span><span class="s0">, </span><span class="s2">2</span><span class="s1">*x.size]:</span>
            <span class="s0">for </span><span class="s1">norm </span><span class="s0">in </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">'backward'</span><span class="s0">, </span><span class="s3">'ortho'</span><span class="s0">, </span><span class="s3">'forward'</span><span class="s1">]:</span>
                <span class="s1">assert_allclose(</span>
                    <span class="s1">np.fft.fft(x</span><span class="s0">, </span><span class="s1">n=n</span><span class="s0">, </span><span class="s1">norm=norm)[:(n//</span><span class="s2">2 </span><span class="s1">+ </span><span class="s2">1</span><span class="s1">)]</span><span class="s0">,</span>
                    <span class="s1">np.fft.rfft(x</span><span class="s0">, </span><span class="s1">n=n</span><span class="s0">, </span><span class="s1">norm=norm)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">np.fft.rfft(x</span><span class="s0">, </span><span class="s1">n=n)</span><span class="s0">,</span>
                <span class="s1">np.fft.rfft(x</span><span class="s0">, </span><span class="s1">n=n</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">np.fft.rfft(x</span><span class="s0">, </span><span class="s1">n=n) / np.sqrt(n)</span><span class="s0">,</span>
                <span class="s1">np.fft.rfft(x</span><span class="s0">, </span><span class="s1">n=n</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">np.fft.rfft(x</span><span class="s0">, </span><span class="s1">n=n) / n</span><span class="s0">,</span>
                <span class="s1">np.fft.rfft(x</span><span class="s0">, </span><span class="s1">n=n</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_irfft(self):</span>
        <span class="s1">x = random(</span><span class="s2">30</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft(np.fft.rfft(x))</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft(np.fft.rfft(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft(np.fft.rfft(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft(np.fft.rfft(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_rfft2(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s1">))</span>
        <span class="s1">assert_allclose(np.fft.fft2(x)[:</span><span class="s0">, </span><span class="s1">:</span><span class="s2">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.fft.rfft2(x)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.rfft2(x)</span><span class="s0">,</span>
                        <span class="s1">np.fft.rfft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.rfft2(x) / np.sqrt(</span><span class="s2">30 </span><span class="s1">* </span><span class="s2">20</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.rfft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.rfft2(x) / (</span><span class="s2">30. </span><span class="s1">* </span><span class="s2">20.</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.rfft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_irfft2(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s1">))</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft2(np.fft.rfft2(x))</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft2(np.fft.rfft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft2(np.fft.rfft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfft2(np.fft.rfft2(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_rfftn(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">assert_allclose(np.fft.fftn(x)[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s2">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.fft.rfftn(x)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.rfftn(x)</span><span class="s0">,</span>
                        <span class="s1">np.fft.rfftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.rfftn(x) / np.sqrt(</span><span class="s2">30 </span><span class="s1">* </span><span class="s2">20 </span><span class="s1">* </span><span class="s2">10</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.rfftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.rfftn(x) / (</span><span class="s2">30. </span><span class="s1">* </span><span class="s2">20. </span><span class="s1">* </span><span class="s2">10.</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.rfftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_irfftn(self):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfftn(np.fft.rfftn(x))</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfftn(np.fft.rfftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfftn(np.fft.rfftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">np.fft.irfftn(np.fft.rfftn(x</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_hfft(self):</span>
        <span class="s1">x = random(</span><span class="s2">14</span><span class="s1">) + </span><span class="s2">1j</span><span class="s1">*random(</span><span class="s2">14</span><span class="s1">)</span>
        <span class="s1">x_herm = np.concatenate((random(</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">random(</span><span class="s2">1</span><span class="s1">)))</span>
        <span class="s1">x = np.concatenate((x_herm</span><span class="s0">, </span><span class="s1">x[::-</span><span class="s2">1</span><span class="s1">].conj()))</span>
        <span class="s1">assert_allclose(np.fft.fft(x)</span><span class="s0">, </span><span class="s1">np.fft.hfft(x_herm)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.hfft(x_herm)</span><span class="s0">,</span>
                        <span class="s1">np.fft.hfft(x_herm</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.hfft(x_herm) / np.sqrt(</span><span class="s2">30</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">np.fft.hfft(x_herm</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.hfft(x_herm) / </span><span class="s2">30.</span><span class="s0">,</span>
                        <span class="s1">np.fft.hfft(x_herm</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_ihfft(self):</span>
        <span class="s1">x = random(</span><span class="s2">14</span><span class="s1">) + </span><span class="s2">1j</span><span class="s1">*random(</span><span class="s2">14</span><span class="s1">)</span>
        <span class="s1">x_herm = np.concatenate((random(</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">random(</span><span class="s2">1</span><span class="s1">)))</span>
        <span class="s1">x = np.concatenate((x_herm</span><span class="s0">, </span><span class="s1">x[::-</span><span class="s2">1</span><span class="s1">].conj()))</span>
        <span class="s1">assert_allclose(x_herm</span><span class="s0">, </span><span class="s1">np.fft.ihfft(np.fft.hfft(x_herm))</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x_herm</span><span class="s0">, </span><span class="s1">np.fft.ihfft(np.fft.hfft(x_herm</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;backward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x_herm</span><span class="s0">, </span><span class="s1">np.fft.ihfft(np.fft.hfft(x_herm</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;ortho&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(x_herm</span><span class="s0">, </span><span class="s1">np.fft.ihfft(np.fft.hfft(x_herm</span><span class="s0">,</span>
                        <span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">norm=</span><span class="s3">&quot;forward&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;op&quot;</span><span class="s0">, </span><span class="s1">[np.fft.fftn</span><span class="s0">, </span><span class="s1">np.fft.ifftn</span><span class="s0">,</span>
                                    <span class="s1">np.fft.rfftn</span><span class="s0">, </span><span class="s1">np.fft.irfftn])</span>
    <span class="s0">def </span><span class="s1">test_axes(self</span><span class="s0">, </span><span class="s1">op):</span>
        <span class="s1">x = random((</span><span class="s2">30</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">axes = [(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)]</span>
        <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">axes:</span>
            <span class="s1">op_tr = op(np.transpose(x</span><span class="s0">, </span><span class="s1">a))</span>
            <span class="s1">tr_op = np.transpose(op(x</span><span class="s0">, </span><span class="s1">axes=a)</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">assert_allclose(op_tr</span><span class="s0">, </span><span class="s1">tr_op</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_all_1d_norm_preserving(self):</span>
        <span class="s4"># verify that round-trip transforms are norm-preserving</span>
        <span class="s1">x = random(</span><span class="s2">30</span><span class="s1">)</span>
        <span class="s1">x_norm = np.linalg.norm(x)</span>
        <span class="s1">n = x.size * </span><span class="s2">2</span>
        <span class="s1">func_pairs = [(np.fft.fft</span><span class="s0">, </span><span class="s1">np.fft.ifft)</span><span class="s0">,</span>
                      <span class="s1">(np.fft.rfft</span><span class="s0">, </span><span class="s1">np.fft.irfft)</span><span class="s0">,</span>
                      <span class="s4"># hfft: order so the first function takes x.size samples</span>
                      <span class="s4">#       (necessary for comparison to x_norm above)</span>
                      <span class="s1">(np.fft.ihfft</span><span class="s0">, </span><span class="s1">np.fft.hfft)</span><span class="s0">,</span>
                      <span class="s1">]</span>
        <span class="s0">for </span><span class="s1">forw</span><span class="s0">, </span><span class="s1">back </span><span class="s0">in </span><span class="s1">func_pairs:</span>
            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">[x.size</span><span class="s0">, </span><span class="s2">2</span><span class="s1">*x.size]:</span>
                <span class="s0">for </span><span class="s1">norm </span><span class="s0">in </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">'backward'</span><span class="s0">, </span><span class="s3">'ortho'</span><span class="s0">, </span><span class="s3">'forward'</span><span class="s1">]:</span>
                    <span class="s1">tmp = forw(x</span><span class="s0">, </span><span class="s1">n=n</span><span class="s0">, </span><span class="s1">norm=norm)</span>
                    <span class="s1">tmp = back(tmp</span><span class="s0">, </span><span class="s1">n=n</span><span class="s0">, </span><span class="s1">norm=norm)</span>
                    <span class="s1">assert_allclose(x_norm</span><span class="s0">,</span>
                                    <span class="s1">np.linalg.norm(tmp)</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.half</span><span class="s0">, </span><span class="s1">np.single</span><span class="s0">, </span><span class="s1">np.double</span><span class="s0">,</span>
                                       <span class="s1">np.longdouble])</span>
    <span class="s0">def </span><span class="s1">test_dtypes(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s4"># make sure that all input precisions are accepted and internally</span>
        <span class="s4"># converted to 64bit</span>
        <span class="s1">x = random(</span><span class="s2">30</span><span class="s1">).astype(dtype)</span>
        <span class="s1">assert_allclose(np.fft.ifft(np.fft.fft(x))</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.fft.irfft(np.fft.rfft(x))</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;dtype&quot;</span><span class="s0">,</span>
        <span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">np.complex64</span><span class="s0">, </span><span class="s1">np.complex128])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;order&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;F&quot;</span><span class="s0">, </span><span class="s3">'non-contiguous'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;fft&quot;</span><span class="s0">,</span>
        <span class="s1">[np.fft.fft</span><span class="s0">, </span><span class="s1">np.fft.fft2</span><span class="s0">, </span><span class="s1">np.fft.fftn</span><span class="s0">,</span>
         <span class="s1">np.fft.ifft</span><span class="s0">, </span><span class="s1">np.fft.ifft2</span><span class="s0">, </span><span class="s1">np.fft.ifftn])</span>
<span class="s0">def </span><span class="s1">test_fft_with_order(dtype</span><span class="s0">, </span><span class="s1">order</span><span class="s0">, </span><span class="s1">fft):</span>
    <span class="s4"># Check that FFT/IFFT produces identical results for C, Fortran and</span>
    <span class="s4"># non contiguous arrays</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s2">42</span><span class="s1">)</span>
    <span class="s1">X = rng.rand(</span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">13</span><span class="s1">).astype(dtype</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s4"># See discussion in pull/14178</span>
    <span class="s1">_tol = </span><span class="s2">8.0 </span><span class="s1">* np.sqrt(np.log2(X.size)) * np.finfo(X.dtype).eps</span>
    <span class="s0">if </span><span class="s1">order == </span><span class="s3">'F'</span><span class="s1">:</span>
        <span class="s1">Y = np.asfortranarray(X)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># Make a non contiguous array</span>
        <span class="s1">Y = X[::-</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">X = np.ascontiguousarray(X[::-</span><span class="s2">1</span><span class="s1">])</span>

    <span class="s0">if </span><span class="s1">fft.__name__.endswith(</span><span class="s3">'fft'</span><span class="s1">):</span>
        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">3</span><span class="s1">):</span>
            <span class="s1">X_res = fft(X</span><span class="s0">, </span><span class="s1">axis=axis)</span>
            <span class="s1">Y_res = fft(Y</span><span class="s0">, </span><span class="s1">axis=axis)</span>
            <span class="s1">assert_allclose(X_res</span><span class="s0">, </span><span class="s1">Y_res</span><span class="s0">, </span><span class="s1">atol=_tol</span><span class="s0">, </span><span class="s1">rtol=_tol)</span>
    <span class="s0">elif </span><span class="s1">fft.__name__.endswith((</span><span class="s3">'fft2'</span><span class="s0">, </span><span class="s3">'fftn'</span><span class="s1">)):</span>
        <span class="s1">axes = [(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)]</span>
        <span class="s0">if </span><span class="s1">fft.__name__.endswith(</span><span class="s3">'fftn'</span><span class="s1">):</span>
            <span class="s1">axes.extend([(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">])</span>
        <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axes:</span>
            <span class="s1">X_res = fft(X</span><span class="s0">, </span><span class="s1">axes=ax)</span>
            <span class="s1">Y_res = fft(Y</span><span class="s0">, </span><span class="s1">axes=ax)</span>
            <span class="s1">assert_allclose(X_res</span><span class="s0">, </span><span class="s1">Y_res</span><span class="s0">, </span><span class="s1">atol=_tol</span><span class="s0">, </span><span class="s1">rtol=_tol)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">ValueError()</span>


<span class="s0">class </span><span class="s1">TestFFTThreadSafe:</span>
    <span class="s1">threads = </span><span class="s2">16</span>
    <span class="s1">input_shape = (</span><span class="s2">800</span><span class="s0">, </span><span class="s2">200</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">_test_mtsame(self</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s0">def </span><span class="s1">worker(args</span><span class="s0">, </span><span class="s1">q):</span>
            <span class="s1">q.put(func(*args))</span>

        <span class="s1">q = queue.Queue()</span>
        <span class="s1">expected = func(*args)</span>

        <span class="s4"># Spin off a bunch of threads to call the same function simultaneously</span>
        <span class="s1">t = [threading.Thread(target=worker</span><span class="s0">, </span><span class="s1">args=(args</span><span class="s0">, </span><span class="s1">q))</span>
             <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(self.threads)]</span>
        <span class="s1">[x.start() </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">t]</span>

        <span class="s1">[x.join() </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">t]</span>
        <span class="s4"># Make sure all threads returned the correct value</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(self.threads):</span>
            <span class="s1">assert_array_equal(q.get(timeout=</span><span class="s2">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">,</span>
                <span class="s3">'Function returned wrong value in multithreaded context'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_fft(self):</span>
        <span class="s1">a = np.ones(self.input_shape) * </span><span class="s2">1</span><span class="s1">+</span><span class="s2">0j</span>
        <span class="s1">self._test_mtsame(np.fft.fft</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_ifft(self):</span>
        <span class="s1">a = np.ones(self.input_shape) * </span><span class="s2">1</span><span class="s1">+</span><span class="s2">0j</span>
        <span class="s1">self._test_mtsame(np.fft.ifft</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_rfft(self):</span>
        <span class="s1">a = np.ones(self.input_shape)</span>
        <span class="s1">self._test_mtsame(np.fft.rfft</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_irfft(self):</span>
        <span class="s1">a = np.ones(self.input_shape) * </span><span class="s2">1</span><span class="s1">+</span><span class="s2">0j</span>
        <span class="s1">self._test_mtsame(np.fft.irfft</span><span class="s0">, </span><span class="s1">a)</span>
</pre>
</body>
</html>