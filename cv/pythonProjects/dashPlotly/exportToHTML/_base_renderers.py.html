<html>
<head>
<title>_base_renderers.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_base_renderers.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span>
<span class="s0">import </span><span class="s1">base64</span>
<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">webbrowser</span>
<span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">os.path </span><span class="s0">import </span><span class="s1">isdir</span>

<span class="s0">import </span><span class="s1">six</span>
<span class="s0">from </span><span class="s1">plotly </span><span class="s0">import </span><span class="s1">utils</span><span class="s0">, </span><span class="s1">optional_imports</span>
<span class="s0">from </span><span class="s1">plotly.io </span><span class="s0">import </span><span class="s1">to_json</span><span class="s0">, </span><span class="s1">to_image</span><span class="s0">, </span><span class="s1">write_image</span><span class="s0">, </span><span class="s1">write_html</span>
<span class="s0">from </span><span class="s1">plotly.io._orca </span><span class="s0">import </span><span class="s1">ensure_server</span>
<span class="s0">from </span><span class="s1">plotly.io._utils </span><span class="s0">import </span><span class="s1">plotly_cdn_url</span>
<span class="s0">from </span><span class="s1">plotly.offline.offline </span><span class="s0">import </span><span class="s1">_get_jconfig</span><span class="s0">, </span><span class="s1">get_plotlyjs</span>
<span class="s0">from </span><span class="s1">plotly.tools </span><span class="s0">import </span><span class="s1">return_figure_from_figure_or_data</span>

<span class="s1">ipython_display = optional_imports.get_module(</span><span class="s2">&quot;IPython.display&quot;</span><span class="s1">)</span>
<span class="s1">IPython = optional_imports.get_module(</span><span class="s2">&quot;IPython&quot;</span><span class="s1">)</span>

<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">from </span><span class="s1">http.server </span><span class="s0">import </span><span class="s1">BaseHTTPRequestHandler</span><span class="s0">, </span><span class="s1">HTTPServer</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s3"># Python 2.7</span>
    <span class="s0">from </span><span class="s1">BaseHTTPServer </span><span class="s0">import </span><span class="s1">BaseHTTPRequestHandler</span><span class="s0">, </span><span class="s1">HTTPServer</span>


<span class="s0">class </span><span class="s1">BaseRenderer(object):</span>
    <span class="s4">&quot;&quot;&quot; 
    Base class for all renderers 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">activate(self):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">__repr__(self):</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">init_sig = inspect.signature(self.__init__)</span>
            <span class="s1">init_args = list(init_sig.parameters.keys())</span>
        <span class="s0">except </span><span class="s1">AttributeError:</span>
            <span class="s3"># Python 2.7</span>
            <span class="s1">argspec = inspect.getargspec(self.__init__)</span>
            <span class="s1">init_args = [a </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">argspec.args </span><span class="s0">if </span><span class="s1">a != </span><span class="s2">&quot;self&quot;</span><span class="s1">]</span>

        <span class="s0">return </span><span class="s2">&quot;{cls}({attrs})</span><span class="s0">\n</span><span class="s2">{doc}&quot;</span><span class="s1">.format(</span>
            <span class="s1">cls=self.__class__.__name__</span><span class="s0">,</span>
            <span class="s1">attrs=</span><span class="s2">&quot;, &quot;</span><span class="s1">.join(</span><span class="s2">&quot;{}={!r}&quot;</span><span class="s1">.format(k</span><span class="s0">, </span><span class="s1">self.__dict__[k]) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">init_args)</span><span class="s0">,</span>
            <span class="s1">doc=self.__doc__</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">__hash__(self):</span>
        <span class="s3"># Constructor args fully define uniqueness</span>
        <span class="s0">return </span><span class="s1">hash(repr(self))</span>


<span class="s0">class </span><span class="s1">MimetypeRenderer(BaseRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Base class for all mime type renderers 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">to_mimebundle(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError()</span>


<span class="s0">class </span><span class="s1">JsonRenderer(MimetypeRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display figures as JSON hierarchies.  This renderer is 
    compatible with JupyterLab and VSCode. 
 
    mime type: 'application/json' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">to_mimebundle(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s1">value = json.loads(to_json(fig_dict</span><span class="s0">, </span><span class="s1">validate=</span><span class="s0">False, </span><span class="s1">remove_uids=</span><span class="s0">False</span><span class="s1">))</span>
        <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;application/json&quot;</span><span class="s1">: value}</span>


<span class="s3"># Plotly mimetype</span>
<span class="s0">class </span><span class="s1">PlotlyRenderer(MimetypeRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display figures using the plotly mime type.  This renderer is 
    compatible with JupyterLab (using the @jupyterlab/plotly-extension), 
    VSCode, and nteract. 
 
    mime type: 'application/vnd.plotly.v1+json' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">config=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">self.config = dict(config) </span><span class="s0">if </span><span class="s1">config </span><span class="s0">else </span><span class="s1">{}</span>

    <span class="s0">def </span><span class="s1">to_mimebundle(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s1">config = _get_jconfig(self.config)</span>
        <span class="s0">if </span><span class="s1">config:</span>
            <span class="s1">fig_dict[</span><span class="s2">&quot;config&quot;</span><span class="s1">] = config</span>

        <span class="s1">json_compatible_fig_dict = json.loads(</span>
            <span class="s1">to_json(fig_dict</span><span class="s0">, </span><span class="s1">validate=</span><span class="s0">False, </span><span class="s1">remove_uids=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;application/vnd.plotly.v1+json&quot;</span><span class="s1">: json_compatible_fig_dict}</span>


<span class="s3"># Static Image</span>
<span class="s0">class </span><span class="s1">ImageRenderer(MimetypeRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Base class for all static image renderers 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">mime_type</span><span class="s0">,</span>
        <span class="s1">b64_encode=</span><span class="s0">False,</span>
        <span class="s1">format=</span><span class="s0">None,</span>
        <span class="s1">width=</span><span class="s0">None,</span>
        <span class="s1">height=</span><span class="s0">None,</span>
        <span class="s1">scale=</span><span class="s0">None,</span>
        <span class="s1">engine=</span><span class="s2">&quot;auto&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>

        <span class="s1">self.mime_type = mime_type</span>
        <span class="s1">self.b64_encode = b64_encode</span>
        <span class="s1">self.format = format</span>
        <span class="s1">self.width = width</span>
        <span class="s1">self.height = height</span>
        <span class="s1">self.scale = scale</span>
        <span class="s1">self.engine = engine</span>

    <span class="s0">def </span><span class="s1">to_mimebundle(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s1">image_bytes = to_image(</span>
            <span class="s1">fig_dict</span><span class="s0">,</span>
            <span class="s1">format=self.format</span><span class="s0">,</span>
            <span class="s1">width=self.width</span><span class="s0">,</span>
            <span class="s1">height=self.height</span><span class="s0">,</span>
            <span class="s1">scale=self.scale</span><span class="s0">,</span>
            <span class="s1">validate=</span><span class="s0">False,</span>
            <span class="s1">engine=self.engine</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">self.b64_encode:</span>
            <span class="s1">image_str = base64.b64encode(image_bytes).decode(</span><span class="s2">&quot;utf8&quot;</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">image_str = image_bytes.decode(</span><span class="s2">&quot;utf8&quot;</span><span class="s1">)</span>

        <span class="s0">return </span><span class="s1">{self.mime_type: image_str}</span>


<span class="s0">class </span><span class="s1">PngRenderer(ImageRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display figures as static PNG images.  This renderer requires 
    either the kaleido package or the orca command-line utility and is broadly 
    compatible across IPython environments (classic Jupyter Notebook, JupyterLab, 
    QtConsole, VSCode, PyCharm, etc) and nbconvert targets (HTML, PDF, etc.). 
 
    mime type: 'image/png' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">width=</span><span class="s0">None, </span><span class="s1">height=</span><span class="s0">None, </span><span class="s1">scale=</span><span class="s0">None, </span><span class="s1">engine=</span><span class="s2">&quot;auto&quot;</span><span class="s1">):</span>
        <span class="s1">super(PngRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">mime_type=</span><span class="s2">&quot;image/png&quot;</span><span class="s0">,</span>
            <span class="s1">b64_encode=</span><span class="s0">True,</span>
            <span class="s1">format=</span><span class="s2">&quot;png&quot;</span><span class="s0">,</span>
            <span class="s1">width=width</span><span class="s0">,</span>
            <span class="s1">height=height</span><span class="s0">,</span>
            <span class="s1">scale=scale</span><span class="s0">,</span>
            <span class="s1">engine=engine</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">class </span><span class="s1">SvgRenderer(ImageRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display figures as static SVG images.  This renderer requires 
    either the kaleido package or the orca command-line utility and is broadly 
    compatible across IPython environments (classic Jupyter Notebook, JupyterLab, 
    QtConsole, VSCode, PyCharm, etc) and nbconvert targets (HTML, PDF, etc.). 
 
    mime type: 'image/svg+xml' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">width=</span><span class="s0">None, </span><span class="s1">height=</span><span class="s0">None, </span><span class="s1">scale=</span><span class="s0">None, </span><span class="s1">engine=</span><span class="s2">&quot;auto&quot;</span><span class="s1">):</span>
        <span class="s1">super(SvgRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">mime_type=</span><span class="s2">&quot;image/svg+xml&quot;</span><span class="s0">,</span>
            <span class="s1">b64_encode=</span><span class="s0">False,</span>
            <span class="s1">format=</span><span class="s2">&quot;svg&quot;</span><span class="s0">,</span>
            <span class="s1">width=width</span><span class="s0">,</span>
            <span class="s1">height=height</span><span class="s0">,</span>
            <span class="s1">scale=scale</span><span class="s0">,</span>
            <span class="s1">engine=engine</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">class </span><span class="s1">JpegRenderer(ImageRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display figures as static JPEG images.  This renderer requires 
    either the kaleido package or the orca command-line utility and is broadly 
    compatible across IPython environments (classic Jupyter Notebook, JupyterLab, 
    QtConsole, VSCode, PyCharm, etc) and nbconvert targets (HTML, PDF, etc.). 
 
    mime type: 'image/jpeg' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">width=</span><span class="s0">None, </span><span class="s1">height=</span><span class="s0">None, </span><span class="s1">scale=</span><span class="s0">None, </span><span class="s1">engine=</span><span class="s2">&quot;auto&quot;</span><span class="s1">):</span>
        <span class="s1">super(JpegRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">mime_type=</span><span class="s2">&quot;image/jpeg&quot;</span><span class="s0">,</span>
            <span class="s1">b64_encode=</span><span class="s0">True,</span>
            <span class="s1">format=</span><span class="s2">&quot;jpg&quot;</span><span class="s0">,</span>
            <span class="s1">width=width</span><span class="s0">,</span>
            <span class="s1">height=height</span><span class="s0">,</span>
            <span class="s1">scale=scale</span><span class="s0">,</span>
            <span class="s1">engine=engine</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">class </span><span class="s1">PdfRenderer(ImageRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display figures as static PDF images.  This renderer requires 
    either the kaleido package or the orca command-line utility and is compatible 
    with JupyterLab and the LaTeX-based nbconvert export to PDF. 
 
    mime type: 'application/pdf' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">width=</span><span class="s0">None, </span><span class="s1">height=</span><span class="s0">None, </span><span class="s1">scale=</span><span class="s0">None, </span><span class="s1">engine=</span><span class="s2">&quot;auto&quot;</span><span class="s1">):</span>
        <span class="s1">super(PdfRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">mime_type=</span><span class="s2">&quot;application/pdf&quot;</span><span class="s0">,</span>
            <span class="s1">b64_encode=</span><span class="s0">True,</span>
            <span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s0">,</span>
            <span class="s1">width=width</span><span class="s0">,</span>
            <span class="s1">height=height</span><span class="s0">,</span>
            <span class="s1">scale=scale</span><span class="s0">,</span>
            <span class="s1">engine=engine</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s3"># HTML</span>
<span class="s3"># Build script to set global PlotlyConfig object. This must execute before</span>
<span class="s3"># plotly.js is loaded.</span>
<span class="s1">_window_plotly_config = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">window.PlotlyConfig = {MathJaxConfig: 'local'};&quot;&quot;&quot;</span>

<span class="s1">_mathjax_config = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">if (window.MathJax) {MathJax.Hub.Config({SVG: {font: &quot;STIX-Web&quot;}});}&quot;&quot;&quot;</span>


<span class="s0">class </span><span class="s1">HtmlRenderer(MimetypeRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Base class for all HTML mime type renderers 
 
    mime type: 'text/html' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">connected=</span><span class="s0">False,</span>
        <span class="s1">full_html=</span><span class="s0">False,</span>
        <span class="s1">requirejs=</span><span class="s0">True,</span>
        <span class="s1">global_init=</span><span class="s0">False,</span>
        <span class="s1">config=</span><span class="s0">None,</span>
        <span class="s1">auto_play=</span><span class="s0">False,</span>
        <span class="s1">post_script=</span><span class="s0">None,</span>
        <span class="s1">animation_opts=</span><span class="s0">None,</span>
    <span class="s1">):</span>

        <span class="s1">self.config = dict(config) </span><span class="s0">if </span><span class="s1">config </span><span class="s0">else </span><span class="s1">{}</span>
        <span class="s1">self.auto_play = auto_play</span>
        <span class="s1">self.connected = connected</span>
        <span class="s1">self.global_init = global_init</span>
        <span class="s1">self.requirejs = requirejs</span>
        <span class="s1">self.full_html = full_html</span>
        <span class="s1">self.animation_opts = animation_opts</span>
        <span class="s1">self.post_script = post_script</span>

    <span class="s0">def </span><span class="s1">activate(self):</span>
        <span class="s0">if </span><span class="s1">self.global_init:</span>
            <span class="s0">if not </span><span class="s1">ipython_display:</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span>
                    <span class="s2">&quot;The {cls} class requires ipython but it is not installed&quot;</span><span class="s1">.format(</span>
                        <span class="s1">cls=self.__class__.__name__</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>

            <span class="s0">if not </span><span class="s1">self.requirejs:</span>
                <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">&quot;global_init is only supported with requirejs=True&quot;</span><span class="s1">)</span>

            <span class="s0">if </span><span class="s1">self.connected:</span>
                <span class="s3"># Connected so we configure requirejs with the plotly CDN</span>
                <span class="s1">script = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s2">&lt;script type=&quot;text/javascript&quot;&gt; 
        {win_config} 
        {mathjax_config} 
        if (typeof require !== 'undefined') {{ 
        require.undef(&quot;plotly&quot;); 
        requirejs.config({{ 
            paths: {{ 
                'plotly': ['{plotly_cdn}'] 
            }} 
        }}); 
        require(['plotly'], function(Plotly) {{ 
            window._Plotly = Plotly; 
        }}); 
        }} 
        &lt;/script&gt; 
        &quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">win_config=_window_plotly_config</span><span class="s0">,</span>
                    <span class="s1">mathjax_config=_mathjax_config</span><span class="s0">,</span>
                    <span class="s1">plotly_cdn=plotly_cdn_url().rstrip(</span><span class="s2">&quot;.js&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span>

            <span class="s0">else</span><span class="s1">:</span>
                <span class="s3"># If not connected then we embed a copy of the plotly.js</span>
                <span class="s3"># library in the notebook</span>
                <span class="s1">script = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s2">&lt;script type=&quot;text/javascript&quot;&gt; 
        {win_config} 
        {mathjax_config} 
        if (typeof require !== 'undefined') {{ 
        require.undef(&quot;plotly&quot;); 
        define('plotly', function(require, exports, module) {{ 
            {script} 
        }}); 
        require(['plotly'], function(Plotly) {{ 
            window._Plotly = Plotly; 
        }}); 
        }} 
        &lt;/script&gt; 
        &quot;&quot;&quot;</span><span class="s1">.format(</span>
                    <span class="s1">script=get_plotlyjs()</span><span class="s0">,</span>
                    <span class="s1">win_config=_window_plotly_config</span><span class="s0">,</span>
                    <span class="s1">mathjax_config=_mathjax_config</span><span class="s0">,</span>
                <span class="s1">)</span>

            <span class="s1">ipython_display.display_html(script</span><span class="s0">, </span><span class="s1">raw=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">to_mimebundle(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>

        <span class="s0">from </span><span class="s1">plotly.io </span><span class="s0">import </span><span class="s1">to_html</span>

        <span class="s0">if </span><span class="s1">self.requirejs:</span>
            <span class="s1">include_plotlyjs = </span><span class="s2">&quot;require&quot;</span>
            <span class="s1">include_mathjax = </span><span class="s0">False</span>
        <span class="s0">elif </span><span class="s1">self.connected:</span>
            <span class="s1">include_plotlyjs = </span><span class="s2">&quot;cdn&quot;</span>
            <span class="s1">include_mathjax = </span><span class="s2">&quot;cdn&quot;</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">include_plotlyjs = </span><span class="s0">True</span>
            <span class="s1">include_mathjax = </span><span class="s2">&quot;cdn&quot;</span>

        <span class="s3"># build post script</span>
        <span class="s1">post_script = [</span>
            <span class="s2">&quot;&quot;&quot; 
var gd = document.getElementById('{plot_id}'); 
var x = new MutationObserver(function (mutations, observer) {{ 
        var display = window.getComputedStyle(gd).display; 
        if (!display || display === 'none') {{ 
            console.log([gd, 'removed!']); 
            Plotly.purge(gd); 
            observer.disconnect(); 
        }} 
}}); 
 
// Listen for the removal of the full notebook cells 
var notebookContainer = gd.closest('#notebook-container'); 
if (notebookContainer) {{ 
    x.observe(notebookContainer, {childList: true}); 
}} 
 
// Listen for the clearing of the current output cell 
var outputEl = gd.closest('.output'); 
if (outputEl) {{ 
    x.observe(outputEl, {childList: true}); 
}} 
&quot;&quot;&quot;</span>
        <span class="s1">]</span>

        <span class="s3"># Add user defined post script</span>
        <span class="s0">if </span><span class="s1">self.post_script:</span>
            <span class="s0">if not </span><span class="s1">isinstance(self.post_script</span><span class="s0">, </span><span class="s1">(list</span><span class="s0">, </span><span class="s1">tuple)):</span>
                <span class="s1">post_script.append(self.post_script)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">post_script.extend(self.post_script)</span>

        <span class="s1">html = to_html(</span>
            <span class="s1">fig_dict</span><span class="s0">,</span>
            <span class="s1">config=self.config</span><span class="s0">,</span>
            <span class="s1">auto_play=self.auto_play</span><span class="s0">,</span>
            <span class="s1">include_plotlyjs=include_plotlyjs</span><span class="s0">,</span>
            <span class="s1">include_mathjax=include_mathjax</span><span class="s0">,</span>
            <span class="s1">post_script=post_script</span><span class="s0">,</span>
            <span class="s1">full_html=self.full_html</span><span class="s0">,</span>
            <span class="s1">animation_opts=self.animation_opts</span><span class="s0">,</span>
            <span class="s1">default_width=</span><span class="s2">&quot;100%&quot;</span><span class="s0">,</span>
            <span class="s1">default_height=</span><span class="s5">525</span><span class="s0">,</span>
            <span class="s1">validate=</span><span class="s0">False,</span>
        <span class="s1">)</span>

        <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;text/html&quot;</span><span class="s1">: html}</span>


<span class="s0">class </span><span class="s1">NotebookRenderer(HtmlRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display interactive figures in the classic Jupyter Notebook. 
    This renderer is also useful for notebooks that will be converted to 
    HTML using nbconvert/nbviewer as it will produce standalone HTML files 
    that include interactive figures. 
 
    This renderer automatically performs global notebook initialization when 
    activated. 
 
    mime type: 'text/html' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">connected=</span><span class="s0">False,</span>
        <span class="s1">config=</span><span class="s0">None,</span>
        <span class="s1">auto_play=</span><span class="s0">False,</span>
        <span class="s1">post_script=</span><span class="s0">None,</span>
        <span class="s1">animation_opts=</span><span class="s0">None,</span>
    <span class="s1">):</span>
        <span class="s1">super(NotebookRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">connected=connected</span><span class="s0">,</span>
            <span class="s1">full_html=</span><span class="s0">False,</span>
            <span class="s1">requirejs=</span><span class="s0">True,</span>
            <span class="s1">global_init=</span><span class="s0">True,</span>
            <span class="s1">config=config</span><span class="s0">,</span>
            <span class="s1">auto_play=auto_play</span><span class="s0">,</span>
            <span class="s1">post_script=post_script</span><span class="s0">,</span>
            <span class="s1">animation_opts=animation_opts</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">class </span><span class="s1">KaggleRenderer(HtmlRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display interactive figures in Kaggle Notebooks. 
 
    Same as NotebookRenderer but with connected=True so that the plotly.js 
    bundle is loaded from a CDN rather than being embedded in the notebook. 
 
    This renderer is enabled by default when running in a Kaggle notebook. 
 
    mime type: 'text/html' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">config=</span><span class="s0">None, </span><span class="s1">auto_play=</span><span class="s0">False, </span><span class="s1">post_script=</span><span class="s0">None, </span><span class="s1">animation_opts=</span><span class="s0">None</span>
    <span class="s1">):</span>

        <span class="s1">super(KaggleRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">connected=</span><span class="s0">True,</span>
            <span class="s1">full_html=</span><span class="s0">False,</span>
            <span class="s1">requirejs=</span><span class="s0">True,</span>
            <span class="s1">global_init=</span><span class="s0">True,</span>
            <span class="s1">config=config</span><span class="s0">,</span>
            <span class="s1">auto_play=auto_play</span><span class="s0">,</span>
            <span class="s1">post_script=post_script</span><span class="s0">,</span>
            <span class="s1">animation_opts=animation_opts</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">class </span><span class="s1">AzureRenderer(HtmlRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display interactive figures in Azure Notebooks. 
 
    Same as NotebookRenderer but with connected=True so that the plotly.js 
    bundle is loaded from a CDN rather than being embedded in the notebook. 
 
    This renderer is enabled by default when running in an Azure notebook. 
 
    mime type: 'text/html' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">config=</span><span class="s0">None, </span><span class="s1">auto_play=</span><span class="s0">False, </span><span class="s1">post_script=</span><span class="s0">None, </span><span class="s1">animation_opts=</span><span class="s0">None</span>
    <span class="s1">):</span>

        <span class="s1">super(AzureRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">connected=</span><span class="s0">True,</span>
            <span class="s1">full_html=</span><span class="s0">False,</span>
            <span class="s1">requirejs=</span><span class="s0">True,</span>
            <span class="s1">global_init=</span><span class="s0">True,</span>
            <span class="s1">config=config</span><span class="s0">,</span>
            <span class="s1">auto_play=auto_play</span><span class="s0">,</span>
            <span class="s1">post_script=post_script</span><span class="s0">,</span>
            <span class="s1">animation_opts=animation_opts</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">class </span><span class="s1">ColabRenderer(HtmlRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display interactive figures in Google Colab Notebooks. 
 
    This renderer is enabled by default when running in a Colab notebook. 
 
    mime type: 'text/html' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">, </span><span class="s1">config=</span><span class="s0">None, </span><span class="s1">auto_play=</span><span class="s0">False, </span><span class="s1">post_script=</span><span class="s0">None, </span><span class="s1">animation_opts=</span><span class="s0">None</span>
    <span class="s1">):</span>

        <span class="s1">super(ColabRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">connected=</span><span class="s0">True,</span>
            <span class="s1">full_html=</span><span class="s0">True,</span>
            <span class="s1">requirejs=</span><span class="s0">False,</span>
            <span class="s1">global_init=</span><span class="s0">False,</span>
            <span class="s1">config=config</span><span class="s0">,</span>
            <span class="s1">auto_play=auto_play</span><span class="s0">,</span>
            <span class="s1">post_script=post_script</span><span class="s0">,</span>
            <span class="s1">animation_opts=animation_opts</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">class </span><span class="s1">IFrameRenderer(MimetypeRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display interactive figures using an IFrame.  HTML 
    representations of Figures are saved to an `iframe_figures/` directory and 
    iframe HTML elements that reference these files are inserted into the 
    notebook. 
 
    With this approach, neither plotly.js nor the figure data are embedded in 
    the notebook, so this is a good choice for notebooks that contain so many 
    large figures that basic operations (like saving and opening) become 
    very slow. 
 
    Notebooks using this renderer will display properly when exported to HTML 
    as long as the `iframe_figures/` directory is placed in the same directory 
    as the exported html file. 
 
    Note that the HTML files in `iframe_figures/` are numbered according to 
    the IPython cell execution count and so they will start being overwritten 
    each time the kernel is restarted.  This directory may be deleted whenever 
    the kernel is restarted and it will be automatically recreated. 
 
    mime type: 'text/html' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">config=</span><span class="s0">None,</span>
        <span class="s1">auto_play=</span><span class="s0">False,</span>
        <span class="s1">post_script=</span><span class="s0">None,</span>
        <span class="s1">animation_opts=</span><span class="s0">None,</span>
        <span class="s1">include_plotlyjs=</span><span class="s0">True,</span>
        <span class="s1">html_directory=</span><span class="s2">&quot;iframe_figures&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>

        <span class="s1">self.config = config</span>
        <span class="s1">self.auto_play = auto_play</span>
        <span class="s1">self.post_script = post_script</span>
        <span class="s1">self.animation_opts = animation_opts</span>
        <span class="s1">self.include_plotlyjs = include_plotlyjs</span>
        <span class="s1">self.html_directory = html_directory</span>

    <span class="s0">def </span><span class="s1">to_mimebundle(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s0">from </span><span class="s1">plotly.io </span><span class="s0">import </span><span class="s1">write_html</span>

        <span class="s3"># Make iframe size slightly larger than figure size to avoid</span>
        <span class="s3"># having iframe have its own scroll bar.</span>
        <span class="s1">iframe_buffer = </span><span class="s5">20</span>
        <span class="s1">layout = fig_dict.get(</span><span class="s2">&quot;layout&quot;</span><span class="s0">, </span><span class="s1">{})</span>

        <span class="s0">if </span><span class="s1">layout.get(</span><span class="s2">&quot;width&quot;</span><span class="s0">, False</span><span class="s1">):</span>
            <span class="s1">iframe_width = str(layout[</span><span class="s2">&quot;width&quot;</span><span class="s1">] + iframe_buffer) + </span><span class="s2">&quot;px&quot;</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">iframe_width = </span><span class="s2">&quot;100%&quot;</span>

        <span class="s0">if </span><span class="s1">layout.get(</span><span class="s2">&quot;height&quot;</span><span class="s0">, False</span><span class="s1">):</span>
            <span class="s1">iframe_height = layout[</span><span class="s2">&quot;height&quot;</span><span class="s1">] + iframe_buffer</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">iframe_height = str(</span><span class="s5">525 </span><span class="s1">+ iframe_buffer) + </span><span class="s2">&quot;px&quot;</span>

        <span class="s3"># Build filename using ipython cell number</span>
        <span class="s1">filename = self.build_filename()</span>

        <span class="s3"># Make directory for</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">os.makedirs(self.html_directory)</span>
        <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">error:</span>
            <span class="s0">if not </span><span class="s1">isdir(self.html_directory):</span>
                <span class="s0">raise</span>

        <span class="s1">write_html(</span>
            <span class="s1">fig_dict</span><span class="s0">,</span>
            <span class="s1">filename</span><span class="s0">,</span>
            <span class="s1">config=self.config</span><span class="s0">,</span>
            <span class="s1">auto_play=self.auto_play</span><span class="s0">,</span>
            <span class="s1">include_plotlyjs=self.include_plotlyjs</span><span class="s0">,</span>
            <span class="s1">include_mathjax=</span><span class="s2">&quot;cdn&quot;</span><span class="s0">,</span>
            <span class="s1">auto_open=</span><span class="s0">False,</span>
            <span class="s1">post_script=self.post_script</span><span class="s0">,</span>
            <span class="s1">animation_opts=self.animation_opts</span><span class="s0">,</span>
            <span class="s1">default_width=</span><span class="s2">&quot;100%&quot;</span><span class="s0">,</span>
            <span class="s1">default_height=</span><span class="s5">525</span><span class="s0">,</span>
            <span class="s1">validate=</span><span class="s0">False,</span>
        <span class="s1">)</span>

        <span class="s3"># Build IFrame</span>
        <span class="s1">iframe_html = </span><span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">&lt;iframe 
    scrolling=&quot;no&quot; 
    width=&quot;{width}&quot; 
    height=&quot;{height}&quot; 
    src=&quot;{src}&quot; 
    frameborder=&quot;0&quot; 
    allowfullscreen 
&gt;&lt;/iframe&gt; 
&quot;&quot;&quot;</span><span class="s1">.format(</span>
            <span class="s1">width=iframe_width</span><span class="s0">, </span><span class="s1">height=iframe_height</span><span class="s0">, </span><span class="s1">src=self.build_url(filename)</span>
        <span class="s1">)</span>

        <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;text/html&quot;</span><span class="s1">: iframe_html}</span>

    <span class="s0">def </span><span class="s1">build_filename(self):</span>
        <span class="s1">ip = IPython.get_ipython() </span><span class="s0">if </span><span class="s1">IPython </span><span class="s0">else None</span>
        <span class="s1">cell_number = list(ip.history_manager.get_tail(</span><span class="s5">1</span><span class="s1">))[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] + </span><span class="s5">1 </span><span class="s0">if </span><span class="s1">ip </span><span class="s0">else </span><span class="s5">0</span>
        <span class="s1">filename = </span><span class="s2">&quot;{dirname}/figure_{cell_number}.html&quot;</span><span class="s1">.format(</span>
            <span class="s1">dirname=self.html_directory</span><span class="s0">, </span><span class="s1">cell_number=cell_number</span>
        <span class="s1">)</span>
        <span class="s0">return </span><span class="s1">filename</span>

    <span class="s0">def </span><span class="s1">build_url(self</span><span class="s0">, </span><span class="s1">filename):</span>
        <span class="s0">return </span><span class="s1">filename</span>


<span class="s0">class </span><span class="s1">CoCalcRenderer(IFrameRenderer):</span>

    <span class="s1">_render_count = </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">build_filename(self):</span>
        <span class="s1">filename = </span><span class="s2">&quot;{dirname}/figure_{render_count}.html&quot;</span><span class="s1">.format(</span>
            <span class="s1">dirname=self.html_directory</span><span class="s0">, </span><span class="s1">render_count=CoCalcRenderer._render_count</span>
        <span class="s1">)</span>

        <span class="s1">CoCalcRenderer._render_count += </span><span class="s5">1</span>
        <span class="s0">return </span><span class="s1">filename</span>

    <span class="s0">def </span><span class="s1">build_url(self</span><span class="s0">, </span><span class="s1">filename):</span>
        <span class="s0">return </span><span class="s2">&quot;{filename}?fullscreen=kiosk&quot;</span><span class="s1">.format(filename=filename)</span>


<span class="s0">class </span><span class="s1">ExternalRenderer(BaseRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Base class for external renderers.  ExternalRenderer subclasses 
    do not display figures inline in a notebook environment, but render 
    figures by some external means (e.g. a separate browser tab). 
 
    Unlike MimetypeRenderer subclasses, ExternalRenderer subclasses are not 
    invoked when a figure is asked to display itself in the notebook. 
    Instead, they are invoked when the plotly.io.show function is called 
    on a figure. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">render(self</span><span class="s0">, </span><span class="s1">fig):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError()</span>


<span class="s0">def </span><span class="s1">open_html_in_browser(html</span><span class="s0">, </span><span class="s1">using=</span><span class="s0">None, </span><span class="s1">new=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">autoraise=</span><span class="s0">True</span><span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Display html in a web browser without creating a temp file. 
 
    Instantiates a trivial http server and uses the webbrowser module to 
    open a URL to retrieve html from that server. 
 
    Parameters 
    ---------- 
    html: str 
        HTML string to display 
    using, new, autoraise: 
        See docstrings in webbrowser.get and webbrowser.open 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance(html</span><span class="s0">, </span><span class="s1">six.string_types):</span>
        <span class="s1">html = html.encode(</span><span class="s2">&quot;utf8&quot;</span><span class="s1">)</span>

    <span class="s1">browser = </span><span class="s0">None</span>

    <span class="s0">if </span><span class="s1">using </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">browser = webbrowser.get(</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">if not </span><span class="s1">isinstance(using</span><span class="s0">, </span><span class="s1">tuple):</span>
            <span class="s1">using = (using</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">browser_key </span><span class="s0">in </span><span class="s1">using:</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">browser = webbrowser.get(browser_key)</span>
                <span class="s0">if </span><span class="s1">browser </span><span class="s0">is not None</span><span class="s1">:</span>
                    <span class="s0">break</span>
            <span class="s0">except </span><span class="s1">webbrowser.Error:</span>
                <span class="s0">pass</span>

        <span class="s0">if </span><span class="s1">browser </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">ValueError(</span><span class="s2">&quot;Can't locate a browser with key in &quot; </span><span class="s1">+ str(using))</span>

    <span class="s0">class </span><span class="s1">OneShotRequestHandler(BaseHTTPRequestHandler):</span>
        <span class="s0">def </span><span class="s1">do_GET(self):</span>
            <span class="s1">self.send_response(</span><span class="s5">200</span><span class="s1">)</span>
            <span class="s1">self.send_header(</span><span class="s2">&quot;Content-type&quot;</span><span class="s0">, </span><span class="s2">&quot;text/html&quot;</span><span class="s1">)</span>
            <span class="s1">self.end_headers()</span>

            <span class="s1">bufferSize = </span><span class="s5">1024 </span><span class="s1">* </span><span class="s5">1024</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">len(html)</span><span class="s0">, </span><span class="s1">bufferSize):</span>
                <span class="s1">self.wfile.write(html[i : i + bufferSize])</span>

        <span class="s0">def </span><span class="s1">log_message(self</span><span class="s0">, </span><span class="s1">format</span><span class="s0">, </span><span class="s1">*args):</span>
            <span class="s3"># Silence stderr logging</span>
            <span class="s0">pass</span>

    <span class="s1">server = HTTPServer((</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">OneShotRequestHandler)</span>
    <span class="s1">browser.open(</span>
        <span class="s2">&quot;http://127.0.0.1:%s&quot; </span><span class="s1">% server.server_port</span><span class="s0">, </span><span class="s1">new=new</span><span class="s0">, </span><span class="s1">autoraise=autoraise</span>
    <span class="s1">)</span>

    <span class="s1">server.handle_request()</span>


<span class="s0">class </span><span class="s1">BrowserRenderer(ExternalRenderer):</span>
    <span class="s4">&quot;&quot;&quot; 
    Renderer to display interactive figures in an external web browser. 
    This renderer will open a new browser window or tab when the 
    plotly.io.show function is called on a figure. 
 
    This renderer has no ipython/jupyter dependencies and is a good choice 
    for use in environments that do not support the inline display of 
    interactive figures. 
 
    mime type: 'text/html' 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">config=</span><span class="s0">None,</span>
        <span class="s1">auto_play=</span><span class="s0">False,</span>
        <span class="s1">using=</span><span class="s0">None,</span>
        <span class="s1">new=</span><span class="s5">0</span><span class="s0">,</span>
        <span class="s1">autoraise=</span><span class="s0">True,</span>
        <span class="s1">post_script=</span><span class="s0">None,</span>
        <span class="s1">animation_opts=</span><span class="s0">None,</span>
    <span class="s1">):</span>

        <span class="s1">self.config = config</span>
        <span class="s1">self.auto_play = auto_play</span>
        <span class="s1">self.using = using</span>
        <span class="s1">self.new = new</span>
        <span class="s1">self.autoraise = autoraise</span>
        <span class="s1">self.post_script = post_script</span>
        <span class="s1">self.animation_opts = animation_opts</span>

    <span class="s0">def </span><span class="s1">render(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s0">from </span><span class="s1">plotly.io </span><span class="s0">import </span><span class="s1">to_html</span>

        <span class="s1">html = to_html(</span>
            <span class="s1">fig_dict</span><span class="s0">,</span>
            <span class="s1">config=self.config</span><span class="s0">,</span>
            <span class="s1">auto_play=self.auto_play</span><span class="s0">,</span>
            <span class="s1">include_plotlyjs=</span><span class="s0">True,</span>
            <span class="s1">include_mathjax=</span><span class="s2">&quot;cdn&quot;</span><span class="s0">,</span>
            <span class="s1">post_script=self.post_script</span><span class="s0">,</span>
            <span class="s1">full_html=</span><span class="s0">True,</span>
            <span class="s1">animation_opts=self.animation_opts</span><span class="s0">,</span>
            <span class="s1">default_width=</span><span class="s2">&quot;100%&quot;</span><span class="s0">,</span>
            <span class="s1">default_height=</span><span class="s2">&quot;100%&quot;</span><span class="s0">,</span>
            <span class="s1">validate=</span><span class="s0">False,</span>
        <span class="s1">)</span>
        <span class="s1">open_html_in_browser(html</span><span class="s0">, </span><span class="s1">self.using</span><span class="s0">, </span><span class="s1">self.new</span><span class="s0">, </span><span class="s1">self.autoraise)</span>


<span class="s0">class </span><span class="s1">DatabricksRenderer(ExternalRenderer):</span>
    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">config=</span><span class="s0">None,</span>
        <span class="s1">auto_play=</span><span class="s0">False,</span>
        <span class="s1">post_script=</span><span class="s0">None,</span>
        <span class="s1">animation_opts=</span><span class="s0">None,</span>
        <span class="s1">include_plotlyjs=</span><span class="s2">&quot;cdn&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>

        <span class="s1">self.config = config</span>
        <span class="s1">self.auto_play = auto_play</span>
        <span class="s1">self.post_script = post_script</span>
        <span class="s1">self.animation_opts = animation_opts</span>
        <span class="s1">self.include_plotlyjs = include_plotlyjs</span>
        <span class="s1">self._displayHTML = </span><span class="s0">None</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">displayHTML(self):</span>
        <span class="s0">import </span><span class="s1">inspect</span>

        <span class="s0">if </span><span class="s1">self._displayHTML </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">for </span><span class="s1">frame </span><span class="s0">in </span><span class="s1">inspect.getouterframes(inspect.currentframe()):</span>
                <span class="s1">global_names = set(frame.frame.f_globals)</span>
                <span class="s3"># Check for displayHTML plus a few others to reduce chance of a false</span>
                <span class="s3"># hit.</span>
                <span class="s0">if </span><span class="s1">all(v </span><span class="s0">in </span><span class="s1">global_names </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;displayHTML&quot;</span><span class="s0">, </span><span class="s2">&quot;display&quot;</span><span class="s0">, </span><span class="s2">&quot;spark&quot;</span><span class="s1">]):</span>
                    <span class="s1">self._displayHTML = frame.frame.f_globals[</span><span class="s2">&quot;displayHTML&quot;</span><span class="s1">]</span>
                    <span class="s0">break</span>

            <span class="s0">if </span><span class="s1">self._displayHTML </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s0">raise </span><span class="s1">EnvironmentError(</span>
                    <span class="s2">&quot;&quot;&quot; 
Unable to detect the Databricks displayHTML function. The 'databricks' renderer is only 
supported when called from within the Databricks notebook environment.&quot;&quot;&quot;</span>
                <span class="s1">)</span>

        <span class="s0">return </span><span class="s1">self._displayHTML</span>

    <span class="s0">def </span><span class="s1">render(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s0">from </span><span class="s1">plotly.io </span><span class="s0">import </span><span class="s1">to_html</span>

        <span class="s1">html = to_html(</span>
            <span class="s1">fig_dict</span><span class="s0">,</span>
            <span class="s1">config=self.config</span><span class="s0">,</span>
            <span class="s1">auto_play=self.auto_play</span><span class="s0">,</span>
            <span class="s1">include_plotlyjs=self.include_plotlyjs</span><span class="s0">,</span>
            <span class="s1">include_mathjax=</span><span class="s2">&quot;cdn&quot;</span><span class="s0">,</span>
            <span class="s1">post_script=self.post_script</span><span class="s0">,</span>
            <span class="s1">full_html=</span><span class="s0">True,</span>
            <span class="s1">animation_opts=self.animation_opts</span><span class="s0">,</span>
            <span class="s1">default_width=</span><span class="s2">&quot;100%&quot;</span><span class="s0">,</span>
            <span class="s1">default_height=</span><span class="s2">&quot;100%&quot;</span><span class="s0">,</span>
            <span class="s1">validate=</span><span class="s0">False,</span>
        <span class="s1">)</span>

        <span class="s3"># displayHTML is a Databricks notebook built-in function</span>
        <span class="s1">self.displayHTML(html)</span>


<span class="s0">class </span><span class="s1">SphinxGalleryHtmlRenderer(HtmlRenderer):</span>
    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">connected=</span><span class="s0">True,</span>
        <span class="s1">config=</span><span class="s0">None,</span>
        <span class="s1">auto_play=</span><span class="s0">False,</span>
        <span class="s1">post_script=</span><span class="s0">None,</span>
        <span class="s1">animation_opts=</span><span class="s0">None,</span>
    <span class="s1">):</span>
        <span class="s1">super(SphinxGalleryHtmlRenderer</span><span class="s0">, </span><span class="s1">self).__init__(</span>
            <span class="s1">connected=connected</span><span class="s0">,</span>
            <span class="s1">full_html=</span><span class="s0">False,</span>
            <span class="s1">requirejs=</span><span class="s0">False,</span>
            <span class="s1">global_init=</span><span class="s0">False,</span>
            <span class="s1">config=config</span><span class="s0">,</span>
            <span class="s1">auto_play=auto_play</span><span class="s0">,</span>
            <span class="s1">post_script=post_script</span><span class="s0">,</span>
            <span class="s1">animation_opts=animation_opts</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">to_mimebundle(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>

        <span class="s0">from </span><span class="s1">plotly.io </span><span class="s0">import </span><span class="s1">to_html</span>

        <span class="s0">if </span><span class="s1">self.requirejs:</span>
            <span class="s1">include_plotlyjs = </span><span class="s2">&quot;require&quot;</span>
            <span class="s1">include_mathjax = </span><span class="s0">False</span>
        <span class="s0">elif </span><span class="s1">self.connected:</span>
            <span class="s1">include_plotlyjs = </span><span class="s2">&quot;cdn&quot;</span>
            <span class="s1">include_mathjax = </span><span class="s2">&quot;cdn&quot;</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">include_plotlyjs = </span><span class="s0">True</span>
            <span class="s1">include_mathjax = </span><span class="s2">&quot;cdn&quot;</span>

        <span class="s1">html = to_html(</span>
            <span class="s1">fig_dict</span><span class="s0">,</span>
            <span class="s1">config=self.config</span><span class="s0">,</span>
            <span class="s1">auto_play=self.auto_play</span><span class="s0">,</span>
            <span class="s1">include_plotlyjs=include_plotlyjs</span><span class="s0">,</span>
            <span class="s1">include_mathjax=include_mathjax</span><span class="s0">,</span>
            <span class="s1">full_html=self.full_html</span><span class="s0">,</span>
            <span class="s1">animation_opts=self.animation_opts</span><span class="s0">,</span>
            <span class="s1">default_width=</span><span class="s2">&quot;100%&quot;</span><span class="s0">,</span>
            <span class="s1">default_height=</span><span class="s5">525</span><span class="s0">,</span>
            <span class="s1">validate=</span><span class="s0">False,</span>
        <span class="s1">)</span>

        <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;text/html&quot;</span><span class="s1">: html}</span>


<span class="s0">class </span><span class="s1">SphinxGalleryOrcaRenderer(ExternalRenderer):</span>
    <span class="s0">def </span><span class="s1">render(self</span><span class="s0">, </span><span class="s1">fig_dict):</span>
        <span class="s1">stack = inspect.stack()</span>
        <span class="s3"># Name of script from which plot function was called is retrieved</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">filename = stack[</span><span class="s5">3</span><span class="s1">].filename  </span><span class="s3"># let's hope this is robust...</span>
        <span class="s0">except</span><span class="s1">:  </span><span class="s3"># python 2</span>
            <span class="s1">filename = stack[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">filename_root</span><span class="s0">, </span><span class="s1">_ = os.path.splitext(filename)</span>
        <span class="s1">filename_html = filename_root + </span><span class="s2">&quot;.html&quot;</span>
        <span class="s1">filename_png = filename_root + </span><span class="s2">&quot;.png&quot;</span>
        <span class="s1">figure = return_figure_from_figure_or_data(fig_dict</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">_ = write_html(fig_dict</span><span class="s0">, </span><span class="s1">file=filename_html</span><span class="s0">, </span><span class="s1">include_plotlyjs=</span><span class="s2">&quot;cdn&quot;</span><span class="s1">)</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">write_image(figure</span><span class="s0">, </span><span class="s1">filename_png)</span>
        <span class="s0">except </span><span class="s1">(ValueError</span><span class="s0">, </span><span class="s1">ImportError):</span>
            <span class="s0">raise </span><span class="s1">ImportError(</span>
                <span class="s2">&quot;orca and psutil are required to use the `sphinx-gallery-orca` renderer. &quot;</span>
                <span class="s2">&quot;See https://plotly.com/python/static-image-export/ for instructions on &quot;</span>
                <span class="s2">&quot;how to install orca. Alternatively, you can use the `sphinx-gallery` &quot;</span>
                <span class="s2">&quot;renderer (note that png thumbnails can only be generated with &quot;</span>
                <span class="s2">&quot;the `sphinx-gallery-orca` renderer).&quot;</span>
            <span class="s1">)</span>
</pre>
</body>
</html>