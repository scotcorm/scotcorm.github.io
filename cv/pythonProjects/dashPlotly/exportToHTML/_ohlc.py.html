<html>
<head>
<title>_ohlc.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_ohlc.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span>

<span class="s0">from </span><span class="s1">plotly </span><span class="s0">import </span><span class="s1">exceptions</span>
<span class="s0">from </span><span class="s1">plotly.graph_objs </span><span class="s0">import </span><span class="s1">graph_objs</span>
<span class="s0">from </span><span class="s1">plotly.figure_factory </span><span class="s0">import </span><span class="s1">utils</span>


<span class="s2"># Default colours for finance charts</span>
<span class="s1">_DEFAULT_INCREASING_COLOR = </span><span class="s3">&quot;#3D9970&quot;  </span><span class="s2"># http://clrs.cc</span>
<span class="s1">_DEFAULT_DECREASING_COLOR = </span><span class="s3">&quot;#FF4136&quot;</span>


<span class="s0">def </span><span class="s1">validate_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">direction</span><span class="s0">, </span><span class="s1">**kwargs):</span>
    <span class="s4">&quot;&quot;&quot; 
    ohlc and candlestick specific validations 
 
    Specifically, this checks that the high value is the greatest value and 
    the low value is the lowest value in each unit. 
 
    See FigureFactory.create_ohlc() or FigureFactory.create_candlestick() 
    for params 
 
    :raises: (PlotlyError) If the high value is not the greatest value in 
        each unit. 
    :raises: (PlotlyError) If the low value is not the lowest value in each 
        unit. 
    :raises: (PlotlyError) If direction is not 'increasing' or 'decreasing' 
    &quot;&quot;&quot;</span>
    <span class="s0">for </span><span class="s1">lst </span><span class="s0">in </span><span class="s1">[open</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close]:</span>
        <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">range(len(high)):</span>
            <span class="s0">if </span><span class="s1">high[index] &lt; lst[index]:</span>
                <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
                    <span class="s3">&quot;Oops! Looks like some of &quot;</span>
                    <span class="s3">&quot;your high values are less &quot;</span>
                    <span class="s3">&quot;the corresponding open, &quot;</span>
                    <span class="s3">&quot;low, or close values. &quot;</span>
                    <span class="s3">&quot;Double check that your data &quot;</span>
                    <span class="s3">&quot;is entered in O-H-L-C order&quot;</span>
                <span class="s1">)</span>

    <span class="s0">for </span><span class="s1">lst </span><span class="s0">in </span><span class="s1">[open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">close]:</span>
        <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">range(len(low)):</span>
            <span class="s0">if </span><span class="s1">low[index] &gt; lst[index]:</span>
                <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
                    <span class="s3">&quot;Oops! Looks like some of &quot;</span>
                    <span class="s3">&quot;your low values are greater &quot;</span>
                    <span class="s3">&quot;than the corresponding high&quot;</span>
                    <span class="s3">&quot;, open, or close values. &quot;</span>
                    <span class="s3">&quot;Double check that your data &quot;</span>
                    <span class="s3">&quot;is entered in O-H-L-C order&quot;</span>
                <span class="s1">)</span>

    <span class="s1">direction_opts = (</span><span class="s3">&quot;increasing&quot;</span><span class="s0">, </span><span class="s3">&quot;decreasing&quot;</span><span class="s0">, </span><span class="s3">&quot;both&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">direction </span><span class="s0">not in </span><span class="s1">direction_opts:</span>
        <span class="s0">raise </span><span class="s1">exceptions.PlotlyError(</span>
            <span class="s3">&quot;direction must be defined as &quot; &quot;'increasing', 'decreasing', or &quot; &quot;'both'&quot;</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">make_increasing_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span><span class="s0">, </span><span class="s1">**kwargs):</span>
    <span class="s4">&quot;&quot;&quot; 
    Makes increasing ohlc sticks 
 
    _make_increasing_ohlc() and _make_decreasing_ohlc separate the 
    increasing trace from the decreasing trace so kwargs (such as 
    color) can be passed separately to increasing or decreasing traces 
    when direction is set to 'increasing' or 'decreasing' in 
    FigureFactory.create_candlestick() 
 
    :param (list) open: opening values 
    :param (list) high: high values 
    :param (list) low: low values 
    :param (list) close: closing values 
    :param (list) dates: list of datetime objects. Default: None 
    :param kwargs: kwargs to be passed to increasing trace via 
        plotly.graph_objs.Scatter. 
 
    :rtype (trace) ohlc_incr_data: Scatter trace of all increasing ohlc 
        sticks. 
    &quot;&quot;&quot;</span>
    <span class="s1">(flat_increase_x</span><span class="s0">, </span><span class="s1">flat_increase_y</span><span class="s0">, </span><span class="s1">text_increase) = _OHLC(</span>
        <span class="s1">open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span>
    <span class="s1">).get_increase()</span>

    <span class="s0">if </span><span class="s3">&quot;name&quot; </span><span class="s0">in </span><span class="s1">kwargs:</span>
        <span class="s1">showlegend = </span><span class="s0">True</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">kwargs.setdefault(</span><span class="s3">&quot;name&quot;</span><span class="s0">, </span><span class="s3">&quot;Increasing&quot;</span><span class="s1">)</span>
        <span class="s1">showlegend = </span><span class="s0">False</span>

    <span class="s1">kwargs.setdefault(</span><span class="s3">&quot;line&quot;</span><span class="s0">, </span><span class="s1">dict(color=_DEFAULT_INCREASING_COLOR</span><span class="s0">, </span><span class="s1">width=</span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">kwargs.setdefault(</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">text_increase)</span>

    <span class="s1">ohlc_incr = dict(</span>
        <span class="s1">type=</span><span class="s3">&quot;scatter&quot;</span><span class="s0">,</span>
        <span class="s1">x=flat_increase_x</span><span class="s0">,</span>
        <span class="s1">y=flat_increase_y</span><span class="s0">,</span>
        <span class="s1">mode=</span><span class="s3">&quot;lines&quot;</span><span class="s0">,</span>
        <span class="s1">showlegend=showlegend</span><span class="s0">,</span>
        <span class="s1">**kwargs</span>
    <span class="s1">)</span>
    <span class="s0">return </span><span class="s1">ohlc_incr</span>


<span class="s0">def </span><span class="s1">make_decreasing_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span><span class="s0">, </span><span class="s1">**kwargs):</span>
    <span class="s4">&quot;&quot;&quot; 
    Makes decreasing ohlc sticks 
 
    :param (list) open: opening values 
    :param (list) high: high values 
    :param (list) low: low values 
    :param (list) close: closing values 
    :param (list) dates: list of datetime objects. Default: None 
    :param kwargs: kwargs to be passed to increasing trace via 
        plotly.graph_objs.Scatter. 
 
    :rtype (trace) ohlc_decr_data: Scatter trace of all decreasing ohlc 
        sticks. 
    &quot;&quot;&quot;</span>
    <span class="s1">(flat_decrease_x</span><span class="s0">, </span><span class="s1">flat_decrease_y</span><span class="s0">, </span><span class="s1">text_decrease) = _OHLC(</span>
        <span class="s1">open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span>
    <span class="s1">).get_decrease()</span>

    <span class="s1">kwargs.setdefault(</span><span class="s3">&quot;line&quot;</span><span class="s0">, </span><span class="s1">dict(color=_DEFAULT_DECREASING_COLOR</span><span class="s0">, </span><span class="s1">width=</span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">kwargs.setdefault(</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">text_decrease)</span>
    <span class="s1">kwargs.setdefault(</span><span class="s3">&quot;showlegend&quot;</span><span class="s0">, False</span><span class="s1">)</span>
    <span class="s1">kwargs.setdefault(</span><span class="s3">&quot;name&quot;</span><span class="s0">, </span><span class="s3">&quot;Decreasing&quot;</span><span class="s1">)</span>

    <span class="s1">ohlc_decr = dict(</span>
        <span class="s1">type=</span><span class="s3">&quot;scatter&quot;</span><span class="s0">, </span><span class="s1">x=flat_decrease_x</span><span class="s0">, </span><span class="s1">y=flat_decrease_y</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;lines&quot;</span><span class="s0">, </span><span class="s1">**kwargs</span>
    <span class="s1">)</span>
    <span class="s0">return </span><span class="s1">ohlc_decr</span>


<span class="s0">def </span><span class="s1">create_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates=</span><span class="s0">None, </span><span class="s1">direction=</span><span class="s3">&quot;both&quot;</span><span class="s0">, </span><span class="s1">**kwargs):</span>
    <span class="s4">&quot;&quot;&quot; 
    **deprecated**, use instead the plotly.graph_objects trace  
    :class:`plotly.graph_objects.Ohlc` 
 
    :param (list) open: opening values 
    :param (list) high: high values 
    :param (list) low: low values 
    :param (list) close: closing 
    :param (list) dates: list of datetime objects. Default: None 
    :param (string) direction: direction can be 'increasing', 'decreasing', 
        or 'both'. When the direction is 'increasing', the returned figure 
        consists of all units where the close value is greater than the 
        corresponding open value, and when the direction is 'decreasing', 
        the returned figure consists of all units where the close value is 
        less than or equal to the corresponding open value. When the 
        direction is 'both', both increasing and decreasing units are 
        returned. Default: 'both' 
    :param kwargs: kwargs passed through plotly.graph_objs.Scatter. 
        These kwargs describe other attributes about the ohlc Scatter trace 
        such as the color or the legend name. For more information on valid 
        kwargs call help(plotly.graph_objs.Scatter) 
 
    :rtype (dict): returns a representation of an ohlc chart figure. 
 
    Example 1: Simple OHLC chart from a Pandas DataFrame 
 
    &gt;&gt;&gt; from plotly.figure_factory import create_ohlc 
    &gt;&gt;&gt; from datetime import datetime 
 
    &gt;&gt;&gt; import pandas as pd 
    &gt;&gt;&gt; df = pd.read_csv('https://raw.githubusercontent.com/plotly/datasets/master/finance-charts-apple.csv') 
    &gt;&gt;&gt; fig = create_ohlc(df['AAPL.Open'], df['AAPL.High'], df['AAPL.Low'], df['AAPL.Close'], dates=df.index) 
    &gt;&gt;&gt; fig.show() 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">dates </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">utils.validate_equal_length(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">utils.validate_equal_length(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close)</span>
    <span class="s1">validate_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">direction</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">if </span><span class="s1">direction == </span><span class="s3">&quot;increasing&quot;</span><span class="s1">:</span>
        <span class="s1">ohlc_incr = make_increasing_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">data = [ohlc_incr]</span>
    <span class="s0">elif </span><span class="s1">direction == </span><span class="s3">&quot;decreasing&quot;</span><span class="s1">:</span>
        <span class="s1">ohlc_decr = make_decreasing_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">data = [ohlc_decr]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">ohlc_incr = make_increasing_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">ohlc_decr = make_decreasing_ohlc(open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">data = [ohlc_incr</span><span class="s0">, </span><span class="s1">ohlc_decr]</span>

    <span class="s1">layout = graph_objs.Layout(xaxis=dict(zeroline=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">hovermode=</span><span class="s3">&quot;closest&quot;</span><span class="s1">)</span>

    <span class="s0">return </span><span class="s1">graph_objs.Figure(data=data</span><span class="s0">, </span><span class="s1">layout=layout)</span>


<span class="s0">class </span><span class="s1">_OHLC(object):</span>
    <span class="s4">&quot;&quot;&quot; 
    Refer to FigureFactory.create_ohlc_increase() for docstring. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">open</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">close</span><span class="s0">, </span><span class="s1">dates</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.open = open</span>
        <span class="s1">self.high = high</span>
        <span class="s1">self.low = low</span>
        <span class="s1">self.close = close</span>
        <span class="s1">self.empty = [</span><span class="s0">None</span><span class="s1">] * len(open)</span>
        <span class="s1">self.dates = dates</span>

        <span class="s1">self.all_x = []</span>
        <span class="s1">self.all_y = []</span>
        <span class="s1">self.increase_x = []</span>
        <span class="s1">self.increase_y = []</span>
        <span class="s1">self.decrease_x = []</span>
        <span class="s1">self.decrease_y = []</span>
        <span class="s1">self.get_all_xy()</span>
        <span class="s1">self.separate_increase_decrease()</span>

    <span class="s0">def </span><span class="s1">get_all_xy(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Zip data to create OHLC shape 
 
        OHLC shape: low to high vertical bar with 
        horizontal branches for open and close values. 
        If dates were added, the smallest date difference is calculated and 
        multiplied by .2 to get the length of the open and close branches. 
        If no date data was provided, the x-axis is a list of integers and the 
        length of the open and close branches is .2. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.all_y = list(</span>
            <span class="s1">zip(</span>
                <span class="s1">self.open</span><span class="s0">,</span>
                <span class="s1">self.open</span><span class="s0">,</span>
                <span class="s1">self.high</span><span class="s0">,</span>
                <span class="s1">self.low</span><span class="s0">,</span>
                <span class="s1">self.close</span><span class="s0">,</span>
                <span class="s1">self.close</span><span class="s0">,</span>
                <span class="s1">self.empty</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s0">if </span><span class="s1">self.dates </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">date_dif = []</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(self.dates) - </span><span class="s5">1</span><span class="s1">):</span>
                <span class="s1">date_dif.append(self.dates[i + </span><span class="s5">1</span><span class="s1">] - self.dates[i])</span>
            <span class="s1">date_dif_min = (min(date_dif)) / </span><span class="s5">5</span>
            <span class="s1">self.all_x = [</span>
                <span class="s1">[x - date_dif_min</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x + date_dif_min</span><span class="s0">, None</span><span class="s1">]</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">self.dates</span>
            <span class="s1">]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">self.all_x = [</span>
                <span class="s1">[x - </span><span class="s5">0.2</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x + </span><span class="s5">0.2</span><span class="s0">, None</span><span class="s1">] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(len(self.open))</span>
            <span class="s1">]</span>

    <span class="s0">def </span><span class="s1">separate_increase_decrease(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Separate data into two groups: increase and decrease 
 
        (1) Increase, where close &gt; open and 
        (2) Decrease, where close &lt;= open 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">range(len(self.open)):</span>
            <span class="s0">if </span><span class="s1">self.close[index] </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s0">pass</span>
            <span class="s0">elif </span><span class="s1">self.close[index] &gt; self.open[index]:</span>
                <span class="s1">self.increase_x.append(self.all_x[index])</span>
                <span class="s1">self.increase_y.append(self.all_y[index])</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.decrease_x.append(self.all_x[index])</span>
                <span class="s1">self.decrease_y.append(self.all_y[index])</span>

    <span class="s0">def </span><span class="s1">get_increase(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Flatten increase data and get increase text 
 
        :rtype (list, list, list): flat_increase_x: x-values for the increasing 
            trace, flat_increase_y: y=values for the increasing trace and 
            text_increase: hovertext for the increasing trace 
        &quot;&quot;&quot;</span>
        <span class="s1">flat_increase_x = utils.flatten(self.increase_x)</span>
        <span class="s1">flat_increase_y = utils.flatten(self.increase_y)</span>
        <span class="s1">text_increase = (</span><span class="s3">&quot;Open&quot;</span><span class="s0">, </span><span class="s3">&quot;Open&quot;</span><span class="s0">, </span><span class="s3">&quot;High&quot;</span><span class="s0">, </span><span class="s3">&quot;Low&quot;</span><span class="s0">, </span><span class="s3">&quot;Close&quot;</span><span class="s0">, </span><span class="s3">&quot;Close&quot;</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">) * (</span>
            <span class="s1">len(self.increase_x)</span>
        <span class="s1">)</span>

        <span class="s0">return </span><span class="s1">flat_increase_x</span><span class="s0">, </span><span class="s1">flat_increase_y</span><span class="s0">, </span><span class="s1">text_increase</span>

    <span class="s0">def </span><span class="s1">get_decrease(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Flatten decrease data and get decrease text 
 
        :rtype (list, list, list): flat_decrease_x: x-values for the decreasing 
            trace, flat_decrease_y: y=values for the decreasing trace and 
            text_decrease: hovertext for the decreasing trace 
        &quot;&quot;&quot;</span>
        <span class="s1">flat_decrease_x = utils.flatten(self.decrease_x)</span>
        <span class="s1">flat_decrease_y = utils.flatten(self.decrease_y)</span>
        <span class="s1">text_decrease = (</span><span class="s3">&quot;Open&quot;</span><span class="s0">, </span><span class="s3">&quot;Open&quot;</span><span class="s0">, </span><span class="s3">&quot;High&quot;</span><span class="s0">, </span><span class="s3">&quot;Low&quot;</span><span class="s0">, </span><span class="s3">&quot;Close&quot;</span><span class="s0">, </span><span class="s3">&quot;Close&quot;</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s1">) * (</span>
            <span class="s1">len(self.decrease_x)</span>
        <span class="s1">)</span>

        <span class="s0">return </span><span class="s1">flat_decrease_x</span><span class="s0">, </span><span class="s1">flat_decrease_y</span><span class="s0">, </span><span class="s1">text_decrease</span>
</pre>
</body>
</html>