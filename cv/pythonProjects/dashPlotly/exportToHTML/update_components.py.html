<html>
<head>
<title>update_components.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
update_components.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">shlex</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">argparse</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">logging</span>
<span class="s0">import </span><span class="s1">coloredlogs</span>


<span class="s0">class </span><span class="s1">_CombinedFormatter(</span>
    <span class="s1">argparse.ArgumentDefaultsHelpFormatter</span><span class="s0">, </span><span class="s1">argparse.RawDescriptionHelpFormatter</span>
<span class="s1">):</span>
    <span class="s0">pass</span>


<span class="s1">logger = logging.getLogger(__name__)</span>
<span class="s1">coloredlogs.install(</span>
    <span class="s1">fmt=</span><span class="s2">&quot;%(asctime)s,%(msecs)03d %(levelname)s - %(message)s&quot;</span><span class="s0">, </span><span class="s1">datefmt=</span><span class="s2">&quot;%H:%M:%S&quot;</span>
<span class="s1">)</span>


<span class="s0">def </span><span class="s1">booststrap_components(components_source):</span>

    <span class="s1">is_windows = sys.platform == </span><span class="s2">&quot;win32&quot;</span>

    <span class="s1">source_glob = (</span>
        <span class="s1">components_source</span>
        <span class="s0">if </span><span class="s1">components_source != </span><span class="s2">&quot;all&quot;</span>
        <span class="s0">else </span><span class="s2">&quot;dash-core-components|dash-html-components|dash-table&quot;</span>
    <span class="s1">)</span>

    <span class="s1">cmd = shlex.split(</span>
        <span class="s2">&quot;npx lerna exec --scope *@({})* -- npm i&quot;</span><span class="s1">.format(source_glob)</span><span class="s0">,</span>
        <span class="s1">posix=</span><span class="s0">not </span><span class="s1">is_windows</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">subprocess.Popen(</span>
        <span class="s1">cmd</span><span class="s0">, </span><span class="s1">stdout=subprocess.PIPE</span><span class="s0">, </span><span class="s1">stderr=subprocess.PIPE</span><span class="s0">, </span><span class="s1">shell=is_windows</span>
    <span class="s1">) </span><span class="s0">as </span><span class="s1">proc:</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">err = proc.communicate()</span>
        <span class="s1">status = proc.poll()</span>

    <span class="s0">if </span><span class="s1">err:</span>
        <span class="s1">print(err.decode()</span><span class="s0">, </span><span class="s1">file=sys.stderr)</span>

    <span class="s0">if </span><span class="s1">status == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s1">print(</span>
            <span class="s2">&quot;游릭 Finished installing npm dependencies for the following component packages: {} (status={}) 游릭&quot;</span><span class="s1">.format(</span>
                <span class="s1">source_glob</span><span class="s0">, </span><span class="s1">status</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">file=sys.stderr</span><span class="s0">,</span>
        <span class="s1">)</span>
    <span class="s0">if not </span><span class="s1">out:</span>
        <span class="s1">print(</span>
            <span class="s2">&quot;Failed installing npm dependencies for the following component packages {} (status={})&quot;</span><span class="s1">.format(</span>
                <span class="s1">source_glob</span><span class="s0">, </span><span class="s1">status</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">file=sys.stderr</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">build_components(components_source):</span>

    <span class="s1">is_windows = sys.platform == </span><span class="s2">&quot;win32&quot;</span>

    <span class="s1">source_glob = (</span>
        <span class="s1">components_source</span>
        <span class="s0">if </span><span class="s1">components_source != </span><span class="s2">&quot;all&quot;</span>
        <span class="s0">else </span><span class="s2">&quot;dash-core-components|dash-html-components|dash-table&quot;</span>
    <span class="s1">)</span>

    <span class="s1">cmd = shlex.split(</span>
        <span class="s2">&quot;npx lerna exec --scope *@({})* -- npm run build&quot;</span><span class="s1">.format(source_glob)</span><span class="s0">,</span>
        <span class="s1">posix=</span><span class="s0">not </span><span class="s1">is_windows</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">subprocess.Popen(</span>
        <span class="s1">cmd</span><span class="s0">, </span><span class="s1">stdout=subprocess.PIPE</span><span class="s0">, </span><span class="s1">stderr=subprocess.PIPE</span><span class="s0">, </span><span class="s1">shell=is_windows</span>
    <span class="s1">) </span><span class="s0">as </span><span class="s1">proc:</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">err = proc.communicate()</span>
        <span class="s1">status = proc.poll()</span>

    <span class="s0">if </span><span class="s1">err:</span>
        <span class="s1">print(err.decode()</span><span class="s0">, </span><span class="s1">file=sys.stderr)</span>

    <span class="s0">if not </span><span class="s1">out:</span>
        <span class="s1">print(</span>
            <span class="s2">&quot;游릭 Finished updating the following component packages {} (status={}) 游릭&quot;</span><span class="s1">.format(</span>
                <span class="s1">source_glob</span><span class="s0">, </span><span class="s1">status</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">file=sys.stderr</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">sys.exit(</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">package </span><span class="s0">in </span><span class="s1">source_glob.split(</span><span class="s2">&quot;|&quot;</span><span class="s1">):</span>
        <span class="s1">build_directory = os.path.join(</span>
            <span class="s2">&quot;components&quot;</span><span class="s0">, </span><span class="s1">package</span><span class="s0">, </span><span class="s1">package.replace(</span><span class="s2">&quot;-&quot;</span><span class="s0">, </span><span class="s2">&quot;_&quot;</span><span class="s1">).rstrip(</span><span class="s2">&quot;/</span><span class="s0">\\</span><span class="s2">&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>

        <span class="s1">dest_dir = (</span>
            <span class="s2">&quot;dcc&quot;</span>
            <span class="s0">if </span><span class="s1">package == </span><span class="s2">&quot;dash-core-components&quot;</span>
            <span class="s0">else </span><span class="s2">&quot;html&quot;</span>
            <span class="s0">if </span><span class="s1">package == </span><span class="s2">&quot;dash-html-components&quot;</span>
            <span class="s0">else </span><span class="s2">&quot;dash_table&quot;</span>
        <span class="s1">)</span>

        <span class="s1">dest_path = os.path.join(</span><span class="s2">&quot;dash&quot;</span><span class="s0">, </span><span class="s1">dest_dir)</span>

        <span class="s0">if not </span><span class="s1">os.path.exists(dest_path):</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">os.makedirs(dest_path)</span>
            <span class="s0">except </span><span class="s1">OSError:</span>
                <span class="s1">logger.exception(</span><span class="s2">&quot;游뚿 Having issues manipulating %s&quot;</span><span class="s0">, </span><span class="s1">dest_path)</span>
                <span class="s1">sys.exit(</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s0">if not </span><span class="s1">os.path.exists(build_directory):</span>
            <span class="s1">print(</span>
                <span class="s2">&quot;Could not locate build artifacts. Check that the npm build process completed successfully for the given package: {}&quot;</span><span class="s1">.format(</span>
                    <span class="s1">package</span>
                <span class="s1">)</span>
            <span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">print(</span><span class="s2">&quot;游뚴 Moving build artifacts from &quot; </span><span class="s1">+ build_directory + </span><span class="s2">&quot; to Dash 游뚴&quot;</span><span class="s1">)</span>
            <span class="s1">shutil.rmtree(dest_path)</span>
            <span class="s1">shutil.copytree(build_directory</span><span class="s0">, </span><span class="s1">dest_path)</span>
            <span class="s0">with </span><span class="s1">open(os.path.join(dest_path</span><span class="s0">, </span><span class="s2">&quot;.gitkeep&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">):</span>
                <span class="s0">pass</span>
            <span class="s1">print(</span>
                <span class="s2">&quot;游릭 Finished moving build artifacts from &quot;</span>
                <span class="s1">+ build_directory</span>
                <span class="s1">+ </span><span class="s2">&quot; to Dash 游릭&quot;</span>
            <span class="s1">)</span>


<span class="s0">def </span><span class="s1">cli():</span>
    <span class="s1">parser = argparse.ArgumentParser(</span>
        <span class="s1">prog=</span><span class="s2">&quot;dash-update-components&quot;</span><span class="s0">,</span>
        <span class="s1">formatter_class=_CombinedFormatter</span><span class="s0">,</span>
        <span class="s1">description=</span><span class="s2">&quot;Update the specified subcomponent libraries within Dash&quot;</span>
        <span class="s2">&quot; by copying over build artifacts, dependencies, and dependency metadata.&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">parser.add_argument(</span>
        <span class="s2">&quot;components_source&quot;</span><span class="s0">,</span>
        <span class="s1">help=</span><span class="s2">&quot;A glob string that matches the Dash component libraries to be updated (eg.'dash-table' // 'dash-core-components|dash-html-components' // 'all'). The default argument is 'all'.&quot;</span><span class="s0">,</span>
        <span class="s1">default=</span><span class="s2">&quot;all&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">args = parser.parse_args()</span>

    <span class="s1">booststrap_components(args.components_source)</span>
    <span class="s1">build_components(args.components_source)</span>


<span class="s1">cli()</span>
</pre>
</body>
</html>